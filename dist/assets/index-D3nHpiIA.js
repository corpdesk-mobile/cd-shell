const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DkfF8G70.js","assets/index-BRIKc63m.js","assets/index-C_EefWij.css","assets/index-CCs3NjLB.js","assets/dayjs.min-8nNmiLn8.js","assets/index-MsEZ4Scr.js","assets/url-kJZEVK88.js","assets/doc.service-IrVtuMVH.js","assets/index-JiKw9JSs.js"])))=>i.map(i=>d[i]);
import{_ as Br,c as bi,g as Um}from"./index-BRIKc63m.js";import{t as Wo,a as Qo,e as Hl,s as KC,g as JC,r as XC,b as ZC,d as ev,f as tv,h as nv,c as ls,i as Fm,j as rv}from"./index-CCs3NjLB.js";import{d as iv}from"./dayjs.min-8nNmiLn8.js";function sv(s,e){for(var t=0;t<e.length;t++){const n=e[t];if(typeof n!="string"&&!Array.isArray(n)){for(const r in n)if(r!=="default"&&!(r in s)){const i=Object.getOwnPropertyDescriptor(n,r);i&&Object.defineProperty(s,r,i.get?i:{enumerable:!0,get:()=>n[r]})}}}return Object.freeze(Object.defineProperty(s,Symbol.toStringTag,{value:"Module"}))}const fr=Object.create(null);fr.open="0";fr.close="1";fr.ping="2";fr.pong="3";fr.message="4";fr.upgrade="5";fr.noop="6";const fo=Object.create(null);Object.keys(fr).forEach(s=>{fo[fr[s]]=s});const ul={type:"error",data:"parser error"},km=typeof Blob=="function"||typeof Blob<"u"&&Object.prototype.toString.call(Blob)==="[object BlobConstructor]",jm=typeof ArrayBuffer=="function",Wm=s=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(s):s&&s.buffer instanceof ArrayBuffer,Yl=({type:s,data:e},t,n)=>km&&e instanceof Blob?t?n(e):hp(e,n):jm&&(e instanceof ArrayBuffer||Wm(e))?t?n(e):hp(new Blob([e]),n):n(fr[s]+(e||"")),hp=(s,e)=>{const t=new FileReader;return t.onload=function(){const n=t.result.split(",")[1];e("b"+(n||""))},t.readAsDataURL(s)};function dp(s){return s instanceof Uint8Array?s:s instanceof ArrayBuffer?new Uint8Array(s):new Uint8Array(s.buffer,s.byteOffset,s.byteLength)}let Bu;function av(s,e){if(km&&s.data instanceof Blob)return s.data.arrayBuffer().then(dp).then(e);if(jm&&(s.data instanceof ArrayBuffer||Wm(s.data)))return e(dp(s.data));Yl(s,!1,t=>{Bu||(Bu=new TextEncoder),e(Bu.encode(t))})}const fp="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Qs=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(let s=0;s<fp.length;s++)Qs[fp.charCodeAt(s)]=s;const ov=s=>{let e=s.length*.75,t=s.length,n,r=0,i,a,o,l;s[s.length-1]==="="&&(e--,s[s.length-2]==="="&&e--);const h=new ArrayBuffer(e),d=new Uint8Array(h);for(n=0;n<t;n+=4)i=Qs[s.charCodeAt(n)],a=Qs[s.charCodeAt(n+1)],o=Qs[s.charCodeAt(n+2)],l=Qs[s.charCodeAt(n+3)],d[r++]=i<<2|a>>4,d[r++]=(a&15)<<4|o>>2,d[r++]=(o&3)<<6|l&63;return h},cv=typeof ArrayBuffer=="function",Gl=(s,e)=>{if(typeof s!="string")return{type:"message",data:Qm(s,e)};const t=s.charAt(0);return t==="b"?{type:"message",data:uv(s.substring(1),e)}:fo[t]?s.length>1?{type:fo[t],data:s.substring(1)}:{type:fo[t]}:ul},uv=(s,e)=>{if(cv){const t=ov(s);return Qm(t,e)}else return{base64:!0,data:s}},Qm=(s,e)=>{switch(e){case"blob":return s instanceof Blob?s:new Blob([s]);case"arraybuffer":default:return s instanceof ArrayBuffer?s:s.buffer}},Vm="",lv=(s,e)=>{const t=s.length,n=new Array(t);let r=0;s.forEach((i,a)=>{Yl(i,!1,o=>{n[a]=o,++r===t&&e(n.join(Vm))})})},hv=(s,e)=>{const t=s.split(Vm),n=[];for(let r=0;r<t.length;r++){const i=Gl(t[r],e);if(n.push(i),i.type==="error")break}return n};function dv(){return new TransformStream({transform(s,e){av(s,t=>{const n=t.length;let r;if(n<126)r=new Uint8Array(1),new DataView(r.buffer).setUint8(0,n);else if(n<65536){r=new Uint8Array(3);const i=new DataView(r.buffer);i.setUint8(0,126),i.setUint16(1,n)}else{r=new Uint8Array(9);const i=new DataView(r.buffer);i.setUint8(0,127),i.setBigUint64(1,BigInt(n))}s.data&&typeof s.data!="string"&&(r[0]|=128),e.enqueue(r),e.enqueue(t)})}})}let Uu;function to(s){return s.reduce((e,t)=>e+t.length,0)}function no(s,e){if(s[0].length===e)return s.shift();const t=new Uint8Array(e);let n=0;for(let r=0;r<e;r++)t[r]=s[0][n++],n===s[0].length&&(s.shift(),n=0);return s.length&&n<s[0].length&&(s[0]=s[0].slice(n)),t}function fv(s,e){Uu||(Uu=new TextDecoder);const t=[];let n=0,r=-1,i=!1;return new TransformStream({transform(a,o){for(t.push(a);;){if(n===0){if(to(t)<1)break;const l=no(t,1);i=(l[0]&128)===128,r=l[0]&127,r<126?n=3:r===126?n=1:n=2}else if(n===1){if(to(t)<2)break;const l=no(t,2);r=new DataView(l.buffer,l.byteOffset,l.length).getUint16(0),n=3}else if(n===2){if(to(t)<8)break;const l=no(t,8),h=new DataView(l.buffer,l.byteOffset,l.length),d=h.getUint32(0);if(d>Math.pow(2,21)-1){o.enqueue(ul);break}r=d*Math.pow(2,32)+h.getUint32(4),n=3}else{if(to(t)<r)break;const l=no(t,r);o.enqueue(Gl(i?l:Uu.decode(l),e)),n=0}if(r===0||r>s){o.enqueue(ul);break}}}})}const Hm=4;function Mt(s){if(s)return pv(s)}function pv(s){for(var e in Mt.prototype)s[e]=Mt.prototype[e];return s}Mt.prototype.on=Mt.prototype.addEventListener=function(s,e){return this._callbacks=this._callbacks||{},(this._callbacks["$"+s]=this._callbacks["$"+s]||[]).push(e),this};Mt.prototype.once=function(s,e){function t(){this.off(s,t),e.apply(this,arguments)}return t.fn=e,this.on(s,t),this};Mt.prototype.off=Mt.prototype.removeListener=Mt.prototype.removeAllListeners=Mt.prototype.removeEventListener=function(s,e){if(this._callbacks=this._callbacks||{},arguments.length==0)return this._callbacks={},this;var t=this._callbacks["$"+s];if(!t)return this;if(arguments.length==1)return delete this._callbacks["$"+s],this;for(var n,r=0;r<t.length;r++)if(n=t[r],n===e||n.fn===e){t.splice(r,1);break}return t.length===0&&delete this._callbacks["$"+s],this};Mt.prototype.emit=function(s){this._callbacks=this._callbacks||{};for(var e=new Array(arguments.length-1),t=this._callbacks["$"+s],n=1;n<arguments.length;n++)e[n-1]=arguments[n];if(t){t=t.slice(0);for(var n=0,r=t.length;n<r;++n)t[n].apply(this,e)}return this};Mt.prototype.emitReserved=Mt.prototype.emit;Mt.prototype.listeners=function(s){return this._callbacks=this._callbacks||{},this._callbacks["$"+s]||[]};Mt.prototype.hasListeners=function(s){return!!this.listeners(s).length};const Vo=typeof Promise=="function"&&typeof Promise.resolve=="function"?e=>Promise.resolve().then(e):(e,t)=>t(e,0),Mn=typeof self<"u"?self:typeof window<"u"?window:Function("return this")(),mv="arraybuffer";function Ym(s,...e){return e.reduce((t,n)=>(s.hasOwnProperty(n)&&(t[n]=s[n]),t),{})}const yv=Mn.setTimeout,gv=Mn.clearTimeout;function Ho(s,e){e.useNativeTimers?(s.setTimeoutFn=yv.bind(Mn),s.clearTimeoutFn=gv.bind(Mn)):(s.setTimeoutFn=Mn.setTimeout.bind(Mn),s.clearTimeoutFn=Mn.clearTimeout.bind(Mn))}const Ev=1.33;function wv(s){return typeof s=="string"?bv(s):Math.ceil((s.byteLength||s.size)*Ev)}function bv(s){let e=0,t=0;for(let n=0,r=s.length;n<r;n++)e=s.charCodeAt(n),e<128?t+=1:e<2048?t+=2:e<55296||e>=57344?t+=3:(n++,t+=4);return t}function Gm(){return Date.now().toString(36).substring(3)+Math.random().toString(36).substring(2,5)}function Tv(s){let e="";for(let t in s)s.hasOwnProperty(t)&&(e.length&&(e+="&"),e+=encodeURIComponent(t)+"="+encodeURIComponent(s[t]));return e}function Sv(s){let e={},t=s.split("&");for(let n=0,r=t.length;n<r;n++){let i=t[n].split("=");e[decodeURIComponent(i[0])]=decodeURIComponent(i[1])}return e}class Av extends Error{constructor(e,t,n){super(e),this.description=t,this.context=n,this.type="TransportError"}}class zl extends Mt{constructor(e){super(),this.writable=!1,Ho(this,e),this.opts=e,this.query=e.query,this.socket=e.socket,this.supportsBinary=!e.forceBase64}onError(e,t,n){return super.emitReserved("error",new Av(e,t,n)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return(this.readyState==="opening"||this.readyState==="open")&&(this.doClose(),this.onClose()),this}send(e){this.readyState==="open"&&this.write(e)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(e){const t=Gl(e,this.socket.binaryType);this.onPacket(t)}onPacket(e){super.emitReserved("packet",e)}onClose(e){this.readyState="closed",super.emitReserved("close",e)}pause(e){}createUri(e,t={}){return e+"://"+this._hostname()+this._port()+this.opts.path+this._query(t)}_hostname(){const e=this.opts.hostname;return e.indexOf(":")===-1?e:"["+e+"]"}_port(){return this.opts.port&&(this.opts.secure&&+(this.opts.port!==443)||!this.opts.secure&&Number(this.opts.port)!==80)?":"+this.opts.port:""}_query(e){const t=Tv(e);return t.length?"?"+t:""}}class Nv extends zl{constructor(){super(...arguments),this._polling=!1}get name(){return"polling"}doOpen(){this._poll()}pause(e){this.readyState="pausing";const t=()=>{this.readyState="paused",e()};if(this._polling||!this.writable){let n=0;this._polling&&(n++,this.once("pollComplete",function(){--n||t()})),this.writable||(n++,this.once("drain",function(){--n||t()}))}else t()}_poll(){this._polling=!0,this.doPoll(),this.emitReserved("poll")}onData(e){const t=n=>{if(this.readyState==="opening"&&n.type==="open"&&this.onOpen(),n.type==="close")return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(n)};hv(e,this.socket.binaryType).forEach(t),this.readyState!=="closed"&&(this._polling=!1,this.emitReserved("pollComplete"),this.readyState==="open"&&this._poll())}doClose(){const e=()=>{this.write([{type:"close"}])};this.readyState==="open"?e():this.once("open",e)}write(e){this.writable=!1,lv(e,t=>{this.doWrite(t,()=>{this.writable=!0,this.emitReserved("drain")})})}uri(){const e=this.opts.secure?"https":"http",t=this.query||{};return this.opts.timestampRequests!==!1&&(t[this.opts.timestampParam]=Gm()),!this.supportsBinary&&!t.sid&&(t.b64=1),this.createUri(e,t)}}let zm=!1;try{zm=typeof XMLHttpRequest<"u"&&"withCredentials"in new XMLHttpRequest}catch{}const Cv=zm;function vv(){}class Rv extends Nv{constructor(e){if(super(e),typeof location<"u"){const t=location.protocol==="https:";let n=location.port;n||(n=t?"443":"80"),this.xd=typeof location<"u"&&e.hostname!==location.hostname||n!==e.port}}doWrite(e,t){const n=this.request({method:"POST",data:e});n.on("success",t),n.on("error",(r,i)=>{this.onError("xhr post error",r,i)})}doPoll(){const e=this.request();e.on("data",this.onData.bind(this)),e.on("error",(t,n)=>{this.onError("xhr poll error",t,n)}),this.pollXhr=e}}class dr extends Mt{constructor(e,t,n){super(),this.createRequest=e,Ho(this,n),this._opts=n,this._method=n.method||"GET",this._uri=t,this._data=n.data!==void 0?n.data:null,this._create()}_create(){var e;const t=Ym(this._opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");t.xdomain=!!this._opts.xd;const n=this._xhr=this.createRequest(t);try{n.open(this._method,this._uri,!0);try{if(this._opts.extraHeaders){n.setDisableHeaderCheck&&n.setDisableHeaderCheck(!0);for(let r in this._opts.extraHeaders)this._opts.extraHeaders.hasOwnProperty(r)&&n.setRequestHeader(r,this._opts.extraHeaders[r])}}catch{}if(this._method==="POST")try{n.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch{}try{n.setRequestHeader("Accept","*/*")}catch{}(e=this._opts.cookieJar)===null||e===void 0||e.addCookies(n),"withCredentials"in n&&(n.withCredentials=this._opts.withCredentials),this._opts.requestTimeout&&(n.timeout=this._opts.requestTimeout),n.onreadystatechange=()=>{var r;n.readyState===3&&((r=this._opts.cookieJar)===null||r===void 0||r.parseCookies(n.getResponseHeader("set-cookie"))),n.readyState===4&&(n.status===200||n.status===1223?this._onLoad():this.setTimeoutFn(()=>{this._onError(typeof n.status=="number"?n.status:0)},0))},n.send(this._data)}catch(r){this.setTimeoutFn(()=>{this._onError(r)},0);return}typeof document<"u"&&(this._index=dr.requestsCount++,dr.requests[this._index]=this)}_onError(e){this.emitReserved("error",e,this._xhr),this._cleanup(!0)}_cleanup(e){if(!(typeof this._xhr>"u"||this._xhr===null)){if(this._xhr.onreadystatechange=vv,e)try{this._xhr.abort()}catch{}typeof document<"u"&&delete dr.requests[this._index],this._xhr=null}}_onLoad(){const e=this._xhr.responseText;e!==null&&(this.emitReserved("data",e),this.emitReserved("success"),this._cleanup())}abort(){this._cleanup()}}dr.requestsCount=0;dr.requests={};if(typeof document<"u"){if(typeof attachEvent=="function")attachEvent("onunload",pp);else if(typeof addEventListener=="function"){const s="onpagehide"in Mn?"pagehide":"unload";addEventListener(s,pp,!1)}}function pp(){for(let s in dr.requests)dr.requests.hasOwnProperty(s)&&dr.requests[s].abort()}const _v=function(){const s=Km({xdomain:!1});return s&&s.responseType!==null}();class xv extends Rv{constructor(e){super(e);const t=e&&e.forceBase64;this.supportsBinary=_v&&!t}request(e={}){return Object.assign(e,{xd:this.xd},this.opts),new dr(Km,this.uri(),e)}}function Km(s){const e=s.xdomain;try{if(typeof XMLHttpRequest<"u"&&(!e||Cv))return new XMLHttpRequest}catch{}if(!e)try{return new Mn[["Active"].concat("Object").join("X")]("Microsoft.XMLHTTP")}catch{}}const Jm=typeof navigator<"u"&&typeof navigator.product=="string"&&navigator.product.toLowerCase()==="reactnative";class Mv extends zl{get name(){return"websocket"}doOpen(){const e=this.uri(),t=this.opts.protocols,n=Jm?{}:Ym(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(n.headers=this.opts.extraHeaders);try{this.ws=this.createSocket(e,t,n)}catch(r){return this.emitReserved("error",r)}this.ws.binaryType=this.socket.binaryType,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=e=>this.onClose({description:"websocket connection closed",context:e}),this.ws.onmessage=e=>this.onData(e.data),this.ws.onerror=e=>this.onError("websocket error",e)}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const n=e[t],r=t===e.length-1;Yl(n,this.supportsBinary,i=>{try{this.doWrite(n,i)}catch{}r&&Vo(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){typeof this.ws<"u"&&(this.ws.onerror=()=>{},this.ws.close(),this.ws=null)}uri(){const e=this.opts.secure?"wss":"ws",t=this.query||{};return this.opts.timestampRequests&&(t[this.opts.timestampParam]=Gm()),this.supportsBinary||(t.b64=1),this.createUri(e,t)}}const Fu=Mn.WebSocket||Mn.MozWebSocket;class Pv extends Mv{createSocket(e,t,n){return Jm?new Fu(e,t,n):t?new Fu(e,t):new Fu(e)}doWrite(e,t){this.ws.send(t)}}class Ov extends zl{get name(){return"webtransport"}doOpen(){try{this._transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name])}catch(e){return this.emitReserved("error",e)}this._transport.closed.then(()=>{this.onClose()}).catch(e=>{this.onError("webtransport error",e)}),this._transport.ready.then(()=>{this._transport.createBidirectionalStream().then(e=>{const t=fv(Number.MAX_SAFE_INTEGER,this.socket.binaryType),n=e.readable.pipeThrough(t).getReader(),r=dv();r.readable.pipeTo(e.writable),this._writer=r.writable.getWriter();const i=()=>{n.read().then(({done:o,value:l})=>{o||(this.onPacket(l),i())}).catch(o=>{})};i();const a={type:"open"};this.query.sid&&(a.data=`{"sid":"${this.query.sid}"}`),this._writer.write(a).then(()=>this.onOpen())})})}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const n=e[t],r=t===e.length-1;this._writer.write(n).then(()=>{r&&Vo(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){var e;(e=this._transport)===null||e===void 0||e.close()}}const Dv={websocket:Pv,webtransport:Ov,polling:xv},Iv=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,$v=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function ll(s){if(s.length>8e3)throw"URI too long";const e=s,t=s.indexOf("["),n=s.indexOf("]");t!=-1&&n!=-1&&(s=s.substring(0,t)+s.substring(t,n).replace(/:/g,";")+s.substring(n,s.length));let r=Iv.exec(s||""),i={},a=14;for(;a--;)i[$v[a]]=r[a]||"";return t!=-1&&n!=-1&&(i.source=e,i.host=i.host.substring(1,i.host.length-1).replace(/;/g,":"),i.authority=i.authority.replace("[","").replace("]","").replace(/;/g,":"),i.ipv6uri=!0),i.pathNames=Lv(i,i.path),i.queryKey=qv(i,i.query),i}function Lv(s,e){const t=/\/{2,9}/g,n=e.replace(t,"/").split("/");return(e.slice(0,1)=="/"||e.length===0)&&n.splice(0,1),e.slice(-1)=="/"&&n.splice(n.length-1,1),n}function qv(s,e){const t={};return e.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(n,r,i){r&&(t[r]=i)}),t}const hl=typeof addEventListener=="function"&&typeof removeEventListener=="function",po=[];hl&&addEventListener("offline",()=>{po.forEach(s=>s())},!1);class ai extends Mt{constructor(e,t){if(super(),this.binaryType=mv,this.writeBuffer=[],this._prevBufferLen=0,this._pingInterval=-1,this._pingTimeout=-1,this._maxPayload=-1,this._pingTimeoutTime=1/0,e&&typeof e=="object"&&(t=e,e=null),e){const n=ll(e);t.hostname=n.host,t.secure=n.protocol==="https"||n.protocol==="wss",t.port=n.port,n.query&&(t.query=n.query)}else t.host&&(t.hostname=ll(t.host).host);Ho(this,t),this.secure=t.secure!=null?t.secure:typeof location<"u"&&location.protocol==="https:",t.hostname&&!t.port&&(t.port=this.secure?"443":"80"),this.hostname=t.hostname||(typeof location<"u"?location.hostname:"localhost"),this.port=t.port||(typeof location<"u"&&location.port?location.port:this.secure?"443":"80"),this.transports=[],this._transportsByName={},t.transports.forEach(n=>{const r=n.prototype.name;this.transports.push(r),this._transportsByName[r]=n}),this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!1},t),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),typeof this.opts.query=="string"&&(this.opts.query=Sv(this.opts.query)),hl&&(this.opts.closeOnBeforeunload&&(this._beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this._beforeunloadEventListener,!1)),this.hostname!=="localhost"&&(this._offlineEventListener=()=>{this._onClose("transport close",{description:"network connection lost"})},po.push(this._offlineEventListener))),this.opts.withCredentials&&(this._cookieJar=void 0),this._open()}createTransport(e){const t=Object.assign({},this.opts.query);t.EIO=Hm,t.transport=e,this.id&&(t.sid=this.id);const n=Object.assign({},this.opts,{query:t,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[e]);return new this._transportsByName[e](n)}_open(){if(this.transports.length===0){this.setTimeoutFn(()=>{this.emitReserved("error","No transports available")},0);return}const e=this.opts.rememberUpgrade&&ai.priorWebsocketSuccess&&this.transports.indexOf("websocket")!==-1?"websocket":this.transports[0];this.readyState="opening";const t=this.createTransport(e);t.open(),this.setTransport(t)}setTransport(e){this.transport&&this.transport.removeAllListeners(),this.transport=e,e.on("drain",this._onDrain.bind(this)).on("packet",this._onPacket.bind(this)).on("error",this._onError.bind(this)).on("close",t=>this._onClose("transport close",t))}onOpen(){this.readyState="open",ai.priorWebsocketSuccess=this.transport.name==="websocket",this.emitReserved("open"),this.flush()}_onPacket(e){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")switch(this.emitReserved("packet",e),this.emitReserved("heartbeat"),e.type){case"open":this.onHandshake(JSON.parse(e.data));break;case"ping":this._sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong"),this._resetPingTimeout();break;case"error":const t=new Error("server error");t.code=e.data,this._onError(t);break;case"message":this.emitReserved("data",e.data),this.emitReserved("message",e.data);break}}onHandshake(e){this.emitReserved("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this._pingInterval=e.pingInterval,this._pingTimeout=e.pingTimeout,this._maxPayload=e.maxPayload,this.onOpen(),this.readyState!=="closed"&&this._resetPingTimeout()}_resetPingTimeout(){this.clearTimeoutFn(this._pingTimeoutTimer);const e=this._pingInterval+this._pingTimeout;this._pingTimeoutTime=Date.now()+e,this._pingTimeoutTimer=this.setTimeoutFn(()=>{this._onClose("ping timeout")},e),this.opts.autoUnref&&this._pingTimeoutTimer.unref()}_onDrain(){this.writeBuffer.splice(0,this._prevBufferLen),this._prevBufferLen=0,this.writeBuffer.length===0?this.emitReserved("drain"):this.flush()}flush(){if(this.readyState!=="closed"&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const e=this._getWritablePackets();this.transport.send(e),this._prevBufferLen=e.length,this.emitReserved("flush")}}_getWritablePackets(){if(!(this._maxPayload&&this.transport.name==="polling"&&this.writeBuffer.length>1))return this.writeBuffer;let t=1;for(let n=0;n<this.writeBuffer.length;n++){const r=this.writeBuffer[n].data;if(r&&(t+=wv(r)),n>0&&t>this._maxPayload)return this.writeBuffer.slice(0,n);t+=2}return this.writeBuffer}_hasPingExpired(){if(!this._pingTimeoutTime)return!0;const e=Date.now()>this._pingTimeoutTime;return e&&(this._pingTimeoutTime=0,Vo(()=>{this._onClose("ping timeout")},this.setTimeoutFn)),e}write(e,t,n){return this._sendPacket("message",e,t,n),this}send(e,t,n){return this._sendPacket("message",e,t,n),this}_sendPacket(e,t,n,r){if(typeof t=="function"&&(r=t,t=void 0),typeof n=="function"&&(r=n,n=null),this.readyState==="closing"||this.readyState==="closed")return;n=n||{},n.compress=n.compress!==!1;const i={type:e,data:t,options:n};this.emitReserved("packetCreate",i),this.writeBuffer.push(i),r&&this.once("flush",r),this.flush()}close(){const e=()=>{this._onClose("forced close"),this.transport.close()},t=()=>{this.off("upgrade",t),this.off("upgradeError",t),e()},n=()=>{this.once("upgrade",t),this.once("upgradeError",t)};return(this.readyState==="opening"||this.readyState==="open")&&(this.readyState="closing",this.writeBuffer.length?this.once("drain",()=>{this.upgrading?n():e()}):this.upgrading?n():e()),this}_onError(e){if(ai.priorWebsocketSuccess=!1,this.opts.tryAllTransports&&this.transports.length>1&&this.readyState==="opening")return this.transports.shift(),this._open();this.emitReserved("error",e),this._onClose("transport error",e)}_onClose(e,t){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing"){if(this.clearTimeoutFn(this._pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),hl&&(this._beforeunloadEventListener&&removeEventListener("beforeunload",this._beforeunloadEventListener,!1),this._offlineEventListener)){const n=po.indexOf(this._offlineEventListener);n!==-1&&po.splice(n,1)}this.readyState="closed",this.id=null,this.emitReserved("close",e,t),this.writeBuffer=[],this._prevBufferLen=0}}}ai.protocol=Hm;class Bv extends ai{constructor(){super(...arguments),this._upgrades=[]}onOpen(){if(super.onOpen(),this.readyState==="open"&&this.opts.upgrade)for(let e=0;e<this._upgrades.length;e++)this._probe(this._upgrades[e])}_probe(e){let t=this.createTransport(e),n=!1;ai.priorWebsocketSuccess=!1;const r=()=>{n||(t.send([{type:"ping",data:"probe"}]),t.once("packet",p=>{if(!n)if(p.type==="pong"&&p.data==="probe"){if(this.upgrading=!0,this.emitReserved("upgrading",t),!t)return;ai.priorWebsocketSuccess=t.name==="websocket",this.transport.pause(()=>{n||this.readyState!=="closed"&&(d(),this.setTransport(t),t.send([{type:"upgrade"}]),this.emitReserved("upgrade",t),t=null,this.upgrading=!1,this.flush())})}else{const m=new Error("probe error");m.transport=t.name,this.emitReserved("upgradeError",m)}}))};function i(){n||(n=!0,d(),t.close(),t=null)}const a=p=>{const m=new Error("probe error: "+p);m.transport=t.name,i(),this.emitReserved("upgradeError",m)};function o(){a("transport closed")}function l(){a("socket closed")}function h(p){t&&p.name!==t.name&&i()}const d=()=>{t.removeListener("open",r),t.removeListener("error",a),t.removeListener("close",o),this.off("close",l),this.off("upgrading",h)};t.once("open",r),t.once("error",a),t.once("close",o),this.once("close",l),this.once("upgrading",h),this._upgrades.indexOf("webtransport")!==-1&&e!=="webtransport"?this.setTimeoutFn(()=>{n||t.open()},200):t.open()}onHandshake(e){this._upgrades=this._filterUpgrades(e.upgrades),super.onHandshake(e)}_filterUpgrades(e){const t=[];for(let n=0;n<e.length;n++)~this.transports.indexOf(e[n])&&t.push(e[n]);return t}}let Uv=class extends Bv{constructor(e,t={}){const n=typeof e=="object"?e:t;(!n.transports||n.transports&&typeof n.transports[0]=="string")&&(n.transports=(n.transports||["polling","websocket","webtransport"]).map(r=>Dv[r]).filter(r=>!!r)),super(e,n)}};function Fv(s,e="",t){let n=s;t=t||typeof location<"u"&&location,s==null&&(s=t.protocol+"//"+t.host),typeof s=="string"&&(s.charAt(0)==="/"&&(s.charAt(1)==="/"?s=t.protocol+s:s=t.host+s),/^(https?|wss?):\/\//.test(s)||(typeof t<"u"?s=t.protocol+"//"+s:s="https://"+s),n=ll(s)),n.port||(/^(http|ws)$/.test(n.protocol)?n.port="80":/^(http|ws)s$/.test(n.protocol)&&(n.port="443")),n.path=n.path||"/";const i=n.host.indexOf(":")!==-1?"["+n.host+"]":n.host;return n.id=n.protocol+"://"+i+":"+n.port+e,n.href=n.protocol+"://"+i+(t&&t.port===n.port?"":":"+n.port),n}const kv=typeof ArrayBuffer=="function",jv=s=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(s):s.buffer instanceof ArrayBuffer,Xm=Object.prototype.toString,Wv=typeof Blob=="function"||typeof Blob<"u"&&Xm.call(Blob)==="[object BlobConstructor]",Qv=typeof File=="function"||typeof File<"u"&&Xm.call(File)==="[object FileConstructor]";function Kl(s){return kv&&(s instanceof ArrayBuffer||jv(s))||Wv&&s instanceof Blob||Qv&&s instanceof File}function mo(s,e){if(!s||typeof s!="object")return!1;if(Array.isArray(s)){for(let t=0,n=s.length;t<n;t++)if(mo(s[t]))return!0;return!1}if(Kl(s))return!0;if(s.toJSON&&typeof s.toJSON=="function"&&arguments.length===1)return mo(s.toJSON(),!0);for(const t in s)if(Object.prototype.hasOwnProperty.call(s,t)&&mo(s[t]))return!0;return!1}function Vv(s){const e=[],t=s.data,n=s;return n.data=dl(t,e),n.attachments=e.length,{packet:n,buffers:e}}function dl(s,e){if(!s)return s;if(Kl(s)){const t={_placeholder:!0,num:e.length};return e.push(s),t}else if(Array.isArray(s)){const t=new Array(s.length);for(let n=0;n<s.length;n++)t[n]=dl(s[n],e);return t}else if(typeof s=="object"&&!(s instanceof Date)){const t={};for(const n in s)Object.prototype.hasOwnProperty.call(s,n)&&(t[n]=dl(s[n],e));return t}return s}function Hv(s,e){return s.data=fl(s.data,e),delete s.attachments,s}function fl(s,e){if(!s)return s;if(s&&s._placeholder===!0){if(typeof s.num=="number"&&s.num>=0&&s.num<e.length)return e[s.num];throw new Error("illegal attachments")}else if(Array.isArray(s))for(let t=0;t<s.length;t++)s[t]=fl(s[t],e);else if(typeof s=="object")for(const t in s)Object.prototype.hasOwnProperty.call(s,t)&&(s[t]=fl(s[t],e));return s}const Yv=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"],Gv=5;var Ye;(function(s){s[s.CONNECT=0]="CONNECT",s[s.DISCONNECT=1]="DISCONNECT",s[s.EVENT=2]="EVENT",s[s.ACK=3]="ACK",s[s.CONNECT_ERROR=4]="CONNECT_ERROR",s[s.BINARY_EVENT=5]="BINARY_EVENT",s[s.BINARY_ACK=6]="BINARY_ACK"})(Ye||(Ye={}));class zv{constructor(e){this.replacer=e}encode(e){return(e.type===Ye.EVENT||e.type===Ye.ACK)&&mo(e)?this.encodeAsBinary({type:e.type===Ye.EVENT?Ye.BINARY_EVENT:Ye.BINARY_ACK,nsp:e.nsp,data:e.data,id:e.id}):[this.encodeAsString(e)]}encodeAsString(e){let t=""+e.type;return(e.type===Ye.BINARY_EVENT||e.type===Ye.BINARY_ACK)&&(t+=e.attachments+"-"),e.nsp&&e.nsp!=="/"&&(t+=e.nsp+","),e.id!=null&&(t+=e.id),e.data!=null&&(t+=JSON.stringify(e.data,this.replacer)),t}encodeAsBinary(e){const t=Vv(e),n=this.encodeAsString(t.packet),r=t.buffers;return r.unshift(n),r}}function mp(s){return Object.prototype.toString.call(s)==="[object Object]"}class Jl extends Mt{constructor(e){super(),this.reviver=e}add(e){let t;if(typeof e=="string"){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");t=this.decodeString(e);const n=t.type===Ye.BINARY_EVENT;n||t.type===Ye.BINARY_ACK?(t.type=n?Ye.EVENT:Ye.ACK,this.reconstructor=new Kv(t),t.attachments===0&&super.emitReserved("decoded",t)):super.emitReserved("decoded",t)}else if(Kl(e)||e.base64)if(this.reconstructor)t=this.reconstructor.takeBinaryData(e),t&&(this.reconstructor=null,super.emitReserved("decoded",t));else throw new Error("got binary data when not reconstructing a packet");else throw new Error("Unknown type: "+e)}decodeString(e){let t=0;const n={type:Number(e.charAt(0))};if(Ye[n.type]===void 0)throw new Error("unknown packet type "+n.type);if(n.type===Ye.BINARY_EVENT||n.type===Ye.BINARY_ACK){const i=t+1;for(;e.charAt(++t)!=="-"&&t!=e.length;);const a=e.substring(i,t);if(a!=Number(a)||e.charAt(t)!=="-")throw new Error("Illegal attachments");n.attachments=Number(a)}if(e.charAt(t+1)==="/"){const i=t+1;for(;++t&&!(e.charAt(t)===","||t===e.length););n.nsp=e.substring(i,t)}else n.nsp="/";const r=e.charAt(t+1);if(r!==""&&Number(r)==r){const i=t+1;for(;++t;){const a=e.charAt(t);if(a==null||Number(a)!=a){--t;break}if(t===e.length)break}n.id=Number(e.substring(i,t+1))}if(e.charAt(++t)){const i=this.tryParse(e.substr(t));if(Jl.isPayloadValid(n.type,i))n.data=i;else throw new Error("invalid payload")}return n}tryParse(e){try{return JSON.parse(e,this.reviver)}catch{return!1}}static isPayloadValid(e,t){switch(e){case Ye.CONNECT:return mp(t);case Ye.DISCONNECT:return t===void 0;case Ye.CONNECT_ERROR:return typeof t=="string"||mp(t);case Ye.EVENT:case Ye.BINARY_EVENT:return Array.isArray(t)&&(typeof t[0]=="number"||typeof t[0]=="string"&&Yv.indexOf(t[0])===-1);case Ye.ACK:case Ye.BINARY_ACK:return Array.isArray(t)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}}class Kv{constructor(e){this.packet=e,this.buffers=[],this.reconPack=e}takeBinaryData(e){if(this.buffers.push(e),this.buffers.length===this.reconPack.attachments){const t=Hv(this.reconPack,this.buffers);return this.finishedReconstruction(),t}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}const Jv=Object.freeze(Object.defineProperty({__proto__:null,Decoder:Jl,Encoder:zv,get PacketType(){return Ye},protocol:Gv},Symbol.toStringTag,{value:"Module"}));function Vn(s,e,t){return s.on(e,t),function(){s.off(e,t)}}const Xv=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class Zm extends Mt{constructor(e,t,n){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=e,this.nsp=t,n&&n.auth&&(this.auth=n.auth),this._opts=Object.assign({},n),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const e=this.io;this.subs=[Vn(e,"open",this.onopen.bind(this)),Vn(e,"packet",this.onpacket.bind(this)),Vn(e,"error",this.onerror.bind(this)),Vn(e,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected?this:(this.subEvents(),this.io._reconnecting||this.io.open(),this.io._readyState==="open"&&this.onopen(),this)}open(){return this.connect()}send(...e){return e.unshift("message"),this.emit.apply(this,e),this}emit(e,...t){var n,r,i;if(Xv.hasOwnProperty(e))throw new Error('"'+e.toString()+'" is a reserved event name');if(t.unshift(e),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(t),this;const a={type:Ye.EVENT,data:t};if(a.options={},a.options.compress=this.flags.compress!==!1,typeof t[t.length-1]=="function"){const d=this.ids++,p=t.pop();this._registerAckCallback(d,p),a.id=d}const o=(r=(n=this.io.engine)===null||n===void 0?void 0:n.transport)===null||r===void 0?void 0:r.writable,l=this.connected&&!(!((i=this.io.engine)===null||i===void 0)&&i._hasPingExpired());return this.flags.volatile&&!o||(l?(this.notifyOutgoingListeners(a),this.packet(a)):this.sendBuffer.push(a)),this.flags={},this}_registerAckCallback(e,t){var n;const r=(n=this.flags.timeout)!==null&&n!==void 0?n:this._opts.ackTimeout;if(r===void 0){this.acks[e]=t;return}const i=this.io.setTimeoutFn(()=>{delete this.acks[e];for(let o=0;o<this.sendBuffer.length;o++)this.sendBuffer[o].id===e&&this.sendBuffer.splice(o,1);t.call(this,new Error("operation has timed out"))},r),a=(...o)=>{this.io.clearTimeoutFn(i),t.apply(this,o)};a.withError=!0,this.acks[e]=a}emitWithAck(e,...t){return new Promise((n,r)=>{const i=(a,o)=>a?r(a):n(o);i.withError=!0,t.push(i),this.emit(e,...t)})}_addToQueue(e){let t;typeof e[e.length-1]=="function"&&(t=e.pop());const n={id:this._queueSeq++,tryCount:0,pending:!1,args:e,flags:Object.assign({fromQueue:!0},this.flags)};e.push((r,...i)=>n!==this._queue[0]?void 0:(r!==null?n.tryCount>this._opts.retries&&(this._queue.shift(),t&&t(r)):(this._queue.shift(),t&&t(null,...i)),n.pending=!1,this._drainQueue())),this._queue.push(n),this._drainQueue()}_drainQueue(e=!1){if(!this.connected||this._queue.length===0)return;const t=this._queue[0];t.pending&&!e||(t.pending=!0,t.tryCount++,this.flags=t.flags,this.emit.apply(this,t.args))}packet(e){e.nsp=this.nsp,this.io._packet(e)}onopen(){typeof this.auth=="function"?this.auth(e=>{this._sendConnectPacket(e)}):this._sendConnectPacket(this.auth)}_sendConnectPacket(e){this.packet({type:Ye.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},e):e})}onerror(e){this.connected||this.emitReserved("connect_error",e)}onclose(e,t){this.connected=!1,delete this.id,this.emitReserved("disconnect",e,t),this._clearAcks()}_clearAcks(){Object.keys(this.acks).forEach(e=>{if(!this.sendBuffer.some(n=>String(n.id)===e)){const n=this.acks[e];delete this.acks[e],n.withError&&n.call(this,new Error("socket has been disconnected"))}})}onpacket(e){if(e.nsp===this.nsp)switch(e.type){case Ye.CONNECT:e.data&&e.data.sid?this.onconnect(e.data.sid,e.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case Ye.EVENT:case Ye.BINARY_EVENT:this.onevent(e);break;case Ye.ACK:case Ye.BINARY_ACK:this.onack(e);break;case Ye.DISCONNECT:this.ondisconnect();break;case Ye.CONNECT_ERROR:this.destroy();const n=new Error(e.data.message);n.data=e.data.data,this.emitReserved("connect_error",n);break}}onevent(e){const t=e.data||[];e.id!=null&&t.push(this.ack(e.id)),this.connected?this.emitEvent(t):this.receiveBuffer.push(Object.freeze(t))}emitEvent(e){if(this._anyListeners&&this._anyListeners.length){const t=this._anyListeners.slice();for(const n of t)n.apply(this,e)}super.emit.apply(this,e),this._pid&&e.length&&typeof e[e.length-1]=="string"&&(this._lastOffset=e[e.length-1])}ack(e){const t=this;let n=!1;return function(...r){n||(n=!0,t.packet({type:Ye.ACK,id:e,data:r}))}}onack(e){const t=this.acks[e.id];typeof t=="function"&&(delete this.acks[e.id],t.withError&&e.data.unshift(null),t.apply(this,e.data))}onconnect(e,t){this.id=e,this.recovered=t&&this._pid===t,this._pid=t,this.connected=!0,this.emitBuffered(),this.emitReserved("connect"),this._drainQueue(!0)}emitBuffered(){this.receiveBuffer.forEach(e=>this.emitEvent(e)),this.receiveBuffer=[],this.sendBuffer.forEach(e=>{this.notifyOutgoingListeners(e),this.packet(e)}),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach(e=>e()),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:Ye.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(e){return this.flags.compress=e,this}get volatile(){return this.flags.volatile=!0,this}timeout(e){return this.flags.timeout=e,this}onAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(e),this}prependAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(e),this}offAny(e){if(!this._anyListeners)return this;if(e){const t=this._anyListeners;for(let n=0;n<t.length;n++)if(e===t[n])return t.splice(n,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(e),this}prependAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(e),this}offAnyOutgoing(e){if(!this._anyOutgoingListeners)return this;if(e){const t=this._anyOutgoingListeners;for(let n=0;n<t.length;n++)if(e===t[n])return t.splice(n,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(e){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const t=this._anyOutgoingListeners.slice();for(const n of t)n.apply(this,e.data)}}}function hs(s){s=s||{},this.ms=s.min||100,this.max=s.max||1e4,this.factor=s.factor||2,this.jitter=s.jitter>0&&s.jitter<=1?s.jitter:0,this.attempts=0}hs.prototype.duration=function(){var s=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var e=Math.random(),t=Math.floor(e*this.jitter*s);s=Math.floor(e*10)&1?s+t:s-t}return Math.min(s,this.max)|0};hs.prototype.reset=function(){this.attempts=0};hs.prototype.setMin=function(s){this.ms=s};hs.prototype.setMax=function(s){this.max=s};hs.prototype.setJitter=function(s){this.jitter=s};class pl extends Mt{constructor(e,t){var n;super(),this.nsps={},this.subs=[],e&&typeof e=="object"&&(t=e,e=void 0),t=t||{},t.path=t.path||"/socket.io",this.opts=t,Ho(this,t),this.reconnection(t.reconnection!==!1),this.reconnectionAttempts(t.reconnectionAttempts||1/0),this.reconnectionDelay(t.reconnectionDelay||1e3),this.reconnectionDelayMax(t.reconnectionDelayMax||5e3),this.randomizationFactor((n=t.randomizationFactor)!==null&&n!==void 0?n:.5),this.backoff=new hs({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(t.timeout==null?2e4:t.timeout),this._readyState="closed",this.uri=e;const r=t.parser||Jv;this.encoder=new r.Encoder,this.decoder=new r.Decoder,this._autoConnect=t.autoConnect!==!1,this._autoConnect&&this.open()}reconnection(e){return arguments.length?(this._reconnection=!!e,e||(this.skipReconnect=!0),this):this._reconnection}reconnectionAttempts(e){return e===void 0?this._reconnectionAttempts:(this._reconnectionAttempts=e,this)}reconnectionDelay(e){var t;return e===void 0?this._reconnectionDelay:(this._reconnectionDelay=e,(t=this.backoff)===null||t===void 0||t.setMin(e),this)}randomizationFactor(e){var t;return e===void 0?this._randomizationFactor:(this._randomizationFactor=e,(t=this.backoff)===null||t===void 0||t.setJitter(e),this)}reconnectionDelayMax(e){var t;return e===void 0?this._reconnectionDelayMax:(this._reconnectionDelayMax=e,(t=this.backoff)===null||t===void 0||t.setMax(e),this)}timeout(e){return arguments.length?(this._timeout=e,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&this.backoff.attempts===0&&this.reconnect()}open(e){if(~this._readyState.indexOf("open"))return this;this.engine=new Uv(this.uri,this.opts);const t=this.engine,n=this;this._readyState="opening",this.skipReconnect=!1;const r=Vn(t,"open",function(){n.onopen(),e&&e()}),i=o=>{this.cleanup(),this._readyState="closed",this.emitReserved("error",o),e?e(o):this.maybeReconnectOnOpen()},a=Vn(t,"error",i);if(this._timeout!==!1){const o=this._timeout,l=this.setTimeoutFn(()=>{r(),i(new Error("timeout")),t.close()},o);this.opts.autoUnref&&l.unref(),this.subs.push(()=>{this.clearTimeoutFn(l)})}return this.subs.push(r),this.subs.push(a),this}connect(e){return this.open(e)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");const e=this.engine;this.subs.push(Vn(e,"ping",this.onping.bind(this)),Vn(e,"data",this.ondata.bind(this)),Vn(e,"error",this.onerror.bind(this)),Vn(e,"close",this.onclose.bind(this)),Vn(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(e){try{this.decoder.add(e)}catch(t){this.onclose("parse error",t)}}ondecoded(e){Vo(()=>{this.emitReserved("packet",e)},this.setTimeoutFn)}onerror(e){this.emitReserved("error",e)}socket(e,t){let n=this.nsps[e];return n?this._autoConnect&&!n.active&&n.connect():(n=new Zm(this,e,t),this.nsps[e]=n),n}_destroy(e){const t=Object.keys(this.nsps);for(const n of t)if(this.nsps[n].active)return;this._close()}_packet(e){const t=this.encoder.encode(e);for(let n=0;n<t.length;n++)this.engine.write(t[n],e.options)}cleanup(){this.subs.forEach(e=>e()),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close")}disconnect(){return this._close()}onclose(e,t){var n;this.cleanup(),(n=this.engine)===null||n===void 0||n.close(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",e,t),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const e=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{const t=this.backoff.duration();this._reconnecting=!0;const n=this.setTimeoutFn(()=>{e.skipReconnect||(this.emitReserved("reconnect_attempt",e.backoff.attempts),!e.skipReconnect&&e.open(r=>{r?(e._reconnecting=!1,e.reconnect(),this.emitReserved("reconnect_error",r)):e.onreconnect()}))},t);this.opts.autoUnref&&n.unref(),this.subs.push(()=>{this.clearTimeoutFn(n)})}}onreconnect(){const e=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",e)}}const Bs={};function ns(s,e){typeof s=="object"&&(e=s,s=void 0),e=e||{};const t=Fv(s,e.path||"/socket.io"),n=t.source,r=t.id,i=t.path,a=Bs[r]&&i in Bs[r].nsps,o=e.forceNew||e["force new connection"]||e.multiplex===!1||a;let l;return o?l=new pl(n,e):(Bs[r]||(Bs[r]=new pl(n,e)),l=Bs[r]),t.query&&!e.query&&(e.query=t.queryKey),l.socket(t.path,e)}Object.assign(ns,{Manager:pl,Socket:Zm,io:ns,connect:ns});var Lt={};const Zv={jwt:null,ttl:300},ri={env:{app:"cd-shell",debug:!0},cdApiLocal:"cd-api-local",cdGitConfig:"cd-git-config",profiles:{cdApiLocal:{endpoint:"https://localhost:3001/api"}},cdSession:Zv,meta:{name:"cd-cli",version:"1.0.0",description:"Your description here",showHelpAfterError:!0},preferences:{encryption:{encryptionKey:Lt.CD_CLI_ENCRYPT_KEY},backUp:[{profileName:"cd-git-config",field:"details.gitAccess.gitHubToken",useLocal:{state:!1,storePath:"~/.cd-cli/"},useWeb3:{state:!1},useCloud:{state:!1}}]},back4app:{url:Lt.B4A_URL,appId:Lt.X_Parse_Application_Id,apiKey:Lt.X_Parse_REST_API_Key},usePush:!0,usePolling:!0,useCacheStore:!0,cacheTtl:Lt.CACHE_TTL,emailUsers:[{name:"ASDAP",email:Lt.EMAIL_ADDRESS,user:Lt.EMAIL_USERNAME,pass:Lt.EMAIL_PASSWORD,auth:{user:Lt.EMAIL_USERNAME,pass:Lt.EMAIL_PASSWORD}}],viteWorkspacePath:"/home/emp-12/cd-shell/src",viteHttpServer:{open:!0,port:4173},cdApi:{endpoint:"https://localhost:3001/api",serverHost:"localhost",serverPort:"3001",entryPoint:"/api",timeout:15e3},cdSio:{endpoint:"https://localhost:3002",serverHost:"localhost",serverPort:"3002",entryPoint:"/socket.io",timeout:15e3},push:{mode:Lt.PUSH_MODE,wsMode:"sio",serverHost:"https://146.190.165.51",serverPort:Lt.SIO_PORT,redisHost:Lt.REDIS_HOST,redisPort:Lt.REDIS_PORT,startupNodes:[{port:6380,host:Lt.REDIS_HOST},{port:6381,host:"146.190.157.42"}],sentinalOptions:{sentinels:[{host:Lt.REDIS_HOST,port:Number(Lt.REDIS_PORT)},{host:"asdap.net",port:Number(Lt.REDIS_PORT)}],name:"master01"}},devSync:{storageType:"memory",sioEndpoint:"wss://cd-sio-server",appId:"vite-dev-instance",autoInitialize:!0},modules:{sys:{}}};class ku{constructor(){this.store=new Map}async save(e,t){this.store.set(e,t)}async get(e){return this.store.get(e)??null}async delete(e){this.store.delete(e)}async clear(){this.store.clear()}}const ci=()=>typeof window<"u"&&typeof document<"u"?"serviceWorker"in navigator||window.matchMedia("(display-mode: standalone)").matches||window.location.protocol==="file:"?"pwa":"browser":typeof process<"u"&&process.versions!=null&&process.versions.node!=null?process.argv[1]?"cli":"node":"unknown",Gs=()=>ci()==="node"||ci()==="cli",e0=()=>ci()==="browser",t0=()=>ci()==="pwa";let Wn=null,Ji=null;Gs()&&(Br(()=>import("./__vite-browser-external_fs-DU1_jvsO.js"),[]).then(s=>Wn=s),Br(()=>import("./__vite-browser-external_path-SE2pKm0_.js"),[]).then(s=>Ji=s));class yp{constructor(e){this.isInitialized=!1,this.storagePath=e||"./data"}async ensureNodeEnvironment(){if(!Gs())throw new Error("FileStoreService is only available in Node.js environment");this.isInitialized||(Wn||(Wn=await Br(()=>import("./__vite-browser-external_fs-DU1_jvsO.js"),[])),Ji||(Ji=await Br(()=>import("./__vite-browser-external_path-SE2pKm0_.js"),[])),this.isInitialized=!0)}async get(e){await this.ensureNodeEnvironment();try{const t=Ji.join(this.storagePath,`${e}.json`),n=await Wn.promises.readFile(t,"utf-8");return JSON.parse(n)}catch(t){if(t.code==="ENOENT")return null;throw t}}async set(e,t){await this.ensureNodeEnvironment(),await Wn.promises.mkdir(this.storagePath,{recursive:!0});const n=Ji.join(this.storagePath,`${e}.json`);await Wn.promises.writeFile(n,JSON.stringify(t,null,2))}async delete(e){await this.ensureNodeEnvironment();const t=Ji.join(this.storagePath,`${e}.json`);try{await Wn.promises.unlink(t)}catch(n){if(n.code!=="ENOENT")throw n}}async clear(){await this.ensureNodeEnvironment();try{await Wn.promises.rm(this.storagePath,{recursive:!0,force:!0})}catch{}}async keys(){await this.ensureNodeEnvironment();try{return(await Wn.promises.readdir(this.storagePath)).filter(t=>t.endsWith(".json")).map(t=>t.replace(".json",""))}catch(e){if(e.code==="ENOENT")return[];throw e}}static isAvailable(){return Gs()}async readFile(){try{const e=await Wn.readFile(this.filePath,"utf-8");return JSON.parse(e||"{}")}catch{return{}}}async writeFile(e){await Wn.writeFile(this.filePath,JSON.stringify(e,null,2),"utf-8")}async save(e,t){const n=await this.readFile();n[e]=t,await this.writeFile(n)}}class gp{init(e){this.redisClient=e}async save(e,t){await this.redisClient.set(e,JSON.stringify(t))}async get(e){const t=await this.redisClient.get(e);return t?JSON.parse(t):null}async delete(e){await this.redisClient.del(e)}async clear(){await this.redisClient.flushDb()}static isAvailable(){return Gs()}}class n0{static create(e="memory",t){switch(e){case"file":return yp.isAvailable()?new yp(t==null?void 0:t.storagePath):(console.warn("FileStore is not available in this environment. Falling back to MemoryStore."),new ku);case"redis":return gp.isAvailable()?new gp:(console.warn("RedisStore is not available in this environment. Falling back to MemoryStore."),new ku);case"memory":default:return new ku}}static createEnvironmentAwareStore(e){return Gs()?this.create("file",e):t0()||e0()?this.create("memory",e):this.create("memory",e)}}const Ep=ci(),ti=Ep==="browser"||Ep==="pwa",r0={env:{NODE_ENV:ti?"production":"development"},version:ti?"v18.0.0":process.version,versions:ti?{node:"18.0.0"}:process.versions,platform:ti?"browser":process.platform,arch:ti?"x64":process.arch,cwd:()=>ti?"/":process.cwd(),nextTick:ti?(s,...e)=>Promise.resolve().then(()=>s(...e)):process.nextTick};ti&&typeof window<"u"&&(window.process=r0);var xo={exports:{}};/**
 * @license
 * Lodash <https://lodash.com/>
 * Copyright OpenJS Foundation and other contributors <https://openjsf.org/>
 * Released under MIT license <https://lodash.com/license>
 * Based on Underscore.js 1.8.3 <http://underscorejs.org/LICENSE>
 * Copyright Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
 */xo.exports;(function(s,e){(function(){var t,n="4.17.21",r=200,i="Unsupported core-js use. Try https://npms.io/search?q=ponyfill.",a="Expected a function",o="Invalid `variable` option passed into `_.template`",l="__lodash_hash_undefined__",h=500,d="__lodash_placeholder__",p=1,m=2,w=4,b=1,S=2,R=1,$=2,q=4,O=8,J=16,ne=32,ge=64,pe=128,me=256,V=512,Ae=30,D="...",ae=800,Q=16,te=1,ce=2,fe=3,oe=1/0,ye=9007199254740991,Ge=17976931348623157e292,ze=NaN,_e=4294967295,We=_e-1,F=_e>>>1,Y=[["ary",pe],["bind",R],["bindKey",$],["curry",O],["curryRight",J],["flip",V],["partial",ne],["partialRight",ge],["rearg",me]],Z="[object Arguments]",Ee="[object Array]",Oe="[object AsyncFunction]",Me="[object Boolean]",xe="[object Date]",ke="[object DOMException]",Ke="[object Error]",wt="[object Function]",Bt="[object GeneratorFunction]",Tt="[object Map]",nn="[object Number]",Wr="[object Null]",Jt="[object Object]",Oi="[object Promise]",X="[object Proxy]",ir="[object RegExp]",Ut="[object Set]",Wt="[object String]",Qr="[object Symbol]",Nc="[object Undefined]",rn="[object WeakMap]",Cc="[object WeakSet]",A="[object ArrayBuffer]",g="[object DataView]",E="[object Float32Array]",v="[object Float64Array]",I="[object Int8Array]",k="[object Int16Array]",G="[object Int32Array]",Le="[object Uint8Array]",ut="[object Uint8ClampedArray]",at="[object Uint16Array]",lt="[object Uint32Array]",it=/\b__p \+= '';/g,EE=/\b(__p \+=) '' \+/g,wE=/(__e\(.*?\)|\b__t\)) \+\n'';/g,$h=/&(?:amp|lt|gt|quot|#39);/g,Lh=/[&<>"']/g,bE=RegExp($h.source),TE=RegExp(Lh.source),SE=/<%-([\s\S]+?)%>/g,AE=/<%([\s\S]+?)%>/g,qh=/<%=([\s\S]+?)%>/g,NE=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,CE=/^\w*$/,vE=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,vc=/[\\^$.*+?()[\]{}|]/g,RE=RegExp(vc.source),Rc=/^\s+/,_E=/\s/,xE=/\{(?:\n\/\* \[wrapped with .+\] \*\/)?\n?/,ME=/\{\n\/\* \[wrapped with (.+)\] \*/,PE=/,? & /,OE=/[^\x00-\x2f\x3a-\x40\x5b-\x60\x7b-\x7f]+/g,DE=/[()=,{}\[\]\/\s]/,IE=/\\(\\)?/g,$E=/\$\{([^\\}]*(?:\\.[^\\}]*)*)\}/g,Bh=/\w*$/,LE=/^[-+]0x[0-9a-f]+$/i,qE=/^0b[01]+$/i,BE=/^\[object .+?Constructor\]$/,UE=/^0o[0-7]+$/i,FE=/^(?:0|[1-9]\d*)$/,kE=/[\xc0-\xd6\xd8-\xf6\xf8-\xff\u0100-\u017f]/g,fa=/($^)/,jE=/['\n\r\u2028\u2029\\]/g,pa="\\ud800-\\udfff",WE="\\u0300-\\u036f",QE="\\ufe20-\\ufe2f",VE="\\u20d0-\\u20ff",Uh=WE+QE+VE,Fh="\\u2700-\\u27bf",kh="a-z\\xdf-\\xf6\\xf8-\\xff",HE="\\xac\\xb1\\xd7\\xf7",YE="\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf",GE="\\u2000-\\u206f",zE=" \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000",jh="A-Z\\xc0-\\xd6\\xd8-\\xde",Wh="\\ufe0e\\ufe0f",Qh=HE+YE+GE+zE,_c="['’]",KE="["+pa+"]",Vh="["+Qh+"]",ma="["+Uh+"]",Hh="\\d+",JE="["+Fh+"]",Yh="["+kh+"]",Gh="[^"+pa+Qh+Hh+Fh+kh+jh+"]",xc="\\ud83c[\\udffb-\\udfff]",XE="(?:"+ma+"|"+xc+")",zh="[^"+pa+"]",Mc="(?:\\ud83c[\\udde6-\\uddff]){2}",Pc="[\\ud800-\\udbff][\\udc00-\\udfff]",Di="["+jh+"]",Kh="\\u200d",Jh="(?:"+Yh+"|"+Gh+")",ZE="(?:"+Di+"|"+Gh+")",Xh="(?:"+_c+"(?:d|ll|m|re|s|t|ve))?",Zh="(?:"+_c+"(?:D|LL|M|RE|S|T|VE))?",ed=XE+"?",td="["+Wh+"]?",ew="(?:"+Kh+"(?:"+[zh,Mc,Pc].join("|")+")"+td+ed+")*",tw="\\d*(?:1st|2nd|3rd|(?![123])\\dth)(?=\\b|[A-Z_])",nw="\\d*(?:1ST|2ND|3RD|(?![123])\\dTH)(?=\\b|[a-z_])",nd=td+ed+ew,rw="(?:"+[JE,Mc,Pc].join("|")+")"+nd,iw="(?:"+[zh+ma+"?",ma,Mc,Pc,KE].join("|")+")",sw=RegExp(_c,"g"),aw=RegExp(ma,"g"),Oc=RegExp(xc+"(?="+xc+")|"+iw+nd,"g"),ow=RegExp([Di+"?"+Yh+"+"+Xh+"(?="+[Vh,Di,"$"].join("|")+")",ZE+"+"+Zh+"(?="+[Vh,Di+Jh,"$"].join("|")+")",Di+"?"+Jh+"+"+Xh,Di+"+"+Zh,nw,tw,Hh,rw].join("|"),"g"),cw=RegExp("["+Kh+pa+Uh+Wh+"]"),uw=/[a-z][A-Z]|[A-Z]{2}[a-z]|[0-9][a-zA-Z]|[a-zA-Z][0-9]|[^a-zA-Z0-9 ]/,lw=["Array","Buffer","DataView","Date","Error","Float32Array","Float64Array","Function","Int8Array","Int16Array","Int32Array","Map","Math","Object","Promise","RegExp","Set","String","Symbol","TypeError","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","WeakMap","_","clearTimeout","isFinite","parseInt","setTimeout"],hw=-1,dt={};dt[E]=dt[v]=dt[I]=dt[k]=dt[G]=dt[Le]=dt[ut]=dt[at]=dt[lt]=!0,dt[Z]=dt[Ee]=dt[A]=dt[Me]=dt[g]=dt[xe]=dt[Ke]=dt[wt]=dt[Tt]=dt[nn]=dt[Jt]=dt[ir]=dt[Ut]=dt[Wt]=dt[rn]=!1;var ht={};ht[Z]=ht[Ee]=ht[A]=ht[g]=ht[Me]=ht[xe]=ht[E]=ht[v]=ht[I]=ht[k]=ht[G]=ht[Tt]=ht[nn]=ht[Jt]=ht[ir]=ht[Ut]=ht[Wt]=ht[Qr]=ht[Le]=ht[ut]=ht[at]=ht[lt]=!0,ht[Ke]=ht[wt]=ht[rn]=!1;var dw={À:"A",Á:"A",Â:"A",Ã:"A",Ä:"A",Å:"A",à:"a",á:"a",â:"a",ã:"a",ä:"a",å:"a",Ç:"C",ç:"c",Ð:"D",ð:"d",È:"E",É:"E",Ê:"E",Ë:"E",è:"e",é:"e",ê:"e",ë:"e",Ì:"I",Í:"I",Î:"I",Ï:"I",ì:"i",í:"i",î:"i",ï:"i",Ñ:"N",ñ:"n",Ò:"O",Ó:"O",Ô:"O",Õ:"O",Ö:"O",Ø:"O",ò:"o",ó:"o",ô:"o",õ:"o",ö:"o",ø:"o",Ù:"U",Ú:"U",Û:"U",Ü:"U",ù:"u",ú:"u",û:"u",ü:"u",Ý:"Y",ý:"y",ÿ:"y",Æ:"Ae",æ:"ae",Þ:"Th",þ:"th",ß:"ss",Ā:"A",Ă:"A",Ą:"A",ā:"a",ă:"a",ą:"a",Ć:"C",Ĉ:"C",Ċ:"C",Č:"C",ć:"c",ĉ:"c",ċ:"c",č:"c",Ď:"D",Đ:"D",ď:"d",đ:"d",Ē:"E",Ĕ:"E",Ė:"E",Ę:"E",Ě:"E",ē:"e",ĕ:"e",ė:"e",ę:"e",ě:"e",Ĝ:"G",Ğ:"G",Ġ:"G",Ģ:"G",ĝ:"g",ğ:"g",ġ:"g",ģ:"g",Ĥ:"H",Ħ:"H",ĥ:"h",ħ:"h",Ĩ:"I",Ī:"I",Ĭ:"I",Į:"I",İ:"I",ĩ:"i",ī:"i",ĭ:"i",į:"i",ı:"i",Ĵ:"J",ĵ:"j",Ķ:"K",ķ:"k",ĸ:"k",Ĺ:"L",Ļ:"L",Ľ:"L",Ŀ:"L",Ł:"L",ĺ:"l",ļ:"l",ľ:"l",ŀ:"l",ł:"l",Ń:"N",Ņ:"N",Ň:"N",Ŋ:"N",ń:"n",ņ:"n",ň:"n",ŋ:"n",Ō:"O",Ŏ:"O",Ő:"O",ō:"o",ŏ:"o",ő:"o",Ŕ:"R",Ŗ:"R",Ř:"R",ŕ:"r",ŗ:"r",ř:"r",Ś:"S",Ŝ:"S",Ş:"S",Š:"S",ś:"s",ŝ:"s",ş:"s",š:"s",Ţ:"T",Ť:"T",Ŧ:"T",ţ:"t",ť:"t",ŧ:"t",Ũ:"U",Ū:"U",Ŭ:"U",Ů:"U",Ű:"U",Ų:"U",ũ:"u",ū:"u",ŭ:"u",ů:"u",ű:"u",ų:"u",Ŵ:"W",ŵ:"w",Ŷ:"Y",ŷ:"y",Ÿ:"Y",Ź:"Z",Ż:"Z",Ž:"Z",ź:"z",ż:"z",ž:"z",Ĳ:"IJ",ĳ:"ij",Œ:"Oe",œ:"oe",ŉ:"'n",ſ:"s"},fw={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},pw={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"},mw={"\\":"\\","'":"'","\n":"n","\r":"r","\u2028":"u2028","\u2029":"u2029"},yw=parseFloat,gw=parseInt,rd=typeof bi=="object"&&bi&&bi.Object===Object&&bi,Ew=typeof self=="object"&&self&&self.Object===Object&&self,Ft=rd||Ew||Function("return this")(),Dc=e&&!e.nodeType&&e,li=Dc&&!0&&s&&!s.nodeType&&s,id=li&&li.exports===Dc,Ic=id&&rd.process,Tn=function(){try{var L=li&&li.require&&li.require("util").types;return L||Ic&&Ic.binding&&Ic.binding("util")}catch{}}(),sd=Tn&&Tn.isArrayBuffer,ad=Tn&&Tn.isDate,od=Tn&&Tn.isMap,cd=Tn&&Tn.isRegExp,ud=Tn&&Tn.isSet,ld=Tn&&Tn.isTypedArray;function fn(L,H,W){switch(W.length){case 0:return L.call(H);case 1:return L.call(H,W[0]);case 2:return L.call(H,W[0],W[1]);case 3:return L.call(H,W[0],W[1],W[2])}return L.apply(H,W)}function ww(L,H,W,he){for(var De=-1,nt=L==null?0:L.length;++De<nt;){var Pt=L[De];H(he,Pt,W(Pt),L)}return he}function Sn(L,H){for(var W=-1,he=L==null?0:L.length;++W<he&&H(L[W],W,L)!==!1;);return L}function bw(L,H){for(var W=L==null?0:L.length;W--&&H(L[W],W,L)!==!1;);return L}function hd(L,H){for(var W=-1,he=L==null?0:L.length;++W<he;)if(!H(L[W],W,L))return!1;return!0}function Vr(L,H){for(var W=-1,he=L==null?0:L.length,De=0,nt=[];++W<he;){var Pt=L[W];H(Pt,W,L)&&(nt[De++]=Pt)}return nt}function ya(L,H){var W=L==null?0:L.length;return!!W&&Ii(L,H,0)>-1}function $c(L,H,W){for(var he=-1,De=L==null?0:L.length;++he<De;)if(W(H,L[he]))return!0;return!1}function yt(L,H){for(var W=-1,he=L==null?0:L.length,De=Array(he);++W<he;)De[W]=H(L[W],W,L);return De}function Hr(L,H){for(var W=-1,he=H.length,De=L.length;++W<he;)L[De+W]=H[W];return L}function Lc(L,H,W,he){var De=-1,nt=L==null?0:L.length;for(he&&nt&&(W=L[++De]);++De<nt;)W=H(W,L[De],De,L);return W}function Tw(L,H,W,he){var De=L==null?0:L.length;for(he&&De&&(W=L[--De]);De--;)W=H(W,L[De],De,L);return W}function qc(L,H){for(var W=-1,he=L==null?0:L.length;++W<he;)if(H(L[W],W,L))return!0;return!1}var Sw=Bc("length");function Aw(L){return L.split("")}function Nw(L){return L.match(OE)||[]}function dd(L,H,W){var he;return W(L,function(De,nt,Pt){if(H(De,nt,Pt))return he=nt,!1}),he}function ga(L,H,W,he){for(var De=L.length,nt=W+(he?1:-1);he?nt--:++nt<De;)if(H(L[nt],nt,L))return nt;return-1}function Ii(L,H,W){return H===H?Lw(L,H,W):ga(L,fd,W)}function Cw(L,H,W,he){for(var De=W-1,nt=L.length;++De<nt;)if(he(L[De],H))return De;return-1}function fd(L){return L!==L}function pd(L,H){var W=L==null?0:L.length;return W?Fc(L,H)/W:ze}function Bc(L){return function(H){return H==null?t:H[L]}}function Uc(L){return function(H){return L==null?t:L[H]}}function md(L,H,W,he,De){return De(L,function(nt,Pt,ct){W=he?(he=!1,nt):H(W,nt,Pt,ct)}),W}function vw(L,H){var W=L.length;for(L.sort(H);W--;)L[W]=L[W].value;return L}function Fc(L,H){for(var W,he=-1,De=L.length;++he<De;){var nt=H(L[he]);nt!==t&&(W=W===t?nt:W+nt)}return W}function kc(L,H){for(var W=-1,he=Array(L);++W<L;)he[W]=H(W);return he}function Rw(L,H){return yt(H,function(W){return[W,L[W]]})}function yd(L){return L&&L.slice(0,bd(L)+1).replace(Rc,"")}function pn(L){return function(H){return L(H)}}function jc(L,H){return yt(H,function(W){return L[W]})}function As(L,H){return L.has(H)}function gd(L,H){for(var W=-1,he=L.length;++W<he&&Ii(H,L[W],0)>-1;);return W}function Ed(L,H){for(var W=L.length;W--&&Ii(H,L[W],0)>-1;);return W}function _w(L,H){for(var W=L.length,he=0;W--;)L[W]===H&&++he;return he}var xw=Uc(dw),Mw=Uc(fw);function Pw(L){return"\\"+mw[L]}function Ow(L,H){return L==null?t:L[H]}function $i(L){return cw.test(L)}function Dw(L){return uw.test(L)}function Iw(L){for(var H,W=[];!(H=L.next()).done;)W.push(H.value);return W}function Wc(L){var H=-1,W=Array(L.size);return L.forEach(function(he,De){W[++H]=[De,he]}),W}function wd(L,H){return function(W){return L(H(W))}}function Yr(L,H){for(var W=-1,he=L.length,De=0,nt=[];++W<he;){var Pt=L[W];(Pt===H||Pt===d)&&(L[W]=d,nt[De++]=W)}return nt}function Ea(L){var H=-1,W=Array(L.size);return L.forEach(function(he){W[++H]=he}),W}function $w(L){var H=-1,W=Array(L.size);return L.forEach(function(he){W[++H]=[he,he]}),W}function Lw(L,H,W){for(var he=W-1,De=L.length;++he<De;)if(L[he]===H)return he;return-1}function qw(L,H,W){for(var he=W+1;he--;)if(L[he]===H)return he;return he}function Li(L){return $i(L)?Uw(L):Sw(L)}function Un(L){return $i(L)?Fw(L):Aw(L)}function bd(L){for(var H=L.length;H--&&_E.test(L.charAt(H)););return H}var Bw=Uc(pw);function Uw(L){for(var H=Oc.lastIndex=0;Oc.test(L);)++H;return H}function Fw(L){return L.match(Oc)||[]}function kw(L){return L.match(ow)||[]}var jw=function L(H){H=H==null?Ft:qi.defaults(Ft.Object(),H,qi.pick(Ft,lw));var W=H.Array,he=H.Date,De=H.Error,nt=H.Function,Pt=H.Math,ct=H.Object,Qc=H.RegExp,Ww=H.String,An=H.TypeError,wa=W.prototype,Qw=nt.prototype,Bi=ct.prototype,ba=H["__core-js_shared__"],Ta=Qw.toString,st=Bi.hasOwnProperty,Vw=0,Td=function(){var c=/[^.]+$/.exec(ba&&ba.keys&&ba.keys.IE_PROTO||"");return c?"Symbol(src)_1."+c:""}(),Sa=Bi.toString,Hw=Ta.call(ct),Yw=Ft._,Gw=Qc("^"+Ta.call(st).replace(vc,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),Aa=id?H.Buffer:t,Gr=H.Symbol,Na=H.Uint8Array,Sd=Aa?Aa.allocUnsafe:t,Ca=wd(ct.getPrototypeOf,ct),Ad=ct.create,Nd=Bi.propertyIsEnumerable,va=wa.splice,Cd=Gr?Gr.isConcatSpreadable:t,Ns=Gr?Gr.iterator:t,hi=Gr?Gr.toStringTag:t,Ra=function(){try{var c=yi(ct,"defineProperty");return c({},"",{}),c}catch{}}(),zw=H.clearTimeout!==Ft.clearTimeout&&H.clearTimeout,Kw=he&&he.now!==Ft.Date.now&&he.now,Jw=H.setTimeout!==Ft.setTimeout&&H.setTimeout,_a=Pt.ceil,xa=Pt.floor,Vc=ct.getOwnPropertySymbols,Xw=Aa?Aa.isBuffer:t,vd=H.isFinite,Zw=wa.join,eb=wd(ct.keys,ct),Ot=Pt.max,Qt=Pt.min,tb=he.now,nb=H.parseInt,Rd=Pt.random,rb=wa.reverse,Hc=yi(H,"DataView"),Cs=yi(H,"Map"),Yc=yi(H,"Promise"),Ui=yi(H,"Set"),vs=yi(H,"WeakMap"),Rs=yi(ct,"create"),Ma=vs&&new vs,Fi={},ib=gi(Hc),sb=gi(Cs),ab=gi(Yc),ob=gi(Ui),cb=gi(vs),Pa=Gr?Gr.prototype:t,_s=Pa?Pa.valueOf:t,_d=Pa?Pa.toString:t;function N(c){if(St(c)&&!Ie(c)&&!(c instanceof Qe)){if(c instanceof Nn)return c;if(st.call(c,"__wrapped__"))return Mf(c)}return new Nn(c)}var ki=function(){function c(){}return function(u){if(!bt(u))return{};if(Ad)return Ad(u);c.prototype=u;var f=new c;return c.prototype=t,f}}();function Oa(){}function Nn(c,u){this.__wrapped__=c,this.__actions__=[],this.__chain__=!!u,this.__index__=0,this.__values__=t}N.templateSettings={escape:SE,evaluate:AE,interpolate:qh,variable:"",imports:{_:N}},N.prototype=Oa.prototype,N.prototype.constructor=N,Nn.prototype=ki(Oa.prototype),Nn.prototype.constructor=Nn;function Qe(c){this.__wrapped__=c,this.__actions__=[],this.__dir__=1,this.__filtered__=!1,this.__iteratees__=[],this.__takeCount__=_e,this.__views__=[]}function ub(){var c=new Qe(this.__wrapped__);return c.__actions__=sn(this.__actions__),c.__dir__=this.__dir__,c.__filtered__=this.__filtered__,c.__iteratees__=sn(this.__iteratees__),c.__takeCount__=this.__takeCount__,c.__views__=sn(this.__views__),c}function lb(){if(this.__filtered__){var c=new Qe(this);c.__dir__=-1,c.__filtered__=!0}else c=this.clone(),c.__dir__*=-1;return c}function hb(){var c=this.__wrapped__.value(),u=this.__dir__,f=Ie(c),y=u<0,T=f?c.length:0,C=AT(0,T,this.__views__),M=C.start,P=C.end,U=P-M,z=y?P:M-1,K=this.__iteratees__,ee=K.length,ue=0,we=Qt(U,this.__takeCount__);if(!f||!y&&T==U&&we==U)return Xd(c,this.__actions__);var Ce=[];e:for(;U--&&ue<we;){z+=u;for(var Ue=-1,ve=c[z];++Ue<ee;){var je=K[Ue],He=je.iteratee,gn=je.type,en=He(ve);if(gn==ce)ve=en;else if(!en){if(gn==te)continue e;break e}}Ce[ue++]=ve}return Ce}Qe.prototype=ki(Oa.prototype),Qe.prototype.constructor=Qe;function di(c){var u=-1,f=c==null?0:c.length;for(this.clear();++u<f;){var y=c[u];this.set(y[0],y[1])}}function db(){this.__data__=Rs?Rs(null):{},this.size=0}function fb(c){var u=this.has(c)&&delete this.__data__[c];return this.size-=u?1:0,u}function pb(c){var u=this.__data__;if(Rs){var f=u[c];return f===l?t:f}return st.call(u,c)?u[c]:t}function mb(c){var u=this.__data__;return Rs?u[c]!==t:st.call(u,c)}function yb(c,u){var f=this.__data__;return this.size+=this.has(c)?0:1,f[c]=Rs&&u===t?l:u,this}di.prototype.clear=db,di.prototype.delete=fb,di.prototype.get=pb,di.prototype.has=mb,di.prototype.set=yb;function br(c){var u=-1,f=c==null?0:c.length;for(this.clear();++u<f;){var y=c[u];this.set(y[0],y[1])}}function gb(){this.__data__=[],this.size=0}function Eb(c){var u=this.__data__,f=Da(u,c);if(f<0)return!1;var y=u.length-1;return f==y?u.pop():va.call(u,f,1),--this.size,!0}function wb(c){var u=this.__data__,f=Da(u,c);return f<0?t:u[f][1]}function bb(c){return Da(this.__data__,c)>-1}function Tb(c,u){var f=this.__data__,y=Da(f,c);return y<0?(++this.size,f.push([c,u])):f[y][1]=u,this}br.prototype.clear=gb,br.prototype.delete=Eb,br.prototype.get=wb,br.prototype.has=bb,br.prototype.set=Tb;function Tr(c){var u=-1,f=c==null?0:c.length;for(this.clear();++u<f;){var y=c[u];this.set(y[0],y[1])}}function Sb(){this.size=0,this.__data__={hash:new di,map:new(Cs||br),string:new di}}function Ab(c){var u=Va(this,c).delete(c);return this.size-=u?1:0,u}function Nb(c){return Va(this,c).get(c)}function Cb(c){return Va(this,c).has(c)}function vb(c,u){var f=Va(this,c),y=f.size;return f.set(c,u),this.size+=f.size==y?0:1,this}Tr.prototype.clear=Sb,Tr.prototype.delete=Ab,Tr.prototype.get=Nb,Tr.prototype.has=Cb,Tr.prototype.set=vb;function fi(c){var u=-1,f=c==null?0:c.length;for(this.__data__=new Tr;++u<f;)this.add(c[u])}function Rb(c){return this.__data__.set(c,l),this}function _b(c){return this.__data__.has(c)}fi.prototype.add=fi.prototype.push=Rb,fi.prototype.has=_b;function Fn(c){var u=this.__data__=new br(c);this.size=u.size}function xb(){this.__data__=new br,this.size=0}function Mb(c){var u=this.__data__,f=u.delete(c);return this.size=u.size,f}function Pb(c){return this.__data__.get(c)}function Ob(c){return this.__data__.has(c)}function Db(c,u){var f=this.__data__;if(f instanceof br){var y=f.__data__;if(!Cs||y.length<r-1)return y.push([c,u]),this.size=++f.size,this;f=this.__data__=new Tr(y)}return f.set(c,u),this.size=f.size,this}Fn.prototype.clear=xb,Fn.prototype.delete=Mb,Fn.prototype.get=Pb,Fn.prototype.has=Ob,Fn.prototype.set=Db;function xd(c,u){var f=Ie(c),y=!f&&Ei(c),T=!f&&!y&&Zr(c),C=!f&&!y&&!T&&Vi(c),M=f||y||T||C,P=M?kc(c.length,Ww):[],U=P.length;for(var z in c)(u||st.call(c,z))&&!(M&&(z=="length"||T&&(z=="offset"||z=="parent")||C&&(z=="buffer"||z=="byteLength"||z=="byteOffset")||Cr(z,U)))&&P.push(z);return P}function Md(c){var u=c.length;return u?c[iu(0,u-1)]:t}function Ib(c,u){return Ha(sn(c),pi(u,0,c.length))}function $b(c){return Ha(sn(c))}function Gc(c,u,f){(f!==t&&!kn(c[u],f)||f===t&&!(u in c))&&Sr(c,u,f)}function xs(c,u,f){var y=c[u];(!(st.call(c,u)&&kn(y,f))||f===t&&!(u in c))&&Sr(c,u,f)}function Da(c,u){for(var f=c.length;f--;)if(kn(c[f][0],u))return f;return-1}function Lb(c,u,f,y){return zr(c,function(T,C,M){u(y,T,f(T),M)}),y}function Pd(c,u){return c&&ar(u,$t(u),c)}function qb(c,u){return c&&ar(u,on(u),c)}function Sr(c,u,f){u=="__proto__"&&Ra?Ra(c,u,{configurable:!0,enumerable:!0,value:f,writable:!0}):c[u]=f}function zc(c,u){for(var f=-1,y=u.length,T=W(y),C=c==null;++f<y;)T[f]=C?t:xu(c,u[f]);return T}function pi(c,u,f){return c===c&&(f!==t&&(c=c<=f?c:f),u!==t&&(c=c>=u?c:u)),c}function Cn(c,u,f,y,T,C){var M,P=u&p,U=u&m,z=u&w;if(f&&(M=T?f(c,y,T,C):f(c)),M!==t)return M;if(!bt(c))return c;var K=Ie(c);if(K){if(M=CT(c),!P)return sn(c,M)}else{var ee=Vt(c),ue=ee==wt||ee==Bt;if(Zr(c))return tf(c,P);if(ee==Jt||ee==Z||ue&&!T){if(M=U||ue?{}:Tf(c),!P)return U?pT(c,qb(M,c)):fT(c,Pd(M,c))}else{if(!ht[ee])return T?c:{};M=vT(c,ee,P)}}C||(C=new Fn);var we=C.get(c);if(we)return we;C.set(c,M),Kf(c)?c.forEach(function(ve){M.add(Cn(ve,u,f,ve,c,C))}):Gf(c)&&c.forEach(function(ve,je){M.set(je,Cn(ve,u,f,je,c,C))});var Ce=z?U?mu:pu:U?on:$t,Ue=K?t:Ce(c);return Sn(Ue||c,function(ve,je){Ue&&(je=ve,ve=c[je]),xs(M,je,Cn(ve,u,f,je,c,C))}),M}function Bb(c){var u=$t(c);return function(f){return Od(f,c,u)}}function Od(c,u,f){var y=f.length;if(c==null)return!y;for(c=ct(c);y--;){var T=f[y],C=u[T],M=c[T];if(M===t&&!(T in c)||!C(M))return!1}return!0}function Dd(c,u,f){if(typeof c!="function")throw new An(a);return Ls(function(){c.apply(t,f)},u)}function Ms(c,u,f,y){var T=-1,C=ya,M=!0,P=c.length,U=[],z=u.length;if(!P)return U;f&&(u=yt(u,pn(f))),y?(C=$c,M=!1):u.length>=r&&(C=As,M=!1,u=new fi(u));e:for(;++T<P;){var K=c[T],ee=f==null?K:f(K);if(K=y||K!==0?K:0,M&&ee===ee){for(var ue=z;ue--;)if(u[ue]===ee)continue e;U.push(K)}else C(u,ee,y)||U.push(K)}return U}var zr=of(sr),Id=of(Jc,!0);function Ub(c,u){var f=!0;return zr(c,function(y,T,C){return f=!!u(y,T,C),f}),f}function Ia(c,u,f){for(var y=-1,T=c.length;++y<T;){var C=c[y],M=u(C);if(M!=null&&(P===t?M===M&&!yn(M):f(M,P)))var P=M,U=C}return U}function Fb(c,u,f,y){var T=c.length;for(f=qe(f),f<0&&(f=-f>T?0:T+f),y=y===t||y>T?T:qe(y),y<0&&(y+=T),y=f>y?0:Xf(y);f<y;)c[f++]=u;return c}function $d(c,u){var f=[];return zr(c,function(y,T,C){u(y,T,C)&&f.push(y)}),f}function kt(c,u,f,y,T){var C=-1,M=c.length;for(f||(f=_T),T||(T=[]);++C<M;){var P=c[C];u>0&&f(P)?u>1?kt(P,u-1,f,y,T):Hr(T,P):y||(T[T.length]=P)}return T}var Kc=cf(),Ld=cf(!0);function sr(c,u){return c&&Kc(c,u,$t)}function Jc(c,u){return c&&Ld(c,u,$t)}function $a(c,u){return Vr(u,function(f){return vr(c[f])})}function mi(c,u){u=Jr(u,c);for(var f=0,y=u.length;c!=null&&f<y;)c=c[or(u[f++])];return f&&f==y?c:t}function qd(c,u,f){var y=u(c);return Ie(c)?y:Hr(y,f(c))}function Xt(c){return c==null?c===t?Nc:Wr:hi&&hi in ct(c)?ST(c):$T(c)}function Xc(c,u){return c>u}function kb(c,u){return c!=null&&st.call(c,u)}function jb(c,u){return c!=null&&u in ct(c)}function Wb(c,u,f){return c>=Qt(u,f)&&c<Ot(u,f)}function Zc(c,u,f){for(var y=f?$c:ya,T=c[0].length,C=c.length,M=C,P=W(C),U=1/0,z=[];M--;){var K=c[M];M&&u&&(K=yt(K,pn(u))),U=Qt(K.length,U),P[M]=!f&&(u||T>=120&&K.length>=120)?new fi(M&&K):t}K=c[0];var ee=-1,ue=P[0];e:for(;++ee<T&&z.length<U;){var we=K[ee],Ce=u?u(we):we;if(we=f||we!==0?we:0,!(ue?As(ue,Ce):y(z,Ce,f))){for(M=C;--M;){var Ue=P[M];if(!(Ue?As(Ue,Ce):y(c[M],Ce,f)))continue e}ue&&ue.push(Ce),z.push(we)}}return z}function Qb(c,u,f,y){return sr(c,function(T,C,M){u(y,f(T),C,M)}),y}function Ps(c,u,f){u=Jr(u,c),c=Cf(c,u);var y=c==null?c:c[or(Rn(u))];return y==null?t:fn(y,c,f)}function Bd(c){return St(c)&&Xt(c)==Z}function Vb(c){return St(c)&&Xt(c)==A}function Hb(c){return St(c)&&Xt(c)==xe}function Os(c,u,f,y,T){return c===u?!0:c==null||u==null||!St(c)&&!St(u)?c!==c&&u!==u:Yb(c,u,f,y,Os,T)}function Yb(c,u,f,y,T,C){var M=Ie(c),P=Ie(u),U=M?Ee:Vt(c),z=P?Ee:Vt(u);U=U==Z?Jt:U,z=z==Z?Jt:z;var K=U==Jt,ee=z==Jt,ue=U==z;if(ue&&Zr(c)){if(!Zr(u))return!1;M=!0,K=!1}if(ue&&!K)return C||(C=new Fn),M||Vi(c)?Ef(c,u,f,y,T,C):bT(c,u,U,f,y,T,C);if(!(f&b)){var we=K&&st.call(c,"__wrapped__"),Ce=ee&&st.call(u,"__wrapped__");if(we||Ce){var Ue=we?c.value():c,ve=Ce?u.value():u;return C||(C=new Fn),T(Ue,ve,f,y,C)}}return ue?(C||(C=new Fn),TT(c,u,f,y,T,C)):!1}function Gb(c){return St(c)&&Vt(c)==Tt}function eu(c,u,f,y){var T=f.length,C=T,M=!y;if(c==null)return!C;for(c=ct(c);T--;){var P=f[T];if(M&&P[2]?P[1]!==c[P[0]]:!(P[0]in c))return!1}for(;++T<C;){P=f[T];var U=P[0],z=c[U],K=P[1];if(M&&P[2]){if(z===t&&!(U in c))return!1}else{var ee=new Fn;if(y)var ue=y(z,K,U,c,u,ee);if(!(ue===t?Os(K,z,b|S,y,ee):ue))return!1}}return!0}function Ud(c){if(!bt(c)||MT(c))return!1;var u=vr(c)?Gw:BE;return u.test(gi(c))}function zb(c){return St(c)&&Xt(c)==ir}function Kb(c){return St(c)&&Vt(c)==Ut}function Jb(c){return St(c)&&Xa(c.length)&&!!dt[Xt(c)]}function Fd(c){return typeof c=="function"?c:c==null?cn:typeof c=="object"?Ie(c)?Wd(c[0],c[1]):jd(c):up(c)}function tu(c){if(!$s(c))return eb(c);var u=[];for(var f in ct(c))st.call(c,f)&&f!="constructor"&&u.push(f);return u}function Xb(c){if(!bt(c))return IT(c);var u=$s(c),f=[];for(var y in c)y=="constructor"&&(u||!st.call(c,y))||f.push(y);return f}function nu(c,u){return c<u}function kd(c,u){var f=-1,y=an(c)?W(c.length):[];return zr(c,function(T,C,M){y[++f]=u(T,C,M)}),y}function jd(c){var u=gu(c);return u.length==1&&u[0][2]?Af(u[0][0],u[0][1]):function(f){return f===c||eu(f,c,u)}}function Wd(c,u){return wu(c)&&Sf(u)?Af(or(c),u):function(f){var y=xu(f,c);return y===t&&y===u?Mu(f,c):Os(u,y,b|S)}}function La(c,u,f,y,T){c!==u&&Kc(u,function(C,M){if(T||(T=new Fn),bt(C))Zb(c,u,M,f,La,y,T);else{var P=y?y(Tu(c,M),C,M+"",c,u,T):t;P===t&&(P=C),Gc(c,M,P)}},on)}function Zb(c,u,f,y,T,C,M){var P=Tu(c,f),U=Tu(u,f),z=M.get(U);if(z){Gc(c,f,z);return}var K=C?C(P,U,f+"",c,u,M):t,ee=K===t;if(ee){var ue=Ie(U),we=!ue&&Zr(U),Ce=!ue&&!we&&Vi(U);K=U,ue||we||Ce?Ie(P)?K=P:vt(P)?K=sn(P):we?(ee=!1,K=tf(U,!0)):Ce?(ee=!1,K=nf(U,!0)):K=[]:qs(U)||Ei(U)?(K=P,Ei(P)?K=Zf(P):(!bt(P)||vr(P))&&(K=Tf(U))):ee=!1}ee&&(M.set(U,K),T(K,U,y,C,M),M.delete(U)),Gc(c,f,K)}function Qd(c,u){var f=c.length;if(f)return u+=u<0?f:0,Cr(u,f)?c[u]:t}function Vd(c,u,f){u.length?u=yt(u,function(C){return Ie(C)?function(M){return mi(M,C.length===1?C[0]:C)}:C}):u=[cn];var y=-1;u=yt(u,pn(Ne()));var T=kd(c,function(C,M,P){var U=yt(u,function(z){return z(C)});return{criteria:U,index:++y,value:C}});return vw(T,function(C,M){return dT(C,M,f)})}function eT(c,u){return Hd(c,u,function(f,y){return Mu(c,y)})}function Hd(c,u,f){for(var y=-1,T=u.length,C={};++y<T;){var M=u[y],P=mi(c,M);f(P,M)&&Ds(C,Jr(M,c),P)}return C}function tT(c){return function(u){return mi(u,c)}}function ru(c,u,f,y){var T=y?Cw:Ii,C=-1,M=u.length,P=c;for(c===u&&(u=sn(u)),f&&(P=yt(c,pn(f)));++C<M;)for(var U=0,z=u[C],K=f?f(z):z;(U=T(P,K,U,y))>-1;)P!==c&&va.call(P,U,1),va.call(c,U,1);return c}function Yd(c,u){for(var f=c?u.length:0,y=f-1;f--;){var T=u[f];if(f==y||T!==C){var C=T;Cr(T)?va.call(c,T,1):ou(c,T)}}return c}function iu(c,u){return c+xa(Rd()*(u-c+1))}function nT(c,u,f,y){for(var T=-1,C=Ot(_a((u-c)/(f||1)),0),M=W(C);C--;)M[y?C:++T]=c,c+=f;return M}function su(c,u){var f="";if(!c||u<1||u>ye)return f;do u%2&&(f+=c),u=xa(u/2),u&&(c+=c);while(u);return f}function Fe(c,u){return Su(Nf(c,u,cn),c+"")}function rT(c){return Md(Hi(c))}function iT(c,u){var f=Hi(c);return Ha(f,pi(u,0,f.length))}function Ds(c,u,f,y){if(!bt(c))return c;u=Jr(u,c);for(var T=-1,C=u.length,M=C-1,P=c;P!=null&&++T<C;){var U=or(u[T]),z=f;if(U==="__proto__"||U==="constructor"||U==="prototype")return c;if(T!=M){var K=P[U];z=y?y(K,U,P):t,z===t&&(z=bt(K)?K:Cr(u[T+1])?[]:{})}xs(P,U,z),P=P[U]}return c}var Gd=Ma?function(c,u){return Ma.set(c,u),c}:cn,sT=Ra?function(c,u){return Ra(c,"toString",{configurable:!0,enumerable:!1,value:Ou(u),writable:!0})}:cn;function aT(c){return Ha(Hi(c))}function vn(c,u,f){var y=-1,T=c.length;u<0&&(u=-u>T?0:T+u),f=f>T?T:f,f<0&&(f+=T),T=u>f?0:f-u>>>0,u>>>=0;for(var C=W(T);++y<T;)C[y]=c[y+u];return C}function oT(c,u){var f;return zr(c,function(y,T,C){return f=u(y,T,C),!f}),!!f}function qa(c,u,f){var y=0,T=c==null?y:c.length;if(typeof u=="number"&&u===u&&T<=F){for(;y<T;){var C=y+T>>>1,M=c[C];M!==null&&!yn(M)&&(f?M<=u:M<u)?y=C+1:T=C}return T}return au(c,u,cn,f)}function au(c,u,f,y){var T=0,C=c==null?0:c.length;if(C===0)return 0;u=f(u);for(var M=u!==u,P=u===null,U=yn(u),z=u===t;T<C;){var K=xa((T+C)/2),ee=f(c[K]),ue=ee!==t,we=ee===null,Ce=ee===ee,Ue=yn(ee);if(M)var ve=y||Ce;else z?ve=Ce&&(y||ue):P?ve=Ce&&ue&&(y||!we):U?ve=Ce&&ue&&!we&&(y||!Ue):we||Ue?ve=!1:ve=y?ee<=u:ee<u;ve?T=K+1:C=K}return Qt(C,We)}function zd(c,u){for(var f=-1,y=c.length,T=0,C=[];++f<y;){var M=c[f],P=u?u(M):M;if(!f||!kn(P,U)){var U=P;C[T++]=M===0?0:M}}return C}function Kd(c){return typeof c=="number"?c:yn(c)?ze:+c}function mn(c){if(typeof c=="string")return c;if(Ie(c))return yt(c,mn)+"";if(yn(c))return _d?_d.call(c):"";var u=c+"";return u=="0"&&1/c==-oe?"-0":u}function Kr(c,u,f){var y=-1,T=ya,C=c.length,M=!0,P=[],U=P;if(f)M=!1,T=$c;else if(C>=r){var z=u?null:ET(c);if(z)return Ea(z);M=!1,T=As,U=new fi}else U=u?[]:P;e:for(;++y<C;){var K=c[y],ee=u?u(K):K;if(K=f||K!==0?K:0,M&&ee===ee){for(var ue=U.length;ue--;)if(U[ue]===ee)continue e;u&&U.push(ee),P.push(K)}else T(U,ee,f)||(U!==P&&U.push(ee),P.push(K))}return P}function ou(c,u){return u=Jr(u,c),c=Cf(c,u),c==null||delete c[or(Rn(u))]}function Jd(c,u,f,y){return Ds(c,u,f(mi(c,u)),y)}function Ba(c,u,f,y){for(var T=c.length,C=y?T:-1;(y?C--:++C<T)&&u(c[C],C,c););return f?vn(c,y?0:C,y?C+1:T):vn(c,y?C+1:0,y?T:C)}function Xd(c,u){var f=c;return f instanceof Qe&&(f=f.value()),Lc(u,function(y,T){return T.func.apply(T.thisArg,Hr([y],T.args))},f)}function cu(c,u,f){var y=c.length;if(y<2)return y?Kr(c[0]):[];for(var T=-1,C=W(y);++T<y;)for(var M=c[T],P=-1;++P<y;)P!=T&&(C[T]=Ms(C[T]||M,c[P],u,f));return Kr(kt(C,1),u,f)}function Zd(c,u,f){for(var y=-1,T=c.length,C=u.length,M={};++y<T;){var P=y<C?u[y]:t;f(M,c[y],P)}return M}function uu(c){return vt(c)?c:[]}function lu(c){return typeof c=="function"?c:cn}function Jr(c,u){return Ie(c)?c:wu(c,u)?[c]:xf(rt(c))}var cT=Fe;function Xr(c,u,f){var y=c.length;return f=f===t?y:f,!u&&f>=y?c:vn(c,u,f)}var ef=zw||function(c){return Ft.clearTimeout(c)};function tf(c,u){if(u)return c.slice();var f=c.length,y=Sd?Sd(f):new c.constructor(f);return c.copy(y),y}function hu(c){var u=new c.constructor(c.byteLength);return new Na(u).set(new Na(c)),u}function uT(c,u){var f=u?hu(c.buffer):c.buffer;return new c.constructor(f,c.byteOffset,c.byteLength)}function lT(c){var u=new c.constructor(c.source,Bh.exec(c));return u.lastIndex=c.lastIndex,u}function hT(c){return _s?ct(_s.call(c)):{}}function nf(c,u){var f=u?hu(c.buffer):c.buffer;return new c.constructor(f,c.byteOffset,c.length)}function rf(c,u){if(c!==u){var f=c!==t,y=c===null,T=c===c,C=yn(c),M=u!==t,P=u===null,U=u===u,z=yn(u);if(!P&&!z&&!C&&c>u||C&&M&&U&&!P&&!z||y&&M&&U||!f&&U||!T)return 1;if(!y&&!C&&!z&&c<u||z&&f&&T&&!y&&!C||P&&f&&T||!M&&T||!U)return-1}return 0}function dT(c,u,f){for(var y=-1,T=c.criteria,C=u.criteria,M=T.length,P=f.length;++y<M;){var U=rf(T[y],C[y]);if(U){if(y>=P)return U;var z=f[y];return U*(z=="desc"?-1:1)}}return c.index-u.index}function sf(c,u,f,y){for(var T=-1,C=c.length,M=f.length,P=-1,U=u.length,z=Ot(C-M,0),K=W(U+z),ee=!y;++P<U;)K[P]=u[P];for(;++T<M;)(ee||T<C)&&(K[f[T]]=c[T]);for(;z--;)K[P++]=c[T++];return K}function af(c,u,f,y){for(var T=-1,C=c.length,M=-1,P=f.length,U=-1,z=u.length,K=Ot(C-P,0),ee=W(K+z),ue=!y;++T<K;)ee[T]=c[T];for(var we=T;++U<z;)ee[we+U]=u[U];for(;++M<P;)(ue||T<C)&&(ee[we+f[M]]=c[T++]);return ee}function sn(c,u){var f=-1,y=c.length;for(u||(u=W(y));++f<y;)u[f]=c[f];return u}function ar(c,u,f,y){var T=!f;f||(f={});for(var C=-1,M=u.length;++C<M;){var P=u[C],U=y?y(f[P],c[P],P,f,c):t;U===t&&(U=c[P]),T?Sr(f,P,U):xs(f,P,U)}return f}function fT(c,u){return ar(c,Eu(c),u)}function pT(c,u){return ar(c,wf(c),u)}function Ua(c,u){return function(f,y){var T=Ie(f)?ww:Lb,C=u?u():{};return T(f,c,Ne(y,2),C)}}function ji(c){return Fe(function(u,f){var y=-1,T=f.length,C=T>1?f[T-1]:t,M=T>2?f[2]:t;for(C=c.length>3&&typeof C=="function"?(T--,C):t,M&&Zt(f[0],f[1],M)&&(C=T<3?t:C,T=1),u=ct(u);++y<T;){var P=f[y];P&&c(u,P,y,C)}return u})}function of(c,u){return function(f,y){if(f==null)return f;if(!an(f))return c(f,y);for(var T=f.length,C=u?T:-1,M=ct(f);(u?C--:++C<T)&&y(M[C],C,M)!==!1;);return f}}function cf(c){return function(u,f,y){for(var T=-1,C=ct(u),M=y(u),P=M.length;P--;){var U=M[c?P:++T];if(f(C[U],U,C)===!1)break}return u}}function mT(c,u,f){var y=u&R,T=Is(c);function C(){var M=this&&this!==Ft&&this instanceof C?T:c;return M.apply(y?f:this,arguments)}return C}function uf(c){return function(u){u=rt(u);var f=$i(u)?Un(u):t,y=f?f[0]:u.charAt(0),T=f?Xr(f,1).join(""):u.slice(1);return y[c]()+T}}function Wi(c){return function(u){return Lc(op(ap(u).replace(sw,"")),c,"")}}function Is(c){return function(){var u=arguments;switch(u.length){case 0:return new c;case 1:return new c(u[0]);case 2:return new c(u[0],u[1]);case 3:return new c(u[0],u[1],u[2]);case 4:return new c(u[0],u[1],u[2],u[3]);case 5:return new c(u[0],u[1],u[2],u[3],u[4]);case 6:return new c(u[0],u[1],u[2],u[3],u[4],u[5]);case 7:return new c(u[0],u[1],u[2],u[3],u[4],u[5],u[6])}var f=ki(c.prototype),y=c.apply(f,u);return bt(y)?y:f}}function yT(c,u,f){var y=Is(c);function T(){for(var C=arguments.length,M=W(C),P=C,U=Qi(T);P--;)M[P]=arguments[P];var z=C<3&&M[0]!==U&&M[C-1]!==U?[]:Yr(M,U);if(C-=z.length,C<f)return pf(c,u,Fa,T.placeholder,t,M,z,t,t,f-C);var K=this&&this!==Ft&&this instanceof T?y:c;return fn(K,this,M)}return T}function lf(c){return function(u,f,y){var T=ct(u);if(!an(u)){var C=Ne(f,3);u=$t(u),f=function(P){return C(T[P],P,T)}}var M=c(u,f,y);return M>-1?T[C?u[M]:M]:t}}function hf(c){return Nr(function(u){var f=u.length,y=f,T=Nn.prototype.thru;for(c&&u.reverse();y--;){var C=u[y];if(typeof C!="function")throw new An(a);if(T&&!M&&Qa(C)=="wrapper")var M=new Nn([],!0)}for(y=M?y:f;++y<f;){C=u[y];var P=Qa(C),U=P=="wrapper"?yu(C):t;U&&bu(U[0])&&U[1]==(pe|O|ne|me)&&!U[4].length&&U[9]==1?M=M[Qa(U[0])].apply(M,U[3]):M=C.length==1&&bu(C)?M[P]():M.thru(C)}return function(){var z=arguments,K=z[0];if(M&&z.length==1&&Ie(K))return M.plant(K).value();for(var ee=0,ue=f?u[ee].apply(this,z):K;++ee<f;)ue=u[ee].call(this,ue);return ue}})}function Fa(c,u,f,y,T,C,M,P,U,z){var K=u&pe,ee=u&R,ue=u&$,we=u&(O|J),Ce=u&V,Ue=ue?t:Is(c);function ve(){for(var je=arguments.length,He=W(je),gn=je;gn--;)He[gn]=arguments[gn];if(we)var en=Qi(ve),En=_w(He,en);if(y&&(He=sf(He,y,T,we)),C&&(He=af(He,C,M,we)),je-=En,we&&je<z){var Rt=Yr(He,en);return pf(c,u,Fa,ve.placeholder,f,He,Rt,P,U,z-je)}var jn=ee?f:this,_r=ue?jn[c]:c;return je=He.length,P?He=LT(He,P):Ce&&je>1&&He.reverse(),K&&U<je&&(He.length=U),this&&this!==Ft&&this instanceof ve&&(_r=Ue||Is(_r)),_r.apply(jn,He)}return ve}function df(c,u){return function(f,y){return Qb(f,c,u(y),{})}}function ka(c,u){return function(f,y){var T;if(f===t&&y===t)return u;if(f!==t&&(T=f),y!==t){if(T===t)return y;typeof f=="string"||typeof y=="string"?(f=mn(f),y=mn(y)):(f=Kd(f),y=Kd(y)),T=c(f,y)}return T}}function du(c){return Nr(function(u){return u=yt(u,pn(Ne())),Fe(function(f){var y=this;return c(u,function(T){return fn(T,y,f)})})})}function ja(c,u){u=u===t?" ":mn(u);var f=u.length;if(f<2)return f?su(u,c):u;var y=su(u,_a(c/Li(u)));return $i(u)?Xr(Un(y),0,c).join(""):y.slice(0,c)}function gT(c,u,f,y){var T=u&R,C=Is(c);function M(){for(var P=-1,U=arguments.length,z=-1,K=y.length,ee=W(K+U),ue=this&&this!==Ft&&this instanceof M?C:c;++z<K;)ee[z]=y[z];for(;U--;)ee[z++]=arguments[++P];return fn(ue,T?f:this,ee)}return M}function ff(c){return function(u,f,y){return y&&typeof y!="number"&&Zt(u,f,y)&&(f=y=t),u=Rr(u),f===t?(f=u,u=0):f=Rr(f),y=y===t?u<f?1:-1:Rr(y),nT(u,f,y,c)}}function Wa(c){return function(u,f){return typeof u=="string"&&typeof f=="string"||(u=_n(u),f=_n(f)),c(u,f)}}function pf(c,u,f,y,T,C,M,P,U,z){var K=u&O,ee=K?M:t,ue=K?t:M,we=K?C:t,Ce=K?t:C;u|=K?ne:ge,u&=~(K?ge:ne),u&q||(u&=-4);var Ue=[c,u,T,we,ee,Ce,ue,P,U,z],ve=f.apply(t,Ue);return bu(c)&&vf(ve,Ue),ve.placeholder=y,Rf(ve,c,u)}function fu(c){var u=Pt[c];return function(f,y){if(f=_n(f),y=y==null?0:Qt(qe(y),292),y&&vd(f)){var T=(rt(f)+"e").split("e"),C=u(T[0]+"e"+(+T[1]+y));return T=(rt(C)+"e").split("e"),+(T[0]+"e"+(+T[1]-y))}return u(f)}}var ET=Ui&&1/Ea(new Ui([,-0]))[1]==oe?function(c){return new Ui(c)}:$u;function mf(c){return function(u){var f=Vt(u);return f==Tt?Wc(u):f==Ut?$w(u):Rw(u,c(u))}}function Ar(c,u,f,y,T,C,M,P){var U=u&$;if(!U&&typeof c!="function")throw new An(a);var z=y?y.length:0;if(z||(u&=-97,y=T=t),M=M===t?M:Ot(qe(M),0),P=P===t?P:qe(P),z-=T?T.length:0,u&ge){var K=y,ee=T;y=T=t}var ue=U?t:yu(c),we=[c,u,f,y,T,K,ee,C,M,P];if(ue&&DT(we,ue),c=we[0],u=we[1],f=we[2],y=we[3],T=we[4],P=we[9]=we[9]===t?U?0:c.length:Ot(we[9]-z,0),!P&&u&(O|J)&&(u&=-25),!u||u==R)var Ce=mT(c,u,f);else u==O||u==J?Ce=yT(c,u,P):(u==ne||u==(R|ne))&&!T.length?Ce=gT(c,u,f,y):Ce=Fa.apply(t,we);var Ue=ue?Gd:vf;return Rf(Ue(Ce,we),c,u)}function yf(c,u,f,y){return c===t||kn(c,Bi[f])&&!st.call(y,f)?u:c}function gf(c,u,f,y,T,C){return bt(c)&&bt(u)&&(C.set(u,c),La(c,u,t,gf,C),C.delete(u)),c}function wT(c){return qs(c)?t:c}function Ef(c,u,f,y,T,C){var M=f&b,P=c.length,U=u.length;if(P!=U&&!(M&&U>P))return!1;var z=C.get(c),K=C.get(u);if(z&&K)return z==u&&K==c;var ee=-1,ue=!0,we=f&S?new fi:t;for(C.set(c,u),C.set(u,c);++ee<P;){var Ce=c[ee],Ue=u[ee];if(y)var ve=M?y(Ue,Ce,ee,u,c,C):y(Ce,Ue,ee,c,u,C);if(ve!==t){if(ve)continue;ue=!1;break}if(we){if(!qc(u,function(je,He){if(!As(we,He)&&(Ce===je||T(Ce,je,f,y,C)))return we.push(He)})){ue=!1;break}}else if(!(Ce===Ue||T(Ce,Ue,f,y,C))){ue=!1;break}}return C.delete(c),C.delete(u),ue}function bT(c,u,f,y,T,C,M){switch(f){case g:if(c.byteLength!=u.byteLength||c.byteOffset!=u.byteOffset)return!1;c=c.buffer,u=u.buffer;case A:return!(c.byteLength!=u.byteLength||!C(new Na(c),new Na(u)));case Me:case xe:case nn:return kn(+c,+u);case Ke:return c.name==u.name&&c.message==u.message;case ir:case Wt:return c==u+"";case Tt:var P=Wc;case Ut:var U=y&b;if(P||(P=Ea),c.size!=u.size&&!U)return!1;var z=M.get(c);if(z)return z==u;y|=S,M.set(c,u);var K=Ef(P(c),P(u),y,T,C,M);return M.delete(c),K;case Qr:if(_s)return _s.call(c)==_s.call(u)}return!1}function TT(c,u,f,y,T,C){var M=f&b,P=pu(c),U=P.length,z=pu(u),K=z.length;if(U!=K&&!M)return!1;for(var ee=U;ee--;){var ue=P[ee];if(!(M?ue in u:st.call(u,ue)))return!1}var we=C.get(c),Ce=C.get(u);if(we&&Ce)return we==u&&Ce==c;var Ue=!0;C.set(c,u),C.set(u,c);for(var ve=M;++ee<U;){ue=P[ee];var je=c[ue],He=u[ue];if(y)var gn=M?y(He,je,ue,u,c,C):y(je,He,ue,c,u,C);if(!(gn===t?je===He||T(je,He,f,y,C):gn)){Ue=!1;break}ve||(ve=ue=="constructor")}if(Ue&&!ve){var en=c.constructor,En=u.constructor;en!=En&&"constructor"in c&&"constructor"in u&&!(typeof en=="function"&&en instanceof en&&typeof En=="function"&&En instanceof En)&&(Ue=!1)}return C.delete(c),C.delete(u),Ue}function Nr(c){return Su(Nf(c,t,Df),c+"")}function pu(c){return qd(c,$t,Eu)}function mu(c){return qd(c,on,wf)}var yu=Ma?function(c){return Ma.get(c)}:$u;function Qa(c){for(var u=c.name+"",f=Fi[u],y=st.call(Fi,u)?f.length:0;y--;){var T=f[y],C=T.func;if(C==null||C==c)return T.name}return u}function Qi(c){var u=st.call(N,"placeholder")?N:c;return u.placeholder}function Ne(){var c=N.iteratee||Du;return c=c===Du?Fd:c,arguments.length?c(arguments[0],arguments[1]):c}function Va(c,u){var f=c.__data__;return xT(u)?f[typeof u=="string"?"string":"hash"]:f.map}function gu(c){for(var u=$t(c),f=u.length;f--;){var y=u[f],T=c[y];u[f]=[y,T,Sf(T)]}return u}function yi(c,u){var f=Ow(c,u);return Ud(f)?f:t}function ST(c){var u=st.call(c,hi),f=c[hi];try{c[hi]=t;var y=!0}catch{}var T=Sa.call(c);return y&&(u?c[hi]=f:delete c[hi]),T}var Eu=Vc?function(c){return c==null?[]:(c=ct(c),Vr(Vc(c),function(u){return Nd.call(c,u)}))}:Lu,wf=Vc?function(c){for(var u=[];c;)Hr(u,Eu(c)),c=Ca(c);return u}:Lu,Vt=Xt;(Hc&&Vt(new Hc(new ArrayBuffer(1)))!=g||Cs&&Vt(new Cs)!=Tt||Yc&&Vt(Yc.resolve())!=Oi||Ui&&Vt(new Ui)!=Ut||vs&&Vt(new vs)!=rn)&&(Vt=function(c){var u=Xt(c),f=u==Jt?c.constructor:t,y=f?gi(f):"";if(y)switch(y){case ib:return g;case sb:return Tt;case ab:return Oi;case ob:return Ut;case cb:return rn}return u});function AT(c,u,f){for(var y=-1,T=f.length;++y<T;){var C=f[y],M=C.size;switch(C.type){case"drop":c+=M;break;case"dropRight":u-=M;break;case"take":u=Qt(u,c+M);break;case"takeRight":c=Ot(c,u-M);break}}return{start:c,end:u}}function NT(c){var u=c.match(ME);return u?u[1].split(PE):[]}function bf(c,u,f){u=Jr(u,c);for(var y=-1,T=u.length,C=!1;++y<T;){var M=or(u[y]);if(!(C=c!=null&&f(c,M)))break;c=c[M]}return C||++y!=T?C:(T=c==null?0:c.length,!!T&&Xa(T)&&Cr(M,T)&&(Ie(c)||Ei(c)))}function CT(c){var u=c.length,f=new c.constructor(u);return u&&typeof c[0]=="string"&&st.call(c,"index")&&(f.index=c.index,f.input=c.input),f}function Tf(c){return typeof c.constructor=="function"&&!$s(c)?ki(Ca(c)):{}}function vT(c,u,f){var y=c.constructor;switch(u){case A:return hu(c);case Me:case xe:return new y(+c);case g:return uT(c,f);case E:case v:case I:case k:case G:case Le:case ut:case at:case lt:return nf(c,f);case Tt:return new y;case nn:case Wt:return new y(c);case ir:return lT(c);case Ut:return new y;case Qr:return hT(c)}}function RT(c,u){var f=u.length;if(!f)return c;var y=f-1;return u[y]=(f>1?"& ":"")+u[y],u=u.join(f>2?", ":" "),c.replace(xE,`{
/* [wrapped with `+u+`] */
`)}function _T(c){return Ie(c)||Ei(c)||!!(Cd&&c&&c[Cd])}function Cr(c,u){var f=typeof c;return u=u??ye,!!u&&(f=="number"||f!="symbol"&&FE.test(c))&&c>-1&&c%1==0&&c<u}function Zt(c,u,f){if(!bt(f))return!1;var y=typeof u;return(y=="number"?an(f)&&Cr(u,f.length):y=="string"&&u in f)?kn(f[u],c):!1}function wu(c,u){if(Ie(c))return!1;var f=typeof c;return f=="number"||f=="symbol"||f=="boolean"||c==null||yn(c)?!0:CE.test(c)||!NE.test(c)||u!=null&&c in ct(u)}function xT(c){var u=typeof c;return u=="string"||u=="number"||u=="symbol"||u=="boolean"?c!=="__proto__":c===null}function bu(c){var u=Qa(c),f=N[u];if(typeof f!="function"||!(u in Qe.prototype))return!1;if(c===f)return!0;var y=yu(f);return!!y&&c===y[0]}function MT(c){return!!Td&&Td in c}var PT=ba?vr:qu;function $s(c){var u=c&&c.constructor,f=typeof u=="function"&&u.prototype||Bi;return c===f}function Sf(c){return c===c&&!bt(c)}function Af(c,u){return function(f){return f==null?!1:f[c]===u&&(u!==t||c in ct(f))}}function OT(c){var u=Ka(c,function(y){return f.size===h&&f.clear(),y}),f=u.cache;return u}function DT(c,u){var f=c[1],y=u[1],T=f|y,C=T<(R|$|pe),M=y==pe&&f==O||y==pe&&f==me&&c[7].length<=u[8]||y==(pe|me)&&u[7].length<=u[8]&&f==O;if(!(C||M))return c;y&R&&(c[2]=u[2],T|=f&R?0:q);var P=u[3];if(P){var U=c[3];c[3]=U?sf(U,P,u[4]):P,c[4]=U?Yr(c[3],d):u[4]}return P=u[5],P&&(U=c[5],c[5]=U?af(U,P,u[6]):P,c[6]=U?Yr(c[5],d):u[6]),P=u[7],P&&(c[7]=P),y&pe&&(c[8]=c[8]==null?u[8]:Qt(c[8],u[8])),c[9]==null&&(c[9]=u[9]),c[0]=u[0],c[1]=T,c}function IT(c){var u=[];if(c!=null)for(var f in ct(c))u.push(f);return u}function $T(c){return Sa.call(c)}function Nf(c,u,f){return u=Ot(u===t?c.length-1:u,0),function(){for(var y=arguments,T=-1,C=Ot(y.length-u,0),M=W(C);++T<C;)M[T]=y[u+T];T=-1;for(var P=W(u+1);++T<u;)P[T]=y[T];return P[u]=f(M),fn(c,this,P)}}function Cf(c,u){return u.length<2?c:mi(c,vn(u,0,-1))}function LT(c,u){for(var f=c.length,y=Qt(u.length,f),T=sn(c);y--;){var C=u[y];c[y]=Cr(C,f)?T[C]:t}return c}function Tu(c,u){if(!(u==="constructor"&&typeof c[u]=="function")&&u!="__proto__")return c[u]}var vf=_f(Gd),Ls=Jw||function(c,u){return Ft.setTimeout(c,u)},Su=_f(sT);function Rf(c,u,f){var y=u+"";return Su(c,RT(y,qT(NT(y),f)))}function _f(c){var u=0,f=0;return function(){var y=tb(),T=Q-(y-f);if(f=y,T>0){if(++u>=ae)return arguments[0]}else u=0;return c.apply(t,arguments)}}function Ha(c,u){var f=-1,y=c.length,T=y-1;for(u=u===t?y:u;++f<u;){var C=iu(f,T),M=c[C];c[C]=c[f],c[f]=M}return c.length=u,c}var xf=OT(function(c){var u=[];return c.charCodeAt(0)===46&&u.push(""),c.replace(vE,function(f,y,T,C){u.push(T?C.replace(IE,"$1"):y||f)}),u});function or(c){if(typeof c=="string"||yn(c))return c;var u=c+"";return u=="0"&&1/c==-oe?"-0":u}function gi(c){if(c!=null){try{return Ta.call(c)}catch{}try{return c+""}catch{}}return""}function qT(c,u){return Sn(Y,function(f){var y="_."+f[0];u&f[1]&&!ya(c,y)&&c.push(y)}),c.sort()}function Mf(c){if(c instanceof Qe)return c.clone();var u=new Nn(c.__wrapped__,c.__chain__);return u.__actions__=sn(c.__actions__),u.__index__=c.__index__,u.__values__=c.__values__,u}function BT(c,u,f){(f?Zt(c,u,f):u===t)?u=1:u=Ot(qe(u),0);var y=c==null?0:c.length;if(!y||u<1)return[];for(var T=0,C=0,M=W(_a(y/u));T<y;)M[C++]=vn(c,T,T+=u);return M}function UT(c){for(var u=-1,f=c==null?0:c.length,y=0,T=[];++u<f;){var C=c[u];C&&(T[y++]=C)}return T}function FT(){var c=arguments.length;if(!c)return[];for(var u=W(c-1),f=arguments[0],y=c;y--;)u[y-1]=arguments[y];return Hr(Ie(f)?sn(f):[f],kt(u,1))}var kT=Fe(function(c,u){return vt(c)?Ms(c,kt(u,1,vt,!0)):[]}),jT=Fe(function(c,u){var f=Rn(u);return vt(f)&&(f=t),vt(c)?Ms(c,kt(u,1,vt,!0),Ne(f,2)):[]}),WT=Fe(function(c,u){var f=Rn(u);return vt(f)&&(f=t),vt(c)?Ms(c,kt(u,1,vt,!0),t,f):[]});function QT(c,u,f){var y=c==null?0:c.length;return y?(u=f||u===t?1:qe(u),vn(c,u<0?0:u,y)):[]}function VT(c,u,f){var y=c==null?0:c.length;return y?(u=f||u===t?1:qe(u),u=y-u,vn(c,0,u<0?0:u)):[]}function HT(c,u){return c&&c.length?Ba(c,Ne(u,3),!0,!0):[]}function YT(c,u){return c&&c.length?Ba(c,Ne(u,3),!0):[]}function GT(c,u,f,y){var T=c==null?0:c.length;return T?(f&&typeof f!="number"&&Zt(c,u,f)&&(f=0,y=T),Fb(c,u,f,y)):[]}function Pf(c,u,f){var y=c==null?0:c.length;if(!y)return-1;var T=f==null?0:qe(f);return T<0&&(T=Ot(y+T,0)),ga(c,Ne(u,3),T)}function Of(c,u,f){var y=c==null?0:c.length;if(!y)return-1;var T=y-1;return f!==t&&(T=qe(f),T=f<0?Ot(y+T,0):Qt(T,y-1)),ga(c,Ne(u,3),T,!0)}function Df(c){var u=c==null?0:c.length;return u?kt(c,1):[]}function zT(c){var u=c==null?0:c.length;return u?kt(c,oe):[]}function KT(c,u){var f=c==null?0:c.length;return f?(u=u===t?1:qe(u),kt(c,u)):[]}function JT(c){for(var u=-1,f=c==null?0:c.length,y={};++u<f;){var T=c[u];y[T[0]]=T[1]}return y}function If(c){return c&&c.length?c[0]:t}function XT(c,u,f){var y=c==null?0:c.length;if(!y)return-1;var T=f==null?0:qe(f);return T<0&&(T=Ot(y+T,0)),Ii(c,u,T)}function ZT(c){var u=c==null?0:c.length;return u?vn(c,0,-1):[]}var eS=Fe(function(c){var u=yt(c,uu);return u.length&&u[0]===c[0]?Zc(u):[]}),tS=Fe(function(c){var u=Rn(c),f=yt(c,uu);return u===Rn(f)?u=t:f.pop(),f.length&&f[0]===c[0]?Zc(f,Ne(u,2)):[]}),nS=Fe(function(c){var u=Rn(c),f=yt(c,uu);return u=typeof u=="function"?u:t,u&&f.pop(),f.length&&f[0]===c[0]?Zc(f,t,u):[]});function rS(c,u){return c==null?"":Zw.call(c,u)}function Rn(c){var u=c==null?0:c.length;return u?c[u-1]:t}function iS(c,u,f){var y=c==null?0:c.length;if(!y)return-1;var T=y;return f!==t&&(T=qe(f),T=T<0?Ot(y+T,0):Qt(T,y-1)),u===u?qw(c,u,T):ga(c,fd,T,!0)}function sS(c,u){return c&&c.length?Qd(c,qe(u)):t}var aS=Fe($f);function $f(c,u){return c&&c.length&&u&&u.length?ru(c,u):c}function oS(c,u,f){return c&&c.length&&u&&u.length?ru(c,u,Ne(f,2)):c}function cS(c,u,f){return c&&c.length&&u&&u.length?ru(c,u,t,f):c}var uS=Nr(function(c,u){var f=c==null?0:c.length,y=zc(c,u);return Yd(c,yt(u,function(T){return Cr(T,f)?+T:T}).sort(rf)),y});function lS(c,u){var f=[];if(!(c&&c.length))return f;var y=-1,T=[],C=c.length;for(u=Ne(u,3);++y<C;){var M=c[y];u(M,y,c)&&(f.push(M),T.push(y))}return Yd(c,T),f}function Au(c){return c==null?c:rb.call(c)}function hS(c,u,f){var y=c==null?0:c.length;return y?(f&&typeof f!="number"&&Zt(c,u,f)?(u=0,f=y):(u=u==null?0:qe(u),f=f===t?y:qe(f)),vn(c,u,f)):[]}function dS(c,u){return qa(c,u)}function fS(c,u,f){return au(c,u,Ne(f,2))}function pS(c,u){var f=c==null?0:c.length;if(f){var y=qa(c,u);if(y<f&&kn(c[y],u))return y}return-1}function mS(c,u){return qa(c,u,!0)}function yS(c,u,f){return au(c,u,Ne(f,2),!0)}function gS(c,u){var f=c==null?0:c.length;if(f){var y=qa(c,u,!0)-1;if(kn(c[y],u))return y}return-1}function ES(c){return c&&c.length?zd(c):[]}function wS(c,u){return c&&c.length?zd(c,Ne(u,2)):[]}function bS(c){var u=c==null?0:c.length;return u?vn(c,1,u):[]}function TS(c,u,f){return c&&c.length?(u=f||u===t?1:qe(u),vn(c,0,u<0?0:u)):[]}function SS(c,u,f){var y=c==null?0:c.length;return y?(u=f||u===t?1:qe(u),u=y-u,vn(c,u<0?0:u,y)):[]}function AS(c,u){return c&&c.length?Ba(c,Ne(u,3),!1,!0):[]}function NS(c,u){return c&&c.length?Ba(c,Ne(u,3)):[]}var CS=Fe(function(c){return Kr(kt(c,1,vt,!0))}),vS=Fe(function(c){var u=Rn(c);return vt(u)&&(u=t),Kr(kt(c,1,vt,!0),Ne(u,2))}),RS=Fe(function(c){var u=Rn(c);return u=typeof u=="function"?u:t,Kr(kt(c,1,vt,!0),t,u)});function _S(c){return c&&c.length?Kr(c):[]}function xS(c,u){return c&&c.length?Kr(c,Ne(u,2)):[]}function MS(c,u){return u=typeof u=="function"?u:t,c&&c.length?Kr(c,t,u):[]}function Nu(c){if(!(c&&c.length))return[];var u=0;return c=Vr(c,function(f){if(vt(f))return u=Ot(f.length,u),!0}),kc(u,function(f){return yt(c,Bc(f))})}function Lf(c,u){if(!(c&&c.length))return[];var f=Nu(c);return u==null?f:yt(f,function(y){return fn(u,t,y)})}var PS=Fe(function(c,u){return vt(c)?Ms(c,u):[]}),OS=Fe(function(c){return cu(Vr(c,vt))}),DS=Fe(function(c){var u=Rn(c);return vt(u)&&(u=t),cu(Vr(c,vt),Ne(u,2))}),IS=Fe(function(c){var u=Rn(c);return u=typeof u=="function"?u:t,cu(Vr(c,vt),t,u)}),$S=Fe(Nu);function LS(c,u){return Zd(c||[],u||[],xs)}function qS(c,u){return Zd(c||[],u||[],Ds)}var BS=Fe(function(c){var u=c.length,f=u>1?c[u-1]:t;return f=typeof f=="function"?(c.pop(),f):t,Lf(c,f)});function qf(c){var u=N(c);return u.__chain__=!0,u}function US(c,u){return u(c),c}function Ya(c,u){return u(c)}var FS=Nr(function(c){var u=c.length,f=u?c[0]:0,y=this.__wrapped__,T=function(C){return zc(C,c)};return u>1||this.__actions__.length||!(y instanceof Qe)||!Cr(f)?this.thru(T):(y=y.slice(f,+f+(u?1:0)),y.__actions__.push({func:Ya,args:[T],thisArg:t}),new Nn(y,this.__chain__).thru(function(C){return u&&!C.length&&C.push(t),C}))});function kS(){return qf(this)}function jS(){return new Nn(this.value(),this.__chain__)}function WS(){this.__values__===t&&(this.__values__=Jf(this.value()));var c=this.__index__>=this.__values__.length,u=c?t:this.__values__[this.__index__++];return{done:c,value:u}}function QS(){return this}function VS(c){for(var u,f=this;f instanceof Oa;){var y=Mf(f);y.__index__=0,y.__values__=t,u?T.__wrapped__=y:u=y;var T=y;f=f.__wrapped__}return T.__wrapped__=c,u}function HS(){var c=this.__wrapped__;if(c instanceof Qe){var u=c;return this.__actions__.length&&(u=new Qe(this)),u=u.reverse(),u.__actions__.push({func:Ya,args:[Au],thisArg:t}),new Nn(u,this.__chain__)}return this.thru(Au)}function YS(){return Xd(this.__wrapped__,this.__actions__)}var GS=Ua(function(c,u,f){st.call(c,f)?++c[f]:Sr(c,f,1)});function zS(c,u,f){var y=Ie(c)?hd:Ub;return f&&Zt(c,u,f)&&(u=t),y(c,Ne(u,3))}function KS(c,u){var f=Ie(c)?Vr:$d;return f(c,Ne(u,3))}var JS=lf(Pf),XS=lf(Of);function ZS(c,u){return kt(Ga(c,u),1)}function eA(c,u){return kt(Ga(c,u),oe)}function tA(c,u,f){return f=f===t?1:qe(f),kt(Ga(c,u),f)}function Bf(c,u){var f=Ie(c)?Sn:zr;return f(c,Ne(u,3))}function Uf(c,u){var f=Ie(c)?bw:Id;return f(c,Ne(u,3))}var nA=Ua(function(c,u,f){st.call(c,f)?c[f].push(u):Sr(c,f,[u])});function rA(c,u,f,y){c=an(c)?c:Hi(c),f=f&&!y?qe(f):0;var T=c.length;return f<0&&(f=Ot(T+f,0)),Za(c)?f<=T&&c.indexOf(u,f)>-1:!!T&&Ii(c,u,f)>-1}var iA=Fe(function(c,u,f){var y=-1,T=typeof u=="function",C=an(c)?W(c.length):[];return zr(c,function(M){C[++y]=T?fn(u,M,f):Ps(M,u,f)}),C}),sA=Ua(function(c,u,f){Sr(c,f,u)});function Ga(c,u){var f=Ie(c)?yt:kd;return f(c,Ne(u,3))}function aA(c,u,f,y){return c==null?[]:(Ie(u)||(u=u==null?[]:[u]),f=y?t:f,Ie(f)||(f=f==null?[]:[f]),Vd(c,u,f))}var oA=Ua(function(c,u,f){c[f?0:1].push(u)},function(){return[[],[]]});function cA(c,u,f){var y=Ie(c)?Lc:md,T=arguments.length<3;return y(c,Ne(u,4),f,T,zr)}function uA(c,u,f){var y=Ie(c)?Tw:md,T=arguments.length<3;return y(c,Ne(u,4),f,T,Id)}function lA(c,u){var f=Ie(c)?Vr:$d;return f(c,Ja(Ne(u,3)))}function hA(c){var u=Ie(c)?Md:rT;return u(c)}function dA(c,u,f){(f?Zt(c,u,f):u===t)?u=1:u=qe(u);var y=Ie(c)?Ib:iT;return y(c,u)}function fA(c){var u=Ie(c)?$b:aT;return u(c)}function pA(c){if(c==null)return 0;if(an(c))return Za(c)?Li(c):c.length;var u=Vt(c);return u==Tt||u==Ut?c.size:tu(c).length}function mA(c,u,f){var y=Ie(c)?qc:oT;return f&&Zt(c,u,f)&&(u=t),y(c,Ne(u,3))}var yA=Fe(function(c,u){if(c==null)return[];var f=u.length;return f>1&&Zt(c,u[0],u[1])?u=[]:f>2&&Zt(u[0],u[1],u[2])&&(u=[u[0]]),Vd(c,kt(u,1),[])}),za=Kw||function(){return Ft.Date.now()};function gA(c,u){if(typeof u!="function")throw new An(a);return c=qe(c),function(){if(--c<1)return u.apply(this,arguments)}}function Ff(c,u,f){return u=f?t:u,u=c&&u==null?c.length:u,Ar(c,pe,t,t,t,t,u)}function kf(c,u){var f;if(typeof u!="function")throw new An(a);return c=qe(c),function(){return--c>0&&(f=u.apply(this,arguments)),c<=1&&(u=t),f}}var Cu=Fe(function(c,u,f){var y=R;if(f.length){var T=Yr(f,Qi(Cu));y|=ne}return Ar(c,y,u,f,T)}),jf=Fe(function(c,u,f){var y=R|$;if(f.length){var T=Yr(f,Qi(jf));y|=ne}return Ar(u,y,c,f,T)});function Wf(c,u,f){u=f?t:u;var y=Ar(c,O,t,t,t,t,t,u);return y.placeholder=Wf.placeholder,y}function Qf(c,u,f){u=f?t:u;var y=Ar(c,J,t,t,t,t,t,u);return y.placeholder=Qf.placeholder,y}function Vf(c,u,f){var y,T,C,M,P,U,z=0,K=!1,ee=!1,ue=!0;if(typeof c!="function")throw new An(a);u=_n(u)||0,bt(f)&&(K=!!f.leading,ee="maxWait"in f,C=ee?Ot(_n(f.maxWait)||0,u):C,ue="trailing"in f?!!f.trailing:ue);function we(Rt){var jn=y,_r=T;return y=T=t,z=Rt,M=c.apply(_r,jn),M}function Ce(Rt){return z=Rt,P=Ls(je,u),K?we(Rt):M}function Ue(Rt){var jn=Rt-U,_r=Rt-z,lp=u-jn;return ee?Qt(lp,C-_r):lp}function ve(Rt){var jn=Rt-U,_r=Rt-z;return U===t||jn>=u||jn<0||ee&&_r>=C}function je(){var Rt=za();if(ve(Rt))return He(Rt);P=Ls(je,Ue(Rt))}function He(Rt){return P=t,ue&&y?we(Rt):(y=T=t,M)}function gn(){P!==t&&ef(P),z=0,y=U=T=P=t}function en(){return P===t?M:He(za())}function En(){var Rt=za(),jn=ve(Rt);if(y=arguments,T=this,U=Rt,jn){if(P===t)return Ce(U);if(ee)return ef(P),P=Ls(je,u),we(U)}return P===t&&(P=Ls(je,u)),M}return En.cancel=gn,En.flush=en,En}var EA=Fe(function(c,u){return Dd(c,1,u)}),wA=Fe(function(c,u,f){return Dd(c,_n(u)||0,f)});function bA(c){return Ar(c,V)}function Ka(c,u){if(typeof c!="function"||u!=null&&typeof u!="function")throw new An(a);var f=function(){var y=arguments,T=u?u.apply(this,y):y[0],C=f.cache;if(C.has(T))return C.get(T);var M=c.apply(this,y);return f.cache=C.set(T,M)||C,M};return f.cache=new(Ka.Cache||Tr),f}Ka.Cache=Tr;function Ja(c){if(typeof c!="function")throw new An(a);return function(){var u=arguments;switch(u.length){case 0:return!c.call(this);case 1:return!c.call(this,u[0]);case 2:return!c.call(this,u[0],u[1]);case 3:return!c.call(this,u[0],u[1],u[2])}return!c.apply(this,u)}}function TA(c){return kf(2,c)}var SA=cT(function(c,u){u=u.length==1&&Ie(u[0])?yt(u[0],pn(Ne())):yt(kt(u,1),pn(Ne()));var f=u.length;return Fe(function(y){for(var T=-1,C=Qt(y.length,f);++T<C;)y[T]=u[T].call(this,y[T]);return fn(c,this,y)})}),vu=Fe(function(c,u){var f=Yr(u,Qi(vu));return Ar(c,ne,t,u,f)}),Hf=Fe(function(c,u){var f=Yr(u,Qi(Hf));return Ar(c,ge,t,u,f)}),AA=Nr(function(c,u){return Ar(c,me,t,t,t,u)});function NA(c,u){if(typeof c!="function")throw new An(a);return u=u===t?u:qe(u),Fe(c,u)}function CA(c,u){if(typeof c!="function")throw new An(a);return u=u==null?0:Ot(qe(u),0),Fe(function(f){var y=f[u],T=Xr(f,0,u);return y&&Hr(T,y),fn(c,this,T)})}function vA(c,u,f){var y=!0,T=!0;if(typeof c!="function")throw new An(a);return bt(f)&&(y="leading"in f?!!f.leading:y,T="trailing"in f?!!f.trailing:T),Vf(c,u,{leading:y,maxWait:u,trailing:T})}function RA(c){return Ff(c,1)}function _A(c,u){return vu(lu(u),c)}function xA(){if(!arguments.length)return[];var c=arguments[0];return Ie(c)?c:[c]}function MA(c){return Cn(c,w)}function PA(c,u){return u=typeof u=="function"?u:t,Cn(c,w,u)}function OA(c){return Cn(c,p|w)}function DA(c,u){return u=typeof u=="function"?u:t,Cn(c,p|w,u)}function IA(c,u){return u==null||Od(c,u,$t(u))}function kn(c,u){return c===u||c!==c&&u!==u}var $A=Wa(Xc),LA=Wa(function(c,u){return c>=u}),Ei=Bd(function(){return arguments}())?Bd:function(c){return St(c)&&st.call(c,"callee")&&!Nd.call(c,"callee")},Ie=W.isArray,qA=sd?pn(sd):Vb;function an(c){return c!=null&&Xa(c.length)&&!vr(c)}function vt(c){return St(c)&&an(c)}function BA(c){return c===!0||c===!1||St(c)&&Xt(c)==Me}var Zr=Xw||qu,UA=ad?pn(ad):Hb;function FA(c){return St(c)&&c.nodeType===1&&!qs(c)}function kA(c){if(c==null)return!0;if(an(c)&&(Ie(c)||typeof c=="string"||typeof c.splice=="function"||Zr(c)||Vi(c)||Ei(c)))return!c.length;var u=Vt(c);if(u==Tt||u==Ut)return!c.size;if($s(c))return!tu(c).length;for(var f in c)if(st.call(c,f))return!1;return!0}function jA(c,u){return Os(c,u)}function WA(c,u,f){f=typeof f=="function"?f:t;var y=f?f(c,u):t;return y===t?Os(c,u,t,f):!!y}function Ru(c){if(!St(c))return!1;var u=Xt(c);return u==Ke||u==ke||typeof c.message=="string"&&typeof c.name=="string"&&!qs(c)}function QA(c){return typeof c=="number"&&vd(c)}function vr(c){if(!bt(c))return!1;var u=Xt(c);return u==wt||u==Bt||u==Oe||u==X}function Yf(c){return typeof c=="number"&&c==qe(c)}function Xa(c){return typeof c=="number"&&c>-1&&c%1==0&&c<=ye}function bt(c){var u=typeof c;return c!=null&&(u=="object"||u=="function")}function St(c){return c!=null&&typeof c=="object"}var Gf=od?pn(od):Gb;function VA(c,u){return c===u||eu(c,u,gu(u))}function HA(c,u,f){return f=typeof f=="function"?f:t,eu(c,u,gu(u),f)}function YA(c){return zf(c)&&c!=+c}function GA(c){if(PT(c))throw new De(i);return Ud(c)}function zA(c){return c===null}function KA(c){return c==null}function zf(c){return typeof c=="number"||St(c)&&Xt(c)==nn}function qs(c){if(!St(c)||Xt(c)!=Jt)return!1;var u=Ca(c);if(u===null)return!0;var f=st.call(u,"constructor")&&u.constructor;return typeof f=="function"&&f instanceof f&&Ta.call(f)==Hw}var _u=cd?pn(cd):zb;function JA(c){return Yf(c)&&c>=-ye&&c<=ye}var Kf=ud?pn(ud):Kb;function Za(c){return typeof c=="string"||!Ie(c)&&St(c)&&Xt(c)==Wt}function yn(c){return typeof c=="symbol"||St(c)&&Xt(c)==Qr}var Vi=ld?pn(ld):Jb;function XA(c){return c===t}function ZA(c){return St(c)&&Vt(c)==rn}function eN(c){return St(c)&&Xt(c)==Cc}var tN=Wa(nu),nN=Wa(function(c,u){return c<=u});function Jf(c){if(!c)return[];if(an(c))return Za(c)?Un(c):sn(c);if(Ns&&c[Ns])return Iw(c[Ns]());var u=Vt(c),f=u==Tt?Wc:u==Ut?Ea:Hi;return f(c)}function Rr(c){if(!c)return c===0?c:0;if(c=_n(c),c===oe||c===-oe){var u=c<0?-1:1;return u*Ge}return c===c?c:0}function qe(c){var u=Rr(c),f=u%1;return u===u?f?u-f:u:0}function Xf(c){return c?pi(qe(c),0,_e):0}function _n(c){if(typeof c=="number")return c;if(yn(c))return ze;if(bt(c)){var u=typeof c.valueOf=="function"?c.valueOf():c;c=bt(u)?u+"":u}if(typeof c!="string")return c===0?c:+c;c=yd(c);var f=qE.test(c);return f||UE.test(c)?gw(c.slice(2),f?2:8):LE.test(c)?ze:+c}function Zf(c){return ar(c,on(c))}function rN(c){return c?pi(qe(c),-ye,ye):c===0?c:0}function rt(c){return c==null?"":mn(c)}var iN=ji(function(c,u){if($s(u)||an(u)){ar(u,$t(u),c);return}for(var f in u)st.call(u,f)&&xs(c,f,u[f])}),ep=ji(function(c,u){ar(u,on(u),c)}),eo=ji(function(c,u,f,y){ar(u,on(u),c,y)}),sN=ji(function(c,u,f,y){ar(u,$t(u),c,y)}),aN=Nr(zc);function oN(c,u){var f=ki(c);return u==null?f:Pd(f,u)}var cN=Fe(function(c,u){c=ct(c);var f=-1,y=u.length,T=y>2?u[2]:t;for(T&&Zt(u[0],u[1],T)&&(y=1);++f<y;)for(var C=u[f],M=on(C),P=-1,U=M.length;++P<U;){var z=M[P],K=c[z];(K===t||kn(K,Bi[z])&&!st.call(c,z))&&(c[z]=C[z])}return c}),uN=Fe(function(c){return c.push(t,gf),fn(tp,t,c)});function lN(c,u){return dd(c,Ne(u,3),sr)}function hN(c,u){return dd(c,Ne(u,3),Jc)}function dN(c,u){return c==null?c:Kc(c,Ne(u,3),on)}function fN(c,u){return c==null?c:Ld(c,Ne(u,3),on)}function pN(c,u){return c&&sr(c,Ne(u,3))}function mN(c,u){return c&&Jc(c,Ne(u,3))}function yN(c){return c==null?[]:$a(c,$t(c))}function gN(c){return c==null?[]:$a(c,on(c))}function xu(c,u,f){var y=c==null?t:mi(c,u);return y===t?f:y}function EN(c,u){return c!=null&&bf(c,u,kb)}function Mu(c,u){return c!=null&&bf(c,u,jb)}var wN=df(function(c,u,f){u!=null&&typeof u.toString!="function"&&(u=Sa.call(u)),c[u]=f},Ou(cn)),bN=df(function(c,u,f){u!=null&&typeof u.toString!="function"&&(u=Sa.call(u)),st.call(c,u)?c[u].push(f):c[u]=[f]},Ne),TN=Fe(Ps);function $t(c){return an(c)?xd(c):tu(c)}function on(c){return an(c)?xd(c,!0):Xb(c)}function SN(c,u){var f={};return u=Ne(u,3),sr(c,function(y,T,C){Sr(f,u(y,T,C),y)}),f}function AN(c,u){var f={};return u=Ne(u,3),sr(c,function(y,T,C){Sr(f,T,u(y,T,C))}),f}var NN=ji(function(c,u,f){La(c,u,f)}),tp=ji(function(c,u,f,y){La(c,u,f,y)}),CN=Nr(function(c,u){var f={};if(c==null)return f;var y=!1;u=yt(u,function(C){return C=Jr(C,c),y||(y=C.length>1),C}),ar(c,mu(c),f),y&&(f=Cn(f,p|m|w,wT));for(var T=u.length;T--;)ou(f,u[T]);return f});function vN(c,u){return np(c,Ja(Ne(u)))}var RN=Nr(function(c,u){return c==null?{}:eT(c,u)});function np(c,u){if(c==null)return{};var f=yt(mu(c),function(y){return[y]});return u=Ne(u),Hd(c,f,function(y,T){return u(y,T[0])})}function _N(c,u,f){u=Jr(u,c);var y=-1,T=u.length;for(T||(T=1,c=t);++y<T;){var C=c==null?t:c[or(u[y])];C===t&&(y=T,C=f),c=vr(C)?C.call(c):C}return c}function xN(c,u,f){return c==null?c:Ds(c,u,f)}function MN(c,u,f,y){return y=typeof y=="function"?y:t,c==null?c:Ds(c,u,f,y)}var rp=mf($t),ip=mf(on);function PN(c,u,f){var y=Ie(c),T=y||Zr(c)||Vi(c);if(u=Ne(u,4),f==null){var C=c&&c.constructor;T?f=y?new C:[]:bt(c)?f=vr(C)?ki(Ca(c)):{}:f={}}return(T?Sn:sr)(c,function(M,P,U){return u(f,M,P,U)}),f}function ON(c,u){return c==null?!0:ou(c,u)}function DN(c,u,f){return c==null?c:Jd(c,u,lu(f))}function IN(c,u,f,y){return y=typeof y=="function"?y:t,c==null?c:Jd(c,u,lu(f),y)}function Hi(c){return c==null?[]:jc(c,$t(c))}function $N(c){return c==null?[]:jc(c,on(c))}function LN(c,u,f){return f===t&&(f=u,u=t),f!==t&&(f=_n(f),f=f===f?f:0),u!==t&&(u=_n(u),u=u===u?u:0),pi(_n(c),u,f)}function qN(c,u,f){return u=Rr(u),f===t?(f=u,u=0):f=Rr(f),c=_n(c),Wb(c,u,f)}function BN(c,u,f){if(f&&typeof f!="boolean"&&Zt(c,u,f)&&(u=f=t),f===t&&(typeof u=="boolean"?(f=u,u=t):typeof c=="boolean"&&(f=c,c=t)),c===t&&u===t?(c=0,u=1):(c=Rr(c),u===t?(u=c,c=0):u=Rr(u)),c>u){var y=c;c=u,u=y}if(f||c%1||u%1){var T=Rd();return Qt(c+T*(u-c+yw("1e-"+((T+"").length-1))),u)}return iu(c,u)}var UN=Wi(function(c,u,f){return u=u.toLowerCase(),c+(f?sp(u):u)});function sp(c){return Pu(rt(c).toLowerCase())}function ap(c){return c=rt(c),c&&c.replace(kE,xw).replace(aw,"")}function FN(c,u,f){c=rt(c),u=mn(u);var y=c.length;f=f===t?y:pi(qe(f),0,y);var T=f;return f-=u.length,f>=0&&c.slice(f,T)==u}function kN(c){return c=rt(c),c&&TE.test(c)?c.replace(Lh,Mw):c}function jN(c){return c=rt(c),c&&RE.test(c)?c.replace(vc,"\\$&"):c}var WN=Wi(function(c,u,f){return c+(f?"-":"")+u.toLowerCase()}),QN=Wi(function(c,u,f){return c+(f?" ":"")+u.toLowerCase()}),VN=uf("toLowerCase");function HN(c,u,f){c=rt(c),u=qe(u);var y=u?Li(c):0;if(!u||y>=u)return c;var T=(u-y)/2;return ja(xa(T),f)+c+ja(_a(T),f)}function YN(c,u,f){c=rt(c),u=qe(u);var y=u?Li(c):0;return u&&y<u?c+ja(u-y,f):c}function GN(c,u,f){c=rt(c),u=qe(u);var y=u?Li(c):0;return u&&y<u?ja(u-y,f)+c:c}function zN(c,u,f){return f||u==null?u=0:u&&(u=+u),nb(rt(c).replace(Rc,""),u||0)}function KN(c,u,f){return(f?Zt(c,u,f):u===t)?u=1:u=qe(u),su(rt(c),u)}function JN(){var c=arguments,u=rt(c[0]);return c.length<3?u:u.replace(c[1],c[2])}var XN=Wi(function(c,u,f){return c+(f?"_":"")+u.toLowerCase()});function ZN(c,u,f){return f&&typeof f!="number"&&Zt(c,u,f)&&(u=f=t),f=f===t?_e:f>>>0,f?(c=rt(c),c&&(typeof u=="string"||u!=null&&!_u(u))&&(u=mn(u),!u&&$i(c))?Xr(Un(c),0,f):c.split(u,f)):[]}var eC=Wi(function(c,u,f){return c+(f?" ":"")+Pu(u)});function tC(c,u,f){return c=rt(c),f=f==null?0:pi(qe(f),0,c.length),u=mn(u),c.slice(f,f+u.length)==u}function nC(c,u,f){var y=N.templateSettings;f&&Zt(c,u,f)&&(u=t),c=rt(c),u=eo({},u,y,yf);var T=eo({},u.imports,y.imports,yf),C=$t(T),M=jc(T,C),P,U,z=0,K=u.interpolate||fa,ee="__p += '",ue=Qc((u.escape||fa).source+"|"+K.source+"|"+(K===qh?$E:fa).source+"|"+(u.evaluate||fa).source+"|$","g"),we="//# sourceURL="+(st.call(u,"sourceURL")?(u.sourceURL+"").replace(/\s/g," "):"lodash.templateSources["+ ++hw+"]")+`
`;c.replace(ue,function(ve,je,He,gn,en,En){return He||(He=gn),ee+=c.slice(z,En).replace(jE,Pw),je&&(P=!0,ee+=`' +
__e(`+je+`) +
'`),en&&(U=!0,ee+=`';
`+en+`;
__p += '`),He&&(ee+=`' +
((__t = (`+He+`)) == null ? '' : __t) +
'`),z=En+ve.length,ve}),ee+=`';
`;var Ce=st.call(u,"variable")&&u.variable;if(!Ce)ee=`with (obj) {
`+ee+`
}
`;else if(DE.test(Ce))throw new De(o);ee=(U?ee.replace(it,""):ee).replace(EE,"$1").replace(wE,"$1;"),ee="function("+(Ce||"obj")+`) {
`+(Ce?"":`obj || (obj = {});
`)+"var __t, __p = ''"+(P?", __e = _.escape":"")+(U?`, __j = Array.prototype.join;
function print() { __p += __j.call(arguments, '') }
`:`;
`)+ee+`return __p
}`;var Ue=cp(function(){return nt(C,we+"return "+ee).apply(t,M)});if(Ue.source=ee,Ru(Ue))throw Ue;return Ue}function rC(c){return rt(c).toLowerCase()}function iC(c){return rt(c).toUpperCase()}function sC(c,u,f){if(c=rt(c),c&&(f||u===t))return yd(c);if(!c||!(u=mn(u)))return c;var y=Un(c),T=Un(u),C=gd(y,T),M=Ed(y,T)+1;return Xr(y,C,M).join("")}function aC(c,u,f){if(c=rt(c),c&&(f||u===t))return c.slice(0,bd(c)+1);if(!c||!(u=mn(u)))return c;var y=Un(c),T=Ed(y,Un(u))+1;return Xr(y,0,T).join("")}function oC(c,u,f){if(c=rt(c),c&&(f||u===t))return c.replace(Rc,"");if(!c||!(u=mn(u)))return c;var y=Un(c),T=gd(y,Un(u));return Xr(y,T).join("")}function cC(c,u){var f=Ae,y=D;if(bt(u)){var T="separator"in u?u.separator:T;f="length"in u?qe(u.length):f,y="omission"in u?mn(u.omission):y}c=rt(c);var C=c.length;if($i(c)){var M=Un(c);C=M.length}if(f>=C)return c;var P=f-Li(y);if(P<1)return y;var U=M?Xr(M,0,P).join(""):c.slice(0,P);if(T===t)return U+y;if(M&&(P+=U.length-P),_u(T)){if(c.slice(P).search(T)){var z,K=U;for(T.global||(T=Qc(T.source,rt(Bh.exec(T))+"g")),T.lastIndex=0;z=T.exec(K);)var ee=z.index;U=U.slice(0,ee===t?P:ee)}}else if(c.indexOf(mn(T),P)!=P){var ue=U.lastIndexOf(T);ue>-1&&(U=U.slice(0,ue))}return U+y}function uC(c){return c=rt(c),c&&bE.test(c)?c.replace($h,Bw):c}var lC=Wi(function(c,u,f){return c+(f?" ":"")+u.toUpperCase()}),Pu=uf("toUpperCase");function op(c,u,f){return c=rt(c),u=f?t:u,u===t?Dw(c)?kw(c):Nw(c):c.match(u)||[]}var cp=Fe(function(c,u){try{return fn(c,t,u)}catch(f){return Ru(f)?f:new De(f)}}),hC=Nr(function(c,u){return Sn(u,function(f){f=or(f),Sr(c,f,Cu(c[f],c))}),c});function dC(c){var u=c==null?0:c.length,f=Ne();return c=u?yt(c,function(y){if(typeof y[1]!="function")throw new An(a);return[f(y[0]),y[1]]}):[],Fe(function(y){for(var T=-1;++T<u;){var C=c[T];if(fn(C[0],this,y))return fn(C[1],this,y)}})}function fC(c){return Bb(Cn(c,p))}function Ou(c){return function(){return c}}function pC(c,u){return c==null||c!==c?u:c}var mC=hf(),yC=hf(!0);function cn(c){return c}function Du(c){return Fd(typeof c=="function"?c:Cn(c,p))}function gC(c){return jd(Cn(c,p))}function EC(c,u){return Wd(c,Cn(u,p))}var wC=Fe(function(c,u){return function(f){return Ps(f,c,u)}}),bC=Fe(function(c,u){return function(f){return Ps(c,f,u)}});function Iu(c,u,f){var y=$t(u),T=$a(u,y);f==null&&!(bt(u)&&(T.length||!y.length))&&(f=u,u=c,c=this,T=$a(u,$t(u)));var C=!(bt(f)&&"chain"in f)||!!f.chain,M=vr(c);return Sn(T,function(P){var U=u[P];c[P]=U,M&&(c.prototype[P]=function(){var z=this.__chain__;if(C||z){var K=c(this.__wrapped__),ee=K.__actions__=sn(this.__actions__);return ee.push({func:U,args:arguments,thisArg:c}),K.__chain__=z,K}return U.apply(c,Hr([this.value()],arguments))})}),c}function TC(){return Ft._===this&&(Ft._=Yw),this}function $u(){}function SC(c){return c=qe(c),Fe(function(u){return Qd(u,c)})}var AC=du(yt),NC=du(hd),CC=du(qc);function up(c){return wu(c)?Bc(or(c)):tT(c)}function vC(c){return function(u){return c==null?t:mi(c,u)}}var RC=ff(),_C=ff(!0);function Lu(){return[]}function qu(){return!1}function xC(){return{}}function MC(){return""}function PC(){return!0}function OC(c,u){if(c=qe(c),c<1||c>ye)return[];var f=_e,y=Qt(c,_e);u=Ne(u),c-=_e;for(var T=kc(y,u);++f<c;)u(f);return T}function DC(c){return Ie(c)?yt(c,or):yn(c)?[c]:sn(xf(rt(c)))}function IC(c){var u=++Vw;return rt(c)+u}var $C=ka(function(c,u){return c+u},0),LC=fu("ceil"),qC=ka(function(c,u){return c/u},1),BC=fu("floor");function UC(c){return c&&c.length?Ia(c,cn,Xc):t}function FC(c,u){return c&&c.length?Ia(c,Ne(u,2),Xc):t}function kC(c){return pd(c,cn)}function jC(c,u){return pd(c,Ne(u,2))}function WC(c){return c&&c.length?Ia(c,cn,nu):t}function QC(c,u){return c&&c.length?Ia(c,Ne(u,2),nu):t}var VC=ka(function(c,u){return c*u},1),HC=fu("round"),YC=ka(function(c,u){return c-u},0);function GC(c){return c&&c.length?Fc(c,cn):0}function zC(c,u){return c&&c.length?Fc(c,Ne(u,2)):0}return N.after=gA,N.ary=Ff,N.assign=iN,N.assignIn=ep,N.assignInWith=eo,N.assignWith=sN,N.at=aN,N.before=kf,N.bind=Cu,N.bindAll=hC,N.bindKey=jf,N.castArray=xA,N.chain=qf,N.chunk=BT,N.compact=UT,N.concat=FT,N.cond=dC,N.conforms=fC,N.constant=Ou,N.countBy=GS,N.create=oN,N.curry=Wf,N.curryRight=Qf,N.debounce=Vf,N.defaults=cN,N.defaultsDeep=uN,N.defer=EA,N.delay=wA,N.difference=kT,N.differenceBy=jT,N.differenceWith=WT,N.drop=QT,N.dropRight=VT,N.dropRightWhile=HT,N.dropWhile=YT,N.fill=GT,N.filter=KS,N.flatMap=ZS,N.flatMapDeep=eA,N.flatMapDepth=tA,N.flatten=Df,N.flattenDeep=zT,N.flattenDepth=KT,N.flip=bA,N.flow=mC,N.flowRight=yC,N.fromPairs=JT,N.functions=yN,N.functionsIn=gN,N.groupBy=nA,N.initial=ZT,N.intersection=eS,N.intersectionBy=tS,N.intersectionWith=nS,N.invert=wN,N.invertBy=bN,N.invokeMap=iA,N.iteratee=Du,N.keyBy=sA,N.keys=$t,N.keysIn=on,N.map=Ga,N.mapKeys=SN,N.mapValues=AN,N.matches=gC,N.matchesProperty=EC,N.memoize=Ka,N.merge=NN,N.mergeWith=tp,N.method=wC,N.methodOf=bC,N.mixin=Iu,N.negate=Ja,N.nthArg=SC,N.omit=CN,N.omitBy=vN,N.once=TA,N.orderBy=aA,N.over=AC,N.overArgs=SA,N.overEvery=NC,N.overSome=CC,N.partial=vu,N.partialRight=Hf,N.partition=oA,N.pick=RN,N.pickBy=np,N.property=up,N.propertyOf=vC,N.pull=aS,N.pullAll=$f,N.pullAllBy=oS,N.pullAllWith=cS,N.pullAt=uS,N.range=RC,N.rangeRight=_C,N.rearg=AA,N.reject=lA,N.remove=lS,N.rest=NA,N.reverse=Au,N.sampleSize=dA,N.set=xN,N.setWith=MN,N.shuffle=fA,N.slice=hS,N.sortBy=yA,N.sortedUniq=ES,N.sortedUniqBy=wS,N.split=ZN,N.spread=CA,N.tail=bS,N.take=TS,N.takeRight=SS,N.takeRightWhile=AS,N.takeWhile=NS,N.tap=US,N.throttle=vA,N.thru=Ya,N.toArray=Jf,N.toPairs=rp,N.toPairsIn=ip,N.toPath=DC,N.toPlainObject=Zf,N.transform=PN,N.unary=RA,N.union=CS,N.unionBy=vS,N.unionWith=RS,N.uniq=_S,N.uniqBy=xS,N.uniqWith=MS,N.unset=ON,N.unzip=Nu,N.unzipWith=Lf,N.update=DN,N.updateWith=IN,N.values=Hi,N.valuesIn=$N,N.without=PS,N.words=op,N.wrap=_A,N.xor=OS,N.xorBy=DS,N.xorWith=IS,N.zip=$S,N.zipObject=LS,N.zipObjectDeep=qS,N.zipWith=BS,N.entries=rp,N.entriesIn=ip,N.extend=ep,N.extendWith=eo,Iu(N,N),N.add=$C,N.attempt=cp,N.camelCase=UN,N.capitalize=sp,N.ceil=LC,N.clamp=LN,N.clone=MA,N.cloneDeep=OA,N.cloneDeepWith=DA,N.cloneWith=PA,N.conformsTo=IA,N.deburr=ap,N.defaultTo=pC,N.divide=qC,N.endsWith=FN,N.eq=kn,N.escape=kN,N.escapeRegExp=jN,N.every=zS,N.find=JS,N.findIndex=Pf,N.findKey=lN,N.findLast=XS,N.findLastIndex=Of,N.findLastKey=hN,N.floor=BC,N.forEach=Bf,N.forEachRight=Uf,N.forIn=dN,N.forInRight=fN,N.forOwn=pN,N.forOwnRight=mN,N.get=xu,N.gt=$A,N.gte=LA,N.has=EN,N.hasIn=Mu,N.head=If,N.identity=cn,N.includes=rA,N.indexOf=XT,N.inRange=qN,N.invoke=TN,N.isArguments=Ei,N.isArray=Ie,N.isArrayBuffer=qA,N.isArrayLike=an,N.isArrayLikeObject=vt,N.isBoolean=BA,N.isBuffer=Zr,N.isDate=UA,N.isElement=FA,N.isEmpty=kA,N.isEqual=jA,N.isEqualWith=WA,N.isError=Ru,N.isFinite=QA,N.isFunction=vr,N.isInteger=Yf,N.isLength=Xa,N.isMap=Gf,N.isMatch=VA,N.isMatchWith=HA,N.isNaN=YA,N.isNative=GA,N.isNil=KA,N.isNull=zA,N.isNumber=zf,N.isObject=bt,N.isObjectLike=St,N.isPlainObject=qs,N.isRegExp=_u,N.isSafeInteger=JA,N.isSet=Kf,N.isString=Za,N.isSymbol=yn,N.isTypedArray=Vi,N.isUndefined=XA,N.isWeakMap=ZA,N.isWeakSet=eN,N.join=rS,N.kebabCase=WN,N.last=Rn,N.lastIndexOf=iS,N.lowerCase=QN,N.lowerFirst=VN,N.lt=tN,N.lte=nN,N.max=UC,N.maxBy=FC,N.mean=kC,N.meanBy=jC,N.min=WC,N.minBy=QC,N.stubArray=Lu,N.stubFalse=qu,N.stubObject=xC,N.stubString=MC,N.stubTrue=PC,N.multiply=VC,N.nth=sS,N.noConflict=TC,N.noop=$u,N.now=za,N.pad=HN,N.padEnd=YN,N.padStart=GN,N.parseInt=zN,N.random=BN,N.reduce=cA,N.reduceRight=uA,N.repeat=KN,N.replace=JN,N.result=_N,N.round=HC,N.runInContext=L,N.sample=hA,N.size=pA,N.snakeCase=XN,N.some=mA,N.sortedIndex=dS,N.sortedIndexBy=fS,N.sortedIndexOf=pS,N.sortedLastIndex=mS,N.sortedLastIndexBy=yS,N.sortedLastIndexOf=gS,N.startCase=eC,N.startsWith=tC,N.subtract=YC,N.sum=GC,N.sumBy=zC,N.template=nC,N.times=OC,N.toFinite=Rr,N.toInteger=qe,N.toLength=Xf,N.toLower=rC,N.toNumber=_n,N.toSafeInteger=rN,N.toString=rt,N.toUpper=iC,N.trim=sC,N.trimEnd=aC,N.trimStart=oC,N.truncate=cC,N.unescape=uC,N.uniqueId=IC,N.upperCase=lC,N.upperFirst=Pu,N.each=Bf,N.eachRight=Uf,N.first=If,Iu(N,function(){var c={};return sr(N,function(u,f){st.call(N.prototype,f)||(c[f]=u)}),c}(),{chain:!1}),N.VERSION=n,Sn(["bind","bindKey","curry","curryRight","partial","partialRight"],function(c){N[c].placeholder=N}),Sn(["drop","take"],function(c,u){Qe.prototype[c]=function(f){f=f===t?1:Ot(qe(f),0);var y=this.__filtered__&&!u?new Qe(this):this.clone();return y.__filtered__?y.__takeCount__=Qt(f,y.__takeCount__):y.__views__.push({size:Qt(f,_e),type:c+(y.__dir__<0?"Right":"")}),y},Qe.prototype[c+"Right"]=function(f){return this.reverse()[c](f).reverse()}}),Sn(["filter","map","takeWhile"],function(c,u){var f=u+1,y=f==te||f==fe;Qe.prototype[c]=function(T){var C=this.clone();return C.__iteratees__.push({iteratee:Ne(T,3),type:f}),C.__filtered__=C.__filtered__||y,C}}),Sn(["head","last"],function(c,u){var f="take"+(u?"Right":"");Qe.prototype[c]=function(){return this[f](1).value()[0]}}),Sn(["initial","tail"],function(c,u){var f="drop"+(u?"":"Right");Qe.prototype[c]=function(){return this.__filtered__?new Qe(this):this[f](1)}}),Qe.prototype.compact=function(){return this.filter(cn)},Qe.prototype.find=function(c){return this.filter(c).head()},Qe.prototype.findLast=function(c){return this.reverse().find(c)},Qe.prototype.invokeMap=Fe(function(c,u){return typeof c=="function"?new Qe(this):this.map(function(f){return Ps(f,c,u)})}),Qe.prototype.reject=function(c){return this.filter(Ja(Ne(c)))},Qe.prototype.slice=function(c,u){c=qe(c);var f=this;return f.__filtered__&&(c>0||u<0)?new Qe(f):(c<0?f=f.takeRight(-c):c&&(f=f.drop(c)),u!==t&&(u=qe(u),f=u<0?f.dropRight(-u):f.take(u-c)),f)},Qe.prototype.takeRightWhile=function(c){return this.reverse().takeWhile(c).reverse()},Qe.prototype.toArray=function(){return this.take(_e)},sr(Qe.prototype,function(c,u){var f=/^(?:filter|find|map|reject)|While$/.test(u),y=/^(?:head|last)$/.test(u),T=N[y?"take"+(u=="last"?"Right":""):u],C=y||/^find/.test(u);T&&(N.prototype[u]=function(){var M=this.__wrapped__,P=y?[1]:arguments,U=M instanceof Qe,z=P[0],K=U||Ie(M),ee=function(je){var He=T.apply(N,Hr([je],P));return y&&ue?He[0]:He};K&&f&&typeof z=="function"&&z.length!=1&&(U=K=!1);var ue=this.__chain__,we=!!this.__actions__.length,Ce=C&&!ue,Ue=U&&!we;if(!C&&K){M=Ue?M:new Qe(this);var ve=c.apply(M,P);return ve.__actions__.push({func:Ya,args:[ee],thisArg:t}),new Nn(ve,ue)}return Ce&&Ue?c.apply(this,P):(ve=this.thru(ee),Ce?y?ve.value()[0]:ve.value():ve)})}),Sn(["pop","push","shift","sort","splice","unshift"],function(c){var u=wa[c],f=/^(?:push|sort|unshift)$/.test(c)?"tap":"thru",y=/^(?:pop|shift)$/.test(c);N.prototype[c]=function(){var T=arguments;if(y&&!this.__chain__){var C=this.value();return u.apply(Ie(C)?C:[],T)}return this[f](function(M){return u.apply(Ie(M)?M:[],T)})}}),sr(Qe.prototype,function(c,u){var f=N[u];if(f){var y=f.name+"";st.call(Fi,y)||(Fi[y]=[]),Fi[y].push({name:u,func:f})}}),Fi[Fa(t,$).name]=[{name:"wrapper",func:t}],Qe.prototype.clone=ub,Qe.prototype.reverse=lb,Qe.prototype.value=hb,N.prototype.at=FS,N.prototype.chain=kS,N.prototype.commit=jS,N.prototype.next=WS,N.prototype.plant=VS,N.prototype.reverse=HS,N.prototype.toJSON=N.prototype.valueOf=N.prototype.value=YS,N.prototype.first=N.prototype.head,Ns&&(N.prototype[Ns]=QS),N},qi=jw();li?((li.exports=qi)._=qi,Dc._=qi):Ft._=qi}).call(bi)})(xo,xo.exports);var i0=xo.exports;class s0{}var ni=(s=>(s[s.Error=0]="Error",s[s.Success=1]="Success",s[s.PartialSuccess=2]="PartialSuccess",s[s.LogicalFailure=3]="LogicalFailure",s[s.Warning=4]="Warning",s[s.Recoverable=5]="Recoverable",s[s.Info=6]="Info",s[s.Pending=7]="Pending",s[s.Cancelled=8]="Cancelled",s[s.NotFound=9]="NotFound",s[s.NotImplemented=10]="NotImplemented",s[s.SystemError=11]="SystemError",s[s.Fatal=12]="Fatal",s[s.Unknown=13]="Unknown",s[s.NetworkError=17]="NetworkError",s[s.PermissionDenied=18]="PermissionDenied",s))(ni||{});const L1={data:null,state:0,message:"Failed!"},a0=["Guid","docId","Enabled"];class yo{static getInheritanceTree(e){const t=[e],n=r=>{const i=Object.getPrototypeOf(r);i&&i.name&&(t.push(i),n(i))};return n(e),t}static isInherited(e,t){return e.prototype instanceof t}static filterByTarget(e,t){return t?e.filter(n=>n.target&&t.indexOf(n.target)!==-1):e}}class ey{constructor(){this.tables=[],this.trees=[],this.entityRepositories=[],this.transactionEntityManagers=[],this.transactionRepositories=[],this.namingStrategies=[],this.entitySubscribers=[],this.indices=[],this.foreignKeys=[],this.uniques=[],this.checks=[],this.exclusions=[],this.columns=[],this.generations=[],this.relations=[],this.joinColumns=[],this.joinTables=[],this.entityListeners=[],this.relationCounts=[],this.relationIds=[],this.embeddeds=[],this.inheritances=[],this.discriminatorValues=[]}filterTables(e){return this.filterByTarget(this.tables,e)}filterColumns(e){return this.filterByTargetAndWithoutDuplicateProperties(this.columns,e)}findGenerated(e,t){return this.generations.find(n=>(Array.isArray(e)?e.indexOf(n.target)!==-1:n.target===e)&&n.propertyName===t)}findTree(e){return this.trees.find(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterRelations(e){return this.filterByTargetAndWithoutDuplicateRelationProperties(this.relations,e)}filterRelationIds(e){return this.filterByTargetAndWithoutDuplicateProperties(this.relationIds,e)}filterRelationCounts(e){return this.filterByTargetAndWithoutDuplicateProperties(this.relationCounts,e)}filterIndices(e){return this.indices.filter(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterForeignKeys(e){return this.foreignKeys.filter(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterUniques(e){return this.uniques.filter(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterChecks(e){return this.checks.filter(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterExclusions(e){return this.exclusions.filter(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterListeners(e){return this.filterByTarget(this.entityListeners,e)}filterEmbeddeds(e){return this.filterByTargetAndWithoutDuplicateEmbeddedProperties(this.embeddeds,e)}findJoinTable(e,t){return this.joinTables.find(n=>n.target===e&&n.propertyName===t)}filterJoinColumns(e,t){return this.joinColumns.filter(n=>n.target===e&&n.propertyName===t)}filterSubscribers(e){return this.filterByTarget(this.entitySubscribers,e)}filterNamingStrategies(e){return this.filterByTarget(this.namingStrategies,e)}filterTransactionEntityManagers(e,t){return this.transactionEntityManagers.filter(n=>(Array.isArray(e)?e.indexOf(n.target)!==-1:n.target===e)&&n.methodName===t)}filterTransactionRepository(e,t){return this.transactionRepositories.filter(n=>(Array.isArray(e)?e.indexOf(n.target)!==-1:n.target===e)&&n.methodName===t)}filterSingleTableChildren(e){return this.tables.filter(t=>typeof t.target=="function"&&typeof e=="function"&&yo.isInherited(t.target,e)&&t.type==="entity-child")}findInheritanceType(e){return this.inheritances.find(t=>t.target===e)}findDiscriminatorValue(e){return this.discriminatorValues.find(t=>t.target===e)}filterByTarget(e,t){return e.filter(n=>Array.isArray(t)?t.indexOf(n.target)!==-1:n.target===t)}filterByTargetAndWithoutDuplicateProperties(e,t){const n=[];return e.forEach(r=>{(Array.isArray(t)?t.indexOf(r.target)!==-1:r.target===t)&&(n.find(a=>a.propertyName===r.propertyName)||n.push(r))}),n}filterByTargetAndWithoutDuplicateRelationProperties(e,t){const n=[];return e.forEach(r=>{if(Array.isArray(t)?t.indexOf(r.target)!==-1:r.target===t){const a=n.findIndex(o=>o.propertyName===r.propertyName);if(Array.isArray(t)&&a!==-1&&t.indexOf(r.target)<t.indexOf(n[a].target)){const o=Object.create(n[a]);o.type=r.type,n[a]=o}else a===-1&&n.push(r)}}),n}filterByTargetAndWithoutDuplicateEmbeddedProperties(e,t){const n=[];return e.forEach(r=>{(Array.isArray(t)?t.indexOf(r.target)!==-1:r.target===t)&&(n.find(o=>o.prefix===r.prefix&&o.propertyName===r.propertyName)||n.push(r))}),n}}var Yo={},Go={};Go.byteLength=u0;Go.toByteArray=h0;Go.fromByteArray=p0;var ur=[],xn=[],o0=typeof Uint8Array<"u"?Uint8Array:Array,ju="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var Yi=0,c0=ju.length;Yi<c0;++Yi)ur[Yi]=ju[Yi],xn[ju.charCodeAt(Yi)]=Yi;xn[45]=62;xn[95]=63;function ty(s){var e=s.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=s.indexOf("=");t===-1&&(t=e);var n=t===e?0:4-t%4;return[t,n]}function u0(s){var e=ty(s),t=e[0],n=e[1];return(t+n)*3/4-n}function l0(s,e,t){return(e+t)*3/4-t}function h0(s){var e,t=ty(s),n=t[0],r=t[1],i=new o0(l0(s,n,r)),a=0,o=r>0?n-4:n,l;for(l=0;l<o;l+=4)e=xn[s.charCodeAt(l)]<<18|xn[s.charCodeAt(l+1)]<<12|xn[s.charCodeAt(l+2)]<<6|xn[s.charCodeAt(l+3)],i[a++]=e>>16&255,i[a++]=e>>8&255,i[a++]=e&255;return r===2&&(e=xn[s.charCodeAt(l)]<<2|xn[s.charCodeAt(l+1)]>>4,i[a++]=e&255),r===1&&(e=xn[s.charCodeAt(l)]<<10|xn[s.charCodeAt(l+1)]<<4|xn[s.charCodeAt(l+2)]>>2,i[a++]=e>>8&255,i[a++]=e&255),i}function d0(s){return ur[s>>18&63]+ur[s>>12&63]+ur[s>>6&63]+ur[s&63]}function f0(s,e,t){for(var n,r=[],i=e;i<t;i+=3)n=(s[i]<<16&16711680)+(s[i+1]<<8&65280)+(s[i+2]&255),r.push(d0(n));return r.join("")}function p0(s){for(var e,t=s.length,n=t%3,r=[],i=16383,a=0,o=t-n;a<o;a+=i)r.push(f0(s,a,a+i>o?o:a+i));return n===1?(e=s[t-1],r.push(ur[e>>2]+ur[e<<4&63]+"==")):n===2&&(e=(s[t-2]<<8)+s[t-1],r.push(ur[e>>10]+ur[e>>4&63]+ur[e<<2&63]+"=")),r.join("")}var Xl={};/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */Xl.read=function(s,e,t,n,r){var i,a,o=r*8-n-1,l=(1<<o)-1,h=l>>1,d=-7,p=t?r-1:0,m=t?-1:1,w=s[e+p];for(p+=m,i=w&(1<<-d)-1,w>>=-d,d+=o;d>0;i=i*256+s[e+p],p+=m,d-=8);for(a=i&(1<<-d)-1,i>>=-d,d+=n;d>0;a=a*256+s[e+p],p+=m,d-=8);if(i===0)i=1-h;else{if(i===l)return a?NaN:(w?-1:1)*(1/0);a=a+Math.pow(2,n),i=i-h}return(w?-1:1)*a*Math.pow(2,i-n)};Xl.write=function(s,e,t,n,r,i){var a,o,l,h=i*8-r-1,d=(1<<h)-1,p=d>>1,m=r===23?Math.pow(2,-24)-Math.pow(2,-77):0,w=n?0:i-1,b=n?1:-1,S=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(o=isNaN(e)?1:0,a=d):(a=Math.floor(Math.log(e)/Math.LN2),e*(l=Math.pow(2,-a))<1&&(a--,l*=2),a+p>=1?e+=m/l:e+=m*Math.pow(2,1-p),e*l>=2&&(a++,l/=2),a+p>=d?(o=0,a=d):a+p>=1?(o=(e*l-1)*Math.pow(2,r),a=a+p):(o=e*Math.pow(2,p-1)*Math.pow(2,r),a=0));r>=8;s[t+w]=o&255,w+=b,o/=256,r-=8);for(a=a<<r|o,h+=r;h>0;s[t+w]=a&255,w+=b,a/=256,h-=8);s[t+w-b]|=S*128};/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */(function(s){const e=Go,t=Xl,n=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;s.Buffer=o,s.SlowBuffer=q,s.INSPECT_MAX_BYTES=50;const r=2147483647;s.kMaxLength=r,o.TYPED_ARRAY_SUPPORT=i(),!o.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function i(){try{const A=new Uint8Array(1),g={foo:function(){return 42}};return Object.setPrototypeOf(g,Uint8Array.prototype),Object.setPrototypeOf(A,g),A.foo()===42}catch{return!1}}Object.defineProperty(o.prototype,"parent",{enumerable:!0,get:function(){if(o.isBuffer(this))return this.buffer}}),Object.defineProperty(o.prototype,"offset",{enumerable:!0,get:function(){if(o.isBuffer(this))return this.byteOffset}});function a(A){if(A>r)throw new RangeError('The value "'+A+'" is invalid for option "size"');const g=new Uint8Array(A);return Object.setPrototypeOf(g,o.prototype),g}function o(A,g,E){if(typeof A=="number"){if(typeof g=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return p(A)}return l(A,g,E)}o.poolSize=8192;function l(A,g,E){if(typeof A=="string")return m(A,g);if(ArrayBuffer.isView(A))return b(A);if(A==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof A);if(Wt(A,ArrayBuffer)||A&&Wt(A.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(Wt(A,SharedArrayBuffer)||A&&Wt(A.buffer,SharedArrayBuffer)))return S(A,g,E);if(typeof A=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const v=A.valueOf&&A.valueOf();if(v!=null&&v!==A)return o.from(v,g,E);const I=R(A);if(I)return I;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof A[Symbol.toPrimitive]=="function")return o.from(A[Symbol.toPrimitive]("string"),g,E);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof A)}o.from=function(A,g,E){return l(A,g,E)},Object.setPrototypeOf(o.prototype,Uint8Array.prototype),Object.setPrototypeOf(o,Uint8Array);function h(A){if(typeof A!="number")throw new TypeError('"size" argument must be of type number');if(A<0)throw new RangeError('The value "'+A+'" is invalid for option "size"')}function d(A,g,E){return h(A),A<=0?a(A):g!==void 0?typeof E=="string"?a(A).fill(g,E):a(A).fill(g):a(A)}o.alloc=function(A,g,E){return d(A,g,E)};function p(A){return h(A),a(A<0?0:$(A)|0)}o.allocUnsafe=function(A){return p(A)},o.allocUnsafeSlow=function(A){return p(A)};function m(A,g){if((typeof g!="string"||g==="")&&(g="utf8"),!o.isEncoding(g))throw new TypeError("Unknown encoding: "+g);const E=O(A,g)|0;let v=a(E);const I=v.write(A,g);return I!==E&&(v=v.slice(0,I)),v}function w(A){const g=A.length<0?0:$(A.length)|0,E=a(g);for(let v=0;v<g;v+=1)E[v]=A[v]&255;return E}function b(A){if(Wt(A,Uint8Array)){const g=new Uint8Array(A);return S(g.buffer,g.byteOffset,g.byteLength)}return w(A)}function S(A,g,E){if(g<0||A.byteLength<g)throw new RangeError('"offset" is outside of buffer bounds');if(A.byteLength<g+(E||0))throw new RangeError('"length" is outside of buffer bounds');let v;return g===void 0&&E===void 0?v=new Uint8Array(A):E===void 0?v=new Uint8Array(A,g):v=new Uint8Array(A,g,E),Object.setPrototypeOf(v,o.prototype),v}function R(A){if(o.isBuffer(A)){const g=$(A.length)|0,E=a(g);return E.length===0||A.copy(E,0,0,g),E}if(A.length!==void 0)return typeof A.length!="number"||Qr(A.length)?a(0):w(A);if(A.type==="Buffer"&&Array.isArray(A.data))return w(A.data)}function $(A){if(A>=r)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+r.toString(16)+" bytes");return A|0}function q(A){return+A!=A&&(A=0),o.alloc(+A)}o.isBuffer=function(g){return g!=null&&g._isBuffer===!0&&g!==o.prototype},o.compare=function(g,E){if(Wt(g,Uint8Array)&&(g=o.from(g,g.offset,g.byteLength)),Wt(E,Uint8Array)&&(E=o.from(E,E.offset,E.byteLength)),!o.isBuffer(g)||!o.isBuffer(E))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(g===E)return 0;let v=g.length,I=E.length;for(let k=0,G=Math.min(v,I);k<G;++k)if(g[k]!==E[k]){v=g[k],I=E[k];break}return v<I?-1:I<v?1:0},o.isEncoding=function(g){switch(String(g).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},o.concat=function(g,E){if(!Array.isArray(g))throw new TypeError('"list" argument must be an Array of Buffers');if(g.length===0)return o.alloc(0);let v;if(E===void 0)for(E=0,v=0;v<g.length;++v)E+=g[v].length;const I=o.allocUnsafe(E);let k=0;for(v=0;v<g.length;++v){let G=g[v];if(Wt(G,Uint8Array))k+G.length>I.length?(o.isBuffer(G)||(G=o.from(G)),G.copy(I,k)):Uint8Array.prototype.set.call(I,G,k);else if(o.isBuffer(G))G.copy(I,k);else throw new TypeError('"list" argument must be an Array of Buffers');k+=G.length}return I};function O(A,g){if(o.isBuffer(A))return A.length;if(ArrayBuffer.isView(A)||Wt(A,ArrayBuffer))return A.byteLength;if(typeof A!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof A);const E=A.length,v=arguments.length>2&&arguments[2]===!0;if(!v&&E===0)return 0;let I=!1;for(;;)switch(g){case"ascii":case"latin1":case"binary":return E;case"utf8":case"utf-8":return Jt(A).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return E*2;case"hex":return E>>>1;case"base64":return ir(A).length;default:if(I)return v?-1:Jt(A).length;g=(""+g).toLowerCase(),I=!0}}o.byteLength=O;function J(A,g,E){let v=!1;if((g===void 0||g<0)&&(g=0),g>this.length||((E===void 0||E>this.length)&&(E=this.length),E<=0)||(E>>>=0,g>>>=0,E<=g))return"";for(A||(A="utf8");;)switch(A){case"hex":return Ge(this,g,E);case"utf8":case"utf-8":return te(this,g,E);case"ascii":return oe(this,g,E);case"latin1":case"binary":return ye(this,g,E);case"base64":return Q(this,g,E);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return ze(this,g,E);default:if(v)throw new TypeError("Unknown encoding: "+A);A=(A+"").toLowerCase(),v=!0}}o.prototype._isBuffer=!0;function ne(A,g,E){const v=A[g];A[g]=A[E],A[E]=v}o.prototype.swap16=function(){const g=this.length;if(g%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let E=0;E<g;E+=2)ne(this,E,E+1);return this},o.prototype.swap32=function(){const g=this.length;if(g%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let E=0;E<g;E+=4)ne(this,E,E+3),ne(this,E+1,E+2);return this},o.prototype.swap64=function(){const g=this.length;if(g%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let E=0;E<g;E+=8)ne(this,E,E+7),ne(this,E+1,E+6),ne(this,E+2,E+5),ne(this,E+3,E+4);return this},o.prototype.toString=function(){const g=this.length;return g===0?"":arguments.length===0?te(this,0,g):J.apply(this,arguments)},o.prototype.toLocaleString=o.prototype.toString,o.prototype.equals=function(g){if(!o.isBuffer(g))throw new TypeError("Argument must be a Buffer");return this===g?!0:o.compare(this,g)===0},o.prototype.inspect=function(){let g="";const E=s.INSPECT_MAX_BYTES;return g=this.toString("hex",0,E).replace(/(.{2})/g,"$1 ").trim(),this.length>E&&(g+=" ... "),"<Buffer "+g+">"},n&&(o.prototype[n]=o.prototype.inspect),o.prototype.compare=function(g,E,v,I,k){if(Wt(g,Uint8Array)&&(g=o.from(g,g.offset,g.byteLength)),!o.isBuffer(g))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof g);if(E===void 0&&(E=0),v===void 0&&(v=g?g.length:0),I===void 0&&(I=0),k===void 0&&(k=this.length),E<0||v>g.length||I<0||k>this.length)throw new RangeError("out of range index");if(I>=k&&E>=v)return 0;if(I>=k)return-1;if(E>=v)return 1;if(E>>>=0,v>>>=0,I>>>=0,k>>>=0,this===g)return 0;let G=k-I,Le=v-E;const ut=Math.min(G,Le),at=this.slice(I,k),lt=g.slice(E,v);for(let it=0;it<ut;++it)if(at[it]!==lt[it]){G=at[it],Le=lt[it];break}return G<Le?-1:Le<G?1:0};function ge(A,g,E,v,I){if(A.length===0)return-1;if(typeof E=="string"?(v=E,E=0):E>2147483647?E=2147483647:E<-2147483648&&(E=-2147483648),E=+E,Qr(E)&&(E=I?0:A.length-1),E<0&&(E=A.length+E),E>=A.length){if(I)return-1;E=A.length-1}else if(E<0)if(I)E=0;else return-1;if(typeof g=="string"&&(g=o.from(g,v)),o.isBuffer(g))return g.length===0?-1:pe(A,g,E,v,I);if(typeof g=="number")return g=g&255,typeof Uint8Array.prototype.indexOf=="function"?I?Uint8Array.prototype.indexOf.call(A,g,E):Uint8Array.prototype.lastIndexOf.call(A,g,E):pe(A,[g],E,v,I);throw new TypeError("val must be string, number or Buffer")}function pe(A,g,E,v,I){let k=1,G=A.length,Le=g.length;if(v!==void 0&&(v=String(v).toLowerCase(),v==="ucs2"||v==="ucs-2"||v==="utf16le"||v==="utf-16le")){if(A.length<2||g.length<2)return-1;k=2,G/=2,Le/=2,E/=2}function ut(lt,it){return k===1?lt[it]:lt.readUInt16BE(it*k)}let at;if(I){let lt=-1;for(at=E;at<G;at++)if(ut(A,at)===ut(g,lt===-1?0:at-lt)){if(lt===-1&&(lt=at),at-lt+1===Le)return lt*k}else lt!==-1&&(at-=at-lt),lt=-1}else for(E+Le>G&&(E=G-Le),at=E;at>=0;at--){let lt=!0;for(let it=0;it<Le;it++)if(ut(A,at+it)!==ut(g,it)){lt=!1;break}if(lt)return at}return-1}o.prototype.includes=function(g,E,v){return this.indexOf(g,E,v)!==-1},o.prototype.indexOf=function(g,E,v){return ge(this,g,E,v,!0)},o.prototype.lastIndexOf=function(g,E,v){return ge(this,g,E,v,!1)};function me(A,g,E,v){E=Number(E)||0;const I=A.length-E;v?(v=Number(v),v>I&&(v=I)):v=I;const k=g.length;v>k/2&&(v=k/2);let G;for(G=0;G<v;++G){const Le=parseInt(g.substr(G*2,2),16);if(Qr(Le))return G;A[E+G]=Le}return G}function V(A,g,E,v){return Ut(Jt(g,A.length-E),A,E,v)}function Ae(A,g,E,v){return Ut(Oi(g),A,E,v)}function D(A,g,E,v){return Ut(ir(g),A,E,v)}function ae(A,g,E,v){return Ut(X(g,A.length-E),A,E,v)}o.prototype.write=function(g,E,v,I){if(E===void 0)I="utf8",v=this.length,E=0;else if(v===void 0&&typeof E=="string")I=E,v=this.length,E=0;else if(isFinite(E))E=E>>>0,isFinite(v)?(v=v>>>0,I===void 0&&(I="utf8")):(I=v,v=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const k=this.length-E;if((v===void 0||v>k)&&(v=k),g.length>0&&(v<0||E<0)||E>this.length)throw new RangeError("Attempt to write outside buffer bounds");I||(I="utf8");let G=!1;for(;;)switch(I){case"hex":return me(this,g,E,v);case"utf8":case"utf-8":return V(this,g,E,v);case"ascii":case"latin1":case"binary":return Ae(this,g,E,v);case"base64":return D(this,g,E,v);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return ae(this,g,E,v);default:if(G)throw new TypeError("Unknown encoding: "+I);I=(""+I).toLowerCase(),G=!0}},o.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function Q(A,g,E){return g===0&&E===A.length?e.fromByteArray(A):e.fromByteArray(A.slice(g,E))}function te(A,g,E){E=Math.min(A.length,E);const v=[];let I=g;for(;I<E;){const k=A[I];let G=null,Le=k>239?4:k>223?3:k>191?2:1;if(I+Le<=E){let ut,at,lt,it;switch(Le){case 1:k<128&&(G=k);break;case 2:ut=A[I+1],(ut&192)===128&&(it=(k&31)<<6|ut&63,it>127&&(G=it));break;case 3:ut=A[I+1],at=A[I+2],(ut&192)===128&&(at&192)===128&&(it=(k&15)<<12|(ut&63)<<6|at&63,it>2047&&(it<55296||it>57343)&&(G=it));break;case 4:ut=A[I+1],at=A[I+2],lt=A[I+3],(ut&192)===128&&(at&192)===128&&(lt&192)===128&&(it=(k&15)<<18|(ut&63)<<12|(at&63)<<6|lt&63,it>65535&&it<1114112&&(G=it))}}G===null?(G=65533,Le=1):G>65535&&(G-=65536,v.push(G>>>10&1023|55296),G=56320|G&1023),v.push(G),I+=Le}return fe(v)}const ce=4096;function fe(A){const g=A.length;if(g<=ce)return String.fromCharCode.apply(String,A);let E="",v=0;for(;v<g;)E+=String.fromCharCode.apply(String,A.slice(v,v+=ce));return E}function oe(A,g,E){let v="";E=Math.min(A.length,E);for(let I=g;I<E;++I)v+=String.fromCharCode(A[I]&127);return v}function ye(A,g,E){let v="";E=Math.min(A.length,E);for(let I=g;I<E;++I)v+=String.fromCharCode(A[I]);return v}function Ge(A,g,E){const v=A.length;(!g||g<0)&&(g=0),(!E||E<0||E>v)&&(E=v);let I="";for(let k=g;k<E;++k)I+=Nc[A[k]];return I}function ze(A,g,E){const v=A.slice(g,E);let I="";for(let k=0;k<v.length-1;k+=2)I+=String.fromCharCode(v[k]+v[k+1]*256);return I}o.prototype.slice=function(g,E){const v=this.length;g=~~g,E=E===void 0?v:~~E,g<0?(g+=v,g<0&&(g=0)):g>v&&(g=v),E<0?(E+=v,E<0&&(E=0)):E>v&&(E=v),E<g&&(E=g);const I=this.subarray(g,E);return Object.setPrototypeOf(I,o.prototype),I};function _e(A,g,E){if(A%1!==0||A<0)throw new RangeError("offset is not uint");if(A+g>E)throw new RangeError("Trying to access beyond buffer length")}o.prototype.readUintLE=o.prototype.readUIntLE=function(g,E,v){g=g>>>0,E=E>>>0,v||_e(g,E,this.length);let I=this[g],k=1,G=0;for(;++G<E&&(k*=256);)I+=this[g+G]*k;return I},o.prototype.readUintBE=o.prototype.readUIntBE=function(g,E,v){g=g>>>0,E=E>>>0,v||_e(g,E,this.length);let I=this[g+--E],k=1;for(;E>0&&(k*=256);)I+=this[g+--E]*k;return I},o.prototype.readUint8=o.prototype.readUInt8=function(g,E){return g=g>>>0,E||_e(g,1,this.length),this[g]},o.prototype.readUint16LE=o.prototype.readUInt16LE=function(g,E){return g=g>>>0,E||_e(g,2,this.length),this[g]|this[g+1]<<8},o.prototype.readUint16BE=o.prototype.readUInt16BE=function(g,E){return g=g>>>0,E||_e(g,2,this.length),this[g]<<8|this[g+1]},o.prototype.readUint32LE=o.prototype.readUInt32LE=function(g,E){return g=g>>>0,E||_e(g,4,this.length),(this[g]|this[g+1]<<8|this[g+2]<<16)+this[g+3]*16777216},o.prototype.readUint32BE=o.prototype.readUInt32BE=function(g,E){return g=g>>>0,E||_e(g,4,this.length),this[g]*16777216+(this[g+1]<<16|this[g+2]<<8|this[g+3])},o.prototype.readBigUInt64LE=rn(function(g){g=g>>>0,Bt(g,"offset");const E=this[g],v=this[g+7];(E===void 0||v===void 0)&&Tt(g,this.length-8);const I=E+this[++g]*2**8+this[++g]*2**16+this[++g]*2**24,k=this[++g]+this[++g]*2**8+this[++g]*2**16+v*2**24;return BigInt(I)+(BigInt(k)<<BigInt(32))}),o.prototype.readBigUInt64BE=rn(function(g){g=g>>>0,Bt(g,"offset");const E=this[g],v=this[g+7];(E===void 0||v===void 0)&&Tt(g,this.length-8);const I=E*2**24+this[++g]*2**16+this[++g]*2**8+this[++g],k=this[++g]*2**24+this[++g]*2**16+this[++g]*2**8+v;return(BigInt(I)<<BigInt(32))+BigInt(k)}),o.prototype.readIntLE=function(g,E,v){g=g>>>0,E=E>>>0,v||_e(g,E,this.length);let I=this[g],k=1,G=0;for(;++G<E&&(k*=256);)I+=this[g+G]*k;return k*=128,I>=k&&(I-=Math.pow(2,8*E)),I},o.prototype.readIntBE=function(g,E,v){g=g>>>0,E=E>>>0,v||_e(g,E,this.length);let I=E,k=1,G=this[g+--I];for(;I>0&&(k*=256);)G+=this[g+--I]*k;return k*=128,G>=k&&(G-=Math.pow(2,8*E)),G},o.prototype.readInt8=function(g,E){return g=g>>>0,E||_e(g,1,this.length),this[g]&128?(255-this[g]+1)*-1:this[g]},o.prototype.readInt16LE=function(g,E){g=g>>>0,E||_e(g,2,this.length);const v=this[g]|this[g+1]<<8;return v&32768?v|4294901760:v},o.prototype.readInt16BE=function(g,E){g=g>>>0,E||_e(g,2,this.length);const v=this[g+1]|this[g]<<8;return v&32768?v|4294901760:v},o.prototype.readInt32LE=function(g,E){return g=g>>>0,E||_e(g,4,this.length),this[g]|this[g+1]<<8|this[g+2]<<16|this[g+3]<<24},o.prototype.readInt32BE=function(g,E){return g=g>>>0,E||_e(g,4,this.length),this[g]<<24|this[g+1]<<16|this[g+2]<<8|this[g+3]},o.prototype.readBigInt64LE=rn(function(g){g=g>>>0,Bt(g,"offset");const E=this[g],v=this[g+7];(E===void 0||v===void 0)&&Tt(g,this.length-8);const I=this[g+4]+this[g+5]*2**8+this[g+6]*2**16+(v<<24);return(BigInt(I)<<BigInt(32))+BigInt(E+this[++g]*2**8+this[++g]*2**16+this[++g]*2**24)}),o.prototype.readBigInt64BE=rn(function(g){g=g>>>0,Bt(g,"offset");const E=this[g],v=this[g+7];(E===void 0||v===void 0)&&Tt(g,this.length-8);const I=(E<<24)+this[++g]*2**16+this[++g]*2**8+this[++g];return(BigInt(I)<<BigInt(32))+BigInt(this[++g]*2**24+this[++g]*2**16+this[++g]*2**8+v)}),o.prototype.readFloatLE=function(g,E){return g=g>>>0,E||_e(g,4,this.length),t.read(this,g,!0,23,4)},o.prototype.readFloatBE=function(g,E){return g=g>>>0,E||_e(g,4,this.length),t.read(this,g,!1,23,4)},o.prototype.readDoubleLE=function(g,E){return g=g>>>0,E||_e(g,8,this.length),t.read(this,g,!0,52,8)},o.prototype.readDoubleBE=function(g,E){return g=g>>>0,E||_e(g,8,this.length),t.read(this,g,!1,52,8)};function We(A,g,E,v,I,k){if(!o.isBuffer(A))throw new TypeError('"buffer" argument must be a Buffer instance');if(g>I||g<k)throw new RangeError('"value" argument is out of bounds');if(E+v>A.length)throw new RangeError("Index out of range")}o.prototype.writeUintLE=o.prototype.writeUIntLE=function(g,E,v,I){if(g=+g,E=E>>>0,v=v>>>0,!I){const Le=Math.pow(2,8*v)-1;We(this,g,E,v,Le,0)}let k=1,G=0;for(this[E]=g&255;++G<v&&(k*=256);)this[E+G]=g/k&255;return E+v},o.prototype.writeUintBE=o.prototype.writeUIntBE=function(g,E,v,I){if(g=+g,E=E>>>0,v=v>>>0,!I){const Le=Math.pow(2,8*v)-1;We(this,g,E,v,Le,0)}let k=v-1,G=1;for(this[E+k]=g&255;--k>=0&&(G*=256);)this[E+k]=g/G&255;return E+v},o.prototype.writeUint8=o.prototype.writeUInt8=function(g,E,v){return g=+g,E=E>>>0,v||We(this,g,E,1,255,0),this[E]=g&255,E+1},o.prototype.writeUint16LE=o.prototype.writeUInt16LE=function(g,E,v){return g=+g,E=E>>>0,v||We(this,g,E,2,65535,0),this[E]=g&255,this[E+1]=g>>>8,E+2},o.prototype.writeUint16BE=o.prototype.writeUInt16BE=function(g,E,v){return g=+g,E=E>>>0,v||We(this,g,E,2,65535,0),this[E]=g>>>8,this[E+1]=g&255,E+2},o.prototype.writeUint32LE=o.prototype.writeUInt32LE=function(g,E,v){return g=+g,E=E>>>0,v||We(this,g,E,4,4294967295,0),this[E+3]=g>>>24,this[E+2]=g>>>16,this[E+1]=g>>>8,this[E]=g&255,E+4},o.prototype.writeUint32BE=o.prototype.writeUInt32BE=function(g,E,v){return g=+g,E=E>>>0,v||We(this,g,E,4,4294967295,0),this[E]=g>>>24,this[E+1]=g>>>16,this[E+2]=g>>>8,this[E+3]=g&255,E+4};function F(A,g,E,v,I){wt(g,v,I,A,E,7);let k=Number(g&BigInt(4294967295));A[E++]=k,k=k>>8,A[E++]=k,k=k>>8,A[E++]=k,k=k>>8,A[E++]=k;let G=Number(g>>BigInt(32)&BigInt(4294967295));return A[E++]=G,G=G>>8,A[E++]=G,G=G>>8,A[E++]=G,G=G>>8,A[E++]=G,E}function Y(A,g,E,v,I){wt(g,v,I,A,E,7);let k=Number(g&BigInt(4294967295));A[E+7]=k,k=k>>8,A[E+6]=k,k=k>>8,A[E+5]=k,k=k>>8,A[E+4]=k;let G=Number(g>>BigInt(32)&BigInt(4294967295));return A[E+3]=G,G=G>>8,A[E+2]=G,G=G>>8,A[E+1]=G,G=G>>8,A[E]=G,E+8}o.prototype.writeBigUInt64LE=rn(function(g,E=0){return F(this,g,E,BigInt(0),BigInt("0xffffffffffffffff"))}),o.prototype.writeBigUInt64BE=rn(function(g,E=0){return Y(this,g,E,BigInt(0),BigInt("0xffffffffffffffff"))}),o.prototype.writeIntLE=function(g,E,v,I){if(g=+g,E=E>>>0,!I){const ut=Math.pow(2,8*v-1);We(this,g,E,v,ut-1,-ut)}let k=0,G=1,Le=0;for(this[E]=g&255;++k<v&&(G*=256);)g<0&&Le===0&&this[E+k-1]!==0&&(Le=1),this[E+k]=(g/G>>0)-Le&255;return E+v},o.prototype.writeIntBE=function(g,E,v,I){if(g=+g,E=E>>>0,!I){const ut=Math.pow(2,8*v-1);We(this,g,E,v,ut-1,-ut)}let k=v-1,G=1,Le=0;for(this[E+k]=g&255;--k>=0&&(G*=256);)g<0&&Le===0&&this[E+k+1]!==0&&(Le=1),this[E+k]=(g/G>>0)-Le&255;return E+v},o.prototype.writeInt8=function(g,E,v){return g=+g,E=E>>>0,v||We(this,g,E,1,127,-128),g<0&&(g=255+g+1),this[E]=g&255,E+1},o.prototype.writeInt16LE=function(g,E,v){return g=+g,E=E>>>0,v||We(this,g,E,2,32767,-32768),this[E]=g&255,this[E+1]=g>>>8,E+2},o.prototype.writeInt16BE=function(g,E,v){return g=+g,E=E>>>0,v||We(this,g,E,2,32767,-32768),this[E]=g>>>8,this[E+1]=g&255,E+2},o.prototype.writeInt32LE=function(g,E,v){return g=+g,E=E>>>0,v||We(this,g,E,4,2147483647,-2147483648),this[E]=g&255,this[E+1]=g>>>8,this[E+2]=g>>>16,this[E+3]=g>>>24,E+4},o.prototype.writeInt32BE=function(g,E,v){return g=+g,E=E>>>0,v||We(this,g,E,4,2147483647,-2147483648),g<0&&(g=4294967295+g+1),this[E]=g>>>24,this[E+1]=g>>>16,this[E+2]=g>>>8,this[E+3]=g&255,E+4},o.prototype.writeBigInt64LE=rn(function(g,E=0){return F(this,g,E,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),o.prototype.writeBigInt64BE=rn(function(g,E=0){return Y(this,g,E,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function Z(A,g,E,v,I,k){if(E+v>A.length)throw new RangeError("Index out of range");if(E<0)throw new RangeError("Index out of range")}function Ee(A,g,E,v,I){return g=+g,E=E>>>0,I||Z(A,g,E,4),t.write(A,g,E,v,23,4),E+4}o.prototype.writeFloatLE=function(g,E,v){return Ee(this,g,E,!0,v)},o.prototype.writeFloatBE=function(g,E,v){return Ee(this,g,E,!1,v)};function Oe(A,g,E,v,I){return g=+g,E=E>>>0,I||Z(A,g,E,8),t.write(A,g,E,v,52,8),E+8}o.prototype.writeDoubleLE=function(g,E,v){return Oe(this,g,E,!0,v)},o.prototype.writeDoubleBE=function(g,E,v){return Oe(this,g,E,!1,v)},o.prototype.copy=function(g,E,v,I){if(!o.isBuffer(g))throw new TypeError("argument should be a Buffer");if(v||(v=0),!I&&I!==0&&(I=this.length),E>=g.length&&(E=g.length),E||(E=0),I>0&&I<v&&(I=v),I===v||g.length===0||this.length===0)return 0;if(E<0)throw new RangeError("targetStart out of bounds");if(v<0||v>=this.length)throw new RangeError("Index out of range");if(I<0)throw new RangeError("sourceEnd out of bounds");I>this.length&&(I=this.length),g.length-E<I-v&&(I=g.length-E+v);const k=I-v;return this===g&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(E,v,I):Uint8Array.prototype.set.call(g,this.subarray(v,I),E),k},o.prototype.fill=function(g,E,v,I){if(typeof g=="string"){if(typeof E=="string"?(I=E,E=0,v=this.length):typeof v=="string"&&(I=v,v=this.length),I!==void 0&&typeof I!="string")throw new TypeError("encoding must be a string");if(typeof I=="string"&&!o.isEncoding(I))throw new TypeError("Unknown encoding: "+I);if(g.length===1){const G=g.charCodeAt(0);(I==="utf8"&&G<128||I==="latin1")&&(g=G)}}else typeof g=="number"?g=g&255:typeof g=="boolean"&&(g=Number(g));if(E<0||this.length<E||this.length<v)throw new RangeError("Out of range index");if(v<=E)return this;E=E>>>0,v=v===void 0?this.length:v>>>0,g||(g=0);let k;if(typeof g=="number")for(k=E;k<v;++k)this[k]=g;else{const G=o.isBuffer(g)?g:o.from(g,I),Le=G.length;if(Le===0)throw new TypeError('The value "'+g+'" is invalid for argument "value"');for(k=0;k<v-E;++k)this[k+E]=G[k%Le]}return this};const Me={};function xe(A,g,E){Me[A]=class extends E{constructor(){super(),Object.defineProperty(this,"message",{value:g.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${A}]`,this.stack,delete this.name}get code(){return A}set code(I){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:I,writable:!0})}toString(){return`${this.name} [${A}]: ${this.message}`}}}xe("ERR_BUFFER_OUT_OF_BOUNDS",function(A){return A?`${A} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),xe("ERR_INVALID_ARG_TYPE",function(A,g){return`The "${A}" argument must be of type number. Received type ${typeof g}`},TypeError),xe("ERR_OUT_OF_RANGE",function(A,g,E){let v=`The value of "${A}" is out of range.`,I=E;return Number.isInteger(E)&&Math.abs(E)>2**32?I=ke(String(E)):typeof E=="bigint"&&(I=String(E),(E>BigInt(2)**BigInt(32)||E<-(BigInt(2)**BigInt(32)))&&(I=ke(I)),I+="n"),v+=` It must be ${g}. Received ${I}`,v},RangeError);function ke(A){let g="",E=A.length;const v=A[0]==="-"?1:0;for(;E>=v+4;E-=3)g=`_${A.slice(E-3,E)}${g}`;return`${A.slice(0,E)}${g}`}function Ke(A,g,E){Bt(g,"offset"),(A[g]===void 0||A[g+E]===void 0)&&Tt(g,A.length-(E+1))}function wt(A,g,E,v,I,k){if(A>E||A<g){const G=typeof g=="bigint"?"n":"";let Le;throw g===0||g===BigInt(0)?Le=`>= 0${G} and < 2${G} ** ${(k+1)*8}${G}`:Le=`>= -(2${G} ** ${(k+1)*8-1}${G}) and < 2 ** ${(k+1)*8-1}${G}`,new Me.ERR_OUT_OF_RANGE("value",Le,A)}Ke(v,I,k)}function Bt(A,g){if(typeof A!="number")throw new Me.ERR_INVALID_ARG_TYPE(g,"number",A)}function Tt(A,g,E){throw Math.floor(A)!==A?(Bt(A,E),new Me.ERR_OUT_OF_RANGE("offset","an integer",A)):g<0?new Me.ERR_BUFFER_OUT_OF_BOUNDS:new Me.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${g}`,A)}const nn=/[^+/0-9A-Za-z-_]/g;function Wr(A){if(A=A.split("=")[0],A=A.trim().replace(nn,""),A.length<2)return"";for(;A.length%4!==0;)A=A+"=";return A}function Jt(A,g){g=g||1/0;let E;const v=A.length;let I=null;const k=[];for(let G=0;G<v;++G){if(E=A.charCodeAt(G),E>55295&&E<57344){if(!I){if(E>56319){(g-=3)>-1&&k.push(239,191,189);continue}else if(G+1===v){(g-=3)>-1&&k.push(239,191,189);continue}I=E;continue}if(E<56320){(g-=3)>-1&&k.push(239,191,189),I=E;continue}E=(I-55296<<10|E-56320)+65536}else I&&(g-=3)>-1&&k.push(239,191,189);if(I=null,E<128){if((g-=1)<0)break;k.push(E)}else if(E<2048){if((g-=2)<0)break;k.push(E>>6|192,E&63|128)}else if(E<65536){if((g-=3)<0)break;k.push(E>>12|224,E>>6&63|128,E&63|128)}else if(E<1114112){if((g-=4)<0)break;k.push(E>>18|240,E>>12&63|128,E>>6&63|128,E&63|128)}else throw new Error("Invalid code point")}return k}function Oi(A){const g=[];for(let E=0;E<A.length;++E)g.push(A.charCodeAt(E)&255);return g}function X(A,g){let E,v,I;const k=[];for(let G=0;G<A.length&&!((g-=2)<0);++G)E=A.charCodeAt(G),v=E>>8,I=E%256,k.push(I),k.push(v);return k}function ir(A){return e.toByteArray(Wr(A))}function Ut(A,g,E,v){let I;for(I=0;I<v&&!(I+E>=g.length||I>=A.length);++I)g[I+E]=A[I];return I}function Wt(A,g){return A instanceof g||A!=null&&A.constructor!=null&&A.constructor.name!=null&&A.constructor.name===g.name}function Qr(A){return A!==A}const Nc=function(){const A="0123456789abcdef",g=new Array(256);for(let E=0;E<16;++E){const v=E*16;for(let I=0;I<16;++I)g[v+I]=A[E]+A[I]}return g}();function rn(A){return typeof BigInt>"u"?Cc:A}function Cc(){throw new Error("BigInt not supported")}})(Yo);class Xe{static getGlobalVariable(){return typeof window<"u"?window:typeof globalThis<"u"?globalThis:global}static load(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: require("${e}").`);return""}static pathNormalize(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: path.normalize("${e}").`);return""}static pathExtname(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: path.extname("${e}").`);return""}static pathResolve(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: path.resolve("${e}").`);return""}static fileExist(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: fs.existsSync("${e}").`);return!1}static dotenv(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: dotenv.config({ path: "${e}" }).`)}static getEnvVariable(e){}static readFileSync(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: fs.readFileSync("${e}").`);return null}static appendFileSync(e,t){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: fs.appendFileSync("${e}").`)}static writeFile(e,t){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: fs.writeFile("${e}").`);return Promise.reject(null)}static highlightSql(e){return e}static logInfo(e,t){console.info(e+" ",t)}static logError(e,t){console.error(e+" ",t)}static logWarn(e,t){console.warn(e+" ",t)}static log(e){console.log(e)}static warn(e){return e}}Xe.type="browser";typeof window<"u"&&(window.Buffer=Yo.Buffer);typeof globalThis<"u"&&(globalThis.Buffer=Yo.Buffer);typeof global<"u"&&typeof require<"u"&&(global.Buffer=require("buffer/").Buffer);class ny{async all(){throw new Error("Cannot read connection options in a browser context.")}async get(){throw new Error("Cannot read connection options in a browser context.")}async has(){throw new Error("Cannot read connection options in a browser context.")}}class Re{static isObject(e){return e!==null&&typeof e=="object"}static isObjectWithName(e){return e!==null&&typeof e=="object"&&e.name!==void 0}static assign(e,...t){for(const n of t)for(const r of Object.getOwnPropertyNames(n))e[r]=n[r]}static mixedListToArray(e){return e!==null&&typeof e=="object"?Object.keys(e).map(t=>e[t]):e}}class x extends Error{get name(){return this.constructor.name}constructor(e){super(e),Object.setPrototypeOf?Object.setPrototypeOf(this,new.target.prototype):this.__proto__=new.target.prototype}}class m0 extends x{constructor(e){super(`Cannot create a new connection named "${e}", because connection with such name already exist and it now has an active connection session.`)}}class ro extends x{constructor(e){super(`Internal error. Subject ${e.metadata.targetName} must have an identifier to perform operation.`)}}class y0 extends x{constructor(e){super(`Cannot create a "${e}" connection because connection to the database already established.`)}}class Gi extends x{constructor(){super("Locking not supported on given driver.")}}class g0 extends x{constructor(e,t){super();const n=e.primaryColumns.reduce((r,i,a)=>(i.setEntityValue(r,a+1),r),{});this.message=`Cannot use given entity id "${t}" because "${e.targetName}" contains multiple primary columns, you must provide object in following form: ${JSON.stringify(n)} as an id.`}}class E0 extends x{constructor(e){super(`Cannot ${e}, given value must be instance of entity class, instead object literal is given. Or you must specify an entity target to method call.`)}}class ml extends x{constructor(){super('Cannot perform update query because update values are not defined. Call "qb.set(...)" method to specify updated values.')}}class w0 extends x{constructor(e){super(`Tree repositories are not supported in ${e.options.type} driver.`)}}class ry extends x{constructor(e){super(`Custom repository ${typeof e=="function"?e.name:e.constructor.name} was not found. Did you forgot to put @EntityRepository decorator on it?`)}}class In extends x{constructor(){super("Transaction is not started yet, start transaction before committing or rolling it back.")}}class b0 extends x{constructor(){super("Transaction already started for the given connection, commit current transaction before starting a new one.")}}class B{static isMssqlParameter(e){return this.check(e,"MssqlParameter")}static isEntityMetadata(e){return this.check(e,"EntityMetadata")}static isColumnMetadata(e){return this.check(e,"ColumnMetadata")}static isSelectQueryBuilder(e){return this.check(e,"SelectQueryBuilder")}static isInsertQueryBuilder(e){return this.check(e,"InsertQueryBuilder")}static isDeleteQueryBuilder(e){return this.check(e,"DeleteQueryBuilder")}static isUpdateQueryBuilder(e){return this.check(e,"UpdateQueryBuilder")}static isSoftDeleteQueryBuilder(e){return this.check(e,"SoftDeleteQueryBuilder")}static isRelationQueryBuilder(e){return this.check(e,"RelationQueryBuilder")}static isBrackets(e){return this.check(e,"Brackets")||this.check(e,"NotBrackets")}static isNotBrackets(e){return this.check(e,"NotBrackets")}static isSubject(e){return this.check(e,"Subject")}static isRdbmsSchemaBuilder(e){return this.check(e,"RdbmsSchemaBuilder")}static isMongoEntityManager(e){return this.check(e,"MongoEntityManager")}static isSqljsEntityManager(e){return this.check(e,"SqljsEntityManager")}static isEntitySchema(e){return this.check(e,"EntitySchema")}static isBaseEntityConstructor(e){return typeof e=="function"&&typeof e.hasId=="function"&&typeof e.save=="function"&&typeof e.useDataSource=="function"}static isFindOperator(e){return this.check(e,"FindOperator")||this.check(e,"EqualOperator")}static isEqualOperator(e){return this.check(e,"EqualOperator")}static isQuery(e){return this.check(e,"Query")}static isTable(e){return this.check(e,"Table")}static isTableCheck(e){return this.check(e,"TableCheck")}static isTableColumn(e){return this.check(e,"TableColumn")}static isTableExclusion(e){return this.check(e,"TableExclusion")}static isTableForeignKey(e){return this.check(e,"TableForeignKey")}static isTableIndex(e){return this.check(e,"TableIndex")}static isTableUnique(e){return this.check(e,"TableUnique")}static isView(e){return this.check(e,"View")}static isDataSource(e){return this.check(e,"DataSource")}static check(e,t){return typeof e=="object"&&e!==null&&e["@instanceof"]===Symbol.for(t)}}class yl extends x{constructor(e,t){super(),this.entityClass=e,this.criteria=t,this.message=`Could not find any entity of type "${this.stringifyTarget(e)}" matching: ${this.stringifyCriteria(t)}`}stringifyTarget(e){return B.isEntitySchema(e)?e.options.name:typeof e=="function"||Re.isObject(e)&&"name"in e?e.name:e}stringifyCriteria(e){try{return JSON.stringify(e,null,4)}catch{}return""+e}}class T0 extends x{constructor(e){super(),this.message=`No metadata for "${this.stringifyTarget(e)}" was found.`}stringifyTarget(e){return B.isEntitySchema(e)?e.options.name:typeof e=="function"||Re.isObject(e)&&"name"in e?e.name:e}}class S0 extends x{constructor(e,t){super(`Cannot ${e}, given value must be an entity, instead "${t}" is given.`)}}class wp extends x{constructor(e,t,n){super(`The optimistic lock on entity ${e} failed, version ${t} was expected, but is actually ${n}.`)}}class iy extends x{constructor(){super("Your database does not support LIMIT on UPDATE statements.")}}class A0 extends x{constructor(e){super(`Custom entity repository ${typeof e=="function"?e.name:e.constructor.name}  cannot inherit Repository class without entity being set in the @EntityRepository decorator.`)}}class sy extends x{constructor(){super("Database connection provided by a query runner was already released, cannot continue to use its querying methods anymore.")}}class bp extends x{constructor(e){super(`Cannot attach entity "${e}" to its parent. Please make sure parent is saved in the database before saving children nodes.`)}}class Wu extends x{constructor(e){super(`Custom repository ${typeof e=="function"?e.name:e.constructor.name} does not have managed entity. Did you forget to specify entity for it @EntityRepository(MyEntity)? `)}}class N0 extends x{constructor(e){super(`Entity "${e.name}" does not have delete date columns.`)}}class C0 extends x{constructor(e){super(`Circular relations detected: ${e}. To resolve this issue you need to set nullable: true somewhere in this dependency structure.`)}}class zo extends x{constructor(){super("OUTPUT or RETURNING clause only supported by PostgreSQL, MariaDB, Microsoft SqlServer or Google Spanner.")}}class v0 extends x{constructor(e){super(`Entity "${e.name}" does not have a primary column. Primary column is required to have in all your entities. Use @PrimaryColumn decorator to add a primary column to your entity.`)}}class Gn extends x{constructor(e,t){super(e),Object.setPrototypeOf(this,Gn.prototype),this.message=`Property "${e}" was not found in "${t.targetName}". Make sure your query is correct.`}}class R0 extends x{constructor(e,t=[]){super(`Wrong driver: "${e}" given. Supported drivers are: ${t.map(n=>`"${n}"`).join(", ")}.`)}}class ds extends x{constructor(e,t){super(`${e} package has not been found installed. Please run "npm install ${t}".`)}}class _0 extends x{constructor(e){super(`Connection "${e}" was not found.`)}}class x0 extends x{constructor(e){super(`Entity ${e} does not have version or update date columns.`)}}class M0 extends x{constructor(){super('Cannot perform insert query because values are not defined. Call "qb.values(...)" method to specify inserted values.')}}class Us extends x{constructor(){super("The optimistic lock can be used only with getOne() method.")}}class P0 extends x{constructor(e){super(`Driver option (${e}) is not set. Please set it to perform connection to the database.`)}}class O0 extends x{constructor(e){super(),e.length===1?this.message=`Relation "${e[0]}" was not found; please check if it is correct and really exists in your entity.`:this.message=`Relations ${e.map(t=>`"${t}"`).join(", ")} were not found; please check if relations are correct and they exist in your entities.`}}class D0 extends x{constructor(){super("An open transaction is required for pessimistic lock.")}}class I0 extends x{constructor(e,t,n){super();const r=typeof t=="string"?t:t.name;this.message=`Data type "${r}" in "${e.entityMetadata.targetName}.${e.propertyName}" is not supported by "${n}" database.`}}class $0 extends x{constructor(e){super(`Array initializations are not allowed in entity relations. Please remove array initialization (= []) from "${e.entityMetadata.targetName}#${e.propertyPath}". This is ORM requirement to make relations to work properly. Refer docs for more information.`)}}class Kn extends x{constructor(e,t,n){if(super(n.toString().replace(/^error: /,"").replace(/^Error: /,"").replace(/^Request/,"")),this.query=e,this.parameters=t,this.driverError=n,n){const{name:r,...i}=n;Re.assign(this,{...i})}}}class L0 extends x{constructor(){super("Entity manager is not using single database connection and cannot be released. Only entity managers created by connection#createEntityManagerWithSingleDatabaseConnection methods have a single database connection and they should be released.")}}class q0 extends x{constructor(e){super(`Removed entity "${e.metadata.name}" is also scheduled for update operation. Make sure you are not updating and removing same object (note that update or remove may be executed by cascade operations).`)}}class zt extends x{constructor(){super("Query runner already released. Cannot run queries anymore.")}}class B0 extends x{constructor(){super("RDBMS does not support OFFSET without LIMIT in SELECT statements. You must use limit in conjunction with offset function (or take in conjunction with skip function if you are using pagination).")}}class Fs extends x{constructor(e){super(`Cannot execute operation on "${e}" connection because connection is not yet established.`)}}class U0 extends x{constructor(e){super(`Option "${e}" is not set in your connection options, please define "${e}" option in your connection options or ormconfig.json`)}}class F0 extends x{constructor(e){const t=e.map(n=>`"${n.name}"`);super(`Migrations ${t.join(", ")} override the transaction mode, but the global transaction mode is "all"`)}}class Tp{constructor(e){Re.assign(this,e||{})}get target(){return this.metadata.target}get hasMetadata(){return!!this._metadata}set metadata(e){this._metadata=e}get metadata(){if(!this._metadata)throw new x(`Cannot get entity metadata for the given alias "${this.name}"`);return this._metadata}}class hr{static isAliasProperty(e){if(typeof e!="string"||e.indexOf(".")===-1)return!1;const[t,n]=e.split(".");return!(!t||!n||e.indexOf("(")!==-1||e.indexOf(")")!==-1)}}var ay={exports:{}},gl={exports:{}};typeof Object.create=="function"?gl.exports=function(e,t){t&&(e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}))}:gl.exports=function(e,t){if(t){e.super_=t;var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e}};var xi=gl.exports,El={exports:{}};/*! safe-buffer. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */(function(s,e){var t=Yo,n=t.Buffer;function r(a,o){for(var l in a)o[l]=a[l]}n.from&&n.alloc&&n.allocUnsafe&&n.allocUnsafeSlow?s.exports=t:(r(t,e),e.Buffer=i);function i(a,o,l){return n(a,o,l)}i.prototype=Object.create(n.prototype),r(n,i),i.from=function(a,o,l){if(typeof a=="number")throw new TypeError("Argument must not be a number");return n(a,o,l)},i.alloc=function(a,o,l){if(typeof a!="number")throw new TypeError("Argument must be a number");var h=n(a);return o!==void 0?typeof l=="string"?h.fill(o,l):h.fill(o):h.fill(0),h},i.allocUnsafe=function(a){if(typeof a!="number")throw new TypeError("Argument must be a number");return n(a)},i.allocUnsafeSlow=function(a){if(typeof a!="number")throw new TypeError("Argument must be a number");return t.SlowBuffer(a)}})(El,El.exports);var ui=El.exports,k0={}.toString,j0=Array.isArray||function(s){return k0.call(s)=="[object Array]"},oy=Function.prototype.toString,Zi=typeof Reflect=="object"&&Reflect!==null&&Reflect.apply,wl,go;if(typeof Zi=="function"&&typeof Object.defineProperty=="function")try{wl=Object.defineProperty({},"length",{get:function(){throw go}}),go={},Zi(function(){throw 42},null,wl)}catch(s){s!==go&&(Zi=null)}else Zi=null;var W0=/^\s*class\b/,bl=function(e){try{var t=oy.call(e);return W0.test(t)}catch{return!1}},Qu=function(e){try{return bl(e)?!1:(oy.call(e),!0)}catch{return!1}},Eo=Object.prototype.toString,Q0="[object Object]",V0="[object Function]",H0="[object GeneratorFunction]",Y0="[object HTMLAllCollection]",G0="[object HTML document.all class]",z0="[object HTMLCollection]",K0=typeof Symbol=="function"&&!!Symbol.toStringTag,J0=!(0 in[,]),Tl=function(){return!1};if(typeof document=="object"){var X0=document.all;Eo.call(X0)===Eo.call(document.all)&&(Tl=function(e){if((J0||!e)&&(typeof e>"u"||typeof e=="object"))try{var t=Eo.call(e);return(t===Y0||t===G0||t===z0||t===Q0)&&e("")==null}catch{}return!1})}var Z0=Zi?function(e){if(Tl(e))return!0;if(!e||typeof e!="function"&&typeof e!="object")return!1;try{Zi(e,null,wl)}catch(t){if(t!==go)return!1}return!bl(e)&&Qu(e)}:function(e){if(Tl(e))return!0;if(!e||typeof e!="function"&&typeof e!="object")return!1;if(K0)return Qu(e);if(bl(e))return!1;var t=Eo.call(e);return t!==V0&&t!==H0&&!/^\[object HTML/.test(t)?!1:Qu(e)},eR=Z0,tR=Object.prototype.toString,cy=Object.prototype.hasOwnProperty,nR=function(e,t,n){for(var r=0,i=e.length;r<i;r++)cy.call(e,r)&&(n==null?t(e[r],r,e):t.call(n,e[r],r,e))},rR=function(e,t,n){for(var r=0,i=e.length;r<i;r++)n==null?t(e.charAt(r),r,e):t.call(n,e.charAt(r),r,e)},iR=function(e,t,n){for(var r in e)cy.call(e,r)&&(n==null?t(e[r],r,e):t.call(n,e[r],r,e))};function sR(s){return tR.call(s)==="[object Array]"}var aR=function(e,t,n){if(!eR(t))throw new TypeError("iterator must be a function");var r;arguments.length>=3&&(r=n),sR(e)?nR(e,t,r):typeof e=="string"?rR(e,t,r):iR(e,t,r)},oR=["Float16Array","Float32Array","Float64Array","Int8Array","Int16Array","Int32Array","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","BigInt64Array","BigUint64Array"],Vu=oR,cR=typeof globalThis>"u"?bi:globalThis,uR=function(){for(var e=[],t=0;t<Vu.length;t++)typeof cR[Vu[t]]=="function"&&(e[e.length]=Vu[t]);return e},uy={exports:{}},Sp=Hl,lR=KC,zi=Wo,Ap=Qo,hR=function(e,t,n){if(!e||typeof e!="object"&&typeof e!="function")throw new zi("`obj` must be an object or a function`");if(typeof t!="string"&&typeof t!="symbol")throw new zi("`property` must be a string or a symbol`");if(arguments.length>3&&typeof arguments[3]!="boolean"&&arguments[3]!==null)throw new zi("`nonEnumerable`, if provided, must be a boolean or null");if(arguments.length>4&&typeof arguments[4]!="boolean"&&arguments[4]!==null)throw new zi("`nonWritable`, if provided, must be a boolean or null");if(arguments.length>5&&typeof arguments[5]!="boolean"&&arguments[5]!==null)throw new zi("`nonConfigurable`, if provided, must be a boolean or null");if(arguments.length>6&&typeof arguments[6]!="boolean")throw new zi("`loose`, if provided, must be a boolean");var r=arguments.length>3?arguments[3]:null,i=arguments.length>4?arguments[4]:null,a=arguments.length>5?arguments[5]:null,o=arguments.length>6?arguments[6]:!1,l=!!Ap&&Ap(e,t);if(Sp)Sp(e,t,{configurable:a===null&&l?l.configurable:!a,enumerable:r===null&&l?l.enumerable:!r,value:n,writable:i===null&&l?l.writable:!i});else if(o||!r&&!i&&!a)e[t]=n;else throw new lR("This environment does not support defining a property as non-configurable, non-writable, or non-enumerable.")},Sl=Hl,ly=function(){return!!Sl};ly.hasArrayLengthDefineBug=function(){if(!Sl)return null;try{return Sl([],"length",{value:1}).length!==1}catch{return!0}};var dR=ly,fR=JC,Np=hR,pR=dR(),Cp=Qo,vp=Wo,mR=fR("%Math.floor%"),yR=function(e,t){if(typeof e!="function")throw new vp("`fn` is not a function");if(typeof t!="number"||t<0||t>4294967295||mR(t)!==t)throw new vp("`length` must be a positive 32-bit integer");var n=arguments.length>2&&!!arguments[2],r=!0,i=!0;if("length"in e&&Cp){var a=Cp(e,"length");a&&!a.configurable&&(r=!1),a&&!a.writable&&(i=!1)}return(r||i||!n)&&(pR?Np(e,"length",t,!0,!0):Np(e,"length",t)),e},gR=XC(),ER=ZC(),wR=ev,bR=function(){return wR(gR,ER,arguments)};(function(s){var e=yR,t=Hl,n=tv,r=bR;s.exports=function(a){var o=n(arguments),l=a.length-(arguments.length-1);return e(o,1+(l>0?l:0),!0)},t?t(s.exports,"apply",{value:r}):s.exports.apply=r})(uy);var TR=uy.exports,SR=nv(),Ko=function(){return SR()&&!!Symbol.toStringTag},Mo=aR,AR=uR,Rp=TR,Zl=ls,wo=Qo,io=Fm(),NR=Zl("Object.prototype.toString"),hy=Ko(),_p=typeof globalThis>"u"?bi:globalThis,Al=AR(),eh=Zl("String.prototype.slice"),CR=Zl("Array.prototype.indexOf",!0)||function(e,t){for(var n=0;n<e.length;n+=1)if(e[n]===t)return n;return-1},Po={__proto__:null};hy&&wo&&io?Mo(Al,function(s){var e=new _p[s];if(Symbol.toStringTag in e&&io){var t=io(e),n=wo(t,Symbol.toStringTag);if(!n&&t){var r=io(t);n=wo(r,Symbol.toStringTag)}Po["$"+s]=Rp(n.get)}}):Mo(Al,function(s){var e=new _p[s],t=e.slice||e.set;t&&(Po["$"+s]=Rp(t))});var vR=function(e){var t=!1;return Mo(Po,function(n,r){if(!t)try{"$"+n(e)===r&&(t=eh(r,1))}catch{}}),t},RR=function(e){var t=!1;return Mo(Po,function(n,r){if(!t)try{n(e),t=eh(r,1)}catch{}}),t},dy=function(e){if(!e||typeof e!="object")return!1;if(!hy){var t=eh(NR(e),8,-1);return CR(Al,t)>-1?t:t!=="Object"?!1:RR(e)}return wo?vR(e):null},_R=dy,fy=function(e){return!!_R(e)},xR=Wo,MR=ls,PR=MR("TypedArray.prototype.buffer",!0),OR=fy,DR=PR||function(e){if(!OR(e))throw new xR("Not a Typed Array");return e.buffer},Qn=ui.Buffer,IR=j0,$R=DR,LR=ArrayBuffer.isView||function(e){try{return $R(e),!0}catch{return!1}},qR=typeof Uint8Array<"u",py=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u",BR=py&&(Qn.prototype instanceof Uint8Array||Qn.TYPED_ARRAY_SUPPORT),UR=function(e,t){if(Qn.isBuffer(e))return e.constructor&&!("isBuffer"in e)?Qn.from(e):e;if(typeof e=="string")return Qn.from(e,t);if(py&&LR(e)){if(e.byteLength===0)return Qn.alloc(0);if(BR){var n=Qn.from(e.buffer,e.byteOffset,e.byteLength);if(n.byteLength===e.byteLength)return n}var r=e instanceof Uint8Array?e:new Uint8Array(e.buffer,e.byteOffset,e.byteLength),i=Qn.from(r);if(i.length===e.byteLength)return i}if(qR&&e instanceof Uint8Array)return Qn.from(e);var a=IR(e);if(a)for(var o=0;o<e.length;o+=1){var l=e[o];if(typeof l!="number"||l<0||l>255||~~l!==l)throw new RangeError("Array items must be numbers in the range 0-255.")}if(a||Qn.isBuffer(e)&&e.constructor&&typeof e.constructor.isBuffer=="function"&&e.constructor.isBuffer(e))return Qn.from(e);throw new TypeError('The "data" argument must be a string, an Array, a Buffer, a Uint8Array, or a DataView.')},FR=ui.Buffer,kR=UR;function Jo(s,e){this._block=FR.alloc(s),this._finalSize=e,this._blockSize=s,this._len=0}Jo.prototype.update=function(s,e){s=kR(s,e||"utf8");for(var t=this._block,n=this._blockSize,r=s.length,i=this._len,a=0;a<r;){for(var o=i%n,l=Math.min(r-a,n-o),h=0;h<l;h++)t[o+h]=s[a+h];i+=l,a+=l,i%n===0&&this._update(t)}return this._len+=r,this};Jo.prototype.digest=function(s){var e=this._len%this._blockSize;this._block[e]=128,this._block.fill(0,e+1),e>=this._finalSize&&(this._update(this._block),this._block.fill(0));var t=this._len*8;if(t<=4294967295)this._block.writeUInt32BE(t,this._blockSize-4);else{var n=(t&4294967295)>>>0,r=(t-n)/4294967296;this._block.writeUInt32BE(r,this._blockSize-8),this._block.writeUInt32BE(n,this._blockSize-4)}this._update(this._block);var i=this._hash();return s?i.toString(s):i};Jo.prototype._update=function(){throw new Error("_update must be implemented by subclass")};var fs=Jo,jR=xi,my=fs,WR=ui.Buffer,QR=[1518500249,1859775393,-1894007588,-899497514],VR=new Array(80);function ta(){this.init(),this._w=VR,my.call(this,64,56)}jR(ta,my);ta.prototype.init=function(){return this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878,this._e=3285377520,this};function HR(s){return s<<5|s>>>27}function YR(s){return s<<30|s>>>2}function GR(s,e,t,n){return s===0?e&t|~e&n:s===2?e&t|e&n|t&n:e^t^n}ta.prototype._update=function(s){for(var e=this._w,t=this._a|0,n=this._b|0,r=this._c|0,i=this._d|0,a=this._e|0,o=0;o<16;++o)e[o]=s.readInt32BE(o*4);for(;o<80;++o)e[o]=e[o-3]^e[o-8]^e[o-14]^e[o-16];for(var l=0;l<80;++l){var h=~~(l/20),d=HR(t)+GR(h,n,r,i)+a+e[l]+QR[h]|0;a=i,i=r,r=YR(n),n=t,t=d}this._a=t+this._a|0,this._b=n+this._b|0,this._c=r+this._c|0,this._d=i+this._d|0,this._e=a+this._e|0};ta.prototype._hash=function(){var s=WR.allocUnsafe(20);return s.writeInt32BE(this._a|0,0),s.writeInt32BE(this._b|0,4),s.writeInt32BE(this._c|0,8),s.writeInt32BE(this._d|0,12),s.writeInt32BE(this._e|0,16),s};var zR=ta,KR=xi,yy=fs,JR=ui.Buffer,XR=[1518500249,1859775393,-1894007588,-899497514],ZR=new Array(80);function na(){this.init(),this._w=ZR,yy.call(this,64,56)}KR(na,yy);na.prototype.init=function(){return this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878,this._e=3285377520,this};function e_(s){return s<<1|s>>>31}function t_(s){return s<<5|s>>>27}function n_(s){return s<<30|s>>>2}function r_(s,e,t,n){return s===0?e&t|~e&n:s===2?e&t|e&n|t&n:e^t^n}na.prototype._update=function(s){for(var e=this._w,t=this._a|0,n=this._b|0,r=this._c|0,i=this._d|0,a=this._e|0,o=0;o<16;++o)e[o]=s.readInt32BE(o*4);for(;o<80;++o)e[o]=e_(e[o-3]^e[o-8]^e[o-14]^e[o-16]);for(var l=0;l<80;++l){var h=~~(l/20),d=t_(t)+r_(h,n,r,i)+a+e[l]+XR[h]|0;a=i,i=r,r=n_(n),n=t,t=d}this._a=t+this._a|0,this._b=n+this._b|0,this._c=r+this._c|0,this._d=i+this._d|0,this._e=a+this._e|0};na.prototype._hash=function(){var s=JR.allocUnsafe(20);return s.writeInt32BE(this._a|0,0),s.writeInt32BE(this._b|0,4),s.writeInt32BE(this._c|0,8),s.writeInt32BE(this._d|0,12),s.writeInt32BE(this._e|0,16),s};var i_=na,s_=xi,gy=fs,a_=ui.Buffer,o_=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],c_=new Array(64);function ra(){this.init(),this._w=c_,gy.call(this,64,56)}s_(ra,gy);ra.prototype.init=function(){return this._a=1779033703,this._b=3144134277,this._c=1013904242,this._d=2773480762,this._e=1359893119,this._f=2600822924,this._g=528734635,this._h=1541459225,this};function u_(s,e,t){return t^s&(e^t)}function l_(s,e,t){return s&e|t&(s|e)}function h_(s){return(s>>>2|s<<30)^(s>>>13|s<<19)^(s>>>22|s<<10)}function d_(s){return(s>>>6|s<<26)^(s>>>11|s<<21)^(s>>>25|s<<7)}function f_(s){return(s>>>7|s<<25)^(s>>>18|s<<14)^s>>>3}function p_(s){return(s>>>17|s<<15)^(s>>>19|s<<13)^s>>>10}ra.prototype._update=function(s){for(var e=this._w,t=this._a|0,n=this._b|0,r=this._c|0,i=this._d|0,a=this._e|0,o=this._f|0,l=this._g|0,h=this._h|0,d=0;d<16;++d)e[d]=s.readInt32BE(d*4);for(;d<64;++d)e[d]=p_(e[d-2])+e[d-7]+f_(e[d-15])+e[d-16]|0;for(var p=0;p<64;++p){var m=h+d_(a)+u_(a,o,l)+o_[p]+e[p]|0,w=h_(t)+l_(t,n,r)|0;h=l,l=o,o=a,a=i+m|0,i=r,r=n,n=t,t=m+w|0}this._a=t+this._a|0,this._b=n+this._b|0,this._c=r+this._c|0,this._d=i+this._d|0,this._e=a+this._e|0,this._f=o+this._f|0,this._g=l+this._g|0,this._h=h+this._h|0};ra.prototype._hash=function(){var s=a_.allocUnsafe(32);return s.writeInt32BE(this._a,0),s.writeInt32BE(this._b,4),s.writeInt32BE(this._c,8),s.writeInt32BE(this._d,12),s.writeInt32BE(this._e,16),s.writeInt32BE(this._f,20),s.writeInt32BE(this._g,24),s.writeInt32BE(this._h,28),s};var Ey=ra,m_=xi,y_=Ey,g_=fs,E_=ui.Buffer,w_=new Array(64);function Xo(){this.init(),this._w=w_,g_.call(this,64,56)}m_(Xo,y_);Xo.prototype.init=function(){return this._a=3238371032,this._b=914150663,this._c=812702999,this._d=4144912697,this._e=4290775857,this._f=1750603025,this._g=1694076839,this._h=3204075428,this};Xo.prototype._hash=function(){var s=E_.allocUnsafe(28);return s.writeInt32BE(this._a,0),s.writeInt32BE(this._b,4),s.writeInt32BE(this._c,8),s.writeInt32BE(this._d,12),s.writeInt32BE(this._e,16),s.writeInt32BE(this._f,20),s.writeInt32BE(this._g,24),s};var b_=Xo,T_=xi,wy=fs,S_=ui.Buffer,xp=[1116352408,3609767458,1899447441,602891725,3049323471,3964484399,3921009573,2173295548,961987163,4081628472,1508970993,3053834265,2453635748,2937671579,2870763221,3664609560,3624381080,2734883394,310598401,1164996542,607225278,1323610764,1426881987,3590304994,1925078388,4068182383,2162078206,991336113,2614888103,633803317,3248222580,3479774868,3835390401,2666613458,4022224774,944711139,264347078,2341262773,604807628,2007800933,770255983,1495990901,1249150122,1856431235,1555081692,3175218132,1996064986,2198950837,2554220882,3999719339,2821834349,766784016,2952996808,2566594879,3210313671,3203337956,3336571891,1034457026,3584528711,2466948901,113926993,3758326383,338241895,168717936,666307205,1188179964,773529912,1546045734,1294757372,1522805485,1396182291,2643833823,1695183700,2343527390,1986661051,1014477480,2177026350,1206759142,2456956037,344077627,2730485921,1290863460,2820302411,3158454273,3259730800,3505952657,3345764771,106217008,3516065817,3606008344,3600352804,1432725776,4094571909,1467031594,275423344,851169720,430227734,3100823752,506948616,1363258195,659060556,3750685593,883997877,3785050280,958139571,3318307427,1322822218,3812723403,1537002063,2003034995,1747873779,3602036899,1955562222,1575990012,2024104815,1125592928,2227730452,2716904306,2361852424,442776044,2428436474,593698344,2756734187,3733110249,3204031479,2999351573,3329325298,3815920427,3391569614,3928383900,3515267271,566280711,3940187606,3454069534,4118630271,4000239992,116418474,1914138554,174292421,2731055270,289380356,3203993006,460393269,320620315,685471733,587496836,852142971,1086792851,1017036298,365543100,1126000580,2618297676,1288033470,3409855158,1501505948,4234509866,1607167915,987167468,1816402316,1246189591],A_=new Array(160);function ia(){this.init(),this._w=A_,wy.call(this,128,112)}T_(ia,wy);ia.prototype.init=function(){return this._ah=1779033703,this._bh=3144134277,this._ch=1013904242,this._dh=2773480762,this._eh=1359893119,this._fh=2600822924,this._gh=528734635,this._hh=1541459225,this._al=4089235720,this._bl=2227873595,this._cl=4271175723,this._dl=1595750129,this._el=2917565137,this._fl=725511199,this._gl=4215389547,this._hl=327033209,this};function Mp(s,e,t){return t^s&(e^t)}function Pp(s,e,t){return s&e|t&(s|e)}function Op(s,e){return(s>>>28|e<<4)^(e>>>2|s<<30)^(e>>>7|s<<25)}function Dp(s,e){return(s>>>14|e<<18)^(s>>>18|e<<14)^(e>>>9|s<<23)}function N_(s,e){return(s>>>1|e<<31)^(s>>>8|e<<24)^s>>>7}function C_(s,e){return(s>>>1|e<<31)^(s>>>8|e<<24)^(s>>>7|e<<25)}function v_(s,e){return(s>>>19|e<<13)^(e>>>29|s<<3)^s>>>6}function R_(s,e){return(s>>>19|e<<13)^(e>>>29|s<<3)^(s>>>6|e<<26)}function qt(s,e){return s>>>0<e>>>0?1:0}ia.prototype._update=function(s){for(var e=this._w,t=this._ah|0,n=this._bh|0,r=this._ch|0,i=this._dh|0,a=this._eh|0,o=this._fh|0,l=this._gh|0,h=this._hh|0,d=this._al|0,p=this._bl|0,m=this._cl|0,w=this._dl|0,b=this._el|0,S=this._fl|0,R=this._gl|0,$=this._hl|0,q=0;q<32;q+=2)e[q]=s.readInt32BE(q*4),e[q+1]=s.readInt32BE(q*4+4);for(;q<160;q+=2){var O=e[q-30],J=e[q-15*2+1],ne=N_(O,J),ge=C_(J,O);O=e[q-2*2],J=e[q-2*2+1];var pe=v_(O,J),me=R_(J,O),V=e[q-7*2],Ae=e[q-7*2+1],D=e[q-16*2],ae=e[q-16*2+1],Q=ge+Ae|0,te=ne+V+qt(Q,ge)|0;Q=Q+me|0,te=te+pe+qt(Q,me)|0,Q=Q+ae|0,te=te+D+qt(Q,ae)|0,e[q]=te,e[q+1]=Q}for(var ce=0;ce<160;ce+=2){te=e[ce],Q=e[ce+1];var fe=Pp(t,n,r),oe=Pp(d,p,m),ye=Op(t,d),Ge=Op(d,t),ze=Dp(a,b),_e=Dp(b,a),We=xp[ce],F=xp[ce+1],Y=Mp(a,o,l),Z=Mp(b,S,R),Ee=$+_e|0,Oe=h+ze+qt(Ee,$)|0;Ee=Ee+Z|0,Oe=Oe+Y+qt(Ee,Z)|0,Ee=Ee+F|0,Oe=Oe+We+qt(Ee,F)|0,Ee=Ee+Q|0,Oe=Oe+te+qt(Ee,Q)|0;var Me=Ge+oe|0,xe=ye+fe+qt(Me,Ge)|0;h=l,$=R,l=o,R=S,o=a,S=b,b=w+Ee|0,a=i+Oe+qt(b,w)|0,i=r,w=m,r=n,m=p,n=t,p=d,d=Ee+Me|0,t=Oe+xe+qt(d,Ee)|0}this._al=this._al+d|0,this._bl=this._bl+p|0,this._cl=this._cl+m|0,this._dl=this._dl+w|0,this._el=this._el+b|0,this._fl=this._fl+S|0,this._gl=this._gl+R|0,this._hl=this._hl+$|0,this._ah=this._ah+t+qt(this._al,d)|0,this._bh=this._bh+n+qt(this._bl,p)|0,this._ch=this._ch+r+qt(this._cl,m)|0,this._dh=this._dh+i+qt(this._dl,w)|0,this._eh=this._eh+a+qt(this._el,b)|0,this._fh=this._fh+o+qt(this._fl,S)|0,this._gh=this._gh+l+qt(this._gl,R)|0,this._hh=this._hh+h+qt(this._hl,$)|0};ia.prototype._hash=function(){var s=S_.allocUnsafe(64);function e(t,n,r){s.writeInt32BE(t,r),s.writeInt32BE(n,r+4)}return e(this._ah,this._al,0),e(this._bh,this._bl,8),e(this._ch,this._cl,16),e(this._dh,this._dl,24),e(this._eh,this._el,32),e(this._fh,this._fl,40),e(this._gh,this._gl,48),e(this._hh,this._hl,56),s};var by=ia,__=xi,x_=by,M_=fs,P_=ui.Buffer,O_=new Array(160);function Zo(){this.init(),this._w=O_,M_.call(this,128,112)}__(Zo,x_);Zo.prototype.init=function(){return this._ah=3418070365,this._bh=1654270250,this._ch=2438529370,this._dh=355462360,this._eh=1731405415,this._fh=2394180231,this._gh=3675008525,this._hh=1203062813,this._al=3238371032,this._bl=914150663,this._cl=812702999,this._dl=4144912697,this._el=4290775857,this._fl=1750603025,this._gl=1694076839,this._hl=3204075428,this};Zo.prototype._hash=function(){var s=P_.allocUnsafe(48);function e(t,n,r){s.writeInt32BE(t,r),s.writeInt32BE(n,r+4)}return e(this._ah,this._al,0),e(this._bh,this._bl,8),e(this._ch,this._cl,16),e(this._dh,this._dl,24),e(this._eh,this._el,32),e(this._fh,this._fl,40),s};var D_=Zo;(function(s){s.exports=function(t){var n=t.toLowerCase(),r=s.exports[n];if(!r)throw new Error(n+" is not supported (we accept pull requests)");return new r},s.exports.sha=zR,s.exports.sha1=i_,s.exports.sha224=b_,s.exports.sha256=Ey,s.exports.sha384=D_,s.exports.sha512=by})(ay);var I_=ay.exports;const $_=Um(I_);function Hu(s,e=!1){return e&&(s=" "+s),s.replace(/^([A-Z])|[\s-_](\w)/g,function(t,n,r){return r?r.toUpperCase():n.toLowerCase()})}function Ip(s){return s.replace(/([A-Z])([A-Z])([a-z])/g,"$1_$2$3").replace(/([a-z0-9])([A-Z])/g,"$1_$2").toLowerCase()}function L_(s){return s.replace(/\w\S*/g,e=>e.charAt(0).toUpperCase()+e.substr(1).toLowerCase())}function Ty(s,e={}){const{segmentLength:t=4,separator:n="__",termLength:r=2}=e;return s.split(n).reduce((o,l)=>{const h=l.replace(/([a-z\xE0-\xFF])([A-Z\xC0-\xDF])/g,"$1 $2").split(" "),d=h.length>1?r:t,p=h.map(m=>m.substr(0,d)).join("");return o.push(p),o},[]).join(n)}function q_(s,e={}){const t=$_("sha1");t.update(s,"utf8");const n=t.digest("hex");return e.length&&e.length>0?n.slice(0,e.length):n}class B_{static isGreaterOrEqual(e,t){if(!e)return!1;const n=$p(e),r=$p(t);for(let i=0;i<n.length&&i<r.length;i++){if(n[i]>r[i])return!0;if(n[i]<r[i])return!1}return!0}}function $p(s){return s.split(".").map(e=>parseInt(e,10))}class ie{static isSQLiteFamily(e){return["sqlite","cordova","react-native","nativescript","sqljs","expo","better-sqlite3","capacitor"].includes(e.options.type)}static isMySQLFamily(e){return["mysql","mariadb"].includes(e.options.type)}static isReleaseVersionOrGreater(e,t){return B_.isGreaterOrEqual(e.version,t)}static isPostgresFamily(e){return["postgres","aurora-postgres","cockroachdb"].includes(e.options.type)}static buildDriverOptions(e,t){if(e.url){const n=this.parseConnectionUrl(e.url);t&&t.useSid&&n.database&&(n.sid=n.database);for(const r of Object.keys(n))typeof n[r]>"u"&&delete n[r];return Object.assign({},e,n)}return Object.assign({},e)}static buildMongoDBDriverOptions(e,t){if(e.url){const n=this.parseMongoDBConnectionUrl(e.url);t&&t.useSid&&n.database&&(n.sid=n.database);for(const r of Object.keys(n))typeof n[r]>"u"&&delete n[r];return Object.assign({},e,n)}return Object.assign({},e)}static buildAlias({maxAliasLength:e},t,...n){const r=t&&t.joiner?t.joiner:"_",i=n.length===1?n[0]:n.join(r);if(e&&e>0&&i.length>e){if(t&&t.shorten===!0){const a=Ty(i);if(a.length<e)return a}return q_(i,{length:e})}return i}static buildColumnAlias({maxAliasLength:e},t,...n){return typeof t=="string"?(n.unshift(t),t={shorten:!1,joiner:"_"}):t=Object.assign({shorten:!1,joiner:"_"},t),this.buildAlias({maxAliasLength:e},t,...n)}static parseConnectionUrl(e){const t=e.split(":")[0],n=e.indexOf("//"),r=e.substr(n+2),i=r.indexOf("/"),a=i!==-1?r.substr(0,i):r;let o=i!==-1?r.substr(i+1):void 0;o&&o.indexOf("?")!==-1&&(o=o.substr(0,o.indexOf("?")));const l=a.lastIndexOf("@"),h=a.substr(0,l),d=a.substr(l+1);let p=h,m="";const w=h.indexOf(":");w!==-1&&(p=h.substr(0,w),m=h.substr(w+1));const[b,S]=d.split(":");return{type:t,host:b,username:decodeURIComponent(p),password:decodeURIComponent(m),port:S?parseInt(S):void 0,database:o||void 0}}static parseMongoDBConnectionUrl(e){const t=e.split(":")[0],n=e.indexOf("//"),r=e.substr(n+2),i=r.indexOf("/"),a=i!==-1?r.substr(0,i):r;let o=i!==-1?r.substr(i+1):void 0,l="",h,d,p,m;const w={};if(o&&o.indexOf("?")!==-1){l=o.substr(o.indexOf("?")+1,o.length);const ne=l.split("&");let ge,pe;ne.forEach(me=>{ge=me.split("=")[0],pe=me.split("=")[1],w[ge]=pe}),m=w.replicaSet,o=o.substr(0,o.indexOf("?"))}const b=a.lastIndexOf("@"),S=a.substr(0,b),R=a.substr(b+1);let $=S,q="";const O=S.indexOf(":");O!==-1&&($=S.substr(0,O),q=S.substr(O+1)),m?p=R:[h,d]=R.split(":");const J={type:t,host:h,hostReplicaSet:p,username:decodeURIComponent($),password:decodeURIComponent(q),port:d?parseInt(d):void 0,database:o||void 0};for(const[ne,ge]of Object.entries(w))J[ne]=ge;return J}}class Sy{constructor(e,t,n){this.connection=e,this.queryExpressionMap=t,this.isSelectedEvaluated=!1,this.relationEvaluated=!1,n&&Re.assign(this,n)}get isMany(){return this.isMappingMany!==void 0?this.isMappingMany:this.relation?this.relation.isManyToMany||this.relation.isOneToMany:!1}get isSelected(){if(!this.isSelectedEvaluated){const e=()=>{for(const t of this.queryExpressionMap.selects)if(t.selection===this.alias.name||this.metadata&&this.metadata.columns.find(n=>t.selection===this.alias.name+"."+n.propertyPath))return!0;return!1};this.isSelectedCache=e(),this.isSelectedEvaluated=!0}return this.isSelectedCache}get tablePath(){return this.metadata?this.metadata.tablePath:this.entityOrProperty}get parentAlias(){if(hr.isAliasProperty(this.entityOrProperty))return this.entityOrProperty.substr(0,this.entityOrProperty.indexOf("."))}get relationPropertyPath(){if(hr.isAliasProperty(this.entityOrProperty))return this.entityOrProperty.substr(this.entityOrProperty.indexOf(".")+1)}get relation(){if(!this.relationEvaluated){const e=()=>{if(!hr.isAliasProperty(this.entityOrProperty))return;const t=this.queryExpressionMap.findAliasByName(this.parentAlias);let n=t.metadata.findRelationWithPropertyPath(this.relationPropertyPath);if(n||t.metadata.parentEntityMetadata&&(n=t.metadata.parentEntityMetadata.findRelationWithPropertyPath(this.relationPropertyPath),n))return n;throw new x(`Relation with property path ${this.relationPropertyPath} in entity was not found.`)};this.relationCache=e.bind(this)(),this.relationEvaluated=!0}return this.relationCache}get metadata(){if(this.relation)return this.relation.inverseEntityMetadata;if(this.connection.hasMetadata(this.entityOrProperty))return this.connection.getMetadata(this.entityOrProperty);if(this.mapAsEntity&&this.connection.hasMetadata(this.mapAsEntity))return this.connection.getMetadata(this.mapAsEntity)}get junctionAlias(){if(!this.relation)throw new x("Cannot get junction table for join without relation.");if(typeof this.entityOrProperty!="string")throw new x("Junction property is not defined.");const e=this.entityOrProperty.substr(0,this.entityOrProperty.indexOf("."));return this.relation.isOwning?ie.buildAlias(this.connection.driver,void 0,e,this.alias.name):ie.buildAlias(this.connection.driver,void 0,this.alias.name,e)}get mapToPropertyParentAlias(){if(this.mapToProperty)return this.mapToProperty.split(".")[0]}get mapToPropertyPropertyName(){if(this.mapToProperty)return this.mapToProperty.split(".")[1]}}class th{constructor(e,t){this.queryExpressionMap=e,this.disableMixedMap=!1,Re.assign(this,t||{})}get joinInverseSideMetadata(){return this.relation.inverseEntityMetadata}get parentAlias(){if(!hr.isAliasProperty(this.relationName))throw new x("Given value must be a string representation of alias property");return this.relationName.substr(0,this.relationName.indexOf("."))}get relationPropertyPath(){if(!hr.isAliasProperty(this.relationName))throw new x("Given value must be a string representation of alias property");return this.relationName.substr(this.relationName.indexOf(".")+1)}get relation(){if(!hr.isAliasProperty(this.relationName))throw new x("Given value must be a string representation of alias property");const t=this.queryExpressionMap.findAliasByName(this.parentAlias).metadata.findRelationWithPropertyPath(this.relationPropertyPath);if(!t)throw new x(`Relation with property path ${this.relationPropertyPath} in entity was not found.`);return t}get junctionAlias(){const[e,t]=this.relationName.split(".");return e+"_"+t+"_rid"}get junctionMetadata(){return this.relation.junctionEntityMetadata}get mapToPropertyParentAlias(){return this.mapToProperty.substr(0,this.mapToProperty.indexOf("."))}get mapToPropertyPropertyPath(){return this.mapToProperty.substr(this.mapToProperty.indexOf(".")+1)}}class nh{constructor(e,t){this.expressionMap=e,Re.assign(this,t||{})}get joinInverseSideMetadata(){return this.relation.inverseEntityMetadata}get parentAlias(){if(!hr.isAliasProperty(this.relationName))throw new x("Given value must be a string representation of alias property");return this.relationName.split(".")[0]}get relationProperty(){if(!hr.isAliasProperty(this.relationName))throw new x("Given value is a string representation of alias property");return this.relationName.split(".")[1]}get junctionAlias(){const[e,t]=this.relationName.split(".");return e+"_"+t+"_rc"}get relation(){if(!hr.isAliasProperty(this.relationName))throw new x("Given value is a string representation of alias property");const[e,t]=this.relationName.split("."),r=this.expressionMap.findAliasByName(e).metadata.findRelationWithPropertyPath(t);if(!r)throw new x(`Relation with property path ${t} in entity was not found.`);return r}get metadata(){if(!hr.isAliasProperty(this.relationName))throw new x("Given value is a string representation of alias property");const e=this.relationName.split(".")[0];return this.expressionMap.findAliasByName(e).metadata}get mapToPropertyPropertyName(){return this.mapToProperty.split(".")[1]}}class rh{constructor(e){var t;this.connection=e,this.relationLoadStrategy="join",this.queryEntity=!1,this.aliases=[],this.queryType="select",this.selects=[],this.maxExecutionTime=0,this.selectDistinct=!1,this.selectDistinctOn=[],this.extraReturningColumns=[],this.onConflict="",this.onIgnore=!1,this.joinAttributes=[],this.relationIdAttributes=[],this.relationCountAttributes=[],this.wheres=[],this.havings=[],this.orderBys={},this.groupBys=[],this.withDeleted=!1,this.parameters={},this.disableEscaping=!0,this.enableRelationIdValues=!1,this.extraAppendedAndWhereCondition="",this.subQuery=!1,this.aliasNamePrefixingEnabled=!0,this.options=[],this.insertColumns=[],this.whereEntities=[],this.updateEntity=!0,this.callListeners=!0,this.useTransaction=!1,this.nativeParameters={},this.locallyGenerated={},this.commonTableExpressions=[],e.options.relationLoadStrategy&&(this.relationLoadStrategy=e.options.relationLoadStrategy),this.timeTravel=((t=e.options)==null?void 0:t.timeTravelQueries)||!1}get allOrderBys(){if(!Object.keys(this.orderBys).length&&this.mainAlias.hasMetadata&&this.options.indexOf("disable-global-order")===-1){const e=this.mainAlias.metadata.orderBy||{};return Object.keys(e).reduce((t,n)=>(t[this.mainAlias.name+"."+n]=e[n],t),{})}return this.orderBys}setMainAlias(e){return this.mainAlias=e,e}createAlias(e){let t=e.name;!t&&e.tablePath&&(t=e.tablePath),!t&&typeof e.target=="function"&&(t=e.target.name),!t&&typeof e.target=="string"&&(t=e.target);const n=new Tp;return n.type=e.type,t&&(n.name=t),e.metadata&&(n.metadata=e.metadata),e.target&&!n.hasMetadata&&(n.metadata=this.connection.getMetadata(e.target)),e.tablePath&&(n.tablePath=e.tablePath),e.subQuery&&(n.subQuery=e.subQuery),this.aliases.push(n),n}findAliasByName(e){const t=this.aliases.find(n=>n.name===e);if(!t)throw new x(`"${e}" alias was not found. Maybe you forgot to join it?`);return t}findColumnByAliasExpression(e){const[t,n]=e.split(".");return this.findAliasByName(t).metadata.findColumnWithPropertyName(n)}get relationMetadata(){if(!this.mainAlias)throw new x("Entity to work with is not specified!");const e=this.mainAlias.metadata.findRelationWithPropertyPath(this.relationPropertyPath);if(!e)throw new x(`Relation ${this.relationPropertyPath} was not found in entity ${this.mainAlias.name}`);return e}clone(){const e=new rh(this.connection);return e.queryType=this.queryType,e.selects=this.selects.map(t=>t),e.maxExecutionTime=this.maxExecutionTime,e.selectDistinct=this.selectDistinct,e.selectDistinctOn=this.selectDistinctOn,this.aliases.forEach(t=>e.aliases.push(new Tp(t))),e.relationLoadStrategy=this.relationLoadStrategy,e.mainAlias=this.mainAlias,e.valuesSet=this.valuesSet,e.returning=this.returning,e.onConflict=this.onConflict,e.onIgnore=this.onIgnore,e.onUpdate=this.onUpdate,e.joinAttributes=this.joinAttributes.map(t=>new Sy(this.connection,this,t)),e.relationIdAttributes=this.relationIdAttributes.map(t=>new th(this,t)),e.relationCountAttributes=this.relationCountAttributes.map(t=>new nh(this,t)),e.wheres=this.wheres.map(t=>({...t})),e.havings=this.havings.map(t=>({...t})),e.orderBys=Object.assign({},this.orderBys),e.groupBys=this.groupBys.map(t=>t),e.limit=this.limit,e.offset=this.offset,e.skip=this.skip,e.take=this.take,e.useIndex=this.useIndex,e.lockMode=this.lockMode,e.onLocked=this.onLocked,e.lockVersion=this.lockVersion,e.lockTables=this.lockTables,e.withDeleted=this.withDeleted,e.parameters=Object.assign({},this.parameters),e.disableEscaping=this.disableEscaping,e.enableRelationIdValues=this.enableRelationIdValues,e.extraAppendedAndWhereCondition=this.extraAppendedAndWhereCondition,e.subQuery=this.subQuery,e.aliasNamePrefixingEnabled=this.aliasNamePrefixingEnabled,e.cache=this.cache,e.cacheId=this.cacheId,e.cacheDuration=this.cacheDuration,e.relationPropertyPath=this.relationPropertyPath,e.of=this.of,e.insertColumns=this.insertColumns,e.whereEntities=this.whereEntities,e.updateEntity=this.updateEntity,e.callListeners=this.callListeners,e.useTransaction=this.useTransaction,e.timeTravel=this.timeTravel,e.nativeParameters=Object.assign({},this.nativeParameters),e.comment=this.comment,e.commonTableExpressions=this.commonTableExpressions.map(t=>({alias:t.alias,queryBuilder:typeof t.queryBuilder=="string"?t.queryBuilder:t.queryBuilder.clone(),options:t.options})),e}}class Oo{constructor(e){this["@instanceof"]=Symbol.for("Brackets"),this.whereFactory=e}}class It{static transformFrom(e,t){return Array.isArray(e)?e.slice().reverse().reduce((r,i)=>i.from(r),t):e.from(t)}static transformTo(e,t){return Array.isArray(e)?e.reduce((n,r)=>r.to(n),t):e.to(t)}}class ps{constructor(e,t,n=!0,r=!1,i,a){this["@instanceof"]=Symbol.for("FindOperator"),this._type=e,this._value=t,this._useParameter=n,this._multipleParameters=r,this._getSql=i,this._objectLiteralParameters=a}get useParameter(){return B.isFindOperator(this._value)?this._value.useParameter:this._useParameter}get multipleParameters(){return B.isFindOperator(this._value)?this._value.multipleParameters:this._multipleParameters}get type(){return this._type}get value(){return B.isFindOperator(this._value)?this._value.value:this._value}get objectLiteralParameters(){return B.isFindOperator(this._value)?this._value.objectLiteralParameters:this._objectLiteralParameters}get child(){if(B.isFindOperator(this._value))return this._value}get getSql(){return B.isFindOperator(this._value)?this._value.getSql:this._getSql}transformValue(e){this._value instanceof ps?this._value.transformValue(e):this._value=Array.isArray(this._value)&&this._multipleParameters?this._value.map(t=>e&&It.transformTo(e,t)):It.transformTo(e,this._value)}}function U_(s){return new ps("in",s,!0,!0)}const F_=/[.*+\-?^${}()|[\]\\]/g,k_=s=>s.replace(F_,"\\$&");class Nt{constructor(e,t){this["@instanceof"]=Symbol.for("QueryBuilder"),this.parameterIndex=0,B.isDataSource(e)?(this.connection=e,this.queryRunner=t,this.expressionMap=new rh(this.connection)):(this.connection=e.connection,this.queryRunner=e.queryRunner,this.expressionMap=e.expressionMap.clone())}static registerQueryBuilderClass(e,t){Nt.queryBuilderRegistry[e]=t}get alias(){if(!this.expressionMap.mainAlias)throw new x("Main alias is not set");return this.expressionMap.mainAlias.name}select(e,t){return this.expressionMap.queryType="select",Array.isArray(e)?this.expressionMap.selects=e.map(n=>({selection:n})):e&&(this.expressionMap.selects=[{selection:e,aliasName:t}]),B.isSelectQueryBuilder(this)?this:Nt.queryBuilderRegistry.SelectQueryBuilder(this)}insert(){return this.expressionMap.queryType="insert",B.isInsertQueryBuilder(this)?this:Nt.queryBuilderRegistry.InsertQueryBuilder(this)}update(e,t){const n=t||e;if(e=B.isEntitySchema(e)?e.options.name:e,typeof e=="function"||typeof e=="string"){const r=this.createFromAlias(e);this.expressionMap.setMainAlias(r)}return this.expressionMap.queryType="update",this.expressionMap.valuesSet=n,B.isUpdateQueryBuilder(this)?this:Nt.queryBuilderRegistry.UpdateQueryBuilder(this)}delete(){return this.expressionMap.queryType="delete",B.isDeleteQueryBuilder(this)?this:Nt.queryBuilderRegistry.DeleteQueryBuilder(this)}softDelete(){return this.expressionMap.queryType="soft-delete",B.isSoftDeleteQueryBuilder(this)?this:Nt.queryBuilderRegistry.SoftDeleteQueryBuilder(this)}restore(){return this.expressionMap.queryType="restore",B.isSoftDeleteQueryBuilder(this)?this:Nt.queryBuilderRegistry.SoftDeleteQueryBuilder(this)}relation(e,t){const n=arguments.length===2?e:void 0,r=arguments.length===2?t:e;if(this.expressionMap.queryType="relation",this.expressionMap.relationPropertyPath=r,n){const i=this.createFromAlias(n);this.expressionMap.setMainAlias(i)}return B.isRelationQueryBuilder(this)?this:Nt.queryBuilderRegistry.RelationQueryBuilder(this)}hasRelation(e,t){const n=this.connection.getMetadata(e);return(Array.isArray(t)?t:[t]).every(i=>!!n.findRelationWithPropertyPath(i))}hasParameter(e){var t;return((t=this.parentQueryBuilder)==null?void 0:t.hasParameter(e))||e in this.expressionMap.parameters}setParameter(e,t){if(typeof t=="function")throw new x(`Function parameter isn't supported in the parameters. Please check "${e}" parameter.`);if(!e.match(/^([A-Za-z0-9_.]+)$/))throw new x("QueryBuilder parameter keys may only contain numbers, letters, underscores, or periods.");return this.parentQueryBuilder&&this.parentQueryBuilder.setParameter(e,t),this.expressionMap.parameters[e]=t,this}setParameters(e){for(const[t,n]of Object.entries(e))this.setParameter(t,n);return this}createParameter(e){let t;do t=`orm_param_${this.parameterIndex++}`;while(this.hasParameter(t));return this.setParameter(t,e),`:${t}`}setNativeParameters(e){return this.parentQueryBuilder&&this.parentQueryBuilder.setNativeParameters(e),Object.keys(e).forEach(t=>{this.expressionMap.nativeParameters[t]=e[t]}),this}getParameters(){const e=Object.assign({},this.expressionMap.parameters);if(this.expressionMap.mainAlias&&this.expressionMap.mainAlias.hasMetadata){const t=this.expressionMap.mainAlias.metadata;if(t.discriminatorColumn&&t.parentEntityMetadata){const n=t.childEntityMetadatas.filter(r=>r.discriminatorColumn).map(r=>r.discriminatorValue);n.push(t.discriminatorValue),e.discriminatorColumnValues=n}}return e}printSql(){const[e,t]=this.getQueryAndParameters();return this.connection.logger.logQuery(e,t),this}getSql(){return this.getQueryAndParameters()[0]}getQueryAndParameters(){const e=this.getQuery(),t=this.getParameters();return this.connection.driver.escapeQueryWithParameters(e,t,this.expressionMap.nativeParameters)}async execute(){const[e,t]=this.getQueryAndParameters(),n=this.obtainQueryRunner();try{return await n.query(e,t)}finally{n!==this.queryRunner&&await n.release()}}createQueryBuilder(e){return new this.constructor(this.connection,e??this.queryRunner)}clone(){return new this.constructor(this)}comment(e){return this.expressionMap.comment=e,this}disableEscaping(){return this.expressionMap.disableEscaping=!1,this}escape(e){return this.expressionMap.disableEscaping?this.connection.driver.escape(e):e}setQueryRunner(e){return this.queryRunner=e,this}callListeners(e){return this.expressionMap.callListeners=e,this}useTransaction(e){return this.expressionMap.useTransaction=e,this}addCommonTableExpression(e,t,n){return this.expressionMap.commonTableExpressions.push({queryBuilder:e,alias:t,options:n||{}}),this}getTableName(e){return e.split(".").map(t=>t===""?t:this.escape(t)).join(".")}getMainTableName(){if(!this.expressionMap.mainAlias)throw new x('Entity where values should be inserted is not specified. Call "qb.into(entity)" method to specify it.');return this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata.tablePath:this.expressionMap.mainAlias.tablePath}createFromAlias(e,t){if(this.connection.hasMetadata(e)){const n=this.connection.getMetadata(e);return this.expressionMap.createAlias({type:"from",name:t,metadata:this.connection.getMetadata(e),tablePath:n.tablePath})}else{if(typeof e=="string"){const i=e.substr(0,1)==="("&&e.substr(-1)===")";return this.expressionMap.createAlias({type:"from",name:t,tablePath:i?void 0:e,subQuery:i?e:void 0})}const n=e(this.subQuery());this.setParameters(n.getParameters());const r=n.getQuery();return this.expressionMap.createAlias({type:"from",name:t,subQuery:r})}}replacePropertyNames(e){return e}replacePropertyNamesForTheWholeQuery(e){const t={};for(const i of this.expressionMap.aliases){if(!i.hasMetadata)continue;const a=this.expressionMap.aliasNamePrefixingEnabled&&i.name?`${i.name}.`:"";t[a]||(t[a]={});for(const o of i.metadata.relations)o.joinColumns.length>0&&(t[a][o.propertyPath]=o.joinColumns[0].databaseName);for(const o of i.metadata.relations){const l=[...o.joinColumns,...o.inverseJoinColumns];for(const h of l){const d=`${o.propertyPath}.${h.referencedColumn.propertyPath}`;t[a][d]=h.databaseName}}for(const o of i.metadata.columns)t[a][o.databaseName]=o.databaseName;for(const o of i.metadata.columns)t[a][o.propertyName]=o.databaseName;for(const o of i.metadata.columns)t[a][o.propertyPath]=o.databaseName}const n=Object.keys(t),r=n.map(i=>k_(i)).join("|");return n.length>0&&(e=e.replace(new RegExp(`([ =(]|^.{0})${r?"("+r+")":""}([^ =(),]+)(?=[ =),]|.{0}$)`,"gm"),(...i)=>{let a,o,l;if(r){if(a=i[0],o=i[1],l=i[3],t[i[2]][l])return`${o}${this.escape(i[2].substring(0,i[2].length-1))}.${this.escape(t[i[2]][l])}`}else if(a=i[0],o=i[1],l=i[2],t[""][l])return`${o}${this.escape(t[""][l])}`;return a})),e}createComment(){return this.expressionMap.comment?`/* ${this.expressionMap.comment.replace(/\*\//g,"")} */ `:""}createTimeTravelQuery(){return this.expressionMap.queryType==="select"&&this.expressionMap.timeTravel?` AS OF SYSTEM TIME ${this.expressionMap.timeTravel}`:""}createWhereExpression(){const e=[],t=this.createWhereClausesExpression(this.expressionMap.wheres);if(t.length>0&&t!=="1=1"&&e.push(this.replacePropertyNames(t)),this.expressionMap.mainAlias.hasMetadata){const r=this.expressionMap.mainAlias.metadata;if(this.expressionMap.queryType==="select"&&!this.expressionMap.withDeleted&&r.deleteDateColumn){const i=this.expressionMap.aliasNamePrefixingEnabled?this.expressionMap.mainAlias.name+"."+r.deleteDateColumn.propertyName:r.deleteDateColumn.propertyName,a=`${this.replacePropertyNames(i)} IS NULL`;e.push(a)}if(r.discriminatorColumn&&r.parentEntityMetadata){const i=this.expressionMap.aliasNamePrefixingEnabled?this.expressionMap.mainAlias.name+"."+r.discriminatorColumn.databaseName:r.discriminatorColumn.databaseName,a=`${this.replacePropertyNames(i)} IN (:...discriminatorColumnValues)`;e.push(a)}}if(this.expressionMap.extraAppendedAndWhereCondition){const r=this.replacePropertyNames(this.expressionMap.extraAppendedAndWhereCondition);e.push(r)}let n="";return n+=this.createTimeTravelQuery(),e.length?e.length===1?n+=` WHERE ${e[0]}`:n+=` WHERE ( ${e.join(" ) AND ( ")} )`:n+="",n}createReturningExpression(e){const t=this.getReturningColumns(),n=this.connection.driver;if(typeof this.expressionMap.returning!="string"&&this.expressionMap.extraReturningColumns.length>0&&n.isReturningSqlSupported(e)&&t.push(...this.expressionMap.extraReturningColumns.filter(r=>t.indexOf(r)===-1)),t.length){let r=t.map(i=>{const a=this.escape(i.databaseName);return n.options.type==="mssql"?this.expressionMap.queryType==="insert"||this.expressionMap.queryType==="update"||this.expressionMap.queryType==="soft-delete"||this.expressionMap.queryType==="restore"?"INSERTED."+a:this.escape(this.getMainTableName())+"."+a:a}).join(", ");return n.options.type==="oracle"&&(r+=" INTO "+t.map(i=>this.createParameter({type:n.columnTypeToNativeParameter(i.type),dir:n.oracle.BIND_OUT})).join(", ")),n.options.type==="mssql"&&(this.expressionMap.queryType==="insert"||this.expressionMap.queryType==="update")&&(r+=" INTO @OutputTable"),r}else if(typeof this.expressionMap.returning=="string")return this.expressionMap.returning;return""}getReturningColumns(){const e=[];return Array.isArray(this.expressionMap.returning)&&this.expressionMap.returning.forEach(t=>{this.expressionMap.mainAlias.hasMetadata&&e.push(...this.expressionMap.mainAlias.metadata.findColumnsWithPropertyPath(t))}),e}createWhereClausesExpression(e){return e.map((t,n)=>{const r=this.createWhereConditionExpression(t.condition);switch(t.type){case"and":return(n>0?"AND ":"")+`${this.connection.options.isolateWhereStatements?"(":""}${r}${this.connection.options.isolateWhereStatements?")":""}`;case"or":return(n>0?"OR ":"")+`${this.connection.options.isolateWhereStatements?"(":""}${r}${this.connection.options.isolateWhereStatements?")":""}`}return r}).join(" ").trim()}createWhereConditionExpression(e,t=!1){if(typeof e=="string")return e;if(Array.isArray(e))return e.length===0?"1=1":e.length===1&&!t?this.createWhereClausesExpression(e):"("+this.createWhereClausesExpression(e)+")";const{driver:n}=this.connection;switch(e.operator){case"lessThan":return`${e.parameters[0]} < ${e.parameters[1]}`;case"lessThanOrEqual":return`${e.parameters[0]} <= ${e.parameters[1]}`;case"arrayContains":return`${e.parameters[0]} @> ${e.parameters[1]}`;case"jsonContains":return`${e.parameters[0]} ::jsonb @> ${e.parameters[1]}`;case"arrayContainedBy":return`${e.parameters[0]} <@ ${e.parameters[1]}`;case"arrayOverlap":return`${e.parameters[0]} && ${e.parameters[1]}`;case"moreThan":return`${e.parameters[0]} > ${e.parameters[1]}`;case"moreThanOrEqual":return`${e.parameters[0]} >= ${e.parameters[1]}`;case"notEqual":return`${e.parameters[0]} != ${e.parameters[1]}`;case"equal":return`${e.parameters[0]} = ${e.parameters[1]}`;case"ilike":return n.options.type==="postgres"||n.options.type==="cockroachdb"?`${e.parameters[0]} ILIKE ${e.parameters[1]}`:`UPPER(${e.parameters[0]}) LIKE UPPER(${e.parameters[1]})`;case"like":return`${e.parameters[0]} LIKE ${e.parameters[1]}`;case"between":return`${e.parameters[0]} BETWEEN ${e.parameters[1]} AND ${e.parameters[2]}`;case"in":return e.parameters.length<=1?"0=1":`${e.parameters[0]} IN (${e.parameters.slice(1).join(", ")})`;case"any":return n.options.type==="cockroachdb"?`${e.parameters[0]}::STRING = ANY(${e.parameters[1]}::STRING[])`:`${e.parameters[0]} = ANY(${e.parameters[1]})`;case"isNull":return`${e.parameters[0]} IS NULL`;case"not":return`NOT(${this.createWhereConditionExpression(e.condition)})`;case"brackets":return`${this.createWhereConditionExpression(e.condition,!0)}`;case"and":return"("+e.parameters.join(" AND ")+")";case"or":return"("+e.parameters.join(" OR ")+")"}throw new TypeError(`Unsupported FindOperator ${ps.constructor.name}`)}createCteExpression(){if(!this.hasCommonTableExpressions())return"";const e=this.connection.driver.cteCapabilities.requiresRecursiveHint;return"WITH "+this.expressionMap.commonTableExpressions.map(n=>{let r=typeof n.queryBuilder=="string"?n.queryBuilder:"";if(typeof n.queryBuilder!="string"){if(n.queryBuilder.hasCommonTableExpressions())throw new x(`Nested CTEs aren't supported (CTE: ${n.alias})`);if(r=n.queryBuilder.getQuery(),!this.connection.driver.cteCapabilities.writable&&!B.isSelectQueryBuilder(n.queryBuilder))throw new x(`Only select queries are supported in CTEs in ${this.connection.options.type} (CTE: ${n.alias})`);this.setParameters(n.queryBuilder.getParameters())}let i=this.escape(n.alias);if(n.options.columnNames){const l=n.options.columnNames.map(h=>this.escape(h));if(B.isSelectQueryBuilder(n.queryBuilder)&&n.queryBuilder.expressionMap.selects.length&&n.options.columnNames.length!==n.queryBuilder.expressionMap.selects.length)throw new x(`cte.options.columnNames length (${n.options.columnNames.length}) doesn't match subquery select list length ${n.queryBuilder.expressionMap.selects.length} (CTE: ${n.alias})`);i+=`(${l.join(", ")})`}const a=n.options.recursive&&e?"RECURSIVE":"";let o="";return this.connection.driver.cteCapabilities.materializedHint&&n.options.materialized!==void 0&&(o=n.options.materialized?"MATERIALIZED":"NOT MATERIALIZED"),[a,i,"AS",o,`(${r})`].filter(Boolean).join(" ")}).join(", ")+" "}getWhereInIdsCondition(e){const t=this.expressionMap.mainAlias.metadata,n=(Array.isArray(e)?e:[e]).map(r=>t.ensureEntityIdMap(r));if(!t.hasMultiplePrimaryKeys){const r=t.primaryColumns[0];if(!r.transformer&&!r.relationMetadata&&!r.embeddedMetadata)return{[r.propertyName]:U_(n.map(i=>r.getEntityValue(i,!1)))}}return new Oo(r=>{for(const i of n)r.orWhere(new Oo(a=>a.where(i)))})}getExistsCondition(e){const t=e.clone().orderBy().groupBy().offset(void 0).limit(void 0).skip(void 0).take(void 0).select("1").setOption("disable-global-order");return[`EXISTS (${t.getQuery()})`,t.getParameters()]}findColumnsForPropertyPath(e){let t=this.expressionMap.mainAlias;const n=[],r=e.split(".");for(;r.length>1;){const o=r[0];if(!(t!=null&&t.hasMetadata))break;if(t.metadata.hasEmbeddedWithPropertyPath(o)){r.unshift(`${r.shift()}.${r.shift()}`);continue}if(t.metadata.hasRelationWithPropertyPath(o)){const l=this.expressionMap.joinAttributes.find(h=>h.relationPropertyPath===o);if(!(l!=null&&l.alias)){const h=n.length>0?`${n.join(".")}.${o}`:o;throw new Error(`Cannot find alias for relation at ${h}`)}t=l.alias,n.push(...o.split(".")),r.shift();continue}break}if(!t)throw new Error(`Cannot find alias for property ${e}`);const i=r.join("."),a=t.metadata.findColumnsWithPropertyPath(i);if(!a.length)throw new Gn(e,t.metadata);return[t,n,a]}createPropertyPath(e,t,n=""){const r=[];for(const i of Object.keys(t)){const a=n?`${n}.${i}`:i;if(t[i]===null||typeof t[i]!="object"||B.isFindOperator(t[i])){r.push(a);continue}if(e.hasEmbeddedWithPropertyPath(a)){const o=this.createPropertyPath(e,t[i],a);r.push(...o);continue}if(e.hasRelationWithPropertyPath(a)){const o=e.findRelationWithPropertyPath(a);if(o.relationType==="one-to-one"||o.relationType==="many-to-one"){const p=o.joinColumns.map(w=>w.referencedColumn).filter(w=>!!w);if(p.length>0&&p.every(w=>w.getEntityValue(t[i],!1))){r.push(a);continue}}if(o.relationType==="one-to-many"||o.relationType==="many-to-many")throw new Error(`Cannot query across ${o.relationType} for property ${a}`);const l=o.inverseEntityMetadata.primaryColumns;if(l.length>0&&l.every(p=>p.getEntityValue(t[i],!1))){const p=l.map(m=>`${a}.${m.propertyPath}`);r.push(...p);continue}const d=this.createPropertyPath(o.inverseEntityMetadata,t[i]).map(p=>`${a}.${p}`);r.push(...d);continue}r.push(a)}return r}*getPredicates(e){if(this.expressionMap.mainAlias.hasMetadata){const t=this.createPropertyPath(this.expressionMap.mainAlias.metadata,e);for(const n of t){const[r,i,a]=this.findColumnsForPropertyPath(n);for(const o of a){let l=e;for(const p of i){if(!l||!(p in l)){l={};break}l=l[p]}const h=this.expressionMap.aliasNamePrefixingEnabled?`${r.name}.${o.propertyPath}`:o.propertyPath,d=o.getEntityValue(l,!0);yield[h,d]}}}else for(const t of Object.keys(e)){const n=e[t];yield[this.expressionMap.aliasNamePrefixingEnabled?`${this.alias}.${t}`:t,n]}}getWherePredicateCondition(e,t){var n,r;if(B.isFindOperator(t)){const i=[];if(t.useParameter)if(t.objectLiteralParameters)this.setParameters(t.objectLiteralParameters);else if(t.multipleParameters)for(const a of t.value)i.push(this.createParameter(a));else i.push(this.createParameter(t.value));if(t.type==="raw")return t.getSql?t.getSql(e):{operator:"equal",parameters:[e,t.value]};if(t.type==="not")return t.child?{operator:t.type,condition:this.getWherePredicateCondition(e,t.child)}:{operator:"notEqual",parameters:[e,...i]};if(t.type==="and"){const a=t.value;return{operator:t.type,parameters:a.map(o=>this.createWhereConditionExpression(this.getWherePredicateCondition(e,o)))}}else if(t.type==="or"){const a=t.value;return{operator:t.type,parameters:a.map(o=>this.createWhereConditionExpression(this.getWherePredicateCondition(e,o)))}}else return{operator:t.type,parameters:[e,...i]}}else if(t===null){const i=((n=this.connection.options.invalidWhereValuesBehavior)==null?void 0:n.null)||"ignore";if(i==="sql-null")return{operator:"isNull",parameters:[e]};if(i==="throw")throw new x(`Null value encountered in property '${e}' of a where condition. To match with SQL NULL, the IsNull() operator must be used. Set 'invalidWhereValuesBehavior.null' to 'ignore' or 'sql-null' in connection options to skip or handle null values.`)}else if(t===void 0&&(((r=this.connection.options.invalidWhereValuesBehavior)==null?void 0:r.undefined)||"ignore")==="throw")throw new x(`Undefined value encountered in property '${e}' of a where condition. Set 'invalidWhereValuesBehavior.undefined' to 'ignore' in connection options to skip properties with undefined values.`);return{operator:"equal",parameters:[e,this.createParameter(t)]}}getWhereCondition(e){if(typeof e=="string")return e;if(B.isBrackets(e)){const r=this.createQueryBuilder();return r.parentQueryBuilder=this,r.expressionMap.mainAlias=this.expressionMap.mainAlias,r.expressionMap.aliasNamePrefixingEnabled=this.expressionMap.aliasNamePrefixingEnabled,r.expressionMap.parameters=this.expressionMap.parameters,r.expressionMap.nativeParameters=this.expressionMap.nativeParameters,r.expressionMap.wheres=[],e.whereFactory(r),{operator:B.isNotBrackets(e)?"not":"brackets",condition:r.expressionMap.wheres}}if(typeof e=="function")return e(this);const t=Array.isArray(e)?e:[e],n=[];for(const r of t){const i=[];for(const[a,o]of this.getPredicates(r))i.push({type:"and",condition:this.getWherePredicateCondition(a,o)});n.push({type:"or",condition:i})}return n.length===1?n[0].condition:n}obtainQueryRunner(){return this.queryRunner||this.connection.createQueryRunner()}hasCommonTableExpressions(){return this.expressionMap.commonTableExpressions.length>0}}Nt.queryBuilderRegistry={};class j_{static from(e){const t=new this;return t.raw=e.records,t.affected=e.affected,t}}class W_ extends Nt{constructor(e,t){super(e,t),this["@instanceof"]=Symbol.for("DeleteQueryBuilder"),this.expressionMap.aliasNamePrefixingEnabled=!1}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createDeleteExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){const[e,t]=this.getQueryAndParameters(),n=this.obtainQueryRunner();let r=!1;try{this.expressionMap.useTransaction===!0&&n.isTransactionActive===!1&&(await n.startTransaction(),r=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await n.broadcaster.broadcast("BeforeRemove",this.expressionMap.mainAlias.metadata);const i=await n.query(e,t,!0),a=j_.from(i);return this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await n.broadcaster.broadcast("AfterRemove",this.expressionMap.mainAlias.metadata),r&&await n.commitTransaction(),a}catch(i){if(r)try{await n.rollbackTransaction()}catch{}throw i}finally{n!==this.queryRunner&&await n.release()}}from(e,t){e=B.isEntitySchema(e)?e.options.name:e;const n=this.createFromAlias(e,t);return this.expressionMap.setMainAlias(n),this}where(e,t){this.expressionMap.wheres=[];const n=this.getWhereCondition(e);return n&&(this.expressionMap.wheres=[{type:"simple",condition:n}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("delete"))throw new zo;return this.expressionMap.returning=e,this}createDeleteExpression(){const e=this.getTableName(this.getMainTableName()),t=this.createWhereExpression(),n=this.createReturningExpression("delete");return n===""?`DELETE FROM ${e}${t}`:this.connection.driver.options.type==="mssql"?`DELETE FROM ${e} OUTPUT ${n}${t}`:this.connection.driver.options.type==="spanner"?`DELETE FROM ${e}${t} THEN RETURN ${n}`:`DELETE FROM ${e}${t} RETURNING ${n}`}}const jt=[];for(let s=0;s<256;++s)jt.push((s+256).toString(16).slice(1));function Q_(s,e=0){return(jt[s[e+0]]+jt[s[e+1]]+jt[s[e+2]]+jt[s[e+3]]+"-"+jt[s[e+4]]+jt[s[e+5]]+"-"+jt[s[e+6]]+jt[s[e+7]]+"-"+jt[s[e+8]]+jt[s[e+9]]+"-"+jt[s[e+10]]+jt[s[e+11]]+jt[s[e+12]]+jt[s[e+13]]+jt[s[e+14]]+jt[s[e+15]]).toLowerCase()}let Yu;const V_=new Uint8Array(16);function H_(){if(!Yu){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");Yu=crypto.getRandomValues.bind(crypto)}return Yu(V_)}const Y_=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Lp={randomUUID:Y_};function ih(s,e,t){var r;if(Lp.randomUUID&&!s)return Lp.randomUUID();s=s||{};const n=s.random??((r=s.rng)==null?void 0:r.call(s))??H_();if(n.length<16)throw new Error("Random bytes length must be >= 16");return n[6]=n[6]&15|64,n[8]=n[8]&63|128,Q_(n)}class $n{constructor(){this.count=0,this.promises=[]}async wait(){return this.promises.length>0&&await Promise.all(this.promises),this}}class qp{constructor(){this.identifiers=[],this.generatedMaps=[]}static from(e){const t=new this;return t.raw=e.raw,t}}class sh{constructor(e,t){this.queryRunner=e,this.expressionMap=t}async update(e,t){const n=this.expressionMap.mainAlias.metadata;await Promise.all(t.map(async(r,i)=>{if(this.queryRunner.connection.driver.isReturningSqlSupported("update")){this.queryRunner.connection.driver.options.type==="oracle"&&Array.isArray(e.raw)&&this.expressionMap.extraReturningColumns.length>0&&(e.raw=e.raw.reduce((l,h,d)=>(l[this.expressionMap.extraReturningColumns[d].databaseName]=h[0],l),{}));const a=Array.isArray(e.raw)?e.raw[i]:e.raw,o=this.queryRunner.connection.driver.createGeneratedMap(n,a);o&&(this.queryRunner.manager.merge(n.target,r,o),e.generatedMaps.push(o))}else{const a=this.expressionMap.extraReturningColumns;if(a.length>0){const o=this.expressionMap.mainAlias.metadata.getEntityIdMap(r);if(!o)throw new x("Cannot update entity because entity id is not set in the entity.");const l=await this.queryRunner.manager.createQueryBuilder().select(n.primaryColumns.map(h=>n.targetName+"."+h.propertyPath)).addSelect(a.map(h=>n.targetName+"."+h.propertyPath)).from(n.target,n.targetName).where(o).withDeleted().setOption("create-pojo").getOne();l&&(this.queryRunner.manager.merge(n.target,r,l),e.generatedMaps.push(l))}}}))}async insert(e,t){const n=this.expressionMap.mainAlias.metadata;let r=n.getInsertionReturningColumns();const i=this.queryRunner.connection.driver.isReturningSqlSupported("insert");r=r.filter(o=>o.isGenerated?i===!0:!0);const a=t.map((o,l)=>{Array.isArray(e.raw)&&this.expressionMap.extraReturningColumns.length>0&&(this.queryRunner.connection.driver.options.type==="oracle"?e.raw=e.raw.reduce((p,m,w)=>(p[this.expressionMap.extraReturningColumns[w].databaseName]=m[0],p),{}):this.queryRunner.connection.driver.options.type==="spanner"&&(e.raw=e.raw[0]));const h=Array.isArray(e.raw)?e.raw[l]:e.raw,d=this.queryRunner.connection.driver.createGeneratedMap(n,h,l,t.length)||{};return l in this.expressionMap.locallyGenerated&&this.queryRunner.manager.merge(n.target,d,this.expressionMap.locallyGenerated[l]),this.queryRunner.manager.merge(n.target,o,d),d});if(r.length>0&&!this.queryRunner.connection.driver.isReturningSqlSupported("insert")){const o=t.map(h=>{const d=n.getEntityIdMap(h);if(!d)throw new x("Cannot update entity because entity id is not set in the entity.");return d}),l=await this.queryRunner.manager.createQueryBuilder().select(n.primaryColumns.map(h=>n.targetName+"."+h.propertyPath)).addSelect(r.map(h=>n.targetName+"."+h.propertyPath)).from(n.target,n.targetName).where(o).setOption("create-pojo").getMany();t.forEach((h,d)=>{this.queryRunner.manager.merge(n.target,a[d],l[d]),this.queryRunner.manager.merge(n.target,h,l[d])})}t.forEach((o,l)=>{const h=n.getEntityIdMap(o);e.identifiers.push(h),e.generatedMaps.push(a[l])})}getUpdationReturningColumns(){return this.expressionMap.mainAlias.metadata.columns.filter(e=>e.asExpression!==void 0||e.isUpdateDate||e.isVersion)}getSoftDeletionReturningColumns(){return this.expressionMap.mainAlias.metadata.columns.filter(e=>e.asExpression!==void 0||e.isUpdateDate||e.isVersion||e.isDeleteDate)}}class G_ extends Nt{constructor(){super(...arguments),this["@instanceof"]=Symbol.for("InsertQueryBuilder")}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createInsertExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){const e=this.getValueSets();if(e.length===0)return new qp;const t=this.obtainQueryRunner();let n=!1;try{if(this.expressionMap.useTransaction===!0&&t.isTransactionActive===!1&&(await t.startTransaction(),n=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata){const b=new $n;e.forEach(S=>{t.broadcaster.broadcastBeforeInsertEvent(b,this.expressionMap.mainAlias.metadata,S)}),await b.wait()}let r=null,i=null;const a=new sh(t,this.expressionMap),o=[];if(Array.isArray(this.expressionMap.returning)&&this.expressionMap.mainAlias.hasMetadata)for(const b of this.expressionMap.returning)o.push(...this.expressionMap.mainAlias.metadata.findColumnsWithPropertyPath(b));this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&(e.length>1&&this.connection.driver.options.type==="oracle"||(this.expressionMap.extraReturningColumns=this.expressionMap.mainAlias.metadata.getInsertionReturningColumns()),o.push(...this.expressionMap.extraReturningColumns.filter(b=>!o.includes(b)))),o.length>0&&this.connection.driver.options.type==="mssql"&&(r=this.connection.driver.buildTableVariableDeclaration("@OutputTable",o),i="SELECT * FROM @OutputTable");const[l,h]=this.getQueryAndParameters(),p=[r,l,i].filter(b=>b!=null).join(`;

`),m=await t.query(p,h,!0),w=qp.from(m);if(this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&await a.insert(w,e),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata){const b=new $n;e.forEach(S=>{t.broadcaster.broadcastAfterInsertEvent(b,this.expressionMap.mainAlias.metadata,S)}),await b.wait()}return n&&await t.commitTransaction(),w}catch(r){if(n)try{await t.rollbackTransaction()}catch{}throw r}finally{t!==this.queryRunner&&await t.release()}}into(e,t){e=B.isEntitySchema(e)?e.options.name:e;const n=this.createFromAlias(e);return this.expressionMap.setMainAlias(n),this.expressionMap.insertColumns=t||[],this}values(e){return this.expressionMap.valuesSet=e,this}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("insert"))throw new zo;return this.expressionMap.returning=e,this}updateEntity(e){return this.expressionMap.updateEntity=e,this}onConflict(e){return this.expressionMap.onConflict=e,this}orIgnore(e=!0){return this.expressionMap.onIgnore=!!e,this}orUpdate(e,t,n){const{where:r,parameters:i}=(n==null?void 0:n.overwriteCondition)??{};let a;if(r){const o=this.getWhereCondition(r);(Array.isArray(o)?o.length!==0:o)&&(a=[{type:"simple",condition:o}])}return i&&this.setParameters(i),Array.isArray(e)?(this.expressionMap.onUpdate={overwrite:e,conflict:t,skipUpdateIfNoValuesChanged:n==null?void 0:n.skipUpdateIfNoValuesChanged,indexPredicate:n==null?void 0:n.indexPredicate,upsertType:n==null?void 0:n.upsertType,overwriteCondition:a},this):(this.expressionMap.onUpdate={conflict:e==null?void 0:e.conflict_target,columns:e==null?void 0:e.columns,overwrite:e==null?void 0:e.overwrite,skipUpdateIfNoValuesChanged:n==null?void 0:n.skipUpdateIfNoValuesChanged,upsertType:n==null?void 0:n.upsertType,overwriteCondition:a},this)}createInsertExpression(){var o,l,h,d;if((this.expressionMap.onUpdate||this.expressionMap.onIgnore)&&(((o=this.expressionMap.onUpdate)==null?void 0:o.upsertType)??"merge-into")==="merge-into"&&this.connection.driver.supportedUpsertTypes.includes("merge-into"))return this.createMergeExpression();const e=this.getTableName(this.getMainTableName()),t=this.alias!==this.getMainTableName()?this.escape(this.alias):e,n=this.createValuesExpression(),r=this.connection.driver.options.type==="oracle"&&this.getValueSets().length>1?null:this.createReturningExpression("insert"),i=this.createColumnNamesExpression();let a="INSERT ";if(((l=this.expressionMap.onUpdate)==null?void 0:l.upsertType)==="primary-key"&&(a="UPSERT "),(ie.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&(a+=`${this.expressionMap.onIgnore?" IGNORE ":""}`),a+=`INTO ${e}`,this.alias!==this.getMainTableName()&&ie.isPostgresFamily(this.connection.driver)&&(a+=` AS "${this.alias}"`),i?a+=`(${i})`:!n&&(ie.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&(a+="()"),r&&this.connection.driver.options.type==="mssql"&&(a+=` OUTPUT ${r}`),n?(this.connection.driver.options.type==="oracle"||this.connection.driver.options.type==="sap")&&this.getValueSets().length>1?a+=` ${n}`:a+=` VALUES ${n}`:ie.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"?a+=" VALUES ()":a+=" DEFAULT VALUES",((h=this.expressionMap.onUpdate)==null?void 0:h.upsertType)!=="primary-key"){if(this.connection.driver.supportedUpsertTypes.includes("on-conflict-do-update")){if(this.expressionMap.onIgnore)a+=" ON CONFLICT DO NOTHING ";else if(this.expressionMap.onConflict)a+=` ON CONFLICT ${this.expressionMap.onConflict} `;else if(this.expressionMap.onUpdate){const{overwrite:p,columns:m,conflict:w,skipUpdateIfNoValuesChanged:b,indexPredicate:S}=this.expressionMap.onUpdate;let R="ON CONFLICT";if(Array.isArray(w)){if(R+=` ( ${w.map(q=>this.escape(q)).join(", ")} )`,S&&!ie.isPostgresFamily(this.connection.driver))throw new x("indexPredicate option is not supported by the current database driver");S&&ie.isPostgresFamily(this.connection.driver)&&(R+=` WHERE ( ${S} )`)}else w&&(R+=` ON CONSTRAINT ${this.escape(w)}`);const $=[];if(Array.isArray(p)?$.push(...p.map(q=>`${this.escape(q)} = EXCLUDED.${this.escape(q)}`)):m&&$.push(...m.map(q=>`${this.escape(q)} = :${q}`)),$.length>0&&(a+=` ${R} DO UPDATE SET `,$.push(...this.expressionMap.mainAlias.metadata.columns.filter(q=>q.isUpdateDate&&!(p!=null&&p.includes(q.databaseName))&&!(this.connection.driver.options.type==="oracle"&&this.getValueSets().length>1||ie.isSQLiteFamily(this.connection.driver)||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner")).map(q=>`${this.escape(q.databaseName)} = DEFAULT`)),a+=$.join(", ")),Array.isArray(p)&&b){(d=this.expressionMap.onUpdate).overwriteCondition??(d.overwriteCondition=[]);const q=p.map(O=>({type:"or",condition:`${t}.${this.escape(O)} IS DISTINCT FROM EXCLUDED.${this.escape(O)}`}));this.expressionMap.onUpdate.overwriteCondition.push({type:"and",condition:q})}ie.isPostgresFamily(this.connection.driver)&&this.expressionMap.onUpdate.overwriteCondition&&this.expressionMap.onUpdate.overwriteCondition.length>0&&(a+=` WHERE ${this.createUpsertConditionExpression()}`)}}else if(this.connection.driver.supportedUpsertTypes.includes("on-duplicate-key-update")){if(this.expressionMap.onUpdate){const{overwrite:p,columns:m}=this.expressionMap.onUpdate;Array.isArray(p)?(a+=" ON DUPLICATE KEY UPDATE ",a+=p.map(w=>`${this.escape(w)} = VALUES(${this.escape(w)})`).join(", "),a+=" "):Array.isArray(m)&&(a+=" ON DUPLICATE KEY UPDATE ",a+=m.map(w=>`${this.escape(w)} = :${w}`).join(", "),a+=" ")}}else if(this.expressionMap.onUpdate)throw new x("onUpdate is not supported by the current database driver")}return r&&(ie.isPostgresFamily(this.connection.driver)||this.connection.driver.options.type==="oracle"||this.connection.driver.options.type==="cockroachdb"||ie.isMySQLFamily(this.connection.driver))&&(a+=` RETURNING ${r}`),r&&this.connection.driver.options.type==="spanner"&&(a+=` THEN RETURN ${r}`),this.connection.driver.options.type==="mssql"&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.mainAlias.metadata.columns.filter(p=>this.expressionMap.insertColumns.length>0?this.expressionMap.insertColumns.indexOf(p.propertyPath)!==-1:p.isInsert).some(p=>this.isOverridingAutoIncrementBehavior(p))&&(a=`SET IDENTITY_INSERT ${e} ON; ${a}; SET IDENTITY_INSERT ${e} OFF`),a}getInsertedColumns(){return this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata.columns.filter(e=>this.expressionMap.insertColumns.length?this.expressionMap.insertColumns.indexOf(e.propertyPath)!==-1:!(!e.isInsert||e.isGenerated&&e.generationStrategy==="increment"&&this.connection.driver.options.type!=="spanner"&&this.connection.driver.options.type!=="oracle"&&!ie.isSQLiteFamily(this.connection.driver)&&!ie.isMySQLFamily(this.connection.driver)&&this.connection.driver.options.type!=="aurora-mysql"&&!(this.connection.driver.options.type==="mssql"&&this.isOverridingAutoIncrementBehavior(e)))):[]}createColumnNamesExpression(){const e=this.getInsertedColumns();if(e.length>0)return e.map(t=>this.escape(t.databaseName)).join(", ");if(!this.expressionMap.mainAlias.hasMetadata&&!this.expressionMap.insertColumns.length){const t=this.getValueSets();if(t.length===1)return Object.keys(t[0]).map(n=>this.escape(n)).join(", ")}return this.expressionMap.insertColumns.map(t=>this.escape(t)).join(", ")}createValuesExpression(){const e=this.getValueSets(),t=this.getInsertedColumns();if(t.length>0){let n="";return e.forEach((r,i)=>{t.forEach((a,o)=>{o===0&&(this.connection.driver.options.type==="oracle"&&e.length>1||this.connection.driver.options.type==="sap"&&e.length>1?n+=" SELECT ":n+="("),n+=this.createColumnValueExpression(e,i,a),o===t.length-1?i===e.length-1?["oracle","sap"].includes(this.connection.driver.options.type)&&e.length>1?n+=" FROM "+this.connection.driver.dummyTableName:n+=")":["oracle","sap"].includes(this.connection.driver.options.type)&&e.length>1?n+=" FROM "+this.connection.driver.dummyTableName+" UNION ALL ":n+="), ":n+=", "})}),n==="()"?"":n}else{let n="";return e.forEach((r,i)=>{Object.keys(r).forEach((o,l)=>{l===0&&(n+="(");const h=r[o];typeof h=="function"?n+=h():h===void 0?this.connection.driver.options.type==="oracle"&&e.length>1||ie.isSQLiteFamily(this.connection.driver)||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"?n+="NULL":n+="DEFAULT":h===null&&this.connection.driver.options.type==="spanner"||(n+=this.createParameter(h)),l===Object.keys(r).length-1?i===e.length-1?n+=")":n+="), ":n+=", "})}),n==="()"?"":n}}getValueSets(){if(Array.isArray(this.expressionMap.valuesSet))return this.expressionMap.valuesSet;if(Re.isObject(this.expressionMap.valuesSet))return[this.expressionMap.valuesSet];throw new M0}isOverridingAutoIncrementBehavior(e){return e.isPrimary&&e.isGenerated&&e.generationStrategy==="increment"&&this.getValueSets().some(t=>e.getEntityValue(t)!==void 0&&e.getEntityValue(t)!==null)}createMergeExpression(){var d,p,m;if(!this.connection.driver.supportedUpsertTypes.includes("merge-into"))throw new x('Upsert type "merge-into" is not supported by current database driver');if((d=this.expressionMap.onUpdate)!=null&&d.upsertType&&this.expressionMap.onUpdate.upsertType!=="merge-into")throw new x(`Upsert type "${this.expressionMap.onUpdate.upsertType}" is not supported by current database driver`);const e=this.getTableName(this.getMainTableName()),t=this.escape(this.alias),n=this.getInsertedColumns(),r=this.createColumnNamesExpression();let i=`MERGE INTO ${e} ${this.escape(this.alias)}`;const a=this.escape("mergeIntoSource"),o=this.createMergeIntoSourceExpression(a);if(i+=` ${o}`,this.expressionMap.onIgnore){const w=n.find(b=>b.isPrimary);w?i+=` ON (${t}.${this.escape(w.databaseName)} = ${a}.${this.escape(w.databaseName)})`:i+=`ON (${this.expressionMap.mainAlias.metadata.uniques.map(b=>`(${b.columns.map(S=>`${t}.${this.escape(S.databaseName)} = ${a}.${this.escape(S.databaseName)}`).join(" AND ")})`).join(" OR ")})`}else if(this.expressionMap.onUpdate){const{conflict:w,indexPredicate:b}=this.expressionMap.onUpdate;if(b)throw new x('indexPredicate option is not supported by upsert type "merge-into"');Array.isArray(w)?i+=` ON (${w.map(S=>`${t}.${this.escape(S)} = ${a}.${this.escape(S)}`).join(" AND ")})`:w?i+=` ON (${t}.${this.escape(w)} = ${a}.${this.escape(w)})`:i+=`ON (${this.expressionMap.mainAlias.metadata.uniques.map(S=>`(${S.columns.map(R=>`${t}.${this.escape(R.databaseName)} = ${a}.${this.escape(R.databaseName)}`).join(" AND ")})`).join(" OR ")})`}if(this.expressionMap.onUpdate){const{overwrite:w,columns:b,conflict:S,skipUpdateIfNoValuesChanged:R}=this.expressionMap.onUpdate;let $="";if(Array.isArray(w)&&($+=(p=w||b)==null?void 0:p.filter(O=>!(S!=null&&S.includes(O))).map(O=>`${t}.${this.escape(O)} = ${a}.${this.escape(O)}`).join(", ")),Array.isArray(w)&&R){(m=this.expressionMap.onUpdate).overwriteCondition??(m.overwriteCondition=[]);const O=w.map(J=>({type:"or",condition:{operator:"notEqual",parameters:[`${t}.${this.escape(J)}`,`${a}.${this.escape(J)}`]}}));this.expressionMap.onUpdate.overwriteCondition.push({type:"and",condition:O})}const q=this.createUpsertConditionExpression();$.trim()&&((this.connection.driver.options.type==="mssql"||this.connection.driver.options.type==="sap")&&q!=""?i+=` WHEN MATCHED AND ${q} THEN UPDATE SET ${$}`:(i+=` WHEN MATCHED THEN UPDATE SET ${$}`,q!=""&&(i+=` WHERE ${q}`)))}const l=this.createMergeIntoInsertValuesExpression(a),h=this.connection.driver.options.type==="mssql"?this.createReturningExpression("insert"):null;return i+=" WHEN NOT MATCHED THEN INSERT",r&&(i+=`(${r})`),l&&(i+=` VALUES ${l}`),h&&this.connection.driver.options.type==="mssql"&&(i+=` OUTPUT ${h}`),this.connection.driver.options.type==="mssql"&&(i+=";"),i}createMergeIntoSourceExpression(e){const t=this.getValueSets(),n=this.getInsertedColumns();let r="USING (";if(n.length>0)this.connection.driver.options.type==="mssql"&&(r+="VALUES "),t.forEach((i,a)=>{n.forEach((o,l)=>{l===0&&(this.connection.driver.options.type==="mssql"?r+="(":r+="SELECT ");const h=o.getEntityValue(i);h===void 0&&!(o.isGenerated&&o.generationStrategy==="uuid"&&!this.connection.driver.isUUIDGenerationSupported())?o.default!==void 0&&o.default!==null?r+=this.connection.driver.normalizeDefault(o):r+="NULL":h===null?r+="NULL":r+=this.createColumnValueExpression(t,a,o),this.connection.driver.options.type!=="mssql"&&(r+=` AS ${this.escape(o.databaseName)}`),l===n.length-1?a===t.length-1?["oracle","sap"].includes(this.connection.driver.options.type)?r+=" FROM "+this.connection.driver.dummyTableName:this.connection.driver.options.type==="mssql"&&(r+=")"):["oracle","sap"].includes(this.connection.driver.options.type)&&t.length>1?r+=" FROM "+this.connection.driver.dummyTableName+" UNION ALL ":this.connection.driver.options.type==="mssql"?r+="), ":r+=" UNION ALL ":r+=", "})});else throw new x('Upsert type "merge-into" is not supported without metadata tables');return r+=`) ${e}`,this.connection.driver.options.type==="mssql"&&(r+=` (${n.map(i=>this.escape(i.databaseName)).join(", ")})`),r}createMergeIntoInsertValuesExpression(e){const t=this.getInsertedColumns();let n="";if(t.length>0)t.forEach((r,i)=>{i===0&&(n+="("),r.isGenerated&&r.generationStrategy==="uuid"&&this.connection.driver.isUUIDGenerationSupported()||r.isGenerated&&r.generationStrategy!=="uuid"?n+="DEFAULT":n+=`${e}.${this.escape(r.databaseName)}`,i===t.length-1?n+=")":n+=", "});else throw new x('Upsert type "merge-into" is not supported without metadata tables');return n==="()"?"":n}createUpsertConditionExpression(){if(!this.expressionMap.onUpdate.overwriteCondition)return"";const e=[],t=this.createWhereClausesExpression(this.expressionMap.onUpdate.overwriteCondition);if(t.length>0&&t!=="1=1"&&e.push(t),this.expressionMap.mainAlias.hasMetadata){const r=this.expressionMap.mainAlias.metadata;if(this.expressionMap.queryType==="select"&&!this.expressionMap.withDeleted&&r.deleteDateColumn){const a=`${this.expressionMap.aliasNamePrefixingEnabled?this.expressionMap.mainAlias.name+"."+r.deleteDateColumn.propertyName:r.deleteDateColumn.propertyName} IS NULL`;e.push(a)}if(r.discriminatorColumn&&r.parentEntityMetadata){const a=`${this.expressionMap.aliasNamePrefixingEnabled?this.expressionMap.mainAlias.name+"."+r.discriminatorColumn.databaseName:r.discriminatorColumn.databaseName} IN (:...discriminatorColumnValues)`;e.push(a)}}if(this.expressionMap.extraAppendedAndWhereCondition){const r=this.expressionMap.extraAppendedAndWhereCondition;e.push(r)}let n="";return e.length?e.length===1?n+=`${e[0]}`:n+=`( ${e.join(" ) AND ( ")} )`:n+="",n}createColumnValueExpression(e,t,n){const r=e[t];let i="",a=n.getEntityValue(r);if(typeof a!="function"&&(a=this.connection.driver.preparePersistentValue(a,n)),n.isVersion&&a===void 0)i+="1";else if(n.isDiscriminator)i+=this.createParameter(this.expressionMap.mainAlias.metadata.discriminatorValue);else if(n.isGenerated&&n.generationStrategy==="uuid"&&!this.connection.driver.isUUIDGenerationSupported()&&a===void 0)a=ih(),i+=this.createParameter(a),t in this.expressionMap.locallyGenerated||(this.expressionMap.locallyGenerated[t]={}),n.setEntityValue(this.expressionMap.locallyGenerated[t],a);else if(a===void 0)this.connection.driver.options.type==="oracle"&&e.length>1||ie.isSQLiteFamily(this.connection.driver)||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"?n.default!==void 0&&n.default!==null?i+=this.connection.driver.normalizeDefault(n):this.connection.driver.options.type==="spanner"&&n.isGenerated&&n.generationStrategy==="uuid"?i+="GENERATE_UUID()":i+="NULL":i+="DEFAULT";else if(a===null&&(this.connection.driver.options.type==="spanner"||this.connection.driver.options.type==="oracle"))i+="NULL";else if(typeof a=="function")i+=a();else{this.connection.driver.options.type==="mssql"&&(a=this.connection.driver.parametrizeValue(n,a));const o=this.createParameter(a);if((ie.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&this.connection.driver.spatialTypes.includes(n.type)){const h=this.connection.driver.options.legacySpatialSupport?"GeomFromText":"ST_GeomFromText";n.srid!=null?i+=`${h}(${o}, ${n.srid})`:i+=`${h}(${o})`}else ie.isPostgresFamily(this.connection.driver)&&this.connection.driver.spatialTypes.includes(n.type)?n.srid!=null?i+=`ST_SetSRID(ST_GeomFromGeoJSON(${o}), ${n.srid})::${n.type}`:i+=`ST_GeomFromGeoJSON(${o})::${n.type}`:this.connection.driver.options.type==="mssql"&&this.connection.driver.spatialTypes.includes(n.type)?i+=n.type+"::STGeomFromText("+o+", "+(n.srid||"0")+")":i+=o}return i}}class Bp{constructor(e,t){this.queryBuilder=e,this.expressionMap=t}async update(e){const t=this.expressionMap.relationMetadata;if(t.isManyToOne||t.isOneToOneOwner){const n=t.joinColumns.reduce((r,i)=>{const a=Re.isObject(e)?i.referencedColumn.getEntityValue(e):e;return i.setEntityValue(r,a),r},{});if(!this.expressionMap.of||Array.isArray(this.expressionMap.of)&&!this.expressionMap.of.length)return;await this.queryBuilder.createQueryBuilder().update(t.entityMetadata.target).set(n).whereInIds(this.expressionMap.of).execute()}else if((t.isOneToOneNotOwner||t.isOneToMany)&&e===null){const n={};t.inverseRelation.joinColumns.forEach(l=>{n[l.propertyName]=null});const r=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],i={},a=[];r.forEach((l,h)=>{t.inverseRelation.joinColumns.map((d,p)=>{const m="joinColumn_"+h+"_"+p;i[m]=Re.isObject(l)?d.referencedColumn.getEntityValue(l):l,a.push(`${d.propertyPath} = :${m}`)})});const o=a.map(l=>"("+l+")").join(" OR ");if(!o)return;await this.queryBuilder.createQueryBuilder().update(t.inverseEntityMetadata.target).set(n).where(o).setParameters(i).execute()}else if(t.isOneToOneNotOwner||t.isOneToMany){if(Array.isArray(this.expressionMap.of))throw new x("You cannot update relations of multiple entities with the same related object. Provide a single entity into .of method.");const n=this.expressionMap.of,r=t.inverseRelation.joinColumns.reduce((i,a)=>{const o=Re.isObject(n)?a.referencedColumn.getEntityValue(n):n;return a.setEntityValue(i,o),i},{});if(!e||Array.isArray(e)&&!e.length)return;await this.queryBuilder.createQueryBuilder().update(t.inverseEntityMetadata.target).set(r).whereInIds(e).execute()}else{const n=t.junctionEntityMetadata,r=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],i=Array.isArray(e)?e:[e],a=t.isManyToManyOwner?r:i,o=t.isManyToManyOwner?i:r,l=[];if(a.forEach(h=>{o.forEach(d=>{const p={};n.ownerColumns.forEach(m=>{p[m.databaseName]=Re.isObject(h)?m.referencedColumn.getEntityValue(h):h}),n.inverseColumns.forEach(m=>{p[m.databaseName]=Re.isObject(d)?m.referencedColumn.getEntityValue(d):d}),l.push(p)})}),!l.length)return;this.queryBuilder.connection.driver.options.type==="oracle"||this.queryBuilder.connection.driver.options.type==="sap"?await Promise.all(l.map(h=>this.queryBuilder.createQueryBuilder().insert().into(n.tableName).values(h).execute())):await this.queryBuilder.createQueryBuilder().insert().into(n.tableName).values(l).execute()}}}class z_{constructor(e,t){this.queryBuilder=e,this.expressionMap=t}async remove(e){const t=this.expressionMap.relationMetadata;if(t.isOneToMany){const n=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],r=Array.isArray(e)?e:[e],i={};t.inverseRelation.joinColumns.forEach(h=>{i[h.propertyName]=null});const a={},o=[];n.forEach((h,d)=>{o.push(...r.map((p,m)=>[...t.inverseRelation.joinColumns.map((w,b)=>{const S="joinColumn_"+d+"_"+m+"_"+b;return a[S]=Re.isObject(h)?w.referencedColumn.getEntityValue(h):h,`${w.propertyPath} = :${S}`}),...t.inverseRelation.entityMetadata.primaryColumns.map((w,b)=>{const S="primaryColumn_"+m+"_"+m+"_"+b;return a[S]=Re.isObject(p)?w.getEntityValue(p):p,`${w.propertyPath} = :${S}`})].join(" AND ")))});const l=o.map(h=>"("+h+")").join(" OR ");if(!l)return;await this.queryBuilder.createQueryBuilder().update(t.inverseEntityMetadata.target).set(i).where(l).setParameters(a).execute()}else{const n=t.junctionEntityMetadata,r=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],i=Array.isArray(e)?e:[e],a=t.isManyToManyOwner?r:i,o=t.isManyToManyOwner?i:r,l={},h=[];a.forEach((p,m)=>{h.push(...o.map((w,b)=>[...n.ownerColumns.map((S,R)=>{const $="firstValue_"+m+"_"+b+"_"+R;return l[$]=Re.isObject(p)?S.referencedColumn.getEntityValue(p):p,`${S.databaseName} = :${$}`}),...n.inverseColumns.map((S,R)=>{const $="secondValue_"+m+"_"+b+"_"+R;return l[$]=Re.isObject(w)?S.referencedColumn.getEntityValue(w):w,`${S.databaseName} = :${$}`})].join(" AND ")))});const d=h.map(p=>"("+p+")").join(" OR ");await this.queryBuilder.createQueryBuilder().delete().from(n.tableName).where(d).setParameters(l).execute()}}}class K_ extends Nt{constructor(){super(...arguments),this["@instanceof"]=Symbol.for("RelationQueryBuilder")}getQuery(){return""}of(e){return this.expressionMap.of=e,this}async set(e){const t=this.expressionMap.relationMetadata;if(!this.expressionMap.of)throw new x("Entity whose relation needs to be set is not set. Use .of method to define whose relation you want to set.");if(t.isManyToMany||t.isOneToMany)throw new x(`Set operation is only supported for many-to-one and one-to-one relations. However given "${t.propertyPath}" has ${t.relationType} relation. Use .add() method instead.`);if(t.joinColumns&&t.joinColumns.length>1&&(!Re.isObject(e)||Object.keys(e).length<t.joinColumns.length))throw new x('Value to be set into the relation must be a map of relation ids, for example: .set({ firstName: "...", lastName: "..." })');return new Bp(this,this.expressionMap).update(e)}async add(e){if(Array.isArray(e)&&e.length===0)return;const t=this.expressionMap.relationMetadata;if(!this.expressionMap.of)throw new x("Entity whose relation needs to be set is not set. Use .of method to define whose relation you want to set.");if(t.isManyToOne||t.isOneToOne)throw new x(`Add operation is only supported for many-to-many and one-to-many relations. However given "${t.propertyPath}" has ${t.relationType} relation. Use .set() method instead.`);if(t.joinColumns&&t.joinColumns.length>1&&(!Re.isObject(e)||Object.keys(e).length<t.joinColumns.length))throw new x('Value to be set into the relation must be a map of relation ids, for example: .set({ firstName: "...", lastName: "..." })');return new Bp(this,this.expressionMap).update(e)}async remove(e){if(Array.isArray(e)&&e.length===0)return;const t=this.expressionMap.relationMetadata;if(!this.expressionMap.of)throw new x("Entity whose relation needs to be set is not set. Use .of method to define whose relation you want to set.");if(t.isManyToOne||t.isOneToOne)throw new x(`Add operation is only supported for many-to-many and one-to-many relations. However given "${t.propertyPath}" has ${t.relationType} relation. Use .set(null) method instead.`);return new z_(this,this.expressionMap).remove(e)}async addAndRemove(e,t){await this.remove(t),await this.add(e)}async loadOne(){return this.loadMany().then(e=>e[0])}async loadMany(){let e=this.expressionMap.of;if(!Re.isObject(e)){const t=this.expressionMap.mainAlias.metadata;if(t.hasMultiplePrimaryKeys)throw new x("Cannot load entity because only one primary key was specified, however entity contains multiple primary keys");e=t.primaryColumns[0].createValueMap(e)}return this.connection.relationLoader.load(this.expressionMap.relationMetadata,e,this.queryRunner)}}class re{static chunk(e,t){return Array.from(Array(Math.ceil(e.length/t)),(n,r)=>e.slice(r*t,r*t+t))}static splitClassesAndStrings(e){return[e.filter(t=>typeof t!="string"),e.filter(t=>typeof t=="string")]}static groupBy(e,t){return e.reduce((n,r)=>{const i=t(r);let a=n.find(o=>o.id===i);return a||(a={id:i,items:[]},n.push(a)),a.items.push(r),n},[])}static uniq(e,t){return e.reduce((n,r)=>{let i=!1;if(typeof t=="function"){const a=t(r);i=!!n.find(o=>t(o)===a)}else typeof t=="string"?i=!!n.find(a=>a[t]===r[t]):i=n.indexOf(r)!==-1;return i||n.push(r),n},[])}static mergeDeep(e,...t){if(!t.length)return e;for(const n of t)re.merge(e,n);return e}static cloneObject(e){return e==null?e:Object.assign(Object.create(Object.getPrototypeOf(e)),e)}static deepCompare(...e){let t,n,r,i;if(e.length<1)return!0;for(t=1,n=e.length;t<n;t++)if(r=[],i=[],!re.compare2Objects(r,i,e[0],e[t]))return!1;return!0}static deepValue(e,t){const n=t.split(".");for(let r=0,i=n.length;r<i;r++)e=e[n[r]];return e}static replaceEmptyObjectsWithBooleans(e){for(const t in e)e[t]&&typeof e[t]=="object"&&(Object.keys(e[t]).length===0?e[t]=!0:re.replaceEmptyObjectsWithBooleans(e[t]))}static propertyPathsToTruthyObject(e){const t={};for(const n of e){const r=n.split(".");if(!r.length)continue;(!t[r[0]]||t[r[0]]===!0)&&(t[r[0]]={});let i=t[r[0]];for(const[a,o]of r.entries())a!==0&&(i[o]?i=i[o]:a===r.length-1?(i[o]={},i=null):(i[o]={},i=i[o]))}return re.replaceEmptyObjectsWithBooleans(t),t}static compareIds(e,t){return e==null||t===void 0||t===null?!1:(typeof e.id=="string"&&typeof t.id=="string"||typeof e.id=="number"&&typeof t.id=="number")&&Object.keys(e).length===1&&Object.keys(t).length===1?e.id===t.id:re.deepCompare(e,t)}static toBoolean(e){return typeof e=="boolean"?e:typeof e=="string"?e==="true"||e==="1":typeof e=="number"?e>0:!1}static isArraysEqual(e,t){return e.length!==t.length?!1:e.every(n=>t.includes(n))}static areMutuallyExclusive(...e){return!e.some(n=>{const r=e.filter(i=>i!==n);return n.some(i=>r.some(a=>a.includes(i)))})}static parseSqlCheckExpression(e,t){const n=e.match(new RegExp(`"${t}" varchar CHECK\\s*\\(\\s*"${t}"\\s+IN\\s*`));if(n&&n.index){const i=e.substring(n.index+n[0].length);let a="",o="";const l=[];for(let h=0;h<i.length;h++){const d=i[h];switch(d){case",":a==""?(l.push(o),o=""):o+=d;break;case"'":a==d?i[h+1]===d?(o+=d,h+=1):a="":a=d;break;case")":if(a=="")return l.push(o),l;o+=d;break;default:a!=""&&(o+=d)}}}}static isCriteriaNullOrEmpty(e){return e==null||e===""||Array.isArray(e)&&e.length===0||re.isPlainObject(e)&&Object.keys(e).length===0}static isSinglePrimitiveCriteria(e){return typeof e=="string"||typeof e=="number"||e instanceof Date}static isPrimitiveCriteria(e){return Array.isArray(e)?e.every(t=>re.isSinglePrimitiveCriteria(t)):re.isSinglePrimitiveCriteria(e)}static compare2Objects(e,t,n,r){let i;if(Number.isNaN(n)&&Number.isNaN(r)||n===r)return!0;if(n===null||r===null||n===void 0||r===void 0)return!1;if((typeof n.equals=="function"||typeof n.equals=="function")&&n.equals(r))return!0;if(typeof n=="function"&&typeof r=="function"||n instanceof Date&&r instanceof Date||n instanceof RegExp&&r instanceof RegExp||typeof n=="string"&&typeof r=="string"||typeof n=="number"&&typeof r=="number")return n.toString()===r.toString();if(!(typeof n=="object"&&typeof r=="object")||Object.prototype.isPrototypeOf.call(n,r)||Object.prototype.isPrototypeOf.call(r,n)||n.constructor!==r.constructor||n.prototype!==r.prototype||e.indexOf(n)>-1||t.indexOf(r)>-1)return!1;for(i in r){if(r.hasOwnProperty(i)!==n.hasOwnProperty(i))return!1;if(typeof r[i]!=typeof n[i])return!1}for(i in n){if(r.hasOwnProperty(i)!==n.hasOwnProperty(i))return!1;if(typeof r[i]!=typeof n[i])return!1;switch(typeof n[i]){case"object":case"function":if(e.push(n),t.push(r),!re.compare2Objects(e,t,n[i],r[i]))return!1;e.pop(),t.pop();break;default:if(n[i]!==r[i])return!1;break}}return!0}static isPlainObject(e){return e==null?!1:!e.constructor||e.constructor===Object}static mergeArrayKey(e,t,n,r){if(r.has(n)){e[t]=r.get(n);return}if(!(n instanceof Promise)){if(!re.isPlainObject(n)&&!Array.isArray(n)){e[t]=n;return}e[t]||(e[t]=Array.isArray(n)?[]:{}),r.set(n,e[t]),re.merge(e[t],n,r),r.delete(n)}}static mergeObjectKey(e,t,n,r){if(r.has(n)){Object.assign(e,{[t]:r.get(n)});return}if(!(n instanceof Promise)){if(!re.isPlainObject(n)&&!Array.isArray(n)){Object.assign(e,{[t]:n});return}e[t]||Object.assign(e,{[t]:Array.isArray(n)?[]:{}}),r.set(n,e[t]),re.merge(e[t],n,r),r.delete(n)}}static merge(e,t,n=new Map){if(re.isPlainObject(e)&&re.isPlainObject(t))for(const[r,i]of Object.entries(t))r!=="__proto__"&&re.mergeObjectKey(e,r,i,n);if(Array.isArray(e)&&Array.isArray(t))for(let r=0;r<t.length;r++)re.mergeArrayKey(e,r,t[r],n)}}class J_{constructor(e,t,n,r,i){this.expressionMap=e,this.driver=t,this.rawRelationIdResults=n,this.rawRelationCountResults=r,this.queryRunner=i,this.pojo=this.expressionMap.options.includes("create-pojo"),this.selections=new Set(this.expressionMap.selects.map(a=>a.selection)),this.aliasCache=new Map,this.columnsCache=new Map}transform(e,t){const n=this.group(e,t),r=[];for(const i of n.values()){const a=this.transformRawResultsGroup(i,t);a!==void 0&&r.push(a)}return r}buildAlias(e,t){let n=this.aliasCache.get(e);n||(n=new Map,this.aliasCache.set(e,n));let r=n.get(t);return r||(r=ie.buildAlias(this.driver,void 0,e,t),n.set(t,r)),r}group(e,t){const n=new Map,r=[];t.metadata.tableType==="view"?r.push(...t.metadata.columns.map(i=>this.buildAlias(t.name,i.databaseName))):r.push(...t.metadata.primaryColumns.map(i=>this.buildAlias(t.name,i.databaseName)));for(const i of e){const a=r.map(l=>{const h=i[l];return Buffer.isBuffer(h)?h.toString("hex"):Re.isObject(h)?JSON.stringify(h):h}).join("_"),o=n.get(a);o?o.push(i):n.set(a,[i])}return n}transformRawResultsGroup(e,t){let n=t.metadata;if(n.discriminatorColumn){const d=e.map(m=>m[this.buildAlias(t.name,t.metadata.discriminatorColumn.databaseName)]),p=n.childEntityMetadatas.find(m=>typeof d.find(w=>w===m.discriminatorValue)<"u");p&&(n=p)}const r=n.create(this.queryRunner,{fromDeserializer:!0,pojo:this.pojo}),i=this.transformColumns(e,t,r,n),a=this.transformJoins(e,r,t,n),o=this.transformRelationIds(e,t,r,n),l=this.transformRelationCounts(e,t,r);if(i||n.primaryColumns.every(d=>d.isVirtual===!0)&&(a||o||l))return r}transformColumns(e,t,n,r){let i=!1;const a=e[0];for(const[o,l]of this.getColumnsToProcess(t.name,r)){const h=a[o];h!==void 0&&(h!==null&&!l.isVirtualProperty&&(i=!0),l.setEntityValue(n,this.driver.prepareHydratedValue(h,l)))}return i}transformJoins(e,t,n,r){let i=!1;for(const a of this.expressionMap.joinAttributes){if(!a.metadata||!a.isSelected||a.relation&&!r.relations.find(l=>l===a.relation))continue;if(a.mapToProperty){if(a.mapToPropertyParentAlias!==n.name)continue}else if(!a.relation||a.parentAlias!==n.name||a.relationPropertyPath!==a.relation.propertyPath)continue;let o=this.transform(e,a.alias);o=a.isMany?o:o[0],o=!a.isMany&&o===void 0?null:o,o!==void 0&&(a.mapToPropertyPropertyName?t[a.mapToPropertyPropertyName]=o:a.relation.setEntityValue(t,o),i=!0)}return i}transformRelationIds(e,t,n,r){let i=!1;for(const[a,o]of this.rawRelationIdResults.entries()){if(o.relationIdAttribute.parentAlias!==t.name)continue;const l=o.relationIdAttribute.relation,h=this.createValueMapFromJoinColumns(l,o.relationIdAttribute.parentAlias,e);if(h==null)continue;this.prepareDataForTransformRelationIds();const d=this.hashEntityIds(l,h),p=this.relationIdMaps[a][d]||[],m=o.relationIdAttribute.mapToPropertyPropertyPath.split("."),w=(b,S,R)=>{const $=b.shift();if($&&b.length===0)return S[$]=R,S;if($&&b.length>0)w(b,S[$],R);else return S};l.isOneToOne||l.isManyToOne?p[0]!==void 0&&(w(m,n,p[0]),i=!0):(w(m,n,p),i=i||p.length>0)}return i}transformRelationCounts(e,t,n){let r=!1;for(const i of this.rawRelationCountResults){if(i.relationCountAttribute.parentAlias!==t.name)continue;const a=i.relationCountAttribute.relation;let o;a.isOneToMany?o=a.inverseRelation.joinColumns[0].referencedColumn.databaseName:o=a.isOwning?a.joinColumns[0].referencedColumn.databaseName:a.inverseRelation.joinColumns[0].referencedColumn.databaseName;const l=e[0][this.buildAlias(t.name,o)];if(l!=null){n[i.relationCountAttribute.mapToPropertyPropertyName]=0;for(const h of i.results)h.parentId===l&&(n[i.relationCountAttribute.mapToPropertyPropertyName]=parseInt(h.cnt),r=!0)}}return r}getColumnsToProcess(e,t){let n=this.columnsCache.get(e);n||(n=new Map,this.columnsCache.set(e,n));let r=n.get(t);return r||(r=t.columns.filter(i=>!i.isVirtual&&(this.selections.has(e)||this.selections.has(`${e}.${i.propertyPath}`))&&!t.childEntityMetadatas.some(a=>a.target===i.target)).map(i=>[this.buildAlias(e,i.databaseName),i]),n.set(t,r)),r}createValueMapFromJoinColumns(e,t,n){let r;return e.isManyToOne||e.isOneToOneOwner?r=e.entityMetadata.primaryColumns.map(i=>i):e.isOneToMany||e.isOneToOneNotOwner?r=e.inverseRelation.joinColumns.map(i=>i):e.isOwning?r=e.joinColumns.map(i=>i):r=e.inverseRelation.inverseJoinColumns.map(i=>i),r.reduce((i,a)=>{for(const o of n)e.isManyToOne||e.isOneToOneOwner?i[a.databaseName]=this.driver.prepareHydratedValue(o[this.buildAlias(t,a.databaseName)],a):i[a.databaseName]=this.driver.prepareHydratedValue(o[this.buildAlias(t,a.referencedColumn.databaseName)],a.referencedColumn);return i},{})}extractEntityPrimaryIds(e,t){let n;return e.isManyToOne||e.isOneToOneOwner?n=e.entityMetadata.primaryColumns.map(r=>r):e.isOneToMany||e.isOneToOneNotOwner?n=e.inverseRelation.joinColumns.map(r=>r):e.isOwning?n=e.joinColumns.map(r=>r):n=e.inverseRelation.inverseJoinColumns.map(r=>r),n.reduce((r,i)=>(r[i.databaseName]=t[i.databaseName],r),{})}prepareDataForTransformRelationIds(){this.relationIdMaps||(this.relationIdMaps=this.rawRelationIdResults.map(e=>{const t=e.relationIdAttribute.relation;let n;return t.isManyToOne||t.isOneToOneOwner?n=t.joinColumns:t.isOneToMany||t.isOneToOneNotOwner?n=t.inverseEntityMetadata.primaryColumns:t.isOwning?n=t.inverseJoinColumns:n=t.inverseRelation.joinColumns,e.results.reduce((r,i)=>{let a=n.reduce((o,l)=>{let h=i[l.databaseName];return t.isOneToMany||t.isOneToOneNotOwner?(l.isVirtual&&l.referencedColumn&&l.referencedColumn.propertyName!==l.propertyName&&(h=l.referencedColumn.createValueMap(h)),re.mergeDeep(o,l.createValueMap(h))):(!l.isPrimary&&l.referencedColumn.referencedColumn&&(h=l.referencedColumn.referencedColumn.createValueMap(h)),re.mergeDeep(o,l.referencedColumn.createValueMap(h)))},{});if(n.length===1&&!e.relationIdAttribute.disableMixedMap&&(t.isOneToMany||t.isOneToOneNotOwner?a=n[0].getEntityValue(a):a=n[0].referencedColumn.getEntityValue(a)),a!==void 0){const o=this.hashEntityIds(t,i);r[o]?r[o].push(a):r[o]=[a]}return r},{})}))}hashEntityIds(e,t){const n=this.extractEntityPrimaryIds(e,t);return JSON.stringify(n)}}let X_=class{constructor(e,t,n){this.connection=e,this.queryRunner=t,this.relationIdAttributes=n}async load(e){const t=this.relationIdAttributes.map(async n=>{if(n.relation.isManyToOne||n.relation.isOneToOneOwner){if(n.queryBuilderFactory)throw new x("Additional condition can not be used with ManyToOne or OneToOne owner relations.");const r={},i=e.map(a=>{const o={},l=[];n.relation.joinColumns.forEach(d=>{o[d.databaseName]=this.connection.driver.prepareHydratedValue(a[ie.buildAlias(this.connection.driver,void 0,n.parentAlias,d.databaseName)],d.referencedColumn);const p=`${d.databaseName}:${o[d.databaseName]}`;l.indexOf(p)===-1&&l.push(p)}),n.relation.entityMetadata.primaryColumns.forEach(d=>{o[d.databaseName]=this.connection.driver.prepareHydratedValue(a[ie.buildAlias(this.connection.driver,void 0,n.parentAlias,d.databaseName)],d);const p=`${d.databaseName}:${o[d.databaseName]}`;l.indexOf(p)===-1&&l.push(p)}),l.sort();const h=l.join("::");return r[h]?null:(r[h]=!0,o)}).filter(a=>a);return{relationIdAttribute:n,results:i}}else if(n.relation.isOneToMany||n.relation.isOneToOneNotOwner){const r=n.relation,i=r.isOwning?r.joinColumns:r.inverseRelation.joinColumns,a=r.inverseEntityMetadata.target,o=r.inverseEntityMetadata.tableName,l=n.alias||o,h={},d={},p=e.map((S,R)=>{const $=[],q={},O=i.map(ne=>{const ge=ne.databaseName+R,pe=S[ie.buildAlias(this.connection.driver,void 0,n.parentAlias,ne.referencedColumn.databaseName)],me=`${l}:${ne.propertyPath}:${pe}`;return $.indexOf(me)!==-1?"":($.push(me),q[ge]=pe,l+"."+ne.propertyPath+" = :"+ge)}).filter(ne=>ne).join(" AND ");$.sort();const J=$.join("::");return h[J]?"":(h[J]=!0,Object.assign(d,q),O)}).filter(S=>S).map(S=>"("+S+")").join(" OR ");if(!p)return{relationIdAttribute:n,results:[]};const m=this.connection.createQueryBuilder(this.queryRunner);re.uniq([...i,...r.inverseRelation.entityMetadata.primaryColumns],S=>S.propertyPath).forEach(S=>{m.addSelect(l+"."+S.propertyPath,S.databaseName)}),m.from(a,l).where("("+p+")").setParameters(d),n.queryBuilderFactory&&n.queryBuilderFactory(m);const b=await m.getRawMany();return b.forEach(S=>{i.forEach(R=>{S[R.databaseName]=this.connection.driver.prepareHydratedValue(S[R.databaseName],R.referencedColumn)}),r.inverseRelation.entityMetadata.primaryColumns.forEach(R=>{S[R.databaseName]=this.connection.driver.prepareHydratedValue(S[R.databaseName],R)})}),{relationIdAttribute:n,results:b}}else{const r=n.relation,i=r.isOwning?r.joinColumns:r.inverseRelation.inverseJoinColumns,a=r.isOwning?r.inverseJoinColumns:r.inverseRelation.joinColumns,o=n.junctionAlias,l=n.joinInverseSideMetadata.tableName,h=n.alias||l,d=r.isOwning?r.junctionEntityMetadata.tableName:r.inverseRelation.junctionEntityMetadata.tableName,p=e.map(O=>i.reduce((J,ne)=>(J[ne.propertyPath]=O[ie.buildAlias(this.connection.driver,void 0,n.parentAlias,ne.referencedColumn.databaseName)],J),{}));if(p.length===0)return{relationIdAttribute:n,results:[]};const m={},w={},b=p.map((O,J)=>{const ne=[],ge={},pe=Object.keys(O).map(V=>{const Ae=V+J,D=O[V],ae=`${o}:${V}:${D}`;return ne.indexOf(ae)!==-1?"":(ne.push(ae),ge[Ae]=D,o+"."+V+" = :"+Ae)}).filter(V=>V).join(" AND ");ne.sort();const me=ne.join("::");return w[me]?"":(w[me]=!0,Object.assign(m,ge),pe)}).filter(O=>O),S=a.map(O=>o+"."+O.propertyPath+" = "+h+"."+O.referencedColumn.propertyPath).join(" AND "),R=b.map(O=>"("+O+" AND "+S+")").join(" OR "),$=this.connection.createQueryBuilder(this.queryRunner);a.forEach(O=>{$.addSelect(o+"."+O.propertyPath,O.databaseName).addOrderBy(o+"."+O.propertyPath)}),i.forEach(O=>{$.addSelect(o+"."+O.propertyPath,O.databaseName).addOrderBy(o+"."+O.propertyPath)}),$.from(l,h).innerJoin(d,o,R).setParameters(m),n.queryBuilderFactory&&n.queryBuilderFactory($);const q=await $.getRawMany();return q.forEach(O=>{[...i,...a].forEach(J=>{O[J.databaseName]=this.connection.driver.prepareHydratedValue(O[J.databaseName],J.referencedColumn)})}),{relationIdAttribute:n,results:q}}});return Promise.all(t)}};class Ay{constructor(e,t){this.connection=e,this.queryRunner=t}load(e,t,n){const r=Array.isArray(t)?t:[t],i=Array.isArray(n)?n:n?[n]:void 0;return e.isManyToMany?this.loadForManyToMany(e,r,i):e.isManyToOne||e.isOneToOneOwner?this.loadForManyToOneAndOneToOneOwner(e,r,i):this.loadForOneToManyAndOneToOneNotOwner(e,r,i)}async loadManyToManyRelationIdsAndGroup(e,t,n,r){const i=e.isManyToMany||e.isOneToMany,a=Array.isArray(t)?t:[t];if(!n&&(n=await this.connection.relationLoader.load(e,t,this.queryRunner,r),!n.length))return a.map(p=>({entity:p,related:i?[]:void 0}));const o=await this.load(e,t,n),l=Array.isArray(n)?n:[n];let h=[],d=[];return e.isManyToManyOwner?(h=e.junctionEntityMetadata.inverseColumns.map(p=>p.referencedColumn),d=e.junctionEntityMetadata.ownerColumns.map(p=>p.referencedColumn)):e.isManyToManyNotOwner?(h=e.junctionEntityMetadata.ownerColumns.map(p=>p.referencedColumn),d=e.junctionEntityMetadata.inverseColumns.map(p=>p.referencedColumn)):e.isManyToOne||e.isOneToOneOwner?(h=e.joinColumns.map(p=>p.referencedColumn),d=e.entityMetadata.primaryColumns):(e.isOneToMany||e.isOneToOneNotOwner)&&(h=e.inverseRelation.entityMetadata.primaryColumns,d=e.inverseRelation.joinColumns.map(p=>p.referencedColumn)),a.map(p=>{const m={entity:p,related:i?[]:void 0},w=o.filter(b=>d.every(S=>S.compareEntityValue(p,b[S.entityMetadata.name+"_"+S.propertyAliasName])));return w.length&&l.forEach(b=>{w.forEach(S=>{h.every($=>$.compareEntityValue(b,S[ie.buildAlias(this.connection.driver,void 0,$.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+$.propertyPath.replace(".","_"))]))&&(i?m.related.push(b):m.related=b)})}),m})}loadForManyToMany(e,t,n){const r=e.junctionEntityMetadata,i=r.name,a=e.isOwning?r.ownerColumns:r.inverseColumns,o=e.isOwning?r.inverseColumns:r.ownerColumns,l=this.connection.createQueryBuilder(this.queryRunner);a.forEach(m=>{const w=ie.buildAlias(this.connection.driver,void 0,m.referencedColumn.entityMetadata.name+"_"+m.referencedColumn.propertyPath.replace(".","_"));l.addSelect(i+"."+m.propertyPath,w)}),o.forEach(m=>{const w=ie.buildAlias(this.connection.driver,void 0,m.referencedColumn.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+m.referencedColumn.propertyPath.replace(".","_"));l.addSelect(i+"."+m.propertyPath,w)});let h="";if(a.length===1){const m=t.map(b=>a[0].referencedColumn.getEntityValue(b));m.every(b=>typeof b=="number")?h=`${i}.${a[0].propertyPath} IN (${m.join(", ")})`:(l.setParameter("values1",m),h=i+"."+a[0].propertyPath+" IN (:...values1)")}else h="("+t.map((m,w)=>a.map(b=>{const S="entity1_"+w+"_"+b.propertyName;return l.setParameter(S,b.referencedColumn.getEntityValue(m)),i+"."+b.propertyPath+" = :"+S}).join(" AND ")).map(m=>"("+m+")").join(" OR ")+")";let d="";if(n)if(o.length===1){const m=n.map(b=>o[0].referencedColumn.getEntityValue(b));m.every(b=>typeof b=="number")?d=`${i}.${o[0].propertyPath} IN (${m.join(", ")})`:(l.setParameter("values2",m),d=i+"."+o[0].propertyPath+" IN (:...values2)")}else d="("+n.map((m,w)=>o.map(b=>{const S="entity2_"+w+"_"+b.propertyName;return l.setParameter(S,b.referencedColumn.getEntityValue(m)),i+"."+b.propertyPath+" = :"+S}).join(" AND ")).map(m=>"("+m+")").join(" OR ")+")";const p=[h,d].filter(m=>m.length>0).join(" AND ");return l.from(r.target,i).where(p).getRawMany()}loadForManyToOneAndOneToOneOwner(e,t,n){const r=e.entityMetadata.targetName,i=e.joinColumns.every(l=>!!e.entityMetadata.nonVirtualColumns.find(h=>h===l));if(n&&i){const l=[];if(t.forEach(h=>{const d={};e.entityMetadata.primaryColumns.forEach(p=>{const m=p.entityMetadata.name+"_"+p.propertyPath.replace(".","_");d[m]=p.getEntityValue(h)}),n.forEach(p=>{e.joinColumns.forEach(m=>{const w=m.getEntityValue(h),b=m.referencedColumn.getEntityValue(p);if(!(w===void 0||b===void 0)&&w===b){const S=m.referencedColumn.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+m.referencedColumn.propertyPath.replace(".","_");d[S]=b}})}),Object.keys(d).length===e.entityMetadata.primaryColumns.length+e.joinColumns.length&&l.push(d)}),l.length===t.length)return Promise.resolve(l)}const a=this.connection.createQueryBuilder(this.queryRunner);e.entityMetadata.primaryColumns.forEach(l=>{const h=ie.buildAlias(this.connection.driver,void 0,l.entityMetadata.name+"_"+l.propertyPath.replace(".","_"));a.addSelect(r+"."+l.propertyPath,h)}),e.joinColumns.forEach(l=>{const h=ie.buildAlias(this.connection.driver,void 0,l.referencedColumn.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+l.referencedColumn.propertyPath.replace(".","_"));a.addSelect(r+"."+l.propertyPath,h)});let o="";if(e.entityMetadata.primaryColumns.length===1){const l=t.map(d=>e.entityMetadata.primaryColumns[0].getEntityValue(d));l.every(d=>typeof d=="number")?o=`${r}.${e.entityMetadata.primaryColumns[0].propertyPath} IN (${l.join(", ")})`:(a.setParameter("values",l),o=r+"."+e.entityMetadata.primaryColumns[0].propertyPath+" IN (:...values)")}else o=t.map((l,h)=>e.entityMetadata.primaryColumns.map((d,p)=>{const m="entity"+h+"_"+p;return a.setParameter(m,d.getEntityValue(l)),r+"."+d.propertyPath+" = :"+m}).join(" AND ")).map(l=>"("+l+")").join(" OR ");return a.from(e.entityMetadata.target,r).where(o).getRawMany()}loadForOneToManyAndOneToOneNotOwner(e,t,n){const r=e;if(e=e.inverseRelation,e.entityMetadata.primaryColumns.length===e.joinColumns.length&&e.entityMetadata.primaryColumns.every(h=>e.joinColumns.indexOf(h)!==-1))return Promise.resolve(t.map(h=>{const d={};return e.joinColumns.forEach(function(p){const m=p.referencedColumn.getEntityValue(h),w=p.referencedColumn.entityMetadata.name+"_"+p.referencedColumn.propertyPath.replace(".","_"),b=p.entityMetadata.name+"_"+r.propertyPath.replace(".","_")+"_"+p.propertyPath.replace(".","_");d[w]=m,d[b]=m}),d}));const i=e.entityMetadata.targetName,a=this.connection.createQueryBuilder(this.queryRunner);e.entityMetadata.primaryColumns.forEach(l=>{const h=ie.buildAlias(this.connection.driver,void 0,l.entityMetadata.name+"_"+r.propertyPath.replace(".","_")+"_"+l.propertyPath.replace(".","_"));a.addSelect(i+"."+l.propertyPath,h)}),e.joinColumns.forEach(l=>{const h=ie.buildAlias(this.connection.driver,void 0,l.referencedColumn.entityMetadata.name+"_"+l.referencedColumn.propertyPath.replace(".","_"));a.addSelect(i+"."+l.propertyPath,h)});let o="";if(e.joinColumns.length===1){const l=t.map(d=>e.joinColumns[0].referencedColumn.getEntityValue(d));l.every(d=>typeof d=="number")?o=`${i}.${e.joinColumns[0].propertyPath} IN (${l.join(", ")})`:(a.setParameter("values",l),o=i+"."+e.joinColumns[0].propertyPath+" IN (:...values)")}else o=t.map((l,h)=>e.joinColumns.map((d,p)=>{const m="entity"+h+"_"+p;return a.setParameter(m,d.referencedColumn.getEntityValue(l)),i+"."+d.propertyPath+" = :"+m}).join(" AND ")).map(l=>"("+l+")").join(" OR ");return a.from(e.entityMetadata.target,i).where(o).getRawMany()}}class Z_{constructor(e){this.expressionMap=e}transform(){this.expressionMap.mainAlias&&this.expressionMap.mainAlias.metadata.relationIds.forEach(e=>{const t=this.metadataToAttribute(this.expressionMap.mainAlias.name,e);this.expressionMap.relationIdAttributes.push(t)}),this.expressionMap.joinAttributes.forEach(e=>{!e.metadata||e.metadata.isJunction||e.metadata.relationIds.forEach(t=>{const n=this.metadataToAttribute(e.alias.name,t);this.expressionMap.relationIdAttributes.push(n)})})}metadataToAttribute(e,t){return new th(this.expressionMap,{relationName:e+"."+t.relation.propertyName,mapToProperty:e+"."+t.propertyName,alias:t.alias,queryBuilderFactory:t.queryBuilderFactory})}}class ex{constructor(e,t,n){this.connection=e,this.queryRunner=t,this.relationCountAttributes=n}async load(e){const t=(r,i,a)=>a.indexOf(r)===i,n=this.relationCountAttributes.map(async r=>{if(r.relation.isOneToMany){const i=r.relation,a=i.inverseRelation,o=a.joinColumns[0].referencedColumn.propertyName,l=i.inverseEntityMetadata.target,h=i.inverseEntityMetadata.tableName,d=r.alias||h,p=a.propertyName;let m=e.map(b=>b[r.parentAlias+"_"+o]).filter(b=>!!b);if(m=m.filter(t),m.length===0)return{relationCountAttribute:r,results:[]};const w=this.connection.createQueryBuilder(this.queryRunner);return w.select(d+"."+p,"parentId").addSelect("COUNT(*)","cnt").from(l,d).where(d+"."+p+" IN (:...ids)").addGroupBy(d+"."+p).setParameter("ids",m),r.queryBuilderFactory&&r.queryBuilderFactory(w),{relationCountAttribute:r,results:await w.getRawMany()}}else{let i,a,o,l;r.relation.isOwning?(i=r.relation.joinColumns[0].referencedColumn.databaseName,a=r.relation.inverseJoinColumns[0].referencedColumn.databaseName,o=r.relation.junctionEntityMetadata.columns[0],l=r.relation.junctionEntityMetadata.columns[1]):(i=r.relation.inverseRelation.inverseJoinColumns[0].referencedColumn.databaseName,a=r.relation.inverseRelation.joinColumns[0].referencedColumn.databaseName,o=r.relation.junctionEntityMetadata.columns[1],l=r.relation.junctionEntityMetadata.columns[0]);let h=e.map(R=>R[r.parentAlias+"_"+i]).filter(R=>!!R);if(h=h.filter(t),h.length===0)return{relationCountAttribute:r,results:[]};const d=r.junctionAlias,p=r.joinInverseSideMetadata.tableName,m=r.alias||p,w=r.relation.junctionEntityMetadata.tableName,b=d+"."+o.propertyName+" IN ("+h.map(R=>isNaN(R)?"'"+R+"'":R)+") AND "+d+"."+l.propertyName+" = "+m+"."+a,S=this.connection.createQueryBuilder(this.queryRunner);return S.select(d+"."+o.propertyName,"parentId").addSelect("COUNT("+S.escape(m)+"."+S.escape(a)+")","cnt").from(p,m).innerJoin(w,d,b).addGroupBy(d+"."+o.propertyName),r.queryBuilderFactory&&r.queryBuilderFactory(S),{relationCountAttribute:r,results:await S.getRawMany()}}});return Promise.all(n)}}class tx{constructor(e){this.expressionMap=e}transform(){this.expressionMap.mainAlias&&this.expressionMap.mainAlias.metadata.relationCounts.forEach(e=>{const t=this.metadataToAttribute(this.expressionMap.mainAlias.name,e);this.expressionMap.relationCountAttributes.push(t)}),this.expressionMap.joinAttributes.forEach(e=>{!e.metadata||e.metadata.isJunction||e.metadata.relationCounts.forEach(t=>{const n=this.metadataToAttribute(e.alias.name,t);this.expressionMap.relationCountAttributes.push(n)})})}metadataToAttribute(e,t){return new nh(this.expressionMap,{relationName:e+"."+t.relation.propertyName,mapToProperty:e+"."+t.propertyName,alias:t.alias,queryBuilderFactory:t.queryBuilderFactory})}}class Ht{static isFindOneOptions(e){const t=e;return t&&(Array.isArray(t.select)||Array.isArray(t.relations)||typeof t.select=="object"||typeof t.relations=="object"||typeof t.where=="object"||typeof t.join=="object"||typeof t.order=="object"||typeof t.cache=="object"||typeof t.cache=="boolean"||typeof t.cache=="number"||typeof t.comment=="string"||typeof t.lock=="object"||typeof t.loadRelationIds=="object"||typeof t.loadRelationIds=="boolean"||typeof t.loadEagerRelations=="boolean"||typeof t.withDeleted=="boolean"||typeof t.relationLoadStrategy=="string"||typeof t.transaction=="boolean")}static isFindManyOptions(e){const t=e;return t&&(this.isFindOneOptions(t)||typeof t.skip=="number"||typeof t.take=="number"||typeof t.skip=="string"||typeof t.take=="string")}static extractFindManyOptionsAlias(e){if(this.isFindManyOptions(e)&&e.join)return e.join.alias}static applyOptionsToTreeQueryBuilder(e,t){if(t!=null&&t.relations){const n=[...t.relations];if(Ht.applyRelationsRecursively(e,n,e.expressionMap.mainAlias.name,e.expressionMap.mainAlias.metadata,""),n.length>0)throw new O0(n)}return e}static applyRelationsRecursively(e,t,n,r,i){let a=[];if(i){const o=new RegExp("^"+i.replace(".","\\.")+"\\.");a=t.filter(l=>l.match(o)).map(l=>r.findRelationWithPropertyPath(l.replace(o,""))).filter(l=>l)}else a=t.map(o=>r.findRelationWithPropertyPath(o)).filter(o=>o);a.forEach(o=>{const l=ie.buildAlias(e.connection.driver,{joiner:"__"},n,o.propertyPath),h=n+"."+o.propertyPath;e.expressionMap.relationLoadStrategy==="query"?e.concatRelationMetadata(o):e.leftJoinAndSelect(h,l),t.splice(t.indexOf(i?i+"."+o.propertyPath:o.propertyPath),1);let d,p;if(e.expressionMap.relationLoadStrategy==="query")d=o.inverseEntityMetadata,p=l;else{const m=e.expressionMap.joinAttributes.find(w=>w.entityOrProperty===h);d=m.metadata,p=m.alias.name}if(!p||!d)throw new Gn(o.propertyPath,r);if(this.applyRelationsRecursively(e,t,p,d,i?i+"."+o.propertyPath:o.propertyPath),e.expressionMap.relationLoadStrategy==="join"){const m=r.relations.find(w=>w.propertyName===o.propertyPath);m&&this.joinEagerRelations(e,l,m.inverseEntityMetadata)}})}static joinEagerRelations(e,t,n){n.eagerRelations.forEach(r=>{let i=ie.buildAlias(e.connection.driver,{joiner:"__"},t,r.propertyName),a=!0;for(const h of e.expressionMap.joinAttributes)if(!(h.condition!==void 0||h.mapToProperty!==void 0||h.isMappingMany!==void 0||h.direction!=="LEFT"||h.entityOrProperty!==`${t}.${r.propertyPath}`)){a=!1,i=h.alias.name;break}const o=!!e.expressionMap.joinAttributes.find(h=>h.alias.name===i);a&&!o&&e.leftJoin(t+"."+r.propertyPath,i);let l=!0;for(const h of e.expressionMap.selects)if(!(h.aliasName!==void 0||h.virtual!==void 0||h.selection!==i)){l=!1;break}l&&e.addSelect(i),this.joinEagerRelations(e,i,r.inverseEntityMetadata)})}}class zs extends Nt{constructor(){super(...arguments),this["@instanceof"]=Symbol.for("SelectQueryBuilder"),this.findOptions={},this.selects=[],this.joins=[],this.conditions="",this.orderBys=[],this.relationMetadatas=[]}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createSelectExpression(),e+=this.createJoinExpression(),e+=this.createWhereExpression(),e+=this.createGroupByExpression(),e+=this.createHavingExpression(),e+=this.createOrderByExpression(),e+=this.createLimitOffsetExpression(),e+=this.createLockExpression(),e=e.trim(),this.expressionMap.subQuery&&(e="("+e+")"),this.replacePropertyNamesForTheWholeQuery(e)}setFindOptions(e){return this.findOptions=e,this.applyFindOptions(),this}subQuery(){const e=this.createQueryBuilder();return e.expressionMap.subQuery=!0,e.parentQueryBuilder=this,e}select(e,t){if(this.expressionMap.queryType="select",Array.isArray(e))this.expressionMap.selects=e.map(n=>({selection:n}));else if(typeof e=="function"){const n=e(this.subQuery());this.setParameters(n.getParameters()),this.expressionMap.selects.push({selection:n.getQuery(),aliasName:t})}else e&&(this.expressionMap.selects=[{selection:e,aliasName:t}]);return this}addSelect(e,t){if(!e)return this;if(Array.isArray(e))this.expressionMap.selects=this.expressionMap.selects.concat(e.map(n=>({selection:n})));else if(typeof e=="function"){const n=e(this.subQuery());this.setParameters(n.getParameters()),this.expressionMap.selects.push({selection:n.getQuery(),aliasName:t})}else e&&this.expressionMap.selects.push({selection:e,aliasName:t});return this}maxExecutionTime(e){return this.expressionMap.maxExecutionTime=e,this}distinct(e=!0){return this.expressionMap.selectDistinct=e,this}distinctOn(e){return this.expressionMap.selectDistinctOn=e,this}fromDummy(){return this.from(this.connection.driver.dummyTableName??"(SELECT 1 AS dummy_column)","dummy_table")}from(e,t){const n=this.createFromAlias(e,t);return this.expressionMap.setMainAlias(n),this}addFrom(e,t){const n=this.createFromAlias(e,t);return this.expressionMap.mainAlias||this.expressionMap.setMainAlias(n),this}innerJoin(e,t,n,r){return this.join("INNER",e,t,n,r),this}leftJoin(e,t,n,r){return this.join("LEFT",e,t,n,r),this}innerJoinAndSelect(e,t,n,r){return this.addSelect(t),this.innerJoin(e,t,n,r),this}leftJoinAndSelect(e,t,n,r){return this.addSelect(t),this.leftJoin(e,t,n,r),this}innerJoinAndMapMany(e,t,n,r,i){return this.addSelect(n),this.join("INNER",t,n,r,i,e,!0),this}innerJoinAndMapOne(e,t,n,r,i,a){return this.addSelect(n),this.join("INNER",t,n,r,i,e,!1,a),this}leftJoinAndMapMany(e,t,n,r,i){return this.addSelect(n),this.join("LEFT",t,n,r,i,e,!0),this}leftJoinAndMapOne(e,t,n,r,i,a){return this.addSelect(n),this.join("LEFT",t,n,r,i,e,!1,a),this}loadRelationIdAndMap(e,t,n,r){const i=new th(this.expressionMap);return i.mapToProperty=e,i.relationName=t,typeof n=="string"&&(i.alias=n),typeof n=="object"&&n.disableMixedMap&&(i.disableMixedMap=!0),i.queryBuilderFactory=r,this.expressionMap.relationIdAttributes.push(i),i.relation.junctionEntityMetadata&&this.expressionMap.createAlias({type:"other",name:i.junctionAlias,metadata:i.relation.junctionEntityMetadata}),this}loadRelationCountAndMap(e,t,n,r){const i=new nh(this.expressionMap);return i.mapToProperty=e,i.relationName=t,i.alias=n,i.queryBuilderFactory=r,this.expressionMap.relationCountAttributes.push(i),this.expressionMap.createAlias({type:"other",name:i.junctionAlias}),i.relation.junctionEntityMetadata&&this.expressionMap.createAlias({type:"other",name:i.junctionAlias,metadata:i.relation.junctionEntityMetadata}),this}loadAllRelationIds(e){return this.expressionMap.mainAlias.metadata.relations.forEach(t=>{e!==void 0&&e.relations!==void 0&&e.relations.indexOf(t.propertyPath)===-1||this.loadRelationIdAndMap(this.expressionMap.mainAlias.name+"."+t.propertyPath,this.expressionMap.mainAlias.name+"."+t.propertyPath,e)}),this}where(e,t){this.expressionMap.wheres=[];const n=this.getWhereCondition(e);return n&&(this.expressionMap.wheres=[{type:"simple",condition:n}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereExists(e){return this.where(...this.getExistsCondition(e))}andWhereExists(e){return this.andWhere(...this.getExistsCondition(e))}orWhereExists(e){return this.orWhere(...this.getExistsCondition(e))}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}having(e,t){return this.expressionMap.havings.push({type:"simple",condition:e}),t&&this.setParameters(t),this}andHaving(e,t){return this.expressionMap.havings.push({type:"and",condition:e}),t&&this.setParameters(t),this}orHaving(e,t){return this.expressionMap.havings.push({type:"or",condition:e}),t&&this.setParameters(t),this}groupBy(e){return e?this.expressionMap.groupBys=[e]:this.expressionMap.groupBys=[],this}addGroupBy(e){return this.expressionMap.groupBys.push(e),this}timeTravelQuery(e){return this.connection.driver.options.type==="cockroachdb"&&(e===void 0?this.expressionMap.timeTravel="follower_read_timestamp()":this.expressionMap.timeTravel=e),this}orderBy(e,t="ASC",n){if(t!==void 0&&t!=="ASC"&&t!=="DESC")throw new x('SelectQueryBuilder.addOrderBy "order" can accept only "ASC" and "DESC" values.');if(n!==void 0&&n!=="NULLS FIRST"&&n!=="NULLS LAST")throw new x('SelectQueryBuilder.addOrderBy "nulls" can accept only "NULLS FIRST" and "NULLS LAST" values.');return e?typeof e=="object"?this.expressionMap.orderBys=e:n?this.expressionMap.orderBys={[e]:{order:t,nulls:n}}:this.expressionMap.orderBys={[e]:t}:this.expressionMap.orderBys={},this}addOrderBy(e,t="ASC",n){if(t!==void 0&&t!=="ASC"&&t!=="DESC")throw new x('SelectQueryBuilder.addOrderBy "order" can accept only "ASC" and "DESC" values.');if(n!==void 0&&n!=="NULLS FIRST"&&n!=="NULLS LAST")throw new x('SelectQueryBuilder.addOrderBy "nulls" can accept only "NULLS FIRST" and "NULLS LAST" values.');return n?this.expressionMap.orderBys[e]={order:t,nulls:n}:this.expressionMap.orderBys[e]=t,this}limit(e){if(this.expressionMap.limit=this.normalizeNumber(e),this.expressionMap.limit!==void 0&&isNaN(this.expressionMap.limit))throw new x('Provided "limit" value is not a number. Please provide a numeric value.');return this}offset(e){if(this.expressionMap.offset=this.normalizeNumber(e),this.expressionMap.offset!==void 0&&isNaN(this.expressionMap.offset))throw new x('Provided "offset" value is not a number. Please provide a numeric value.');return this}take(e){if(this.expressionMap.take=this.normalizeNumber(e),this.expressionMap.take!==void 0&&isNaN(this.expressionMap.take))throw new x('Provided "take" value is not a number. Please provide a numeric value.');return this}skip(e){if(this.expressionMap.skip=this.normalizeNumber(e),this.expressionMap.skip!==void 0&&isNaN(this.expressionMap.skip))throw new x('Provided "skip" value is not a number. Please provide a numeric value.');return this}useIndex(e){return this.expressionMap.useIndex=e,this}setLock(e,t,n){return this.expressionMap.lockMode=e,this.expressionMap.lockVersion=t,this.expressionMap.lockTables=n,this}setOnLocked(e){return this.expressionMap.onLocked=e,this}withDeleted(){return this.expressionMap.withDeleted=!0,this}async getRawOne(){return(await this.getRawMany())[0]}async getRawMany(){if(this.expressionMap.lockMode==="optimistic")throw new Us;this.expressionMap.queryEntity=!1;const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0);const n=await this.loadRawResults(e);return t&&await e.commitTransaction(),n}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}async getRawAndEntities(){const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!0;const n=await this.executeEntitiesAndRawResults(e);return t&&await e.commitTransaction(),n}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}async getOne(){const t=(await this.getRawAndEntities()).entities[0];if(t&&this.expressionMap.lockMode==="optimistic"&&this.expressionMap.lockVersion){const n=this.expressionMap.mainAlias.metadata;if(this.expressionMap.lockVersion instanceof Date){const r=n.updateDateColumn.getEntityValue(t);if(r.getTime()!==this.expressionMap.lockVersion.getTime())throw new wp(n.name,this.expressionMap.lockVersion,r)}else{const r=n.versionColumn.getEntityValue(t);if(r!==this.expressionMap.lockVersion)throw new wp(n.name,this.expressionMap.lockVersion,r)}}return t===void 0?null:t}async getOneOrFail(){const e=await this.getOne();if(!e)throw new yl(this.expressionMap.mainAlias.target,this.expressionMap.parameters);return e}async getMany(){if(this.expressionMap.lockMode==="optimistic")throw new Us;return(await this.getRawAndEntities()).entities}async getCount(){if(this.expressionMap.lockMode==="optimistic")throw new Us;const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!1;const n=await this.executeCountQuery(e);return t&&await e.commitTransaction(),n}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}async getExists(){if(this.expressionMap.lockMode==="optimistic")throw new Us;const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!1;const n=await this.executeExistsQuery(e);return t&&await e.commitTransaction(),n}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}async getManyAndCount(){if(this.expressionMap.lockMode==="optimistic")throw new Us;const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!0;const n=await this.executeEntitiesAndRawResults(e);this.expressionMap.queryEntity=!1;let r=this.lazyCount(n);if(r===void 0){const a=this.expressionMap.cacheId;a&&(this.expressionMap.cacheId=`${a}-count`),r=await this.executeCountQuery(e)}const i=[n.entities,r];return t&&await e.commitTransaction(),i}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}lazyCount(e){const t=this.expressionMap.limit!==void 0&&this.expressionMap.limit!==null;if(this.expressionMap.joinAttributes.length>0&&t)return;const n=this.expressionMap.take!==void 0&&this.expressionMap.take!==null,r=t?this.expressionMap.limit:n?this.expressionMap.take:void 0;if(r!==void 0&&e.entities.length===r)return;const i=this.expressionMap.skip!==void 0&&this.expressionMap.skip!==null&&this.expressionMap.skip>0,a=this.expressionMap.offset!==void 0&&this.expressionMap.offset!==null&&this.expressionMap.offset>0;if(e.entities.length===0&&(i||a))return;const o=a?this.expressionMap.offset:i?this.expressionMap.skip:0;return e.entities.length+o}async stream(){this.expressionMap.queryEntity=!1;const[e,t]=this.getQueryAndParameters(),n=this.obtainQueryRunner();let r=!1;try{this.expressionMap.useTransaction===!0&&n.isTransactionActive===!1&&(await n.startTransaction(),r=!0);const i=()=>{if(n!==this.queryRunner)return n.release()},a=n.stream(e,t,i,i);return r&&await n.commitTransaction(),a}catch(i){if(r)try{await n.rollbackTransaction()}catch{}throw i}}cache(e,t){return typeof e=="boolean"?this.expressionMap.cache=e:typeof e=="number"?(this.expressionMap.cache=!0,this.expressionMap.cacheDuration=e):(typeof e=="string"||typeof e=="number")&&(this.expressionMap.cache=!0,this.expressionMap.cacheId=e),t&&(this.expressionMap.cacheDuration=t),this}setOption(e){return this.expressionMap.options.push(e),this}join(e,t,n,r,i,a,o,l){i&&this.setParameters(i);const h=new Sy(this.connection,this.expressionMap);h.direction=e,h.mapAsEntity=l,h.mapToProperty=a,h.isMappingMany=o,h.entityOrProperty=t,h.condition=r,this.expressionMap.joinAttributes.push(h);const d=h.metadata;if(d){if(d.deleteDateColumn&&!this.expressionMap.withDeleted){const p=`${n}.${d.deleteDateColumn.propertyName} IS NULL`;h.condition=h.condition?` ${h.condition} AND ${p}`:`${p}`}h.alias=this.expressionMap.createAlias({type:"join",name:n,metadata:d}),h.relation&&h.relation.junctionEntityMetadata&&this.expressionMap.createAlias({type:"join",name:h.junctionAlias,metadata:h.relation.junctionEntityMetadata})}else{let p="";if(typeof t=="function"){const w=t(this.subQuery());this.setParameters(w.getParameters()),p=w.getQuery()}else p=t;const m=typeof t=="function"||t.substr(0,1)==="("&&t.substr(-1)===")";h.alias=this.expressionMap.createAlias({type:"join",name:n,tablePath:m===!1?t:void 0,subQuery:m===!0?p:void 0})}}createSelectExpression(){if(!this.expressionMap.mainAlias)throw new x("Cannot build query because main alias is not set (call qb#from method)");const e=[],t=[];if(this.expressionMap.mainAlias.hasMetadata){const o=this.expressionMap.mainAlias.metadata;e.push(...this.buildEscapedEntityColumnSelects(this.expressionMap.mainAlias.name,o)),t.push(...this.findEntityColumnSelects(this.expressionMap.mainAlias.name,o))}this.expressionMap.joinAttributes.forEach(o=>{if(o.metadata)e.push(...this.buildEscapedEntityColumnSelects(o.alias.name,o.metadata)),t.push(...this.findEntityColumnSelects(o.alias.name,o.metadata));else if(this.expressionMap.selects.some(h=>h.selection===o.alias.name)){e.push({selection:this.escape(o.alias.name)+".*"});const h=this.expressionMap.selects.find(d=>d.selection===o.alias.name);t.push(h)}}),this.expressionMap.selects.filter(o=>t.indexOf(o)===-1).forEach(o=>e.push({selection:this.replacePropertyNames(o.selection),aliasName:o.aliasName})),e.length===0&&e.push({selection:"*"});let n="";this.expressionMap.useIndex&&ie.isMySQLFamily(this.connection.driver)&&(n=` USE INDEX (${this.expressionMap.useIndex})`);const r=this.expressionMap.aliases.filter(o=>o.type==="from"&&(o.tablePath||o.subQuery)).map(o=>o.subQuery?o.subQuery+" "+this.escape(o.name):this.getTableName(o.tablePath)+" "+this.escape(o.name)),i=this.createSelectDistinctExpression(),a=e.map(o=>o.selection+(o.aliasName?" AS "+this.escape(o.aliasName):"")).join(", ");return i+a+" FROM "+r.join(", ")+this.createTableLockExpression()+n}createSelectDistinctExpression(){const{selectDistinct:e,selectDistinctOn:t,maxExecutionTime:n}=this.expressionMap,{driver:r}=this.connection;let i="SELECT ";return n>0&&ie.isMySQLFamily(r)&&(i+=`/*+ MAX_EXECUTION_TIME(${this.expressionMap.maxExecutionTime}) */ `),ie.isPostgresFamily(r)&&t.length>0?i=`SELECT DISTINCT ON (${t.map(o=>this.replacePropertyNames(o)).join(", ")}) `:e&&(i="SELECT DISTINCT "),i}createJoinExpression(){return this.expressionMap.joinAttributes.map(t=>{const n=t.relation,r=t.tablePath,i=t.alias.name;let a=t.condition?" AND ("+t.condition+")":"";const o=t.parentAlias;if(!o||!n){const l=t.alias.subQuery?t.alias.subQuery:this.getTableName(r);return" "+t.direction+" JOIN "+l+" "+this.escape(i)+this.createTableLockExpression()+(t.condition?" ON "+this.replacePropertyNames(t.condition):"")}if(n.isManyToOne||n.isOneToOneOwner){const l=n.joinColumns.map(h=>i+"."+h.referencedColumn.propertyPath+"="+o+"."+n.propertyPath+"."+h.referencedColumn.propertyPath).join(" AND ");return" "+t.direction+" JOIN "+this.getTableName(r)+" "+this.escape(i)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(l+a)}else if(n.isOneToMany||n.isOneToOneNotOwner){const l=n.inverseRelation.joinColumns.map(h=>(n.inverseEntityMetadata.tableType==="entity-child"&&n.inverseEntityMetadata.discriminatorColumn&&(a+=" AND "+i+"."+n.inverseEntityMetadata.discriminatorColumn.databaseName+"='"+n.inverseEntityMetadata.discriminatorValue+"'"),i+"."+n.inverseRelation.propertyPath+"."+h.referencedColumn.propertyPath+"="+o+"."+h.referencedColumn.propertyPath)).join(" AND ");if(!l)throw new x(`Relation ${n.entityMetadata.name}.${n.propertyName} does not have join columns.`);return" "+t.direction+" JOIN "+this.getTableName(r)+" "+this.escape(i)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(l+a)}else{const l=n.junctionEntityMetadata.tablePath,h=t.junctionAlias;let d="",p="";return n.isOwning?(d=n.joinColumns.map(m=>h+"."+m.propertyPath+"="+o+"."+m.referencedColumn.propertyPath).join(" AND "),p=n.inverseJoinColumns.map(m=>i+"."+m.referencedColumn.propertyPath+"="+h+"."+m.propertyPath).join(" AND ")):(d=n.inverseRelation.inverseJoinColumns.map(m=>h+"."+m.propertyPath+"="+o+"."+m.referencedColumn.propertyPath).join(" AND "),p=n.inverseRelation.joinColumns.map(m=>i+"."+m.referencedColumn.propertyPath+"="+h+"."+m.propertyPath).join(" AND "))," "+t.direction+" JOIN "+this.getTableName(l)+" "+this.escape(h)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(d)+" "+t.direction+" JOIN "+this.getTableName(r)+" "+this.escape(i)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(p+a)}}).join(" ")}createGroupByExpression(){return!this.expressionMap.groupBys||!this.expressionMap.groupBys.length?"":" GROUP BY "+this.replacePropertyNames(this.expressionMap.groupBys.join(", "))}createOrderByExpression(){const e=this.expressionMap.allOrderBys;return Object.keys(e).length===0?"":" ORDER BY "+Object.keys(e).map(t=>{const n=typeof e[t]=="string"?e[t]:e[t].order+" "+e[t].nulls,r=this.expressionMap.selects.find(i=>i.selection===t);if(r&&!r.aliasName&&t.indexOf(".")!==-1){const i=t.split("."),a=i[0],o=i.slice(1).join("."),l=this.expressionMap.aliases.find(h=>h.name===a);if(l){const h=l.metadata.findColumnWithPropertyPath(o);if(h){const d=ie.buildAlias(this.connection.driver,void 0,a,h.databaseName);return this.escape(d)+" "+n}}}return this.replacePropertyNames(t)+" "+n}).join(", ")}createLimitOffsetExpression(){let e=this.expressionMap.offset,t=this.expressionMap.limit;e===void 0&&t===void 0&&this.expressionMap.joinAttributes.length===0&&(e=this.expressionMap.skip,t=this.expressionMap.take);const n=t!=null,r=e!=null;if(this.connection.driver.options.type==="mssql"){let i="";if((n||r)&&Object.keys(this.expressionMap.allOrderBys).length<=0&&(i=" ORDER BY (SELECT NULL)"),n&&r)return i+" OFFSET "+e+" ROWS FETCH NEXT "+t+" ROWS ONLY";if(n)return i+" OFFSET 0 ROWS FETCH NEXT "+t+" ROWS ONLY";if(r)return i+" OFFSET "+e+" ROWS"}else if(ie.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"){if(n&&r)return" LIMIT "+t+" OFFSET "+e;if(n)return" LIMIT "+t;if(r)throw new B0}else if(ie.isSQLiteFamily(this.connection.driver)){if(n&&r)return" LIMIT "+t+" OFFSET "+e;if(n)return" LIMIT "+t;if(r)return" LIMIT -1 OFFSET "+e}else if(this.connection.driver.options.type==="oracle"){if(n&&r)return" OFFSET "+e+" ROWS FETCH NEXT "+t+" ROWS ONLY";if(n)return" FETCH NEXT "+t+" ROWS ONLY";if(r)return" OFFSET "+e+" ROWS"}else{if(n&&r)return" LIMIT "+t+" OFFSET "+e;if(n)return" LIMIT "+t;if(r)return" OFFSET "+e}return""}createTableLockExpression(){if(this.connection.driver.options.type==="mssql")switch(this.expressionMap.lockMode){case"pessimistic_read":return" WITH (HOLDLOCK, ROWLOCK)";case"pessimistic_write":return" WITH (UPDLOCK, ROWLOCK)";case"dirty_read":return" WITH (NOLOCK)"}return""}createLockExpression(){const e=this.connection.driver;let t="";if(this.expressionMap.lockTables){if(!(ie.isPostgresFamily(e)||e.options.type==="cockroachdb"))throw new x("Lock tables not supported in selected driver");if(this.expressionMap.lockTables.length<1)throw new x("lockTables cannot be an empty array");t=" OF "+this.expressionMap.lockTables.join(", ")}let n="";switch(this.expressionMap.onLocked==="nowait"?n=" NOWAIT":this.expressionMap.onLocked==="skip_locked"&&(n=" SKIP LOCKED"),this.expressionMap.lockMode){case"pessimistic_read":if(e.options.type==="mysql"||e.options.type==="aurora-mysql")return ie.isReleaseVersionOrGreater(e,"8.0.0")?" FOR SHARE"+t+n:" LOCK IN SHARE MODE";if(e.options.type==="mariadb")return" LOCK IN SHARE MODE";if(ie.isPostgresFamily(e))return" FOR SHARE"+t+n;if(e.options.type==="oracle")return" FOR UPDATE";if(e.options.type==="mssql")return"";throw new Gi;case"pessimistic_write":if(ie.isMySQLFamily(e)||e.options.type==="aurora-mysql"||e.options.type==="oracle")return" FOR UPDATE"+n;if(ie.isPostgresFamily(e)||e.options.type==="cockroachdb")return" FOR UPDATE"+t+n;if(e.options.type==="mssql")return"";throw new Gi;case"pessimistic_partial_write":if(ie.isPostgresFamily(e))return" FOR UPDATE"+t+" SKIP LOCKED";if(ie.isMySQLFamily(e))return" FOR UPDATE SKIP LOCKED";throw new Gi;case"pessimistic_write_or_fail":if(ie.isPostgresFamily(e)||e.options.type==="cockroachdb")return" FOR UPDATE"+t+" NOWAIT";if(ie.isMySQLFamily(e))return" FOR UPDATE NOWAIT";throw new Gi;case"for_no_key_update":if(ie.isPostgresFamily(e)||e.options.type==="cockroachdb")return" FOR NO KEY UPDATE"+t+n;throw new Gi;case"for_key_share":if(ie.isPostgresFamily(e))return" FOR KEY SHARE"+t+n;throw new Gi;default:return""}}createHavingExpression(){if(!this.expressionMap.havings||!this.expressionMap.havings.length)return"";const e=this.expressionMap.havings.map((t,n)=>{switch(t.type){case"and":return(n>0?"AND ":"")+this.replacePropertyNames(t.condition);case"or":return(n>0?"OR ":"")+this.replacePropertyNames(t.condition);default:return this.replacePropertyNames(t.condition)}}).join(" ");return e.length?" HAVING "+e:""}buildEscapedEntityColumnSelects(e,t){const n=this.expressionMap.selects.some(h=>h.selection===e),r=[];if(n&&r.push(...t.columns.filter(h=>h.isSelect===!0)),r.push(...t.columns.filter(h=>this.expressionMap.selects.some(d=>d.selection===e+"."+h.propertyPath))),r.length===0)return[];const i=this.expressionMap.queryEntity?t.primaryColumns.filter(h=>r.indexOf(h)===-1):[],a=[...r,...i],o=[],l=this.escape(e);return a.forEach(h=>{let d=l+"."+this.escape(h.databaseName);h.isVirtualProperty&&h.query&&(d=`(${h.query(l)})`),this.connection.driver.spatialTypes.indexOf(h.type)!==-1&&((ie.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&(d=`${this.connection.driver.options.legacySpatialSupport?"AsText":"ST_AsText"}(${d})`),ie.isPostgresFamily(this.connection.driver)&&(h.precision?d=`ST_AsGeoJSON(${d}, ${h.precision})::json`:d=`ST_AsGeoJSON(${d})::json`),this.connection.driver.options.type==="mssql"&&(d=`${d}.ToString()`));const p=this.expressionMap.selects.filter(m=>m.selection===e+"."+h.propertyPath);p.length?p.forEach(m=>{o.push({selection:d,aliasName:m.aliasName?m.aliasName:ie.buildAlias(this.connection.driver,void 0,e,h.databaseName),virtual:m.virtual})}):o.push({selection:d,aliasName:ie.buildAlias(this.connection.driver,void 0,e,h.databaseName),virtual:n})}),o}findEntityColumnSelects(e,t){return this.expressionMap.selects.filter(n=>n.selection===e||t.columns.some(r=>n.selection===e+"."+r.propertyPath))}computeCountExpression(){const e=this.expressionMap.mainAlias.name,n=this.expressionMap.mainAlias.metadata.primaryColumns,r=this.escape(e);if(this.expressionMap.joinAttributes.length===0&&this.expressionMap.relationIdAttributes.length===0&&this.expressionMap.relationCountAttributes.length===0)return"COUNT(1)";if(this.connection.driver.options.type==="cockroachdb"||ie.isPostgresFamily(this.connection.driver))return"COUNT(DISTINCT("+n.map(i=>`${r}.${this.escape(i.databaseName)}`).join(", ")+"))";if(ie.isMySQLFamily(this.connection.driver))return"COUNT(DISTINCT "+n.map(i=>`${r}.${this.escape(i.databaseName)}`).join(", ")+")";if(this.connection.driver.options.type==="mssql"){const i=n.map(a=>`${r}.${this.escape(a.databaseName)}`).join(", '|;|', ");return n.length===1?`COUNT(DISTINCT(${i}))`:`COUNT(DISTINCT(CONCAT(${i})))`}return this.connection.driver.options.type==="spanner"?n.length===1?`COUNT(DISTINCT(${r}.${this.escape(n[0].databaseName)}))`:`COUNT(DISTINCT(CONCAT(${n.map(a=>`CAST(${r}.${this.escape(a.databaseName)} AS STRING)`).join(", '|;|', ")})))`:"COUNT(DISTINCT("+n.map(i=>`${r}.${this.escape(i.databaseName)}`).join(" || '|;|' || ")+"))"}async executeCountQuery(e){const t=this.computeCountExpression(),n=await this.clone().orderBy().groupBy().offset(void 0).limit(void 0).skip(void 0).take(void 0).select(t,"cnt").setOption("disable-global-order").loadRawResults(e);return!n||!n[0]||!n[0].cnt?0:parseInt(n[0].cnt)}async executeExistsQuery(e){return(await this.connection.createQueryBuilder().fromDummy().select("1","row_exists").whereExists(this).limit(1).loadRawResults(e)).length>0}applyFindOptions(){if(this.expressionMap.mainAlias.metadata){if(this.findOptions.relationLoadStrategy&&(this.expressionMap.relationLoadStrategy=this.findOptions.relationLoadStrategy),this.findOptions.comment&&this.comment(this.findOptions.comment),this.findOptions.withDeleted&&this.withDeleted(),this.findOptions.select){const e=Array.isArray(this.findOptions.select)?re.propertyPathsToTruthyObject(this.findOptions.select):this.findOptions.select;this.buildSelect(e,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name)}if(this.selects.length&&this.select(this.selects),this.selects=[],this.findOptions.relations){const e=Array.isArray(this.findOptions.relations)?re.propertyPathsToTruthyObject(this.findOptions.relations):this.findOptions.relations;this.buildRelations(e,typeof this.findOptions.select=="object"?this.findOptions.select:void 0,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name),this.findOptions.loadEagerRelations!==!1&&this.expressionMap.relationLoadStrategy==="join"&&this.buildEagerRelations(e,typeof this.findOptions.select=="object"?this.findOptions.select:void 0,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name)}if(this.selects.length&&this.addSelect(this.selects),this.findOptions.where&&(this.conditions=this.buildWhere(this.findOptions.where,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name),this.conditions.length&&this.andWhere(this.conditions.substr(0,1)!=="("?"("+this.conditions+")":this.conditions)),this.findOptions.order&&this.buildOrder(this.findOptions.order,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name),this.joins.length&&this.joins.forEach(e=>{e.select&&!e.selection?e.type==="inner"?this.innerJoinAndSelect(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias):this.leftJoinAndSelect(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias):e.type==="inner"?this.innerJoin(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias):this.leftJoin(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias)}),this.findOptions.skip!==void 0&&this.skip(this.findOptions.skip),this.findOptions.take!==void 0&&this.take(this.findOptions.take),typeof this.findOptions.cache=="number"?this.cache(this.findOptions.cache):typeof this.findOptions.cache=="boolean"?this.cache(this.findOptions.cache):typeof this.findOptions.cache=="object"&&this.cache(this.findOptions.cache.id,this.findOptions.cache.milliseconds),this.findOptions.join&&(this.findOptions.join.leftJoin&&Object.keys(this.findOptions.join.leftJoin).forEach(e=>{this.leftJoin(this.findOptions.join.leftJoin[e],e)}),this.findOptions.join.innerJoin&&Object.keys(this.findOptions.join.innerJoin).forEach(e=>{this.innerJoin(this.findOptions.join.innerJoin[e],e)}),this.findOptions.join.leftJoinAndSelect&&Object.keys(this.findOptions.join.leftJoinAndSelect).forEach(e=>{this.leftJoinAndSelect(this.findOptions.join.leftJoinAndSelect[e],e)}),this.findOptions.join.innerJoinAndSelect&&Object.keys(this.findOptions.join.innerJoinAndSelect).forEach(e=>{this.innerJoinAndSelect(this.findOptions.join.innerJoinAndSelect[e],e)})),this.findOptions.lock){if(this.findOptions.lock.mode==="optimistic")this.setLock(this.findOptions.lock.mode,this.findOptions.lock.version);else if(this.findOptions.lock.mode==="pessimistic_read"||this.findOptions.lock.mode==="pessimistic_write"||this.findOptions.lock.mode==="dirty_read"||this.findOptions.lock.mode==="pessimistic_partial_write"||this.findOptions.lock.mode==="pessimistic_write_or_fail"||this.findOptions.lock.mode==="for_no_key_update"||this.findOptions.lock.mode==="for_key_share"){const e=this.findOptions.lock.tables?this.findOptions.lock.tables.map(t=>{const n=this.expressionMap.aliases.find(r=>r.metadata.tableNameWithoutPrefix===t);if(!n)throw new x(`"${t}" is not part of this query`);return this.escape(n.name)}):void 0;this.setLock(this.findOptions.lock.mode,void 0,e),this.findOptions.lock.onLocked&&this.setOnLocked(this.findOptions.lock.onLocked)}}this.findOptions.loadRelationIds===!0?this.loadAllRelationIds():typeof this.findOptions.loadRelationIds=="object"&&this.loadAllRelationIds(this.findOptions.loadRelationIds),this.findOptions.loadEagerRelations!==!1&&Ht.joinEagerRelations(this,this.expressionMap.mainAlias.name,this.expressionMap.mainAlias.metadata),this.findOptions.transaction===!0&&(this.expressionMap.useTransaction=!0)}}concatRelationMetadata(e){this.relationMetadatas.push(e)}async executeEntitiesAndRawResults(e){if(!this.expressionMap.mainAlias)throw new x('Alias is not set. Use "from" method to set an alias.');if((this.expressionMap.lockMode==="pessimistic_read"||this.expressionMap.lockMode==="pessimistic_write"||this.expressionMap.lockMode==="pessimistic_partial_write"||this.expressionMap.lockMode==="pessimistic_write_or_fail"||this.expressionMap.lockMode==="for_no_key_update"||this.expressionMap.lockMode==="for_key_share")&&!e.isTransactionActive)throw new D0;if(this.expressionMap.lockMode==="optimistic"){const l=this.expressionMap.mainAlias.metadata;if(!l.versionColumn&&!l.updateDateColumn)throw new x0(l.name)}const t=new X_(this.connection,e,this.expressionMap.relationIdAttributes),n=new ex(this.connection,e,this.expressionMap.relationCountAttributes);new Z_(this.expressionMap).transform(),new tx(this.expressionMap).transform();let a=[],o=[];if((this.expressionMap.skip||this.expressionMap.take)&&this.expressionMap.joinAttributes.length>0){const[l,h]=this.createOrderByCombinedWithSelectExpression("distinctAlias"),d=this.expressionMap.mainAlias.metadata,p=this.expressionMap.mainAlias.name,m=d.primaryColumns.map(S=>{const R=this.escape("distinctAlias"),$=this.escape(ie.buildAlias(this.connection.driver,void 0,p,S.databaseName));h[$]||(h[$]="ASC");const q=ie.buildAlias(this.connection.driver,void 0,"ids_"+p,S.databaseName);return`${R}.${$} AS ${this.escape(q)}`}),w=this.clone(),b=w.expressionMap.timeTravel;if(a=await new zs(this.connection,e).select(`DISTINCT ${m.join(", ")}`).addSelect(l).from(`(${w.orderBy().timeTravelQuery(!1).getQuery()})`,"distinctAlias").timeTravelQuery(b).offset(this.expressionMap.skip).limit(this.expressionMap.take).orderBy(h).cache(this.expressionMap.cache&&this.expressionMap.cacheId?`${this.expressionMap.cacheId}-pagination`:this.expressionMap.cache,this.expressionMap.cacheDuration).setParameters(this.getParameters()).setNativeParameters(this.expressionMap.nativeParameters).getRawMany(),a.length>0){let S="";const R={};if(d.hasMultiplePrimaryKeys)S=a.map(($,q)=>d.primaryColumns.map(O=>{const J=`orm_distinct_ids_${q}_${O.databaseName}`,ne=ie.buildAlias(this.connection.driver,void 0,"ids_"+p,O.databaseName);return R[J]=$[ne],`${p}.${O.propertyPath}=:${J}`}).join(" AND ")).join(" OR ");else{const $=ie.buildAlias(this.connection.driver,void 0,"ids_"+p,d.primaryColumns[0].databaseName),q=a.map(J=>J[$]);q.every(J=>typeof J=="number")?S=`${p}.${d.primaryColumns[0].propertyPath} IN (${q.join(", ")})`:(R.orm_distinct_ids=q,S=p+"."+d.primaryColumns[0].propertyPath+" IN (:...orm_distinct_ids)")}a=await this.clone().mergeExpressionMap({extraAppendedAndWhereCondition:S}).setParameters(R).loadRawResults(e)}}else a=await this.loadRawResults(e);if(a.length>0){const l=await t.load(a),h=await n.load(a);o=new J_(this.expressionMap,this.connection.driver,l,h,this.queryRunner).transform(a,this.expressionMap.mainAlias),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await e.broadcaster.broadcast("Load",this.expressionMap.mainAlias.metadata,o)}if(this.expressionMap.relationLoadStrategy==="query"){const l=new Ay(this.connection,e);await Promise.all(this.relationMetadatas.map(async h=>{const d=h.inverseEntityMetadata.target,p=h.inverseEntityMetadata.targetName,m=Array.isArray(this.findOptions.select)?re.propertyPathsToTruthyObject(this.findOptions.select):this.findOptions.select,w=Array.isArray(this.findOptions.relations)?re.propertyPathsToTruthyObject(this.findOptions.relations):this.findOptions.relations,b=this.createQueryBuilder(e).select(p).from(d,p).setFindOptions({select:m?re.deepValue(m,h.propertyPath):void 0,order:this.findOptions.order?re.deepValue(this.findOptions.order,h.propertyPath):void 0,relations:w?re.deepValue(w,h.propertyPath):void 0,withDeleted:this.findOptions.withDeleted,relationLoadStrategy:this.findOptions.relationLoadStrategy});if(o.length>0){const S=await l.loadManyToManyRelationIdsAndGroup(h,o,void 0,b);o.forEach(R=>{const $=S.find(q=>q.entity===R);if($){const q=$.related===void 0?null:$.related;h.setEntityValue(R,q)}})}}))}return{raw:a,entities:o}}createOrderByCombinedWithSelectExpression(e){const t=this.expressionMap.allOrderBys,n=Object.keys(t).map(i=>{if(i.indexOf(".")!==-1){const a=i.split("."),o=a[0],l=a.slice(1).join("."),d=this.expressionMap.findAliasByName(o).metadata.findColumnWithPropertyPath(l);return this.escape(e)+"."+this.escape(ie.buildAlias(this.connection.driver,void 0,o,d.databaseName))}else return this.expressionMap.selects.find(a=>a.selection===i||a.aliasName===i)?this.escape(e)+"."+this.escape(i):""}).join(", "),r={};return Object.keys(t).forEach(i=>{if(i.indexOf(".")!==-1){const a=i.split("."),o=a[0],l=a.slice(1).join("."),d=this.expressionMap.findAliasByName(o).metadata.findColumnWithPropertyPath(l);r[this.escape(e)+"."+this.escape(ie.buildAlias(this.connection.driver,void 0,o,d.databaseName))]=t[i]}else this.expressionMap.selects.find(a=>a.selection===i||a.aliasName===i)?r[this.escape(e)+"."+this.escape(i)]=t[i]:r[i]=t[i]}),[n,r]}async loadRawResults(e){const[t,n]=this.getQueryAndParameters(),r=t+" -- PARAMETERS: "+JSON.stringify(n,(d,p)=>typeof p=="bigint"?p.toString():p),i=typeof this.connection.options.cache=="object"?this.connection.options.cache:{};let a;const o=i.alwaysEnabled&&this.expressionMap.cache!==!1||this.expressionMap.cache===!0;let l=!1;if(this.connection.queryResultCache&&o)try{if(a=await this.connection.queryResultCache.getFromCache({identifier:this.expressionMap.cacheId,query:r,duration:this.expressionMap.cacheDuration||i.duration||1e3},e),a&&!this.connection.queryResultCache.isExpired(a))return JSON.parse(a.result)}catch(d){if(!i.ignoreErrors)throw d;l=!0}const h=await e.query(t,n,!0);if(!l&&this.connection.queryResultCache&&o)try{await this.connection.queryResultCache.storeInCache({identifier:this.expressionMap.cacheId,query:r,time:Date.now(),duration:this.expressionMap.cacheDuration||i.duration||1e3,result:JSON.stringify(h.records)},a,e)}catch(d){if(!i.ignoreErrors)throw d}return h.records}mergeExpressionMap(e){return Re.assign(this.expressionMap,e),this}normalizeNumber(e){return typeof e=="number"||e===void 0||e===null?e:Number(e)}obtainQueryRunner(){return this.queryRunner||this.connection.createQueryRunner(this.connection.defaultReplicationModeForReads())}buildSelect(e,t,n,r){for(const i in e){if(e[i]===void 0||e[i]===!1)continue;const a=r?r+"."+i:i,o=t.findColumnWithPropertyPathStrict(a),l=t.findEmbeddedWithPropertyPath(a),h=t.findRelationWithPropertyPath(a);if(!l&&!o&&!h)throw new Gn(a,t);o?this.selects.push(n+"."+a):l&&this.buildSelect(e[i],t,n,a)}}buildRelations(e,t,n,r,i){e&&Object.keys(e).forEach(a=>{const o=e[a],l=i?i+"."+a:a,h=n.findEmbeddedWithPropertyPath(l),d=n.findRelationWithPropertyPath(l);if(!h&&!d)throw new Gn(l,n);if(h)this.buildRelations(o,typeof t=="object"?re.deepValue(t,h.propertyPath):void 0,n,r,l);else if(d){let p=r+"_"+l.replace(".","_");p=ie.buildAlias(this.connection.driver,{joiner:"__"},r,p),(o===!0||typeof o=="object")&&(this.expressionMap.relationLoadStrategy==="query"?this.concatRelationMetadata(d):(this.joins.push({type:"left",select:!0,selection:t&&typeof t[a]=="object"?t[a]:void 0,alias:p,parentAlias:r,relationMetadata:d}),t&&typeof t[a]=="object"&&this.buildSelect(t[a],d.inverseEntityMetadata,p))),typeof o=="object"&&this.expressionMap.relationLoadStrategy==="join"&&this.buildRelations(o,typeof t=="object"?re.deepValue(t,d.propertyPath):void 0,d.inverseEntityMetadata,p,void 0)}})}buildEagerRelations(e,t,n,r,i){e&&Object.keys(e).forEach(a=>{const o=e[a],l=i?i+"."+a:a,h=n.findEmbeddedWithPropertyPath(l),d=n.findRelationWithPropertyPath(l);if(!h&&!d)throw new Gn(l,n);if(h)this.buildEagerRelations(o,typeof t=="object"?re.deepValue(t,h.propertyPath):void 0,n,r,l);else if(d){let p=r+"_"+l.replace(".","_");p=ie.buildAlias(this.connection.driver,{joiner:"__"},r,p),(o===!0||typeof o=="object")&&d.inverseEntityMetadata.eagerRelations.forEach(m=>{let w=p+"_"+m.propertyPath.replace(".","_");w=ie.buildAlias(this.connection.driver,{joiner:"__"},p,w),this.joins.find(S=>S.alias===w)||this.joins.push({type:"left",select:!0,alias:w,parentAlias:p,selection:void 0,relationMetadata:m}),t&&typeof t[a]=="object"&&this.buildSelect(t[a],d.inverseEntityMetadata,p)}),typeof o=="object"&&this.buildEagerRelations(o,typeof t=="object"?re.deepValue(t,d.propertyPath):void 0,d.inverseEntityMetadata,p,void 0)}})}buildOrder(e,t,n,r){for(const i in e){if(e[i]===void 0)continue;const a=r?r+"."+i:i,o=t.findColumnWithPropertyPathStrict(a),l=t.findEmbeddedWithPropertyPath(a),h=t.findRelationWithPropertyPath(a);if(!l&&!o&&!h)throw new Gn(a,t);if(o){let d=typeof e[i]=="object"?e[i].direction:e[i];d=d==="DESC"||d==="desc"||d===-1?"DESC":"ASC";let p=typeof e[i]=="object"?e[i].nulls:void 0;p=(p==null?void 0:p.toLowerCase())==="first"?"NULLS FIRST":(p==null?void 0:p.toLowerCase())==="last"?"NULLS LAST":void 0;const m=`${n}.${a}`;this.addOrderBy(m,d,p)}else if(l)this.buildOrder(e[i],t,n,a);else if(h){let d=n+"_"+a.replace(".","_");d=ie.buildAlias(this.connection.driver,{joiner:"__"},n,d),this.joins.find(m=>m.alias===d)||this.joins.push({type:"left",select:!1,alias:d,parentAlias:n,selection:void 0,relationMetadata:h}),this.buildOrder(e[i],h.inverseEntityMetadata,d)}}}buildWhere(e,t,n,r){var a,o,l;let i="";if(Array.isArray(e))e.length&&(i=e.map(h=>this.buildWhere(h,t,n,r)).filter(h=>!!h).map(h=>"("+h+")").join(" OR "));else{const h=[];for(const d in e){let p=e[d];const m=r?r+"."+d:d,w=t.findColumnWithPropertyPathStrict(m),b=t.findEmbeddedWithPropertyPath(m),S=t.findRelationWithPropertyPath(m);if(!b&&!w&&!S)throw new Gn(m,t);if(p===void 0){if((((a=this.connection.options.invalidWhereValuesBehavior)==null?void 0:a.undefined)||"ignore")==="throw")throw new x(`Undefined value encountered in property '${n}.${d}' of a where condition. Set 'invalidWhereValuesBehavior.undefined' to 'ignore' in connection options to skip properties with undefined values.`);continue}if(p===null){const R=((o=this.connection.options.invalidWhereValuesBehavior)==null?void 0:o.null)||"ignore";if(R==="ignore")continue;if(R==="throw")throw new x(`Null value encountered in property '${n}.${d}' of a where condition. To match with SQL NULL, the IsNull() operator must be used. Set 'invalidWhereValuesBehavior.null' to 'ignore' or 'sql-null' in connection options to skip or handle null values.`)}if(w){let R=`${n}.${m}`;if(w.isVirtualProperty&&w.query&&(R=`(${w.query(this.escape(n))})`),p===null){h.push(`${R} IS NULL`);continue}B.isEqualOperator(e[d])&&(p=e[d].value),w.transformer&&(p instanceof ps?p.transformValue(w.transformer):p=It.transformTo(w.transformer,p)),this.connection.driver.options.type==="mssql"&&(p=this.connection.driver.parametrizeValues(w,p)),h.push(this.createWhereConditionExpression(this.getWherePredicateCondition(R,p)))}else if(b){const R=this.buildWhere(e[d],t,n,m);R&&h.push(R)}else if(S){if(e[d]===null){const R=((l=this.connection.options.invalidWhereValuesBehavior)==null?void 0:l.null)||"ignore";if(R==="sql-null")h.push(`${n}.${m} IS NULL`);else if(R==="throw")throw new x(`Null value encountered in property '${n}.${d}' of a where condition. Set 'invalidWhereValuesBehavior.null' to 'ignore' or 'sql-null' in connection options to skip or handle null values.`);continue}if(typeof e[d]=="object"&&Object.keys(e[d]).every($=>e[d][$]===void 0))continue;if(B.isFindOperator(e[d]))if(e[d].type==="moreThan"||e[d].type==="lessThan"||e[d].type==="moreThanOrEqual"||e[d].type==="lessThanOrEqual"){let R="";e[d].type==="moreThan"?R=">":e[d].type==="lessThan"?R="<":e[d].type==="moreThanOrEqual"?R=">=":e[d].type==="lessThanOrEqual"&&(R="<=");const $=this.subQuery();if(S.isManyToManyOwner)$.select("COUNT(*)").from(S.joinTableName,S.joinTableName).where(S.joinColumns.map(q=>`${S.joinTableName}.${q.propertyName} = ${n}.${q.referencedColumn.propertyName}`).join(" AND "));else if(S.isManyToManyNotOwner)$.select("COUNT(*)").from(S.inverseRelation.joinTableName,S.inverseRelation.joinTableName).where(S.inverseRelation.inverseJoinColumns.map(q=>`${S.inverseRelation.joinTableName}.${q.propertyName} = ${n}.${q.referencedColumn.propertyName}`).join(" AND "));else if(S.isOneToMany)$.select("COUNT(*)").from(S.inverseEntityMetadata.target,S.inverseEntityMetadata.tableName).where(S.inverseRelation.joinColumns.map(q=>`${S.inverseEntityMetadata.tableName}.${q.propertyName} = ${n}.${q.referencedColumn.propertyName}`).join(" AND "));else throw new Error("This relation isn't supported by given find operator");this.andWhere($.getSql()+" "+R+" "+parseInt(e[d].value))}else if(S.isManyToOne||S.isOneToOne&&S.isOneToOneOwner){const R=`${n}.${m}`;h.push(this.createWhereConditionExpression(this.getWherePredicateCondition(R,e[d])))}else throw new Error("This relation isn't supported by given find operator");else{let R=n+"_"+S.propertyPath.replace(".","_");R=ie.buildAlias(this.connection.driver,{joiner:"__"},n,R),this.joins.find(O=>O.alias===R)||this.joins.push({type:"left",select:!1,selection:void 0,alias:R,parentAlias:n,relationMetadata:S});const q=this.buildWhere(e[d],S.inverseEntityMetadata,R);q&&h.push(q)}}}i=h.length?"("+h.join(") AND (")+")":h.join(" AND ")}return i.length?"("+i+")":i}}class Ny{constructor(){this.generatedMaps=[]}static from(e){const t=new this;return t.raw=e.records,t.affected=e.affected,t}}class nx extends Nt{constructor(e,t){super(e,t),this["@instanceof"]=Symbol.for("SoftDeleteQueryBuilder"),this.expressionMap.aliasNamePrefixingEnabled=!1}getQuery(){let e=this.createUpdateExpression();return e+=this.createCteExpression(),e+=this.createOrderByExpression(),e+=this.createLimitExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&(this.expressionMap.queryType==="soft-delete"?await e.broadcaster.broadcast("BeforeSoftRemove",this.expressionMap.mainAlias.metadata):this.expressionMap.queryType==="restore"&&await e.broadcaster.broadcast("BeforeRecover",this.expressionMap.mainAlias.metadata));const n=new sh(e,this.expressionMap);this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&(this.expressionMap.extraReturningColumns=n.getSoftDeletionReturningColumns());const[r,i]=this.getQueryAndParameters(),a=await e.query(r,i,!0),o=Ny.from(a);return this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&await n.update(o,this.expressionMap.whereEntities),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&(this.expressionMap.queryType==="soft-delete"?await e.broadcaster.broadcast("AfterSoftRemove",this.expressionMap.mainAlias.metadata):this.expressionMap.queryType==="restore"&&await e.broadcaster.broadcast("AfterRecover",this.expressionMap.mainAlias.metadata)),t&&await e.commitTransaction(),o}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}from(e,t){e=B.isEntitySchema(e)?e.options.name:e;const n=this.createFromAlias(e,t);return this.expressionMap.setMainAlias(n),this}where(e,t){this.expressionMap.wheres=[];const n=this.getWhereCondition(e);return n&&(this.expressionMap.wheres=[{type:"simple",condition:n}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("update"))throw new zo;return this.expressionMap.returning=e,this}orderBy(e,t="ASC",n){return e?typeof e=="object"?this.expressionMap.orderBys=e:n?this.expressionMap.orderBys={[e]:{order:t,nulls:n}}:this.expressionMap.orderBys={[e]:t}:this.expressionMap.orderBys={},this}addOrderBy(e,t="ASC",n){return n?this.expressionMap.orderBys[e]={order:t,nulls:n}:this.expressionMap.orderBys[e]=t,this}limit(e){return this.expressionMap.limit=e,this}whereEntity(e){if(!this.expressionMap.mainAlias.hasMetadata)throw new x(".whereEntity method can only be used on queries which update real entity table.");this.expressionMap.wheres=[];const t=Array.isArray(e)?e:[e];return t.forEach(n=>{const r=this.expressionMap.mainAlias.metadata.getEntityIdMap(n);if(!r)throw new x("Provided entity does not have ids set, cannot perform operation.");this.orWhereInIds(r)}),this.expressionMap.whereEntities=t,this}updateEntity(e){return this.expressionMap.updateEntity=e,this}createUpdateExpression(){const e=this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata:void 0;if(!e)throw new x(`Cannot get entity metadata for the given alias "${this.expressionMap.mainAlias}"`);if(!e.deleteDateColumn)throw new N0(e);const t=[];switch(this.expressionMap.queryType){case"soft-delete":t.push(this.escape(e.deleteDateColumn.databaseName)+" = CURRENT_TIMESTAMP");break;case"restore":t.push(this.escape(e.deleteDateColumn.databaseName)+" = NULL");break;default:throw new x('The queryType must be "soft-delete" or "restore"')}if(e.versionColumn&&t.push(this.escape(e.versionColumn.databaseName)+" = "+this.escape(e.versionColumn.databaseName)+" + 1"),e.updateDateColumn&&t.push(this.escape(e.updateDateColumn.databaseName)+" = CURRENT_TIMESTAMP"),t.length<=0)throw new ml;const n=this.createWhereExpression(),r=this.createReturningExpression("update");return r===""?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${t.join(", ")}${n}`:this.connection.driver.options.type==="mssql"?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${t.join(", ")} OUTPUT ${r}${n}`:`UPDATE ${this.getTableName(this.getMainTableName())} SET ${t.join(", ")}${n} RETURNING ${r}`}createOrderByExpression(){const e=this.expressionMap.orderBys;return Object.keys(e).length>0?" ORDER BY "+Object.keys(e).map(t=>typeof e[t]=="string"?this.replacePropertyNames(t)+" "+e[t]:this.replacePropertyNames(t)+" "+e[t].order+" "+e[t].nulls).join(", "):""}createLimitExpression(){const e=this.expressionMap.limit;if(e){if(ie.isMySQLFamily(this.connection.driver))return" LIMIT "+e;throw new iy}return""}}class rx extends Nt{constructor(e,t){super(e,t),this["@instanceof"]=Symbol.for("UpdateQueryBuilder"),this.expressionMap.aliasNamePrefixingEnabled=!1}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createUpdateExpression(),e+=this.createOrderByExpression(),e+=this.createLimitExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await e.broadcaster.broadcast("BeforeUpdate",this.expressionMap.mainAlias.metadata,this.expressionMap.valuesSet);let n=null,r=null;const i=new sh(e,this.expressionMap),a=[];if(Array.isArray(this.expressionMap.returning)&&this.expressionMap.mainAlias.hasMetadata)for(const m of this.expressionMap.returning)a.push(...this.expressionMap.mainAlias.metadata.findColumnsWithPropertyPath(m));this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&(this.expressionMap.extraReturningColumns=i.getUpdationReturningColumns(),a.push(...this.expressionMap.extraReturningColumns.filter(m=>!a.includes(m)))),a.length>0&&this.connection.driver.options.type==="mssql"&&(n=this.connection.driver.buildTableVariableDeclaration("@OutputTable",a),r="SELECT * FROM @OutputTable");const[o,l]=this.getQueryAndParameters(),h=[n,o,r],d=await e.query(h.filter(m=>m!=null).join(`;

`),l,!0),p=Ny.from(d);return this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&await i.update(p,this.expressionMap.whereEntities),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await e.broadcaster.broadcast("AfterUpdate",this.expressionMap.mainAlias.metadata,this.expressionMap.valuesSet),t&&await e.commitTransaction(),p}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}set(e){return this.expressionMap.valuesSet=e,this}where(e,t){this.expressionMap.wheres=[];const n=this.getWhereCondition(e);return n&&(this.expressionMap.wheres=[{type:"simple",condition:n}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("update"))throw new zo;return this.expressionMap.returning=e,this}orderBy(e,t="ASC",n){return e?typeof e=="object"?this.expressionMap.orderBys=e:n?this.expressionMap.orderBys={[e]:{order:t,nulls:n}}:this.expressionMap.orderBys={[e]:t}:this.expressionMap.orderBys={},this}addOrderBy(e,t="ASC",n){return n?this.expressionMap.orderBys[e]={order:t,nulls:n}:this.expressionMap.orderBys[e]=t,this}limit(e){return this.expressionMap.limit=e,this}whereEntity(e){if(!this.expressionMap.mainAlias.hasMetadata)throw new x(".whereEntity method can only be used on queries which update real entity table.");this.expressionMap.wheres=[];const t=Array.isArray(e)?e:[e];return t.forEach(n=>{const r=this.expressionMap.mainAlias.metadata.getEntityIdMap(n);if(!r)throw new x("Provided entity does not have ids set, cannot perform operation.");this.orWhereInIds(r)}),this.expressionMap.whereEntities=t,this}updateEntity(e){return this.expressionMap.updateEntity=e,this}createUpdateExpression(){const e=this.getValueSet(),t=this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata:void 0,n={};for(const l in e)e[l]!==void 0&&(n[l]=e[l]);const r=[],i=[];if(t?(this.createPropertyPath(t,n).forEach(l=>{const h=t.findColumnsWithPropertyPath(l);if(h.length<=0)throw new Gn(l,t);h.forEach(d=>{if(!d.isUpdate||i.includes(d))return;i.push(d);let p=d.getEntityValue(n);if(d.referencedColumn&&typeof p=="object"&&!(p instanceof Date)&&p!==null&&!Buffer.isBuffer(p)?p=d.referencedColumn.getEntityValue(p):typeof p!="function"&&(p=this.connection.driver.preparePersistentValue(p,d)),typeof p=="function")r.push(this.escape(d.databaseName)+" = "+p());else if((this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner")&&p===null)r.push(this.escape(d.databaseName)+" = NULL");else{this.connection.driver.options.type==="mssql"&&(p=this.connection.driver.parametrizeValue(d,p));const m=this.createParameter(p);let w=null;if((ie.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&this.connection.driver.spatialTypes.indexOf(d.type)!==-1){const S=this.connection.driver.options.legacySpatialSupport?"GeomFromText":"ST_GeomFromText";d.srid!=null?w=`${S}(${m}, ${d.srid})`:w=`${S}(${m})`}else ie.isPostgresFamily(this.connection.driver)&&this.connection.driver.spatialTypes.indexOf(d.type)!==-1?d.srid!=null?w=`ST_SetSRID(ST_GeomFromGeoJSON(${m}), ${d.srid})::${d.type}`:w=`ST_GeomFromGeoJSON(${m})::${d.type}`:this.connection.driver.options.type==="mssql"&&this.connection.driver.spatialTypes.indexOf(d.type)!==-1?w=d.type+"::STGeomFromText("+m+", "+(d.srid||"0")+")":w=m;r.push(this.escape(d.databaseName)+" = "+w)}})}),(r.length>0||Object.keys(n).length===0)&&(t.versionColumn&&i.indexOf(t.versionColumn)===-1&&r.push(this.escape(t.versionColumn.databaseName)+" = "+this.escape(t.versionColumn.databaseName)+" + 1"),t.updateDateColumn&&i.indexOf(t.updateDateColumn)===-1&&r.push(this.escape(t.updateDateColumn.databaseName)+" = CURRENT_TIMESTAMP"))):Object.keys(n).map(l=>{const h=n[l];if(typeof h=="function")r.push(this.escape(l)+" = "+h());else if((this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner")&&h===null)r.push(this.escape(l)+" = NULL");else{const d=this.createParameter(h);r.push(this.escape(l)+" = "+d)}}),r.length<=0)throw new ml;const a=this.createWhereExpression(),o=this.createReturningExpression("update");return o===""?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${r.join(", ")}${a}`:this.connection.driver.options.type==="mssql"?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${r.join(", ")} OUTPUT ${o}${a}`:this.connection.driver.options.type==="spanner"?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${r.join(", ")}${a} THEN RETURN ${o}`:`UPDATE ${this.getTableName(this.getMainTableName())} SET ${r.join(", ")}${a} RETURNING ${o}`}createOrderByExpression(){const e=this.expressionMap.orderBys;return Object.keys(e).length>0?" ORDER BY "+Object.keys(e).map(t=>typeof e[t]=="string"?this.replacePropertyNames(t)+" "+e[t]:this.replacePropertyNames(t)+" "+e[t].order+" "+e[t].nulls).join(", "):""}createLimitExpression(){const e=this.expressionMap.limit;if(e){if(ie.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")return" LIMIT "+e;throw new iy}return""}getValueSet(){if(typeof this.expressionMap.valuesSet=="object")return this.expressionMap.valuesSet;throw new ml}}function Cy(){Nt.registerQueryBuilderClass("DeleteQueryBuilder",s=>new W_(s)),Nt.registerQueryBuilderClass("InsertQueryBuilder",s=>new G_(s)),Nt.registerQueryBuilderClass("RelationQueryBuilder",s=>new K_(s)),Nt.registerQueryBuilderClass("SelectQueryBuilder",s=>new zs(s)),Nt.registerQueryBuilderClass("SoftDeleteQueryBuilder",s=>new nx(s)),Nt.registerQueryBuilderClass("UpdateQueryBuilder",s=>new rx(s))}class ei{static sha1(e){const t=function(ne,ge){return ne<<ge|ne>>>32-ge},n=function(ne){let ge="",pe,me;for(pe=7;pe>=0;pe--)me=ne>>>pe*4&15,ge+=me.toString(16);return ge};let r,i,a;const o=new Array(80);let l=1732584193,h=4023233417,d=2562383102,p=271733878,m=3285377520,w,b,S,R,$,q;e=encodeURIComponent(e);const O=e.length,J=[];for(i=0;i<O-3;i+=4)a=e.charCodeAt(i)<<24|e.charCodeAt(i+1)<<16|e.charCodeAt(i+2)<<8|e.charCodeAt(i+3),J.push(a);switch(O%4){case 0:i=2147483648;break;case 1:i=e.charCodeAt(O-1)<<24|8388608;break;case 2:i=e.charCodeAt(O-2)<<24|e.charCodeAt(O-1)<<16|32768;break;case 3:i=e.charCodeAt(O-3)<<24|e.charCodeAt(O-2)<<16|e.charCodeAt(O-1)<<8|128;break}for(J.push(i);J.length%16!==14;)J.push(0);for(J.push(O>>>29),J.push(O<<3&4294967295),r=0;r<J.length;r+=16){for(i=0;i<16;i++)o[i]=J[r+i];for(i=16;i<=79;i++)o[i]=t(o[i-3]^o[i-8]^o[i-14]^o[i-16],1);for(w=l,b=h,S=d,R=p,$=m,i=0;i<=19;i++)q=t(w,5)+(b&S|~b&R)+$+o[i]+1518500249&4294967295,$=R,R=S,S=t(b,30),b=w,w=q;for(i=20;i<=39;i++)q=t(w,5)+(b^S^R)+$+o[i]+1859775393&4294967295,$=R,R=S,S=t(b,30),b=w,w=q;for(i=40;i<=59;i++)q=t(w,5)+(b&S|b&R|S&R)+$+o[i]+2400959708&4294967295,$=R,R=S,S=t(b,30),b=w,w=q;for(i=60;i<=79;i++)q=t(w,5)+(b^S^R)+$+o[i]+3395469782&4294967295,$=R,R=S,S=t(b,30),b=w,w=q;l=l+w&4294967295,h=h+b&4294967295,d=d+S&4294967295,p=p+R&4294967295,m=m+$&4294967295}return q=n(l)+n(h)+n(d)+n(p)+n(m),q.toLowerCase()}}class ix{constructor(){this.nestedSetColumnNames={left:"nsleft",right:"nsright"},this.materializedPathColumnName="mpath"}getTableName(e){return typeof e!="string"&&(e=e.name),e.split(".").pop()}tableName(e,t){return t||Ip(e)}closureJunctionTableName(e){return e+"_closure"}columnName(e,t,n){const r=t||e;return n.length?Hu(n.join("_"))+L_(r):r}relationName(e){return e}primaryKeyName(e,t){const n=[...t];n.sort();const a=`${this.getTableName(e).replace(".","_")}_${n.join("_")}`;return"PK_"+ei.sha1(a).substr(0,27)}uniqueConstraintName(e,t){const n=[...t];n.sort();const a=`${this.getTableName(e).replace(".","_")}_${n.join("_")}`;return"UQ_"+ei.sha1(a).substr(0,27)}relationConstraintName(e,t,n){const r=[...t];r.sort();let o=`${this.getTableName(e).replace(".","_")}_${r.join("_")}`;return n&&(o+=`_${n}`),"REL_"+ei.sha1(o).substr(0,26)}defaultConstraintName(e,t){const i=`${this.getTableName(e).replace(".","_")}_${t}`;return"DF_"+ei.sha1(i).substr(0,27)}foreignKeyName(e,t,n,r){const i=[...t];i.sort();const l=`${this.getTableName(e).replace(".","_")}_${i.join("_")}`;return"FK_"+ei.sha1(l).substr(0,27)}indexName(e,t,n){const r=[...t];r.sort();let o=`${this.getTableName(e).replace(".","_")}_${r.join("_")}`;return n&&(o+=`_${n}`),"IDX_"+ei.sha1(o).substr(0,26)}checkConstraintName(e,t,n){const a=`${this.getTableName(e).replace(".","_")}_${t}`,o="CHK_"+ei.sha1(a).substr(0,26);return n?`${o}_ENUM`:o}exclusionConstraintName(e,t){const i=`${this.getTableName(e).replace(".","_")}_${t}`;return"XCL_"+ei.sha1(i).substr(0,26)}joinColumnName(e,t){return Hu(e+"_"+t)}joinTableName(e,t,n,r){return Ip(e+"_"+n.replace(/\./gi,"_")+"_"+t)}joinTableColumnDuplicationPrefix(e,t){return e+"_"+t}joinTableColumnName(e,t,n){return Hu(e+"_"+(n||t))}joinTableInverseColumnName(e,t,n){return this.joinTableColumnName(e,t,n)}prefixTableName(e,t){return e+t}}class ln{constructor(e){this["@instanceof"]=Symbol.for("TableColumn"),this.isNullable=!1,this.isGenerated=!1,this.isPrimary=!1,this.isUnique=!1,this.isArray=!1,this.length="",this.zerofill=!1,this.unsigned=!1,e&&(this.name=e.name,this.type=e.type||"",this.length=e.length||"",this.width=e.width,this.charset=e.charset,this.collation=e.collation,this.precision=e.precision,this.scale=e.scale,this.zerofill=e.zerofill||!1,this.unsigned=this.zerofill?!0:e.unsigned||!1,this.default=e.default,this.onUpdate=e.onUpdate,this.isNullable=e.isNullable||!1,this.isGenerated=e.isGenerated||!1,this.generationStrategy=e.generationStrategy,this.generatedIdentity=e.generatedIdentity,this.isPrimary=e.isPrimary||!1,this.isUnique=e.isUnique||!1,this.isArray=e.isArray||!1,this.comment=e.comment,this.enum=e.enum,this.enumName=e.enumName,this.primaryKeyConstraintName=e.primaryKeyConstraintName,this.asExpression=e.asExpression,this.generatedType=e.generatedType,this.spatialFeatureType=e.spatialFeatureType,this.srid=e.srid)}clone(){return new ln({name:this.name,type:this.type,length:this.length,width:this.width,charset:this.charset,collation:this.collation,precision:this.precision,scale:this.scale,zerofill:this.zerofill,unsigned:this.unsigned,enum:this.enum,enumName:this.enumName,primaryKeyConstraintName:this.primaryKeyConstraintName,asExpression:this.asExpression,generatedType:this.generatedType,default:this.default,onUpdate:this.onUpdate,isNullable:this.isNullable,isGenerated:this.isGenerated,generationStrategy:this.generationStrategy,generatedIdentity:this.generatedIdentity,isPrimary:this.isPrimary,isUnique:this.isUnique,isArray:this.isArray,comment:this.comment,spatialFeatureType:this.spatialFeatureType,srid:this.srid})}}class Ct{constructor(e){this["@instanceof"]=Symbol.for("TableIndex"),this.columnNames=[],this.name=e.name,this.columnNames=e.columnNames,this.isUnique=!!e.isUnique,this.isSpatial=!!e.isSpatial,this.isConcurrent=!!e.isConcurrent,this.isFulltext=!!e.isFulltext,this.isNullFiltered=!!e.isNullFiltered,this.parser=e.parser,this.where=e.where?e.where:""}clone(){return new Ct({name:this.name,columnNames:[...this.columnNames],isUnique:this.isUnique,isSpatial:this.isSpatial,isConcurrent:this.isConcurrent,isFulltext:this.isFulltext,isNullFiltered:this.isNullFiltered,parser:this.parser,where:this.where})}static create(e){return new Ct({name:e.name,columnNames:e.columns.map(t=>t.databaseName),isUnique:e.isUnique,isSpatial:e.isSpatial,isConcurrent:e.isConcurrent,isFulltext:e.isFulltext,isNullFiltered:e.isNullFiltered,parser:e.parser,where:e.where})}}class Dn{constructor(e){this["@instanceof"]=Symbol.for("TableForeignKey"),this.columnNames=[],this.referencedColumnNames=[],this.name=e.name,this.columnNames=e.columnNames,this.referencedColumnNames=e.referencedColumnNames,this.referencedDatabase=e.referencedDatabase,this.referencedSchema=e.referencedSchema,this.referencedTableName=e.referencedTableName,this.onDelete=e.onDelete,this.onUpdate=e.onUpdate,this.deferrable=e.deferrable}clone(){return new Dn({name:this.name,columnNames:[...this.columnNames],referencedColumnNames:[...this.referencedColumnNames],referencedDatabase:this.referencedDatabase,referencedSchema:this.referencedSchema,referencedTableName:this.referencedTableName,onDelete:this.onDelete,onUpdate:this.onUpdate,deferrable:this.deferrable})}static create(e,t){return new Dn({name:e.name,columnNames:e.columnNames,referencedColumnNames:e.referencedColumnNames,referencedDatabase:e.referencedEntityMetadata.database,referencedSchema:e.referencedEntityMetadata.schema,referencedTableName:e.referencedTablePath,onDelete:e.onDelete,onUpdate:e.onUpdate,deferrable:e.deferrable})}}class bo{static createTableColumnOptions(e,t){return{name:e.databaseName,length:t.getColumnLength(e),width:e.width,charset:e.charset,collation:e.collation,precision:e.precision,scale:e.scale,zerofill:e.zerofill,unsigned:e.unsigned,asExpression:e.asExpression,generatedType:e.generatedType,default:t.normalizeDefault(e),onUpdate:e.onUpdate,comment:e.comment,isGenerated:e.isGenerated,generationStrategy:e.generationStrategy,generatedIdentity:e.generatedIdentity,isNullable:e.isNullable,type:t.normalizeType(e),isPrimary:e.isPrimary,isUnique:t.normalizeIsUnique(e),isArray:e.isArray||!1,enum:e.enum?e.enum.map(n=>n+""):e.enum,enumName:e.enumName,primaryKeyConstraintName:e.primaryKeyConstraintName,spatialFeatureType:e.spatialFeatureType,srid:e.srid}}}class Gt{constructor(e){this["@instanceof"]=Symbol.for("TableUnique"),this.columnNames=[],this.name=e.name,this.columnNames=e.columnNames,this.deferrable=e.deferrable}clone(){return new Gt({name:this.name,columnNames:[...this.columnNames],deferrable:this.deferrable})}static create(e){return new Gt({name:e.name,columnNames:e.columns.map(t=>t.databaseName),deferrable:e.deferrable})}}class Jn{constructor(e){this["@instanceof"]=Symbol.for("TableCheck"),this.columnNames=[],this.name=e.name,this.columnNames=e.columnNames,this.expression=e.expression}clone(){return new Jn({name:this.name,columnNames:this.columnNames?[...this.columnNames]:[],expression:this.expression})}static create(e){return new Jn({name:e.name,expression:e.expression})}}class Ri{constructor(e){this["@instanceof"]=Symbol.for("TableExclusion"),this.name=e.name,this.expression=e.expression}clone(){return new Ri({name:this.name,expression:this.expression})}static create(e){return new Ri({name:e.name,expression:e.expression})}}class gt{constructor(e){this["@instanceof"]=Symbol.for("Table"),this.columns=[],this.indices=[],this.foreignKeys=[],this.uniques=[],this.checks=[],this.exclusions=[],this.justCreated=!1,this.withoutRowid=!1,e&&(this.database=e.database,this.schema=e.schema,this.name=e.name,e.columns&&(this.columns=e.columns.map(t=>new ln(t))),e.indices&&(this.indices=e.indices.map(t=>new Ct(t))),e.foreignKeys&&(this.foreignKeys=e.foreignKeys.map(t=>new Dn({...t,referencedDatabase:(t==null?void 0:t.referencedDatabase)||e.database,referencedSchema:(t==null?void 0:t.referencedSchema)||e.schema}))),e.uniques&&(this.uniques=e.uniques.map(t=>new Gt(t))),e.checks&&(this.checks=e.checks.map(t=>new Jn(t))),e.exclusions&&(this.exclusions=e.exclusions.map(t=>new Ri(t))),e.justCreated!==void 0&&(this.justCreated=e.justCreated),e.withoutRowid&&(this.withoutRowid=e.withoutRowid),this.engine=e.engine,this.comment=e.comment)}get primaryColumns(){return this.columns.filter(e=>e.isPrimary)}clone(){return new gt({schema:this.schema,database:this.database,name:this.name,columns:this.columns.map(e=>e.clone()),indices:this.indices.map(e=>e.clone()),foreignKeys:this.foreignKeys.map(e=>e.clone()),uniques:this.uniques.map(e=>e.clone()),checks:this.checks.map(e=>e.clone()),exclusions:this.exclusions.map(e=>e.clone()),justCreated:this.justCreated,withoutRowid:this.withoutRowid,engine:this.engine,comment:this.comment})}addColumn(e){this.columns.push(e)}removeColumn(e){const t=this.columns.find(n=>n.name===e.name);t&&this.columns.splice(this.columns.indexOf(t),1)}addUniqueConstraint(e){if(this.uniques.push(e),e.columnNames.length===1){const t=this.columns.find(n=>n.name===e.columnNames[0]);t&&(t.isUnique=!0)}}removeUniqueConstraint(e){const t=this.uniques.find(n=>n.name===e.name);if(t&&(this.uniques.splice(this.uniques.indexOf(t),1),t.columnNames.length===1)){const n=this.columns.find(r=>r.name===t.columnNames[0]);n&&(n.isUnique=!1)}}addCheckConstraint(e){this.checks.push(e)}removeCheckConstraint(e){const t=this.checks.find(n=>n.name===e.name);t&&this.checks.splice(this.checks.indexOf(t),1)}addExclusionConstraint(e){this.exclusions.push(e)}removeExclusionConstraint(e){const t=this.exclusions.find(n=>n.name===e.name);t&&this.exclusions.splice(this.exclusions.indexOf(t),1)}addForeignKey(e){this.foreignKeys.push(e)}removeForeignKey(e){const t=this.foreignKeys.find(n=>n.name===e.name);t&&this.foreignKeys.splice(this.foreignKeys.indexOf(t),1)}addIndex(e,t=!1){if(this.indices.push(e),e.columnNames.length===1&&e.isUnique&&t){const n=this.columns.find(r=>r.name===e.columnNames[0]);n&&(n.isUnique=!0)}}removeIndex(e,t=!1){const n=this.indices.find(r=>r.name===e.name);if(n&&(this.indices.splice(this.indices.indexOf(n),1),n.columnNames.length===1&&n.isUnique&&t)){const r=this.columns.find(i=>i.name===n.columnNames[0]);r&&(r.isUnique=this.indices.some(i=>i.columnNames.length===1&&i.columnNames[0]===r.name&&!!n.isUnique))}}findColumnByName(e){return this.columns.find(t=>t.name===e)}findColumnIndices(e){return this.indices.filter(t=>!!t.columnNames.find(n=>n===e.name))}findColumnForeignKeys(e){return this.foreignKeys.filter(t=>!!t.columnNames.find(n=>n===e.name))}findColumnUniques(e){return this.uniques.filter(t=>!!t.columnNames.find(n=>n===e.name))}findColumnChecks(e){return this.checks.filter(t=>!!t.columnNames.find(n=>n===e.name))}static create(e,t){const n=e.database===t.database?void 0:e.database,r=e.schema===t.options.schema?void 0:e.schema,i={database:e.database,schema:e.schema,name:t.buildTableName(e.tableName,r,n),withoutRowid:e.withoutRowid,engine:e.engine,columns:e.columns.filter(a=>a&&!a.isVirtualProperty).map(a=>bo.createTableColumnOptions(a,t)),indices:e.indices.filter(a=>a.synchronize===!0).map(a=>Ct.create(a)),uniques:e.uniques.map(a=>Gt.create(a)),checks:e.checks.map(a=>Jn.create(a)),exclusions:e.exclusions.map(a=>Ri.create(a)),comment:e.comment};return new gt(i)}}class Up{constructor(e,t,n,r,i){this.id=e,this.timestamp=t,this.name=n,this.instance=r,this.transaction=i}}class Hn{constructor(e,t,...n){this.value=e,this.type=t,this["@instanceof"]=Symbol.for("MssqlParameter"),this.params=[],this.params=n||[]}}class Gu{constructor(e,t){this.connection=e,this.queryRunner=t,this.transaction="all";const{schema:n}=this.connection.driver.options,r=this.connection.driver.database;this.migrationsDatabase=r,this.migrationsSchema=n,this.migrationsTableName=e.options.migrationsTableName||"migrations",this.migrationsTable=this.connection.driver.buildTableName(this.migrationsTableName,n,r)}async executeMigration(e){return this.withQueryRunner(async t=>{await this.createMigrationsTableIfNotExist(t);const n=this.connection.driver.createSchemaBuilder();return B.isRdbmsSchemaBuilder(n)&&await n.createMetadataTableIfNecessary(t),await t.beforeMigration(),await e.instance.up(t),await t.afterMigration(),await this.insertExecutedMigration(t,e),e})}async getAllMigrations(){return Promise.resolve(this.getMigrations())}async getExecutedMigrations(){return this.withQueryRunner(async e=>(await this.createMigrationsTableIfNotExist(e),await this.loadExecutedMigrations(e)))}async getPendingMigrations(){const e=await this.getAllMigrations(),t=await this.getExecutedMigrations();return e.filter(n=>!t.find(r=>r.name===n.name))}insertMigration(e){return this.withQueryRunner(t=>this.insertExecutedMigration(t,e))}deleteMigration(e){return this.withQueryRunner(t=>this.deleteExecutedMigration(t,e))}async showMigrations(){let e=!1;const t=this.queryRunner||this.connection.createQueryRunner();await this.createMigrationsTableIfNotExist(t);const n=await this.loadExecutedMigrations(t),r=this.getMigrations();for(const i of r){const a=n.find(o=>o.name===i.name);a?this.connection.logger.logSchemaBuild(`[X] ${a.id} ${i.name}`):(e=!0,this.connection.logger.logSchemaBuild(`[ ] ${i.name}`))}return this.queryRunner||await t.release(),e}async executePendingMigrations(){const e=this.queryRunner||this.connection.createQueryRunner();await this.createMigrationsTableIfNotExist(e);const t=this.connection.driver.createSchemaBuilder();B.isRdbmsSchemaBuilder(t)&&await t.createMetadataTableIfNecessary(e);const n=await this.loadExecutedMigrations(e),r=this.getLatestTimestampMigration(n),i=this.getMigrations(),a=[],o=i.filter(d=>!n.find(m=>m.name===d.name));if(!o.length)return this.connection.logger.logSchemaBuild("No migrations are pending"),this.queryRunner||await e.release(),[];if(this.connection.logger.logSchemaBuild(`${n.length} migrations are already loaded in the database.`),this.connection.logger.logSchemaBuild(`${i.length} migrations were found in the source code.`),r&&this.connection.logger.logSchemaBuild(`${r.name} is the last executed migration. It was executed on ${new Date(r.timestamp).toString()}.`),this.connection.logger.logSchemaBuild(`${o.length} migrations are new migrations must be executed.`),this.transaction==="all"){const d=o.filter(p=>{var m;return((m=p.instance)==null?void 0:m.transaction)!==void 0});if(d.length>0){const p=new F0(d);throw this.connection.logger.logMigration(`Migrations failed, error: ${p.message}`),p}}const l={each:!0,none:!1,all:!1}[this.transaction];for(const d of o)if(d.instance){const p=d.instance.transaction;p===void 0?d.transaction=l:d.transaction=p}let h=!1;this.transaction==="all"&&!e.isTransactionActive&&(await e.beforeMigration(),await e.startTransaction(),h=!0);try{for(const d of o){if(this.fake){await this.insertExecutedMigration(e,d);continue}d.transaction&&!e.isTransactionActive&&(await e.beforeMigration(),await e.startTransaction(),h=!0),await d.instance.up(e).catch(p=>{throw this.connection.logger.logMigration(`Migration "${d.name}" failed, error: ${p==null?void 0:p.message}`),p}).then(async()=>{await this.insertExecutedMigration(e,d),d.transaction&&h&&(await e.commitTransaction(),await e.afterMigration())}).then(()=>{a.push(d),this.connection.logger.logSchemaBuild(`Migration ${d.name} has been ${this.fake?"(fake) ":""}executed successfully.`)})}this.transaction==="all"&&h&&(await e.commitTransaction(),await e.afterMigration())}catch(d){if(h)try{await e.rollbackTransaction()}catch{}throw d}finally{this.queryRunner||await e.release()}return a}async undoLastMigration(){const e=this.queryRunner||this.connection.createQueryRunner();await this.createMigrationsTableIfNotExist(e);const t=this.connection.driver.createSchemaBuilder();B.isRdbmsSchemaBuilder(t)&&await t.createMetadataTableIfNecessary(e);const n=await this.loadExecutedMigrations(e),r=this.getLatestExecutedMigration(n);if(!r){this.connection.logger.logSchemaBuild("No migrations were found in the database. Nothing to revert!");return}const a=this.getMigrations().find(l=>l.name===r.name);if(!a)throw new x(`No migration ${r.name} was found in the source code. Make sure you have this migration in your codebase and its included in the connection options.`);this.connection.logger.logSchemaBuild(`${n.length} migrations are already loaded in the database.`),this.connection.logger.logSchemaBuild(`${r.name} is the last executed migration. It was executed on ${new Date(r.timestamp).toString()}.`),this.connection.logger.logSchemaBuild("Now reverting it...");let o=!1;this.transaction!=="none"&&!e.isTransactionActive&&(await e.startTransaction(),o=!0);try{this.fake||(await e.beforeMigration(),await a.instance.down(e),await e.afterMigration()),await this.deleteExecutedMigration(e,a),this.connection.logger.logSchemaBuild(`Migration ${a.name} has been ${this.fake?"(fake) ":""}reverted successfully.`),o&&await e.commitTransaction()}catch(l){if(o)try{await e.rollbackTransaction()}catch{}throw l}finally{this.queryRunner||await e.release()}}async createMigrationsTableIfNotExist(e){if(this.connection.driver.options.type==="mongodb")return;await e.hasTable(this.migrationsTable)||await e.createTable(new gt({database:this.migrationsDatabase,schema:this.migrationsSchema,name:this.migrationsTable,columns:[{name:"id",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.migrationId}),isGenerated:!0,generationStrategy:"increment",isPrimary:!0,isNullable:!1},{name:"timestamp",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.migrationTimestamp}),isPrimary:!1,isNullable:!1},{name:"name",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.migrationName}),isNullable:!1}]}))}async loadExecutedMigrations(e){return this.connection.driver.options.type==="mongodb"?e.cursor(this.migrationsTableName,{}).sort({_id:-1}).toArray():(await this.connection.manager.createQueryBuilder(e).select().orderBy(this.connection.driver.escape("id"),"DESC").from(this.migrationsTable,this.migrationsTableName).getRawMany()).map(n=>new Up(parseInt(n.id),parseInt(n.timestamp),n.name))}getMigrations(){const e=this.connection.migrations.map(t=>{const n=t.name||t.constructor.name,r=parseInt(n.substr(-13),10);if(!r||isNaN(r))throw new x(`${n} migration name is wrong. Migration class name should have a JavaScript timestamp appended.`);return new Up(void 0,r,n,t)});return this.checkForDuplicateMigrations(e),e.sort((t,n)=>t.timestamp-n.timestamp)}checkForDuplicateMigrations(e){const t=e.map(r=>r.name),n=Array.from(new Set(t.filter((r,i)=>t.indexOf(r)<i)));if(n.length>0)throw Error(`Duplicate migrations: ${n.join(", ")}`)}getLatestTimestampMigration(e){const t=e.map(n=>n).sort((n,r)=>(n.timestamp-r.timestamp)*-1);return t.length>0?t[0]:void 0}getLatestExecutedMigration(e){return e.length>0?e[0]:void 0}async insertExecutedMigration(e,t){const n={};this.connection.driver.options.type==="mssql"?(n.timestamp=new Hn(t.timestamp,this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.migrationTimestamp})),n.name=new Hn(t.name,this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.migrationName}))):(n.timestamp=t.timestamp,n.name=t.name),this.connection.driver.options.type==="mongodb"?await e.databaseConnection.db(this.connection.driver.database).collection(this.migrationsTableName).insertOne(n):await e.manager.createQueryBuilder().insert().into(this.migrationsTable).values(n).execute()}async deleteExecutedMigration(e,t){const n={};if(this.connection.driver.options.type==="mssql"?(n.timestamp=new Hn(t.timestamp,this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.migrationTimestamp})),n.name=new Hn(t.name,this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.migrationName}))):(n.timestamp=t.timestamp,n.name=t.name),this.connection.driver.options.type==="mongodb")await e.databaseConnection.db(this.connection.driver.database).collection(this.migrationsTableName).deleteOne(n);else{const r=e.manager.createQueryBuilder();await r.delete().from(this.migrationsTable).where(`${r.escape("timestamp")} = :timestamp`).andWhere(`${r.escape("name")} = :name`).setParameters(n).execute()}}async withQueryRunner(e){const t=this.queryRunner||this.connection.createQueryRunner();try{return await e(t)}finally{this.queryRunner||await t.release()}}}function so(s,e,t){const n=[],r={};return function i(a){r[a]=!0,n.push(a),s[a].forEach(function(o){if(!r[o])i(o);else if(n.indexOf(o)>=0)throw n.push(o),new x(`Dependency Cycle Found: ${n.join(" -> ")}`)}),n.pop(),(!e||s[a].length===0)&&t.indexOf(a)===-1&&t.push(a)}}class sx{constructor(){this.nodes={},this.outgoingEdges={},this.incomingEdges={}}addNode(e,t){this.hasNode(e)||(arguments.length===2?this.nodes[e]=t:this.nodes[e]=e,this.outgoingEdges[e]=[],this.incomingEdges[e]=[])}removeNode(e){this.hasNode(e)&&(delete this.nodes[e],delete this.outgoingEdges[e],delete this.incomingEdges[e],[this.incomingEdges,this.outgoingEdges].forEach(function(t){Object.keys(t).forEach(function(n){const r=t[n].indexOf(e);r>=0&&t[n].splice(r,1)})}))}hasNode(e){return this.nodes.hasOwnProperty(e)}getNodeData(e){if(this.hasNode(e))return this.nodes[e];throw new x(`Node does not exist: ${e}`)}setNodeData(e,t){if(this.hasNode(e))this.nodes[e]=t;else throw new x(`Node does not exist: ${e}`)}addDependency(e,t){if(!this.hasNode(e))throw new x(`Node does not exist: ${e}`);if(!this.hasNode(t))throw new x(`Node does not exist: ${t}`);return this.outgoingEdges[e].indexOf(t)===-1&&this.outgoingEdges[e].push(t),this.incomingEdges[t].indexOf(e)===-1&&this.incomingEdges[t].push(e),!0}removeDependency(e,t){let n;this.hasNode(e)&&(n=this.outgoingEdges[e].indexOf(t),n>=0&&this.outgoingEdges[e].splice(n,1)),this.hasNode(t)&&(n=this.incomingEdges[t].indexOf(e),n>=0&&this.incomingEdges[t].splice(n,1))}dependenciesOf(e,t){if(this.hasNode(e)){const n=[];so(this.outgoingEdges,t,n)(e);const i=n.indexOf(e);return i>=0&&n.splice(i,1),n}else throw new x(`Node does not exist: ${e}`)}dependantsOf(e,t){if(this.hasNode(e)){const n=[];so(this.incomingEdges,t,n)(e);const i=n.indexOf(e);return i>=0&&n.splice(i,1),n}else throw new x(`Node does not exist: ${e}`)}overallOrder(e){const t=this,n=[],r=Object.keys(this.nodes);if(r.length===0)return n;{const i=so(this.outgoingEdges,!1,[]);r.forEach(function(o){i(o)});const a=so(this.outgoingEdges,e,n);return r.filter(function(o){return t.incomingEdges[o].length===0}).forEach(function(o){a(o)}),n}}}class ax{validateMany(e,t){e.forEach(n=>this.validate(n,e,t)),this.validateDependencies(e),this.validateEagerRelations(e)}validate(e,t,n){if(!e.primaryColumns.length&&!e.isJunction)throw new v0(e);if(e.primaryColumns.length>1&&!e.primaryColumns.every((a,o,l)=>a.primaryKeyConstraintName===l[0].primaryKeyConstraintName))throw new x(`Entity ${e.name} has multiple primary columns with different constraint names. Constraint names should be the equal.`);if(e.inheritancePattern==="STI"||e.tableType==="entity-child"){if(!e.discriminatorColumn)throw new x(`Entity ${e.name} using single-table inheritance, it should also have a discriminator column. Did you forget to put discriminator column options?`);if(typeof e.discriminatorValue>"u")throw new x(`Entity ${e.name} has an undefined discriminator value. Discriminator value should be defined.`);const i=t.find(a=>a!==e&&(a.inheritancePattern==="STI"||a.tableType==="entity-child")&&a.tableName===e.tableName&&a.discriminatorValue===e.discriminatorValue&&a.inheritanceTree.some(o=>e.inheritanceTree.indexOf(o)!==-1));if(i)throw new x(`Entities ${e.name} and ${i.name} have the same discriminator values. Make sure they are different while using the @ChildEntity decorator.`)}if(e.relationCounts.forEach(i=>{if(i.relation.isManyToOne||i.relation.isOneToOne)throw new x("Relation count can not be implemented on ManyToOne or OneToOne relations.")}),n.options.type!=="mongodb"&&e.columns.filter(i=>!i.isVirtualProperty).forEach(i=>{const a=n.normalizeType(i);if(!n.supportedDataTypes.includes(a))throw new I0(i,a,n.options.type);if(i.length&&!n.withLengthColumnTypes.includes(a))throw new x(`Column ${i.propertyName} of Entity ${e.name} does not support length property.`);if(i.type==="enum"&&!i.enum&&!i.enumName)throw new x(`Column "${i.propertyName}" of Entity "${e.name}" is defined as enum, but missing "enum" or "enumName" properties.`)}),(ie.isMySQLFamily(n)||n.options.type==="aurora-mysql")&&e.columns.filter(a=>a.isGenerated&&a.generationStrategy!=="uuid").length>1)throw new x(`Error in ${e.name} entity. There can be only one auto-increment column in MySql table.`);if(ie.isMySQLFamily(n)&&t.filter(a=>a.database).length===0&&!n.database)throw new U0("database");if(n.options.type==="mssql"&&e.columns.filter(a=>a.charset).length>1)throw new x("Character set specifying is not supported in Sql Server");if(n.options.type==="postgres"){const i=e.columns.find(a=>a.asExpression&&(!a.generatedType||a.generatedType==="VIRTUAL"));if(i)throw new x(`Column "${i.propertyName}" of Entity "${e.name}" is defined as VIRTUAL, but Postgres supports only STORED generated columns.`)}const r=e.create(void 0,{fromDeserializer:!0});e.relations.forEach(i=>{if(i.isManyToMany||i.isOneToMany){if(i.persistenceEnabled===!1)return;const a=i.getEntityValue(r);if(Array.isArray(a))throw new $0(i)}}),e.relations.forEach(i=>{if(n.supportedOnDeleteTypes&&i.onDelete&&!n.supportedOnDeleteTypes.includes(i.onDelete))throw new x(`OnDeleteType "${i.onDelete}" is not supported for ${n.options.type}!`);if(n.supportedOnUpdateTypes&&i.onUpdate&&!n.supportedOnUpdateTypes.includes(i.onUpdate))throw new x(`OnUpdateType "${i.onUpdate}" is not valid for ${n.options.type}!`)}),e.relations.forEach(i=>{if(i.isCascadeRemove&&i.inverseRelation&&i.inverseRelation.isCascadeRemove)throw new x(`Relation ${e.name}#${i.propertyName} and ${i.inverseRelation.entityMetadata.name}#${i.inverseRelation.propertyName} both has cascade remove set. This may lead to unexpected circular removals. Please set cascade remove only from one side of relationship.`)})}validateDependencies(e){const t=new sx;e.forEach(n=>{t.addNode(n.name)}),e.forEach(n=>{n.relationsWithJoinColumns.filter(r=>!r.isNullable).forEach(r=>{t.addDependency(n.name,r.inverseEntityMetadata.name)})});try{t.overallOrder()}catch(n){throw new C0(n.toString().replace("Error: Dependency Cycle Found: ",""))}}validateEagerRelations(e){e.forEach(t=>{t.eagerRelations.forEach(n=>{if(n.inverseRelation&&n.inverseRelation.isEager)throw new x(`Circular eager relations are disallowed. ${t.targetName}#${n.propertyPath} contains "eager: true", and its inverse side ${n.inverseEntityMetadata.targetName}#${n.inverseRelation.propertyPath} contains "eager: true" as well. Remove "eager: true" from one side of the relation.`)})})}}class ox{}class U1{}class cx{}class ux{}class vy{}let F1=class{};class lx{}let j1=class{};class hx{}class dx{}class Fp{}class fx{}class px{}class mx{}class Ti{static createRelationMaps(e,t,n,r){return r.map(i=>{const a=t.treeParentRelation.joinColumns[0],o=a.referencedColumn??t.primaryColumns[0],l=a.givenDatabaseName||a.databaseName,h=o.givenDatabaseName||o.databaseName,d=i[n+"_"+h],p=i[n+"_"+l];return{id:e.connection.driver.prepareHydratedValue(d,o),parentId:e.connection.driver.prepareHydratedValue(p,a)}})}static buildChildrenEntityTree(e,t,n,r,i){const a=e.treeChildrenRelation.propertyName;if(i.depth===0){t[a]=[];return}const l=e.treeParentRelation.joinColumns[0].referencedColumn??e.primaryColumns[0],h=l.getEntityValue(t),d=r.filter(m=>m.parentId===h),p=new Set(d.map(m=>m.id));t[a]=n.filter(m=>p.has(l.getEntityValue(m))),t[a].forEach(m=>{Ti.buildChildrenEntityTree(e,m,n,r,{...i,depth:i.depth-1})})}static buildParentEntityTree(e,t,n,r){const i=e.treeParentRelation.propertyName,o=e.treeParentRelation.joinColumns[0].referencedColumn??e.primaryColumns[0],l=o.getEntityValue(t),h=r.find(p=>p.id===l),d=n.find(p=>h?o.getEntityValue(p)===h.parentId:!1);d&&(t[i]=d,Ti.buildParentEntityTree(e,t[i],n,r))}}function kp(s,e){var t=Object.keys(s);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(s);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(s,r).enumerable})),t.push.apply(t,n)}return t}function jp(s){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?kp(Object(t),!0).forEach(function(n){yx(s,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(t)):kp(Object(t)).forEach(function(n){Object.defineProperty(s,n,Object.getOwnPropertyDescriptor(t,n))})}return s}function yx(s,e,t){return e=gx(e),e in s?Object.defineProperty(s,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):s[e]=t,s}function gx(s){var e=Ex(s,"string");return typeof e=="symbol"?e:String(e)}function Ex(s,e){if(typeof s!="object"||s===null)return s;var t=s[Symbol.toPrimitive];if(t!==void 0){var n=t.call(s,e);if(typeof n!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(s)}const wx=Ry({});function Ry(s){return e.withOptions=t=>Ry(jp(jp({},s),t)),e;function e(t,...n){const r=typeof t=="string"?[t]:t.raw,{alignValues:i=!1,escapeSpecialCharacters:a=Array.isArray(t),trimWhitespace:o=!0}=s;let l="";for(let p=0;p<r.length;p++){let m=r[p];if(a&&(m=m.replace(/\\\n[ \t]*/g,"").replace(/\\`/g,"`").replace(/\\\$/g,"$").replace(/\\\{/g,"{")),l+=m,p<n.length){const w=i?bx(n[p],l):n[p];l+=w}}const h=l.split(`
`);let d=null;for(const p of h){const m=p.match(/^(\s+)\S+/);if(m){const w=m[1].length;d?d=Math.min(d,w):d=w}}if(d!==null){const p=d;l=h.map(m=>m[0]===" "||m[0]==="	"?m.slice(p):m).join(`
`)}return o&&(l=l.trim()),a&&(l=l.replace(/\\n/g,`
`)),l}}function bx(s,e){if(typeof s!="string"||!s.includes(`
`))return s;const n=e.slice(e.lastIndexOf(`
`)+1).match(/^(\s+)/);if(n){const r=n[1];return s.replace(/\n/g,`
${r}`)}return s}function ec({driver:s,strings:e,expressions:t}){let n="";const r=[];let i=0;for(const[a,o]of t.entries()){if(n+=e[a],o===null){n+="NULL";continue}if(typeof o=="function"){const l=o();if(typeof l=="string"){n+=l;continue}if(Array.isArray(l)){if(l.length===0)throw new Error(`Expression ${a} in this sql tagged template is a function which returned an empty array. Empty arrays cannot safely be expanded into parameter lists.`);const h=l.map(()=>s.createParameter(`param_${i+1}`,i++));n+=h.join(", "),r.push(...l);continue}throw new Error(`Expression ${a} in this sql tagged template is a function which returned a value of type "${l===null?"null":typeof l}". Only array and string types are supported as function return values in sql tagged template expressions.`)}n+=s.createParameter(`param_${i+1}`,i++),r.push(o)}return n+=e[e.length-1],n=wx(n),{query:n,parameters:r}}class _y{get metadata(){return this.manager.connection.getMetadata(this.target)}constructor(e,t,n){this.target=e,this.manager=t,this.queryRunner=n}createQueryBuilder(e,t){return this.manager.createQueryBuilder(this.metadata.target,e||this.metadata.targetName,t||this.queryRunner)}hasId(e){return this.manager.hasId(this.metadata.target,e)}getId(e){return this.manager.getId(this.metadata.target,e)}create(e){return this.manager.create(this.metadata.target,e)}merge(e,...t){return this.manager.merge(this.metadata.target,e,...t)}preload(e){return this.manager.preload(this.metadata.target,e)}save(e,t){return this.manager.save(this.metadata.target,e,t)}remove(e,t){return this.manager.remove(this.metadata.target,e,t)}softRemove(e,t){return this.manager.softRemove(this.metadata.target,e,t)}recover(e,t){return this.manager.recover(this.metadata.target,e,t)}insert(e){return this.manager.insert(this.metadata.target,e)}update(e,t){return this.manager.update(this.metadata.target,e,t)}updateAll(e){return this.manager.updateAll(this.metadata.target,e)}upsert(e,t){return this.manager.upsert(this.metadata.target,e,t)}delete(e){return this.manager.delete(this.metadata.target,e)}deleteAll(){return this.manager.deleteAll(this.metadata.target)}softDelete(e){return this.manager.softDelete(this.metadata.target,e)}restore(e){return this.manager.restore(this.metadata.target,e)}exist(e){return this.manager.exists(this.metadata.target,e)}exists(e){return this.manager.exists(this.metadata.target,e)}existsBy(e){return this.manager.existsBy(this.metadata.target,e)}count(e){return this.manager.count(this.metadata.target,e)}countBy(e){return this.manager.countBy(this.metadata.target,e)}sum(e,t){return this.manager.sum(this.metadata.target,e,t)}average(e,t){return this.manager.average(this.metadata.target,e,t)}minimum(e,t){return this.manager.minimum(this.metadata.target,e,t)}maximum(e,t){return this.manager.maximum(this.metadata.target,e,t)}async find(e){return this.manager.find(this.metadata.target,e)}async findBy(e){return this.manager.findBy(this.metadata.target,e)}findAndCount(e){return this.manager.findAndCount(this.metadata.target,e)}findAndCountBy(e){return this.manager.findAndCountBy(this.metadata.target,e)}async findByIds(e){return this.manager.findByIds(this.metadata.target,e)}async findOne(e){return this.manager.findOne(this.metadata.target,e)}async findOneBy(e){return this.manager.findOneBy(this.metadata.target,e)}async findOneById(e){return this.manager.findOneById(this.metadata.target,e)}async findOneOrFail(e){return this.manager.findOneOrFail(this.metadata.target,e)}async findOneByOrFail(e){return this.manager.findOneByOrFail(this.metadata.target,e)}query(e,t){return this.manager.query(e,t)}async sql(e,...t){const{query:n,parameters:r}=ec({driver:this.manager.connection.driver,strings:e,expressions:t});return await this.query(n,r)}clear(){return this.manager.clear(this.metadata.target)}increment(e,t,n){return this.manager.increment(this.metadata.target,e,t,n)}decrement(e,t,n){return this.manager.decrement(this.metadata.target,e,t,n)}extend(e){const t=this.constructor,{target:n,manager:r,queryRunner:i}=this,a=class extends t{constructor(o,l,h){super(o,l,h)}};for(const o in e)a.prototype[o]=e[o];return new a(n,r,i)}}class Tx extends _y{async findTrees(e){const t=await this.findRoots(e);return await Promise.all(t.map(n=>this.findDescendantsTree(n,e))),t}findRoots(e){const t=o=>this.manager.connection.driver.escape(o),n=o=>this.manager.connection.driver.escape(o),r=this.metadata.treeParentRelation.joinColumns[0],i=r.givenDatabaseName||r.databaseName,a=this.createQueryBuilder("treeEntity");return Ht.applyOptionsToTreeQueryBuilder(a,e),a.where(`${t("treeEntity")}.${n(i)} IS NULL`).getMany()}findDescendants(e,t){const n=this.createDescendantsQueryBuilder("treeEntity","treeClosure",e);return Ht.applyOptionsToTreeQueryBuilder(n,t),n.getMany()}async findDescendantsTree(e,t){const n=this.createDescendantsQueryBuilder("treeEntity","treeClosure",e);Ht.applyOptionsToTreeQueryBuilder(n,t);const r=await n.getRawAndEntities(),i=Ti.createRelationMaps(this.manager,this.metadata,"treeEntity",r.raw);return Ti.buildChildrenEntityTree(this.metadata,e,r.entities,i,{depth:-1,...t}),e}countDescendants(e){return this.createDescendantsQueryBuilder("treeEntity","treeClosure",e).getCount()}createDescendantsQueryBuilder(e,t,n){const r=i=>this.manager.connection.driver.escape(i);if(this.metadata.treeType==="closure-table"){const i=this.metadata.closureJunctionTable.descendantColumns.map(l=>r(t)+"."+r(l.propertyPath)+" = "+r(e)+"."+r(l.referencedColumn.propertyPath)).join(" AND "),a={},o=this.metadata.closureJunctionTable.ancestorColumns.map(l=>(a[l.referencedColumn.propertyName]=l.referencedColumn.getEntityValue(n),r(t)+"."+r(l.propertyPath)+" = :"+l.referencedColumn.propertyName)).join(" AND ");return this.createQueryBuilder(e).innerJoin(this.metadata.closureJunctionTable.tableName,t,i).where(o).setParameters(a)}else if(this.metadata.treeType==="nested-set"){const i=e+"."+this.metadata.nestedSetLeftColumn.propertyPath+" BETWEEN joined."+this.metadata.nestedSetLeftColumn.propertyPath+" AND joined."+this.metadata.nestedSetRightColumn.propertyPath,a={},o=this.metadata.treeParentRelation.joinColumns.map(l=>{const h=l.referencedColumn.propertyPath.replace(".","_");return a[h]=l.referencedColumn.getEntityValue(n),"joined."+l.referencedColumn.propertyPath+" = :"+h}).join(" AND ");return this.createQueryBuilder(e).innerJoin(this.metadata.targetName,"joined",i).where(o,a)}else if(this.metadata.treeType==="materialized-path")return this.createQueryBuilder(e).where(i=>{const a=i.subQuery().select(`${this.metadata.targetName}.${this.metadata.materializedPathColumn.propertyPath}`,"path").from(this.metadata.target,this.metadata.targetName).whereInIds(this.metadata.getEntityIdMap(n));return ie.isSQLiteFamily(this.manager.connection.driver)?`${e}.${this.metadata.materializedPathColumn.propertyPath} LIKE ${a.getQuery()} || '%'`:`${e}.${this.metadata.materializedPathColumn.propertyPath} LIKE NULLIF(CONCAT(${a.getQuery()}, '%'), '%')`});throw new x("Supported only in tree entities")}findAncestors(e,t){const n=this.createAncestorsQueryBuilder("treeEntity","treeClosure",e);return Ht.applyOptionsToTreeQueryBuilder(n,t),n.getMany()}async findAncestorsTree(e,t){const n=this.createAncestorsQueryBuilder("treeEntity","treeClosure",e);Ht.applyOptionsToTreeQueryBuilder(n,t);const r=await n.getRawAndEntities(),i=Ti.createRelationMaps(this.manager,this.metadata,"treeEntity",r.raw);return Ti.buildParentEntityTree(this.metadata,e,r.entities,i),e}countAncestors(e){return this.createAncestorsQueryBuilder("treeEntity","treeClosure",e).getCount()}createAncestorsQueryBuilder(e,t,n){if(this.metadata.treeType==="closure-table"){const r=this.metadata.closureJunctionTable.ancestorColumns.map(o=>t+"."+o.propertyPath+" = "+e+"."+o.referencedColumn.propertyPath).join(" AND "),i={},a=this.metadata.closureJunctionTable.descendantColumns.map(o=>(i[o.referencedColumn.propertyName]=o.referencedColumn.getEntityValue(n),t+"."+o.propertyPath+" = :"+o.referencedColumn.propertyName)).join(" AND ");return this.createQueryBuilder(e).innerJoin(this.metadata.closureJunctionTable.tableName,t,r).where(a).setParameters(i)}else if(this.metadata.treeType==="nested-set"){const r="joined."+this.metadata.nestedSetLeftColumn.propertyPath+" BETWEEN "+e+"."+this.metadata.nestedSetLeftColumn.propertyPath+" AND "+e+"."+this.metadata.nestedSetRightColumn.propertyPath,i={},a=this.metadata.treeParentRelation.joinColumns.map(o=>{const l=o.referencedColumn.propertyPath.replace(".","_");return i[l]=o.referencedColumn.getEntityValue(n),"joined."+o.referencedColumn.propertyPath+" = :"+l}).join(" AND ");return this.createQueryBuilder(e).innerJoin(this.metadata.targetName,"joined",r).where(a,i)}else if(this.metadata.treeType==="materialized-path")return this.createQueryBuilder(e).where(r=>{const i=r.subQuery().select(`${this.metadata.targetName}.${this.metadata.materializedPathColumn.propertyPath}`,"path").from(this.metadata.target,this.metadata.targetName).whereInIds(this.metadata.getEntityIdMap(n));return ie.isSQLiteFamily(this.manager.connection.driver)?`${i.getQuery()} LIKE ${e}.${this.metadata.materializedPathColumn.propertyPath} || '%'`:`${i.getQuery()} LIKE CONCAT(${e}.${this.metadata.materializedPathColumn.propertyPath}, '%')`});throw new x("Supported only in tree entities")}}class Sx{transform(e,t,n,r=!1){return this.groupAndTransform(e,t,n,r),e}groupAndTransform(e,t,n,r=!1){n.nonVirtualColumns.forEach(i=>{const a=i.getEntityValue(t);a!==void 0&&i.setEntityValue(e,a)}),n.relations.length&&n.relations.forEach(i=>{let a=i.getEntityValue(e);const o=i.getEntityValue(t,r);if(o!==void 0)if(i.isOneToMany||i.isManyToMany){if(!Array.isArray(o))return;a||(a=[],i.setEntityValue(e,a)),o.forEach(l=>{let h=a.find(p=>i.inverseEntityMetadata.compareEntities(l,p));const d=i.inverseEntityMetadata.findInheritanceMetadata(l);h||(h=d.create(void 0,{fromDeserializer:!0}),a.push(h)),this.groupAndTransform(h,l,d,r)})}else{if(!Re.isObject(o)){Re.isObject(a)||i.setEntityValue(e,o);return}const l=i.inverseEntityMetadata.findInheritanceMetadata(o);a||(a=l.create(void 0,{fromDeserializer:!0}),i.setEntityValue(e,a)),this.groupAndTransform(a,o,l,r)}})}}class Ax{constructor(e,t,n,r){this.plainEntity=e,this.metadata=t,this.parentLoadMapItem=n,this.relation=r}get target(){return this.metadata.target}get id(){return this.metadata.getEntityIdMixedMap(this.plainEntity)}}class Nx{constructor(){this.loadMapItems=[]}get mainLoadMapItem(){return this.loadMapItems.find(e=>!e.relation&&!e.parentLoadMapItem)}addLoadMap(e){this.loadMapItems.find(n=>n.target===e.target&&n.id===e.id)||this.loadMapItems.push(e)}fillEntities(e,t){t.forEach(n=>{const r=this.loadMapItems.find(i=>i.target===e&&i.metadata.compareEntities(n,i.plainEntity));r&&(r.entity=n)})}groupByTargetIds(){const e=[];return this.loadMapItems.forEach(t=>{let n=e.find(r=>r.target===t.target);n||(n={target:t.target,ids:[]},e.push(n)),n.ids.push(t.id)}),e}}class Cx{constructor(e){this.manager=e}async transform(e,t){if(!t.hasAllPrimaryKeys(e))return Promise.reject("Given object does not have a primary column, cannot transform it to database entity.");const n=new Nx,r=(i,a,o,l)=>{const h=new Ax(i,a,o,l);n.addLoadMap(h),a.extractRelationValuesFromEntity(i,t.relations).filter(d=>d!=null).forEach(([d,p,m])=>r(p,m,h,d))};return r(e,t),await Promise.all(n.groupByTargetIds().map(i=>this.manager.findByIds(i.target,i.ids).then(a=>n.fillEntities(i.target,a)))),n.loadMapItems.forEach(i=>{!i.relation||!i.entity||!i.parentLoadMapItem||!i.parentLoadMapItem.entity||(i.relation.isManyToMany||i.relation.isOneToMany?(i.parentLoadMapItem.entity[i.relation.propertyName]||(i.parentLoadMapItem.entity[i.relation.propertyName]=[]),i.parentLoadMapItem.entity[i.relation.propertyName].push(i.entity)):i.parentLoadMapItem.entity[i.relation.propertyName]=i.entity)}),n.mainLoadMapItem?n.mainLoadMapItem.entity:void 0}}class vx{get repository(){const e=this.getCustomRepositoryTarget(this);if(!e)throw new Wu(this.constructor);return this.manager.getRepository(e)}get treeRepository(){const e=this.getCustomRepositoryTarget(this);if(!e)throw new Wu(this.constructor);return this.manager.getTreeRepository(e)}createQueryBuilder(e){const t=this.getCustomRepositoryTarget(this.constructor);if(!t)throw new Wu(this.constructor);return this.manager.getRepository(t).createQueryBuilder(e)}createQueryBuilderFor(e,t){return this.getRepositoryFor(e).createQueryBuilder(t)}getRepositoryFor(e){return this.manager.getRepository(e)}getTreeRepositoryFor(e){return this.manager.getTreeRepository(e)}getCustomRepositoryTarget(e){const t=Io().entityRepositories.find(n=>n.target===(typeof e=="function"?e:e.constructor));if(!t)throw new ry(e);return t.entity}}class Wp{constructor(e){this.subjects=[...e],this.metadatas=this.getUniqueMetadatas(this.subjects)}sort(e){if(!this.metadatas.length)return this.subjects;const t=[];if(e==="delete"){const o=this.subjects.filter(l=>!l.entity&&!l.databaseEntity);t.push(...o),this.removeAlreadySorted(o)}const n=this.getNonNullableDependencies();let r=this.toposort(n);e==="insert"&&(r=r.reverse()),r.forEach(o=>{const l=this.subjects.filter(h=>h.metadata.targetName===o||h.metadata.inheritanceTree.some(d=>d.name===o));t.push(...l),this.removeAlreadySorted(l)});const i=this.getDependencies();let a=this.toposort(i);return e==="insert"&&(a=a.reverse()),a.forEach(o=>{const l=this.subjects.filter(h=>h.metadata.targetName===o);t.push(...l),this.removeAlreadySorted(l)}),t.push(...this.subjects),t}removeAlreadySorted(e){e.forEach(t=>{this.subjects.splice(this.subjects.indexOf(t),1)})}getUniqueMetadatas(e){const t=[];return e.forEach(n=>{t.indexOf(n.metadata)===-1&&t.push(n.metadata)}),t}getNonNullableDependencies(){return this.metadatas.reduce((e,t)=>(t.relationsWithJoinColumns.forEach(n=>{n.isNullable||e.push([t.targetName,n.inverseEntityMetadata.targetName])}),e),[])}getDependencies(){return this.metadatas.reduce((e,t)=>(t.relationsWithJoinColumns.forEach(n=>{n.inverseEntityMetadata!==t&&e.push([t.targetName,n.inverseEntityMetadata.targetName])}),e),[])}toposort(e){function t(h){const d=[];for(let p=0,m=h.length;p<m;p++){const w=h[p];d.indexOf(w[0])<0&&d.push(w[0]),d.indexOf(w[1])<0&&d.push(w[1])}return d}const n=t(e);let r=n.length,i=r;const a=new Array(r),o=new Set;for(;i--;)o.has(i)||l(n[i],i,[]);function l(h,d,p){if(p.indexOf(h)>=0)throw new x("Cyclic dependency: "+JSON.stringify(h));if(!~n.indexOf(h))throw new x("Found unknown node. Make sure to provided all involved nodes. Unknown node: "+JSON.stringify(h));if(o.has(d))return;o.add(d);const m=e.filter(function(w){return w[0]===h});if(d=m.length){const w=p.concat(h);do{const b=m[--d][1];l(b,n.indexOf(b),w)}while(d)}a[--r]=h}return a}}class be{static normalizeHydratedDate(e){return e&&(typeof e=="string"?new Date(e):e)}static mixedDateToDateString(e){return e instanceof Date?this.formatZerolessValue(e.getFullYear(),4)+"-"+this.formatZerolessValue(e.getMonth()+1)+"-"+this.formatZerolessValue(e.getDate()):e}static mixedDateToDate(e,t=!1,n=!0){let r=typeof e=="string"?iv(e).toDate():e;return t&&(r=new Date(r.getUTCFullYear(),r.getUTCMonth(),r.getUTCDate(),r.getUTCHours(),r.getUTCMinutes(),r.getUTCSeconds(),r.getUTCMilliseconds())),n||r.setUTCMilliseconds(0),r}static mixedDateToTimeString(e,t=!1){return e instanceof Date?this.formatZerolessValue(e.getHours())+":"+this.formatZerolessValue(e.getMinutes())+(t?"":":"+this.formatZerolessValue(e.getSeconds())):e}static mixedTimeToDate(e){if(typeof e=="string"){const[t,n,r]=e.split(":"),i=new Date;return t&&i.setHours(parseInt(t)),n&&i.setMinutes(parseInt(n)),r&&i.setSeconds(parseInt(r)),i}return e}static mixedTimeToString(e,t=!1){return e=e instanceof Date?e.getHours()+":"+e.getMinutes()+(t?"":":"+e.getSeconds()):e,typeof e=="string"?e.split(":").map(n=>n.length===1?"0"+n:n).join(":"):e}static mixedDateToDatetimeString(e,t){if(typeof e=="string"&&(e=new Date(e)),e instanceof Date){let n=this.formatZerolessValue(e.getFullYear(),4)+"-"+this.formatZerolessValue(e.getMonth()+1)+"-"+this.formatZerolessValue(e.getDate())+" "+this.formatZerolessValue(e.getHours())+":"+this.formatZerolessValue(e.getMinutes())+":"+this.formatZerolessValue(e.getSeconds());t&&(n+=`.${this.formatMilliseconds(e.getMilliseconds())}`),e=n}return e}static mixedDateToUtcDatetimeString(e){return typeof e=="string"&&(e=new Date(e)),e instanceof Date?this.formatZerolessValue(e.getUTCFullYear(),4)+"-"+this.formatZerolessValue(e.getUTCMonth()+1)+"-"+this.formatZerolessValue(e.getUTCDate())+" "+this.formatZerolessValue(e.getUTCHours())+":"+this.formatZerolessValue(e.getUTCMinutes())+":"+this.formatZerolessValue(e.getUTCSeconds())+"."+this.formatMilliseconds(e.getUTCMilliseconds()):e}static simpleArrayToString(e){return Array.isArray(e)?e.map(t=>String(t)).join(","):e}static stringToSimpleArray(e){return typeof e=="string"?e.length>0?e.split(","):[]:e}static simpleJsonToString(e){return JSON.stringify(e)}static stringToSimpleJson(e){return typeof e=="string"?JSON.parse(e):e}static simpleEnumToString(e){return""+e}static stringToSimpleEnum(e,t){return t.enum&&!isNaN(e)&&t.enum.indexOf(parseInt(e))>=0&&(e=parseInt(e)),e}static formatZerolessValue(e,t=2){return`${"0".repeat(t)}${e}`.slice(-t)}static formatMilliseconds(e){return e<10?"00"+e:e<100?"0"+e:String(e)}}class Rx{compute(e){e.forEach(t=>{this.computeDiffColumns(t),this.computeDiffRelationalColumns(e,t)})}computeDiffColumns(e){e.entity&&e.metadata.columns.forEach(t=>{if(t.isVirtual||t.isDiscriminator)return;const n=e.changeMaps.find(i=>i.column===t);n&&e.changeMaps.splice(e.changeMaps.indexOf(n),1);const r=t.getEntityValue(e.entity);if(r!==void 0){if(e.databaseEntity){const i=t.type!=="json"&&t.type!=="jsonb";let a=t.getEntityValue(e.databaseEntity,i);if(t.relationMetadata){const l=t.relationMetadata.getEntityValue(e.entity);if(l!=null)return}let o=r;if(r!==null&&a!==null){switch(t.type){case"date":o=t.isArray?r.map(l=>be.mixedDateToDateString(l)):be.mixedDateToDateString(r),a=t.isArray?a.map(l=>be.mixedDateToDateString(l)):be.mixedDateToDateString(a);break;case"time":case"time with time zone":case"time without time zone":case"timetz":o=t.isArray?r.map(l=>be.mixedDateToTimeString(l)):be.mixedDateToTimeString(r),a=t.isArray?a.map(l=>be.mixedDateToTimeString(l)):be.mixedDateToTimeString(a);break;case"datetime":case"datetime2":case Date:case"timestamp":case"timestamp without time zone":case"timestamp with time zone":case"timestamp with local time zone":case"timestamptz":o=t.isArray?r.map(l=>be.mixedDateToUtcDatetimeString(l)):be.mixedDateToUtcDatetimeString(r),a=t.isArray?a.map(l=>be.mixedDateToUtcDatetimeString(l)):be.mixedDateToUtcDatetimeString(a);break;case"json":case"jsonb":if(re.deepCompare(r,a))return;break;case"simple-array":o=be.simpleArrayToString(r),a=be.simpleArrayToString(a);break;case"simple-enum":o=be.simpleEnumToString(r),a=be.simpleEnumToString(a);break;case"simple-json":o=be.simpleJsonToString(r),a=be.simpleJsonToString(a);break}t.transformer&&(o=It.transformTo(t.transformer,r))}if(t.isArray){if(re.deepCompare(o,a))return}else if(Buffer.isBuffer(o)&&Buffer.isBuffer(a)){if(o.equals(a))return}else if(o===a)return}e.diffColumns.includes(t)||e.diffColumns.push(t),e.changeMaps.push({column:t,value:r})}})}computeDiffRelationalColumns(e,t){t.entity&&t.metadata.relationsWithJoinColumns.forEach(n=>{let r=n.getEntityValue(t.entity);if(r===void 0)return;if(t.databaseEntity){let o=r;o!==null&&Re.isObject(o)&&(o=n.getRelationIdMap(o));const l=n.getEntityValue(t.databaseEntity);if(re.compareIds(o,l))return;t.diffRelations.push(n)}const i=e.find(o=>o.mustBeInserted&&o.entity===r);i&&(r=i);const a=t.changeMaps.find(o=>o.relation===n);a?a.value=r:t.changeMaps.push({relation:n,value:r})})}}class Qp extends x{constructor(){super("Nested sets do not support multiple root entities.")}}class zu{constructor(e){this.queryRunner=e}async insert(e){const t=h=>this.queryRunner.connection.driver.escape(h),n=this.getTableName(e.metadata.tablePath),r=t(e.metadata.nestedSetLeftColumn.databaseName),i=t(e.metadata.nestedSetRightColumn.databaseName);let a=e.metadata.treeParentRelation.getEntityValue(e.entity);!a&&e.parentSubject&&e.parentSubject.entity&&(a=e.parentSubject.insertedValueSet?e.parentSubject.insertedValueSet:e.parentSubject.entity);const o=e.metadata.getEntityIdMap(a);let l;if(o&&(l=await this.queryRunner.manager.createQueryBuilder().select(e.metadata.targetName+"."+e.metadata.nestedSetRightColumn.propertyPath,"right").from(e.metadata.target,e.metadata.targetName).whereInIds(o).getRawOne().then(h=>{const d=h?h.right:void 0;return typeof d=="string"?parseInt(d):d})),l!==void 0)await this.queryRunner.query(`UPDATE ${n} SET ${r} = CASE WHEN ${r} > ${l} THEN ${r} + 2 ELSE ${r} END,${i} = ${i} + 2 WHERE ${i} >= ${l}`),re.mergeDeep(e.insertedValueSet,e.metadata.nestedSetLeftColumn.createValueMap(l),e.metadata.nestedSetRightColumn.createValueMap(l+1));else{if(!await this.isUniqueRootEntity(e,a))throw new Qp;re.mergeDeep(e.insertedValueSet,e.metadata.nestedSetLeftColumn.createValueMap(1),e.metadata.nestedSetRightColumn.createValueMap(2))}}async update(e){let t=e.metadata.treeParentRelation.getEntityValue(e.entity);!t&&e.parentSubject&&e.parentSubject.entity&&(t=e.parentSubject.entity);let n=e.databaseEntity;if(!n&&t&&(n=e.metadata.treeChildrenRelation.getEntityValue(t).find(o=>Object.entries(e.identifier).every(([l,h])=>o[l]===h))),n===void 0||t===void 0)return;const r=e.metadata.treeParentRelation.getEntityValue(n),i=e.metadata.getEntityIdMap(r),a=e.metadata.getEntityIdMap(t);if(!re.compareIds(i,a)){if(t){const o=b=>this.queryRunner.connection.driver.escape(b),l=this.getTableName(e.metadata.tablePath),h=o(e.metadata.nestedSetLeftColumn.databaseName),d=o(e.metadata.nestedSetRightColumn.databaseName),p=e.metadata.getEntityIdMap(n);let m;p&&(m=(await this.getNestedSetIds(e.metadata,p))[0]);let w;if(a&&(w=(await this.getNestedSetIds(e.metadata,a))[0]),m!==void 0&&w!==void 0){const b=w.left>m.left,S=m.right-m.left+1;let R;b?R=w.left-m.right:R=w.right-m.left;const $=`WHEN ${h} >= ${m.left} AND ${h} < ${m.right} THEN ${h} + ${R} `,q=`WHEN ${d} > ${m.left} AND ${d} <= ${m.right} THEN ${d} + ${R} `;b?await this.queryRunner.query(`UPDATE ${l} SET ${h} = CASE WHEN ${h} > ${m.right} AND ${h} <= ${w.left} THEN ${h} - ${S} `+$+`ELSE ${h} END, ${d} = CASE WHEN ${d} > ${m.right} AND ${d} < ${w.left} THEN ${d} - ${S} `+q+`ELSE ${d} END`):await this.queryRunner.query(`UPDATE ${l} SET ${h} = CASE WHEN ${h} < ${m.left} AND ${h} > ${w.right} THEN ${h} + ${S} `+$+`ELSE ${h} END, ${d} = CASE WHEN ${d} < ${m.left} AND ${d} >= ${w.right} THEN ${d} + ${S} `+q+`ELSE ${d} END`)}}else if(!await this.isUniqueRootEntity(e,t))throw new Qp}}async remove(e){Array.isArray(e)||(e=[e]);const t=e[0].metadata,n=h=>this.queryRunner.connection.driver.escape(h),r=this.getTableName(t.tablePath),i=n(t.nestedSetLeftColumn.databaseName),a=n(t.nestedSetRightColumn.databaseName),o=[];for(const h of e){const d=t.getEntityIdMap(h.entity);d&&o.push(d)}const l=await this.getNestedSetIds(t,o);for(const h of l){const d=h.right-h.left+1;await this.queryRunner.query(`UPDATE ${r} SET ${i} = CASE WHEN ${i} > ${h.left} THEN ${i} - ${d} ELSE ${i} END, ${a} = CASE WHEN ${a} > ${h.right} THEN ${a} - ${d} ELSE ${a} END`)}}getNestedSetIds(e,t){const n={left:`${e.targetName}.${e.nestedSetLeftColumn.propertyPath}`,right:`${e.targetName}.${e.nestedSetRightColumn.propertyPath}`},r=this.queryRunner.manager.createQueryBuilder();return Object.entries(n).forEach(([i,a])=>{r.addSelect(a,i)}),r.from(e.target,e.targetName).whereInIds(t).orderBy(n.right,"DESC").getRawMany().then(i=>{const a=[];for(const o of i){const l={};for(const h of Object.keys(n)){const d=o?o[h]:void 0;l[h]=typeof d=="string"?parseInt(d):d}a.push(l)}return a})}async isUniqueRootEntity(e,t){const n=h=>this.queryRunner.connection.driver.escape(h),r=this.getTableName(e.metadata.tablePath),i=[],a=e.metadata.treeParentRelation.joinColumns.map(h=>{const d=n(h.databaseName),p=h.getEntityValue(t);if(p==null)return`${d} IS NULL`;i.push(p);const m=this.queryRunner.connection.driver.createParameter("entity_"+h.databaseName,i.length-1);return`${d} = ${m}`}).join(" AND "),o="count",l=await this.queryRunner.query(`SELECT COUNT(1) AS ${n(o)} FROM ${r} WHERE ${a}`,i,!0);return parseInt(l.records[0][o])===0}getTableName(e){return e.split(".").map(t=>t===""?t:this.queryRunner.connection.driver.escape(t)).join(".")}}class Ku{constructor(e){this.queryRunner=e}async insert(e){const t={};e.metadata.closureJunctionTable.ancestorColumns.forEach(r=>{t[r.databaseName]=e.identifier}),e.metadata.closureJunctionTable.descendantColumns.forEach(r=>{t[r.databaseName]=e.identifier}),await this.queryRunner.manager.createQueryBuilder().insert().into(e.metadata.closureJunctionTable.tablePath).values(t).updateEntity(!1).callListeners(!1).execute();let n=e.metadata.treeParentRelation.getEntityValue(e.entity);if(!n&&e.parentSubject&&e.parentSubject.entity&&(n=e.parentSubject.insertedValueSet?e.parentSubject.insertedValueSet:e.parentSubject.entity),n){const r=p=>this.queryRunner.connection.driver.escape(p),i=this.getTableName(e.metadata.closureJunctionTable.tablePath),a=[],o=e.metadata.closureJunctionTable.ancestorColumns.map(p=>r(p.databaseName)),l=e.metadata.closureJunctionTable.descendantColumns.map(p=>r(p.databaseName)),h=e.metadata.primaryColumns.map(p=>(a.push(p.getEntityValue(e.insertedValueSet?e.insertedValueSet:e.entity)),this.queryRunner.connection.driver.createParameter("child_entity_"+p.databaseName,a.length-1))),d=e.metadata.closureJunctionTable.descendantColumns.map(p=>{const m=r(p.databaseName),w=p.referencedColumn.getEntityValue(n);if(!w)throw new bp(e.metadata.name);a.push(w);const b=this.queryRunner.connection.driver.createParameter("parent_entity_"+p.referencedColumn.databaseName,a.length-1);return`${m} = ${b}`});await this.queryRunner.query(`INSERT INTO ${i} (${[...o,...l].join(", ")}) SELECT ${o.join(", ")}, ${h.join(", ")} FROM ${i} WHERE ${d.join(" AND ")}`,a)}}async update(e){let t=e.metadata.treeParentRelation.getEntityValue(e.entity);!t&&e.parentSubject&&e.parentSubject.entity&&(t=e.parentSubject.entity);let n=e.databaseEntity;if(!n&&t&&(n=e.metadata.treeChildrenRelation.getEntityValue(t).find(w=>Object.entries(e.identifier).every(([b,S])=>w[b]===S))),n===void 0||t===void 0)return;const r=e.metadata.treeParentRelation.getEntityValue(n),i=e.metadata.getEntityIdMap(r),a=e.metadata.getEntityIdMap(t);if(re.compareIds(i,a))return;const o=w=>this.queryRunner.connection.driver.escape(w),l=e.metadata.closureJunctionTable,h=l.ancestorColumns.map(w=>o(w.databaseName)),d=l.descendantColumns.map(w=>o(w.databaseName)),p=(w,b)=>{const S=`sub${b}`,R=w.createQueryBuilder().select(d.join(", ")).from(l.tablePath,S);for(const $ of l.ancestorColumns)R.andWhere(`${o(S)}.${o($.databaseName)} = :value_${$.referencedColumn.databaseName}`);return w.createQueryBuilder().select(d.join(", ")).from(`(${R.getQuery()})`,b).setParameters(R.getParameters()).getQuery()},m={};for(const w of e.metadata.primaryColumns)m[`value_${w.databaseName}`]=n[w.databaseName];if(await this.queryRunner.manager.createQueryBuilder().delete().from(l.tablePath).where(w=>`(${d.join(", ")}) IN (${p(w,"descendant")})`).andWhere(w=>`(${h.join(", ")}) NOT IN (${p(w,"ancestor")})`).setParameters(m).execute(),t){const w=[],b=this.getTableName(l.tablePath),S=o("supertree"),R=o("subtree"),$=[...h.map(J=>`${S}.${J}`),...d.map(J=>`${R}.${J}`)],q=e.metadata.closureJunctionTable.ancestorColumns.map(J=>{const ne=o(J.databaseName),ge=J.referencedColumn.getEntityValue(n);w.push(ge);const pe=this.queryRunner.connection.driver.createParameter("entity_"+J.referencedColumn.databaseName,w.length-1);return`${R}.${ne} = ${pe}`}),O=e.metadata.closureJunctionTable.descendantColumns.map(J=>{const ne=o(J.databaseName),ge=J.referencedColumn.getEntityValue(t);if(!ge)throw new bp(e.metadata.name);w.push(ge);const pe=this.queryRunner.connection.driver.createParameter("parent_entity_"+J.referencedColumn.databaseName,w.length-1);return`${S}.${ne} = ${pe}`});await this.queryRunner.query(`INSERT INTO ${b} (${[...h,...d].join(", ")}) SELECT ${$.join(", ")} FROM ${b} AS ${S}, ${b} AS ${R} WHERE ${[...q,...O].join(" AND ")}`,w)}}async remove(e){if(this.queryRunner.connection.driver.options.type!=="mssql")return;Array.isArray(e)||(e=[e]);const t=l=>this.queryRunner.connection.driver.escape(l),n=e.map(l=>l.identifier),r=e[0].metadata.closureJunctionTable,i=l=>l.map(h=>{const d=n.map(p=>p[h.referencedColumn.databaseName]);return`${t(h.databaseName)} IN (${d.join(", ")})`}).join(" AND "),a=i(r.ancestorColumns),o=i(r.descendantColumns);await this.queryRunner.manager.createQueryBuilder().delete().from(r.tablePath).where(a).orWhere(o).execute()}getTableName(e){return e.split(".").map(t=>t===""?t:this.queryRunner.connection.driver.escape(t)).join(".")}}class Xn{constructor(e){this["@instanceof"]=Symbol.for("EntityMetadata"),this.childEntityMetadatas=[],this.inheritanceTree=[],this.tableType="regular",this.withoutRowid=!1,this.synchronize=!0,this.hasNonNullableRelations=!1,this.isJunction=!1,this.isAlwaysUsingConstructor=!0,this.isClosureJunction=!1,this.hasMultiplePrimaryKeys=!1,this.hasUUIDGeneratedColumns=!1,this.ownColumns=[],this.columns=[],this.ancestorColumns=[],this.descendantColumns=[],this.nonVirtualColumns=[],this.ownerColumns=[],this.inverseColumns=[],this.generatedColumns=[],this.primaryColumns=[],this.ownRelations=[],this.relations=[],this.eagerRelations=[],this.lazyRelations=[],this.oneToOneRelations=[],this.ownerOneToOneRelations=[],this.oneToManyRelations=[],this.manyToOneRelations=[],this.manyToManyRelations=[],this.ownerManyToManyRelations=[],this.relationsWithJoinColumns=[],this.relationIds=[],this.relationCounts=[],this.foreignKeys=[],this.embeddeds=[],this.allEmbeddeds=[],this.ownIndices=[],this.indices=[],this.uniques=[],this.ownUniques=[],this.checks=[],this.exclusions=[],this.ownListeners=[],this.listeners=[],this.afterLoadListeners=[],this.beforeInsertListeners=[],this.afterInsertListeners=[],this.beforeUpdateListeners=[],this.afterUpdateListeners=[],this.beforeRemoveListeners=[],this.beforeSoftRemoveListeners=[],this.beforeRecoverListeners=[],this.afterRemoveListeners=[],this.afterSoftRemoveListeners=[],this.afterRecoverListeners=[],this.connection=e.connection,this.inheritanceTree=e.inheritanceTree||[],this.inheritancePattern=e.inheritancePattern,this.treeType=e.tableTree?e.tableTree.type:void 0,this.treeOptions=e.tableTree?e.tableTree.options:void 0,this.parentClosureEntityMetadata=e.parentClosureEntityMetadata,this.tableMetadataArgs=e.args,this.target=this.tableMetadataArgs.target,this.tableType=this.tableMetadataArgs.type,this.expression=this.tableMetadataArgs.expression,this.withoutRowid=this.tableMetadataArgs.withoutRowid,this.dependsOn=this.tableMetadataArgs.dependsOn}create(e,t){const n=!!(t&&t.pojo===!0);let r;return typeof this.target=="function"&&!n?!(t!=null&&t.fromDeserializer)||this.isAlwaysUsingConstructor?r=new this.target:r=Object.create(this.target.prototype):r={},this.connection.options.typename&&(r[this.connection.options.typename]=this.targetName),this.lazyRelations.forEach(i=>this.connection.relationLoader.enableLazyLoad(i,r,e)),r}hasId(e){return e?this.primaryColumns.every(t=>{const n=t.getEntityValue(e);return n!=null&&n!==""}):!1}hasAllPrimaryKeys(e){return this.primaryColumns.every(t=>{const n=t.getEntityValue(e);return n!=null})}ensureEntityIdMap(e){if(Re.isObject(e))return e;if(this.hasMultiplePrimaryKeys)throw new g0(this,e);return this.primaryColumns[0].createValueMap(e)}getEntityIdMap(e){if(e)return Xn.getValueMap(e,this.primaryColumns,{skipNulls:!0})}getEntityIdMixedMap(e){if(!e)return e;const t=this.getEntityIdMap(e);return this.hasMultiplePrimaryKeys?t:t&&this.primaryColumns[0].getEntityValue(t)}compareEntities(e,t){const n=this.getEntityIdMap(e);if(!n)return!1;const r=this.getEntityIdMap(t);return r?re.compareIds(n,r):!1}findColumnWithPropertyName(e){return this.columns.find(t=>t.propertyName===e)}findColumnWithDatabaseName(e){return this.columns.find(t=>t.databaseName===e)}hasColumnWithPropertyPath(e){return this.columns.some(n=>n.propertyPath===e)||this.hasRelationWithPropertyPath(e)}findColumnWithPropertyPath(e){const t=this.columns.find(r=>r.propertyPath===e);if(t)return t;const n=this.relations.find(r=>r.propertyPath===e);if(n&&n.joinColumns.length===1)return n.joinColumns[0]}findColumnWithPropertyPathStrict(e){return this.columns.find(t=>t.propertyPath===e)}findColumnsWithPropertyPath(e){const t=this.columns.find(r=>r.propertyPath===e);if(t)return[t];const n=this.findRelationWithPropertyPath(e);return n&&n.joinColumns?n.joinColumns:[]}hasRelationWithPropertyPath(e){return this.relations.some(t=>t.propertyPath===e)}findRelationWithPropertyPath(e){return this.relations.find(t=>t.propertyPath===e)}hasEmbeddedWithPropertyPath(e){return this.allEmbeddeds.some(t=>t.propertyPath===e)}findEmbeddedWithPropertyPath(e){return this.allEmbeddeds.find(t=>t.propertyPath===e)}mapPropertyPathsToColumns(e){return e.map(t=>{const n=this.findColumnWithPropertyPath(t);if(n==null)throw new Gn(t,this);return n})}extractRelationValuesFromEntity(e,t){const n=[];return t.forEach(r=>{const i=r.getEntityValue(e);Array.isArray(i)?i.forEach(a=>n.push([r,a,Xn.getInverseEntityMetadata(a,r)])):i&&n.push([r,i,Xn.getInverseEntityMetadata(i,r)])}),n}findInheritanceMetadata(e){if(this.inheritancePattern==="STI"&&this.childEntityMetadatas.length>0){let t;return this.discriminatorColumn&&(t=e[this.discriminatorColumn.propertyName]),this.childEntityMetadatas.find(n=>t===n.discriminatorValue||e.constructor===n.target)||this}return this}static getInverseEntityMetadata(e,t){return t.inverseEntityMetadata.findInheritanceMetadata(e)}static createPropertyPath(e,t,n=""){const r=[];return Object.keys(t).forEach(i=>{const a=n?n+"."+i:i;if(e.hasEmbeddedWithPropertyPath(a)){const o=this.createPropertyPath(e,t[i],a);r.push(...o)}else{const o=n?n+"."+i:i;r.push(o)}}),r}static difference(e,t){return e.filter(n=>!t.find(r=>re.compareIds(n,r)))}static getValueMap(e,t,n){return t.reduce((r,i)=>{const a=i.getEntityValueMap(e,n);if(!(r===void 0||a===null||a===void 0))return re.mergeDeep(r,a)},{})}build(){var r;const e=this.connection.namingStrategy,t=this.connection.options.entityPrefix,n=this.connection.options.entitySkipConstructor;this.engine=this.tableMetadataArgs.engine,this.database=this.tableMetadataArgs.type==="entity-child"&&this.parentEntityMetadata?this.parentEntityMetadata.database:this.tableMetadataArgs.database,this.tableMetadataArgs.schema?this.schema=this.tableMetadataArgs.schema:this.tableMetadataArgs.type==="entity-child"&&this.parentEntityMetadata?this.schema=this.parentEntityMetadata.schema:(r=this.connection.options)!=null&&r.hasOwnProperty("schema")&&(this.schema=this.connection.options.schema),this.givenTableName=this.tableMetadataArgs.type==="entity-child"&&this.parentEntityMetadata?this.parentEntityMetadata.givenTableName:this.tableMetadataArgs.name,this.synchronize=this.tableMetadataArgs.synchronize!==!1,this.targetName=typeof this.tableMetadataArgs.target=="function"?this.tableMetadataArgs.target.name:this.tableMetadataArgs.target,this.tableMetadataArgs.type==="closure-junction"?this.tableNameWithoutPrefix=e.closureJunctionTableName(this.givenTableName):this.tableMetadataArgs.type==="entity-child"&&this.parentEntityMetadata?this.tableNameWithoutPrefix=e.tableName(this.parentEntityMetadata.targetName,this.parentEntityMetadata.givenTableName):(this.tableNameWithoutPrefix=e.tableName(this.targetName,this.givenTableName),this.tableMetadataArgs.type==="junction"&&this.connection.driver.maxAliasLength&&this.connection.driver.maxAliasLength>0&&this.tableNameWithoutPrefix.length>this.connection.driver.maxAliasLength&&(this.tableNameWithoutPrefix=Ty(this.tableNameWithoutPrefix,{separator:"_",segmentLength:3}))),this.tableName=t?e.prefixTableName(t,this.tableNameWithoutPrefix):this.tableNameWithoutPrefix,this.target=this.target?this.target:this.tableName,this.name=this.targetName?this.targetName:this.tableName,this.expression=this.tableMetadataArgs.expression,this.withoutRowid=this.tableMetadataArgs.withoutRowid===!0,this.tablePath=this.connection.driver.buildTableName(this.tableName,this.schema,this.database),this.orderBy=typeof this.tableMetadataArgs.orderBy=="function"?this.tableMetadataArgs.orderBy(this.propertiesMap):this.tableMetadataArgs.orderBy,n!==void 0&&(this.isAlwaysUsingConstructor=!n),this.isJunction=this.tableMetadataArgs.type==="closure-junction"||this.tableMetadataArgs.type==="junction",this.isClosureJunction=this.tableMetadataArgs.type==="closure-junction",this.comment=this.tableMetadataArgs.comment}registerColumn(e){this.ownColumns.indexOf(e)===-1&&(this.ownColumns.push(e),this.columns=this.embeddeds.reduce((t,n)=>t.concat(n.columnsFromTree),this.ownColumns),this.primaryColumns=this.columns.filter(t=>t.isPrimary),this.hasMultiplePrimaryKeys=this.primaryColumns.length>1,this.hasUUIDGeneratedColumns=this.columns.filter(t=>t.isGenerated||t.generationStrategy==="uuid").length>0,this.propertiesMap=this.createPropertiesMap(),this.childEntityMetadatas&&this.childEntityMetadatas.forEach(t=>t.registerColumn(e)))}createPropertiesMap(){const e={};return this.columns.forEach(t=>re.mergeDeep(e,t.createValueMap(t.propertyPath))),this.relations.forEach(t=>re.mergeDeep(e,t.createValueMap(t.propertyPath))),e}getInsertionReturningColumns(){return this.columns.filter(e=>e.default!==void 0||e.asExpression!==void 0||e.isGenerated||e.isCreateDate||e.isUpdateDate||e.isDeleteDate||e.isVersion)}}class Vp{constructor(e){this.queryRunner=e}async insert(e){let t=e.metadata.treeParentRelation.getEntityValue(e.entity);!t&&e.parentSubject&&e.parentSubject.entity&&(t=e.parentSubject.insertedValueSet?e.parentSubject.insertedValueSet:e.parentSubject.entity);const n=e.metadata.getEntityIdMap(t);let r="";n&&(r=await this.getEntityPath(e,n));const i=e.metadata.treeParentRelation.joinColumns.map(a=>a.referencedColumn.getEntityValue(e.insertedValueSet)).join("_");await this.queryRunner.manager.createQueryBuilder().update(e.metadata.target).set({[e.metadata.materializedPathColumn.propertyPath]:r+i+"."}).where(e.identifier).execute()}async update(e){let t=e.metadata.treeParentRelation.getEntityValue(e.entity);!t&&e.parentSubject&&e.parentSubject.entity&&(t=e.parentSubject.entity);let n=e.databaseEntity;!n&&t&&(n=e.metadata.treeChildrenRelation.getEntityValue(t).find(p=>Object.entries(e.identifier).every(([m,w])=>p[m]===w)));const r=e.metadata.treeParentRelation.getEntityValue(n),i=this.getEntityParentReferencedColumnMap(e,r),a=this.getEntityParentReferencedColumnMap(e,t);if(re.compareIds(i,a))return;let o="";a&&(o=await this.getEntityPath(e,a));let l="";i&&(l=await this.getEntityPath(e,i)||"");const h=e.metadata.treeParentRelation.joinColumns.map(p=>p.referencedColumn.getEntityValue(n)).join("_"),d=e.metadata.materializedPathColumn.propertyPath;await this.queryRunner.manager.createQueryBuilder().update(e.metadata.target).set({[d]:()=>`REPLACE(${this.queryRunner.connection.driver.escape(d)}, '${l}${h}.', '${o}${h}.')`}).where(`${d} LIKE :path`,{path:`${l}${h}.%`}).execute()}getEntityParentReferencedColumnMap(e,t){if(t)return Xn.getValueMap(t,e.metadata.treeParentRelation.joinColumns.map(n=>n.referencedColumn).filter(n=>n!=null),{skipNulls:!0})}getEntityPath(e,t){const n=e.metadata,r=(Array.isArray(t)?t:[t]).map(i=>n.ensureEntityIdMap(i));return this.queryRunner.manager.createQueryBuilder().select(e.metadata.targetName+"."+e.metadata.materializedPathColumn.propertyPath,"path").from(e.metadata.target,e.metadata.targetName).where(new Oo(i=>{for(const a of r)i.orWhere(new Oo(o=>o.where(a)))})).getRawOne().then(i=>i?i.path:"")}}class _x{constructor(e,t,n){this.hasExecutableOperations=!1,this.insertSubjects=[],this.updateSubjects=[],this.removeSubjects=[],this.softRemoveSubjects=[],this.recoverSubjects=[],this.queryRunner=e,this.allSubjects=t,this.options=n,this.validate(),this.recompute()}async execute(){let e;(!this.options||this.options.listeners!==!1)&&(e=this.broadcastBeforeEventsForAll(),e.promises.length>0&&await Promise.all(e.promises)),e&&e.count>0&&(this.insertSubjects.forEach(t=>t.recompute()),this.updateSubjects.forEach(t=>t.recompute()),this.removeSubjects.forEach(t=>t.recompute()),this.softRemoveSubjects.forEach(t=>t.recompute()),this.recoverSubjects.forEach(t=>t.recompute()),this.recompute()),this.insertSubjects=new Wp(this.insertSubjects).sort("insert"),await this.executeInsertOperations(),this.updateSubjects=this.allSubjects.filter(t=>t.mustBeUpdated),await this.executeUpdateOperations(),this.removeSubjects=new Wp(this.removeSubjects).sort("delete"),await this.executeRemoveOperations(),this.softRemoveSubjects=this.allSubjects.filter(t=>t.mustBeSoftRemoved),await this.executeSoftRemoveOperations(),this.recoverSubjects=this.allSubjects.filter(t=>t.mustBeRecovered),await this.executeRecoverOperations(),this.updateSpecialColumnsInPersistedEntities(),(!this.options||this.options.listeners!==!1)&&(e=this.broadcastAfterEventsForAll(),e.promises.length>0&&await Promise.all(e.promises))}validate(){this.allSubjects.forEach(e=>{if(e.mustBeUpdated&&e.mustBeRemoved)throw new q0(e)})}recompute(){new Rx().compute(this.allSubjects),this.insertSubjects=this.allSubjects.filter(e=>e.mustBeInserted),this.updateSubjects=this.allSubjects.filter(e=>e.mustBeUpdated),this.removeSubjects=this.allSubjects.filter(e=>e.mustBeRemoved),this.softRemoveSubjects=this.allSubjects.filter(e=>e.mustBeSoftRemoved),this.recoverSubjects=this.allSubjects.filter(e=>e.mustBeRecovered),this.hasExecutableOperations=this.insertSubjects.length>0||this.updateSubjects.length>0||this.removeSubjects.length>0||this.softRemoveSubjects.length>0||this.recoverSubjects.length>0}broadcastBeforeEventsForAll(){const e=new $n;return this.insertSubjects.length&&this.insertSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastBeforeInsertEvent(e,t.metadata,t.entity)),this.updateSubjects.length&&this.updateSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastBeforeUpdateEvent(e,t.metadata,t.entity,t.databaseEntity,t.diffColumns,t.diffRelations)),this.removeSubjects.length&&this.removeSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastBeforeRemoveEvent(e,t.metadata,t.entity,t.databaseEntity,t.identifier)),this.softRemoveSubjects.length&&this.softRemoveSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastBeforeSoftRemoveEvent(e,t.metadata,t.entity,t.databaseEntity,t.identifier)),this.recoverSubjects.length&&this.recoverSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastBeforeRecoverEvent(e,t.metadata,t.entity,t.databaseEntity,t.identifier)),e}broadcastAfterEventsForAll(){const e=new $n;return this.insertSubjects.length&&this.insertSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastAfterInsertEvent(e,t.metadata,t.entity,t.identifier)),this.updateSubjects.length&&this.updateSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastAfterUpdateEvent(e,t.metadata,t.entity,t.databaseEntity,t.diffColumns,t.diffRelations)),this.removeSubjects.length&&this.removeSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastAfterRemoveEvent(e,t.metadata,t.entity,t.databaseEntity,t.identifier)),this.softRemoveSubjects.length&&this.softRemoveSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastAfterSoftRemoveEvent(e,t.metadata,t.entity,t.databaseEntity,t.identifier)),this.recoverSubjects.length&&this.recoverSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastAfterRecoverEvent(e,t.metadata,t.entity,t.databaseEntity,t.identifier)),e}async executeInsertOperations(){const[e,t]=this.groupBulkSubjects(this.insertSubjects,"insert");for(const n of t){const r=e[n],i=[],a=[],o=[];if(this.queryRunner.connection.driver.options.type==="mongodb"?r.forEach(l=>{l.metadata.createDateColumn&&l.entity&&(l.entity[l.metadata.createDateColumn.databaseName]=new Date),l.metadata.updateDateColumn&&l.entity&&(l.entity[l.metadata.updateDateColumn.databaseName]=new Date),l.createValueSetAndPopChangeMap(),a.push(l),i.push(l.entity)}):this.queryRunner.connection.driver.options.type==="oracle"?r.forEach(l=>{o.push(l)}):r.forEach(l=>{l.changeMaps.length===0||l.metadata.treeType||this.queryRunner.connection.driver.options.type==="oracle"||this.queryRunner.connection.driver.options.type==="sap"?o.push(l):(a.push(l),i.push(l.createValueSetAndPopChangeMap()))}),B.isMongoEntityManager(this.queryRunner.manager)){const l=await this.queryRunner.manager.insert(r[0].metadata.target,i);r.forEach((h,d)=>{h.identifier=l.identifiers[d],h.generatedMap=l.generatedMaps[d],h.insertedValueSet=i[d]})}else{if(i.length>0){const l=await this.queryRunner.manager.createQueryBuilder().insert().into(r[0].metadata.target).values(i).updateEntity(!(this.options&&this.options.reload===!1)).callListeners(!1).execute();a.forEach((h,d)=>{h.identifier=l.identifiers[d],h.generatedMap=l.generatedMaps[d],h.insertedValueSet=i[d]})}if(o.length>0)for(const l of o)l.insertedValueSet=l.createValueSetAndPopChangeMap(),l.metadata.treeType==="nested-set"&&await new zu(this.queryRunner).insert(l),await this.queryRunner.manager.createQueryBuilder().insert().into(l.metadata.target).values(l.insertedValueSet).updateEntity(!(this.options&&this.options.reload===!1)).callListeners(!1).execute().then(h=>{l.identifier=h.identifiers[0],l.generatedMap=h.generatedMaps[0]}),l.metadata.treeType==="closure-table"?await new Ku(this.queryRunner).insert(l):l.metadata.treeType==="materialized-path"&&await new Vp(this.queryRunner).insert(l)}r.forEach(l=>{l.generatedMap&&l.metadata.columns.forEach(h=>{const d=h.getEntityValue(l.generatedMap);if(d!=null){const p=this.queryRunner.connection.driver.prepareHydratedValue(d,h);h.setEntityValue(l.generatedMap,p)}})})}}async executeUpdateOperations(){const e=async i=>{if(!i.identifier)throw new ro(i);if(B.isMongoEntityManager(this.queryRunner.manager)){const a=this.cloneMongoSubjectEntity(i);i.metadata.objectIdColumn&&i.metadata.objectIdColumn.propertyName&&delete a[i.metadata.objectIdColumn.propertyName],i.metadata.createDateColumn&&i.metadata.createDateColumn.propertyName&&delete a[i.metadata.createDateColumn.propertyName],i.metadata.updateDateColumn&&i.metadata.updateDateColumn.propertyName&&(a[i.metadata.updateDateColumn.propertyName]=new Date),await this.queryRunner.manager.update(i.metadata.target,i.identifier,a)}else{const a=i.createValueSetAndPopChangeMap();switch(i.metadata.treeType){case"nested-set":await new zu(this.queryRunner).update(i);break;case"closure-table":await new Ku(this.queryRunner).update(i);break;case"materialized-path":await new Vp(this.queryRunner).update(i);break}const o=this.queryRunner.manager.createQueryBuilder().update(i.metadata.target).set(a).updateEntity(!(this.options&&this.options.reload===!1)).callListeners(!1);i.entity?o.whereEntity(i.identifier):o.where(i.identifier);const h=(await o.execute()).generatedMaps[0];h&&(i.metadata.columns.forEach(d=>{const p=d.getEntityValue(h);if(p!=null){const m=this.queryRunner.connection.driver.prepareHydratedValue(p,d);d.setEntityValue(h,m)}}),i.generatedMap||(i.generatedMap={}),Object.assign(i.generatedMap,h))}},t=[],n=[];for(const i of this.updateSubjects)i.metadata.treeType==="nested-set"?t.push(i):n.push(i);const r=async()=>{for(const i of t)await e(i)};await Promise.all([...n.map(e),r()])}async executeRemoveOperations(){const[e,t]=this.groupBulkSubjects(this.removeSubjects,"delete");for(const n of t){const r=e[n],i=r.map(a=>{if(!a.identifier)throw new ro(a);return a.identifier});if(B.isMongoEntityManager(this.queryRunner.manager))await this.queryRunner.manager.delete(r[0].metadata.target,i);else{switch(r[0].metadata.treeType){case"nested-set":await new zu(this.queryRunner).remove(r);break;case"closure-table":await new Ku(this.queryRunner).remove(r);break}await this.queryRunner.manager.createQueryBuilder().delete().from(r[0].metadata.target).where(i).callListeners(!1).execute()}}}cloneMongoSubjectEntity(e){const t={};if(e.entity)for(const n of e.metadata.columns)re.mergeDeep(t,n.getEntityValueMap(e.entity));return t}async executeSoftRemoveOperations(){await Promise.all(this.softRemoveSubjects.map(async e=>{if(!e.identifier)throw new ro(e);let t;if(B.isMongoEntityManager(this.queryRunner.manager)){const n=this.cloneMongoSubjectEntity(e);e.metadata.objectIdColumn&&e.metadata.objectIdColumn.propertyName&&delete n[e.metadata.objectIdColumn.propertyName],e.metadata.createDateColumn&&e.metadata.createDateColumn.propertyName&&delete n[e.metadata.createDateColumn.propertyName],e.metadata.updateDateColumn&&e.metadata.updateDateColumn.propertyName&&(n[e.metadata.updateDateColumn.propertyName]=new Date),e.metadata.deleteDateColumn&&e.metadata.deleteDateColumn.propertyName&&(n[e.metadata.deleteDateColumn.propertyName]=new Date),t=await this.queryRunner.manager.update(e.metadata.target,e.identifier,n)}else{const n=this.queryRunner.manager.createQueryBuilder().softDelete().from(e.metadata.target).updateEntity(!(this.options&&this.options.reload===!1)).callListeners(!1);e.entity?n.whereEntity(e.identifier):n.where(e.identifier),t=await n.execute()}e.generatedMap=t.generatedMaps[0],e.generatedMap&&e.metadata.columns.forEach(n=>{const r=n.getEntityValue(e.generatedMap);if(r!=null){const i=this.queryRunner.connection.driver.prepareHydratedValue(r,n);n.setEntityValue(e.generatedMap,i)}})}))}async executeRecoverOperations(){await Promise.all(this.recoverSubjects.map(async e=>{if(!e.identifier)throw new ro(e);let t;if(B.isMongoEntityManager(this.queryRunner.manager)){const n=this.cloneMongoSubjectEntity(e);e.metadata.objectIdColumn&&e.metadata.objectIdColumn.propertyName&&delete n[e.metadata.objectIdColumn.propertyName],e.metadata.createDateColumn&&e.metadata.createDateColumn.propertyName&&delete n[e.metadata.createDateColumn.propertyName],e.metadata.updateDateColumn&&e.metadata.updateDateColumn.propertyName&&(n[e.metadata.updateDateColumn.propertyName]=new Date),e.metadata.deleteDateColumn&&e.metadata.deleteDateColumn.propertyName&&(n[e.metadata.deleteDateColumn.propertyName]=null),t=await this.queryRunner.manager.update(e.metadata.target,e.identifier,n)}else{const n=this.queryRunner.manager.createQueryBuilder().restore().from(e.metadata.target).updateEntity(!(this.options&&this.options.reload===!1)).callListeners(!1);e.entity?n.whereEntity(e.identifier):n.where(e.identifier),t=await n.execute()}e.generatedMap=t.generatedMaps[0],e.generatedMap&&e.metadata.columns.forEach(n=>{const r=n.getEntityValue(e.generatedMap);if(r!=null){const i=this.queryRunner.connection.driver.prepareHydratedValue(r,n);n.setEntityValue(e.generatedMap,i)}})}))}updateSpecialColumnsInPersistedEntities(){this.insertSubjects.length&&this.updateSpecialColumnsInInsertedAndUpdatedEntities(this.insertSubjects),this.updateSubjects.length&&this.updateSpecialColumnsInInsertedAndUpdatedEntities(this.updateSubjects),this.softRemoveSubjects.length&&this.updateSpecialColumnsInInsertedAndUpdatedEntities(this.softRemoveSubjects),this.recoverSubjects.length&&this.updateSpecialColumnsInInsertedAndUpdatedEntities(this.recoverSubjects),this.removeSubjects.length&&this.removeSubjects.forEach(e=>{e.entity&&e.metadata.primaryColumns.forEach(t=>{t.setEntityValue(e.entity,void 0)})}),this.allSubjects.forEach(e=>{e.entity&&(e.metadata.relationIds.forEach(t=>{t.setValue(e.entity)}),B.isMongoEntityManager(this.queryRunner.manager)&&e.metadata.objectIdColumn&&e.metadata.objectIdColumn.databaseName&&e.metadata.objectIdColumn.databaseName!==e.metadata.objectIdColumn.propertyName&&delete e.entity[e.metadata.objectIdColumn.databaseName])})}updateSpecialColumnsInInsertedAndUpdatedEntities(e){e.forEach(t=>{t.entity&&(t.metadata.columns.forEach(n=>{t.metadata.childEntityMetadatas.length>0&&t.metadata.childEntityMetadatas.map(r=>r.target).indexOf(n.target)!==-1||n.isVirtual||n.isDeleteDate||(n.isNullable&&n.getEntityValue(t.entity)===void 0&&n.setEntityValue(t.entity,null),t.updatedRelationMaps.length>0&&t.updatedRelationMaps.forEach(r=>{r.relation.joinColumns.forEach(i=>{i.isVirtual!==!0&&i.setEntityValue(t.entity,Re.isObject(r.value)?i.referencedColumn.getEntityValue(r.value):r.value)})}))}),t.generatedMap&&this.queryRunner.manager.merge(t.metadata.target,t.entity,t.generatedMap))})}groupBulkSubjects(e,t){const n={},r=[],i=e.some(o=>o.metadata.getInsertionReturningColumns().length>0),a=t==="delete"||this.queryRunner.connection.driver.isReturningSqlSupported("insert")||i===!1;return e.forEach((o,l)=>{const h=a||o.metadata.isJunction?o.metadata.name:o.metadata.name+"_"+l;n[h]?n[h].push(o):(n[h]=[o],r.push(h))}),[n,r]}}let $r=class{constructor(e){this["@instanceof"]=Symbol.for("Subject"),this.identifier=void 0,this.entityWithFulfilledIds=void 0,this.databaseEntityLoaded=!1,this.changeMaps=[],this.canBeInserted=!1,this.canBeUpdated=!1,this.mustBeRemoved=!1,this.canBeSoftRemoved=!1,this.canBeRecovered=!1,this.updatedRelationMaps=[],this.diffColumns=[],this.diffRelations=[],this.metadata=e.metadata,this.entity=e.entity,this.parentSubject=e.parentSubject,e.canBeInserted!==void 0&&(this.canBeInserted=e.canBeInserted),e.canBeUpdated!==void 0&&(this.canBeUpdated=e.canBeUpdated),e.mustBeRemoved!==void 0&&(this.mustBeRemoved=e.mustBeRemoved),e.canBeSoftRemoved!==void 0&&(this.canBeSoftRemoved=e.canBeSoftRemoved),e.canBeRecovered!==void 0&&(this.canBeRecovered=e.canBeRecovered),e.identifier!==void 0&&(this.identifier=e.identifier),e.changeMaps!==void 0&&this.changeMaps.push(...e.changeMaps),this.recompute()}get mustBeInserted(){return this.canBeInserted&&!this.databaseEntity}get mustBeUpdated(){return this.canBeUpdated&&this.identifier&&(this.databaseEntityLoaded===!1||this.databaseEntityLoaded&&this.databaseEntity)&&this.changeMaps.some(e=>!e.column||e.column.isUpdate)}get mustBeSoftRemoved(){return this.canBeSoftRemoved&&this.identifier&&(this.databaseEntityLoaded===!1||this.databaseEntityLoaded&&this.databaseEntity)}get mustBeRecovered(){return this.canBeRecovered&&this.identifier&&(this.databaseEntityLoaded===!1||this.databaseEntityLoaded&&this.databaseEntity)}createValueSetAndPopChangeMap(){const e=[],t=this.changeMaps.reduce((n,r)=>{let i=r.value;B.isSubject(i)&&(i=i.insertedValueSet?i.insertedValueSet:i.entity);let a;if(this.metadata.isJunction&&r.column)a=r.column.createValueMap(r.column.referencedColumn.getEntityValue(i));else if(r.column)a=r.column.createValueMap(i);else if(r.relation)if(Re.isObject(i)&&!Buffer.isBuffer(i)){const o=r.relation.getRelationIdMap(i);if(o===void 0)return e.push(r),this.canBeUpdated=!0,n;a=r.relation.createValueMap(o),this.updatedRelationMaps.push({relation:r.relation,value:o})}else a=r.relation.createValueMap(i),this.updatedRelationMaps.push({relation:r.relation,value:i});return re.mergeDeep(n,a),n},{});return this.changeMaps=e,t}recompute(){this.entity?(this.entityWithFulfilledIds=Object.assign({},this.entity),this.parentSubject&&this.metadata.primaryColumns.forEach(e=>{if(e.relationMetadata&&e.relationMetadata.inverseEntityMetadata===this.parentSubject.metadata){const t=e.referencedColumn.getEntityValue(this.parentSubject.entity);e.setEntityValue(this.entityWithFulfilledIds,t)}}),this.identifier=this.metadata.getEntityIdMap(this.entityWithFulfilledIds)):this.databaseEntity&&(this.identifier=this.metadata.getEntityIdMap(this.databaseEntity))}};class xx{constructor(e){this.subjects=e}build(){this.subjects.forEach(e=>{e.metadata.oneToManyRelations.forEach(t=>{t.persistenceEnabled!==!1&&this.buildForSubjectRelation(e,t)})})}buildForSubjectRelation(e,t){var a;let n=[];if(e.databaseEntity){const o=t.getEntityValue(e.databaseEntity);o&&(n=o.map(l=>t.inverseEntityMetadata.getEntityIdMap(l)))}let r=t.getEntityValue(e.entity);if(r===null&&(r=[]),r===void 0)return;const i=[];r.forEach(o=>{let l=t.inverseEntityMetadata.getEntityIdMap(o),h=this.subjects.find(p=>p.entity===o);if(h&&(l=h.identifier),!l){if(!h)return;h.changeMaps.push({relation:t.inverseRelation,value:e});return}n.find(p=>re.compareIds(l,p))||(h||(h=new $r({metadata:t.inverseEntityMetadata,parentSubject:e,canBeUpdated:!0,identifier:l}),this.subjects.push(h)),h.changeMaps.push({relation:t.inverseRelation,value:e})),i.push(l)}),((a=t.inverseRelation)==null?void 0:a.orphanedRowAction)!=="disable"&&Xn.difference(n,i).forEach(o=>{const l=new $r({metadata:t.inverseEntityMetadata,parentSubject:e,identifier:o});!t.inverseRelation||t.inverseRelation.orphanedRowAction==="nullify"?(l.canBeUpdated=!0,l.changeMaps=[{relation:t.inverseRelation,value:null}]):t.inverseRelation.orphanedRowAction==="delete"?l.mustBeRemoved=!0:t.inverseRelation.orphanedRowAction==="soft-delete"&&(l.canBeSoftRemoved=!0),this.subjects.push(l)})}}class Mx{constructor(e){this.subjects=e}build(){this.subjects.forEach(e=>{e.metadata.oneToOneRelations.forEach(t=>{t.isOwning||t.persistenceEnabled===!1||this.buildForSubjectRelation(e,t)})})}buildForSubjectRelation(e,t){let n;e.databaseEntity&&(n=t.getEntityValue(e.databaseEntity));const r=t.getEntityValue(e.entity);if(r===void 0)return;if(r===null){if(n){const l=new $r({metadata:t.inverseEntityMetadata,parentSubject:e,canBeUpdated:!0,identifier:n,changeMaps:[{relation:t.inverseRelation,value:null}]});this.subjects.push(l)}return}let i=t.inverseEntityMetadata.getEntityIdMap(r),a=this.subjects.find(l=>!!l.entity&&l.entity===r);if(a&&(i=a.identifier),!i){if(!a)return;a.changeMaps.push({relation:t.inverseRelation,value:e})}n&&re.compareIds(i,n)||(a||(a=new $r({metadata:t.inverseEntityMetadata,canBeUpdated:!0,identifier:i}),this.subjects.push(a)),a.changeMaps.push({relation:t.inverseRelation,value:e}))}}class Hp{constructor(e){this.subjects=e}build(){this.subjects.forEach(e=>{e.entity&&e.metadata.manyToManyRelations.forEach(t=>{t.persistenceEnabled!==!1&&this.buildForSubjectRelation(e,t)})})}buildForAllRemoval(e){e.databaseEntity&&e.metadata.manyToManyRelations.forEach(t=>{if(t.persistenceEnabled===!1)return;t.getEntityValue(e.databaseEntity).forEach(r=>{const i=new $r({metadata:t.junctionEntityMetadata,parentSubject:e,mustBeRemoved:!0,identifier:this.buildJunctionIdentifier(e,t,r)});this.subjects.push(i)})})}buildForSubjectRelation(e,t){let n=[];if(e.databaseEntity){const o=t.getEntityValue(e.databaseEntity);o&&(n=o.map(l=>t.inverseEntityMetadata.getEntityIdMap(l)))}let r=t.getEntityValue(e.entity);if(r===null&&(r=[]),!Array.isArray(r))return;r.forEach(o=>{let l=t.inverseEntityMetadata.getEntityIdMap(o);const h=this.subjects.find(b=>b.entity===o);if(h&&(l=h.identifier),!l&&!h||n.find(b=>re.compareIds(b,l)))return;const p=t.isOwning?e:h||o,m=t.isOwning?h||o:e,w=new $r({metadata:t.junctionEntityMetadata,parentSubject:e,canBeInserted:!0});this.subjects.push(w),t.junctionEntityMetadata.ownerColumns.forEach(b=>{w.changeMaps.push({column:b,value:p})}),t.junctionEntityMetadata.inverseColumns.forEach(b=>{w.changeMaps.push({column:b,value:m})})});const i=[];r.forEach(o=>{let l=t.inverseEntityMetadata.getEntityIdMap(o);const h=this.subjects.find(d=>d.entity===o);h&&(l=h.identifier),l!=null&&i.push(l)}),n.filter(o=>!i.find(l=>re.compareIds(l,o))).forEach(o=>{const l=new $r({metadata:t.junctionEntityMetadata,parentSubject:e,mustBeRemoved:!0,identifier:this.buildJunctionIdentifier(e,t,o)});this.subjects.push(l)})}buildJunctionIdentifier(e,t,n){const r=t.isOwning?e.entity:n,i=t.isOwning?n:e.entity,a={};return t.junctionEntityMetadata.ownerColumns.forEach(o=>{re.mergeDeep(a,o.createValueMap(o.referencedColumn.getEntityValue(r)))}),t.junctionEntityMetadata.inverseColumns.forEach(o=>{re.mergeDeep(a,o.createValueMap(o.referencedColumn.getEntityValue(i)))}),a}}class Px{constructor(e,t){this.queryRunner=e,this.subjects=t}async load(e){const t=this.groupByEntityTargets().map(async n=>{const r=[],i=[];if(n.subjects.forEach(h=>{h.databaseEntity||!h.identifier||(r.push(h.identifier),i.push(h))}),!r.length)return;const a=[];e==="save"||e==="soft-remove"||e==="recover"?n.subjects.forEach(h=>{h.metadata.relations.forEach(d=>{d.getEntityValue(h.entityWithFulfilledIds)!==void 0&&a.indexOf(d.propertyPath)===-1&&a.push(d.propertyPath)})}):a.push(...n.subjects[0].metadata.manyToManyRelations.map(h=>h.propertyPath));const o={loadEagerRelations:!1,loadRelationIds:{relations:a,disableMixedMap:!0},withDeleted:!0};let l=[];this.queryRunner.connection.driver.options.type==="mongodb"?l=await this.queryRunner.manager.getRepository(n.target).findByIds(r,o):l=await this.queryRunner.manager.getRepository(n.target).createQueryBuilder().setFindOptions(o).whereInIds(r).getMany(),l.forEach(h=>{const d=i[0].metadata.getEntityIdMap(h);i.forEach(p=>{p.databaseEntity||re.compareIds(p.identifier,d)&&(p.databaseEntity=h)})});for(const h of i)h.databaseEntityLoaded=!0});await Promise.all(t)}groupByEntityTargets(){return this.subjects.reduce((e,t)=>{let n=e.find(r=>r.target===t.metadata.target);return n||(n={target:t.metadata.target,subjects:[]},e.push(n)),n.subjects.push(t),e},[])}}class Ox{constructor(e){this.allSubjects=e}build(e,t){e.metadata.extractRelationValuesFromEntity(e.entity,e.metadata.relations).forEach(([n,r,i])=>{if(r==null||!n.isCascadeInsert&&!n.isCascadeUpdate&&!n.isCascadeSoftRemove&&!n.isCascadeRecover||!Re.isObject(r))return;const a=this.findByPersistEntityLike(i.target,r);if(a){a.canBeInserted===!1&&(a.canBeInserted=n.isCascadeInsert===!0&&t==="save"),a.canBeUpdated===!1&&(a.canBeUpdated=n.isCascadeUpdate===!0&&t==="save"),a.canBeSoftRemoved===!1&&(a.canBeSoftRemoved=n.isCascadeSoftRemove===!0&&t==="soft-remove"),a.canBeRecovered===!1&&(a.canBeRecovered=n.isCascadeRecover===!0&&t==="recover");return}const o=new $r({metadata:i,parentSubject:e,entity:r,canBeInserted:n.isCascadeInsert===!0&&t==="save",canBeUpdated:n.isCascadeUpdate===!0&&t==="save",canBeSoftRemoved:n.isCascadeSoftRemove===!0&&t==="soft-remove",canBeRecovered:n.isCascadeRecover===!0&&t==="recover"});this.allSubjects.push(o),this.build(o,t)})}findByPersistEntityLike(e,t){return this.allSubjects.find(n=>n.entity?n.entity===t?!0:n.metadata.target===e&&n.metadata.compareEntities(n.entityWithFulfilledIds,t):!1)}}class ao{constructor(e,t,n,r,i,a){this.connection=e,this.queryRunner=t,this.mode=n,this.target=r,this.entity=i,this.options=a}async execute(){if(!this.entity||typeof this.entity!="object")return Promise.reject(new S0(this.mode,this.entity));await Promise.resolve();const e=this.queryRunner||this.connection.createQueryRunner(),t=e.data;this.options&&this.options.data&&(e.data=this.options.data);try{const n=Array.isArray(this.entity)?this.entity:[this.entity],r=this.options&&this.options.chunk&&this.options.chunk>0?re.chunk(n,this.options.chunk):[n],a=(await Promise.all(r.map(async l=>{const h=[];l.forEach(p=>{const m=this.target?this.target:p.constructor;if(m===Object)throw new E0(this.mode);const w=this.connection.getMetadata(m).findInheritanceMetadata(p);h.push(new $r({metadata:w,entity:p,canBeInserted:this.mode==="save",canBeUpdated:this.mode==="save",mustBeRemoved:this.mode==="remove",canBeSoftRemoved:this.mode==="soft-remove",canBeRecovered:this.mode==="recover"}))});const d=new Ox(h);return h.forEach(p=>{d.build(p,this.mode)}),await new Px(e,h).load(this.mode),this.mode==="save"||this.mode==="soft-remove"||this.mode==="recover"?(new xx(h).build(),new Mx(h).build(),new Hp(h).build()):h.forEach(p=>{p.mustBeRemoved&&new Hp(h).buildForAllRemoval(p)}),new _x(e,h,this.options)}))).filter(l=>l.hasExecutableOperations);if(a.length===0)return;let o=!1;try{e.isTransactionActive||this.connection.driver.transactionSupport!=="none"&&(!this.options||this.options.transaction!==!1)&&(o=!0,await e.startTransaction());for(const l of a)await l.execute();o===!0&&await e.commitTransaction()}catch(l){if(o)try{await e.rollbackTransaction()}catch{}throw l}}finally{e.data=t,this.queryRunner||await e.release()}}}class xy{constructor(e,t){this["@instanceof"]=Symbol.for("EntityManager"),this.repositories=new Map,this.treeRepositories=[],this.plainObjectToEntityTransformer=new Sx,this.connection=e,t&&(this.queryRunner=t,Re.assign(this.queryRunner,{manager:this}))}async transaction(e,t){const n=typeof e=="string"?e:void 0,r=typeof e=="function"?e:t;if(!r)throw new x("Transaction method requires callback in second parameter if isolation level is supplied.");if(this.queryRunner&&this.queryRunner.isReleased)throw new sy;const i=this.queryRunner||this.connection.createQueryRunner();try{await i.startTransaction(n);const a=await r(i.manager);return await i.commitTransaction(),a}catch(a){try{await i.rollbackTransaction()}catch{}throw a}finally{this.queryRunner||await i.release()}}async query(e,t){return this.connection.query(e,t,this.queryRunner)}async sql(e,...t){const{query:n,parameters:r}=ec({driver:this.connection.driver,strings:e,expressions:t});return await this.query(n,r)}createQueryBuilder(e,t,n){return t?this.connection.createQueryBuilder(e,t,n||this.queryRunner):this.connection.createQueryBuilder(e||n||this.queryRunner)}hasId(e,t){const n=arguments.length===2?e:e.constructor,r=arguments.length===2?t:e;return this.connection.getMetadata(n).hasId(r)}getId(e,t){const n=arguments.length===2?e:e.constructor,r=arguments.length===2?t:e;return this.connection.getMetadata(n).getEntityIdMixedMap(r)}create(e,t){const n=this.connection.getMetadata(e);if(!t)return n.create(this.queryRunner);if(Array.isArray(t))return t.map(i=>this.create(e,i));const r=n.create(this.queryRunner);return this.plainObjectToEntityTransformer.transform(r,t,n,!0),r}merge(e,t,...n){const r=this.connection.getMetadata(e);return n.forEach(i=>this.plainObjectToEntityTransformer.transform(t,i,r)),t}async preload(e,t){const n=this.connection.getMetadata(e),i=await new Cx(this.connection.manager).transform(t,n);if(i)return this.merge(e,i,t)}save(e,t,n){let r=arguments.length>1&&(typeof e=="function"||B.isEntitySchema(e)||typeof e=="string")?e:void 0;const i=r?t:e,a=r?n:t;return B.isEntitySchema(r)&&(r=r.options.name),Array.isArray(i)&&i.length===0?Promise.resolve(i):new ao(this.connection,this.queryRunner,"save",r,i,a).execute().then(()=>i)}remove(e,t,n){const r=arguments.length>1&&(typeof e=="function"||B.isEntitySchema(e)||typeof e=="string")?e:void 0,i=r?t:e,a=r?n:t;return Array.isArray(i)&&i.length===0?Promise.resolve(i):new ao(this.connection,this.queryRunner,"remove",r,i,a).execute().then(()=>i)}softRemove(e,t,n){let r=arguments.length>1&&(typeof e=="function"||B.isEntitySchema(e)||typeof e=="string")?e:void 0;const i=r?t:e,a=r?n:t;return B.isEntitySchema(r)&&(r=r.options.name),Array.isArray(i)&&i.length===0?Promise.resolve(i):new ao(this.connection,this.queryRunner,"soft-remove",r,i,a).execute().then(()=>i)}recover(e,t,n){let r=arguments.length>1&&(typeof e=="function"||B.isEntitySchema(e)||typeof e=="string")?e:void 0;const i=r?t:e,a=r?n:t;return B.isEntitySchema(r)&&(r=r.options.name),Array.isArray(i)&&i.length===0?Promise.resolve(i):new ao(this.connection,this.queryRunner,"recover",r,i,a).execute().then(()=>i)}async insert(e,t){return this.createQueryBuilder().insert().into(e).values(t).execute()}async upsert(e,t,n){const r=this.connection.getMetadata(e);let i;Array.isArray(n)?i={conflictPaths:n}:i=n;let a;Array.isArray(t)?a=t:a=[t];const o=r.mapPropertyPathsToColumns(Array.isArray(i.conflictPaths)?i.conflictPaths:Object.keys(i.conflictPaths)),l=r.columns.filter(h=>!o.includes(h)&&a.some(d=>typeof h.getEntityValue(d)<"u"));return this.createQueryBuilder().insert().into(e).values(a).orUpdate([...o,...l].map(h=>h.databaseName),o.map(h=>h.databaseName),{skipUpdateIfNoValuesChanged:i.skipUpdateIfNoValuesChanged,indexPredicate:i.indexPredicate,upsertType:i.upsertType||this.connection.driver.supportedUpsertTypes[0]}).execute()}update(e,t,n){return re.isCriteriaNullOrEmpty(t)?Promise.reject(new x("Empty criteria(s) are not allowed for the update method.")):re.isPrimitiveCriteria(t)?this.createQueryBuilder().update(e).set(n).whereInIds(t).execute():this.createQueryBuilder().update(e).set(n).where(t).execute()}updateAll(e,t){return this.createQueryBuilder().update(e).set(t).execute()}delete(e,t){return re.isCriteriaNullOrEmpty(t)?Promise.reject(new x("Empty criteria(s) are not allowed for the delete method.")):re.isPrimitiveCriteria(t)?this.createQueryBuilder().delete().from(e).whereInIds(t).execute():this.createQueryBuilder().delete().from(e).where(t).execute()}deleteAll(e){return this.createQueryBuilder().delete().from(e).execute()}softDelete(e,t){return re.isCriteriaNullOrEmpty(t)?Promise.reject(new x("Empty criteria(s) are not allowed for the softDelete method.")):re.isPrimitiveCriteria(t)?this.createQueryBuilder().softDelete().from(e).whereInIds(t).execute():this.createQueryBuilder().softDelete().from(e).where(t).execute()}restore(e,t){return re.isCriteriaNullOrEmpty(t)?Promise.reject(new x("Empty criteria(s) are not allowed for the restore method.")):re.isPrimitiveCriteria(t)?this.createQueryBuilder().restore().from(e).whereInIds(t).execute():this.createQueryBuilder().restore().from(e).where(t).execute()}exists(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,Ht.extractFindManyOptionsAlias(t)||n.name).setFindOptions(t||{}).getExists()}async existsBy(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,n.name).setFindOptions({where:t}).getExists()}count(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,Ht.extractFindManyOptionsAlias(t)||n.name).setFindOptions(t||{}).getCount()}countBy(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,n.name).setFindOptions({where:t}).getCount()}sum(e,t,n){return this.callAggregateFun(e,"SUM",t,n)}average(e,t,n){return this.callAggregateFun(e,"AVG",t,n)}minimum(e,t,n){return this.callAggregateFun(e,"MIN",t,n)}maximum(e,t,n){return this.callAggregateFun(e,"MAX",t,n)}async callAggregateFun(e,t,n,r={}){const i=this.connection.getMetadata(e),a=i.columns.find(l=>l.propertyPath===n);if(!a)throw new x(`Column "${n}" was not found in table "${i.name}"`);const o=await this.createQueryBuilder(e,i.name).setFindOptions({where:r}).select(`${t}(${this.connection.driver.escape(a.databaseName)})`,t).getRawOne();return o[t]===null?null:parseFloat(o[t])}async find(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,Ht.extractFindManyOptionsAlias(t)||n.name).setFindOptions(t||{}).getMany()}async findBy(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,n.name).setFindOptions({where:t}).getMany()}findAndCount(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,Ht.extractFindManyOptionsAlias(t)||n.name).setFindOptions(t||{}).getManyAndCount()}findAndCountBy(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,n.name).setFindOptions({where:t}).getManyAndCount()}async findByIds(e,t){if(!t.length)return Promise.resolve([]);const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,n.name).andWhereInIds(t).getMany()}async findOne(e,t){let r=this.connection.getMetadata(e).name;if(t&&t.join&&(r=t.join.alias),!t.where)throw new Error("You must provide selection conditions in order to find a single row.");return this.createQueryBuilder(e,r).setFindOptions({...t,take:1}).getOne()}async findOneBy(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,n.name).setFindOptions({where:t,take:1}).getOne()}async findOneById(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,n.name).setFindOptions({take:1}).whereInIds(n.ensureEntityIdMap(t)).getOne()}async findOneOrFail(e,t){return this.findOne(e,t).then(n=>n===null?Promise.reject(new yl(e,t)):Promise.resolve(n))}async findOneByOrFail(e,t){return this.findOneBy(e,t).then(n=>n===null?Promise.reject(new yl(e,t)):Promise.resolve(n))}async clear(e){const t=this.connection.getMetadata(e),n=this.queryRunner||this.connection.createQueryRunner();try{return await n.clearTable(t.tablePath)}finally{this.queryRunner||await n.release()}}async increment(e,t,n,r){const i=this.connection.getMetadata(e),a=i.findColumnWithPropertyPath(n);if(!a)throw new x(`Column ${n} was not found in ${i.targetName} entity.`);if(isNaN(Number(r)))throw new x(`Value "${r}" is not a number.`);const o=n.split(".").reduceRight((l,h)=>({[h]:l}),()=>this.connection.driver.escape(a.databaseName)+" + "+r);return this.createQueryBuilder(e,"entity").update(e).set(o).where(t).execute()}async decrement(e,t,n,r){const i=this.connection.getMetadata(e),a=i.findColumnWithPropertyPath(n);if(!a)throw new x(`Column ${n} was not found in ${i.targetName} entity.`);if(isNaN(Number(r)))throw new x(`Value "${r}" is not a number.`);const o=n.split(".").reduceRight((l,h)=>({[h]:l}),()=>this.connection.driver.escape(a.databaseName)+" - "+r);return this.createQueryBuilder(e,"entity").update(e).set(o).where(t).execute()}getRepository(e){const t=this.repositories.get(e);if(t)return t;if(this.connection.driver.options.type==="mongodb"){const n=new ux(e,this,this.queryRunner);return this.repositories.set(e,n),n}else{const n=new _y(e,this,this.queryRunner);return this.repositories.set(e,n),n}}getTreeRepository(e){if(this.connection.driver.treeSupport===!1)throw new w0(this.connection.driver);const t=this.treeRepositories.find(r=>r.target===e);if(t)return t;const n=new Tx(e,this,this.queryRunner);return this.treeRepositories.push(n),n}getMongoRepository(e){return this.connection.getMongoRepository(e)}withRepository(e){const t=e.constructor,{target:n,manager:r,queryRunner:i,...a}=e;return Object.assign(new t(e.target,this),{...a})}getCustomRepository(e){const t=Io().entityRepositories.find(i=>i.target===(typeof e=="function"?e:e.constructor));if(!t)throw new ry(e);const n=t.entity?this.connection.getMetadata(t.entity):void 0,r=new t.target(this,n);if(r instanceof vx)r.manager||(r.manager=this);else{if(!n)throw new A0(e);r.manager=this,r.metadata=n}return r}async release(){if(!this.queryRunner)throw new L0;return this.queryRunner.release()}}class Dx extends xy{constructor(e,t){super(e,t),this["@instanceof"]=Symbol.for("SqljsEntityManager"),this.driver=e.driver}async loadDatabase(e){await this.driver.load(e)}async saveDatabase(e){await this.driver.save(e)}exportDatabase(){return this.driver.export()}}class Ix{create(e,t){return e.driver.options.type==="mongodb"?new cx(e):e.driver.options.type==="sqljs"?new Dx(e,t):new xy(e,t)}}class Ur{constructor(e){this["@instanceof"]=Symbol.for("View"),this.indices=[],e&&(this.database=e.database,this.schema=e.schema,this.name=e.name,this.expression=e.expression,this.materialized=!!e.materialized)}clone(){return new Ur({database:this.database,schema:this.schema,name:this.name,expression:this.expression,materialized:this.materialized})}addIndex(e){this.indices.push(e)}removeIndex(e){const t=this.indices.find(n=>n.name===e.name);t&&this.indices.splice(this.indices.indexOf(t),1)}static create(e,t){const n={database:e.database,schema:e.schema,name:t.buildTableName(e.tableName,e.schema,e.database),expression:e.expression,materialized:e.tableMetadataArgs.materialized};return new Ur(n)}}class Yp{static viewMetadataCmp(e,t){return!e||!t?0:e.dependsOn&&(e.dependsOn.has(t.target)||e.dependsOn.has(t.name))?1:t.dependsOn&&(t.dependsOn.has(e.target)||t.dependsOn.has(e.name))?-1:0}}class tc{constructor(e){this.connection=e,this["@instanceof"]=Symbol.for("RdbmsSchemaBuilder")}async build(){this.queryRunner=this.connection.createQueryRunner(),this.currentDatabase=this.connection.driver.database,this.currentSchema=this.connection.driver.schema;const e=this.connection.driver.options.type!=="cockroachdb"&&this.connection.driver.options.type!=="spanner"&&this.connection.options.migrationsTransactionMode!=="none";await this.queryRunner.beforeMigration(),e&&await this.queryRunner.startTransaction();try{await this.createMetadataTableIfNecessary(this.queryRunner);const t=this.entityToSyncMetadatas.map(r=>this.getTablePath(r)),n=this.viewEntityToSyncMetadatas.map(r=>this.getTablePath(r));await this.queryRunner.getTables(t),await this.queryRunner.getViews(n),await this.executeSchemaSyncOperationsInProperOrder(),this.connection.queryResultCache&&await this.connection.queryResultCache.synchronize(this.queryRunner),e&&await this.queryRunner.commitTransaction()}catch(t){try{e&&await this.queryRunner.rollbackTransaction()}catch{}throw t}finally{await this.queryRunner.afterMigration(),await this.queryRunner.release()}}async createMetadataTableIfNecessary(e){(this.viewEntityToSyncMetadatas.length>0||this.hasGeneratedColumns())&&await this.createTypeormMetadataTable(e)}async log(){this.queryRunner=this.connection.createQueryRunner();try{const e=this.entityToSyncMetadatas.map(n=>this.getTablePath(n)),t=this.viewEntityToSyncMetadatas.map(n=>this.getTablePath(n));return await this.queryRunner.getTables(e),await this.queryRunner.getViews(t),this.queryRunner.enableSqlMemory(),await this.executeSchemaSyncOperationsInProperOrder(),this.connection.queryResultCache&&await this.connection.queryResultCache.synchronize(this.queryRunner),this.queryRunner.getMemorySql()}finally{this.queryRunner.disableSqlMemory(),await this.queryRunner.release()}}get entityToSyncMetadatas(){return this.connection.entityMetadatas.filter(e=>e.synchronize&&e.tableType!=="entity-child"&&e.tableType!=="view")}get viewEntityToSyncMetadatas(){return this.connection.entityMetadatas.filter(e=>e.tableType==="view"&&e.synchronize).sort(Yp.viewMetadataCmp)}hasGeneratedColumns(){return this.connection.entityMetadatas.some(e=>e.columns.some(t=>t.generatedType))}async executeSchemaSyncOperationsInProperOrder(){await this.dropOldViews(),await this.dropOldForeignKeys(),await this.dropOldIndices(),await this.dropOldChecks(),await this.dropOldExclusions(),await this.dropCompositeUniqueConstraints(),await this.renameColumns(),await this.changeTableComment(),await this.createNewTables(),await this.dropRemovedColumns(),await this.addNewColumns(),await this.updatePrimaryKeys(),await this.updateExistColumns(),await this.createNewIndices(),await this.createNewChecks(),await this.createNewExclusions(),await this.createCompositeUniqueConstraints(),await this.createForeignKeys(),await this.createViews(),await this.createNewViewIndices()}getTablePath(e){const t=this.connection.driver.parseTableName(e);return this.connection.driver.buildTableName(t.tableName,t.schema||this.currentSchema,t.database||this.currentDatabase)}async dropOldForeignKeys(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(r=>this.getTablePath(r)===this.getTablePath(e));if(!t)continue;const n=t.foreignKeys.filter(r=>{const i=e.foreignKeys.find(a=>r.name===a.name&&this.getTablePath(r)===this.getTablePath(a.referencedEntityMetadata));return!i||i.onDelete&&i.onDelete!==r.onDelete||i.onUpdate&&i.onUpdate!==r.onUpdate});n.length!==0&&(this.connection.logger.logSchemaBuild(`dropping old foreign keys of ${t.name}: ${n.map(r=>r.name).join(", ")}`),await this.queryRunner.dropForeignKeys(t,n))}}async renameTables(){}async renameColumns(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(a=>this.getTablePath(a)===this.getTablePath(e));if(!t||e.columns.length!==t.columns.length)continue;const n=e.columns.filter(a=>!a.isVirtualProperty).filter(a=>!t.columns.find(o=>o.name===a.databaseName&&o.type===this.connection.driver.normalizeType(a)&&o.isNullable===a.isNullable&&o.isUnique===this.connection.driver.normalizeIsUnique(a)));if(n.length===0||n.length>1)continue;const r=t.columns.filter(a=>!e.columns.find(o=>!o.isVirtualProperty&&o.databaseName===a.name&&this.connection.driver.normalizeType(o)===a.type&&o.isNullable===a.isNullable&&this.connection.driver.normalizeIsUnique(o)===a.isUnique));if(r.length===0||r.length>1)continue;const i=r[0].clone();i.name=n[0].databaseName,this.connection.logger.logSchemaBuild(`renaming column "${r[0].name}" in "${t.name}" to "${i.name}"`),await this.queryRunner.renameColumn(t,r[0],i)}}async dropOldIndices(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(r=>this.getTablePath(r)===this.getTablePath(e));if(!t)continue;const n=t.indices.filter(r=>{const i=e.indices.find(a=>a.name===r.name);return i?i.synchronize===!1?!1:i.isUnique!==r.isUnique||i.isSpatial!==r.isSpatial||this.connection.driver.isFullTextColumnTypeSupported()&&i.isFulltext!==r.isFulltext||i.columns.length!==r.columnNames.length?!0:!i.columns.every(a=>r.columnNames.indexOf(a.databaseName)!==-1):!0}).map(async r=>{this.connection.logger.logSchemaBuild(`dropping an index: "${r.name}" from table ${t.name}`),await this.queryRunner.dropIndex(t,r)});await Promise.all(n)}if(this.connection.options.type==="postgres"){const e=this.queryRunner;for(const t of this.viewEntityToSyncMetadatas){const n=this.queryRunner.loadedViews.find(i=>this.getTablePath(i)===this.getTablePath(t));if(!n)continue;const r=n.indices.filter(i=>{const a=t.indices.find(o=>o.name===i.name);return a?a.synchronize===!1?!1:a.isUnique!==i.isUnique||a.isSpatial!==i.isSpatial||this.connection.driver.isFullTextColumnTypeSupported()&&a.isFulltext!==i.isFulltext||a.columns.length!==i.columnNames.length?!0:!a.columns.every(o=>i.columnNames.indexOf(o.databaseName)!==-1):!0}).map(async i=>{this.connection.logger.logSchemaBuild(`dropping an index: "${i.name}" from view ${n.name}`),await e.dropViewIndex(n,i)});await Promise.all(r)}}}async dropOldChecks(){if(!(ie.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"))for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(r=>this.getTablePath(r)===this.getTablePath(e));if(!t)continue;const n=t.checks.filter(r=>!e.checks.find(i=>i.name===r.name));n.length!==0&&(this.connection.logger.logSchemaBuild(`dropping old check constraint: ${n.map(r=>`"${r.name}"`).join(", ")} from table "${t.name}"`),await this.queryRunner.dropCheckConstraints(t,n))}}async dropCompositeUniqueConstraints(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(r=>this.getTablePath(r)===this.getTablePath(e));if(!t)continue;const n=t.uniques.filter(r=>r.columnNames.length>1&&!e.uniques.find(i=>i.name===r.name));n.length!==0&&(this.connection.logger.logSchemaBuild(`dropping old unique constraint: ${n.map(r=>`"${r.name}"`).join(", ")} from table "${t.name}"`),await this.queryRunner.dropUniqueConstraints(t,n))}}async dropOldExclusions(){if(this.connection.driver.options.type==="postgres")for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(r=>this.getTablePath(r)===this.getTablePath(e));if(!t)continue;const n=t.exclusions.filter(r=>!e.exclusions.find(i=>i.name===r.name));n.length!==0&&(this.connection.logger.logSchemaBuild(`dropping old exclusion constraint: ${n.map(r=>`"${r.name}"`).join(", ")} from table "${t.name}"`),await this.queryRunner.dropExclusionConstraints(t,n))}}async changeTableComment(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(n=>this.getTablePath(n)===this.getTablePath(e));if(t&&(ie.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="postgres")){const n=e.comment;await this.queryRunner.changeTableComment(t,n)}}}async createNewTables(){for(const e of this.entityToSyncMetadatas){if(this.queryRunner.loadedTables.find(r=>this.getTablePath(r)===this.getTablePath(e)))continue;this.connection.logger.logSchemaBuild(`creating a new table: ${this.getTablePath(e)}`);const n=gt.create(e,this.connection.driver);await this.queryRunner.createTable(n,!1,!1),this.queryRunner.loadedTables.push(n)}}async createViews(){for(const e of this.viewEntityToSyncMetadatas){if(this.queryRunner.loadedViews.find(r=>{const i=typeof r.expression=="string"?r.expression.trim():r.expression(this.connection).getQuery(),a=typeof e.expression=="string"?e.expression.trim():e.expression(this.connection).getQuery();return this.getTablePath(r)===this.getTablePath(e)&&i===a}))continue;this.connection.logger.logSchemaBuild(`creating a new view: ${this.getTablePath(e)}`);const n=Ur.create(e,this.connection.driver);await this.queryRunner.createView(n,!0),this.queryRunner.loadedViews.push(n)}}async dropOldViews(){const e=[],t=this.viewEntityToSyncMetadatas,n=new Map;for(const a of this.queryRunner.loadedViews){const o=t.find(l=>this.getTablePath(a)===this.getTablePath(l));o&&n.set(a,o)}for(const a of this.queryRunner.loadedViews){const o=n.get(a);if(!o)continue;const l=typeof a.expression=="string"?a.expression.trim():a.expression(this.connection).getQuery(),h=typeof o.expression=="string"?o.expression.trim():o.expression(this.connection).getQuery();l!==h&&(this.connection.logger.logSchemaBuild(`dropping an old view: ${a.name}`),e.push(a))}const r=a=>{const o=n.get(a);let l=[a];if(!o)return l;for(const[h,d]of n.entries())h!==a&&d.dependsOn&&(d.dependsOn.has(o.target)||d.dependsOn.has(o.name))&&(l=l.concat(r(h)));return l},i=new Set(e.map(a=>r(a)).reduce((a,o)=>a.concat(o),[]).sort((a,o)=>Yp.viewMetadataCmp(n.get(a),n.get(o))).reverse());for(const a of i)await this.queryRunner.dropView(a);this.queryRunner.loadedViews=this.queryRunner.loadedViews.filter(a=>!i.has(a))}async dropRemovedColumns(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(r=>this.getTablePath(r)===this.getTablePath(e));if(!t)continue;const n=t.columns.filter(r=>!e.columns.find(i=>i.isVirtualProperty||i.databaseName===r.name));n.length!==0&&(this.connection.logger.logSchemaBuild(`columns dropped in ${t.name}: `+n.map(r=>r.name).join(", ")),await this.queryRunner.dropColumns(t,n))}}async addNewColumns(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(a=>this.getTablePath(a)===this.getTablePath(e));if(!t)continue;const n=e.columns.filter(a=>!a.isVirtualProperty&&!t.columns.find(o=>o.name===a.databaseName));if(n.length===0)continue;const i=this.metadataColumnsToTableColumnOptions(n).map(a=>new ln(a));i.length!==0&&(this.connection.logger.logSchemaBuild("new columns added: "+n.map(a=>a.databaseName).join(", ")),await this.queryRunner.addColumns(t,i))}}async updatePrimaryKeys(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===this.getTablePath(e));if(!t)continue;const n=e.columns.filter(i=>i.isPrimary);if(t.columns.filter(i=>i.isPrimary).length!==n.length&&n.length>1){const i=n.map(a=>new ln(bo.createTableColumnOptions(a,this.connection.driver)));await this.queryRunner.updatePrimaryKeys(t,i)}}}async updateExistColumns(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===this.getTablePath(e));if(!t)continue;const n=this.connection.driver.findChangedColumns(t.columns,e.columns);if(n.length===0)continue;for(const i of n)await this.dropColumnReferencedForeignKeys(this.getTablePath(e),i.databaseName);for(const i of n)await this.dropColumnCompositeIndices(this.getTablePath(e),i.databaseName);if(!(ie.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"||this.connection.driver.options.type==="spanner"))for(const i of n)await this.dropColumnCompositeUniques(this.getTablePath(e),i.databaseName);const r=n.map(i=>{const a=t.columns.find(h=>h.name===i.databaseName),o=bo.createTableColumnOptions(i,this.connection.driver),l=new ln(o);return{oldColumn:a,newColumn:l}});r.length!==0&&(this.connection.logger.logSchemaBuild(`columns changed in "${t.name}". updating: `+n.map(i=>i.databaseName).join(", ")),await this.queryRunner.changeColumns(t,r))}}async createNewIndices(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(r=>this.getTablePath(r)===this.getTablePath(e));if(!t)continue;const n=e.indices.filter(r=>!t.indices.find(i=>i.name===r.name)&&r.synchronize===!0).map(r=>Ct.create(r));n.length!==0&&(this.connection.logger.logSchemaBuild(`adding new indices ${n.map(r=>`"${r.name}"`).join(", ")} in table "${t.name}"`),await this.queryRunner.createIndices(t,n))}}async createNewViewIndices(){if(this.connection.options.type!=="postgres"||!ie.isPostgresFamily(this.connection.driver))return;const e=this.queryRunner;for(const t of this.viewEntityToSyncMetadatas){const n=this.queryRunner.loadedViews.find(i=>{const a=typeof i.expression=="string"?i.expression.trim():i.expression(this.connection).getQuery(),o=typeof t.expression=="string"?t.expression.trim():t.expression(this.connection).getQuery();return this.getTablePath(i)===this.getTablePath(t)&&a===o});if(!n||!n.materialized)continue;const r=t.indices.filter(i=>!n.indices.find(a=>a.name===i.name)&&i.synchronize===!0).map(i=>Ct.create(i));r.length!==0&&(this.connection.logger.logSchemaBuild(`adding new indices ${r.map(i=>`"${i.name}"`).join(", ")} in view "${n.name}"`),await e.createViewIndices(n,r))}}async createNewChecks(){if(!(ie.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"))for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(r=>this.getTablePath(r)===this.getTablePath(e));if(!t)continue;const n=e.checks.filter(r=>!t.checks.find(i=>i.name===r.name)).map(r=>Jn.create(r));n.length!==0&&(this.connection.logger.logSchemaBuild(`adding new check constraints: ${n.map(r=>`"${r.name}"`).join(", ")} in table "${t.name}"`),await this.queryRunner.createCheckConstraints(t,n))}}async createCompositeUniqueConstraints(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(r=>this.getTablePath(r)===this.getTablePath(e));if(!t)continue;const n=e.uniques.filter(r=>r.columns.length>1&&!t.uniques.find(i=>i.name===r.name)).map(r=>Gt.create(r));n.length!==0&&(this.connection.logger.logSchemaBuild(`adding new unique constraints: ${n.map(r=>`"${r.name}"`).join(", ")} in table "${t.name}"`),await this.queryRunner.createUniqueConstraints(t,n))}}async createNewExclusions(){if(this.connection.driver.options.type==="postgres")for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(r=>this.getTablePath(r)===this.getTablePath(e));if(!t)continue;const n=e.exclusions.filter(r=>!t.exclusions.find(i=>i.name===r.name)).map(r=>Ri.create(r));n.length!==0&&(this.connection.logger.logSchemaBuild(`adding new exclusion constraints: ${n.map(r=>`"${r.name}"`).join(", ")} in table "${t.name}"`),await this.queryRunner.createExclusionConstraints(t,n))}}async createForeignKeys(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===this.getTablePath(e));if(!t)continue;const n=e.foreignKeys.filter(i=>!t.foreignKeys.find(a=>a.name===i.name&&this.getTablePath(a)===this.getTablePath(i.referencedEntityMetadata)));if(n.length===0)continue;const r=n.map(i=>Dn.create(i,this.connection.driver));this.connection.logger.logSchemaBuild(`creating a foreign keys: ${n.map(i=>i.name).join(", ")} on table "${t.name}"`),await this.queryRunner.createForeignKeys(t,r)}}async dropColumnReferencedForeignKeys(e,t){const n=this.queryRunner.loadedTables.find(a=>this.getTablePath(a)===e);if(!n)return;const r=[],i=n.foreignKeys.find(a=>a.columnNames.indexOf(t)!==-1);if(i){const a=n.clone();a.foreignKeys=[i],r.push(a),n.removeForeignKey(i)}for(const a of this.queryRunner.loadedTables){const o=a.foreignKeys.filter(l=>this.getTablePath(l)===e&&l.referencedColumnNames.indexOf(t)!==-1);if(o.length>0){const l=a.clone();l.foreignKeys=o,r.push(l),o.forEach(h=>a.removeForeignKey(h))}}if(r.length>0)for(const a of r)this.connection.logger.logSchemaBuild(`dropping related foreign keys of ${a.name}: ${a.foreignKeys.map(o=>o.name).join(", ")}`),await this.queryRunner.dropForeignKeys(a,a.foreignKeys)}async dropColumnCompositeIndices(e,t){const n=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===e);if(!n)return;const r=n.indices.filter(i=>i.columnNames.length>1&&i.columnNames.indexOf(t)!==-1);r.length!==0&&(this.connection.logger.logSchemaBuild(`dropping related indices of "${e}"."${t}": ${r.map(i=>i.name).join(", ")}`),await this.queryRunner.dropIndices(n,r))}async dropColumnCompositeUniques(e,t){const n=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===e);if(!n)return;const r=n.uniques.filter(i=>i.columnNames.length>1&&i.columnNames.indexOf(t)!==-1);r.length!==0&&(this.connection.logger.logSchemaBuild(`dropping related unique constraints of "${e}"."${t}": ${r.map(i=>i.name).join(", ")}`),await this.queryRunner.dropUniqueConstraints(n,r))}metadataColumnsToTableColumnOptions(e){return e.map(t=>bo.createTableColumnOptions(t,this.connection.driver))}async createTypeormMetadataTable(e){const t=this.currentSchema,n=this.currentDatabase,r=this.connection.driver.buildTableName(this.connection.metadataTableName,t,n),i=this.connection.driver.options.type==="spanner";await e.createTable(new gt({database:n,schema:t,name:r,columns:[{name:"type",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.metadataType}),isNullable:!1,isPrimary:i},{name:"database",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.metadataDatabase}),isNullable:!0,isPrimary:i},{name:"schema",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.metadataSchema}),isNullable:!0,isPrimary:i},{name:"table",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.metadataTable}),isNullable:!0,isPrimary:i},{name:"name",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.metadataName}),isNullable:!0,isPrimary:i},{name:"value",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.metadataValue}),isNullable:!0,isPrimary:i}]}),!0)}}class ms{constructor(e){this.isReplicated=!1,this.treeSupport=!0,this.transactionSupport="nested",this.supportedDataTypes=["int","integer","tinyint","smallint","mediumint","bigint","unsigned big int","int2","int8","integer","character","varchar","varying character","nchar","native character","nvarchar","text","clob","text","blob","real","double","double precision","float","real","numeric","decimal","boolean","date","time","datetime","json"],this.supportedUpsertTypes=["on-conflict-do-update"],this.withLengthColumnTypes=["character","varchar","varying character","nchar","native character","nvarchar","text","blob","clob"],this.spatialTypes=[],this.withPrecisionColumnTypes=["real","double","double precision","float","real","numeric","decimal","date","time","datetime"],this.withScaleColumnTypes=["real","double","double precision","float","real","numeric","decimal"],this.mappedDataTypes={createDate:"datetime",createDateDefault:"datetime('now')",updateDate:"datetime",updateDateDefault:"datetime('now')",deleteDate:"datetime",deleteDateNullable:!0,version:"integer",treeLevel:"integer",migrationId:"integer",migrationName:"varchar",migrationTimestamp:"bigint",cacheId:"int",cacheIdentifier:"varchar",cacheTime:"bigint",cacheDuration:"int",cacheQuery:"text",cacheResult:"text",metadataType:"varchar",metadataDatabase:"varchar",metadataSchema:"varchar",metadataTable:"varchar",metadataName:"varchar",metadataValue:"text"},this.cteCapabilities={enabled:!0,requiresRecursiveHint:!0},this.attachedDatabases={},this.connection=e,this.options=e.options,this.database=ie.buildDriverOptions(this.options).database}async connect(){this.databaseConnection=await this.createDatabaseConnection()}afterConnect(){return Promise.resolve()}async disconnect(){return new Promise((e,t)=>{this.queryRunner=void 0,this.databaseConnection.close(n=>n?t(n):e())})}hasAttachedDatabases(){return!!Object.keys(this.attachedDatabases).length}getAttachedDatabaseHandleByRelativePath(e){var t,n;return(n=(t=this.attachedDatabases)==null?void 0:t[e])==null?void 0:n.attachHandle}getAttachedDatabasePathRelativeByHandle(e){var t;return(t=Object.values(this.attachedDatabases).find(({attachHandle:n})=>e===n))==null?void 0:t.attachFilepathRelative}createSchemaBuilder(){return new tc(this.connection)}preparePersistentValue(e,t){return t.transformer&&(e=It.transformTo(t.transformer,e)),e==null?e:t.type===Boolean||t.type==="boolean"?e===!0?1:0:t.type==="date"?be.mixedDateToDateString(e):t.type==="time"?be.mixedDateToTimeString(e):t.type==="datetime"||t.type===Date?be.mixedDateToUtcDatetimeString(e):t.type==="json"||t.type==="simple-json"?be.simpleJsonToString(e):t.type==="simple-array"?be.simpleArrayToString(e):t.type==="simple-enum"?be.simpleEnumToString(e):e}prepareHydratedValue(e,t){return e==null?t.transformer?It.transformFrom(t.transformer,e):e:(t.type===Boolean||t.type==="boolean"?e=!!e:t.type==="datetime"||t.type===Date?(e&&typeof e=="string"&&(/^\d\d\d\d-\d\d-\d\d \d\d:\d\d/.test(e)&&(e=e.replace(" ","T")),/^\d\d\d\d-\d\d-\d\dT\d\d:\d\d(:\d\d(\.\d\d\d)?)?$/.test(e)&&(e+="Z")),e=be.normalizeHydratedDate(e)):t.type==="date"?e=be.mixedDateToDateString(e):t.type==="time"?e=be.mixedTimeToString(e):t.type==="json"||t.type==="simple-json"?e=be.stringToSimpleJson(e):t.type==="simple-array"?e=be.stringToSimpleArray(e):t.type==="simple-enum"?e=be.stringToSimpleEnum(e,t):t.type===Number&&(e=isNaN(+e)?e:parseInt(e)),t.transformer&&(e=It.transformFrom(t.transformer,e)),e)}escapeQueryWithParameters(e,t,n){const r=Object.keys(n).map(i=>typeof n[i]=="boolean"?n[i]===!0?1:0:n[i]instanceof Date?be.mixedDateToUtcDatetimeString(n[i]):n[i]);return!t||!Object.keys(t).length?[e,r]:(e=e.replace(/:(\.\.\.)?([A-Za-z0-9_.]+)/g,(i,a,o)=>{if(!t.hasOwnProperty(o))return i;const l=t[o];return a?l.map(h=>(r.push(h),this.createParameter(o,r.length-1))).join(", "):typeof l=="function"?l():typeof l=="number"?String(l):typeof l=="boolean"?(r.push(+l),this.createParameter(o,r.length-1)):l instanceof Date?(r.push(be.mixedDateToUtcDatetimeString(l)),this.createParameter(o,r.length-1)):(r.push(l),this.createParameter(o,r.length-1))}),[e,r])}escape(e){return'"'+e+'"'}buildTableName(e,t,n){return e}parseTableName(e){const t=this.database,n=void 0;if(B.isTable(e)||B.isView(e)){const i=this.parseTableName(e.schema?`"${e.schema}"."${e.name}"`:e.name);return{database:e.database||i.database||t,schema:e.schema||i.schema||n,tableName:i.tableName}}if(B.isTableForeignKey(e)){const i=this.parseTableName(e.referencedTableName);return{database:e.referencedDatabase||i.database||t,schema:e.referencedSchema||i.schema||n,tableName:i.tableName}}if(B.isEntityMetadata(e))return{database:e.database||t,schema:e.schema||n,tableName:e.tableName};const r=e.split(".");return r.length===3?{database:r[0]||t,schema:r[1]||n,tableName:r[2]}:r.length===2?{database:this.getAttachedDatabasePathRelativeByHandle(r[0])??t,schema:r[0],tableName:r[1]}:{database:t,schema:n,tableName:e}}normalizeType(e){return e.type===Number||e.type==="int"?"integer":e.type===String?"varchar":e.type===Date?"datetime":e.type===Boolean?"boolean":e.type==="uuid"?"varchar":e.type==="simple-array"||e.type==="simple-json"?"text":e.type==="simple-enum"?"varchar":e.type||""}normalizeDefault(e){const t=e.default;if(typeof t=="number")return""+t;if(typeof t=="boolean")return t?"1":"0";if(typeof t=="function")return t();if(typeof t=="string")return`'${t}'`;if(t!=null)return`${t}`}normalizeIsUnique(e){return e.entityMetadata.uniques.some(t=>t.columns.length===1&&t.columns[0]===e)}getColumnLength(e){return e.length?e.length.toString():""}createFullType(e){let t=e.type;return e.enum?"varchar":(e.length?t+="("+e.length+")":e.precision!==null&&e.precision!==void 0&&e.scale!==null&&e.scale!==void 0?t+="("+e.precision+","+e.scale+")":e.precision!==null&&e.precision!==void 0&&(t+="("+e.precision+")"),e.isArray&&(t+=" array"),t)}obtainMasterConnection(){return Promise.resolve()}obtainSlaveConnection(){return Promise.resolve()}createGeneratedMap(e,t,n,r){const i=e.generatedColumns.reduce((a,o)=>{let l;return o.generationStrategy==="increment"&&t&&(l=t-r+n+1),l?re.mergeDeep(a,o.createValueMap(l)):a},{});return Object.keys(i).length>0?i:void 0}findChangedColumns(e,t){return t.filter(n=>{const r=e.find(a=>a.name===n.databaseName);return r?r.name!==n.databaseName||r.type!==this.normalizeType(n)||r.length!==n.length||r.precision!==n.precision||r.scale!==n.scale||this.normalizeDefault(n)!==r.default||r.isPrimary!==n.isPrimary||r.isNullable!==n.isNullable||r.generatedType!==n.generatedType||r.asExpression!==n.asExpression||r.isUnique!==this.normalizeIsUnique(n)||r.enum&&n.enum&&!re.isArraysEqual(r.enum,n.enum.map(a=>a+""))||n.generationStrategy!=="uuid"&&r.isGenerated!==n.isGenerated:!1})}isReturningSqlSupported(){return!1}isUUIDGenerationSupported(){return!1}isFullTextColumnTypeSupported(){return!1}createParameter(e,t){return"?"}async createDatabaseConnection(){throw new x("Do not use AbstractSqlite directly, it has to be used with one of the sqlite drivers")}loadDependencies(){}}class tr{constructor(){this.records=[]}}class mr{constructor(e){this.queryRunner=e}async broadcast(e,...t){const n=new $n,r=this[`broadcast${e}Event`];typeof r=="function"&&r.call(this,n,...t),await n.wait()}broadcastBeforeInsertEvent(e,t,n){n&&t.beforeInsertListeners.length&&t.beforeInsertListeners.forEach(r=>{if(r.isAllowed(n)){const i=r.execute(n);i instanceof Promise&&e.promises.push(i),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(r=>{if(this.isAllowedSubscriber(r,t.target)&&r.beforeInsert){const i=r.beforeInsert({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t});i instanceof Promise&&e.promises.push(i),e.count++}})}broadcastBeforeUpdateEvent(e,t,n,r,i,a){n&&t.beforeUpdateListeners.length&&t.beforeUpdateListeners.forEach(o=>{if(o.isAllowed(n)){const l=o.execute(n);l instanceof Promise&&e.promises.push(l),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(o=>{if(this.isAllowedSubscriber(o,t.target)&&o.beforeUpdate){const l=o.beforeUpdate({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:r,updatedColumns:i||[],updatedRelations:a||[]});l instanceof Promise&&e.promises.push(l),e.count++}})}broadcastBeforeRemoveEvent(e,t,n,r,i){n&&t.beforeRemoveListeners.length&&t.beforeRemoveListeners.forEach(a=>{if(a.isAllowed(n)){const o=a.execute(n);o instanceof Promise&&e.promises.push(o),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(a=>{if(this.isAllowedSubscriber(a,t.target)&&a.beforeRemove){const o=a.beforeRemove({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:r,entityId:t.getEntityIdMixedMap(r??i)});o instanceof Promise&&e.promises.push(o),e.count++}})}broadcastBeforeSoftRemoveEvent(e,t,n,r,i){n&&t.beforeSoftRemoveListeners.length&&t.beforeSoftRemoveListeners.forEach(a=>{if(a.isAllowed(n)){const o=a.execute(n);o instanceof Promise&&e.promises.push(o),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(a=>{if(this.isAllowedSubscriber(a,t.target)&&a.beforeSoftRemove){const o=a.beforeSoftRemove({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:r,entityId:t.getEntityIdMixedMap(r??i)});o instanceof Promise&&e.promises.push(o),e.count++}})}broadcastBeforeRecoverEvent(e,t,n,r,i){n&&t.beforeRecoverListeners.length&&t.beforeRecoverListeners.forEach(a=>{if(a.isAllowed(n)){const o=a.execute(n);o instanceof Promise&&e.promises.push(o),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(a=>{if(this.isAllowedSubscriber(a,t.target)&&a.beforeRecover){const o=a.beforeRecover({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:r,entityId:t.getEntityIdMixedMap(r??i)});o instanceof Promise&&e.promises.push(o),e.count++}})}broadcastAfterInsertEvent(e,t,n,r){n&&t.afterInsertListeners.length&&t.afterInsertListeners.forEach(i=>{if(i.isAllowed(n)){const a=i.execute(n);a instanceof Promise&&e.promises.push(a),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(i=>{if(this.isAllowedSubscriber(i,t.target)&&i.afterInsert){const a=i.afterInsert({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,entityId:t.getEntityIdMixedMap(r)});a instanceof Promise&&e.promises.push(a),e.count++}})}broadcastBeforeQueryEvent(e,t,n){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(r=>{if(r.beforeQuery){const i=r.beforeQuery({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,query:t,parameters:n});i instanceof Promise&&e.promises.push(i),e.count++}})}broadcastAfterQueryEvent(e,t,n,r,i,a,o){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(l=>{if(l.afterQuery){const h=l.afterQuery({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,query:t,parameters:n,success:r,executionTime:i,rawResults:a,error:o});h instanceof Promise&&e.promises.push(h),e.count++}})}broadcastBeforeTransactionStartEvent(e){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(t=>{if(t.beforeTransactionStart){const n=t.beforeTransactionStart({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});n instanceof Promise&&e.promises.push(n),e.count++}})}broadcastAfterTransactionStartEvent(e){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(t=>{if(t.afterTransactionStart){const n=t.afterTransactionStart({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});n instanceof Promise&&e.promises.push(n),e.count++}})}broadcastBeforeTransactionCommitEvent(e){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(t=>{if(t.beforeTransactionCommit){const n=t.beforeTransactionCommit({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});n instanceof Promise&&e.promises.push(n),e.count++}})}broadcastAfterTransactionCommitEvent(e){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(t=>{if(t.afterTransactionCommit){const n=t.afterTransactionCommit({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});n instanceof Promise&&e.promises.push(n),e.count++}})}broadcastBeforeTransactionRollbackEvent(e){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(t=>{if(t.beforeTransactionRollback){const n=t.beforeTransactionRollback({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});n instanceof Promise&&e.promises.push(n),e.count++}})}broadcastAfterTransactionRollbackEvent(e){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(t=>{if(t.afterTransactionRollback){const n=t.afterTransactionRollback({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});n instanceof Promise&&e.promises.push(n),e.count++}})}broadcastAfterUpdateEvent(e,t,n,r,i,a){n&&t.afterUpdateListeners.length&&t.afterUpdateListeners.forEach(o=>{if(o.isAllowed(n)){const l=o.execute(n);l instanceof Promise&&e.promises.push(l),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(o=>{if(this.isAllowedSubscriber(o,t.target)&&o.afterUpdate){const l=o.afterUpdate({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:r,updatedColumns:i||[],updatedRelations:a||[]});l instanceof Promise&&e.promises.push(l),e.count++}})}broadcastAfterRemoveEvent(e,t,n,r,i){n&&t.afterRemoveListeners.length&&t.afterRemoveListeners.forEach(a=>{if(a.isAllowed(n)){const o=a.execute(n);o instanceof Promise&&e.promises.push(o),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(a=>{if(this.isAllowedSubscriber(a,t.target)&&a.afterRemove){const o=a.afterRemove({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:r,entityId:t.getEntityIdMixedMap(r??i)});o instanceof Promise&&e.promises.push(o),e.count++}})}broadcastAfterSoftRemoveEvent(e,t,n,r,i){n&&t.afterSoftRemoveListeners.length&&t.afterSoftRemoveListeners.forEach(a=>{if(a.isAllowed(n)){const o=a.execute(n);o instanceof Promise&&e.promises.push(o),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(a=>{if(this.isAllowedSubscriber(a,t.target)&&a.afterSoftRemove){const o=a.afterSoftRemove({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:r,entityId:t.getEntityIdMixedMap(r??i)});o instanceof Promise&&e.promises.push(o),e.count++}})}broadcastAfterRecoverEvent(e,t,n,r,i){n&&t.afterRecoverListeners.length&&t.afterRecoverListeners.forEach(a=>{if(a.isAllowed(n)){const o=a.execute(n);o instanceof Promise&&e.promises.push(o),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(a=>{if(this.isAllowedSubscriber(a,t.target)&&a.afterRecover){const o=a.afterRecover({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:r,entityId:t.getEntityIdMixedMap(r??i)});o instanceof Promise&&e.promises.push(o),e.count++}})}broadcastLoadEventsForAll(e,t,n){return this.broadcastLoadEvent(e,t,n)}broadcastLoadEvent(e,t,n){const r=this.queryRunner.connection.subscribers.filter(i=>this.isAllowedSubscriber(i,t.target)&&i.afterLoad);if(t.relations.length||t.afterLoadListeners.length||r.length){const i=n.filter(a=>!(a instanceof Promise));t.relations.length&&t.relations.forEach(a=>{i.forEach(o=>{if(a.isLazy&&!o.hasOwnProperty(a.propertyName))return;const l=a.getEntityValue(o);Re.isObject(l)&&this.broadcastLoadEvent(e,a.inverseEntityMetadata,Array.isArray(l)?l:[l])})}),t.afterLoadListeners.length&&t.afterLoadListeners.forEach(a=>{i.forEach(o=>{if(a.isAllowed(o)){const l=a.execute(o);l instanceof Promise&&e.promises.push(l),e.count++}})}),r.forEach(a=>{i.forEach(o=>{const l=a.afterLoad(o,{entity:o,metadata:t,connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});l instanceof Promise&&e.promises.push(l),e.count++})})}}isAllowedSubscriber(e,t){return!e.listenTo||!e.listenTo()||e.listenTo()===Object||e.listenTo()===t||e.listenTo().isPrototypeOf(t)}}class _{constructor(e,t){this.query=e,this.parameters=t,this["@instanceof"]=Symbol.for("Query")}}class oo{constructor(){this.upQueries=[],this.downQueries=[]}}class nc{constructor(){this.isReleased=!1,this.isTransactionActive=!1,this.data={},this.loadedTables=[],this.loadedViews=[],this.sqlMemoryMode=!1,this.sqlInMemory=new oo,this.transactionDepth=0,this.cachedTablePaths={}}async sql(e,...t){const{query:n,parameters:r}=ec({driver:this.connection.driver,strings:e,expressions:t});return await this.query(n,r)}async beforeMigration(){}async afterMigration(){}async getTable(e){return this.loadedTables=await this.loadTables([e]),this.loadedTables.length>0?this.loadedTables[0]:void 0}async getTables(e){return e?(this.loadedTables=await this.loadTables(e),this.loadedTables):await this.loadTables(e)}async getView(e){return this.loadedViews=await this.loadViews([e]),this.loadedViews.length>0?this.loadedViews[0]:void 0}async getViews(e){return this.loadedViews=await this.loadViews(e),this.loadedViews}enableSqlMemory(){this.sqlInMemory=new oo,this.sqlMemoryMode=!0}disableSqlMemory(){this.sqlInMemory=new oo,this.sqlMemoryMode=!1}clearSqlMemory(){this.sqlInMemory=new oo}getMemorySql(){return this.sqlInMemory}async executeMemoryUpSql(){for(const{query:e,parameters:t}of this.sqlInMemory.upQueries)await this.query(e,t)}async executeMemoryDownSql(){for(const{query:e,parameters:t}of this.sqlInMemory.downQueries.reverse())await this.query(e,t)}getReplicationMode(){return this.mode}async getCachedView(e){const t=this.loadedViews.find(r=>r.name===e);if(t)return t;const n=await this.loadViews([e]);if(n.length>0)return this.loadedViews.push(n[0]),n[0];throw new x(`View "${e}" does not exist.`)}async getCachedTable(e){if(e in this.cachedTablePaths){const n=this.cachedTablePaths[e],r=this.loadedTables.find(i=>this.getTablePath(i)===n);if(r)return r}const t=await this.loadTables([e]);if(t.length>0){const n=this.getTablePath(t[0]),r=this.loadedTables.find(i=>this.getTablePath(i)===n);return r||(this.cachedTablePaths[e]=this.getTablePath(t[0]),this.loadedTables.push(t[0]),t[0])}else throw new x(`Table "${e}" does not exist.`)}replaceCachedTable(e,t){const n=this.getTablePath(e),r=this.loadedTables.find(i=>this.getTablePath(i)===n);for(const[i,a]of Object.entries(this.cachedTablePaths))a===n&&(this.cachedTablePaths[i]=this.getTablePath(t));r&&(r.database=t.database,r.schema=t.schema,r.name=t.name,r.columns=t.columns,r.indices=t.indices,r.foreignKeys=t.foreignKeys,r.uniques=t.uniques,r.checks=t.checks,r.justCreated=t.justCreated,r.engine=t.engine,r.comment=t.comment)}getTablePath(e){const t=this.connection.driver.parseTableName(e);return this.connection.driver.buildTableName(t.tableName,t.schema,t.database)}getTypeormMetadataTableName(){const e=this.connection.driver.options;return this.connection.driver.buildTableName(this.connection.metadataTableName,e.schema,e.database)}selectTypeormMetadataSql({database:e,schema:t,table:n,type:r,name:i}){const a=this.connection.createQueryBuilder(),o=a.select().from(this.getTypeormMetadataTableName(),"t").where(`${a.escape("type")} = :type`,{type:r}).andWhere(`${a.escape("name")} = :name`,{name:i});e&&o.andWhere(`${a.escape("database")} = :database`,{database:e}),t&&o.andWhere(`${a.escape("schema")} = :schema`,{schema:t}),n&&o.andWhere(`${a.escape("table")} = :table`,{table:n});const[l,h]=o.getQueryAndParameters();return new _(l,h)}insertTypeormMetadataSql({database:e,schema:t,table:n,type:r,name:i,value:a}){const[o,l]=this.connection.createQueryBuilder().insert().into(this.getTypeormMetadataTableName()).values({database:e,schema:t,table:n,type:r,name:i,value:a}).getQueryAndParameters();return new _(o,l)}deleteTypeormMetadataSql({database:e,schema:t,table:n,type:r,name:i}){const a=this.connection.createQueryBuilder(),o=a.delete().from(this.getTypeormMetadataTableName()).where(`${a.escape("type")} = :type`,{type:r}).andWhere(`${a.escape("name")} = :name`,{name:i});e&&o.andWhere(`${a.escape("database")} = :database`,{database:e}),t&&o.andWhere(`${a.escape("schema")} = :schema`,{schema:t}),n&&o.andWhere(`${a.escape("table")} = :table`,{table:n});const[l,h]=o.getQueryAndParameters();return new _(l,h)}isColumnChanged(e,t,n,r,i=!0){return e.charset!==t.charset||e.collation!==t.collation||e.precision!==t.precision||e.scale!==t.scale||e.width!==t.width||e.zerofill!==t.zerofill||e.unsigned!==t.unsigned||e.asExpression!==t.asExpression||n&&e.default!==t.default||e.onUpdate!==t.onUpdate||e.isNullable!==t.isNullable||r&&e.comment!==t.comment||i&&this.isEnumChanged(e,t)}isEnumChanged(e,t){return!re.isArraysEqual(e.enum||[],t.enum||[])}isDefaultColumnLength(e,t,n){if(this.connection.hasMetadata(e.name)){const i=this.connection.getMetadata(e.name).findColumnWithDatabaseName(t.name);if(i&&this.connection.driver.getColumnLength(i))return!1}return this.connection.driver.dataTypeDefaults&&this.connection.driver.dataTypeDefaults[t.type]&&this.connection.driver.dataTypeDefaults[t.type].length?this.connection.driver.dataTypeDefaults[t.type].length.toString()===n.toString():!1}isDefaultColumnPrecision(e,t,n){if(this.connection.hasMetadata(e.name)){const i=this.connection.getMetadata(e.name).findColumnWithDatabaseName(t.name);if(i&&i.precision!==null&&i.precision!==void 0)return!1}return this.connection.driver.dataTypeDefaults&&this.connection.driver.dataTypeDefaults[t.type]&&this.connection.driver.dataTypeDefaults[t.type].precision!==null&&this.connection.driver.dataTypeDefaults[t.type].precision!==void 0?this.connection.driver.dataTypeDefaults[t.type].precision===n:!1}isDefaultColumnScale(e,t,n){if(this.connection.hasMetadata(e.name)){const i=this.connection.getMetadata(e.name).findColumnWithDatabaseName(t.name);if(i&&i.scale!==null&&i.scale!==void 0)return!1}return this.connection.driver.dataTypeDefaults&&this.connection.driver.dataTypeDefaults[t.type]&&this.connection.driver.dataTypeDefaults[t.type].scale!==null&&this.connection.driver.dataTypeDefaults[t.type].scale!==void 0?this.connection.driver.dataTypeDefaults[t.type].scale===n:!1}async executeQueries(e,t){if(B.isQuery(e)&&(e=[e]),B.isQuery(t)&&(t=[t]),this.sqlInMemory.upQueries.push(...e),this.sqlInMemory.downQueries.push(...t),this.sqlMemoryMode===!0)return Promise.resolve();for(const{query:n,parameters:r}of e)await this.query(n,r)}generateIndexName(e,t){return this.connection.namingStrategy.indexName(e,t.columnNames,t.where)}}var Se;(function(s){s.VIEW="VIEW",s.MATERIALIZED_VIEW="MATERIALIZED_VIEW",s.GENERATED_COLUMN="GENERATED_COLUMN"})(Se||(Se={}));class Mi extends nc{constructor(){super(),this.transactionPromise=null}connect(){return Promise.resolve(this.driver.databaseConnection)}release(){return this.loadedTables=[],this.clearSqlMemory(),Promise.resolve()}async startTransaction(e){if(this.driver.transactionSupport==="none")throw new x(`Transactions aren't supported by ${this.connection.driver.options.type}.`);if(this.isTransactionActive&&this.driver.transactionSupport==="simple")throw new b0;if(e&&e!=="READ UNCOMMITTED"&&e!=="SERIALIZABLE")throw new x("SQLite only supports SERIALIZABLE and READ UNCOMMITTED isolation");this.isTransactionActive=!0;try{await this.broadcaster.broadcast("BeforeTransactionStart")}catch(t){throw this.isTransactionActive=!1,t}this.transactionDepth===0?(e&&(e==="READ UNCOMMITTED"?await this.query("PRAGMA read_uncommitted = true"):await this.query("PRAGMA read_uncommitted = false")),await this.query("BEGIN TRANSACTION")):await this.query(`SAVEPOINT typeorm_${this.transactionDepth}`),this.transactionDepth+=1,await this.broadcaster.broadcast("AfterTransactionStart")}async commitTransaction(){if(!this.isTransactionActive)throw new In;await this.broadcaster.broadcast("BeforeTransactionCommit"),this.transactionDepth>1?await this.query(`RELEASE SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.query("COMMIT"),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionCommit")}async rollbackTransaction(){if(!this.isTransactionActive)throw new In;await this.broadcaster.broadcast("BeforeTransactionRollback"),this.transactionDepth>1?await this.query(`ROLLBACK TO SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.query("ROLLBACK"),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionRollback")}stream(e,t,n,r){throw new x("Stream is not supported by sqlite driver.")}async getDatabases(){return Promise.resolve([])}async getSchemas(e){return Promise.resolve([])}async hasDatabase(e){return Promise.resolve(!1)}async getCurrentDatabase(){return Promise.resolve(void 0)}async hasSchema(e){throw new x("This driver does not support table schemas")}async getCurrentSchema(){return Promise.resolve(void 0)}async hasTable(e){const n=`SELECT * FROM "sqlite_master" WHERE "type" = 'table' AND "name" = '${B.isTable(e)?e.name:e}'`;return!!(await this.query(n)).length}async hasColumn(e,t){const n=B.isTable(e)?e.name:e,r=`PRAGMA table_xinfo(${this.escapePath(n)})`;return!!(await this.query(r)).find(a=>a.name===t)}async createDatabase(e,t){return Promise.resolve()}async dropDatabase(e,t){return Promise.resolve()}async createSchema(e,t){return Promise.resolve()}async dropSchema(e,t){return Promise.resolve()}async createTable(e,t=!1,n=!0,r=!0){const i=[],a=[];if(t&&await this.hasTable(e))return Promise.resolve();i.push(this.createTableSql(e,n)),a.push(this.dropTableSql(e)),r&&e.indices.forEach(l=>{l.name||(l.name=this.connection.namingStrategy.indexName(e,l.columnNames,l.where)),i.push(this.createIndexSql(e,l)),a.push(this.dropIndexSql(l))});const o=e.columns.filter(l=>l.generatedType&&l.asExpression);for(const l of o){const h=this.insertTypeormMetadataSql({table:e.name,type:Se.GENERATED_COLUMN,name:l.name,value:l.asExpression}),d=this.deleteTypeormMetadataSql({table:e.name,type:Se.GENERATED_COLUMN,name:l.name});i.push(h),a.push(d)}await this.executeQueries(i,a)}async dropTable(e,t,n=!0,r=!0){if(t&&!await this.hasTable(e))return Promise.resolve();const i=n,a=B.isTable(e)?e:await this.getCachedTable(e),o=[],l=[];r&&a.indices.forEach(d=>{o.push(this.dropIndexSql(d)),l.push(this.createIndexSql(a,d))}),o.push(this.dropTableSql(a,t)),l.push(this.createTableSql(a,i));const h=a.columns.filter(d=>d.generatedType&&d.asExpression);for(const d of h){const p=this.deleteTypeormMetadataSql({table:a.name,type:Se.GENERATED_COLUMN,name:d.name}),m=this.insertTypeormMetadataSql({table:a.name,type:Se.GENERATED_COLUMN,name:d.name,value:d.asExpression});o.push(p),l.push(m)}await this.executeQueries(o,l)}async createView(e,t=!1){const n=[],r=[];n.push(this.createViewSql(e)),t&&n.push(this.insertViewDefinitionSql(e)),r.push(this.dropViewSql(e)),t&&r.push(this.deleteViewDefinitionSql(e)),await this.executeQueries(n,r)}async dropView(e){const t=B.isView(e)?e.name:e,n=await this.getCachedView(t),r=[],i=[];r.push(this.deleteViewDefinitionSql(n)),r.push(this.dropViewSql(n)),i.push(this.insertViewDefinitionSql(n)),i.push(this.createViewSql(n)),await this.executeQueries(r,i)}async renameTable(e,t){const n=B.isTable(e)?e:await this.getCachedTable(e),r=n.clone();r.name=t;const i=new _(`ALTER TABLE ${this.escapePath(n.name)} RENAME TO ${this.escapePath(t)}`),a=new _(`ALTER TABLE ${this.escapePath(t)} RENAME TO ${this.escapePath(n.name)}`);await this.executeQueries(i,a),r.uniques.forEach(o=>{const l=this.connection.namingStrategy.uniqueConstraintName(n,o.columnNames);o.name===l&&(o.name=this.connection.namingStrategy.uniqueConstraintName(r,o.columnNames))}),r.foreignKeys.forEach(o=>{const l=this.connection.namingStrategy.foreignKeyName(n,o.columnNames,this.getTablePath(o),o.referencedColumnNames);o.name===l&&(o.name=this.connection.namingStrategy.foreignKeyName(r,o.columnNames,this.getTablePath(o),o.referencedColumnNames))}),r.indices.forEach(o=>{const l=this.connection.namingStrategy.indexName(n,o.columnNames,o.where);o.name===l&&(o.name=this.connection.namingStrategy.indexName(r,o.columnNames,o.where))}),n.name=r.name,await this.recreateTable(r,n)}async addColumn(e,t){const n=B.isTable(e)?e:await this.getCachedTable(e);return this.addColumns(n,[t])}async addColumns(e,t){const n=B.isTable(e)?e:await this.getCachedTable(e),r=n.clone();t.forEach(i=>r.addColumn(i)),await this.recreateTable(r,n)}async renameColumn(e,t,n){const r=B.isTable(e)?e:await this.getCachedTable(e),i=B.isTableColumn(t)?t:r.columns.find(o=>o.name===t);if(!i)throw new x(`Column "${t}" was not found in the "${r.name}" table.`);let a;return B.isTableColumn(n)?a=n:(a=i.clone(),a.name=n),this.changeColumn(r,i,a)}async changeColumn(e,t,n){const r=B.isTable(e)?e:await this.getCachedTable(e),i=B.isTableColumn(t)?t:r.columns.find(a=>a.name===t);if(!i)throw new x(`Column "${t}" was not found in the "${r.name}" table.`);await this.changeColumns(r,[{oldColumn:i,newColumn:n}])}async changeColumns(e,t){const n=B.isTable(e)?e:await this.getCachedTable(e),r=n.clone();t.forEach(i=>{i.newColumn.name!==i.oldColumn.name&&(r.findColumnUniques(i.oldColumn).forEach(o=>{const l=this.connection.namingStrategy.uniqueConstraintName(n,o.columnNames);o.columnNames.splice(o.columnNames.indexOf(i.oldColumn.name),1),o.columnNames.push(i.newColumn.name),o.name===l&&(o.name=this.connection.namingStrategy.uniqueConstraintName(r,o.columnNames))}),r.findColumnForeignKeys(i.oldColumn).forEach(o=>{const l=this.connection.namingStrategy.foreignKeyName(n,o.columnNames,this.getTablePath(o),o.referencedColumnNames);o.columnNames.splice(o.columnNames.indexOf(i.oldColumn.name),1),o.columnNames.push(i.newColumn.name),o.name===l&&(o.name=this.connection.namingStrategy.foreignKeyName(r,o.columnNames,this.getTablePath(o),o.referencedColumnNames))}),r.findColumnIndices(i.oldColumn).forEach(o=>{const l=this.connection.namingStrategy.indexName(n,o.columnNames,o.where);o.columnNames.splice(o.columnNames.indexOf(i.oldColumn.name),1),o.columnNames.push(i.newColumn.name),o.name===l&&(o.name=this.connection.namingStrategy.indexName(r,o.columnNames,o.where))}));const a=r.columns.find(o=>o.name===i.oldColumn.name);a&&(r.columns[r.columns.indexOf(a)]=i.newColumn)}),await this.recreateTable(r,n)}async dropColumn(e,t){const n=B.isTable(e)?e:await this.getCachedTable(e),r=B.isTableColumn(t)?t:n.findColumnByName(t);if(!r)throw new x(`Column "${t}" was not found in table "${n.name}"`);await this.dropColumns(n,[r])}async dropColumns(e,t){const n=B.isTable(e)?e:await this.getCachedTable(e),r=n.clone();t.forEach(i=>{const a=B.isTableColumn(i)?i:n.findColumnByName(i);if(!a)throw new Error(`Column "${i}" was not found in table "${n.name}"`);r.removeColumn(a),r.findColumnUniques(a).forEach(o=>r.removeUniqueConstraint(o)),r.findColumnIndices(a).forEach(o=>r.removeIndex(o)),r.findColumnForeignKeys(a).forEach(o=>r.removeForeignKey(o))}),await this.recreateTable(r,n)}async createPrimaryKey(e,t){const n=B.isTable(e)?e:await this.getCachedTable(e),r=n.clone();r.columns.forEach(i=>{t.find(a=>a===i.name)&&(i.isPrimary=!0)}),await this.recreateTable(r,n),n.columns.forEach(i=>{t.find(a=>a===i.name)&&(i.isPrimary=!0)})}async updatePrimaryKeys(e,t){await Promise.resolve()}async dropPrimaryKey(e){const t=B.isTable(e)?e:await this.getCachedTable(e),n=t.clone();n.primaryColumns.forEach(r=>{r.isPrimary=!1}),await this.recreateTable(n,t),t.primaryColumns.forEach(r=>{r.isPrimary=!1})}async createUniqueConstraint(e,t){await this.createUniqueConstraints(e,[t])}async createUniqueConstraints(e,t){const n=B.isTable(e)?e:await this.getCachedTable(e),r=n.clone();t.forEach(i=>r.addUniqueConstraint(i)),await this.recreateTable(r,n)}async dropUniqueConstraint(e,t){const n=B.isTable(e)?e:await this.getCachedTable(e),r=B.isTableUnique(t)?t:n.uniques.find(i=>i.name===t);if(!r)throw new x(`Supplied unique constraint was not found in table ${n.name}`);await this.dropUniqueConstraints(n,[r])}async dropUniqueConstraints(e,t){const n=B.isTable(e)?e:await this.getCachedTable(e),r=n.clone();t.forEach(i=>r.removeUniqueConstraint(i)),await this.recreateTable(r,n)}async createCheckConstraint(e,t){await this.createCheckConstraints(e,[t])}async createCheckConstraints(e,t){const n=B.isTable(e)?e:await this.getCachedTable(e),r=n.clone();t.forEach(i=>r.addCheckConstraint(i)),await this.recreateTable(r,n)}async dropCheckConstraint(e,t){const n=B.isTable(e)?e:await this.getCachedTable(e),r=B.isTableCheck(t)?t:n.checks.find(i=>i.name===t);if(!r)throw new x(`Supplied check constraint was not found in table ${n.name}`);await this.dropCheckConstraints(n,[r])}async dropCheckConstraints(e,t){const n=B.isTable(e)?e:await this.getCachedTable(e),r=n.clone();t.forEach(i=>r.removeCheckConstraint(i)),await this.recreateTable(r,n)}async createExclusionConstraint(e,t){throw new x("Sqlite does not support exclusion constraints.")}async createExclusionConstraints(e,t){throw new x("Sqlite does not support exclusion constraints.")}async dropExclusionConstraint(e,t){throw new x("Sqlite does not support exclusion constraints.")}async dropExclusionConstraints(e,t){throw new x("Sqlite does not support exclusion constraints.")}async createForeignKey(e,t){await this.createForeignKeys(e,[t])}async createForeignKeys(e,t){const n=B.isTable(e)?e:await this.getCachedTable(e),r=n.clone();t.forEach(i=>r.addForeignKey(i)),await this.recreateTable(r,n)}async dropForeignKey(e,t){const n=B.isTable(e)?e:await this.getCachedTable(e),r=B.isTableForeignKey(t)?t:n.foreignKeys.find(i=>i.name===t);if(!r)throw new x(`Supplied foreign key was not found in table ${n.name}`);await this.dropForeignKeys(e,[r])}async dropForeignKeys(e,t){const n=B.isTable(e)?e:await this.getCachedTable(e),r=n.clone();t.forEach(i=>r.removeForeignKey(i)),await this.recreateTable(r,n)}async createIndex(e,t){const n=B.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.generateIndexName(n,t));const r=this.createIndexSql(n,t),i=this.dropIndexSql(t);await this.executeQueries(r,i),n.addIndex(t)}async createIndices(e,t){const n=t.map(r=>this.createIndex(e,r));await Promise.all(n)}async dropIndex(e,t){const n=B.isTable(e)?e:await this.getCachedTable(e),r=B.isTableIndex(t)?t:n.indices.find(o=>o.name===t);if(!r)throw new x(`Supplied index ${t} was not found in table ${n.name}`);r.name||(r.name=this.generateIndexName(n,r));const i=this.dropIndexSql(r),a=this.createIndexSql(n,r);await this.executeQueries(i,a),n.removeIndex(r)}async dropIndices(e,t){const n=t.map(r=>this.dropIndex(e,r));await Promise.all(n)}async clearTable(e){await this.query(`DELETE FROM ${this.escapePath(e)}`)}async clearDatabase(e){let t;e&&this.driver.getAttachedDatabaseHandleByRelativePath(e)&&(t=this.driver.getAttachedDatabaseHandleByRelativePath(e)),await this.query("PRAGMA foreign_keys = OFF");const n=this.isTransactionActive;n||await this.startTransaction();try{const r=t?`SELECT 'DROP VIEW "${t}"."' || name || '";' as query FROM "${t}"."sqlite_master" WHERE "type" = 'view'`:`SELECT 'DROP VIEW "' || name || '";' as query FROM "sqlite_master" WHERE "type" = 'view'`,i=await this.query(r);await Promise.all(i.map(l=>this.query(l.query)));const a=t?`SELECT 'DROP TABLE "${t}"."' || name || '";' as query FROM "${t}"."sqlite_master" WHERE "type" = 'table' AND "name" != 'sqlite_sequence'`:`SELECT 'DROP TABLE "' || name || '";' as query FROM "sqlite_master" WHERE "type" = 'table' AND "name" != 'sqlite_sequence'`,o=await this.query(a);await Promise.all(o.map(l=>this.query(l.query))),n||await this.commitTransaction()}catch(r){try{n||await this.rollbackTransaction()}catch{}throw r}finally{await this.query("PRAGMA foreign_keys = ON")}}async loadViews(e){if(!await this.hasTable(this.getTypeormMetadataTableName()))return[];e||(e=[]);const n=e.map(a=>"'"+a+"'").join(", ");let r=`SELECT "t".* FROM "${this.getTypeormMetadataTableName()}" "t" INNER JOIN "sqlite_master" s ON "s"."name" = "t"."name" AND "s"."type" = 'view' WHERE "t"."type" = '${Se.VIEW}'`;return n.length>0&&(r+=` AND "t"."name" IN (${n})`),(await this.query(r)).map(a=>{const o=new Ur;return o.name=a.name,o.expression=a.value,o})}async loadTableRecords(e,t){let n;const[r,i]=this.splitTablePath(e);return r&&this.driver.getAttachedDatabasePathRelativeByHandle(r)&&(n=this.driver.getAttachedDatabasePathRelativeByHandle(r)),this.query(`SELECT ${n?`'${n}'`:null} as database, ${r?`'${r}'`:null} as schema, * FROM ${r?`"${r}".`:""}${this.escapePath("sqlite_master")} WHERE "type" = '${t}' AND "${t==="table"?"name":"tbl_name"}" IN ('${i}')`)}async loadPragmaRecords(e,t){const[,n]=this.splitTablePath(e);return this.query(`PRAGMA ${t}("${n}")`)}async loadTables(e){if(e&&e.length===0)return[];let t=[],n;if(e){const r=e.filter(o=>o.split(".").length===1).map(o=>`'${o}'`),i=e.filter(o=>o.split(".").length>1),a=o=>{const l=[...i.map(h=>this.loadTableRecords(h,o))];return r.length&&l.push(this.query(`SELECT * FROM "sqlite_master" WHERE "type" = '${o}' AND "${o==="table"?"name":"tbl_name"}" IN (${r})`)),l};t=(await Promise.all(a("table"))).reduce((o,l)=>[...o,...l],[]).filter(Boolean),n=(await Promise.all(a("index"))).reduce((o,l)=>[...o,...l],[]).filter(Boolean)}else{t.push(...await this.query(`SELECT * FROM "sqlite_master" WHERE "type" = 'table'`));const i=t.map(({name:a})=>`'${a}'`).join(", ");n=await this.query(`SELECT * FROM "sqlite_master" WHERE "type" = 'index' AND "tbl_name" IN (${i})`)}return t.length===0?[]:Promise.all(t.map(async r=>{const i=r.database&&this.driver.getAttachedDatabaseHandleByRelativePath(r.database)?`${this.driver.getAttachedDatabaseHandleByRelativePath(r.database)}.${r.name}`:r.name,a=r.sql,o=a.includes("WITHOUT ROWID"),l=new gt({name:i,withoutRowid:o}),[h,d,p]=await Promise.all([this.loadPragmaRecords(i,"table_xinfo"),this.loadPragmaRecords(i,"index_list"),this.loadPragmaRecords(i,"foreign_key_list")]);let m;const w=r.sql,b=w.toUpperCase().indexOf("AUTOINCREMENT");if(b!==-1){m=w.substr(0,b);const D=m.lastIndexOf(","),ae=m.lastIndexOf("(");D!==-1?(m=m.substr(D),m=m.substr(0,m.lastIndexOf('"')),m=m.substr(m.indexOf('"')+1)):ae!==-1&&(m=m.substr(ae),m=m.substr(0,m.lastIndexOf('"')),m=m.substr(m.indexOf('"')+1))}l.columns=await Promise.all(h.map(async D=>{const ae=new ln;if(ae.name=D.name,ae.type=D.type.toLowerCase(),ae.default=D.dflt_value!==null&&D.dflt_value!==void 0?D.dflt_value:void 0,ae.isNullable=D.notnull===0,ae.isPrimary=D.pk>0,ae.comment="",ae.isGenerated=m===D.name,ae.isGenerated&&(ae.generationStrategy="increment"),D.hidden===2||D.hidden===3){ae.generatedType=D.hidden===2?"VIRTUAL":"STORED";const te=this.selectTypeormMetadataSql({table:l.name,type:Se.GENERATED_COLUMN,name:ae.name}),ce=await this.query(te.query,te.parameters);ce[0]&&ce[0].value?ae.asExpression=ce[0].value:ae.asExpression=""}ae.type==="varchar"&&(ae.enum=re.parseSqlCheckExpression(a,ae.name));const Q=ae.type.indexOf("(");if(Q!==-1){const te=ae.type,ce=te.substr(0,Q);if(this.driver.withLengthColumnTypes.find(fe=>fe===ce)){const fe=parseInt(te.substring(Q+1,te.length-1));fe&&(ae.length=fe.toString(),ae.type=ce)}if(this.driver.withPrecisionColumnTypes.find(fe=>fe===ce)){const fe=new RegExp(`^${ce}\\((\\d+),?\\s?(\\d+)?\\)`),oe=te.match(fe);oe&&oe[1]&&(ae.precision=+oe[1]),this.driver.withScaleColumnTypes.find(ye=>ye===ce)&&oe&&oe[2]&&(ae.scale=+oe[2]),ae.type=ce}}return ae}));let S;const R=[],$=/CONSTRAINT "([^"]*)" FOREIGN KEY ?\((.*?)\) REFERENCES "([^"]*)"/g;for(;(S=$.exec(a))!==null;)R.push({name:S[1],columns:S[2].substr(1,S[2].length-2).split('", "'),referencedTableName:S[3]});const q=re.uniq(p,D=>D.id);l.foreignKeys=q.map(D=>{const ae=p.filter(fe=>fe.id===D.id&&fe.table===D.table),Q=ae.map(fe=>fe.from),te=ae.map(fe=>fe.to),ce=R.find(fe=>fe.referencedTableName===D.table&&fe.columns.every(oe=>Q.indexOf(oe)!==-1));return new Dn({name:ce==null?void 0:ce.name,columnNames:Q,referencedTableName:D.table,referencedColumnNames:te,onDelete:D.on_delete,onUpdate:D.on_update})});let O;const J=[],ne=/CONSTRAINT "([^"]*)" UNIQUE ?\((.*?)\)/g;for(;(O=ne.exec(a))!==null;)J.push({name:O[1],columns:O[2].substr(1,O[2].length-2).split('", "')});const ge=d.filter(D=>D.origin==="u").map(D=>D.name).filter((D,ae,Q)=>Q.indexOf(D)===ae).map(async D=>{const ae=d.find(fe=>fe.name===D),te=(await this.query(`PRAGMA index_info("${ae.name}")`)).sort((fe,oe)=>parseInt(fe.seqno)-parseInt(oe.seqno)).map(fe=>fe.name);if(te.length===1){const fe=l.columns.find(oe=>!!te.find(ye=>ye===oe.name));fe&&(fe.isUnique=!0)}const ce=J.find(fe=>fe.columns.every(oe=>te.indexOf(oe)!==-1));return new Gt({name:ce?ce.name:this.connection.namingStrategy.uniqueConstraintName(l,te),columnNames:te})});l.uniques=await Promise.all(ge);let pe;const me=/CONSTRAINT "([^"]*)" CHECK ?(\(.*?\))([,]|[)]$)/g;for(;(pe=me.exec(a))!==null;)l.checks.push(new Jn({name:pe[1],expression:pe[2]}));const V=d.filter(D=>D.origin==="c").map(D=>D.name).filter((D,ae,Q)=>Q.indexOf(D)===ae).map(async D=>{const ae=n.find(Ge=>Ge.name===D),Q=/WHERE (.*)/.exec(ae.sql),te=d.find(Ge=>Ge.name===D),fe=(await this.query(`PRAGMA index_info("${te.name}")`)).sort((Ge,ze)=>parseInt(Ge.seqno)-parseInt(ze.seqno)).map(Ge=>Ge.name),oe=`${r.database?`${r.database}.`:""}${te.name}`,ye=te.unique==="1"||te.unique===1;return new Ct({table:l,name:oe,columnNames:fe,isUnique:ye,where:Q?Q[1]:void 0})}),Ae=await Promise.all(V);return l.indices=Ae.filter(D=>!!D),l}))}createTableSql(e,t,n){const r=e.columns.filter(w=>w.isPrimary),i=r.find(w=>w.isGenerated&&w.generationStrategy==="increment"),a=r.length>1;if(a&&i)throw new x("Sqlite does not support AUTOINCREMENT on composite primary key");const o=e.columns.map(w=>this.buildCreateColumnSql(w,a)).join(", "),[l]=this.splitTablePath(e.name);let h=`CREATE TABLE ${this.escapePath(e.name)} (${o}`;const[d,p]=this.splitTablePath(e.name),m=n?`${d?`${d}.`:""}${p.replace(/^temporary_/,"")}`:e.name;if(e.columns.filter(w=>w.isUnique).forEach(w=>{e.uniques.some(S=>S.columnNames.length===1&&S.columnNames[0]===w.name)||e.uniques.push(new Gt({name:this.connection.namingStrategy.uniqueConstraintName(e,[w.name]),columnNames:[w.name]}))}),e.uniques.length>0){const w=e.uniques.map(b=>{const S=b.name?b.name:this.connection.namingStrategy.uniqueConstraintName(m,b.columnNames),R=b.columnNames.map($=>`"${$}"`).join(", ");return`CONSTRAINT "${S}" UNIQUE (${R})`}).join(", ");h+=`, ${w}`}if(e.checks.length>0){const w=e.checks.map(b=>`CONSTRAINT "${b.name?b.name:this.connection.namingStrategy.checkConstraintName(m,b.expression)}" CHECK (${b.expression})`).join(", ");h+=`, ${w}`}if(e.foreignKeys.length>0&&t){const w=e.foreignKeys.filter(b=>{const[S]=this.splitTablePath(b.referencedTableName);return S===l}).map(b=>{const[,S]=this.splitTablePath(b.referencedTableName),R=b.columnNames.map(O=>`"${O}"`).join(", ");b.name||(b.name=this.connection.namingStrategy.foreignKeyName(m,b.columnNames,this.getTablePath(b),b.referencedColumnNames));const $=b.referencedColumnNames.map(O=>`"${O}"`).join(", ");let q=`CONSTRAINT "${b.name}" FOREIGN KEY (${R}) REFERENCES "${S}" (${$})`;return b.onDelete&&(q+=` ON DELETE ${b.onDelete}`),b.onUpdate&&(q+=` ON UPDATE ${b.onUpdate}`),b.deferrable&&(q+=` DEFERRABLE ${b.deferrable}`),q}).join(", ");h+=`, ${w}`}if(r.length>1){const w=r.map(b=>`"${b.name}"`).join(", ");h+=`, PRIMARY KEY (${w})`}return h+=")",e.withoutRowid&&(h+=" WITHOUT ROWID"),new _(h)}dropTableSql(e,t){const n=B.isTable(e)?e.name:e,r=t?`DROP TABLE IF EXISTS ${this.escapePath(n)}`:`DROP TABLE ${this.escapePath(n)}`;return new _(r)}createViewSql(e){return typeof e.expression=="string"?new _(`CREATE VIEW "${e.name}" AS ${e.expression}`):new _(`CREATE VIEW "${e.name}" AS ${e.expression(this.connection).getQuery()}`)}insertViewDefinitionSql(e){const t=typeof e.expression=="string"?e.expression.trim():e.expression(this.connection).getQuery();return this.insertTypeormMetadataSql({type:Se.VIEW,name:e.name,value:t})}dropViewSql(e){const t=B.isView(e)?e.name:e;return new _(`DROP VIEW "${t}"`)}deleteViewDefinitionSql(e){const t=B.isView(e)?e.name:e;return this.deleteTypeormMetadataSql({type:Se.VIEW,name:t})}createIndexSql(e,t){const n=t.columnNames.map(a=>`"${a}"`).join(", "),[r,i]=this.splitTablePath(e.name);return new _(`CREATE ${t.isUnique?"UNIQUE ":""}INDEX ${r?`"${r}".`:""}${this.escapePath(t.name)} ON "${i}" (${n}) ${t.where?"WHERE "+t.where:""}`)}dropIndexSql(e){const t=B.isTableIndex(e)?e.name:e;return new _(`DROP INDEX ${this.escapePath(t)}`)}buildCreateColumnSql(e,t){let n='"'+e.name+'"';return B.isColumnMetadata(e)?n+=" "+this.driver.normalizeType(e):n+=" "+this.connection.driver.createFullType(e),e.enum&&(n+=' CHECK( "'+e.name+'" IN ('+e.enum.map(r=>"'"+r+"'").join(",")+") )"),e.isPrimary&&!t&&(n+=" PRIMARY KEY"),e.isGenerated===!0&&e.generationStrategy==="increment"&&(n+=" AUTOINCREMENT"),e.collation&&(n+=" COLLATE "+e.collation),e.isNullable!==!0&&(n+=" NOT NULL"),e.asExpression?n+=` AS (${e.asExpression}) ${e.generatedType?e.generatedType:"VIRTUAL"}`:e.default!==void 0&&e.default!==null&&(n+=" DEFAULT ("+e.default+")"),n}async recreateTable(e,t,n=!0){const r=[],i=[];t.indices.forEach(h=>{r.push(this.dropIndexSql(h)),i.push(this.createIndexSql(t,h))});let[a,o]=this.splitTablePath(e.name);const[,l]=this.splitTablePath(t.name);if(e.name=o=`${a?`${a}.`:""}temporary_${o}`,r.push(this.createTableSql(e,!0,!0)),i.push(this.dropTableSql(e)),n){let h=e.columns.filter(p=>!p.generatedType).map(p=>`"${p.name}"`),d=t.columns.filter(p=>!p.generatedType).map(p=>`"${p.name}"`);d.length<h.length?h=e.columns.filter(p=>{const m=t.columns.find(w=>w.name===p.name);return m&&m.generatedType?!1:!p.generatedType&&m}).map(p=>`"${p.name}"`):d.length>h.length&&(d=t.columns.filter(p=>!p.generatedType&&e.columns.find(m=>m.name===p.name)).map(p=>`"${p.name}"`)),r.push(new _(`INSERT INTO ${this.escapePath(e.name)}(${h.join(", ")}) SELECT ${d.join(", ")} FROM ${this.escapePath(t.name)}`)),i.push(new _(`INSERT INTO ${this.escapePath(t.name)}(${d.join(", ")}) SELECT ${h.join(", ")} FROM ${this.escapePath(e.name)}`))}r.push(this.dropTableSql(t)),i.push(this.createTableSql(t,!0)),r.push(new _(`ALTER TABLE ${this.escapePath(e.name)} RENAME TO ${this.escapePath(l)}`)),i.push(new _(`ALTER TABLE ${this.escapePath(t.name)} RENAME TO ${this.escapePath(o)}`)),e.name=t.name,e.indices.forEach(h=>{h.name||(h.name=this.connection.namingStrategy.indexName(e,h.columnNames,h.where)),r.push(this.createIndexSql(e,h)),i.push(this.dropIndexSql(h))}),t.columns.filter(h=>{const d=e.columns.find(p=>p.name===h.name);return h.generatedType&&h.asExpression&&(!d||!d.generatedType&&!d.asExpression)}).forEach(h=>{const d=this.deleteTypeormMetadataSql({table:t.name,type:Se.GENERATED_COLUMN,name:h.name}),p=this.insertTypeormMetadataSql({table:t.name,type:Se.GENERATED_COLUMN,name:h.name,value:h.asExpression});r.push(d),i.push(p)}),e.columns.filter(h=>h.generatedType&&h.asExpression&&!t.columns.some(d=>d.name===h.name)).forEach(h=>{const d=this.insertTypeormMetadataSql({table:e.name,type:Se.GENERATED_COLUMN,name:h.name,value:h.asExpression}),p=this.deleteTypeormMetadataSql({table:e.name,type:Se.GENERATED_COLUMN,name:h.name});r.push(d),i.push(p)}),e.columns.filter(h=>h.generatedType&&h.asExpression).forEach(h=>{const d=t.columns.find(S=>S.name===h.name&&S.generatedType&&h.generatedType&&S.asExpression!==h.asExpression);if(!d)return;const p=this.deleteTypeormMetadataSql({table:t.name,type:Se.GENERATED_COLUMN,name:d.name}),m=this.insertTypeormMetadataSql({table:e.name,type:Se.GENERATED_COLUMN,name:h.name,value:h.asExpression});r.push(p),r.push(m);const w=this.insertTypeormMetadataSql({table:e.name,type:Se.GENERATED_COLUMN,name:d.name,value:d.asExpression}),b=this.deleteTypeormMetadataSql({table:t.name,type:Se.GENERATED_COLUMN,name:h.name});i.push(w),i.push(b)}),await this.executeQueries(r,i),this.replaceCachedTable(t,e)}splitTablePath(e){return e.indexOf(".")!==-1?e.split("."):[void 0,e]}escapePath(e,t){return(B.isTable(e)||B.isView(e)?e.name:e).replace(/^\.+|\.+$/g,"").split(".").map(r=>t?r:`"${r}"`).join(".")}changeTableComment(e,t){throw new x("sqlit driver does not support change comment.")}}class $x extends Mi{constructor(e){super(),this.driver=e,this.connection=e.connection,this.broadcaster=new mr(this)}async beforeMigration(){await this.query("PRAGMA foreign_keys = OFF")}async afterMigration(){await this.query("PRAGMA foreign_keys = ON")}async query(e,t,n=!1){if(this.isReleased)throw new zt;const r=await this.connect();this.driver.connection.logger.logQuery(e,t,this),await this.broadcaster.broadcast("BeforeQuery",e,t);const i=new $n,a=Date.now();try{const o=await new Promise((m,w)=>{r.executeSql(e,t,b=>m(b),b=>w(b))}),l=this.driver.options.maxQueryExecutionTime,d=Date.now()-a;this.broadcaster.broadcastAfterQueryEvent(i,e,t,!0,d,o,void 0),l&&d>l&&this.driver.connection.logger.logQuerySlow(d,e,t,this);const p=new tr;if(e.substr(0,11)==="INSERT INTO")p.raw=o.insertId;else{const m=[];for(let w=0;w<o.rows.length;w++)m.push(o.rows.item(w));p.records=m,p.raw=m}return n?p:p.raw}catch(o){throw this.driver.connection.logger.logQueryError(o,e,t,this),this.broadcaster.broadcastAfterQueryEvent(i,e,t,!1,void 0,void 0,o),new Kn(e,t,o)}finally{await i.wait()}}async startTransaction(){throw new x("Transactions are not supported by the Cordova driver")}async commitTransaction(){throw new x("Transactions are not supported by the Cordova driver")}async rollbackTransaction(){throw new x("Transactions are not supported by the Cordova driver")}async clearDatabase(){await this.query("PRAGMA foreign_keys = OFF");try{const t=await this.query(`SELECT 'DROP VIEW "' || name || '";' as query FROM "sqlite_master" WHERE "type" = 'view'`),r=await this.query(`SELECT 'DROP TABLE "' || name || '";' as query FROM "sqlite_master" WHERE "type" = 'table' AND "name" != 'sqlite_sequence'`);await Promise.all(t.map(i=>this.query(i.query))),await Promise.all(r.map(i=>this.query(i.query)))}finally{await this.query("PRAGMA foreign_keys = ON")}}parametrize(e,t=0){return Object.keys(e).map((n,r)=>`"${n}"=?`)}}class Lx extends ms{constructor(e){super(e),this.transactionSupport="none",this.database=this.options.database,this.loadDependencies()}async disconnect(){return this.queryRunner=void 0,new Promise((e,t)=>{this.databaseConnection.close(e,t)})}createQueryRunner(e){return this.queryRunner||(this.queryRunner=new $x(this)),this.queryRunner}async createDatabaseConnection(){const e=Object.assign({},{name:this.options.database,location:this.options.location},this.options.extra||{}),t=await new Promise((n,r)=>{this.sqlite.openDatabase(e,i=>n(i),i=>r(i))});return await new Promise((n,r)=>{t.executeSql("PRAGMA foreign_keys = ON",[],()=>n(),i=>r(i))}),t}loadDependencies(){try{const e=this.options.driver||window.sqlitePlugin;this.sqlite=e}catch{throw new ds("Cordova-SQLite","cordova-sqlite-storage")}}}class qx extends Mi{constructor(e){super(),this.driver=e,this.connection=e.connection,this.broadcaster=new mr(this)}async beforeMigration(){await this.query("PRAGMA foreign_keys = OFF")}async afterMigration(){await this.query("PRAGMA foreign_keys = ON")}async query(e,t,n=!1){if(this.isReleased)throw new zt;const r=await this.connect();this.driver.connection.logger.logQuery(e,t,this),await this.broadcaster.broadcast("BeforeQuery",e,t);const i=new $n,a=Date.now();return new Promise(async(o,l)=>{try{r.executeSql(e,t,async h=>{const d=this.driver.options.maxQueryExecutionTime,m=Date.now()-a;this.broadcaster.broadcastAfterQueryEvent(i,e,t,!0,m,h,void 0),d&&m>d&&this.driver.connection.logger.logQuerySlow(m,e,t,this),i.promises.length>0&&await Promise.all(i.promises);const w=new tr;if(h!=null&&h.hasOwnProperty("rowsAffected")&&(w.affected=h.rowsAffected),h!=null&&h.hasOwnProperty("rows")){const b=[];for(let S=0;S<h.rows.length;S++)b.push(h.rows.item(S));w.raw=b,w.records=b}e.substr(0,11)==="INSERT INTO"&&(w.raw=h.insertId),o(n?w:w.raw)},h=>{this.driver.connection.logger.logQueryError(h,e,t,this),this.broadcaster.broadcastAfterQueryEvent(i,e,t,!1,void 0,void 0,h),l(new Kn(e,t,h))})}catch(h){l(h)}finally{await i.wait()}})}parametrize(e,t=0){return Object.keys(e).map((n,r)=>`"${n}"=?`)}}class Bx{constructor(e){this.isReplicated=!1,this.treeSupport=!0,this.transactionSupport="nested",this.supportedDataTypes=["int","integer","tinyint","smallint","mediumint","bigint","unsigned big int","int2","int8","integer","character","varchar","varying character","nchar","native character","nvarchar","text","clob","text","blob","real","double","double precision","float","real","numeric","decimal","boolean","date","time","datetime"],this.supportedUpsertTypes=["on-conflict-do-update"],this.withLengthColumnTypes=["character","varchar","varying character","nchar","native character","nvarchar","text","blob","clob"],this.spatialTypes=[],this.withPrecisionColumnTypes=["real","double","double precision","float","real","numeric","decimal","date","time","datetime"],this.withScaleColumnTypes=["real","double","double precision","float","real","numeric","decimal"],this.mappedDataTypes={createDate:"datetime",createDateDefault:"datetime('now')",updateDate:"datetime",updateDateDefault:"datetime('now')",deleteDate:"datetime",deleteDateNullable:!0,version:"integer",treeLevel:"integer",migrationId:"integer",migrationName:"varchar",migrationTimestamp:"bigint",cacheId:"int",cacheIdentifier:"varchar",cacheTime:"bigint",cacheDuration:"int",cacheQuery:"text",cacheResult:"text",metadataType:"varchar",metadataDatabase:"varchar",metadataSchema:"varchar",metadataTable:"varchar",metadataName:"varchar",metadataValue:"text"},this.cteCapabilities={enabled:!0,requiresRecursiveHint:!0},this.attachedDatabases={},this.connection=e,this.options=e.options,this.database=this.options.database,this.loadDependencies()}createQueryRunner(e){return this.queryRunner||(this.queryRunner=new qx(this)),this.queryRunner}async connect(){this.databaseConnection=await this.createDatabaseConnection()}afterConnect(){return Promise.resolve()}async disconnect(){return new Promise((e,t)=>{this.queryRunner=void 0,this.databaseConnection.close(e,t)})}hasAttachedDatabases(){return!!Object.keys(this.attachedDatabases).length}getAttachedDatabaseHandleByRelativePath(e){var t,n;return(n=(t=this.attachedDatabases)==null?void 0:t[e])==null?void 0:n.attachHandle}getAttachedDatabasePathRelativeByHandle(e){var t;return(t=Object.values(this.attachedDatabases).find(({attachHandle:n})=>e===n))==null?void 0:t.attachFilepathRelative}createSchemaBuilder(){return new tc(this.connection)}preparePersistentValue(e,t){return t.transformer&&(e=It.transformTo(t.transformer,e)),e==null?e:t.type===Boolean||t.type==="boolean"?e===!0?1:0:t.type==="date"?be.mixedDateToDateString(e):t.type==="time"?be.mixedDateToTimeString(e):t.type==="datetime"||t.type===Date?be.mixedDateToUtcDatetimeString(e):t.type==="simple-array"?be.simpleArrayToString(e):t.type==="simple-json"?be.simpleJsonToString(e):t.type==="simple-enum"?be.simpleEnumToString(e):e}prepareHydratedValue(e,t){return e==null?t.transformer?It.transformFrom(t.transformer,e):e:(t.type===Boolean||t.type==="boolean"?e=!!e:t.type==="datetime"||t.type===Date?(e&&typeof e=="string"&&(/^\d\d\d\d-\d\d-\d\d \d\d:\d\d/.test(e)&&(e=e.replace(" ","T")),/^\d\d\d\d-\d\d-\d\dT\d\d:\d\d(:\d\d(\.\d\d\d)?)?$/.test(e)&&(e+="Z")),e=be.normalizeHydratedDate(e)):t.type==="date"?e=be.mixedDateToDateString(e):t.type==="time"?e=be.mixedTimeToString(e):t.type==="simple-array"?e=be.stringToSimpleArray(e):t.type==="simple-json"?e=be.stringToSimpleJson(e):t.type==="simple-enum"?e=be.stringToSimpleEnum(e,t):t.type===Number&&(e=isNaN(+e)?e:parseInt(e)),t.transformer&&(e=It.transformFrom(t.transformer,e)),e)}escapeQueryWithParameters(e,t,n){const r=Object.keys(n).map(i=>typeof n[i]=="boolean"?n[i]===!0?1:0:n[i]instanceof Date?be.mixedDateToUtcDatetimeString(n[i]):n[i]);return!t||!Object.keys(t).length?[e,r]:(e=e.replace(/:(\.\.\.)?([A-Za-z0-9_.]+)/g,(i,a,o)=>{if(!t.hasOwnProperty(o))return i;const l=t[o];return a?l.map(h=>(r.push(h),this.createParameter(o,r.length-1))).join(", "):typeof l=="function"?l():typeof l=="number"?String(l):typeof l=="boolean"?(r.push(+l),this.createParameter(o,r.length-1)):l instanceof Date?(r.push(be.mixedDateToUtcDatetimeString(l)),this.createParameter(o,r.length-1)):(r.push(l),this.createParameter(o,r.length-1))}),[e,r])}escape(e){return'"'+e+'"'}buildTableName(e,t,n){return e}parseTableName(e){const t=this.database,n=void 0;if(B.isTable(e)||B.isView(e)){const i=this.parseTableName(e.schema?`"${e.schema}"."${e.name}"`:e.name);return{database:e.database||i.database||t,schema:e.schema||i.schema||n,tableName:i.tableName}}if(B.isTableForeignKey(e)){const i=this.parseTableName(e.referencedTableName);return{database:e.referencedDatabase||i.database||t,schema:e.referencedSchema||i.schema||n,tableName:i.tableName}}if(B.isEntityMetadata(e))return{database:e.database||t,schema:e.schema||n,tableName:e.tableName};const r=e.split(".");return r.length===3?{database:r[0]||t,schema:r[1]||n,tableName:r[2]}:r.length===2?{database:this.getAttachedDatabasePathRelativeByHandle(r[0])??t,schema:r[0],tableName:r[1]}:{database:t,schema:n,tableName:e}}normalizeType(e){return e.type===Number||e.type==="int"?"integer":e.type===String?"varchar":e.type===Date?"datetime":e.type===Boolean?"boolean":e.type==="uuid"?"varchar":e.type==="simple-array"||e.type==="simple-json"?"text":e.type==="simple-enum"?"varchar":e.type||""}normalizeDefault(e){const t=e.default;if(typeof t=="number")return""+t;if(typeof t=="boolean")return t?"1":"0";if(typeof t=="function")return t();if(typeof t=="string")return`'${t}'`;if(t!=null)return`${t}`}normalizeIsUnique(e){return e.entityMetadata.uniques.some(t=>t.columns.length===1&&t.columns[0]===e)}getColumnLength(e){return e.length?e.length.toString():""}createFullType(e){let t=e.type;return e.enum?"varchar":(e.length?t+="("+e.length+")":e.precision!==null&&e.precision!==void 0&&e.scale!==null&&e.scale!==void 0?t+="("+e.precision+","+e.scale+")":e.precision!==null&&e.precision!==void 0&&(t+="("+e.precision+")"),e.isArray&&(t+=" array"),t)}obtainMasterConnection(){return Promise.resolve()}obtainSlaveConnection(){return Promise.resolve()}createGeneratedMap(e,t,n,r){const i=e.generatedColumns.reduce((a,o)=>{let l;return o.generationStrategy==="increment"&&t&&(l=t-r+n+1),l?re.mergeDeep(a,o.createValueMap(l)):a},{});return Object.keys(i).length>0?i:void 0}findChangedColumns(e,t){return t.filter(n=>{const r=e.find(a=>a.name===n.databaseName);return r?r.name!==n.databaseName||r.type!==this.normalizeType(n)||r.length!==n.length||r.precision!==n.precision||r.scale!==n.scale||this.normalizeDefault(n)!==r.default||r.isPrimary!==n.isPrimary||r.isNullable!==n.isNullable||r.generatedType!==n.generatedType||r.asExpression!==n.asExpression||r.isUnique!==this.normalizeIsUnique(n)||r.enum&&n.enum&&!re.isArraysEqual(r.enum,n.enum.map(a=>a+""))||n.generationStrategy!=="uuid"&&r.isGenerated!==n.isGenerated:!1})}isReturningSqlSupported(){return!1}isUUIDGenerationSupported(){return!1}isFullTextColumnTypeSupported(){return!1}createParameter(e,t){return"?"}createDatabaseConnection(){return new Promise((e,t)=>{const n=Object.assign({},{name:this.options.database,location:this.options.location},this.options.extra||{});this.sqlite.openDatabase(n,r=>{const i=r;i.executeSql("PRAGMA foreign_keys = ON",[],a=>{e(i)},a=>{t(a)})},r=>{t(r)})})}loadDependencies(){try{const e=this.options.driver||require("react-native-sqlite-storage");this.sqlite=e}catch{throw new ds("React-Native","react-native-sqlite-storage")}}}class Ux extends Mi{constructor(e){super(),this.driver=e,this.connection=e.connection,this.broadcaster=new mr(this)}async beforeMigration(){await this.query("PRAGMA foreign_keys = OFF")}async afterMigration(){await this.query("PRAGMA foreign_keys = ON")}async query(e,t,n=!1){if(this.isReleased)throw new zt;const r=this.driver.connection,i=await this.connect();return new Promise((a,o)=>{const l=e.substr(0,11)==="INSERT INTO";r.logger.logQuery(e,t,this);const h=(p,m)=>{const w=this.driver.options.maxQueryExecutionTime,S=Date.now()-d;w&&S>w&&r.logger.logQuerySlow(S,e,t,this),p&&(r.logger.logQueryError(p,e,t,this),o(new Kn(e,t,p)));const R=new tr;R.raw=m,!l&&Array.isArray(m)&&(R.records=m),a(n?R:R.raw)},d=Date.now();l?i.execSQL(e,t,h):i.all(e,t,h)})}parametrize(e,t=0){return Object.keys(e).map((n,r)=>`"${n}"=?`)}}class Fx extends ms{constructor(e){super(e),this.connection=e,this.options=e.options,this.database=this.options.database,this.driver=this.options.driver,this.loadDependencies()}async disconnect(){return new Promise((e,t)=>{this.queryRunner=void 0,this.databaseConnection.close().then(e).catch(t)})}createQueryRunner(e){return this.queryRunner||(this.queryRunner=new Ux(this)),this.queryRunner}normalizeType(e){return e.type===Buffer?"blob":super.normalizeType(e)}createDatabaseConnection(){return new Promise((e,t)=>{const n=Object.assign({},{readOnly:this.options.readOnly,key:this.options.key,multithreading:this.options.multithreading,migrate:this.options.migrate,iosFlags:this.options.iosFlags,androidFlags:this.options.androidFlags},this.options.extra||{});new this.sqlite(this.options.database,n,(r,i)=>{if(r)return t(r);i.resultType(this.sqlite.RESULTSASOBJECT),i.execSQL("PRAGMA foreign_keys = ON",[],(a,o)=>{if(a)return t(a);e(i)})})})}loadDependencies(){if(this.sqlite=this.driver,!this.driver)throw new ds("Nativescript","nativescript-sqlite")}}class kx extends Mi{constructor(e){super(),this.isDirty=!1,this.driver=e,this.connection=e.connection,this.broadcaster=new mr(this)}async beforeMigration(){await this.query("PRAGMA foreign_keys = OFF")}async afterMigration(){await this.query("PRAGMA foreign_keys = ON")}async flush(){this.isDirty&&(await this.driver.autoSave(),this.isDirty=!1)}async release(){return await this.flush(),super.release()}async commitTransaction(){await super.commitTransaction(),this.isTransactionActive||await this.flush()}async query(e,t=[],n=!1){if(this.isReleased)throw new zt;const r=e.trim().split(" ",1)[0],i=this.driver.databaseConnection;this.driver.connection.logger.logQuery(e,t,this),await this.broadcaster.broadcast("BeforeQuery",e,t);const a=new $n,o=Date.now();let l;try{l=i.prepare(e),t&&(t=t.map(b=>typeof b<"u"?b:null),l.bind(t));const h=this.driver.options.maxQueryExecutionTime,p=Date.now()-o;h&&p>h&&this.driver.connection.logger.logQuerySlow(p,e,t,this);const m=[];for(;l.step();)m.push(l.getAsObject());this.broadcaster.broadcastAfterQueryEvent(a,e,t,!0,p,m,void 0);const w=new tr;return w.affected=i.getRowsModified(),w.records=m,w.raw=m,l.free(),r!=="SELECT"&&(this.isDirty=!0),n?w:w.raw}catch(h){throw l&&l.free(),this.driver.connection.logger.logQueryError(h,e,t,this),this.broadcaster.broadcastAfterQueryEvent(a,e,t,!1,void 0,void 0,h),new Kn(e,t,h)}finally{await a.wait()}}}class jx extends ms{constructor(e){if(super(e),this.options.autoSave&&!this.options.location&&!this.options.autoSaveCallback)throw new P0("location or autoSaveCallback");this.loadDependencies()}async connect(){this.databaseConnection=await this.createDatabaseConnection()}async disconnect(){this.queryRunner=void 0,this.databaseConnection.close()}createQueryRunner(e){return this.queryRunner||(this.queryRunner=new kx(this)),this.queryRunner}async load(e,t=!0){if(typeof e=="string")if(Xe.type==="node")if(Xe.fileExist(e)){const n=Xe.readFileSync(e);return this.createDatabaseConnectionWithImport(n)}else{if(t)throw new x(`File ${e} does not exist`);return this.createDatabaseConnectionWithImport()}else{let n=null;if(this.options.useLocalForage)if(window.localforage)n=await window.localforage.getItem(e);else throw new x("localforage is not defined - please import localforage.js into your site");else n=Xe.getGlobalVariable().localStorage.getItem(e);if(n!=null)return this.createDatabaseConnectionWithImport(JSON.parse(n));if(t)throw new x(`File ${e} does not exist`);return this.createDatabaseConnectionWithImport()}else return this.createDatabaseConnectionWithImport(e)}async save(e){if(!e&&!this.options.location)throw new x("No location is set, specify a location parameter or add the location option to your configuration");let t="";if(e?t=e:this.options.location&&(t=this.options.location),Xe.type==="node")try{const n=Buffer.from(this.databaseConnection.export());await Xe.writeFile(t,n)}catch(n){throw new x(`Could not save database, error: ${n}`)}else{const n=this.databaseConnection.export(),r=[].slice.call(n);if(this.options.useLocalForage)if(window.localforage)await window.localforage.setItem(t,JSON.stringify(r));else throw new x("localforage is not defined - please import localforage.js into your site");else Xe.getGlobalVariable().localStorage.setItem(t,JSON.stringify(r))}}async autoSave(){var e;this.options.autoSave&&!((e=this.queryRunner)!=null&&e.isTransactionActive)&&(this.options.autoSaveCallback?await this.options.autoSaveCallback(this.export()):await this.save())}export(){return this.databaseConnection.export()}createGeneratedMap(e,t){const n=e.generatedColumns.reduce((r,i)=>{if(i.isPrimary&&i.generationStrategy==="increment"){const a="SELECT last_insert_rowid()";try{const o=this.databaseConnection.exec(a);return this.connection.logger.logQuery(a),re.mergeDeep(r,i.createValueMap(o[0].values[0][0]))}catch(o){this.connection.logger.logQueryError(o,a,[])}}return r},{});return Object.keys(n).length>0?n:void 0}createDatabaseConnection(){return this.options.location?this.load(this.options.location,!1):this.createDatabaseConnectionWithImport(this.options.database)}async createDatabaseConnectionWithImport(e){const n=typeof this.sqlite.Database=="function"?this.sqlite:await this.sqlite(this.options.sqlJsConfig);return e&&e.length>0?this.databaseConnection=new n.Database(e):this.databaseConnection=new n.Database,this.databaseConnection.exec("PRAGMA foreign_keys = ON"),this.databaseConnection}loadDependencies(){if(Xe.type==="browser"){const e=this.options.driver||window.SQL;this.sqlite=e}else try{const e=this.options.driver||Xe.load("sql.js");this.sqlite=e}catch{throw new ds("sql.js","sql.js")}}}class Wx extends Mi{constructor(e){super(),this.driver=e,this.connection=e.connection,this.broadcaster=new mr(this)}async beforeMigration(){await this.query("PRAGMA foreign_keys = OFF")}async afterMigration(){await this.query("PRAGMA foreign_keys = ON")}async query(e,t,n=!1){if(this.isReleased)throw new zt;const r=await this.connect(),i=new $n;this.driver.connection.logger.logQuery(e,t,this),await this.broadcaster.broadcast("BeforeQuery",e,t);const a=Date.now(),o=await r.prepareAsync(e);try{const l=await o.executeAsync(t),h=this.driver.options.maxQueryExecutionTime,p=Date.now()-a;this.broadcaster.broadcastAfterQueryEvent(i,e,t,!0,p,l,void 0),await i.wait(),h&&p>h&&this.driver.connection.logger.logQuerySlow(p,e,t,this);const m=new tr;return m.affected=l.changes,m.records=await l.getAllAsync(),m.raw=e.startsWith("INSERT INTO")?l.lastInsertRowId:m.records,n?m:m.raw}catch(l){throw this.driver.connection.logger.logQueryError(l,e,t,this),this.broadcaster.broadcastAfterQueryEvent(i,e,t,!1,0,void 0,l),await i.wait(),new Kn(e,t,l)}finally{await i.wait(),await o.finalizeAsync()}}}class Qx extends ms{constructor(e){super(e),this.sqlite=this.options.driver}async disconnect(){this.queryRunner=void 0,await this.databaseConnection.closeAsync(),this.databaseConnection=void 0}createQueryRunner(){return this.queryRunner||(this.queryRunner=new Wx(this)),this.queryRunner}async createDatabaseConnection(){return this.databaseConnection=await this.sqlite.openDatabaseAsync(this.options.database),await this.databaseConnection.runAsync("PRAGMA foreign_keys = ON"),this.databaseConnection}}class Vx extends Mi{constructor(e){super(),this.driver=e,this.connection=e.connection,this.broadcaster=new mr(this)}async startTransaction(){this.isTransactionActive=!0;try{await this.broadcaster.broadcast("BeforeTransactionStart")}catch(e){throw this.isTransactionActive=!1,e}this.transactionDepth+=1,await this.broadcaster.broadcast("AfterTransactionStart")}async commitTransaction(){if(!this.isTransactionActive&&typeof this.transaction>"u")throw new In;await this.broadcaster.broadcast("BeforeTransactionCommit"),this.transaction=void 0,this.isTransactionActive=!1,this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionCommit")}async rollbackTransaction(){if(!this.isTransactionActive&&typeof this.transaction>"u")throw new In;await this.broadcaster.broadcast("BeforeTransactionRollback"),this.transaction=void 0,this.isTransactionActive=!1,this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionRollback")}async beforeMigration(){const e=await this.connect();return new Promise((t,n)=>{e.exec([{sql:"PRAGMA foreign_keys = OFF",args:[]}],!1,r=>r?n(r):t())})}async afterMigration(){const e=await this.connect();return new Promise((t,n)=>{e.exec([{sql:"PRAGMA foreign_keys = ON",args:[]}],!1,r=>r?n(r):t())})}async query(e,t,n=!1){if(this.isReleased)throw new zt;return new Promise(async(r,i)=>{const a=await this.connect(),o=new $n;this.driver.connection.logger.logQuery(e,t,this),this.broadcaster.broadcastBeforeQueryEvent(o,e,t);const l=Date.now();a.transaction(async h=>{typeof this.transaction>"u"&&(await this.startTransaction(),this.transaction=h),this.transaction.executeSql(e,t,async(d,p)=>{const m=this.driver.options.maxQueryExecutionTime,b=Date.now()-l;this.broadcaster.broadcastAfterQueryEvent(o,e,t,!0,b,p,void 0),await o.wait(),m&&b>m&&this.driver.connection.logger.logQuerySlow(b,e,t,this);const S=new tr;if(p!=null&&p.hasOwnProperty("rowsAffected")&&(S.affected=p.rowsAffected),p!=null&&p.hasOwnProperty("rows")){const R=[];for(let $=0;$<p.rows.length;$++)R.push(p.rows.item($));S.raw=R,S.records=R}e.startsWith("INSERT INTO")&&(S.raw=p.insertId),r(n?S:S.raw)},async(d,p)=>{this.driver.connection.logger.logQueryError(p,e,t,this),this.broadcaster.broadcastAfterQueryEvent(o,e,t,!1,void 0,void 0,p),await o.wait(),i(new Kn(e,t,p))})},async h=>{await this.rollbackTransaction(),i(h)},()=>{this.isTransactionActive=!1,this.transaction=void 0})})}}class Hx extends ms{constructor(e){super(e),this.database=this.options.database,this.sqlite=this.options.driver}async disconnect(){return new Promise((e,t)=>{try{this.queryRunner=void 0,this.databaseConnection._db.close(),this.databaseConnection=void 0,e()}catch(n){t(n)}})}createQueryRunner(e){return this.queryRunner||(this.queryRunner=new Vx(this)),this.queryRunner}createDatabaseConnection(){return new Promise((e,t)=>{try{const n=this.sqlite.openDatabase(this.options.database);n.transaction(r=>{r.executeSql("PRAGMA foreign_keys = ON",[],(i,a)=>{e(n)},(i,a)=>{t({transaction:i,error:a})})},r=>{t(r)})}catch(n){t(n)}})}}class Yx{constructor(e){this.connection=e}create(){return this.isLegacyDriver?new Hx(this.connection):new Qx(this.connection)}get isLegacyDriver(){return!("openDatabaseAsync"in this.connection.options.driver)}}class Gx extends nc{constructor(e,t){super(),this.driver=e,this.connection=e.connection,this.client=t,this.broadcaster=new mr(this)}async connect(){return{}}release(){return this.isReleased=!0,this.databaseConnection&&this.databaseConnection.release(),Promise.resolve()}async startTransaction(e){this.isTransactionActive=!0;try{await this.broadcaster.broadcast("BeforeTransactionStart")}catch(t){throw this.isTransactionActive=!1,t}this.transactionDepth===0?await this.client.startTransaction():await this.query(`SAVEPOINT typeorm_${this.transactionDepth}`),this.transactionDepth+=1,await this.broadcaster.broadcast("AfterTransactionStart")}async commitTransaction(){if(!this.isTransactionActive)throw new In;await this.broadcaster.broadcast("BeforeTransactionCommit"),this.transactionDepth>1?await this.query(`RELEASE SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.client.commitTransaction(),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionCommit")}async rollbackTransaction(){if(!this.isTransactionActive)throw new In;await this.broadcaster.broadcast("BeforeTransactionRollback"),this.transactionDepth>1?await this.query(`ROLLBACK TO SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.client.rollbackTransaction(),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionRollback")}async query(e,t,n=!1){if(this.isReleased)throw new zt;const r=await this.client.query(e,t),i=new tr;return i.raw=r,r!=null&&r.hasOwnProperty("records")&&Array.isArray(r.records)&&(i.records=r.records),r!=null&&r.hasOwnProperty("numberOfRecordsUpdated")&&(i.affected=r.numberOfRecordsUpdated),n?i:i.raw}stream(e,t,n,r){if(this.isReleased)throw new zt;return new Promise(async(i,a)=>{try{const l=(await this.connect()).query(e,t);n&&l.on("end",n),r&&l.on("error",r),i(l)}catch(o){a(o)}})}async getDatabases(){return Promise.resolve([])}async getSchemas(e){throw new x("MySql driver does not support table schemas")}async hasDatabase(e){return!!(await this.query(`SELECT * FROM \`INFORMATION_SCHEMA\`.\`SCHEMATA\` WHERE \`SCHEMA_NAME\` = '${e}'`)).length}async getCurrentDatabase(){return(await this.query("SELECT DATABASE() AS `db_name`"))[0].db_name}async hasSchema(e){throw new x("MySql driver does not support table schemas")}async getCurrentSchema(){return(await this.query("SELECT SCHEMA() AS `schema_name`"))[0].schema_name}async hasTable(e){const t=this.driver.parseTableName(e),n=`SELECT * FROM \`INFORMATION_SCHEMA\`.\`COLUMNS\` WHERE \`TABLE_SCHEMA\` = '${t.database}' AND \`TABLE_NAME\` = '${t.tableName}'`;return!!(await this.query(n)).length}async hasColumn(e,t){const n=this.driver.parseTableName(e),r=B.isTableColumn(t)?t.name:t,i=`SELECT * FROM \`INFORMATION_SCHEMA\`.\`COLUMNS\` WHERE \`TABLE_SCHEMA\` = '${n.database}' AND \`TABLE_NAME\` = '${n.tableName}' AND \`COLUMN_NAME\` = '${r}'`;return!!(await this.query(i)).length}async createDatabase(e,t){const n=t?`CREATE DATABASE IF NOT EXISTS \`${e}\``:`CREATE DATABASE \`${e}\``,r=`DROP DATABASE \`${e}\``;await this.executeQueries(new _(n),new _(r))}async dropDatabase(e,t){const n=t?`DROP DATABASE IF EXISTS \`${e}\``:`DROP DATABASE \`${e}\``,r=`CREATE DATABASE \`${e}\``;await this.executeQueries(new _(n),new _(r))}async createSchema(e,t){throw new x("Schema create queries are not supported by MySql driver.")}async dropSchema(e,t){throw new x("Schema drop queries are not supported by MySql driver.")}async createTable(e,t=!1,n=!0){if(t&&await this.hasTable(e))return Promise.resolve();const r=[],i=[];return r.push(this.createTableSql(e,n)),i.push(this.dropTableSql(e)),e.indices.forEach(a=>i.push(this.dropIndexSql(e,a))),n&&e.foreignKeys.forEach(a=>i.push(this.dropForeignKeySql(e,a))),this.executeQueries(r,i)}async dropTable(e,t,n=!0){if(t&&!await this.hasTable(e))return Promise.resolve();const r=n,i=this.getTablePath(e),a=await this.getCachedTable(i),o=[],l=[];n&&a.foreignKeys.forEach(h=>o.push(this.dropForeignKeySql(a,h))),a.indices.forEach(h=>o.push(this.dropIndexSql(a,h))),o.push(this.dropTableSql(a)),l.push(this.createTableSql(a,r)),await this.executeQueries(o,l)}async createView(e,t=!1){const n=[],r=[];n.push(this.createViewSql(e)),t&&n.push(await this.insertViewDefinitionSql(e)),r.push(this.dropViewSql(e)),t&&r.push(await this.deleteViewDefinitionSql(e)),await this.executeQueries(n,r)}async dropView(e){const t=B.isView(e)?e.name:e,n=await this.getCachedView(t),r=[],i=[];r.push(await this.deleteViewDefinitionSql(n)),r.push(this.dropViewSql(n)),i.push(await this.insertViewDefinitionSql(n)),i.push(this.createViewSql(n)),await this.executeQueries(r,i)}async renameTable(e,t){const n=[],r=[],i=B.isTable(e)?e:await this.getCachedTable(e),a=i.clone(),{database:o}=this.driver.parseTableName(i);a.name=o?`${o}.${t}`:t,n.push(new _(`RENAME TABLE ${this.escapePath(i)} TO ${this.escapePath(a)}`)),r.push(new _(`RENAME TABLE ${this.escapePath(a)} TO ${this.escapePath(i)}`)),a.indices.forEach(l=>{const h=l.columnNames.map(m=>`\`${m}\``).join(", "),d=this.connection.namingStrategy.indexName(a,l.columnNames,l.where);let p="";l.isUnique&&(p+="UNIQUE "),l.isSpatial&&(p+="SPATIAL "),l.isFulltext&&(p+="FULLTEXT "),n.push(new _(`ALTER TABLE ${this.escapePath(a)} DROP INDEX \`${l.name}\`, ADD ${p}INDEX \`${d}\` (${h})`)),r.push(new _(`ALTER TABLE ${this.escapePath(a)} DROP INDEX \`${d}\`, ADD ${p}INDEX \`${l.name}\` (${h})`)),l.name=d}),a.foreignKeys.forEach(l=>{const h=l.columnNames.map(b=>`\`${b}\``).join(", "),d=l.referencedColumnNames.map(b=>`\`${b}\``).join(","),p=this.connection.namingStrategy.foreignKeyName(a,l.columnNames);let m=`ALTER TABLE ${this.escapePath(a)} DROP FOREIGN KEY \`${l.name}\`, ADD CONSTRAINT \`${p}\` FOREIGN KEY (${h}) REFERENCES ${this.escapePath(this.getTablePath(l))}(${d})`;l.onDelete&&(m+=` ON DELETE ${l.onDelete}`),l.onUpdate&&(m+=` ON UPDATE ${l.onUpdate}`);let w=`ALTER TABLE ${this.escapePath(a)} DROP FOREIGN KEY \`${p}\`, ADD CONSTRAINT \`${l.name}\` FOREIGN KEY (${h}) REFERENCES ${this.escapePath(this.getTablePath(l))}(${d})`;l.onDelete&&(w+=` ON DELETE ${l.onDelete}`),l.onUpdate&&(w+=` ON UPDATE ${l.onUpdate}`),n.push(new _(m)),r.push(new _(w)),l.name=p}),await this.executeQueries(n,r),i.name=a.name,this.replaceCachedTable(i,a)}async addColumn(e,t){const n=B.isTable(e)?e:await this.getCachedTable(e),r=n.clone(),i=[],a=[],o=r.primaryColumns.length>0;if(i.push(new _(`ALTER TABLE ${this.escapePath(n)} ADD ${this.buildCreateColumnSql(t,o,!1)}`)),a.push(new _(`ALTER TABLE ${this.escapePath(n)} DROP COLUMN \`${t.name}\``)),t.isPrimary&&o){const h=r.columns.find(m=>m.isGenerated&&m.generationStrategy==="increment");if(h){const m=h.clone();m.isGenerated=!1,m.generationStrategy=void 0,i.push(new _(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${t.name}\` ${this.buildCreateColumnSql(m,!0)}`)),a.push(new _(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${m.name}\` ${this.buildCreateColumnSql(t,!0)}`))}const d=r.primaryColumns;let p=d.map(m=>`\`${m.name}\``).join(", ");if(i.push(new _(`ALTER TABLE ${this.escapePath(n)} DROP PRIMARY KEY`)),a.push(new _(`ALTER TABLE ${this.escapePath(n)} ADD PRIMARY KEY (${p})`)),d.push(t),p=d.map(m=>`\`${m.name}\``).join(", "),i.push(new _(`ALTER TABLE ${this.escapePath(n)} ADD PRIMARY KEY (${p})`)),a.push(new _(`ALTER TABLE ${this.escapePath(n)} DROP PRIMARY KEY`)),h){const m=h.clone();m.isGenerated=!1,m.generationStrategy=void 0,i.push(new _(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${m.name}\` ${this.buildCreateColumnSql(t,!0)}`)),a.push(new _(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${t.name}\` ${this.buildCreateColumnSql(m,!0)}`))}}const l=r.indices.find(h=>h.columnNames.length===1&&h.columnNames[0]===t.name);if(l)i.push(this.createIndexSql(n,l)),a.push(this.dropIndexSql(n,l));else if(t.isUnique){const h=new Ct({name:this.connection.namingStrategy.indexName(n,[t.name]),columnNames:[t.name],isUnique:!0});r.indices.push(h),r.uniques.push(new Gt({name:h.name,columnNames:h.columnNames})),i.push(new _(`ALTER TABLE ${this.escapePath(n)} ADD UNIQUE INDEX \`${h.name}\` (\`${t.name}\`)`)),a.push(new _(`ALTER TABLE ${this.escapePath(n)} DROP INDEX \`${h.name}\``))}await this.executeQueries(i,a),r.addColumn(t),this.replaceCachedTable(n,r)}async addColumns(e,t){for(const n of t)await this.addColumn(e,n)}async renameColumn(e,t,n){const r=B.isTable(e)?e:await this.getCachedTable(e),i=B.isTableColumn(t)?t:r.columns.find(o=>o.name===t);if(!i)throw new x(`Column "${t}" was not found in the "${r.name}" table.`);let a;B.isTableColumn(n)?a=n:(a=i.clone(),a.name=n),await this.changeColumn(r,i,a)}async changeColumn(e,t,n){const r=B.isTable(e)?e:await this.getCachedTable(e);let i=r.clone();const a=[],o=[],l=B.isTableColumn(t)?t:r.columns.find(h=>h.name===t);if(!l)throw new x(`Column "${t}" was not found in the "${r.name}" table.`);if(n.isGenerated!==l.isGenerated&&n.generationStrategy!=="uuid"||l.type!==n.type||l.length!==n.length||l.generatedType!==n.generatedType)await this.dropColumn(r,l),await this.addColumn(r,n),i=r.clone();else{if(n.name!==l.name){a.push(new _(`ALTER TABLE ${this.escapePath(r)} CHANGE \`${l.name}\` \`${n.name}\` ${this.buildCreateColumnSql(l,!0,!0)}`)),o.push(new _(`ALTER TABLE ${this.escapePath(r)} CHANGE \`${n.name}\` \`${l.name}\` ${this.buildCreateColumnSql(l,!0,!0)}`)),i.findColumnIndices(l).forEach(d=>{d.columnNames.splice(d.columnNames.indexOf(l.name),1),d.columnNames.push(n.name);const p=d.columnNames.map(b=>`\`${b}\``).join(", "),m=this.connection.namingStrategy.indexName(i,d.columnNames,d.where);let w="";d.isUnique&&(w+="UNIQUE "),d.isSpatial&&(w+="SPATIAL "),d.isFulltext&&(w+="FULLTEXT "),a.push(new _(`ALTER TABLE ${this.escapePath(r)} DROP INDEX \`${d.name}\`, ADD ${w}INDEX \`${m}\` (${p})`)),o.push(new _(`ALTER TABLE ${this.escapePath(r)} DROP INDEX \`${m}\`, ADD ${w}INDEX \`${d.name}\` (${p})`)),d.name=m}),i.findColumnForeignKeys(l).forEach(d=>{d.columnNames.splice(d.columnNames.indexOf(l.name),1),d.columnNames.push(n.name);const p=d.columnNames.map(R=>`\`${R}\``).join(", "),m=d.referencedColumnNames.map(R=>`\`${R}\``).join(","),w=this.connection.namingStrategy.foreignKeyName(i,d.columnNames);let b=`ALTER TABLE ${this.escapePath(r)} DROP FOREIGN KEY \`${d.name}\`, ADD CONSTRAINT \`${w}\` FOREIGN KEY (${p}) REFERENCES ${this.escapePath(this.getTablePath(d))}(${m})`;d.onDelete&&(b+=` ON DELETE ${d.onDelete}`),d.onUpdate&&(b+=` ON UPDATE ${d.onUpdate}`);let S=`ALTER TABLE ${this.escapePath(r)} DROP FOREIGN KEY \`${w}\`, ADD CONSTRAINT \`${d.name}\` FOREIGN KEY (${p}) REFERENCES ${this.escapePath(this.getTablePath(d))}(${m})`;d.onDelete&&(S+=` ON DELETE ${d.onDelete}`),d.onUpdate&&(S+=` ON UPDATE ${d.onUpdate}`),a.push(new _(b)),o.push(new _(S)),d.name=w});const h=i.columns.find(d=>d.name===l.name);i.columns[i.columns.indexOf(h)].name=n.name,l.name=n.name}if(this.isColumnChanged(l,n,!0)&&(a.push(new _(`ALTER TABLE ${this.escapePath(r)} CHANGE \`${l.name}\` ${this.buildCreateColumnSql(n,!0)}`)),o.push(new _(`ALTER TABLE ${this.escapePath(r)} CHANGE \`${n.name}\` ${this.buildCreateColumnSql(l,!0)}`))),n.isPrimary!==l.isPrimary){const h=i.columns.find(p=>p.isGenerated&&p.generationStrategy==="increment");if(h){const p=h.clone();p.isGenerated=!1,p.generationStrategy=void 0,a.push(new _(`ALTER TABLE ${this.escapePath(r)} CHANGE \`${h.name}\` ${this.buildCreateColumnSql(p,!0)}`)),o.push(new _(`ALTER TABLE ${this.escapePath(r)} CHANGE \`${p.name}\` ${this.buildCreateColumnSql(h,!0)}`))}const d=i.primaryColumns;if(d.length>0){const p=d.map(m=>`\`${m.name}\``).join(", ");a.push(new _(`ALTER TABLE ${this.escapePath(r)} DROP PRIMARY KEY`)),o.push(new _(`ALTER TABLE ${this.escapePath(r)} ADD PRIMARY KEY (${p})`))}if(n.isPrimary===!0){d.push(n);const p=i.columns.find(w=>w.name===n.name);p.isPrimary=!0;const m=d.map(w=>`\`${w.name}\``).join(", ");a.push(new _(`ALTER TABLE ${this.escapePath(r)} ADD PRIMARY KEY (${m})`)),o.push(new _(`ALTER TABLE ${this.escapePath(r)} DROP PRIMARY KEY`))}else{const p=d.find(w=>w.name===n.name);d.splice(d.indexOf(p),1);const m=i.columns.find(w=>w.name===n.name);if(m.isPrimary=!1,d.length>0){const w=d.map(b=>`\`${b.name}\``).join(", ");a.push(new _(`ALTER TABLE ${this.escapePath(r)} ADD PRIMARY KEY (${w})`)),o.push(new _(`ALTER TABLE ${this.escapePath(r)} DROP PRIMARY KEY`))}}if(h){const p=h.clone();p.isGenerated=!1,p.generationStrategy=void 0,a.push(new _(`ALTER TABLE ${this.escapePath(r)} CHANGE \`${p.name}\` ${this.buildCreateColumnSql(h,!0)}`)),o.push(new _(`ALTER TABLE ${this.escapePath(r)} CHANGE \`${h.name}\` ${this.buildCreateColumnSql(p,!0)}`))}}if(n.isUnique!==l.isUnique)if(n.isUnique===!0){const h=new Ct({name:this.connection.namingStrategy.indexName(r,[n.name]),columnNames:[n.name],isUnique:!0});i.indices.push(h),i.uniques.push(new Gt({name:h.name,columnNames:h.columnNames})),a.push(new _(`ALTER TABLE ${this.escapePath(r)} ADD UNIQUE INDEX \`${h.name}\` (\`${n.name}\`)`)),o.push(new _(`ALTER TABLE ${this.escapePath(r)} DROP INDEX \`${h.name}\``))}else{const h=i.indices.find(p=>p.columnNames.length===1&&p.isUnique===!0&&!!p.columnNames.find(m=>m===n.name));i.indices.splice(i.indices.indexOf(h),1);const d=i.uniques.find(p=>p.name===h.name);i.uniques.splice(i.uniques.indexOf(d),1),a.push(new _(`ALTER TABLE ${this.escapePath(r)} DROP INDEX \`${h.name}\``)),o.push(new _(`ALTER TABLE ${this.escapePath(r)} ADD UNIQUE INDEX \`${h.name}\` (\`${n.name}\`)`))}}await this.executeQueries(a,o),this.replaceCachedTable(r,i)}async changeColumns(e,t){for(const{oldColumn:n,newColumn:r}of t)await this.changeColumn(e,n,r)}async dropColumn(e,t){const n=B.isTable(e)?e:await this.getCachedTable(e),r=B.isTableColumn(t)?t:n.findColumnByName(t);if(!r)throw new x(`Column "${t}" was not found in table "${n.name}"`);const i=n.clone(),a=[],o=[];if(r.isPrimary){const h=i.columns.find(m=>m.isGenerated&&m.generationStrategy==="increment");if(h){const m=h.clone();m.isGenerated=!1,m.generationStrategy=void 0,a.push(new _(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${h.name}\` ${this.buildCreateColumnSql(m,!0)}`)),o.push(new _(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${m.name}\` ${this.buildCreateColumnSql(h,!0)}`))}const d=i.primaryColumns.map(m=>`\`${m.name}\``).join(", ");a.push(new _(`ALTER TABLE ${this.escapePath(i)} DROP PRIMARY KEY`)),o.push(new _(`ALTER TABLE ${this.escapePath(i)} ADD PRIMARY KEY (${d})`));const p=i.findColumnByName(r.name);if(p.isPrimary=!1,i.primaryColumns.length>0){const m=i.primaryColumns.map(w=>`\`${w.name}\``).join(", ");a.push(new _(`ALTER TABLE ${this.escapePath(i)} ADD PRIMARY KEY (${m})`)),o.push(new _(`ALTER TABLE ${this.escapePath(i)} DROP PRIMARY KEY`))}if(h&&h.name!==r.name){const m=h.clone();m.isGenerated=!1,m.generationStrategy=void 0,a.push(new _(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${m.name}\` ${this.buildCreateColumnSql(h,!0)}`)),o.push(new _(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${h.name}\` ${this.buildCreateColumnSql(m,!0)}`))}}const l=i.indices.find(h=>h.columnNames.length===1&&h.columnNames[0]===r.name);if(l)i.indices.splice(i.indices.indexOf(l),1),a.push(this.dropIndexSql(n,l)),o.push(this.createIndexSql(n,l));else if(r.isUnique){const h=this.connection.namingStrategy.uniqueConstraintName(n,[r.name]),d=i.uniques.find(w=>w.name===h);d&&i.uniques.splice(i.uniques.indexOf(d),1);const p=this.connection.namingStrategy.indexName(n,[r.name]),m=i.indices.find(w=>w.name===p);m&&i.indices.splice(i.indices.indexOf(m),1),a.push(new _(`ALTER TABLE ${this.escapePath(n)} DROP INDEX \`${p}\``)),o.push(new _(`ALTER TABLE ${this.escapePath(n)} ADD UNIQUE INDEX \`${p}\` (\`${r.name}\`)`))}a.push(new _(`ALTER TABLE ${this.escapePath(n)} DROP COLUMN \`${r.name}\``)),o.push(new _(`ALTER TABLE ${this.escapePath(n)} ADD ${this.buildCreateColumnSql(r,!0)}`)),await this.executeQueries(a,o),i.removeColumn(r),this.replaceCachedTable(n,i)}async dropColumns(e,t){for(const n of[...t])await this.dropColumn(e,n)}async createPrimaryKey(e,t){const n=B.isTable(e)?e:await this.getCachedTable(e),r=n.clone(),i=this.createPrimaryKeySql(n,t),a=this.dropPrimaryKeySql(n);await this.executeQueries(i,a),r.columns.forEach(o=>{t.find(l=>l===o.name)&&(o.isPrimary=!0)}),this.replaceCachedTable(n,r)}async updatePrimaryKeys(e,t){const n=B.isTable(e)?e:await this.getCachedTable(e),r=n.clone(),i=t.map(m=>m.name),a=[],o=[],l=r.columns.find(m=>m.isGenerated&&m.generationStrategy==="increment");if(l){const m=l.clone();m.isGenerated=!1,m.generationStrategy=void 0,a.push(new _(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${l.name}\` ${this.buildCreateColumnSql(m,!0)}`)),o.push(new _(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${m.name}\` ${this.buildCreateColumnSql(l,!0)}`))}const h=r.primaryColumns;if(h.length>0){const m=h.map(w=>`\`${w.name}\``).join(", ");a.push(new _(`ALTER TABLE ${this.escapePath(n)} DROP PRIMARY KEY`)),o.push(new _(`ALTER TABLE ${this.escapePath(n)} ADD PRIMARY KEY (${m})`))}r.columns.filter(m=>i.indexOf(m.name)!==-1).forEach(m=>m.isPrimary=!0);const d=i.map(m=>`\`${m}\``).join(", ");a.push(new _(`ALTER TABLE ${this.escapePath(n)} ADD PRIMARY KEY (${d})`)),o.push(new _(`ALTER TABLE ${this.escapePath(n)} DROP PRIMARY KEY`));const p=l||t.find(m=>m.isGenerated&&m.generationStrategy==="increment");if(p){const m=p.clone();m.isGenerated=!1,m.generationStrategy=void 0,a.push(new _(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${m.name}\` ${this.buildCreateColumnSql(p,!0)}`)),o.push(new _(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${p.name}\` ${this.buildCreateColumnSql(m,!0)}`));const w=r.columns.find(b=>b.name===p.name);w.isGenerated=!0,w.generationStrategy="increment"}await this.executeQueries(a,o),this.replaceCachedTable(n,r)}async dropPrimaryKey(e){const t=B.isTable(e)?e:await this.getCachedTable(e),n=this.dropPrimaryKeySql(t),r=this.createPrimaryKeySql(t,t.primaryColumns.map(i=>i.name));await this.executeQueries(n,r),t.primaryColumns.forEach(i=>{i.isPrimary=!1})}async createUniqueConstraint(e,t){throw new x("MySql does not support unique constraints. Use unique index instead.")}async createUniqueConstraints(e,t){throw new x("MySql does not support unique constraints. Use unique index instead.")}async dropUniqueConstraint(e,t){throw new x("MySql does not support unique constraints. Use unique index instead.")}async dropUniqueConstraints(e,t){throw new x("MySql does not support unique constraints. Use unique index instead.")}async createCheckConstraint(e,t){throw new x("MySql does not support check constraints.")}async createCheckConstraints(e,t){throw new x("MySql does not support check constraints.")}async dropCheckConstraint(e,t){throw new x("MySql does not support check constraints.")}async dropCheckConstraints(e,t){throw new x("MySql does not support check constraints.")}async createExclusionConstraint(e,t){throw new x("MySql does not support exclusion constraints.")}async createExclusionConstraints(e,t){throw new x("MySql does not support exclusion constraints.")}async dropExclusionConstraint(e,t){throw new x("MySql does not support exclusion constraints.")}async dropExclusionConstraints(e,t){throw new x("MySql does not support exclusion constraints.")}async createForeignKey(e,t){const n=B.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.connection.namingStrategy.foreignKeyName(n,t.columnNames));const r=this.createForeignKeySql(n,t),i=this.dropForeignKeySql(n,t);await this.executeQueries(r,i),n.addForeignKey(t)}async createForeignKeys(e,t){const n=t.map(r=>this.createForeignKey(e,r));await Promise.all(n)}async dropForeignKey(e,t){const n=B.isTable(e)?e:await this.getCachedTable(e),r=B.isTableForeignKey(t)?t:n.foreignKeys.find(o=>o.name===t);if(!r)throw new x(`Supplied foreign key was not found in table ${n.name}`);const i=this.dropForeignKeySql(n,r),a=this.createForeignKeySql(n,r);await this.executeQueries(i,a),n.removeForeignKey(r)}async dropForeignKeys(e,t){const n=t.map(r=>this.dropForeignKey(e,r));await Promise.all(n)}async createIndex(e,t){const n=B.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.generateIndexName(n,t));const r=this.createIndexSql(n,t),i=this.dropIndexSql(n,t);await this.executeQueries(r,i),n.addIndex(t,!0)}async createIndices(e,t){const n=t.map(r=>this.createIndex(e,r));await Promise.all(n)}async dropIndex(e,t){const n=B.isTable(e)?e:await this.getCachedTable(e),r=B.isTableIndex(t)?t:n.indices.find(o=>o.name===t);if(!r)throw new x(`Supplied index ${t} was not found in table ${n.name}`);r.name||(r.name=this.generateIndexName(n,r));const i=this.dropIndexSql(n,r),a=this.createIndexSql(n,r);await this.executeQueries(i,a),n.removeIndex(r,!0)}async dropIndices(e,t){const n=t.map(r=>this.dropIndex(e,r));await Promise.all(n)}async clearTable(e){await this.query(`TRUNCATE TABLE ${this.escapePath(e)}`)}async clearDatabase(e){const t=e||this.driver.database;if(t){if(!await this.hasDatabase(t))return Promise.resolve()}else throw new x("Can not clear database. No database is specified");const n=this.isTransactionActive;n||await this.startTransaction();try{const r=`SELECT concat('DROP VIEW IF EXISTS \`', table_schema, '\`.\`', table_name, '\`') AS \`query\` FROM \`INFORMATION_SCHEMA\`.\`VIEWS\` WHERE \`TABLE_SCHEMA\` = '${t}'`,i=await this.query(r);await Promise.all(i.map(d=>this.query(d.query)));const a="SET FOREIGN_KEY_CHECKS = 0;",o=`SELECT concat('DROP TABLE IF EXISTS \`', table_schema, '\`.\`', table_name, '\`') AS \`query\` FROM \`INFORMATION_SCHEMA\`.\`TABLES\` WHERE \`TABLE_SCHEMA\` = '${t}'`,l="SET FOREIGN_KEY_CHECKS = 1;";await this.query(a);const h=await this.query(o);await Promise.all(h.map(d=>this.query(d.query))),await this.query(l),n||await this.commitTransaction()}catch(r){try{n||await this.rollbackTransaction()}catch{}throw r}}async loadViews(e){if(!await this.hasTable(this.getTypeormMetadataTableName()))return[];e||(e=[]);const n=await this.getCurrentDatabase(),r=e.map(o=>{let{database:l,tableName:h}=this.driver.parseTableName(o);return l||(l=n),`(\`t\`.\`schema\` = '${l}' AND \`t\`.\`name\` = '${h}')`}).join(" OR "),i=`SELECT \`t\`.*, \`v\`.\`check_option\` FROM ${this.escapePath(this.getTypeormMetadataTableName())} \`t\` INNER JOIN \`information_schema\`.\`views\` \`v\` ON \`v\`.\`table_schema\` = \`t\`.\`schema\` AND \`v\`.\`table_name\` = \`t\`.\`name\` WHERE \`t\`.\`type\` = '${Se.VIEW}' ${r?`AND (${r})`:""}`;return(await this.query(i)).map(o=>{const l=new Ur,h=o.schema===n?void 0:o.schema;return l.database=o.schema,l.name=this.driver.buildTableName(o.name,void 0,h),l.expression=o.value,l})}async loadTables(e){if(e&&e.length===0)return[];const t=[],n=await this.getCurrentDatabase();if(!e)t.push(...await this.query("SELECT TABLE_NAME, TABLE_SCHEMA FROM `INFORMATION_SCHEMA`.`TABLES`"));else{const q="SELECT TABLE_NAME, TABLE_SCHEMA FROM `INFORMATION_SCHEMA`.`TABLES` WHERE "+e.map(O=>{let[J,ne]=O.split(".");return ne||(ne=J,J=this.driver.database||n),`(\`TABLE_SCHEMA\` = '${J}' AND \`TABLE_NAME\` = '${ne}')`}).join(" OR ");t.push(...await this.query(q))}if(t.length===0)return[];const r=t.map(({TABLE_NAME:$,TABLE_SCHEMA:q})=>`(\`TABLE_SCHEMA\` = '${q}' AND \`TABLE_NAME\` = '${$}')`).join(" OR "),i="SELECT * FROM `INFORMATION_SCHEMA`.`COLUMNS` WHERE "+r,a=`SELECT * FROM \`INFORMATION_SCHEMA\`.\`KEY_COLUMN_USAGE\` WHERE \`CONSTRAINT_NAME\` = 'PRIMARY' AND (${r})`,o="SELECT `SCHEMA_NAME`, `DEFAULT_CHARACTER_SET_NAME` as `CHARSET`, `DEFAULT_COLLATION_NAME` AS `COLLATION` FROM `INFORMATION_SCHEMA`.`SCHEMATA`",h=`SELECT \`s\`.* FROM \`INFORMATION_SCHEMA\`.\`STATISTICS\` \`s\` LEFT JOIN \`INFORMATION_SCHEMA\`.\`REFERENTIAL_CONSTRAINTS\` \`rc\` ON \`s\`.\`INDEX_NAME\` = \`rc\`.\`CONSTRAINT_NAME\` WHERE (${t.map(({TABLE_NAME:$,TABLE_SCHEMA:q})=>`(\`s\`.\`TABLE_SCHEMA\` = '${q}' AND \`s\`.\`TABLE_NAME\` = '${$}')`).join(" OR ")}) AND \`s\`.\`INDEX_NAME\` != 'PRIMARY' AND \`rc\`.\`CONSTRAINT_NAME\` IS NULL`,p="SELECT `kcu`.`TABLE_SCHEMA`, `kcu`.`TABLE_NAME`, `kcu`.`CONSTRAINT_NAME`, `kcu`.`COLUMN_NAME`, `kcu`.`REFERENCED_TABLE_SCHEMA`, `kcu`.`REFERENCED_TABLE_NAME`, `kcu`.`REFERENCED_COLUMN_NAME`, `rc`.`DELETE_RULE` `ON_DELETE`, `rc`.`UPDATE_RULE` `ON_UPDATE` FROM `INFORMATION_SCHEMA`.`KEY_COLUMN_USAGE` `kcu` INNER JOIN `INFORMATION_SCHEMA`.`REFERENTIAL_CONSTRAINTS` `rc` ON `rc`.`constraint_name` = `kcu`.`constraint_name` WHERE "+t.map(({TABLE_NAME:$,TABLE_SCHEMA:q})=>`(\`kcu\`.\`TABLE_SCHEMA\` = '${q}' AND \`kcu\`.\`TABLE_NAME\` = '${$}')`).join(" OR "),[m,w,b,S,R]=await Promise.all([this.query(i),this.query(a),this.query(o),this.query(h),this.query(p)]);return t.map($=>{const q=new gt,O=b.find(V=>V.SCHEMA_NAME===$.TABLE_SCHEMA),J=O.COLLATION,ne=O.CHARSET,ge=$.TABLE_SCHEMA===n?void 0:$.TABLE_SCHEMA;q.database=$.TABLE_SCHEMA,q.name=this.driver.buildTableName($.TABLE_NAME,void 0,ge),q.columns=m.filter(V=>V.TABLE_NAME===$.TABLE_NAME&&V.TABLE_SCHEMA===$.TABLE_SCHEMA).map(V=>{const Ae=S.filter(ce=>ce.TABLE_NAME===$.TABLE_NAME&&ce.TABLE_SCHEMA===$.TABLE_SCHEMA&&ce.COLUMN_NAME===V.COLUMN_NAME&&parseInt(ce.NON_UNIQUE,10)===0),D=this.connection.entityMetadatas.find(ce=>this.getTablePath(q)===this.getTablePath(ce)),ae=Ae.length>0&&D&&D.indices.some(ce=>Ae.some(fe=>ce.name===fe.INDEX_NAME&&ce.synchronize===!1)),Q=Ae.every(ce=>S.some(fe=>fe.INDEX_NAME===ce.INDEX_NAME&&fe.COLUMN_NAME!==V.COLUMN_NAME)),te=new ln;if(te.name=V.COLUMN_NAME,te.type=V.DATA_TYPE.toLowerCase(),te.zerofill=V.COLUMN_TYPE.includes("zerofill"),te.unsigned=te.zerofill||V.COLUMN_TYPE.includes("unsigned"),this.driver.unsignedColumnTypes.includes(te.type)){const ce=V.COLUMN_TYPE.substring(V.COLUMN_TYPE.indexOf("(")+1,V.COLUMN_TYPE.indexOf(")"));te.width=ce&&!this.isDefaultColumnWidth(q,te,parseInt(ce))?parseInt(ce):void 0}if(V.COLUMN_DEFAULT===null||V.COLUMN_DEFAULT===void 0?te.default=void 0:te.default=V.COLUMN_DEFAULT==="CURRENT_TIMESTAMP"?V.COLUMN_DEFAULT:`'${V.COLUMN_DEFAULT}'`,V.EXTRA.indexOf("on update")!==-1&&(te.onUpdate=V.EXTRA.substring(V.EXTRA.indexOf("on update")+10)),V.GENERATION_EXPRESSION&&(te.asExpression=V.GENERATION_EXPRESSION,te.generatedType=V.EXTRA.indexOf("VIRTUAL")!==-1?"VIRTUAL":"STORED"),te.isUnique=Ae.length>0&&!ae&&!Q,te.isNullable=V.IS_NULLABLE==="YES",te.isPrimary=w.some(ce=>ce.TABLE_NAME===V.TABLE_NAME&&ce.TABLE_SCHEMA===V.TABLE_SCHEMA&&ce.COLUMN_NAME===V.COLUMN_NAME),te.zerofill=V.COLUMN_TYPE.indexOf("zerofill")!==-1,te.isGenerated=V.EXTRA.indexOf("auto_increment")!==-1,te.isGenerated&&(te.generationStrategy="increment"),te.comment=typeof V.COLUMN_COMMENT=="string"&&V.COLUMN_COMMENT.length===0?void 0:V.COLUMN_COMMENT,V.CHARACTER_SET_NAME&&(te.charset=V.CHARACTER_SET_NAME===ne?void 0:V.CHARACTER_SET_NAME),V.COLLATION_NAME&&(te.collation=V.COLLATION_NAME===J?void 0:V.COLLATION_NAME),this.driver.withLengthColumnTypes.indexOf(te.type)!==-1&&V.CHARACTER_MAXIMUM_LENGTH){const ce=V.CHARACTER_MAXIMUM_LENGTH.toString();te.length=this.isDefaultColumnLength(q,te,ce)?"":ce}if((te.type==="decimal"||te.type==="double"||te.type==="float")&&(V.NUMERIC_PRECISION!==null&&!this.isDefaultColumnPrecision(q,te,V.NUMERIC_PRECISION)&&(te.precision=parseInt(V.NUMERIC_PRECISION)),V.NUMERIC_SCALE!==null&&!this.isDefaultColumnScale(q,te,V.NUMERIC_SCALE)&&(te.scale=parseInt(V.NUMERIC_SCALE))),te.type==="enum"||te.type==="simple-enum"||te.type==="set"){const ce=V.COLUMN_TYPE,fe=ce.substring(ce.indexOf("(")+1,ce.lastIndexOf(")")).split(",");te.enum=fe.map(oe=>oe.substring(1,oe.length-1)),te.length=""}return(te.type==="datetime"||te.type==="time"||te.type==="timestamp")&&V.DATETIME_PRECISION!==null&&V.DATETIME_PRECISION!==void 0&&!this.isDefaultColumnPrecision(q,te,parseInt(V.DATETIME_PRECISION))&&(te.precision=parseInt(V.DATETIME_PRECISION)),te});const pe=re.uniq(R.filter(V=>V.TABLE_NAME===$.TABLE_NAME&&V.TABLE_SCHEMA===$.TABLE_SCHEMA),V=>V.CONSTRAINT_NAME);q.foreignKeys=pe.map(V=>{const Ae=R.filter(Q=>Q.CONSTRAINT_NAME===V.CONSTRAINT_NAME),D=V.REFERENCED_TABLE_SCHEMA===n?void 0:V.REFERENCED_TABLE_SCHEMA,ae=this.driver.buildTableName(V.REFERENCED_TABLE_NAME,void 0,D);return new Dn({name:V.CONSTRAINT_NAME,columnNames:Ae.map(Q=>Q.COLUMN_NAME),referencedDatabase:V.REFERENCED_TABLE_SCHEMA,referencedTableName:ae,referencedColumnNames:Ae.map(Q=>Q.REFERENCED_COLUMN_NAME),onDelete:V.ON_DELETE,onUpdate:V.ON_UPDATE})});const me=re.uniq(S.filter(V=>V.TABLE_NAME===$.TABLE_NAME&&V.TABLE_SCHEMA===$.TABLE_SCHEMA),V=>V.INDEX_NAME);return q.indices=me.map(V=>{const Ae=S.filter(ae=>ae.TABLE_SCHEMA===V.TABLE_SCHEMA&&ae.TABLE_NAME===V.TABLE_NAME&&ae.INDEX_NAME===V.INDEX_NAME),D=parseInt(V.NON_UNIQUE,10);return new Ct({table:q,name:V.INDEX_NAME,columnNames:Ae.map(ae=>ae.COLUMN_NAME),isUnique:D===0,isSpatial:V.INDEX_TYPE==="SPATIAL",isFulltext:V.INDEX_TYPE==="FULLTEXT"})}),q})}createTableSql(e,t){const n=e.columns.map(i=>this.buildCreateColumnSql(i,!0)).join(", ");let r=`CREATE TABLE ${this.escapePath(e)} (${n}`;if(e.columns.filter(i=>i.isUnique).forEach(i=>{const a=e.indices.some(l=>l.columnNames.length===1&&!!l.isUnique&&l.columnNames.indexOf(i.name)!==-1),o=e.uniques.some(l=>l.columnNames.length===1&&l.columnNames.indexOf(i.name)!==-1);!a&&!o&&e.indices.push(new Ct({name:this.connection.namingStrategy.uniqueConstraintName(e,[i.name]),columnNames:[i.name],isUnique:!0}))}),e.uniques.length>0&&e.uniques.forEach(i=>{e.indices.some(o=>o.name===i.name)||e.indices.push(new Ct({name:i.name,columnNames:i.columnNames,isUnique:!0}))}),e.indices.length>0){const i=e.indices.map(a=>{const o=a.columnNames.map(h=>`\`${h}\``).join(", ");a.name||(a.name=this.connection.namingStrategy.indexName(e,a.columnNames,a.where));let l="";return a.isUnique&&(l+="UNIQUE "),a.isSpatial&&(l+="SPATIAL "),a.isFulltext&&(l+="FULLTEXT "),`${l}INDEX \`${a.name}\` (${o})`}).join(", ");r+=`, ${i}`}if(e.foreignKeys.length>0&&t){const i=e.foreignKeys.map(a=>{const o=a.columnNames.map(d=>`\`${d}\``).join(", ");a.name||(a.name=this.connection.namingStrategy.foreignKeyName(e,a.columnNames));const l=a.referencedColumnNames.map(d=>`\`${d}\``).join(", ");let h=`CONSTRAINT \`${a.name}\` FOREIGN KEY (${o}) REFERENCES ${this.escapePath(this.getTablePath(a))} (${l})`;return a.onDelete&&(h+=` ON DELETE ${a.onDelete}`),a.onUpdate&&(h+=` ON UPDATE ${a.onUpdate}`),h}).join(", ");r+=`, ${i}`}if(e.primaryColumns.length>0){const i=e.primaryColumns.map(a=>`\`${a.name}\``).join(", ");r+=`, PRIMARY KEY (${i})`}return r+=`) ENGINE=${e.engine||"InnoDB"}`,new _(r)}dropTableSql(e){return new _(`DROP TABLE ${this.escapePath(e)}`)}createViewSql(e){return typeof e.expression=="string"?new _(`CREATE VIEW ${this.escapePath(e)} AS ${e.expression}`):new _(`CREATE VIEW ${this.escapePath(e)} AS ${e.expression(this.connection).getQuery()}`)}async insertViewDefinitionSql(e){const t=await this.getCurrentDatabase(),n=typeof e.expression=="string"?e.expression.trim():e.expression(this.connection).getQuery();return this.insertTypeormMetadataSql({type:Se.VIEW,schema:t,name:e.name,value:n})}dropViewSql(e){return new _(`DROP VIEW ${this.escapePath(e)}`)}async deleteViewDefinitionSql(e){const t=await this.getCurrentDatabase(),n=B.isView(e)?e.name:e;return this.deleteTypeormMetadataSql({type:Se.VIEW,schema:t,name:n})}createIndexSql(e,t){const n=t.columnNames.map(i=>`\`${i}\``).join(", ");let r="";return t.isUnique&&(r+="UNIQUE "),t.isSpatial&&(r+="SPATIAL "),t.isFulltext&&(r+="FULLTEXT "),new _(`CREATE ${r}INDEX \`${t.name}\` ON ${this.escapePath(e)} (${n})`)}dropIndexSql(e,t){const n=B.isTableIndex(t)?t.name:t;return new _(`DROP INDEX \`${n}\` ON ${this.escapePath(e)}`)}createPrimaryKeySql(e,t){const n=t.map(r=>`\`${r}\``).join(", ");return new _(`ALTER TABLE ${this.escapePath(e)} ADD PRIMARY KEY (${n})`)}dropPrimaryKeySql(e){return new _(`ALTER TABLE ${this.escapePath(e)} DROP PRIMARY KEY`)}createForeignKeySql(e,t){const n=t.columnNames.map(a=>`\`${a}\``).join(", "),r=t.referencedColumnNames.map(a=>`\`${a}\``).join(",");let i=`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT \`${t.name}\` FOREIGN KEY (${n}) REFERENCES ${this.escapePath(this.getTablePath(t))}(${r})`;return t.onDelete&&(i+=` ON DELETE ${t.onDelete}`),t.onUpdate&&(i+=` ON UPDATE ${t.onUpdate}`),new _(i)}dropForeignKeySql(e,t){const n=B.isTableForeignKey(t)?t.name:t;return new _(`ALTER TABLE ${this.escapePath(e)} DROP FOREIGN KEY \`${n}\``)}escapeComment(e){return!e||e.length===0?"''":(e=e.replace(/\\/g,"\\\\").replace(/'/g,"''").replace(/\u0000/g,""),`'${e}'`)}escapePath(e){const{database:t,tableName:n}=this.driver.parseTableName(e);return t&&t!==this.driver.database?`\`${t}\`.\`${n}\``:`\`${n}\``}buildCreateColumnSql(e,t,n=!1){let r="";return n?r=this.connection.driver.createFullType(e):r=`\`${e.name}\` ${this.connection.driver.createFullType(e)}`,e.asExpression&&(r+=` AS (${e.asExpression}) ${e.generatedType?e.generatedType:"VIRTUAL"}`),e.zerofill?r+=" ZEROFILL":e.unsigned&&(r+=" UNSIGNED"),e.enum&&(r+=` (${e.enum.map(i=>"'"+i+"'").join(", ")})`),e.charset&&(r+=` CHARACTER SET "${e.charset}"`),e.collation&&(r+=` COLLATE "${e.collation}"`),e.isNullable||(r+=" NOT NULL"),e.isNullable&&(r+=" NULL"),e.isPrimary&&!t&&(r+=" PRIMARY KEY"),e.isGenerated&&e.generationStrategy==="increment"&&(r+=" AUTO_INCREMENT"),e.comment&&(r+=` COMMENT ${this.escapeComment(e.comment)}`),e.default!==void 0&&e.default!==null&&(r+=` DEFAULT ${e.default}`),e.onUpdate&&(r+=` ON UPDATE ${e.onUpdate}`),r}isDefaultColumnWidth(e,t,n){if(this.connection.hasMetadata(e.name)){const a=this.connection.getMetadata(e.name).findColumnWithDatabaseName(t.name);if(a&&a.width)return!1}const r=this.connection.driver.dataTypeDefaults&&this.connection.driver.dataTypeDefaults[t.type]&&this.connection.driver.dataTypeDefaults[t.type].width;if(r){const a=["int","tinyint","smallint","mediumint"].indexOf(t.type)!==-1;return t.unsigned&&a?r-1===n:r===n}return!1}changeTableComment(e,t){throw new x("aurora-mysql driver does not support change table comment.")}}class zx{constructor(e){this.isReplicated=!1,this.treeSupport=!0,this.transactionSupport="nested",this.supportedDataTypes=["bit","int","integer","tinyint","smallint","mediumint","bigint","float","double","double precision","real","decimal","dec","numeric","fixed","bool","boolean","date","datetime","timestamp","time","year","char","nchar","national char","varchar","nvarchar","national varchar","blob","text","tinyblob","tinytext","mediumblob","mediumtext","longblob","longtext","enum","set","binary","varbinary","json","geometry","point","linestring","polygon","multipoint","multilinestring","multipolygon","geometrycollection"],this.supportedUpsertTypes=["on-duplicate-key-update"],this.spatialTypes=["geometry","point","linestring","polygon","multipoint","multilinestring","multipolygon","geometrycollection"],this.withLengthColumnTypes=["char","varchar","nvarchar","binary","varbinary"],this.unsignedColumnTypes=["tinyint","smallint","mediumint","int","integer","bigint"],this.withPrecisionColumnTypes=["decimal","dec","numeric","fixed","float","double","double precision","real","time","datetime","timestamp"],this.withScaleColumnTypes=["decimal","dec","numeric","fixed","float","double","double precision","real"],this.mappedDataTypes={createDate:"datetime",createDatePrecision:6,createDateDefault:"CURRENT_TIMESTAMP(6)",updateDate:"datetime",updateDatePrecision:6,updateDateDefault:"CURRENT_TIMESTAMP(6)",deleteDate:"datetime",deleteDatePrecision:6,deleteDateNullable:!0,version:"int",treeLevel:"int",migrationId:"int",migrationName:"varchar",migrationTimestamp:"bigint",cacheId:"int",cacheIdentifier:"varchar",cacheTime:"bigint",cacheDuration:"int",cacheQuery:"text",cacheResult:"text",metadataType:"varchar",metadataDatabase:"varchar",metadataSchema:"varchar",metadataTable:"varchar",metadataName:"varchar",metadataValue:"text"},this.dataTypeDefaults={varchar:{length:255},nvarchar:{length:255},"national varchar":{length:255},char:{length:1},binary:{length:1},varbinary:{length:255},decimal:{precision:10,scale:0},dec:{precision:10,scale:0},numeric:{precision:10,scale:0},fixed:{precision:10,scale:0},float:{precision:12},double:{precision:22},time:{precision:0},datetime:{precision:0},timestamp:{precision:0},bit:{width:1},int:{width:11},integer:{width:11},tinyint:{width:4},smallint:{width:6},mediumint:{width:9},bigint:{width:20}},this.maxAliasLength=63,this.cteCapabilities={enabled:!1},this.connection=e,this.options=e.options,this.loadDependencies(),this.client=new this.DataApiDriver(this.options.region,this.options.secretArn,this.options.resourceArn,this.options.database,(t,n)=>this.connection.logger.logQuery(t,n),this.options.serviceConfigOptions,this.options.formatOptions),this.database=ie.buildDriverOptions(this.options).database}async connect(){if(!this.database){const e=this.createQueryRunner("master");this.database=await e.getCurrentDatabase(),await e.release()}}afterConnect(){return Promise.resolve()}async disconnect(){}createSchemaBuilder(){return new tc(this.connection)}createQueryRunner(e){return new Gx(this,new this.DataApiDriver(this.options.region,this.options.secretArn,this.options.resourceArn,this.options.database,(t,n)=>this.connection.logger.logQuery(t,n),this.options.serviceConfigOptions,this.options.formatOptions))}escapeQueryWithParameters(e,t,n){const r=Object.keys(n).map(i=>n[i]);return!t||!Object.keys(t).length?[e,r]:(e=e.replace(/:(\.\.\.)?([A-Za-z0-9_.]+)/g,(i,a,o)=>{if(!t.hasOwnProperty(o))return i;const l=t[o];return a?l.map(h=>(r.push(h),this.createParameter(o,r.length-1))).join(", "):typeof l=="function"?l():(r.push(l),this.createParameter(o,r.length-1))}),[e,r])}escape(e){return"`"+e+"`"}buildTableName(e,t,n){const r=[e];return n&&r.unshift(n),r.join(".")}parseTableName(e){const t=this.database,n=void 0;if(B.isTable(e)||B.isView(e)){const i=this.parseTableName(e.name);return{database:e.database||i.database||t,schema:e.schema||i.schema||n,tableName:i.tableName}}if(B.isTableForeignKey(e)){const i=this.parseTableName(e.referencedTableName);return{database:e.referencedDatabase||i.database||t,schema:e.referencedSchema||i.schema||n,tableName:i.tableName}}if(B.isEntityMetadata(e))return{database:e.database||t,schema:e.schema||n,tableName:e.tableName};const r=e.split(".");return{database:(r.length>1?r[0]:void 0)||t,schema:n,tableName:r.length>1?r[1]:r[0]}}preparePersistentValue(e,t){return t.transformer&&(e=It.transformTo(t.transformer,e)),!this.options.formatOptions||this.options.formatOptions.castParameters!==!1?this.client.preparePersistentValue(e,t):e==null?e:t.type===Boolean?e===!0?1:0:t.type==="date"?be.mixedDateToDateString(e):t.type==="time"?be.mixedDateToTimeString(e):t.type==="json"?JSON.stringify(e):t.type==="timestamp"||t.type==="datetime"||t.type===Date?be.mixedDateToDate(e):t.type==="simple-array"||t.type==="set"?be.simpleArrayToString(e):t.type==="simple-json"?be.simpleJsonToString(e):t.type==="enum"||t.type==="simple-enum"?""+e:e}prepareHydratedValue(e,t){return e==null?t.transformer?It.transformFrom(t.transformer,e):e:!this.options.formatOptions||this.options.formatOptions.castParameters!==!1?this.client.prepareHydratedValue(e,t):(t.type===Boolean||t.type==="bool"||t.type==="boolean"?e=!!e:t.type==="datetime"||t.type===Date?e=be.normalizeHydratedDate(e):t.type==="date"?e=be.mixedDateToDateString(e):t.type==="json"?e=typeof e=="string"?JSON.parse(e):e:t.type==="time"?e=be.mixedTimeToString(e):t.type==="simple-array"||t.type==="set"?e=be.stringToSimpleArray(e):t.type==="simple-json"?e=be.stringToSimpleJson(e):(t.type==="enum"||t.type==="simple-enum")&&t.enum&&!isNaN(e)&&t.enum.indexOf(parseInt(e))>=0?e=parseInt(e):t.type===Number&&(e=isNaN(+e)?e:parseInt(e)),t.transformer&&(e=It.transformFrom(t.transformer,e)),e)}normalizeType(e){return e.type===Number||e.type==="integer"?"int":e.type===String?"varchar":e.type===Date?"datetime":e.type===Buffer?"blob":e.type===Boolean?"tinyint":e.type==="uuid"?"varchar":e.type==="simple-array"||e.type==="simple-json"?"text":e.type==="simple-enum"?"enum":e.type==="double precision"||e.type==="real"?"double":e.type==="dec"||e.type==="numeric"||e.type==="fixed"?"decimal":e.type==="bool"||e.type==="boolean"?"tinyint":e.type==="nvarchar"||e.type==="national varchar"?"varchar":e.type==="nchar"||e.type==="national char"?"char":e.type||""}normalizeDefault(e){const t=e.default;if(t!==null){if((e.type==="enum"||e.type==="simple-enum")&&t!==void 0)return`'${t}'`;if(e.type==="set"&&t!==void 0)return`'${be.simpleArrayToString(t)}'`;if(typeof t=="number")return`${t}`;if(typeof t=="boolean")return t?"1":"0";if(typeof t=="function")return t();if(typeof t=="string")return`'${t}'`;if(t!==void 0)return`${t}`}}normalizeIsUnique(e){return e.entityMetadata.indices.some(t=>t.isUnique&&t.columns.length===1&&t.columns[0]===e)}getColumnLength(e){if(e.length)return e.length.toString();if(e.generationStrategy==="uuid")return"36";switch(e.type){case String:case"varchar":case"nvarchar":case"national varchar":return"255";case"varbinary":return"255";default:return""}}createFullType(e){let t=e.type;return this.getColumnLength(e)?t+=`(${this.getColumnLength(e)})`:e.width?t+=`(${e.width})`:e.precision!==null&&e.precision!==void 0&&e.scale!==null&&e.scale!==void 0?t+=`(${e.precision},${e.scale})`:e.precision!==null&&e.precision!==void 0&&(t+=`(${e.precision})`),e.isArray&&(t+=" array"),t}obtainMasterConnection(){return new Promise((e,t)=>{this.poolCluster?this.poolCluster.getConnection("MASTER",(n,r)=>{n?t(n):e(this.prepareDbConnection(r))}):this.pool?this.pool.getConnection((n,r)=>{n?t(n):e(this.prepareDbConnection(r))}):t(new x("Connection is not established with mysql database"))})}obtainSlaveConnection(){return this.poolCluster?new Promise((e,t)=>{this.poolCluster.getConnection("SLAVE*",(n,r)=>{n?t(n):e(this.prepareDbConnection(r))})}):this.obtainMasterConnection()}createGeneratedMap(e,t,n){const r=e.generatedColumns.reduce((i,a)=>{let o;return a.generationStrategy==="increment"&&t.insertId&&(o=t.insertId+n),re.mergeDeep(i,a.createValueMap(o))},{});return Object.keys(r).length>0?r:void 0}findChangedColumns(e,t){return t.filter(n=>{const r=e.find(a=>a.name===n.databaseName);if(!r)return!1;let i=n.length;return!i&&n.generationStrategy==="uuid"&&(i=this.getColumnLength(n)),r.name!==n.databaseName||r.type!==this.normalizeType(n)||r.length!==i||r.width!==n.width||r.precision!==n.precision||r.scale!==n.scale||r.zerofill!==n.zerofill||r.unsigned!==n.unsigned||r.asExpression!==n.asExpression||r.generatedType!==n.generatedType||r.comment!==this.escapeComment(n.comment)||!this.compareDefaultValues(this.normalizeDefault(n),r.default)||r.enum&&n.enum&&!re.isArraysEqual(r.enum,n.enum.map(a=>a+""))||r.onUpdate!==n.onUpdate||r.isPrimary!==n.isPrimary||r.isNullable!==n.isNullable||r.isUnique!==this.normalizeIsUnique(n)||n.generationStrategy!=="uuid"&&r.isGenerated!==n.isGenerated})}isReturningSqlSupported(){return!1}isUUIDGenerationSupported(){return!1}isFullTextColumnTypeSupported(){return!0}createParameter(e,t){return"?"}loadDependencies(){const e=this.options.driver||Xe.load("typeorm-aurora-data-api-driver");this.DataApiDriver=e,this.DataApiDriver=this.DataApiDriver.default||this.DataApiDriver}createConnectionOptions(e,t){return t=Object.assign({},t,ie.buildDriverOptions(t)),Object.assign({},{resourceArn:e.resourceArn,secretArn:e.secretArn,database:e.database,region:e.region,type:e.type},{host:t.host,user:t.username,password:t.password,database:t.database,port:t.port,ssl:e.ssl},e.extra||{})}async createPool(e){return{}}prepareDbConnection(e){const{logger:t}=this.connection;return e.listeners("error").length===0&&e.on("error",n=>t.log("warn",`MySQL connection raised an error. ${n}`)),e}compareDefaultValues(e,t){return typeof e=="string"&&typeof t=="string"&&(e=e.replace(/^'+|'+$/g,""),t=t.replace(/^'+|'+$/g,"")),e===t}escapeComment(e){return e&&(e=e.replace(/\u0000/g,""),e)}}class Kx extends nc{constructor(e,t){super(),this.driver=e,this.connection=e.connection,this.mode=t,this.broadcaster=new mr(this)}connect(){return this.databaseConnection?Promise.resolve(this.databaseConnection):this.databaseConnectionPromise?this.databaseConnectionPromise:(this.mode==="slave"&&this.driver.isReplicated?this.databaseConnectionPromise=this.driver.obtainSlaveConnection().then(([e,t])=>{this.driver.connectedQueryRunners.push(this),this.databaseConnection=e;const n=r=>this.releasePostgresConnection(r);return this.releaseCallback=r=>{this.databaseConnection.removeListener("error",n),t(r)},this.databaseConnection.on("error",n),this.databaseConnection}):this.databaseConnectionPromise=this.driver.obtainMasterConnection().then(([e,t])=>{this.driver.connectedQueryRunners.push(this),this.databaseConnection=e;const n=r=>this.releasePostgresConnection(r);return this.releaseCallback=r=>{this.databaseConnection.removeListener("error",n),t(r)},this.databaseConnection.on("error",n),this.databaseConnection}),this.databaseConnectionPromise)}async releasePostgresConnection(e){if(this.isReleased)return;this.isReleased=!0,this.releaseCallback&&(this.releaseCallback(e),this.releaseCallback=void 0);const t=this.driver.connectedQueryRunners.indexOf(this);t!==-1&&this.driver.connectedQueryRunners.splice(t,1)}release(){return this.releasePostgresConnection()}async startTransaction(e){this.isTransactionActive=!0;try{await this.broadcaster.broadcast("BeforeTransactionStart")}catch(t){throw this.isTransactionActive=!1,t}this.transactionDepth===0?(await this.query("START TRANSACTION"),e&&await this.query("SET TRANSACTION ISOLATION LEVEL "+e)):await this.query(`SAVEPOINT typeorm_${this.transactionDepth}`),this.transactionDepth+=1,await this.broadcaster.broadcast("AfterTransactionStart")}async commitTransaction(){if(!this.isTransactionActive)throw new In;await this.broadcaster.broadcast("BeforeTransactionCommit"),this.transactionDepth>1?await this.query(`RELEASE SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.query("COMMIT"),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionCommit")}async rollbackTransaction(){if(!this.isTransactionActive)throw new In;await this.broadcaster.broadcast("BeforeTransactionRollback"),this.transactionDepth>1?await this.query(`ROLLBACK TO SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.query("ROLLBACK"),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionRollback")}async query(e,t,n=!1){if(this.isReleased)throw new zt;const r=await this.connect();this.driver.connection.logger.logQuery(e,t,this),await this.broadcaster.broadcast("BeforeQuery",e,t);const i=new $n;try{const a=Date.now(),o=await r.query(e,t),l=this.driver.options.maxQueryExecutionTime,d=Date.now()-a;this.broadcaster.broadcastAfterQueryEvent(i,e,t,!0,d,o,void 0),l&&d>l&&this.driver.connection.logger.logQuerySlow(d,e,t,this);const p=new tr;if(o){switch(o.hasOwnProperty("rows")&&(p.records=o.rows),o.hasOwnProperty("rowCount")&&(p.affected=o.rowCount),o.command){case"DELETE":case"UPDATE":p.raw=[o.rows,o.rowCount];break;default:p.raw=o.rows}if(!n)return p.raw}return p}catch(a){throw this.driver.connection.logger.logQueryError(a,e,t,this),this.broadcaster.broadcastAfterQueryEvent(i,e,t,!1,void 0,void 0,a),new Kn(e,t,a)}finally{await i.wait()}}async stream(e,t,n,r){const i=this.driver.loadStreamDependency();if(this.isReleased)throw new zt;const a=await this.connect();this.driver.connection.logger.logQuery(e,t,this);const o=a.query(new i(e,t));return n&&o.on("end",n),r&&o.on("error",r),o}async getDatabases(){return Promise.resolve([])}async getSchemas(e){return Promise.resolve([])}async hasDatabase(e){return!!(await this.query(`SELECT * FROM pg_database WHERE datname='${e}';`)).length}async getCurrentDatabase(){return(await this.query("SELECT * FROM current_database()"))[0].current_database}async hasSchema(e){return!!(await this.query(`SELECT * FROM "information_schema"."schemata" WHERE "schema_name" = '${e}'`)).length}async getCurrentSchema(){return(await this.query("SELECT * FROM current_schema()"))[0].current_schema}async hasTable(e){const t=this.driver.parseTableName(e);t.schema||(t.schema=await this.getCurrentSchema());const n=`SELECT * FROM "information_schema"."tables" WHERE "table_schema" = '${t.schema}' AND "table_name" = '${t.tableName}'`;return!!(await this.query(n)).length}async hasColumn(e,t){const n=this.driver.parseTableName(e);n.schema||(n.schema=await this.getCurrentSchema());const r=`SELECT * FROM "information_schema"."columns" WHERE "table_schema" = '${n.schema}' AND "table_name" = '${n.tableName}' AND "column_name" = '${t}'`;return!!(await this.query(r)).length}async createDatabase(e,t){if(t&&await this.hasDatabase(e))return Promise.resolve();const n=`CREATE DATABASE "${e}"`,r=`DROP DATABASE "${e}"`;await this.executeQueries(new _(n),new _(r))}async dropDatabase(e,t){const n=t?`DROP DATABASE IF EXISTS "${e}"`:`DROP DATABASE "${e}"`,r=`CREATE DATABASE "${e}"`;await this.executeQueries(new _(n),new _(r))}async createSchema(e,t){const n=e.indexOf(".")===-1?e:e.split(".")[1],r=t?`CREATE SCHEMA IF NOT EXISTS "${n}"`:`CREATE SCHEMA "${n}"`,i=`DROP SCHEMA "${n}" CASCADE`;await this.executeQueries(new _(r),new _(i))}async dropSchema(e,t,n){const r=e.indexOf(".")===-1?e:e.split(".")[1],i=t?`DROP SCHEMA IF EXISTS "${r}" ${n?"CASCADE":""}`:`DROP SCHEMA "${r}" ${n?"CASCADE":""}`,a=`CREATE SCHEMA "${r}"`;await this.executeQueries(new _(i),new _(a))}async createTable(e,t=!1,n=!0,r=!0){if(t&&await this.hasTable(e))return Promise.resolve();const i=[],a=[],o=e.columns.filter(d=>d.type==="enum"||d.type==="simple-enum"),l=[];for(const d of o){const p=await this.hasEnumType(e,d),m=this.buildEnumName(e,d);!p&&l.indexOf(m)===-1&&(l.push(m),i.push(this.createEnumTypeSql(e,d,m)),a.push(this.dropEnumTypeSql(e,d,m)))}const h=e.columns.filter(d=>d.generatedType==="STORED"&&d.asExpression);for(const d of h){const p=(await this.getTableNameWithSchema(e.name)).split("."),m=p[1],w=p[0],b=this.insertTypeormMetadataSql({database:this.driver.database,schema:w,table:m,type:Se.GENERATED_COLUMN,name:d.name,value:d.asExpression}),S=this.deleteTypeormMetadataSql({database:this.driver.database,schema:w,table:m,type:Se.GENERATED_COLUMN,name:d.name});i.push(b),a.push(S)}i.push(this.createTableSql(e,n)),a.push(this.dropTableSql(e)),n&&e.foreignKeys.forEach(d=>a.push(this.dropForeignKeySql(e,d))),r&&e.indices.forEach(d=>{d.name||(d.name=this.connection.namingStrategy.indexName(e,d.columnNames,d.where)),i.push(this.createIndexSql(e,d)),a.push(this.dropIndexSql(e,d))}),e.comment&&(i.push(new _("COMMENT ON TABLE "+this.escapePath(e)+" IS '"+e.comment+"'")),a.push(new _("COMMENT ON TABLE "+this.escapePath(e)+" IS NULL"))),await this.executeQueries(i,a)}async dropTable(e,t,n=!0,r=!0){if(t&&!await this.hasTable(e))return Promise.resolve();const i=n,a=this.getTablePath(e),o=await this.getCachedTable(a),l=[],h=[];r&&o.indices.forEach(p=>{l.push(this.dropIndexSql(o,p)),h.push(this.createIndexSql(o,p))}),n&&o.foreignKeys.forEach(p=>l.push(this.dropForeignKeySql(o,p))),l.push(this.dropTableSql(o)),h.push(this.createTableSql(o,i));const d=o.columns.filter(p=>p.generatedType&&p.asExpression);for(const p of d){const m=(await this.getTableNameWithSchema(o.name)).split("."),w=m[1],b=m[0],S=this.deleteTypeormMetadataSql({database:this.driver.database,schema:b,table:w,type:Se.GENERATED_COLUMN,name:p.name}),R=this.insertTypeormMetadataSql({database:this.driver.database,schema:b,table:w,type:Se.GENERATED_COLUMN,name:p.name,value:p.asExpression});l.push(S),h.push(R)}await this.executeQueries(l,h)}async createView(e,t=!1){const n=[],r=[];n.push(this.createViewSql(e)),t&&n.push(await this.insertViewDefinitionSql(e)),r.push(this.dropViewSql(e)),t&&r.push(await this.deleteViewDefinitionSql(e)),await this.executeQueries(n,r)}async dropView(e){const t=B.isView(e)?e.name:e,n=await this.getCachedView(t),r=[],i=[];r.push(await this.deleteViewDefinitionSql(n)),r.push(this.dropViewSql(n)),i.push(await this.insertViewDefinitionSql(n)),i.push(this.createViewSql(n)),await this.executeQueries(r,i)}async renameTable(e,t){const n=[],r=[],i=B.isTable(e)?e:await this.getCachedTable(e),a=i.clone(),{schema:o,tableName:l}=this.driver.parseTableName(i);if(a.name=o?`${o}.${t}`:t,n.push(new _(`ALTER TABLE ${this.escapePath(i)} RENAME TO "${t}"`)),r.push(new _(`ALTER TABLE ${this.escapePath(a)} RENAME TO "${l}"`)),a.primaryColumns.length>0&&!a.primaryColumns[0].primaryKeyConstraintName){const d=a.primaryColumns.map(w=>w.name),p=this.connection.namingStrategy.primaryKeyName(i,d),m=this.connection.namingStrategy.primaryKeyName(a,d);n.push(new _(`ALTER TABLE ${this.escapePath(a)} RENAME CONSTRAINT "${p}" TO "${m}"`)),r.push(new _(`ALTER TABLE ${this.escapePath(a)} RENAME CONSTRAINT "${m}" TO "${p}"`))}a.columns.map(d=>{if(d.isGenerated&&d.generationStrategy==="increment"){const p=this.buildSequencePath(i,d.name),m=this.buildSequenceName(i,d.name),w=this.buildSequencePath(a,d.name),b=this.buildSequenceName(a,d.name),S=`ALTER SEQUENCE ${this.escapePath(p)} RENAME TO "${b}"`,R=`ALTER SEQUENCE ${this.escapePath(w)} RENAME TO "${m}"`;n.push(new _(S)),r.push(new _(R))}}),a.uniques.forEach(d=>{const p=this.connection.namingStrategy.uniqueConstraintName(i,d.columnNames);if(d.name!==p)return;const m=this.connection.namingStrategy.uniqueConstraintName(a,d.columnNames);n.push(new _(`ALTER TABLE ${this.escapePath(a)} RENAME CONSTRAINT "${d.name}" TO "${m}"`)),r.push(new _(`ALTER TABLE ${this.escapePath(a)} RENAME CONSTRAINT "${m}" TO "${d.name}"`)),d.name=m}),a.indices.forEach(d=>{const p=this.connection.namingStrategy.indexName(i,d.columnNames,d.where);if(d.name!==p)return;const{schema:m}=this.driver.parseTableName(a),w=this.connection.namingStrategy.indexName(a,d.columnNames,d.where),b=m?`ALTER INDEX "${m}"."${d.name}" RENAME TO "${w}"`:`ALTER INDEX "${d.name}" RENAME TO "${w}"`,S=m?`ALTER INDEX "${m}"."${w}" RENAME TO "${d.name}"`:`ALTER INDEX "${w}" RENAME TO "${d.name}"`;n.push(new _(b)),r.push(new _(S)),d.name=w}),a.foreignKeys.forEach(d=>{const p=this.connection.namingStrategy.foreignKeyName(i,d.columnNames,this.getTablePath(d),d.referencedColumnNames);if(d.name!==p)return;const m=this.connection.namingStrategy.foreignKeyName(a,d.columnNames,this.getTablePath(d),d.referencedColumnNames);n.push(new _(`ALTER TABLE ${this.escapePath(a)} RENAME CONSTRAINT "${d.name}" TO "${m}"`)),r.push(new _(`ALTER TABLE ${this.escapePath(a)} RENAME CONSTRAINT "${m}" TO "${d.name}"`)),d.name=m});const h=a.columns.filter(d=>d.type==="enum"||d.type==="simple-enum");for(const d of h){if(d.enumName)continue;const p=await this.getUserDefinedTypeName(i,d);n.push(new _(`ALTER TYPE "${p.schema}"."${p.name}" RENAME TO ${this.buildEnumName(a,d,!1)}`)),r.push(new _(`ALTER TYPE ${this.buildEnumName(a,d)} RENAME TO "${p.name}"`))}await this.executeQueries(n,r)}async addColumn(e,t){const n=B.isTable(e)?e:await this.getCachedTable(e),r=n.clone(),i=[],a=[];if((t.type==="enum"||t.type==="simple-enum")&&(await this.hasEnumType(n,t)||(i.push(this.createEnumTypeSql(n,t)),a.push(this.dropEnumTypeSql(n,t)))),i.push(new _(`ALTER TABLE ${this.escapePath(n)} ADD ${this.buildCreateColumnSql(n,t)}`)),a.push(new _(`ALTER TABLE ${this.escapePath(n)} DROP COLUMN "${t.name}"`)),t.isPrimary){const l=r.primaryColumns;if(l.length>0){const p=l[0].primaryKeyConstraintName?l[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(r,l.map(w=>w.name)),m=l.map(w=>`"${w.name}"`).join(", ");i.push(new _(`ALTER TABLE ${this.escapePath(n)} DROP CONSTRAINT "${p}"`)),a.push(new _(`ALTER TABLE ${this.escapePath(n)} ADD CONSTRAINT "${p}" PRIMARY KEY (${m})`))}l.push(t);const h=l[0].primaryKeyConstraintName?l[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(r,l.map(p=>p.name)),d=l.map(p=>`"${p.name}"`).join(", ");i.push(new _(`ALTER TABLE ${this.escapePath(n)} ADD CONSTRAINT "${h}" PRIMARY KEY (${d})`)),a.push(new _(`ALTER TABLE ${this.escapePath(n)} DROP CONSTRAINT "${h}"`))}const o=r.indices.find(l=>l.columnNames.length===1&&l.columnNames[0]===t.name);if(o&&(i.push(this.createIndexSql(n,o)),a.push(this.dropIndexSql(n,o))),t.isUnique){const l=new Gt({name:this.connection.namingStrategy.uniqueConstraintName(n,[t.name]),columnNames:[t.name]});r.uniques.push(l),i.push(new _(`ALTER TABLE ${this.escapePath(n)} ADD CONSTRAINT "${l.name}" UNIQUE ("${t.name}")`)),a.push(new _(`ALTER TABLE ${this.escapePath(n)} DROP CONSTRAINT "${l.name}"`))}if(t.generatedType==="STORED"&&t.asExpression){const l=(await this.getTableNameWithSchema(n.name)).split("."),h=l[1],d=l[0],p=this.insertTypeormMetadataSql({database:this.driver.database,schema:d,table:h,type:Se.GENERATED_COLUMN,name:t.name,value:t.asExpression}),m=this.deleteTypeormMetadataSql({database:this.driver.database,schema:d,table:h,type:Se.GENERATED_COLUMN,name:t.name});i.push(p),a.push(m)}t.comment&&(i.push(new _(`COMMENT ON COLUMN ${this.escapePath(n)}."${t.name}" IS ${this.escapeComment(t.comment)}`)),a.push(new _(`COMMENT ON COLUMN ${this.escapePath(n)}."${t.name}" IS ${this.escapeComment(t.comment)}`))),await this.executeQueries(i,a),r.addColumn(t),this.replaceCachedTable(n,r)}async addColumns(e,t){for(const n of t)await this.addColumn(e,n)}async renameColumn(e,t,n){const r=B.isTable(e)?e:await this.getCachedTable(e),i=B.isTableColumn(t)?t:r.columns.find(o=>o.name===t);if(!i)throw new x(`Column "${t}" was not found in the "${r.name}" table.`);let a;return B.isTableColumn(n)?a=n:(a=i.clone(),a.name=n),this.changeColumn(r,i,a)}async changeColumn(e,t,n){const r=B.isTable(e)?e:await this.getCachedTable(e);let i=r.clone();const a=[],o=[];let l=!1;const h=B.isTableColumn(t)?t:r.columns.find(d=>d.name===t);if(!h)throw new x(`Column "${t}" was not found in the "${r.name}" table.`);if(h.type!==n.type||h.length!==n.length||n.isArray!==h.isArray||!h.generatedType&&n.generatedType==="STORED"||h.asExpression!==n.asExpression&&n.generatedType==="STORED")await this.dropColumn(r,h),await this.addColumn(r,n),i=r.clone();else{if(h.name!==n.name){if(a.push(new _(`ALTER TABLE ${this.escapePath(r)} RENAME COLUMN "${h.name}" TO "${n.name}"`)),o.push(new _(`ALTER TABLE ${this.escapePath(r)} RENAME COLUMN "${n.name}" TO "${h.name}"`)),h.type==="enum"||h.type==="simple-enum"){const p=await this.getUserDefinedTypeName(r,h);a.push(new _(`ALTER TYPE "${p.schema}"."${p.name}" RENAME TO ${this.buildEnumName(r,n,!1)}`)),o.push(new _(`ALTER TYPE ${this.buildEnumName(r,n)} RENAME TO "${p.name}"`))}if(h.isPrimary===!0&&!h.primaryKeyConstraintName){const m=i.primaryColumns.map(S=>S.name),w=this.connection.namingStrategy.primaryKeyName(i,m);m.splice(m.indexOf(h.name),1),m.push(n.name);const b=this.connection.namingStrategy.primaryKeyName(i,m);a.push(new _(`ALTER TABLE ${this.escapePath(r)} RENAME CONSTRAINT "${w}" TO "${b}"`)),o.push(new _(`ALTER TABLE ${this.escapePath(r)} RENAME CONSTRAINT "${b}" TO "${w}"`))}if(h.isGenerated===!0&&n.generationStrategy==="increment"){const p=this.buildSequencePath(r,h.name),m=this.buildSequenceName(r,h.name),w=this.buildSequencePath(r,n.name),b=this.buildSequenceName(r,n.name),S=`ALTER SEQUENCE ${this.escapePath(p)} RENAME TO "${b}"`,R=`ALTER SEQUENCE ${this.escapePath(w)} RENAME TO "${m}"`;a.push(new _(S)),o.push(new _(R))}i.findColumnUniques(h).forEach(p=>{const m=this.connection.namingStrategy.uniqueConstraintName(i,p.columnNames);if(p.name!==m)return;p.columnNames.splice(p.columnNames.indexOf(h.name),1),p.columnNames.push(n.name);const w=this.connection.namingStrategy.uniqueConstraintName(i,p.columnNames);a.push(new _(`ALTER TABLE ${this.escapePath(r)} RENAME CONSTRAINT "${p.name}" TO "${w}"`)),o.push(new _(`ALTER TABLE ${this.escapePath(r)} RENAME CONSTRAINT "${w}" TO "${p.name}"`)),p.name=w}),i.findColumnIndices(h).forEach(p=>{const m=this.connection.namingStrategy.indexName(i,p.columnNames,p.where);if(p.name!==m)return;p.columnNames.splice(p.columnNames.indexOf(h.name),1),p.columnNames.push(n.name);const{schema:w}=this.driver.parseTableName(r),b=this.connection.namingStrategy.indexName(i,p.columnNames,p.where),S=w?`ALTER INDEX "${w}"."${p.name}" RENAME TO "${b}"`:`ALTER INDEX "${p.name}" RENAME TO "${b}"`,R=w?`ALTER INDEX "${w}"."${b}" RENAME TO "${p.name}"`:`ALTER INDEX "${b}" RENAME TO "${p.name}"`;a.push(new _(S)),o.push(new _(R)),p.name=b}),i.findColumnForeignKeys(h).forEach(p=>{const m=this.connection.namingStrategy.foreignKeyName(i,p.columnNames,this.getTablePath(p),p.referencedColumnNames);if(p.name!==m)return;p.columnNames.splice(p.columnNames.indexOf(h.name),1),p.columnNames.push(n.name);const w=this.connection.namingStrategy.foreignKeyName(i,p.columnNames,this.getTablePath(p),p.referencedColumnNames);a.push(new _(`ALTER TABLE ${this.escapePath(r)} RENAME CONSTRAINT "${p.name}" TO "${w}"`)),o.push(new _(`ALTER TABLE ${this.escapePath(r)} RENAME CONSTRAINT "${w}" TO "${p.name}"`)),p.name=w});const d=i.columns.find(p=>p.name===h.name);i.columns[i.columns.indexOf(d)].name=n.name,h.name=n.name}if((n.precision!==h.precision||n.scale!==h.scale)&&(a.push(new _(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" TYPE ${this.driver.createFullType(n)}`)),o.push(new _(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" TYPE ${this.driver.createFullType(h)}`))),(n.type==="enum"||n.type==="simple-enum")&&(h.type==="enum"||h.type==="simple-enum")&&(!re.isArraysEqual(n.enum,h.enum)||n.enumName!==h.enumName)){const d=n.isArray?"[]":"",p=this.buildEnumName(r,n),m=this.buildEnumName(r,h),w=this.buildEnumName(r,h,!1),b=this.buildEnumName(r,h,!0,!1,!0),S=this.buildEnumName(r,h,!1,!1,!0);a.push(new _(`ALTER TYPE ${m} RENAME TO ${S}`)),o.push(new _(`ALTER TYPE ${b} RENAME TO ${w}`)),a.push(this.createEnumTypeSql(r,n,p)),o.push(this.dropEnumTypeSql(r,n,p)),h.default!==null&&h.default!==void 0&&(l=!0,a.push(new _(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${h.name}" DROP DEFAULT`)),o.push(new _(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${h.name}" SET DEFAULT ${h.default}`)));const R=`${p}${d} USING "${n.name}"::"text"::${p}${d}`,$=`${b}${d} USING "${n.name}"::"text"::${b}${d}`;a.push(new _(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" TYPE ${R}`)),o.push(new _(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" TYPE ${$}`)),n.default!==null&&n.default!==void 0&&(a.push(new _(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" SET DEFAULT ${n.default}`)),o.push(new _(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" DROP DEFAULT`))),a.push(this.dropEnumTypeSql(r,h,b)),o.push(this.createEnumTypeSql(r,h,b))}if(h.isNullable!==n.isNullable&&(n.isNullable?(a.push(new _(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${h.name}" DROP NOT NULL`)),o.push(new _(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${h.name}" SET NOT NULL`))):(a.push(new _(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${h.name}" SET NOT NULL`)),o.push(new _(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${h.name}" DROP NOT NULL`)))),h.comment!==n.comment&&(a.push(new _(`COMMENT ON COLUMN ${this.escapePath(r)}."${h.name}" IS ${this.escapeComment(n.comment)}`)),o.push(new _(`COMMENT ON COLUMN ${this.escapePath(r)}."${n.name}" IS ${this.escapeComment(h.comment)}`))),n.isPrimary!==h.isPrimary){const d=i.primaryColumns;if(d.length>0){const p=d[0].primaryKeyConstraintName?d[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(i,d.map(w=>w.name)),m=d.map(w=>`"${w.name}"`).join(", ");a.push(new _(`ALTER TABLE ${this.escapePath(r)} DROP CONSTRAINT "${p}"`)),o.push(new _(`ALTER TABLE ${this.escapePath(r)} ADD CONSTRAINT "${p}" PRIMARY KEY (${m})`))}if(n.isPrimary===!0){d.push(n);const p=i.columns.find(b=>b.name===n.name);p.isPrimary=!0;const m=d[0].primaryKeyConstraintName?d[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(i,d.map(b=>b.name)),w=d.map(b=>`"${b.name}"`).join(", ");a.push(new _(`ALTER TABLE ${this.escapePath(r)} ADD CONSTRAINT "${m}" PRIMARY KEY (${w})`)),o.push(new _(`ALTER TABLE ${this.escapePath(r)} DROP CONSTRAINT "${m}"`))}else{const p=d.find(w=>w.name===n.name);d.splice(d.indexOf(p),1);const m=i.columns.find(w=>w.name===n.name);if(m.isPrimary=!1,d.length>0){const w=d[0].primaryKeyConstraintName?d[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(i,d.map(S=>S.name)),b=d.map(S=>`"${S.name}"`).join(", ");a.push(new _(`ALTER TABLE ${this.escapePath(r)} ADD CONSTRAINT "${w}" PRIMARY KEY (${b})`)),o.push(new _(`ALTER TABLE ${this.escapePath(r)} DROP CONSTRAINT "${w}"`))}}}if(n.isUnique!==h.isUnique)if(n.isUnique===!0){const d=new Gt({name:this.connection.namingStrategy.uniqueConstraintName(r,[n.name]),columnNames:[n.name]});i.uniques.push(d),a.push(new _(`ALTER TABLE ${this.escapePath(r)} ADD CONSTRAINT "${d.name}" UNIQUE ("${n.name}")`)),o.push(new _(`ALTER TABLE ${this.escapePath(r)} DROP CONSTRAINT "${d.name}"`))}else{const d=i.uniques.find(p=>p.columnNames.length===1&&!!p.columnNames.find(m=>m===n.name));i.uniques.splice(i.uniques.indexOf(d),1),a.push(new _(`ALTER TABLE ${this.escapePath(r)} DROP CONSTRAINT "${d.name}"`)),o.push(new _(`ALTER TABLE ${this.escapePath(r)} ADD CONSTRAINT "${d.name}" UNIQUE ("${n.name}")`))}if(h.isGenerated!==n.isGenerated&&(h.isGenerated&&(h.generationStrategy==="uuid"?(a.push(new _(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${h.name}" DROP DEFAULT`)),o.push(new _(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${h.name}" SET DEFAULT ${this.driver.uuidGenerator}`))):h.generationStrategy==="increment"&&(a.push(new _(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" DROP DEFAULT`)),o.push(new _(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" SET DEFAULT nextval('${this.escapePath(this.buildSequencePath(r,n))}')`)),a.push(new _(`DROP SEQUENCE ${this.escapePath(this.buildSequencePath(r,n))}`)),o.push(new _(`CREATE SEQUENCE IF NOT EXISTS ${this.escapePath(this.buildSequencePath(r,n))} OWNED BY ${this.escapePath(r)}."${n.name}"`)))),n.generationStrategy==="uuid"?n.isGenerated===!0?(a.push(new _(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" SET DEFAULT ${this.driver.uuidGenerator}`)),o.push(new _(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" DROP DEFAULT`))):(a.push(new _(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" DROP DEFAULT`)),o.push(new _(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" SET DEFAULT ${this.driver.uuidGenerator}`))):n.generationStrategy==="increment"&&(n.isGenerated===!0?(a.push(new _(`CREATE SEQUENCE IF NOT EXISTS ${this.escapePath(this.buildSequencePath(r,n))} OWNED BY ${this.escapePath(r)}."${n.name}"`)),o.push(new _(`DROP SEQUENCE ${this.escapePath(this.buildSequencePath(r,n))}`)),a.push(new _(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" SET DEFAULT nextval('${this.escapePath(this.buildSequencePath(r,n))}')`)),o.push(new _(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" DROP DEFAULT`))):(a.push(new _(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" DROP DEFAULT`)),o.push(new _(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" SET DEFAULT nextval('${this.escapePath(this.buildSequencePath(r,n))}')`)),a.push(new _(`DROP SEQUENCE ${this.escapePath(this.buildSequencePath(r,n))}`)),o.push(new _(`CREATE SEQUENCE IF NOT EXISTS ${this.escapePath(this.buildSequencePath(r,n))} OWNED BY ${this.escapePath(r)}."${n.name}"`))))),n.default!==h.default&&!l&&(n.default!==null&&n.default!==void 0?(a.push(new _(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" SET DEFAULT ${n.default}`)),h.default!==null&&h.default!==void 0?o.push(new _(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" SET DEFAULT ${h.default}`)):o.push(new _(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" DROP DEFAULT`))):h.default!==null&&h.default!==void 0&&(a.push(new _(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" DROP DEFAULT`)),o.push(new _(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" SET DEFAULT ${h.default}`)))),((n.spatialFeatureType||"").toLowerCase()!==(h.spatialFeatureType||"").toLowerCase()||n.srid!==h.srid)&&(a.push(new _(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" TYPE ${this.driver.createFullType(n)}`)),o.push(new _(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" TYPE ${this.driver.createFullType(h)}`))),n.collation!==h.collation){a.push(new _(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" TYPE ${n.type} COLLATE "${n.collation}"`));const d=h.collation?`"${h.collation}"`:'pg_catalog."default"';o.push(new _(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" TYPE ${n.type} COLLATE ${d}`))}if(n.generatedType!==h.generatedType&&(!n.generatedType||n.generatedType==="VIRTUAL")){const d=(await this.getTableNameWithSchema(r.name)).split("."),p=d[1],m=d[0];a.push(new _(`ALTER TABLE ${this.escapePath(r)} RENAME COLUMN "${h.name}" TO "TEMP_OLD_${h.name}"`)),a.push(new _(`ALTER TABLE ${this.escapePath(r)} ADD ${this.buildCreateColumnSql(r,n)}`)),a.push(new _(`UPDATE ${this.escapePath(r)} SET "${n.name}" = "TEMP_OLD_${h.name}"`)),a.push(new _(`ALTER TABLE ${this.escapePath(r)} DROP COLUMN "TEMP_OLD_${h.name}"`)),a.push(this.deleteTypeormMetadataSql({database:this.driver.database,schema:m,table:p,type:Se.GENERATED_COLUMN,name:h.name})),o.push(this.insertTypeormMetadataSql({database:this.driver.database,schema:m,table:p,type:Se.GENERATED_COLUMN,name:h.name,value:h.asExpression})),o.push(new _(`ALTER TABLE ${this.escapePath(r)} ADD ${this.buildCreateColumnSql(r,h)}`)),o.push(new _(`ALTER TABLE ${this.escapePath(r)} DROP COLUMN "${n.name}"`))}}await this.executeQueries(a,o),this.replaceCachedTable(r,i)}async changeColumns(e,t){for(const{oldColumn:n,newColumn:r}of t)await this.changeColumn(e,n,r)}async dropColumn(e,t){const n=B.isTable(e)?e:await this.getCachedTable(e),r=B.isTableColumn(t)?t:n.findColumnByName(t);if(!r)throw new x(`Column "${t}" was not found in table "${n.name}"`);const i=n.clone(),a=[],o=[];if(r.isPrimary){const p=r.primaryKeyConstraintName?r.primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(i,i.primaryColumns.map(b=>b.name)),m=i.primaryColumns.map(b=>`"${b.name}"`).join(", ");a.push(new _(`ALTER TABLE ${this.escapePath(i)} DROP CONSTRAINT "${p}"`)),o.push(new _(`ALTER TABLE ${this.escapePath(i)} ADD CONSTRAINT "${p}" PRIMARY KEY (${m})`));const w=i.findColumnByName(r.name);if(w.isPrimary=!1,i.primaryColumns.length>0){const b=i.primaryColumns[0].primaryKeyConstraintName?i.primaryColumns[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(i,i.primaryColumns.map(R=>R.name)),S=i.primaryColumns.map(R=>`"${R.name}"`).join(", ");a.push(new _(`ALTER TABLE ${this.escapePath(i)} ADD CONSTRAINT "${b}" PRIMARY KEY (${S})`)),o.push(new _(`ALTER TABLE ${this.escapePath(i)} DROP CONSTRAINT "${b}"`))}}const l=i.indices.find(p=>p.columnNames.length===1&&p.columnNames[0]===r.name);l&&(i.indices.splice(i.indices.indexOf(l),1),a.push(this.dropIndexSql(n,l)),o.push(this.createIndexSql(n,l)));const h=i.checks.find(p=>!!p.columnNames&&p.columnNames.length===1&&p.columnNames[0]===r.name);h&&(i.checks.splice(i.checks.indexOf(h),1),a.push(this.dropCheckConstraintSql(n,h)),o.push(this.createCheckConstraintSql(n,h)));const d=i.uniques.find(p=>p.columnNames.length===1&&p.columnNames[0]===r.name);if(d&&(i.uniques.splice(i.uniques.indexOf(d),1),a.push(this.dropUniqueConstraintSql(n,d)),o.push(this.createUniqueConstraintSql(n,d))),a.push(new _(`ALTER TABLE ${this.escapePath(n)} DROP COLUMN "${r.name}"`)),o.push(new _(`ALTER TABLE ${this.escapePath(n)} ADD ${this.buildCreateColumnSql(n,r)}`)),(r.type==="enum"||r.type==="simple-enum")&&await this.hasEnumType(n,r)){const m=await this.getUserDefinedTypeName(n,r),w=`"${m.schema}"."${m.name}"`;a.push(this.dropEnumTypeSql(n,r,w)),o.push(this.createEnumTypeSql(n,r,w))}if(r.generatedType==="STORED"){const p=(await this.getTableNameWithSchema(n.name)).split("."),m=p[1],w=p[0],b=this.deleteTypeormMetadataSql({database:this.driver.database,schema:w,table:m,type:Se.GENERATED_COLUMN,name:r.name}),S=this.insertTypeormMetadataSql({database:this.driver.database,schema:w,table:m,type:Se.GENERATED_COLUMN,name:r.name,value:r.asExpression});a.push(b),o.push(S)}await this.executeQueries(a,o),i.removeColumn(r),this.replaceCachedTable(n,i)}async dropColumns(e,t){for(const n of[...t])await this.dropColumn(e,n)}async createPrimaryKey(e,t,n){const r=B.isTable(e)?e:await this.getCachedTable(e),i=r.clone(),a=this.createPrimaryKeySql(r,t,n);i.columns.forEach(l=>{t.find(h=>h===l.name)&&(l.isPrimary=!0)});const o=this.dropPrimaryKeySql(i);await this.executeQueries(a,o),this.replaceCachedTable(r,i)}async updatePrimaryKeys(e,t){var p;const n=B.isTable(e)?e:await this.getCachedTable(e),r=n.clone(),i=t.map(m=>m.name),a=[],o=[],l=r.primaryColumns;if(l.length>0){const m=l[0].primaryKeyConstraintName?l[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(r,l.map(b=>b.name)),w=l.map(b=>`"${b.name}"`).join(", ");a.push(new _(`ALTER TABLE ${this.escapePath(n)} DROP CONSTRAINT "${m}"`)),o.push(new _(`ALTER TABLE ${this.escapePath(n)} ADD CONSTRAINT "${m}" PRIMARY KEY (${w})`))}r.columns.filter(m=>i.indexOf(m.name)!==-1).forEach(m=>m.isPrimary=!0);const h=(p=l[0])!=null&&p.primaryKeyConstraintName?l[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(r,i),d=i.map(m=>`"${m}"`).join(", ");a.push(new _(`ALTER TABLE ${this.escapePath(n)} ADD CONSTRAINT "${h}" PRIMARY KEY (${d})`)),o.push(new _(`ALTER TABLE ${this.escapePath(n)} DROP CONSTRAINT "${h}"`)),await this.executeQueries(a,o),this.replaceCachedTable(n,r)}async dropPrimaryKey(e,t){const n=B.isTable(e)?e:await this.getCachedTable(e),r=this.dropPrimaryKeySql(n),i=this.createPrimaryKeySql(n,n.primaryColumns.map(a=>a.name),t);await this.executeQueries(r,i),n.primaryColumns.forEach(a=>{a.isPrimary=!1})}async createUniqueConstraint(e,t){const n=B.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.connection.namingStrategy.uniqueConstraintName(n,t.columnNames));const r=this.createUniqueConstraintSql(n,t),i=this.dropUniqueConstraintSql(n,t);await this.executeQueries(r,i),n.addUniqueConstraint(t)}async createUniqueConstraints(e,t){for(const n of t)await this.createUniqueConstraint(e,n)}async dropUniqueConstraint(e,t){const n=B.isTable(e)?e:await this.getCachedTable(e),r=B.isTableUnique(t)?t:n.uniques.find(o=>o.name===t);if(!r)throw new x(`Supplied unique constraint was not found in table ${n.name}`);const i=this.dropUniqueConstraintSql(n,r),a=this.createUniqueConstraintSql(n,r);await this.executeQueries(i,a),n.removeUniqueConstraint(r)}async dropUniqueConstraints(e,t){for(const n of[...t])await this.dropUniqueConstraint(e,n)}async createCheckConstraint(e,t){const n=B.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.connection.namingStrategy.checkConstraintName(n,t.expression));const r=this.createCheckConstraintSql(n,t),i=this.dropCheckConstraintSql(n,t);await this.executeQueries(r,i),n.addCheckConstraint(t)}async createCheckConstraints(e,t){const n=t.map(r=>this.createCheckConstraint(e,r));await Promise.all(n)}async dropCheckConstraint(e,t){const n=B.isTable(e)?e:await this.getCachedTable(e),r=B.isTableCheck(t)?t:n.checks.find(o=>o.name===t);if(!r)throw new x(`Supplied check constraint was not found in table ${n.name}`);const i=this.dropCheckConstraintSql(n,r),a=this.createCheckConstraintSql(n,r);await this.executeQueries(i,a),n.removeCheckConstraint(r)}async dropCheckConstraints(e,t){const n=t.map(r=>this.dropCheckConstraint(e,r));await Promise.all(n)}async createExclusionConstraint(e,t){const n=B.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.connection.namingStrategy.exclusionConstraintName(n,t.expression));const r=this.createExclusionConstraintSql(n,t),i=this.dropExclusionConstraintSql(n,t);await this.executeQueries(r,i),n.addExclusionConstraint(t)}async createExclusionConstraints(e,t){const n=t.map(r=>this.createExclusionConstraint(e,r));await Promise.all(n)}async dropExclusionConstraint(e,t){const n=B.isTable(e)?e:await this.getCachedTable(e),r=B.isTableExclusion(t)?t:n.exclusions.find(o=>o.name===t);if(!r)throw new x(`Supplied exclusion constraint was not found in table ${n.name}`);const i=this.dropExclusionConstraintSql(n,r),a=this.createExclusionConstraintSql(n,r);await this.executeQueries(i,a),n.removeExclusionConstraint(r)}async dropExclusionConstraints(e,t){const n=t.map(r=>this.dropExclusionConstraint(e,r));await Promise.all(n)}async createForeignKey(e,t){const n=B.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.connection.namingStrategy.foreignKeyName(n,t.columnNames,this.getTablePath(t),t.referencedColumnNames));const r=this.createForeignKeySql(n,t),i=this.dropForeignKeySql(n,t);await this.executeQueries(r,i),n.addForeignKey(t)}async createForeignKeys(e,t){for(const n of t)await this.createForeignKey(e,n)}async dropForeignKey(e,t){const n=B.isTable(e)?e:await this.getCachedTable(e),r=B.isTableForeignKey(t)?t:n.foreignKeys.find(o=>o.name===t);if(!r)throw new x(`Supplied foreign key was not found in table ${n.name}`);r.name||(r.name=this.connection.namingStrategy.foreignKeyName(n,r.columnNames,this.getTablePath(r),r.referencedColumnNames));const i=this.dropForeignKeySql(n,r),a=this.createForeignKeySql(n,r);await this.executeQueries(i,a),n.removeForeignKey(r)}async dropForeignKeys(e,t){for(const n of[...t])await this.dropForeignKey(e,n)}async createIndex(e,t){const n=B.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.generateIndexName(n,t));const r=this.createIndexSql(n,t),i=this.dropIndexSql(n,t);await this.executeQueries(r,i),n.addIndex(t)}async createViewIndex(e,t){const n=B.isView(e)?e:await this.getCachedView(e);t.name||(t.name=this.generateIndexName(n,t));const r=this.createViewIndexSql(n,t),i=this.dropIndexSql(n,t);await this.executeQueries(r,i),n.addIndex(t)}async createIndices(e,t){for(const n of t)await this.createIndex(e,n)}async createViewIndices(e,t){for(const n of t)await this.createViewIndex(e,n)}async dropIndex(e,t){const n=B.isTable(e)?e:await this.getCachedTable(e),r=B.isTableIndex(t)?t:n.indices.find(o=>o.name===t);if(!r)throw new x(`Supplied index ${t} was not found in table ${n.name}`);r.name||(r.name=this.generateIndexName(n,r));const i=this.dropIndexSql(n,r),a=this.createIndexSql(n,r);await this.executeQueries(i,a),n.removeIndex(r)}async dropViewIndex(e,t){const n=B.isView(e)?e:await this.getCachedView(e),r=B.isTableIndex(t)?t:n.indices.find(o=>o.name===t);if(!r)throw new x(`Supplied index ${t} was not found in view ${n.name}`);r.name||(r.name=this.generateIndexName(n,r));const i=this.dropIndexSql(n,r),a=this.createViewIndexSql(n,r);await this.executeQueries(i,a),n.removeIndex(r)}async dropIndices(e,t){for(const n of[...t])await this.dropIndex(e,n)}async clearTable(e){await this.query(`TRUNCATE TABLE ${this.escapePath(e)}`)}async clearDatabase(){const e=[];this.connection.entityMetadatas.filter(r=>r.schema).forEach(r=>{!!e.find(a=>a===r.schema)||e.push(r.schema)}),e.push(this.driver.options.schema||"current_schema()");const t=e.map(r=>r==="current_schema()"?r:"'"+r+"'").join(", "),n=this.isTransactionActive;n||await this.startTransaction();try{const r=`SELECT 'DROP VIEW IF EXISTS "' || schemaname || '"."' || viewname || '" CASCADE;' as "query" FROM "pg_views" WHERE "schemaname" IN (${t}) AND "viewname" NOT IN ('geography_columns', 'geometry_columns', 'raster_columns', 'raster_overviews')`,i=await this.query(r);if(await Promise.all(i.map(l=>this.query(l.query))),ie.isReleaseVersionOrGreater(this.driver,"9.3")){const l=`SELECT 'DROP MATERIALIZED VIEW IF EXISTS "' || schemaname || '"."' || matviewname || '" CASCADE;' as "query" FROM "pg_matviews" WHERE "schemaname" IN (${t})`,h=await this.query(l);await Promise.all(h.map(d=>this.query(d.query)))}const a=`SELECT 'DROP TABLE IF EXISTS "' || schemaname || '"."' || tablename || '" CASCADE;' as "query" FROM "pg_tables" WHERE "schemaname" IN (${t}) AND "tablename" NOT IN ('spatial_ref_sys')`,o=await this.query(a);await Promise.all(o.map(l=>this.query(l.query))),await this.dropEnumTypes(t),n||await this.commitTransaction()}catch(r){try{n||await this.rollbackTransaction()}catch{}throw r}}async loadViews(e){if(!await this.hasTable(this.getTypeormMetadataTableName()))return[];e||(e=[]);const n=await this.getCurrentDatabase(),r=await this.getCurrentSchema(),i=e.length===0?"1=1":e.map(p=>this.driver.parseTableName(p)).map(({schema:p,tableName:m})=>(p||(p=this.driver.options.schema||r),`("t"."schema" = '${p}' AND "t"."name" = '${m}')`)).join(" OR "),o=`SELECT "ns"."nspname" AS "table_schema", "t"."relname" AS "table_name", "i"."relname" AS "constraint_name", "a"."attname" AS "column_name", CASE "ix"."indisunique" WHEN 't' THEN 'TRUE' ELSE'FALSE' END AS "is_unique", pg_get_expr("ix"."indpred", "ix"."indrelid") AS "condition", "types"."typname" AS "type_name" FROM "pg_class" "t" INNER JOIN "pg_index" "ix" ON "ix"."indrelid" = "t"."oid" INNER JOIN "pg_attribute" "a" ON "a"."attrelid" = "t"."oid"  AND "a"."attnum" = ANY ("ix"."indkey") INNER JOIN "pg_namespace" "ns" ON "ns"."oid" = "t"."relnamespace" INNER JOIN "pg_class" "i" ON "i"."oid" = "ix"."indexrelid" INNER JOIN "pg_type" "types" ON "types"."oid" = "a"."atttypid" LEFT JOIN "pg_constraint" "cnst" ON "cnst"."conname" = "i"."relname" WHERE "t"."relkind" IN ('m') AND "cnst"."contype" IS NULL AND (${e.length===0?"1=1":e.map(p=>this.driver.parseTableName(p)).map(({schema:p,tableName:m})=>(p||(p=this.driver.options.schema||r),`("ns"."nspname" = '${p}' AND "t"."relname" = '${m}')`)).join(" OR ")})`,l=`SELECT "t".* FROM ${this.escapePath(this.getTypeormMetadataTableName())} "t" INNER JOIN "pg_catalog"."pg_class" "c" ON "c"."relname" = "t"."name" INNER JOIN "pg_namespace" "n" ON "n"."oid" = "c"."relnamespace" AND "n"."nspname" = "t"."schema" WHERE "t"."type" IN ('${Se.VIEW}', '${Se.MATERIALIZED_VIEW}') ${i?`AND (${i})`:""}`,h=await this.query(l),d=await this.query(o);return h.map(p=>{const m=re.uniq(d.filter(S=>S.table_name===p.name&&S.table_schema===p.schema),S=>S.constraint_name),w=new Ur,b=p.schema===r&&!this.driver.options.schema?void 0:p.schema;return w.database=n,w.schema=p.schema,w.name=this.driver.buildTableName(p.name,b),w.expression=p.value,w.materialized=p.type===Se.MATERIALIZED_VIEW,w.indices=m.map(S=>{const R=d.filter($=>$.table_schema===S.table_schema&&$.table_name===S.table_name&&$.constraint_name===S.constraint_name);return new Ct({view:w,name:S.constraint_name,columnNames:R.map($=>$.column_name),isUnique:S.is_unique==="TRUE",where:S.condition,isFulltext:!1})}),w})}async loadTables(e){if(e&&e.length===0)return[];const t=await this.getCurrentSchema(),n=await this.getCurrentDatabase(),r=[];if(!e)r.push(...await this.query(`SELECT "table_schema", "table_name", obj_description(('"' || "table_schema" || '"."' || "table_name" || '"')::regclass, 'pg_class') AS table_comment FROM "information_schema"."tables"`));else{const O=`SELECT "table_schema", "table_name", obj_description(('"' || "table_schema" || '"."' || "table_name" || '"')::regclass, 'pg_class') AS table_comment FROM "information_schema"."tables" WHERE `+e.map(J=>this.driver.parseTableName(J)).map(({schema:J,tableName:ne})=>`("table_schema" = '${J||t}' AND "table_name" = '${ne}')`).join(" OR ");r.push(...await this.query(O))}if(r.length===0)return[];const a=`SELECT columns.*, pg_catalog.col_description(('"' || table_catalog || '"."' || table_schema || '"."' || table_name || '"')::regclass::oid, ordinal_position) AS description, ('"' || "udt_schema" || '"."' || "udt_name" || '"')::"regtype"::text AS "regtype", pg_catalog.format_type("col_attr"."atttypid", "col_attr"."atttypmod") AS "format_type" FROM "information_schema"."columns" LEFT JOIN "pg_catalog"."pg_attribute" AS "col_attr" ON "col_attr"."attname" = "columns"."column_name" AND "col_attr"."attrelid" = ( SELECT "cls"."oid" FROM "pg_catalog"."pg_class" AS "cls" LEFT JOIN "pg_catalog"."pg_namespace" AS "ns" ON "ns"."oid" = "cls"."relnamespace" WHERE "cls"."relname" = "columns"."table_name" AND "ns"."nspname" = "columns"."table_schema" ) WHERE `+r.map(({table_schema:q,table_name:O})=>`("table_schema" = '${q}' AND "table_name" = '${O}')`).join(" OR "),o=r.map(({table_schema:q,table_name:O})=>`("ns"."nspname" = '${q}' AND "t"."relname" = '${O}')`).join(" OR "),l=`SELECT "ns"."nspname" AS "table_schema", "t"."relname" AS "table_name", "cnst"."conname" AS "constraint_name", pg_get_constraintdef("cnst"."oid") AS "expression", CASE "cnst"."contype" WHEN 'p' THEN 'PRIMARY' WHEN 'u' THEN 'UNIQUE' WHEN 'c' THEN 'CHECK' WHEN 'x' THEN 'EXCLUDE' END AS "constraint_type", "a"."attname" AS "column_name" FROM "pg_constraint" "cnst" INNER JOIN "pg_class" "t" ON "t"."oid" = "cnst"."conrelid" INNER JOIN "pg_namespace" "ns" ON "ns"."oid" = "cnst"."connamespace" LEFT JOIN "pg_attribute" "a" ON "a"."attrelid" = "cnst"."conrelid" AND "a"."attnum" = ANY ("cnst"."conkey") WHERE "t"."relkind" IN ('r', 'p') AND (${o})`,h=`SELECT "ns"."nspname" AS "table_schema", "t"."relname" AS "table_name", "i"."relname" AS "constraint_name", "a"."attname" AS "column_name", CASE "ix"."indisunique" WHEN 't' THEN 'TRUE' ELSE'FALSE' END AS "is_unique", pg_get_expr("ix"."indpred", "ix"."indrelid") AS "condition", "types"."typname" AS "type_name", "am"."amname" AS "index_type" FROM "pg_class" "t" INNER JOIN "pg_index" "ix" ON "ix"."indrelid" = "t"."oid" INNER JOIN "pg_attribute" "a" ON "a"."attrelid" = "t"."oid"  AND "a"."attnum" = ANY ("ix"."indkey") INNER JOIN "pg_namespace" "ns" ON "ns"."oid" = "t"."relnamespace" INNER JOIN "pg_class" "i" ON "i"."oid" = "ix"."indexrelid" INNER JOIN "pg_type" "types" ON "types"."oid" = "a"."atttypid" INNER JOIN "pg_am" "am" ON "i"."relam" = "am"."oid" LEFT JOIN "pg_constraint" "cnst" ON "cnst"."conname" = "i"."relname" WHERE "t"."relkind" IN ('r', 'p') AND "cnst"."contype" IS NULL AND (${o})`,d=r.map(({table_schema:q,table_name:O})=>`("ns"."nspname" = '${q}' AND "cl"."relname" = '${O}')`).join(" OR "),m=await this.hasSupportForPartitionedTables()?` AND "cl"."relispartition" = 'f'`:"",w=`SELECT "con"."conname" AS "constraint_name", "con"."nspname" AS "table_schema", "con"."relname" AS "table_name", "att2"."attname" AS "column_name", "ns"."nspname" AS "referenced_table_schema", "cl"."relname" AS "referenced_table_name", "att"."attname" AS "referenced_column_name", "con"."confdeltype" AS "on_delete", "con"."confupdtype" AS "on_update", "con"."condeferrable" AS "deferrable", "con"."condeferred" AS "deferred" FROM ( SELECT UNNEST ("con1"."conkey") AS "parent", UNNEST ("con1"."confkey") AS "child", "con1"."confrelid", "con1"."conrelid", "con1"."conname", "con1"."contype", "ns"."nspname", "cl"."relname", "con1"."condeferrable", CASE WHEN "con1"."condeferred" THEN 'INITIALLY DEFERRED' ELSE 'INITIALLY IMMEDIATE' END as condeferred, CASE "con1"."confdeltype" WHEN 'a' THEN 'NO ACTION' WHEN 'r' THEN 'RESTRICT' WHEN 'c' THEN 'CASCADE' WHEN 'n' THEN 'SET NULL' WHEN 'd' THEN 'SET DEFAULT' END as "confdeltype", CASE "con1"."confupdtype" WHEN 'a' THEN 'NO ACTION' WHEN 'r' THEN 'RESTRICT' WHEN 'c' THEN 'CASCADE' WHEN 'n' THEN 'SET NULL' WHEN 'd' THEN 'SET DEFAULT' END as "confupdtype" FROM "pg_class" "cl" INNER JOIN "pg_namespace" "ns" ON "cl"."relnamespace" = "ns"."oid" INNER JOIN "pg_constraint" "con1" ON "con1"."conrelid" = "cl"."oid" WHERE "con1"."contype" = 'f' AND (${d}) ) "con" INNER JOIN "pg_attribute" "att" ON "att"."attrelid" = "con"."confrelid" AND "att"."attnum" = "con"."child" INNER JOIN "pg_class" "cl" ON "cl"."oid" = "con"."confrelid" ${m}INNER JOIN "pg_namespace" "ns" ON "cl"."relnamespace" = "ns"."oid" INNER JOIN "pg_attribute" "att2" ON "att2"."attrelid" = "con"."conrelid" AND "att2"."attnum" = "con"."parent"`,[b,S,R,$]=await Promise.all([this.query(a),this.query(l),this.query(h),this.query(w)]);return Promise.all(r.map(async q=>{const O=new gt,J=(D,ae)=>D[ae]===t&&(!this.driver.options.schema||this.driver.options.schema===t)?void 0:D[ae],ne=J(q,"table_schema");O.database=n,O.schema=q.table_schema,O.comment=q.table_comment,O.name=this.driver.buildTableName(q.table_name,ne),O.columns=await Promise.all(b.filter(D=>D.table_name===q.table_name&&D.table_schema===q.table_schema).map(async D=>{const ae=S.filter(oe=>oe.table_name===D.table_name&&oe.table_schema===D.table_schema&&oe.column_name===D.column_name),Q=new ln;if(Q.name=D.column_name,Q.type=D.regtype.toLowerCase(),Q.type==="vector"||Q.type==="halfvec"){const oe=D.format_type.match(/^(?:vector|halfvec)\((\d+)\)$/);oe&&oe[1]&&(Q.length=oe[1])}if(Q.type==="numeric"||Q.type==="numeric[]"||Q.type==="decimal"||Q.type==="float"){let oe=D.numeric_precision,ye=D.numeric_scale;if(D.data_type==="ARRAY"){const Ge=D.format_type.match(/^numeric\(([0-9]+),([0-9]+)\)\[\]$/);Ge&&(oe=+Ge[1],ye=+Ge[2])}oe!==null&&!this.isDefaultColumnPrecision(O,Q,oe)?Q.precision=oe:ye!==null&&!this.isDefaultColumnScale(O,Q,ye)&&(Q.precision=void 0),ye!==null&&!this.isDefaultColumnScale(O,Q,ye)?Q.scale=ye:oe!==null&&!this.isDefaultColumnPrecision(O,Q,oe)&&(Q.scale=void 0)}if((Q.type==="interval"||Q.type==="time without time zone"||Q.type==="time with time zone"||Q.type==="timestamp without time zone"||Q.type==="timestamp with time zone")&&(Q.precision=this.isDefaultColumnPrecision(O,Q,D.datetime_precision)?void 0:D.datetime_precision),D.data_type==="USER-DEFINED"||D.data_type==="ARRAY"){const{name:oe}=await this.getUserDefinedTypeName(O,Q),Ge=this.buildEnumName(O,Q,!1,!0)!==oe?oe:void 0,ze=`SELECT "e"."enumlabel" AS "value" FROM "pg_enum" "e" INNER JOIN "pg_type" "t" ON "t"."oid" = "e"."enumtypid" INNER JOIN "pg_namespace" "n" ON "n"."oid" = "t"."typnamespace" WHERE "n"."nspname" = '${q.table_schema}' AND "t"."typname" = '${Ge||oe}'`,_e=await this.query(ze);if(_e.length&&(Q.type="enum",Q.enum=_e.map(We=>We.value),Q.enumName=Ge),D.data_type==="ARRAY"){Q.isArray=!0;const We=Q.type.replace("[]","");Q.type=this.connection.driver.normalizeType({type:We})}}if(Q.type==="geometry"||Q.type==="geography"){const oe=`SELECT * FROM (SELECT "f_table_schema" "table_schema", "f_table_name" "table_name", "f_${Q.type}_column" "column_name", "srid", "type" FROM "${Q.type}_columns") AS _ WHERE "column_name" = '${D.column_name}' AND "table_schema" = '${D.table_schema}' AND "table_name" = '${D.table_name}'`,ye=await this.query(oe);ye.length>0&&(Q.spatialFeatureType=ye[0].type,Q.srid=ye[0].srid)}if(this.driver.withLengthColumnTypes.indexOf(Q.type)!==-1){let oe;if(Q.isArray){const ye=/\((\d+)\)/.exec(D.format_type);oe=ye?ye[1]:void 0}else D.character_maximum_length&&(oe=D.character_maximum_length.toString());oe&&(Q.length=this.isDefaultColumnLength(O,Q,oe)?"":oe)}Q.isNullable=D.is_nullable==="YES";const te=ae.find(oe=>oe.constraint_type==="PRIMARY");if(te){Q.isPrimary=!0;const ye=S.filter(ze=>ze.table_name===D.table_name&&ze.table_schema===D.table_schema&&ze.column_name!==D.column_name&&ze.constraint_type==="PRIMARY").map(ze=>ze.column_name);ye.push(D.column_name);const Ge=this.connection.namingStrategy.primaryKeyName(O,ye);te.constraint_name!==Ge&&(Q.primaryKeyConstraintName=te.constraint_name)}const ce=ae.filter(oe=>oe.constraint_type==="UNIQUE"),fe=ce.every(oe=>S.some(ye=>ye.constraint_type==="UNIQUE"&&ye.constraint_name===oe.constraint_name&&ye.column_name!==D.column_name));if(Q.isUnique=ce.length>0&&!fe,D.is_identity==="YES")Q.isGenerated=!0,Q.generationStrategy="identity",Q.generatedIdentity=D.identity_generation;else if(D.column_default!==null&&D.column_default!==void 0){const oe=`nextval('${this.buildSequenceName(O,D.column_name)}'::regclass)`,ye=`nextval('${this.buildSequencePath(O,D.column_name)}'::regclass)`,Ge=D.column_default.replace(/"/g,"");Ge===oe||Ge===ye?(Q.isGenerated=!0,Q.generationStrategy="increment"):D.column_default==="gen_random_uuid()"||/^uuid_generate_v\d\(\)/.test(D.column_default)?Q.type==="uuid"?(Q.isGenerated=!0,Q.generationStrategy="uuid"):Q.default=D.column_default:D.column_default==="now()"||D.column_default.indexOf("'now'::text")!==-1?Q.default=D.column_default:(Q.default=D.column_default.replace(/::[\w\s.[\]\-"]+/g,""),Q.default=Q.default.replace(/^(-?\d+)$/,"'$1'"))}if(D.is_generated==="ALWAYS"&&D.generation_expression){Q.generatedType="STORED";const oe=this.selectTypeormMetadataSql({database:n,schema:q.table_schema,table:q.table_name,type:Se.GENERATED_COLUMN,name:Q.name}),ye=await this.query(oe.query,oe.parameters);ye[0]&&ye[0].value?Q.asExpression=ye[0].value:Q.asExpression=""}return Q.comment=D.description?D.description:void 0,D.character_set_name&&(Q.charset=D.character_set_name),D.collation_name&&(Q.collation=D.collation_name),Q}));const ge=re.uniq(S.filter(D=>D.table_name===q.table_name&&D.table_schema===q.table_schema&&D.constraint_type==="UNIQUE"),D=>D.constraint_name);O.uniques=ge.map(D=>{const ae=S.filter(Q=>Q.constraint_name===D.constraint_name);return new Gt({name:D.constraint_name,columnNames:ae.map(Q=>Q.column_name),deferrable:D.deferrable?D.deferred:void 0})});const pe=re.uniq(S.filter(D=>D.table_name===q.table_name&&D.table_schema===q.table_schema&&D.constraint_type==="CHECK"),D=>D.constraint_name);O.checks=pe.map(D=>{const ae=S.filter(Q=>Q.constraint_name===D.constraint_name);return new Jn({name:D.constraint_name,columnNames:ae.map(Q=>Q.column_name),expression:D.expression.replace(/^\s*CHECK\s*\((.*)\)\s*$/i,"$1")})});const me=re.uniq(S.filter(D=>D.table_name===q.table_name&&D.table_schema===q.table_schema&&D.constraint_type==="EXCLUDE"),D=>D.constraint_name);O.exclusions=me.map(D=>new Ri({name:D.constraint_name,expression:D.expression.substring(8)}));const V=re.uniq($.filter(D=>D.table_name===q.table_name&&D.table_schema===q.table_schema),D=>D.constraint_name);O.foreignKeys=V.map(D=>{const ae=$.filter(ce=>ce.constraint_name===D.constraint_name),Q=J(D,"referenced_table_schema"),te=this.driver.buildTableName(D.referenced_table_name,Q);return new Dn({name:D.constraint_name,columnNames:ae.map(ce=>ce.column_name),referencedSchema:D.referenced_table_schema,referencedTableName:te,referencedColumnNames:ae.map(ce=>ce.referenced_column_name),onDelete:D.on_delete,onUpdate:D.on_update,deferrable:D.deferrable?D.deferred:void 0})});const Ae=re.uniq(R.filter(D=>D.table_name===q.table_name&&D.table_schema===q.table_schema),D=>D.constraint_name);return O.indices=Ae.map(D=>{const ae=R.filter(Q=>Q.table_schema===D.table_schema&&Q.table_name===D.table_name&&Q.constraint_name===D.constraint_name);return new Ct({table:O,name:D.constraint_name,columnNames:ae.map(Q=>Q.column_name),isUnique:D.is_unique==="TRUE",where:D.condition,isSpatial:D.index_type==="gist",isFulltext:!1})}),O}))}createTableSql(e,t){const n=e.columns.map(a=>this.buildCreateColumnSql(e,a)).join(", ");let r=`CREATE TABLE ${this.escapePath(e)} (${n}`;if(e.columns.filter(a=>a.isUnique).forEach(a=>{e.uniques.some(l=>l.columnNames.length===1&&l.columnNames[0]===a.name)||e.uniques.push(new Gt({name:this.connection.namingStrategy.uniqueConstraintName(e,[a.name]),columnNames:[a.name]}))}),e.uniques.length>0){const a=e.uniques.map(o=>{const l=o.name?o.name:this.connection.namingStrategy.uniqueConstraintName(e,o.columnNames),h=o.columnNames.map(p=>`"${p}"`).join(", ");let d=`CONSTRAINT "${l}" UNIQUE (${h})`;return o.deferrable&&(d+=` DEFERRABLE ${o.deferrable}`),d}).join(", ");r+=`, ${a}`}if(e.checks.length>0){const a=e.checks.map(o=>`CONSTRAINT "${o.name?o.name:this.connection.namingStrategy.checkConstraintName(e,o.expression)}" CHECK (${o.expression})`).join(", ");r+=`, ${a}`}if(e.exclusions.length>0){const a=e.exclusions.map(o=>`CONSTRAINT "${o.name?o.name:this.connection.namingStrategy.exclusionConstraintName(e,o.expression)}" EXCLUDE ${o.expression}`).join(", ");r+=`, ${a}`}if(e.foreignKeys.length>0&&t){const a=e.foreignKeys.map(o=>{const l=o.columnNames.map(p=>`"${p}"`).join(", ");o.name||(o.name=this.connection.namingStrategy.foreignKeyName(e,o.columnNames,this.getTablePath(o),o.referencedColumnNames));const h=o.referencedColumnNames.map(p=>`"${p}"`).join(", ");let d=`CONSTRAINT "${o.name}" FOREIGN KEY (${l}) REFERENCES ${this.escapePath(this.getTablePath(o))} (${h})`;return o.onDelete&&(d+=` ON DELETE ${o.onDelete}`),o.onUpdate&&(d+=` ON UPDATE ${o.onUpdate}`),o.deferrable&&(d+=` DEFERRABLE ${o.deferrable}`),d}).join(", ");r+=`, ${a}`}const i=e.columns.filter(a=>a.isPrimary);if(i.length>0){const a=i[0].primaryKeyConstraintName?i[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(e,i.map(l=>l.name)),o=i.map(l=>`"${l.name}"`).join(", ");r+=`, CONSTRAINT "${a}" PRIMARY KEY (${o})`}return r+=")",e.columns.filter(a=>a.comment).forEach(a=>r+=`; COMMENT ON COLUMN ${this.escapePath(e)}."${a.name}" IS ${this.escapeComment(a.comment)}`),new _(r)}async getVersion(){return(await this.query("SELECT version()"))[0].version.replace(/^PostgreSQL ([\d.]+).*$/,"$1")}dropTableSql(e){return new _(`DROP TABLE ${this.escapePath(e)}`)}createViewSql(e){const t=e.materialized?"MATERIALIZED ":"",n=this.escapePath(e);return typeof e.expression=="string"?new _(`CREATE ${t}VIEW ${n} AS ${e.expression}`):new _(`CREATE ${t}VIEW ${n} AS ${e.expression(this.connection).getQuery()}`)}async insertViewDefinitionSql(e){const t=await this.getCurrentSchema();let{schema:n,tableName:r}=this.driver.parseTableName(e);n||(n=t);const i=e.materialized?Se.MATERIALIZED_VIEW:Se.VIEW,a=typeof e.expression=="string"?e.expression.trim():e.expression(this.connection).getQuery();return this.insertTypeormMetadataSql({type:i,schema:n,name:r,value:a})}dropViewSql(e){const t=e.materialized?"MATERIALIZED ":"";return new _(`DROP ${t}VIEW ${this.escapePath(e)}`)}async deleteViewDefinitionSql(e){const t=await this.getCurrentSchema();let{schema:n,tableName:r}=this.driver.parseTableName(e);n||(n=t);const i=e.materialized?Se.MATERIALIZED_VIEW:Se.VIEW;return this.deleteTypeormMetadataSql({type:i,schema:n,name:r})}async dropEnumTypes(e){const t=`SELECT 'DROP TYPE IF EXISTS "' || n.nspname || '"."' || t.typname || '" CASCADE;' as "query" FROM "pg_type" "t" INNER JOIN "pg_enum" "e" ON "e"."enumtypid" = "t"."oid" INNER JOIN "pg_namespace" "n" ON "n"."oid" = "t"."typnamespace" WHERE "n"."nspname" IN (${e}) GROUP BY "n"."nspname", "t"."typname"`,n=await this.query(t);await Promise.all(n.map(r=>this.query(r.query)))}async hasEnumType(e,t){let{schema:n}=this.driver.parseTableName(e);n||(n=await this.getCurrentSchema());const r=this.buildEnumName(e,t,!1,!0),i=`SELECT "n"."nspname", "t"."typname" FROM "pg_type" "t" INNER JOIN "pg_namespace" "n" ON "n"."oid" = "t"."typnamespace" WHERE "n"."nspname" = '${n}' AND "t"."typname" = '${r}'`;return!!(await this.query(i)).length}createEnumTypeSql(e,t,n){n||(n=this.buildEnumName(e,t));const r=t.enum.map(i=>`'${i.replaceAll("'","''")}'`).join(", ");return new _(`CREATE TYPE ${n} AS ENUM(${r})`)}dropEnumTypeSql(e,t,n){return n||(n=this.buildEnumName(e,t)),new _(`DROP TYPE ${n}`)}createIndexSql(e,t){const n=t.columnNames.map(r=>`"${r}"`).join(", ");return new _(`CREATE ${t.isUnique?"UNIQUE ":""}INDEX${t.isConcurrent?" CONCURRENTLY":""} "${t.name}" ON ${this.escapePath(e)} ${t.isSpatial?"USING GiST ":""}(${n}) ${t.where?"WHERE "+t.where:""}`)}createViewIndexSql(e,t){const n=t.columnNames.map(r=>`"${r}"`).join(", ");return new _(`CREATE ${t.isUnique?"UNIQUE ":""}INDEX "${t.name}" ON ${this.escapePath(e)} (${n}) ${t.where?"WHERE "+t.where:""}`)}dropIndexSql(e,t){const n=B.isTableIndex(t)?t.name:t,r=B.isTableIndex(t)?t.isConcurrent:!1,{schema:i}=this.driver.parseTableName(e);return i?new _(`DROP INDEX ${r?"CONCURRENTLY ":""}"${i}"."${n}"`):new _(`DROP INDEX ${r?"CONCURRENTLY ":""}"${n}"`)}createPrimaryKeySql(e,t,n){const r=n||this.connection.namingStrategy.primaryKeyName(e,t),i=t.map(a=>`"${a}"`).join(", ");return new _(`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT "${r}" PRIMARY KEY (${i})`)}dropPrimaryKeySql(e){if(!e.primaryColumns.length)throw new x(`Table ${e} has no primary keys.`);const t=e.primaryColumns.map(i=>i.name),n=e.primaryColumns[0].primaryKeyConstraintName,r=n||this.connection.namingStrategy.primaryKeyName(e,t);return new _(`ALTER TABLE ${this.escapePath(e)} DROP CONSTRAINT "${r}"`)}createUniqueConstraintSql(e,t){const n=t.columnNames.map(i=>'"'+i+'"').join(", ");let r=`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT "${t.name}" UNIQUE (${n})`;return t.deferrable&&(r+=` DEFERRABLE ${t.deferrable}`),new _(r)}dropUniqueConstraintSql(e,t){const n=B.isTableUnique(t)?t.name:t;return new _(`ALTER TABLE ${this.escapePath(e)} DROP CONSTRAINT "${n}"`)}createCheckConstraintSql(e,t){return new _(`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT "${t.name}" CHECK (${t.expression})`)}dropCheckConstraintSql(e,t){const n=B.isTableCheck(t)?t.name:t;return new _(`ALTER TABLE ${this.escapePath(e)} DROP CONSTRAINT "${n}"`)}createExclusionConstraintSql(e,t){return new _(`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT "${t.name}" EXCLUDE ${t.expression}`)}dropExclusionConstraintSql(e,t){const n=B.isTableExclusion(t)?t.name:t;return new _(`ALTER TABLE ${this.escapePath(e)} DROP CONSTRAINT "${n}"`)}createForeignKeySql(e,t){const n=t.columnNames.map(a=>'"'+a+'"').join(", "),r=t.referencedColumnNames.map(a=>'"'+a+'"').join(",");let i=`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT "${t.name}" FOREIGN KEY (${n}) REFERENCES ${this.escapePath(this.getTablePath(t))}(${r})`;return t.onDelete&&(i+=` ON DELETE ${t.onDelete}`),t.onUpdate&&(i+=` ON UPDATE ${t.onUpdate}`),t.deferrable&&(i+=` DEFERRABLE ${t.deferrable}`),new _(i)}dropForeignKeySql(e,t){const n=B.isTableForeignKey(t)?t.name:t;return new _(`ALTER TABLE ${this.escapePath(e)} DROP CONSTRAINT "${n}"`)}buildSequenceName(e,t){const{tableName:n}=this.driver.parseTableName(e),r=B.isTableColumn(t)?t.name:t;let i=`${n}_${r}_seq`;return i.length>this.connection.driver.maxAliasLength&&(i=`${n.substring(0,29)}_${r.substring(0,Math.max(29,63-e.name.length-5))}_seq`),i}buildSequencePath(e,t){const{schema:n}=this.driver.parseTableName(e);return n?`${n}.${this.buildSequenceName(e,t)}`:this.buildSequenceName(e,t)}buildEnumName(e,t,n=!0,r,i){const{schema:a,tableName:o}=this.driver.parseTableName(e);let l=t.enumName?t.enumName:`${o}_${t.name.toLowerCase()}_enum`;return a&&n&&(l=`${a}.${l}`),i&&(l=l+"_old"),l.split(".").map(h=>r?h:`"${h}"`).join(".")}async getUserDefinedTypeName(e,t){let{schema:n,tableName:r}=this.driver.parseTableName(e);n||(n=await this.getCurrentSchema());const i=await this.query(`SELECT "udt_schema", "udt_name" FROM "information_schema"."columns" WHERE "table_schema" = '${n}' AND "table_name" = '${r}' AND "column_name"='${t.name}'`);let a=i[0].udt_name;return a.indexOf("_")===0&&(a=a.substr(1,a.length)),{schema:i[0].udt_schema,name:a}}escapeComment(e){return!e||e.length===0?"NULL":(e=e.replace(/'/g,"''").replace(/\u0000/g,""),`'${e}'`)}escapePath(e){const{schema:t,tableName:n}=this.driver.parseTableName(e);return t&&t!==this.driver.searchSchema?`"${t}"."${n}"`:`"${n}"`}async getTableNameWithSchema(e){const t=B.isTable(e)?e.name:e;return t.indexOf(".")===-1?`${(await this.query("SELECT current_schema()"))[0].current_schema}.${t}`:`${t.split(".")[0]}.${t.split(".")[1]}`}buildCreateColumnSql(e,t){let n='"'+t.name+'"';if(t.isGenerated===!0&&t.generationStrategy!=="uuid")if(t.generationStrategy==="identity"){const r=t.generatedIdentity||"BY DEFAULT";n+=` ${t.type} GENERATED ${r} AS IDENTITY`}else(t.type==="integer"||t.type==="int"||t.type==="int4")&&(n+=" SERIAL"),(t.type==="smallint"||t.type==="int2")&&(n+=" SMALLSERIAL"),(t.type==="bigint"||t.type==="int8")&&(n+=" BIGSERIAL");return t.type==="enum"||t.type==="simple-enum"?(n+=" "+this.buildEnumName(e,t),t.isArray&&(n+=" array")):(!t.isGenerated||t.type==="uuid")&&(n+=" "+this.connection.driver.createFullType(t)),t.generatedType==="STORED"&&t.asExpression&&(n+=` GENERATED ALWAYS AS (${t.asExpression}) STORED`),t.charset&&(n+=' CHARACTER SET "'+t.charset+'"'),t.collation&&(n+=' COLLATE "'+t.collation+'"'),t.isNullable!==!0&&(n+=" NOT NULL"),t.default!==void 0&&t.default!==null&&(n+=" DEFAULT "+t.default),t.isGenerated&&t.generationStrategy==="uuid"&&!t.default&&(n+=` DEFAULT ${this.driver.uuidGenerator}`),n}async hasSupportForPartitionedTables(){return!!(await this.query("SELECT TRUE FROM information_schema.columns WHERE table_name = 'pg_class' and column_name = 'relispartition'")).length}async changeTableComment(e,t){const n=[],r=[],i=B.isTable(e)?e:await this.getCachedTable(e);t=this.escapeComment(t);const a=this.escapeComment(i.comment);if(t===a)return;const o=i.clone();n.push(new _(`COMMENT ON TABLE ${this.escapePath(o)} IS ${t}`)),r.push(new _(`COMMENT ON TABLE ${this.escapePath(i)} IS ${a}`)),await this.executeQueries(n,r),i.comment=o.comment,this.replaceCachedTable(i,o)}}class Jx extends Kx{constructor(e,t){super(e,t)}}class Xx extends Jx{constructor(e,t,n){super(e,n),this.client=t}connect(){return this.databaseConnection?Promise.resolve(this.databaseConnection):this.databaseConnectionPromise?this.databaseConnectionPromise:(this.mode==="slave"&&this.driver.isReplicated?this.databaseConnectionPromise=this.driver.obtainSlaveConnection().then(([e,t])=>(this.driver.connectedQueryRunners.push(this),this.databaseConnection=e,this.releaseCallback=t,this.databaseConnection)):this.databaseConnectionPromise=this.driver.obtainMasterConnection().then(([e,t])=>(this.driver.connectedQueryRunners.push(this),this.databaseConnection=e,this.releaseCallback=t,this.databaseConnection)),this.databaseConnectionPromise)}async startTransaction(e){this.isTransactionActive=!0;try{await this.broadcaster.broadcast("BeforeTransactionStart")}catch(t){throw this.isTransactionActive=!1,t}this.transactionDepth===0?await this.client.startTransaction():await this.query(`SAVEPOINT typeorm_${this.transactionDepth}`),this.transactionDepth+=1,await this.broadcaster.broadcast("AfterTransactionStart")}async commitTransaction(){if(!this.isTransactionActive)throw new In;await this.broadcaster.broadcast("BeforeTransactionCommit"),this.transactionDepth>1?await this.query(`RELEASE SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.client.commitTransaction(),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionCommit")}async rollbackTransaction(){if(!this.isTransactionActive)throw new In;await this.broadcaster.broadcast("BeforeTransactionRollback"),this.transactionDepth>1?await this.query(`ROLLBACK TO SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.client.rollbackTransaction(),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionRollback")}async query(e,t,n=!1){if(this.isReleased)throw new zt;const r=await this.client.query(e,t),i=new tr;return i.raw=r,r!=null&&r.hasOwnProperty("records")&&Array.isArray(r.records)&&(i.records=r.records),r!=null&&r.hasOwnProperty("numberOfRecordsUpdated")&&(i.affected=r.numberOfRecordsUpdated),n?i:i.raw}changeTableComment(e,t){throw new x("aurora-postgres driver does not support change comment.")}}class Zx extends vy{}class eM extends Zx{constructor(e){super(),this.transactionSupport="nested",this.connection=e,this.options=e.options,this.isReplicated=!1,this.loadDependencies(),this.client=new this.DataApiDriver(this.options.region,this.options.secretArn,this.options.resourceArn,this.options.database,(t,n)=>this.connection.logger.logQuery(t,n),this.options.serviceConfigOptions,this.options.formatOptions),this.database=ie.buildDriverOptions(this.options).database}async connect(){}async disconnect(){}createQueryRunner(e){return new Xx(this,new this.DataApiDriver(this.options.region,this.options.secretArn,this.options.resourceArn,this.options.database,(t,n)=>this.connection.logger.logQuery(t,n),this.options.serviceConfigOptions,this.options.formatOptions),e)}preparePersistentValue(e,t){return this.options.formatOptions&&this.options.formatOptions.castParameters===!1?super.preparePersistentValue(e,t):(t.transformer&&(e=It.transformTo(t.transformer,e)),this.client.preparePersistentValue(e,t))}prepareHydratedValue(e,t){return this.options.formatOptions&&this.options.formatOptions.castParameters===!1?super.prepareHydratedValue(e,t):(t.transformer&&(e=It.transformFrom(t.transformer,e)),this.client.prepareHydratedValue(e,t))}loadDependencies(){const e=this.options.driver||Xe.load("typeorm-aurora-data-api-driver"),{pg:t}=e;this.DataApiDriver=t}executeQuery(e,t){return this.connection.query(t)}async afterConnect(){const e=await this.checkMetadataForExtensions();return e.hasExtensions&&await this.enableExtensions(e,this.connection),Promise.resolve()}}class tM extends Mi{constructor(e){super(),this.driver=e,this.connection=e.connection,this.broadcaster=new mr(this)}async beforeMigration(){await this.query("PRAGMA foreign_keys = OFF")}async afterMigration(){await this.query("PRAGMA foreign_keys = ON")}async executeSet(e){if(this.isReleased)throw new zt;return(await this.connect()).executeSet(e,!1)}async query(e,t,n=!1){if(this.isReleased)throw new zt;const r=await this.connect();this.driver.connection.logger.logQuery(e,t,this);const i=e.substring(0,e.indexOf(" ")!==-1?e.indexOf(" "):void 0);try{let a;["BEGIN","ROLLBACK","COMMIT","CREATE","ALTER","DROP"].indexOf(i)!==-1?a=await r.execute(e,!1):["INSERT","UPDATE","DELETE"].indexOf(i)!==-1?a=await r.run(e,t,!1):a=await r.query(e,t||[]);const o=new tr;return a!=null&&a.hasOwnProperty("values")&&(o.raw=a.values,o.records=a.values),a!=null&&a.hasOwnProperty("changes")&&(o.affected=a.changes.changes,o.raw=a.changes.lastId||a.changes.changes),n?o:o.raw}catch(a){throw this.driver.connection.logger.logQueryError(a,e,t,this),new Kn(e,t,a)}}parametrize(e){return Object.keys(e).map(t=>`"${t}"=?`)}}class nM extends ms{constructor(e){super(e),this.database=this.options.database,this.driver=this.options.driver,this.sqlite=this.options.driver}async connect(){this.databaseConnection=this.createDatabaseConnection(),await this.databaseConnection}async disconnect(){return this.queryRunner=void 0,(await this.databaseConnection).close().then(()=>{this.databaseConnection=void 0})}createQueryRunner(e){return this.queryRunner||(this.queryRunner=new tM(this)),this.queryRunner}async createDatabaseConnection(){const e=this.options.mode||"no-encryption",t=e!=="no-encryption",n=typeof this.options.version>"u"?1:this.options.version,r=await this.sqlite.createConnection(this.options.database,t,e,n);return await r.open(),await r.execute("PRAGMA foreign_keys = ON"),this.options.journalMode&&["DELETE","TRUNCATE","PERSIST","MEMORY","WAL","OFF"].indexOf(this.options.journalMode)!==-1&&await r.execute(`PRAGMA journal_mode = ${this.options.journalMode}`),r}loadDependencies(){if(this.sqlite=this.driver,!this.driver)throw new ds("Capacitor","@capacitor-community/sqlite")}}class rM extends nc{constructor(e,t){super(),this.driver=e,this.connection=e.connection,this.mode=t,this.broadcaster=new mr(this)}async connect(){if(this.session)return Promise.resolve(this.session);const[e]=await this.driver.instanceDatabase.createSession({});return this.session=e,this.sessionTransaction=await e.transaction(),this.session}async release(){return this.isReleased=!0,this.session&&await this.session.delete(),this.session=void 0,Promise.resolve()}async startTransaction(e){this.isTransactionActive=!0;try{await this.broadcaster.broadcast("BeforeTransactionStart")}catch(t){throw this.isTransactionActive=!1,t}await this.connect(),await this.sessionTransaction.begin(),this.connection.logger.logQuery("START TRANSACTION"),await this.broadcaster.broadcast("AfterTransactionStart")}async commitTransaction(){if(!this.isTransactionActive||!this.sessionTransaction)throw new In;await this.broadcaster.broadcast("BeforeTransactionCommit"),await this.sessionTransaction.commit(),this.connection.logger.logQuery("COMMIT"),this.isTransactionActive=!1,await this.broadcaster.broadcast("AfterTransactionCommit")}async rollbackTransaction(){if(!this.isTransactionActive||!this.sessionTransaction)throw new In;await this.broadcaster.broadcast("BeforeTransactionRollback"),await this.sessionTransaction.rollback(),this.connection.logger.logQuery("ROLLBACK"),this.isTransactionActive=!1,await this.broadcaster.broadcast("AfterTransactionRollback")}async query(e,t,n=!1){if(this.isReleased)throw new zt;await this.connect(),this.driver.connection.logger.logQuery(e,t,this),await this.broadcaster.broadcast("BeforeQuery",e,t);const r=new $n;try{const i=Date.now();let a;const o=e.startsWith("SELECT"),l=o&&!this.isTransactionActive?this.driver.instanceDatabase:this.sessionTransaction;!this.isTransactionActive&&!o&&await this.sessionTransaction.begin();try{a=await l.run({sql:e,params:t?t.reduce((w,b,S)=>(w["param"+S]=b,w),{}):void 0,json:!0}),!this.isTransactionActive&&!o&&await this.sessionTransaction.commit()}catch(w){try{!this.isTransactionActive&&!o&&await this.sessionTransaction.rollback()}catch{}throw w}const h=this.driver.options.maxQueryExecutionTime,p=Date.now()-i;this.broadcaster.broadcastAfterQueryEvent(r,e,t,!0,p,a,void 0),h&&p>h&&this.driver.connection.logger.logQuerySlow(p,e,t,this);const m=new tr;return m.raw=a,m.records=a?a[0]:[],a&&a[1]&&a[1].rowCountExact&&(m.affected=parseInt(a[1].rowCountExact)),n?m:m.records}catch(i){throw this.driver.connection.logger.logQueryError(i,e,t,this),this.broadcaster.broadcastAfterQueryEvent(r,e,t,!1,void 0,void 0,i),new Kn(e,t,i)}finally{await r.wait()}}async updateDDL(e,t){if(this.isReleased)throw new zt;this.driver.connection.logger.logQuery(e,t,this);try{const n=Date.now(),[r]=await this.driver.instanceDatabase.updateSchema(e);await r.promise();const i=this.driver.options.maxQueryExecutionTime,o=Date.now()-n;i&&o>i&&this.driver.connection.logger.logQuerySlow(o,e,t,this)}catch(n){throw this.driver.connection.logger.logQueryError(n,e,t,this),new Kn(e,t,n)}}async stream(e,t,n,r){if(this.isReleased)throw new zt;try{this.driver.connection.logger.logQuery(e,t,this);const i={sql:e,params:t?t.reduce((o,l,h)=>(o["param"+h]=l,o),{}):void 0,json:!0},a=this.driver.instanceDatabase.runStream(i);return n&&a.on("end",n),r&&a.on("error",r),a}catch(i){throw this.driver.connection.logger.logQueryError(i,e,t,this),new Kn(e,t,i)}}async getDatabases(){return Promise.resolve([])}async getSchemas(e){return Promise.resolve([])}async hasDatabase(e){throw new x("Check database queries are not supported by Spanner driver.")}async getCurrentDatabase(){throw new x("Check database queries are not supported by Spanner driver.")}async hasSchema(e){return!!(await this.query(`SELECT * FROM "information_schema"."schemata" WHERE "schema_name" = '${e}'`)).length}async getCurrentSchema(){throw new x("Check schema queries are not supported by Spanner driver.")}async hasTable(e){const n=`SELECT * FROM \`INFORMATION_SCHEMA\`.\`TABLES\` WHERE \`TABLE_CATALOG\` = '' AND \`TABLE_SCHEMA\` = '' AND \`TABLE_TYPE\` = 'BASE TABLE' AND \`TABLE_NAME\` = '${e instanceof gt?e.name:e}'`;return!!(await this.query(n)).length}async hasColumn(e,t){const r=`SELECT * FROM \`INFORMATION_SCHEMA\`.\`COLUMNS\` WHERE \`TABLE_CATALOG\` = '' AND \`TABLE_SCHEMA\` = '' AND \`TABLE_NAME\` = '${e instanceof gt?e.name:e}' AND \`COLUMN_NAME\` = '${t}'`;return!!(await this.query(r)).length}async createDatabase(e,t){if(t&&await this.hasDatabase(e))return Promise.resolve();const n=`CREATE DATABASE "${e}"`,r=`DROP DATABASE "${e}"`;await this.executeQueries(new _(n),new _(r))}async dropDatabase(e,t){const n=t?`DROP DATABASE IF EXISTS "${e}"`:`DROP DATABASE "${e}"`,r=`CREATE DATABASE "${e}"`;await this.executeQueries(new _(n),new _(r))}async createSchema(e,t){return Promise.resolve()}async dropSchema(e,t,n){return Promise.resolve()}async createTable(e,t=!1,n=!0,r=!0){if(t&&await this.hasTable(e))return Promise.resolve();const i=[],a=[];i.push(this.createTableSql(e,n)),a.push(this.dropTableSql(e)),n&&e.foreignKeys.forEach(l=>a.push(this.dropForeignKeySql(e,l))),r&&e.indices.forEach(l=>{l.name||(l.name=this.connection.namingStrategy.indexName(e,l.columnNames,l.where)),i.push(this.createIndexSql(e,l)),a.push(this.dropIndexSql(e,l))});const o=e.columns.filter(l=>l.generatedType&&l.asExpression);for(const l of o){const h=this.insertTypeormMetadataSql({table:e.name,type:Se.GENERATED_COLUMN,name:l.name,value:l.asExpression}),d=this.deleteTypeormMetadataSql({table:e.name,type:Se.GENERATED_COLUMN,name:l.name});i.push(h),a.push(d)}await this.executeQueries(i,a)}async dropTable(e,t,n=!0,r=!0){if(t&&!await this.hasTable(e))return Promise.resolve();const i=n,a=this.getTablePath(e),o=await this.getCachedTable(a),l=[],h=[];r&&o.indices.forEach(p=>{l.push(this.dropIndexSql(o,p)),h.push(this.createIndexSql(o,p))}),n&&o.foreignKeys.forEach(p=>l.push(this.dropForeignKeySql(o,p))),l.push(this.dropTableSql(o)),h.push(this.createTableSql(o,i));const d=o.columns.filter(p=>p.generatedType&&p.asExpression);for(const p of d){const m=this.deleteTypeormMetadataSql({table:o.name,type:Se.GENERATED_COLUMN,name:p.name}),w=this.insertTypeormMetadataSql({table:o.name,type:Se.GENERATED_COLUMN,name:p.name,value:p.asExpression});l.push(m),h.push(w)}await this.executeQueries(l,h)}async createView(e){const t=[],n=[];t.push(this.createViewSql(e)),t.push(await this.insertViewDefinitionSql(e)),n.push(this.dropViewSql(e)),n.push(await this.deleteViewDefinitionSql(e)),await this.executeQueries(t,n)}async dropView(e){const t=e instanceof Ur?e.name:e,n=await this.getCachedView(t),r=[],i=[];r.push(await this.deleteViewDefinitionSql(n)),r.push(this.dropViewSql(n)),i.push(await this.insertViewDefinitionSql(n)),i.push(this.createViewSql(n)),await this.executeQueries(r,i)}async renameTable(e,t){throw new x("Rename table queries are not supported by Spanner driver.")}async addColumn(e,t){const n=e instanceof gt?e:await this.getCachedTable(e),r=n.clone(),i=[],a=[];i.push(new _(`ALTER TABLE ${this.escapePath(n)} ADD ${this.buildCreateColumnSql(t)}`)),a.push(new _(`ALTER TABLE ${this.escapePath(n)} DROP COLUMN ${this.driver.escape(t.name)}`));const o=r.indices.find(l=>l.columnNames.length===1&&l.columnNames[0]===t.name);if(o)i.push(this.createIndexSql(n,o)),a.push(this.dropIndexSql(n,o));else if(t.isUnique){const l=new Ct({name:this.connection.namingStrategy.indexName(n,[t.name]),columnNames:[t.name],isUnique:!0});r.indices.push(l),r.uniques.push(new Gt({name:l.name,columnNames:l.columnNames})),i.push(this.createIndexSql(n,l)),a.push(this.dropIndexSql(n,l))}if(t.generatedType&&t.asExpression){const l=this.insertTypeormMetadataSql({table:n.name,type:Se.GENERATED_COLUMN,name:t.name,value:t.asExpression}),h=this.deleteTypeormMetadataSql({table:n.name,type:Se.GENERATED_COLUMN,name:t.name});i.push(l),a.push(h)}await this.executeQueries(i,a),r.addColumn(t),this.replaceCachedTable(n,r)}async addColumns(e,t){for(const n of t)await this.addColumn(e,n)}async renameColumn(e,t,n){const r=e instanceof gt?e:await this.getCachedTable(e),i=t instanceof ln?t:r.columns.find(o=>o.name===t);if(!i)throw new x(`Column "${t}" was not found in the "${r.name}" table.`);let a;return n instanceof ln?a=n:(a=i.clone(),a.name=n),this.changeColumn(r,i,a)}async changeColumn(e,t,n){const r=e instanceof gt?e:await this.getCachedTable(e);let i=r.clone();const a=[],o=[],l=t instanceof ln?t:r.columns.find(h=>h.name===t);if(!l)throw new x(`Column "${t}" was not found in the "${r.name}" table.`);if(l.name!==n.name||l.type!==n.type||l.length!==n.length||l.isArray!==n.isArray||l.generatedType!==n.generatedType||l.asExpression!==n.asExpression)await this.dropColumn(r,l),await this.addColumn(r,n),i=r.clone();else if((n.precision!==l.precision||n.scale!==l.scale)&&(a.push(new _(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" TYPE ${this.driver.createFullType(n)}`)),o.push(new _(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${n.name}" TYPE ${this.driver.createFullType(l)}`))),l.isNullable!==n.isNullable&&(n.isNullable?(a.push(new _(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${l.name}" DROP NOT NULL`)),o.push(new _(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${l.name}" SET NOT NULL`))):(a.push(new _(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${l.name}" SET NOT NULL`)),o.push(new _(`ALTER TABLE ${this.escapePath(r)} ALTER COLUMN "${l.name}" DROP NOT NULL`)))),n.isUnique!==l.isUnique)if(n.isUnique===!0){const h=new Ct({name:this.connection.namingStrategy.indexName(r,[n.name]),columnNames:[n.name],isUnique:!0});i.indices.push(h),i.uniques.push(new Gt({name:h.name,columnNames:h.columnNames})),a.push(this.createIndexSql(r,h)),o.push(this.dropIndexSql(r,h))}else{const h=i.indices.find(p=>p.columnNames.length===1&&p.isUnique===!0&&!!p.columnNames.find(m=>m===n.name));i.indices.splice(i.indices.indexOf(h),1);const d=i.uniques.find(p=>p.name===h.name);i.uniques.splice(i.uniques.indexOf(d),1),a.push(this.dropIndexSql(r,h)),o.push(this.createIndexSql(r,h))}await this.executeQueries(a,o),this.replaceCachedTable(r,i)}async changeColumns(e,t){for(const{oldColumn:n,newColumn:r}of t)await this.changeColumn(e,n,r)}async dropColumn(e,t){const n=e instanceof gt?e:await this.getCachedTable(e),r=t instanceof ln?t:n.findColumnByName(t);if(!r)throw new x(`Column "${t}" was not found in table "${n.name}"`);const i=n.clone(),a=[],o=[],l=i.indices.find(d=>d.columnNames.length===1&&d.columnNames[0]===r.name);l&&(i.indices.splice(i.indices.indexOf(l),1),a.push(this.dropIndexSql(n,l)),o.push(this.createIndexSql(n,l)));const h=i.checks.find(d=>!!d.columnNames&&d.columnNames.length===1&&d.columnNames[0]===r.name);if(h&&(i.checks.splice(i.checks.indexOf(h),1),a.push(this.dropCheckConstraintSql(n,h)),o.push(this.createCheckConstraintSql(n,h))),a.push(new _(`ALTER TABLE ${this.escapePath(n)} DROP COLUMN ${this.driver.escape(r.name)}`)),o.push(new _(`ALTER TABLE ${this.escapePath(n)} ADD ${this.buildCreateColumnSql(r)}`)),r.generatedType&&r.asExpression){const d=this.deleteTypeormMetadataSql({table:n.name,type:Se.GENERATED_COLUMN,name:r.name}),p=this.insertTypeormMetadataSql({table:n.name,type:Se.GENERATED_COLUMN,name:r.name,value:r.asExpression});a.push(d),o.push(p)}await this.executeQueries(a,o),i.removeColumn(r),this.replaceCachedTable(n,i)}async dropColumns(e,t){for(const n of[...t])await this.dropColumn(e,n)}async createPrimaryKey(e,t){throw new Error("The keys of a table can't change; you can't add a key column to an existing table or remove a key column from an existing table.")}async updatePrimaryKeys(e,t){throw new Error("The keys of a table can't change; you can't add a key column to an existing table or remove a key column from an existing table.")}async dropPrimaryKey(e){throw new Error("The keys of a table can't change; you can't add a key column to an existing table or remove a key column from an existing table.")}async createUniqueConstraint(e,t){throw new x("Spanner does not support unique constraints. Use unique index instead.")}async createUniqueConstraints(e,t){throw new x("Spanner does not support unique constraints. Use unique index instead.")}async dropUniqueConstraint(e,t){throw new x("Spanner does not support unique constraints. Use unique index instead.")}async dropUniqueConstraints(e,t){throw new x("Spanner does not support unique constraints. Use unique index instead.")}async createCheckConstraint(e,t){const n=e instanceof gt?e:await this.getCachedTable(e);t.name||(t.name=this.connection.namingStrategy.checkConstraintName(n,t.expression));const r=this.createCheckConstraintSql(n,t),i=this.dropCheckConstraintSql(n,t);await this.executeQueries(r,i),n.addCheckConstraint(t)}async createCheckConstraints(e,t){const n=t.map(r=>this.createCheckConstraint(e,r));await Promise.all(n)}async dropCheckConstraint(e,t){const n=e instanceof gt?e:await this.getCachedTable(e),r=t instanceof Jn?t:n.checks.find(o=>o.name===t);if(!r)throw new x(`Supplied check constraint was not found in table ${n.name}`);const i=this.dropCheckConstraintSql(n,r),a=this.createCheckConstraintSql(n,r);await this.executeQueries(i,a),n.removeCheckConstraint(r)}async dropCheckConstraints(e,t){const n=t.map(r=>this.dropCheckConstraint(e,r));await Promise.all(n)}async createExclusionConstraint(e,t){throw new x("Spanner does not support exclusion constraints.")}async createExclusionConstraints(e,t){throw new x("Spanner does not support exclusion constraints.")}async dropExclusionConstraint(e,t){throw new x("Spanner does not support exclusion constraints.")}async dropExclusionConstraints(e,t){throw new x("Spanner does not support exclusion constraints.")}async createForeignKey(e,t){const n=e instanceof gt?e:await this.getCachedTable(e);t.name||(t.name=this.connection.namingStrategy.foreignKeyName(n,t.columnNames,this.getTablePath(t),t.referencedColumnNames));const r=this.createForeignKeySql(n,t),i=this.dropForeignKeySql(n,t);await this.executeQueries(r,i),n.addForeignKey(t)}async createForeignKeys(e,t){for(const n of t)await this.createForeignKey(e,n)}async dropForeignKey(e,t){const n=e instanceof gt?e:await this.getCachedTable(e),r=t instanceof Dn?t:n.foreignKeys.find(o=>o.name===t);if(!r)throw new x(`Supplied foreign key was not found in table ${n.name}`);const i=this.dropForeignKeySql(n,r),a=this.createForeignKeySql(n,r);await this.executeQueries(i,a),n.removeForeignKey(r)}async dropForeignKeys(e,t){for(const n of[...t])await this.dropForeignKey(e,n)}async createIndex(e,t){const n=e instanceof gt?e:await this.getCachedTable(e);t.name||(t.name=this.generateIndexName(n,t));const r=this.createIndexSql(n,t),i=this.dropIndexSql(n,t);await this.executeQueries(r,i),n.addIndex(t)}async createIndices(e,t){for(const n of t)await this.createIndex(e,n)}async dropIndex(e,t){const n=e instanceof gt?e:await this.getCachedTable(e),r=t instanceof Ct?t:n.indices.find(o=>o.name===t);if(!r)throw new x(`Supplied index ${t} was not found in table ${n.name}`);r.name||(r.name=this.generateIndexName(n,r));const i=this.dropIndexSql(n,r),a=this.createIndexSql(n,r);await this.executeQueries(i,a),n.removeIndex(r)}async dropIndices(e,t){for(const n of[...t])await this.dropIndex(e,n)}async clearTable(e){await this.query(`DELETE FROM ${this.escapePath(e)} WHERE true`)}async clearDatabase(){const t=await this.query("SELECT concat('DROP INDEX `', INDEX_NAME, '`') AS `query` FROM `INFORMATION_SCHEMA`.`INDEXES` WHERE `TABLE_CATALOG` = '' AND `TABLE_SCHEMA` = '' AND `INDEX_TYPE` = 'INDEX' AND `SPANNER_IS_MANAGED` = false"),r=await this.query("SELECT concat('ALTER TABLE `', TABLE_NAME, '`', ' DROP CONSTRAINT `', CONSTRAINT_NAME, '`') AS `query` FROM `INFORMATION_SCHEMA`.`TABLE_CONSTRAINTS` WHERE `TABLE_CATALOG` = '' AND `TABLE_SCHEMA` = '' AND `CONSTRAINT_TYPE` = 'FOREIGN KEY'"),a=await this.query("SELECT concat('DROP TABLE `', TABLE_NAME, '`') AS `query` FROM `INFORMATION_SCHEMA`.`TABLES` WHERE `TABLE_CATALOG` = '' AND `TABLE_SCHEMA` = '' AND `TABLE_TYPE` = 'BASE TABLE'");if(!t.length&&!r.length&&!a.length)return;const o=this.isTransactionActive;o||await this.startTransaction();try{for(const l of t)await this.updateDDL(l.query);for(const l of r)await this.updateDDL(l.query);for(const l of a)await this.updateDDL(l.query);await this.commitTransaction()}catch(l){try{o||await this.rollbackTransaction()}catch{}throw l}}async executeMemoryUpSql(){for(const{query:e,parameters:t}of this.sqlInMemory.upQueries)this.isDMLQuery(e)?await this.query(e,t):await this.updateDDL(e,t)}async executeMemoryDownSql(){for(const{query:e,parameters:t}of this.sqlInMemory.downQueries.reverse())this.isDMLQuery(e)?await this.query(e,t):await this.updateDDL(e,t)}async loadViews(e){return Promise.resolve([])}async loadTables(e){if(e&&e.length===0)return[];const t=[];if(!e||!e.length)t.push(...await this.query("SELECT `TABLE_NAME` FROM `INFORMATION_SCHEMA`.`TABLES` WHERE `TABLE_CATALOG` = '' AND `TABLE_SCHEMA` = '' AND `TABLE_TYPE` = 'BASE TABLE'"));else{const b=`SELECT \`TABLE_NAME\` FROM \`INFORMATION_SCHEMA\`.\`TABLES\` WHERE \`TABLE_CATALOG\` = '' AND \`TABLE_SCHEMA\` = '' AND \`TABLE_TYPE\` = 'BASE TABLE' AND \`TABLE_NAME\` IN (${e.map(S=>`'${S}'`).join(", ")})`;t.push(...await this.query(b))}if(!t.length)return[];const n=t.map(b=>`'${b.TABLE_NAME}'`).join(", "),r=`SELECT * FROM \`INFORMATION_SCHEMA\`.\`COLUMNS\` WHERE \`TABLE_CATALOG\` = '' AND \`TABLE_SCHEMA\` = '' AND \`TABLE_NAME\` IN (${n})`,i=`SELECT \`KCU\`.\`TABLE_NAME\`, \`KCU\`.\`COLUMN_NAME\` FROM \`INFORMATION_SCHEMA\`.\`TABLE_CONSTRAINTS\` \`TC\` INNER JOIN \`INFORMATION_SCHEMA\`.\`KEY_COLUMN_USAGE\` \`KCU\` ON \`KCU\`.\`CONSTRAINT_NAME\` = \`TC\`.\`CONSTRAINT_NAME\` WHERE \`TC\`.\`TABLE_CATALOG\` = '' AND \`TC\`.\`TABLE_SCHEMA\` = '' AND \`TC\`.\`CONSTRAINT_TYPE\` = 'PRIMARY KEY' AND \`TC\`.\`TABLE_NAME\` IN (${n})`,a=`SELECT \`I\`.\`TABLE_NAME\`, \`I\`.\`INDEX_NAME\`, \`I\`.\`IS_UNIQUE\`, \`I\`.\`IS_NULL_FILTERED\`, \`IC\`.\`COLUMN_NAME\` FROM \`INFORMATION_SCHEMA\`.\`INDEXES\` \`I\` INNER JOIN \`INFORMATION_SCHEMA\`.\`INDEX_COLUMNS\` \`IC\` ON \`IC\`.\`INDEX_NAME\` = \`I\`.\`INDEX_NAME\` AND \`IC\`.\`TABLE_NAME\` = \`I\`.\`TABLE_NAME\` WHERE \`I\`.\`TABLE_CATALOG\` = '' AND \`I\`.\`TABLE_SCHEMA\` = '' AND \`I\`.\`TABLE_NAME\` IN (${n}) AND \`I\`.\`INDEX_TYPE\` = 'INDEX' AND \`I\`.\`SPANNER_IS_MANAGED\` = false`,o=`SELECT \`TC\`.\`TABLE_NAME\`, \`TC\`.\`CONSTRAINT_NAME\`, \`CC\`.\`CHECK_CLAUSE\`, \`CCU\`.\`COLUMN_NAME\`FROM \`INFORMATION_SCHEMA\`.\`TABLE_CONSTRAINTS\` \`TC\` INNER JOIN \`INFORMATION_SCHEMA\`.\`CONSTRAINT_COLUMN_USAGE\` \`CCU\` ON \`CCU\`.\`CONSTRAINT_NAME\` = \`TC\`.\`CONSTRAINT_NAME\` INNER JOIN \`INFORMATION_SCHEMA\`.\`CHECK_CONSTRAINTS\` \`CC\` ON \`CC\`.\`CONSTRAINT_NAME\` = \`TC\`.\`CONSTRAINT_NAME\` WHERE \`TC\`.\`TABLE_CATALOG\` = '' AND \`TC\`.\`TABLE_SCHEMA\` = '' AND \`TC\`.\`CONSTRAINT_TYPE\` = 'CHECK' AND \`TC\`.\`TABLE_NAME\` IN (${n}) AND \`TC\`.\`CONSTRAINT_NAME\` NOT LIKE 'CK_IS_NOT_NULL%'`,l=`SELECT \`TC\`.\`TABLE_NAME\`, \`TC\`.\`CONSTRAINT_NAME\`, \`KCU\`.\`COLUMN_NAME\`, \`CTU\`.\`TABLE_NAME\` AS \`REFERENCED_TABLE_NAME\`, \`CCU\`.\`COLUMN_NAME\` AS \`REFERENCED_COLUMN_NAME\`, \`RC\`.\`UPDATE_RULE\`, \`RC\`.\`DELETE_RULE\` FROM \`INFORMATION_SCHEMA\`.\`TABLE_CONSTRAINTS\` \`TC\` INNER JOIN \`INFORMATION_SCHEMA\`.\`KEY_COLUMN_USAGE\` \`KCU\` ON \`KCU\`.\`CONSTRAINT_NAME\` = \`TC\`.\`CONSTRAINT_NAME\` INNER JOIN \`INFORMATION_SCHEMA\`.\`CONSTRAINT_TABLE_USAGE\` \`CTU\` ON \`CTU\`.\`CONSTRAINT_NAME\` = \`TC\`.\`CONSTRAINT_NAME\` INNER JOIN \`INFORMATION_SCHEMA\`.\`REFERENTIAL_CONSTRAINTS\` \`RC\` ON \`RC\`.\`CONSTRAINT_NAME\` = \`TC\`.\`CONSTRAINT_NAME\` INNER JOIN \`INFORMATION_SCHEMA\`.\`CONSTRAINT_COLUMN_USAGE\` \`CCU\` ON \`CCU\`.\`CONSTRAINT_NAME\` = \`TC\`.\`CONSTRAINT_NAME\` WHERE \`TC\`.\`TABLE_CATALOG\` = '' AND \`TC\`.\`TABLE_SCHEMA\` = '' AND \`TC\`.\`CONSTRAINT_TYPE\` = 'FOREIGN KEY' AND \`TC\`.\`TABLE_NAME\` IN (${n})`,[h,d,p,m,w]=await Promise.all([this.query(r),this.query(i),this.query(a),this.query(o),this.query(l)]);return Promise.all(t.map(async b=>{const S=new gt;S.name=this.driver.buildTableName(b.TABLE_NAME),S.columns=await Promise.all(h.filter(O=>O.TABLE_NAME===b.TABLE_NAME).map(async O=>{const J=p.filter(Ae=>Ae.TABLE_NAME===b.TABLE_NAME&&Ae.COLUMN_NAME===O.COLUMN_NAME&&Ae.IS_UNIQUE===!0),ne=this.connection.entityMetadatas.find(Ae=>this.getTablePath(S)===this.getTablePath(Ae)),ge=J.length>0&&ne&&ne.indices.some(Ae=>J.some(D=>Ae.name===D.INDEX_NAME&&Ae.synchronize===!1)),pe=J.every(Ae=>p.some(D=>D.INDEX_NAME===Ae.INDEX_NAME&&D.COLUMN_NAME!==O.COLUMN_NAME)),me=new ln;me.name=O.COLUMN_NAME;let V=O.SPANNER_TYPE.toLowerCase();if(V.indexOf("array")!==-1&&(me.isArray=!0,V=V.substring(V.indexOf("<")+1,V.indexOf(">"))),V.indexOf("(")!==-1?me.type=V.substring(0,V.indexOf("(")):me.type=V,this.driver.withLengthColumnTypes.indexOf(me.type)!==-1&&(me.length=V.substring(V.indexOf("(")+1,V.indexOf(")"))),O.IS_GENERATED==="ALWAYS"){me.asExpression=O.GENERATION_EXPRESSION,me.generatedType="STORED";const Ae=this.selectTypeormMetadataSql({table:b.TABLE_NAME,type:Se.GENERATED_COLUMN,name:me.name}),D=await this.query(Ae.query,Ae.parameters);D[0]&&D[0].value?me.asExpression=D[0].value:me.asExpression=""}return me.isUnique=J.length>0&&!ge&&!pe,me.isNullable=O.IS_NULLABLE==="YES",me.isPrimary=d.some(Ae=>Ae.TABLE_NAME===O.TABLE_NAME&&Ae.COLUMN_NAME===O.COLUMN_NAME),me}));const R=w.filter(O=>O.TABLE_NAME===b.TABLE_NAME);S.foreignKeys=re.uniq(R,O=>O.CONSTRAINT_NAME).map(O=>{const J=R.filter(ne=>ne.CONSTRAINT_NAME===O.CONSTRAINT_NAME);return new Dn({name:O.CONSTRAINT_NAME,columnNames:re.uniq(J.map(ne=>ne.COLUMN_NAME)),referencedDatabase:O.REFERENCED_TABLE_SCHEMA,referencedTableName:O.REFERENCED_TABLE_NAME,referencedColumnNames:re.uniq(J.map(ne=>ne.REFERENCED_COLUMN_NAME)),onDelete:O.DELETE_RULE,onUpdate:O.UPDATE_RULE})});const $=p.filter(O=>O.TABLE_NAME===b.TABLE_NAME);S.indices=re.uniq($,O=>O.INDEX_NAME).map(O=>{const J=$.filter(ne=>ne.INDEX_NAME===O.INDEX_NAME);return new Ct({table:S,name:O.INDEX_NAME,columnNames:J.map(ne=>ne.COLUMN_NAME),isUnique:O.IS_UNIQUE,isNullFiltered:O.IS_NULL_FILTERED})});const q=m.filter(O=>O.TABLE_NAME===b.TABLE_NAME);return S.checks=re.uniq(q,O=>O.CONSTRAINT_NAME).map(O=>{const J=q.filter(ne=>ne.CONSTRAINT_NAME===O.CONSTRAINT_NAME);return new Jn({name:O.CONSTRAINT_NAME,columnNames:J.map(ne=>ne.COLUMN_NAME),expression:O.CHECK_CLAUSE})}),S}))}createTableSql(e,t){const n=e.columns.map(a=>this.buildCreateColumnSql(a)).join(", ");let r=`CREATE TABLE ${this.escapePath(e)} (${n}`;if(e.columns.filter(a=>a.isUnique).forEach(a=>{const o=e.indices.some(h=>h.columnNames.length===1&&!!h.isUnique&&h.columnNames.indexOf(a.name)!==-1),l=e.uniques.some(h=>h.columnNames.length===1&&h.columnNames.indexOf(a.name)!==-1);!o&&!l&&e.indices.push(new Ct({name:this.connection.namingStrategy.uniqueConstraintName(e,[a.name]),columnNames:[a.name],isUnique:!0}))}),e.uniques.length>0&&e.uniques.forEach(a=>{e.indices.some(l=>l.name===a.name)||e.indices.push(new Ct({name:a.name,columnNames:a.columnNames,isUnique:!0}))}),e.checks.length>0){const a=e.checks.map(o=>`CONSTRAINT \`${o.name?o.name:this.connection.namingStrategy.checkConstraintName(e,o.expression)}\` CHECK (${o.expression})`).join(", ");r+=`, ${a}`}if(e.foreignKeys.length>0&&t){const a=e.foreignKeys.map(o=>{const l=o.columnNames.map(d=>`\`${d}\``).join(", ");o.name||(o.name=this.connection.namingStrategy.foreignKeyName(e,o.columnNames,this.getTablePath(o),o.referencedColumnNames));const h=o.referencedColumnNames.map(d=>`\`${d}\``).join(", ");return`CONSTRAINT \`${o.name}\` FOREIGN KEY (${l}) REFERENCES ${this.escapePath(this.getTablePath(o))} (${h})`}).join(", ");r+=`, ${a}`}r+=")";const i=e.columns.filter(a=>a.isPrimary);if(i.length>0){const a=i.map(o=>this.driver.escape(o.name)).join(", ");r+=` PRIMARY KEY (${a})`}return new _(r)}dropTableSql(e){return new _(`DROP TABLE ${this.escapePath(e)}`)}createViewSql(e){const t=e.materialized?"MATERIALIZED ":"",n=this.escapePath(e),r=typeof e.expression=="string"?e.expression:e.expression(this.connection).getQuery();return new _(`CREATE ${t}VIEW ${n} SQL SECURITY INVOKER AS ${r}`)}async insertViewDefinitionSql(e){const{schema:t,tableName:n}=this.driver.parseTableName(e),r=e.materialized?Se.MATERIALIZED_VIEW:Se.VIEW,i=typeof e.expression=="string"?e.expression.trim():e.expression(this.connection).getQuery();return this.insertTypeormMetadataSql({type:r,schema:t,name:n,value:i})}dropViewSql(e){const t=e.materialized?"MATERIALIZED ":"";return new _(`DROP ${t}VIEW ${this.escapePath(e)}`)}async deleteViewDefinitionSql(e){const{schema:t,tableName:n}=this.driver.parseTableName(e),r=e.materialized?Se.MATERIALIZED_VIEW:Se.VIEW;return this.deleteTypeormMetadataSql({type:r,schema:t,name:n})}createIndexSql(e,t){const n=t.columnNames.map(i=>this.driver.escape(i)).join(", ");let r="";return t.isUnique&&(r+="UNIQUE "),t.isNullFiltered&&(r+="NULL_FILTERED "),new _(`CREATE ${r}INDEX \`${t.name}\` ON ${this.escapePath(e)} (${n})`)}dropIndexSql(e,t){const n=t instanceof Ct?t.name:t;return new _(`DROP INDEX \`${n}\``)}createCheckConstraintSql(e,t){return new _(`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT \`${t.name}\` CHECK (${t.expression})`)}dropCheckConstraintSql(e,t){const n=t instanceof Jn?t.name:t;return new _(`ALTER TABLE ${this.escapePath(e)} DROP CONSTRAINT \`${n}\``)}createForeignKeySql(e,t){const n=t.columnNames.map(a=>this.driver.escape(a)).join(", "),r=t.referencedColumnNames.map(a=>this.driver.escape(a)).join(","),i=`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT \`${t.name}\` FOREIGN KEY (${n}) REFERENCES ${this.escapePath(this.getTablePath(t))} (${r})`;return new _(i)}dropForeignKeySql(e,t){const n=t instanceof Dn?t.name:t;return new _(`ALTER TABLE ${this.escapePath(e)} DROP CONSTRAINT \`${n}\``)}escapePath(e){const{tableName:t}=this.driver.parseTableName(e);return`\`${t}\``}buildCreateColumnSql(e){let t=`${this.driver.escape(e.name)} ${this.connection.driver.createFullType(e)}`;return e.generatedType==="STORED"&&e.asExpression?t+=` AS (${e.asExpression}) STORED`:e.isNullable||(t+=" NOT NULL"),t}async executeQueries(e,t){if(e instanceof _&&(e=[e]),t instanceof _&&(t=[t]),this.sqlInMemory.upQueries.push(...e),this.sqlInMemory.downQueries.push(...t),this.sqlMemoryMode===!0)return Promise.resolve();for(const{query:n,parameters:r}of e)this.isDMLQuery(n)?await this.query(n,r):await this.updateDDL(n,r)}isDMLQuery(e){return e.startsWith("INSERT")||e.startsWith("UPDATE")||e.startsWith("DELETE")}changeTableComment(e,t){throw new x("spanner driver does not support change table comment.")}}class iM{constructor(e){this.isReplicated=!1,this.treeSupport=!0,this.transactionSupport="none",this.supportedDataTypes=["bool","int64","float64","numeric","string","json","bytes","date","timestamp","array"],this.supportedUpsertTypes=[],this.spatialTypes=[],this.withLengthColumnTypes=["string","bytes"],this.withPrecisionColumnTypes=[],this.withScaleColumnTypes=[],this.mappedDataTypes={createDate:"timestamp",createDateDefault:"",updateDate:"timestamp",updateDateDefault:"",deleteDate:"timestamp",deleteDateNullable:!0,version:"int64",treeLevel:"int64",migrationId:"int64",migrationName:"string",migrationTimestamp:"int64",cacheId:"string",cacheIdentifier:"string",cacheTime:"int64",cacheDuration:"int64",cacheQuery:"string",cacheResult:"string",metadataType:"string",metadataDatabase:"string",metadataSchema:"string",metadataTable:"string",metadataName:"string",metadataValue:"string"},this.parametersPrefix="@param",this.dataTypeDefaults={},this.maxAliasLength=63,this.cteCapabilities={enabled:!0},this.connection=e,this.options=e.options,this.isReplicated=!!this.options.replication,this.loadDependencies()}async connect(){this.instance=this.spanner.instance(this.options.instanceId),this.instanceDatabase=this.instance.database(this.options.databaseId)}afterConnect(){return Promise.resolve()}async disconnect(){this.instanceDatabase.close()}createSchemaBuilder(){return new tc(this.connection)}createQueryRunner(e){return new rM(this,e)}escapeQueryWithParameters(e,t,n){const r=Object.keys(n).map(a=>n[a]);if(!t||!Object.keys(t).length)return[e,r];const i=new Map;return e=e.replace(/:(\.\.\.)?([A-Za-z0-9_.]+)/g,(a,o,l)=>{if(!t.hasOwnProperty(l))return a;if(i.has(l))return this.parametersPrefix+i.get(l);const h=t[l];return h===null?a:o?h.map(d=>(r.push(d),this.createParameter(l,r.length-1))).join(", "):h instanceof Function?h():(r.push(h),i.set(l,r.length-1),this.createParameter(l,r.length-1))}),e=e.replace(/([ ]+)?=([ ]+)?:(\.\.\.)?([A-Za-z0-9_.]+)/g,(a,o,l,h,d)=>t.hasOwnProperty(d)&&t[d]===null?" IS NULL":a),[e,r]}escape(e){return`\`${e}\``}buildTableName(e,t,n){const r=[e];return n&&r.unshift(n),r.join(".")}parseTableName(e){const t=this.database,n=void 0;if(e instanceof gt||e instanceof Ur){const i=this.parseTableName(e.name);return{database:e.database||i.database||t,schema:e.schema||i.schema||n,tableName:i.tableName}}if(e instanceof Dn){const i=this.parseTableName(e.referencedTableName);return{database:e.referencedDatabase||i.database||t,schema:e.referencedSchema||i.schema||n,tableName:i.tableName}}if(e instanceof Xn)return{database:e.database||t,schema:e.schema||n,tableName:e.tableName};const r=e.split(".");return{database:(r.length>1?r[0]:void 0)||t,schema:n,tableName:r.length>1?r[1]:r[0]}}preparePersistentValue(e,t){return t.transformer&&(e=It.transformTo(t.transformer,e)),e==null?e:t.type==="numeric"?(this.options.driver||Xe.load("spanner")).Spanner.numeric(e.toString()):t.type==="date"?be.mixedDateToDateString(e):t.type==="json"?e:t.type==="timestamp"||t.type===Date?be.mixedDateToDate(e):e}prepareHydratedValue(e,t){return e==null?t.transformer?It.transformFrom(t.transformer,e):e:(t.type===Boolean||t.type==="bool"?e=!!e:t.type==="timestamp"||t.type===Date?e=new Date(e):t.type==="numeric"?e=e.value:t.type==="date"?e=be.mixedDateToDateString(e):t.type==="json"?e=typeof e=="string"?JSON.parse(e):e:t.type===Number&&(e=isNaN(+e)?e:parseInt(e)),t.transformer&&(e=It.transformFrom(t.transformer,e)),e)}normalizeType(e){return e.type===Number?"int64":e.type===String||e.type==="uuid"?"string":e.type===Date?"timestamp":e.type===Buffer?"bytes":e.type===Boolean?"bool":e.type||""}normalizeDefault(e){return e.default===""?`"${e.default}"`:`${e.default}`}normalizeIsUnique(e){return e.entityMetadata.indices.some(t=>t.isUnique&&t.columns.length===1&&t.columns[0]===e)}getColumnLength(e){if(e.length)return e.length.toString();if(e.generationStrategy==="uuid")return"36";switch(e.type){case String:case"string":case"bytes":return"max";default:return""}}createFullType(e){let t=e.type;return this.getColumnLength(e)?t+=`(${this.getColumnLength(e)})`:e.width?t+=`(${e.width})`:e.precision!==null&&e.precision!==void 0&&e.scale!==null&&e.scale!==void 0?t+=`(${e.precision},${e.scale})`:e.precision!==null&&e.precision!==void 0&&(t+=`(${e.precision})`),e.isArray&&(t=`array<${t}>`),t}obtainMasterConnection(){return this.instanceDatabase}obtainSlaveConnection(){return this.instanceDatabase}createGeneratedMap(e,t,n){if(!t)return;if(t.insertId===void 0)return Object.keys(t).reduce((i,a)=>{const o=e.findColumnWithDatabaseName(a);return o&&re.mergeDeep(i,o.createValueMap(t[a])),i},{});const r=e.generatedColumns.reduce((i,a)=>{let o;return a.generationStrategy==="increment"&&t.insertId&&(o=t.insertId+n),re.mergeDeep(i,a.createValueMap(o))},{});return Object.keys(r).length>0?r:void 0}findChangedColumns(e,t){return t.filter(n=>{const r=e.find(a=>a.name===n.databaseName);return r?r.name!==n.databaseName||r.type!==this.normalizeType(n)||r.length!==this.getColumnLength(n)||r.asExpression!==n.asExpression||r.generatedType!==n.generatedType||r.isPrimary!==n.isPrimary||!this.compareNullableValues(n,r)||r.isUnique!==this.normalizeIsUnique(n):!1})}isReturningSqlSupported(){return!0}isUUIDGenerationSupported(){return!0}isFullTextColumnTypeSupported(){return!1}createParameter(e,t){return this.parametersPrefix+t}loadDependencies(){try{const e=this.options.driver||Xe.load("spanner");if(this.options.credentials){this.spanner=new e.Spanner({projectId:this.options.projectId,credentials:this.options.credentials});return}this.spanner=new e.Spanner({projectId:this.options.projectId})}catch(e){throw console.error(e),new ds("Spanner","@google-cloud/spanner")}}compareNullableValues(e,t){return e.generatedType?!0:e.isNullable===t.isNullable}compareDefaultValues(e,t){return typeof e=="string"&&typeof t=="string"&&(e=e.replace(/^'+|'+$/g,""),t=t.replace(/^'+|'+$/g,"")),e===t}normalizeDatetimeFunction(e){if(!e)return e;if(e.toUpperCase().indexOf("CURRENT_TIMESTAMP")!==-1||e.toUpperCase().indexOf("NOW")!==-1){const n=e.match(/\(\d+\)/);return n?`CURRENT_TIMESTAMP${n[0]}`:"CURRENT_TIMESTAMP"}else return e}escapeComment(e){return e&&(e=e.replace(/\u0000/g,""),e)}}class sM{create(e){const{type:t}=e.options;switch(t){case"mysql":return new Fp(e);case"postgres":return new vy(e);case"cockroachdb":return new lx(e);case"sap":return new dx(e);case"mariadb":return new Fp(e);case"sqlite":return new px(e);case"better-sqlite3":return new mx(e);case"cordova":return new Lx(e);case"nativescript":return new Fx(e);case"react-native":return new Bx(e);case"sqljs":return new jx(e);case"oracle":return new fx(e);case"mssql":return new hx(e);case"mongodb":return new ox(e);case"expo":return new Yx(e).create();case"aurora-mysql":return new zx(e);case"aurora-postgres":return new eM(e);case"capacitor":return new nM(e);case"spanner":return new iM(e);default:throw new R0(t,["aurora-mysql","aurora-postgres","better-sqlite3","capacitor","cockroachdb","cordova","expo","mariadb","mongodb","mssql","mysql","nativescript","oracle","postgres","react-native","sap","sqlite","sqljs","spanner"])}}}function Ju(s,e,t=[".js",".cjs",".ts"]){return[]}const aM=new class{constructor(){this.instances=[]}get(s){let e=this.instances.find(t=>t.type===s);return e||(e={type:s,object:new s},this.instances.push(e)),e.object}};let Nl,Vs;function V1(s,e){Nl=s,Vs=e}function Cl(s){if(Nl)try{const e=Nl.get(s);if(e||!Vs||!Vs.fallback)return e}catch(e){if(!Vs||!Vs.fallbackOnErrors)throw e}return aM.get(s)}class Pn{constructor(e){this["@instanceof"]=Symbol.for("ColumnMetadata"),this.length="",this.isPrimary=!1,this.isGenerated=!1,this.isNullable=!1,this.isSelect=!0,this.isInsert=!0,this.isUpdate=!0,this.zerofill=!1,this.unsigned=!1,this.isArray=!1,this.isVirtual=!1,this.isVirtualProperty=!1,this.isDiscriminator=!1,this.isTreeLevel=!1,this.isCreateDate=!1,this.isUpdateDate=!1,this.isDeleteDate=!1,this.isVersion=!1,this.isObjectId=!1,this.isNestedSetLeft=!1,this.isNestedSetRight=!1,this.isMaterializedPath=!1,this.entityMetadata=e.entityMetadata,this.embeddedMetadata=e.embeddedMetadata,this.referencedColumn=e.referencedColumn,e.args.target&&(this.target=e.args.target),e.args.propertyName&&(this.propertyName=e.args.propertyName),e.args.options.name&&(this.givenDatabaseName=e.args.options.name),e.args.options.type&&(this.type=e.args.options.type),e.args.options.length&&(this.length=e.args.options.length?e.args.options.length.toString():""),e.args.options.width&&(this.width=e.args.options.width),e.args.options.charset&&(this.charset=e.args.options.charset),e.args.options.collation&&(this.collation=e.args.options.collation),e.args.options.primary&&(this.isPrimary=e.args.options.primary),e.args.options.default===null&&(this.isNullable=!0),e.args.options.nullable!==void 0&&(this.isNullable=e.args.options.nullable),e.args.options.select!==void 0&&(this.isSelect=e.args.options.select),e.args.options.insert!==void 0&&(this.isInsert=e.args.options.insert),e.args.options.update!==void 0&&(this.isUpdate=e.args.options.update),e.args.options.readonly!==void 0&&(this.isUpdate=!e.args.options.readonly),e.args.options.comment&&(this.comment=e.args.options.comment),e.args.options.default!==void 0&&(this.default=e.args.options.default),e.args.options.onUpdate&&(this.onUpdate=e.args.options.onUpdate),e.args.options.generatedIdentity&&(this.generatedIdentity=e.args.options.generatedIdentity),e.args.options.scale!==null&&e.args.options.scale!==void 0&&(this.scale=e.args.options.scale),e.args.options.zerofill&&(this.zerofill=e.args.options.zerofill,this.unsigned=!0),e.args.options.unsigned&&(this.unsigned=e.args.options.unsigned),e.args.options.precision!==null&&(this.precision=e.args.options.precision),e.args.options.enum&&(Re.isObject(e.args.options.enum)&&!Array.isArray(e.args.options.enum)?this.enum=Object.keys(e.args.options.enum).filter(t=>isNaN(+t)&&typeof e.args.options.enum[t]!="function").map(t=>e.args.options.enum[t]):this.enum=e.args.options.enum),e.args.options.enumName&&(this.enumName=e.args.options.enumName),e.args.options.primaryKeyConstraintName&&(this.primaryKeyConstraintName=e.args.options.primaryKeyConstraintName),e.args.options.foreignKeyConstraintName&&(this.foreignKeyConstraintName=e.args.options.foreignKeyConstraintName),e.args.options.asExpression&&(this.asExpression=e.args.options.asExpression,this.generatedType=e.args.options.generatedType?e.args.options.generatedType:"VIRTUAL"),e.args.options.hstoreType&&(this.hstoreType=e.args.options.hstoreType),e.args.options.array&&(this.isArray=e.args.options.array),e.args.mode&&(this.isVirtualProperty=e.args.mode==="virtual-property",this.isVirtual=e.args.mode==="virtual",this.isTreeLevel=e.args.mode==="treeLevel",this.isCreateDate=e.args.mode==="createDate",this.isUpdateDate=e.args.mode==="updateDate",this.isDeleteDate=e.args.mode==="deleteDate",this.isVersion=e.args.mode==="version",this.isObjectId=e.args.mode==="objectId"),this.isVirtualProperty&&(this.isInsert=!1,this.isUpdate=!1),e.args.options.transformer&&(this.transformer=e.args.options.transformer),e.args.options.spatialFeatureType&&(this.spatialFeatureType=e.args.options.spatialFeatureType),e.args.options.srid!==void 0&&(this.srid=e.args.options.srid),e.args.options.query&&(this.query=e.args.options.query),this.isTreeLevel&&(this.type=e.connection.driver.mappedDataTypes.treeLevel),this.isCreateDate&&(this.type||(this.type=e.connection.driver.mappedDataTypes.createDate),this.default||(this.default=()=>e.connection.driver.mappedDataTypes.createDateDefault),this.precision===void 0&&e.args.options.precision===void 0&&e.connection.driver.mappedDataTypes.createDatePrecision&&(this.precision=e.connection.driver.mappedDataTypes.createDatePrecision)),this.isUpdateDate&&(this.type||(this.type=e.connection.driver.mappedDataTypes.updateDate),this.default||(this.default=()=>e.connection.driver.mappedDataTypes.updateDateDefault),this.onUpdate||(this.onUpdate=e.connection.driver.mappedDataTypes.updateDateDefault),this.precision===void 0&&e.args.options.precision===void 0&&e.connection.driver.mappedDataTypes.updateDatePrecision&&(this.precision=e.connection.driver.mappedDataTypes.updateDatePrecision)),this.isDeleteDate&&(this.type||(this.type=e.connection.driver.mappedDataTypes.deleteDate),this.isNullable||(this.isNullable=e.connection.driver.mappedDataTypes.deleteDateNullable),this.precision===void 0&&e.args.options.precision===void 0&&e.connection.driver.mappedDataTypes.deleteDatePrecision&&(this.precision=e.connection.driver.mappedDataTypes.deleteDatePrecision)),this.isVersion&&(this.type=e.connection.driver.mappedDataTypes.version),e.closureType&&(this.closureType=e.closureType),e.nestedSetLeft&&(this.isNestedSetLeft=e.nestedSetLeft),e.nestedSetRight&&(this.isNestedSetRight=e.nestedSetRight),e.materializedPath&&(this.isMaterializedPath=e.materializedPath)}createValueMap(e,t=!1){if(this.embeddedMetadata){const n=[...this.embeddedMetadata.parentPropertyNames],r=(i,a)=>{const o=i.shift();return o?(a[o]={},r(i,a[o]),a):((this.generationStrategy==="increment"||this.generationStrategy==="rowid")&&this.type==="bigint"&&e!==null&&(e=String(e)),a[t?this.databaseName:this.propertyName]=e,a)};return r(n,{})}else return(this.generationStrategy==="increment"||this.generationStrategy==="rowid")&&this.type==="bigint"&&e!==null&&(e=String(e)),{[t?this.databaseName:this.propertyName]:e}}getEntityValueMap(e,t){var r;if(this.embeddedMetadata){const i=[...this.embeddedMetadata.parentPropertyNames],a=this.embeddedMetadata.isArray,o=(h,d)=>{if(d===void 0)return{};const p=h.shift();if(p){const m=o(h,d[p]);return Object.keys(m).length>0?{[p]:m}:{}}return a&&Array.isArray(d)?d.map(m=>({[this.propertyName]:m[this.propertyName]})):d[this.propertyName]!==void 0?{[this.propertyName]:d[this.propertyName]}:{}},l=o(i,e);return Object.keys(l).length>0?l:void 0}else if(this.relationMetadata&&!((r=Object.getOwnPropertyDescriptor(e,this.relationMetadata.propertyName))!=null&&r.get)&&e[this.relationMetadata.propertyName]&&Re.isObject(e[this.relationMetadata.propertyName])){if(this.relationMetadata.joinColumns.length>1){const i=this.relationMetadata.joinColumns.reduce((a,o)=>{const l=o.referencedColumn.getEntityValueMap(e[this.relationMetadata.propertyName]);return l===void 0?a:re.mergeDeep(a,l)},{});if(Object.keys(i).length>0)return{[this.propertyName]:i}}else{const i=this.relationMetadata.joinColumns[0].referencedColumn.getEntityValue(e[this.relationMetadata.propertyName]);if(i)return{[this.propertyName]:i}}return}else return e[this.propertyName]!==void 0?{[this.propertyName]:e[this.propertyName]}:void 0}getEntityValue(e,t=!1){if(e==null)return;let n;if(this.embeddedMetadata){const r=[...this.embeddedMetadata.parentPropertyNames],i=this.embeddedMetadata.isArray,a=(l,h)=>{const d=l.shift();return d&&h?a(l,h[d]):h},o=a(r,e);if(o)if(this.relationMetadata&&this.referencedColumn){const l=this.relationMetadata.getEntityValue(o);l&&Re.isObject(l)&&!B.isFindOperator(l)&&!Buffer.isBuffer(l)?n=this.referencedColumn.getEntityValue(l):o[this.propertyName]&&Re.isObject(o[this.propertyName])&&!B.isFindOperator(o[this.propertyName])&&!Buffer.isBuffer(o[this.propertyName])&&!(o[this.propertyName]instanceof Date)?n=this.referencedColumn.getEntityValue(o[this.propertyName]):n=o[this.propertyName]}else this.referencedColumn?n=this.referencedColumn.getEntityValue(o[this.propertyName]):i&&Array.isArray(o)?n=o.map(l=>l[this.propertyName]):n=o[this.propertyName]}else if(this.relationMetadata&&this.referencedColumn){const r=this.relationMetadata.getEntityValue(e);r&&Re.isObject(r)&&!B.isFindOperator(r)&&typeof r!="function"&&!Buffer.isBuffer(r)?n=this.referencedColumn.getEntityValue(r):e[this.propertyName]&&Re.isObject(e[this.propertyName])&&!B.isFindOperator(e[this.propertyName])&&typeof e[this.propertyName]!="function"&&!Buffer.isBuffer(e[this.propertyName])&&!(e[this.propertyName]instanceof Date)?n=this.referencedColumn.getEntityValue(e[this.propertyName]):n=e[this.propertyName]}else this.referencedColumn?n=this.referencedColumn.getEntityValue(e[this.propertyName]):n=e[this.propertyName];return t&&this.transformer&&(n=It.transformTo(this.transformer,n)),n}setEntityValue(e,t){if(this.embeddedMetadata){const n=(r,i)=>{const a=r.shift();return a?(i[a.propertyName]||(i[a.propertyName]=a.create()),n(r,i[a.propertyName]),i):(i[this.propertyName]=t,i)};return n([...this.embeddedMetadata.embeddedMetadataTree],e)}else!this.entityMetadata.isJunction&&this.isVirtual&&this.referencedColumn&&this.referencedColumn.propertyName!==this.propertyName?(this.propertyName in e||(e[this.propertyName]={}),e[this.propertyName][this.referencedColumn.propertyName]=t):e[this.propertyName]=t}compareEntityValue(e,t){const n=this.getEntityValue(e);return typeof(n==null?void 0:n.equals)=="function"?n.equals(t):n===t}build(e){return this.propertyPath=this.buildPropertyPath(),this.propertyAliasName=this.propertyPath.replace(".","_"),this.databaseName=this.buildDatabaseName(e),this.databasePath=this.buildDatabasePath(),this.databaseNameWithoutPrefixes=e.namingStrategy.columnName(this.propertyName,this.givenDatabaseName,[]),this}buildPropertyPath(){let e="";return this.embeddedMetadata&&this.embeddedMetadata.parentPropertyNames.length&&(e=this.embeddedMetadata.parentPropertyNames.join(".")+"."),e+=this.propertyName,!this.entityMetadata.isJunction&&this.isVirtual&&this.referencedColumn&&this.referencedColumn.propertyName!==this.propertyName&&(e+="."+this.referencedColumn.propertyName),e}buildDatabasePath(){let e="";return this.embeddedMetadata&&this.embeddedMetadata.parentPropertyNames.length&&(e=this.embeddedMetadata.parentPropertyNames.join(".")+"."),e+=this.databaseName,!this.entityMetadata.isJunction&&this.isVirtual&&this.referencedColumn&&this.referencedColumn.databaseName!==this.databaseName&&(e+="."+this.referencedColumn.databaseName),e}buildDatabaseName(e){let t=this.embeddedMetadata?this.embeddedMetadata.parentPrefixes:[];return e.driver.options.type==="mongodb"&&(t=[]),e.namingStrategy.columnName(this.propertyName,this.givenDatabaseName,t)}}class Yn{constructor(e){this.isUnique=!1,this.isSpatial=!1,this.isFulltext=!1,this.isNullFiltered=!1,this.synchronize=!0,this.columns=[],this.columnNamesWithOrderingMap={},this.entityMetadata=e.entityMetadata,this.embeddedMetadata=e.embeddedMetadata,e.columns&&(this.columns=e.columns),e.args&&(this.target=e.args.target,e.args.synchronize!==null&&e.args.synchronize!==void 0&&(this.synchronize=e.args.synchronize),this.isUnique=!!e.args.unique,this.isSpatial=!!e.args.spatial,this.isFulltext=!!e.args.fulltext,this.isNullFiltered=!!e.args.nullFiltered,this.parser=e.args.parser,this.where=e.args.where,this.isSparse=e.args.sparse,this.isBackground=e.args.background,this.isConcurrent=e.args.concurrent,this.expireAfterSeconds=e.args.expireAfterSeconds,this.givenName=e.args.name,this.givenColumnNames=e.args.columns)}build(e){if(this.synchronize===!1)return this.name=this.givenName,this;const t={};if(this.givenColumnNames){let n=[];if(Array.isArray(this.givenColumnNames))n=this.givenColumnNames.map(r=>this.embeddedMetadata?this.embeddedMetadata.propertyPath+"."+r:r.trim()),n.forEach(r=>t[r]=1);else{const r=this.givenColumnNames(this.entityMetadata.propertiesMap);Array.isArray(r)?(n=r.map(i=>String(i)),n.forEach(i=>t[i]=1)):(n=Object.keys(r).map(i=>String(i)),Object.keys(r).forEach(i=>t[i]=r[i]))}this.columns=n.map(r=>{const i=this.entityMetadata.columns.find(h=>h.propertyPath===r);if(i)return[i];const a=this.entityMetadata.relations.find(h=>h.isWithJoinColumn&&h.propertyName===r);if(a)return a.joinColumns;const o=this.givenName?'"'+this.givenName+'" ':"",l=this.entityMetadata.targetName;throw new x(`Index ${o}contains column that is missing in the entity (${l}): `+r)}).reduce((r,i)=>r.concat(i))}return this.columnNamesWithOrderingMap=Object.keys(t).reduce((n,r)=>{const i=this.entityMetadata.columns.find(a=>a.propertyPath===r);return i&&(n[i.databasePath]=t[r]),n},{}),this.name=this.givenName?this.givenName:e.indexName(this.entityMetadata.tableName,this.columns.map(n=>n.databaseName),this.where),this}}class Gp{constructor(e){this.isTreeParent=!1,this.isTreeChildren=!1,this.isPrimary=!1,this.isLazy=!1,this.isEager=!1,this.persistenceEnabled=!0,this.isCascadeInsert=!1,this.isCascadeUpdate=!1,this.isCascadeRemove=!1,this.isCascadeSoftRemove=!1,this.isCascadeRecover=!1,this.isNullable=!0,this.createForeignKeyConstraints=!0,this.isOwning=!1,this.isOneToOne=!1,this.isOneToOneOwner=!1,this.isWithJoinColumn=!1,this.isOneToOneNotOwner=!1,this.isOneToMany=!1,this.isManyToOne=!1,this.isManyToMany=!1,this.isManyToManyOwner=!1,this.isManyToManyNotOwner=!1,this.foreignKeys=[],this.joinColumns=[],this.inverseJoinColumns=[],this.entityMetadata=e.entityMetadata,this.embeddedMetadata=e.embeddedMetadata;const t=e.args;this.target=t.target,this.propertyName=t.propertyName,this.relationType=t.relationType,t.inverseSideProperty&&(this.givenInverseSidePropertyFactory=t.inverseSideProperty),this.isLazy=t.isLazy||!1,this.isCascadeInsert=t.options.cascade===!0||Array.isArray(t.options.cascade)&&t.options.cascade.indexOf("insert")!==-1,this.isCascadeUpdate=t.options.cascade===!0||Array.isArray(t.options.cascade)&&t.options.cascade.indexOf("update")!==-1,this.isCascadeRemove=t.options.cascade===!0||Array.isArray(t.options.cascade)&&t.options.cascade.indexOf("remove")!==-1,this.isCascadeSoftRemove=t.options.cascade===!0||Array.isArray(t.options.cascade)&&t.options.cascade.indexOf("soft-remove")!==-1,this.isCascadeRecover=t.options.cascade===!0||Array.isArray(t.options.cascade)&&t.options.cascade.indexOf("recover")!==-1,this.isNullable=!(t.options.nullable===!1||this.isPrimary),this.onDelete=t.options.onDelete,this.onUpdate=t.options.onUpdate,this.deferrable=t.options.deferrable,this.createForeignKeyConstraints=t.options.createForeignKeyConstraints!==!1,this.isEager=t.options.eager||!1,this.persistenceEnabled=t.options.persistence!==!1,this.orphanedRowAction=t.options.orphanedRowAction||"nullify",this.isTreeParent=t.isTreeParent||!1,this.isTreeChildren=t.isTreeChildren||!1,typeof t.type=="function"?this.type=typeof t.type=="function"?t.type():t.type:B.isEntitySchema(t.type)?this.type=t.type.options.name:Re.isObject(t.type)&&typeof t.type.name=="string"?this.type=t.type.name:this.type=t.type,this.isOneToOne=this.relationType==="one-to-one",this.isOneToMany=this.relationType==="one-to-many",this.isManyToOne=this.relationType==="many-to-one",this.isManyToMany=this.relationType==="many-to-many",this.isOneToOneNotOwner=!!this.isOneToOne,this.isManyToManyNotOwner=!!this.isManyToMany}getRelationIdMap(e){const n=(this.isOwning?this.joinColumns:this.inverseRelation.joinColumns).map(r=>r.referencedColumn);return Xn.getValueMap(e,n)}ensureRelationIdMap(e){if(Re.isObject(e))return e;const n=(this.isOwning?this.joinColumns:this.inverseRelation.joinColumns).map(r=>r.referencedColumn);if(n.length>1)throw new x("Cannot create relation id map for a single value because relation contains multiple referenced columns.");return n[0].createValueMap(e)}getEntityValue(e,t=!1){if(e!=null)if(this.embeddedMetadata){const n=[...this.embeddedMetadata.parentPropertyNames],r=(a,o)=>{const l=a.shift();return l?o[l]?r(a,o[l]):void 0:o},i=r(n,e);return this.isLazy?i["__"+this.propertyName+"__"]!==void 0?i["__"+this.propertyName+"__"]:t===!0?i[this.propertyName]:void 0:i?i[this.isLazy?"__"+this.propertyName+"__":this.propertyName]:void 0}else return this.isLazy?e["__"+this.propertyName+"__"]!==void 0?e["__"+this.propertyName+"__"]:t===!0?e[this.propertyName]:void 0:e[this.propertyName]}setEntityValue(e,t){const n=this.isLazy?"__"+this.propertyName+"__":this.propertyName;if(this.embeddedMetadata){const r=(i,a)=>{const o=i.shift();return o?(a[o.propertyName]||(a[o.propertyName]=o.create()),r(i,a[o.propertyName]),a):(a[n]=t,a)};return r([...this.embeddedMetadata.embeddedMetadataTree],e)}else e[n]=t}createValueMap(e){if(this.embeddedMetadata){const t=[...this.embeddedMetadata.parentPropertyNames],n=(r,i)=>{const a=r.shift();return a?(i[a]={},n(r,i[a]),i):(i[this.propertyName]=e,i)};return n(t,{})}else return{[this.propertyName]:e}}build(){this.propertyPath=this.buildPropertyPath()}registerForeignKeys(...e){this.foreignKeys.push(...e)}registerJoinColumns(e=[],t=[]){this.joinColumns=e,this.inverseJoinColumns=t,this.isOwning=this.isManyToOne||(this.isManyToMany||this.isOneToOne)&&this.joinColumns.length>0,this.isOneToOneOwner=this.isOneToOne&&this.isOwning,this.isOneToOneNotOwner=this.isOneToOne&&!this.isOwning,this.isManyToManyOwner=this.isManyToMany&&this.isOwning,this.isManyToManyNotOwner=this.isManyToMany&&!this.isOwning,this.isWithJoinColumn=this.isManyToOne||this.isOneToOneOwner}registerJunctionEntityMetadata(e){this.junctionEntityMetadata=e,this.joinTableName=e.tableName,this.inverseRelation&&(this.inverseRelation.junctionEntityMetadata=e,this.joinTableName=e.tableName)}buildInverseSidePropertyPath(){if(this.givenInverseSidePropertyFactory){const e=this.inverseEntityMetadata.propertiesMap;if(typeof this.givenInverseSidePropertyFactory=="function")return this.givenInverseSidePropertyFactory(e);if(typeof this.givenInverseSidePropertyFactory=="string")return this.givenInverseSidePropertyFactory}else{if(this.isTreeParent&&this.entityMetadata.treeChildrenRelation)return this.entityMetadata.treeChildrenRelation.propertyName;if(this.isTreeChildren&&this.entityMetadata.treeParentRelation)return this.entityMetadata.treeParentRelation.propertyName}return""}buildPropertyPath(){return!this.embeddedMetadata||!this.embeddedMetadata.parentPropertyNames.length?this.propertyName:this.embeddedMetadata.parentPropertyNames.join(".")+"."+this.propertyName}}class oM{constructor(e){this.columns=[],this.relations=[],this.listeners=[],this.indices=[],this.uniques=[],this.relationIds=[],this.relationCounts=[],this.embeddeds=[],this.isAlwaysUsingConstructor=!0,this.isArray=!1,this.parentPropertyNames=[],this.parentPrefixes=[],this.embeddedMetadataTree=[],this.columnsFromTree=[],this.relationsFromTree=[],this.listenersFromTree=[],this.indicesFromTree=[],this.uniquesFromTree=[],this.relationIdsFromTree=[],this.relationCountsFromTree=[],this.entityMetadata=e.entityMetadata,this.type=e.args.type(),this.propertyName=e.args.propertyName,this.customPrefix=e.args.prefix,this.isArray=e.args.isArray}create(e){return typeof this.type!="function"?{}:e!=null&&e.fromDeserializer||!this.isAlwaysUsingConstructor?Object.create(this.type.prototype):new this.type}build(e){return this.embeddeds.forEach(t=>t.build(e)),this.prefix=this.buildPrefix(e),this.parentPropertyNames=this.buildParentPropertyNames(),this.parentPrefixes=this.buildParentPrefixes(),this.propertyPath=this.parentPropertyNames.join("."),this.embeddedMetadataTree=this.buildEmbeddedMetadataTree(),this.columnsFromTree=this.buildColumnsFromTree(),this.relationsFromTree=this.buildRelationsFromTree(),this.listenersFromTree=this.buildListenersFromTree(),this.indicesFromTree=this.buildIndicesFromTree(),this.uniquesFromTree=this.buildUniquesFromTree(),this.relationIdsFromTree=this.buildRelationIdsFromTree(),this.relationCountsFromTree=this.buildRelationCountsFromTree(),e.options.entitySkipConstructor&&(this.isAlwaysUsingConstructor=!e.options.entitySkipConstructor),this}buildPartialPrefix(){if(this.customPrefix===void 0||this.customPrefix===!0)return[this.propertyName];if(this.customPrefix===""||this.customPrefix===!1)return[];if(typeof this.customPrefix=="string")return[this.customPrefix];throw new x(`Invalid prefix option given for ${this.entityMetadata.targetName}#${this.propertyName}`)}buildPrefix(e){if(e.driver.options.type==="mongodb")return this.propertyName;const t=[];return this.parentEmbeddedMetadata&&t.push(this.parentEmbeddedMetadata.buildPrefix(e)),t.push(...this.buildPartialPrefix()),t.join("_")}buildParentPropertyNames(){return this.parentEmbeddedMetadata?this.parentEmbeddedMetadata.buildParentPropertyNames().concat(this.propertyName):[this.propertyName]}buildParentPrefixes(){return this.parentEmbeddedMetadata?this.parentEmbeddedMetadata.buildParentPrefixes().concat(this.buildPartialPrefix()):this.buildPartialPrefix()}buildEmbeddedMetadataTree(){return this.parentEmbeddedMetadata?this.parentEmbeddedMetadata.buildEmbeddedMetadataTree().concat(this):[this]}buildColumnsFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildColumnsFromTree()),this.columns)}buildRelationsFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildRelationsFromTree()),this.relations)}buildListenersFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildListenersFromTree()),this.listeners)}buildIndicesFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildIndicesFromTree()),this.indices)}buildUniquesFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildUniquesFromTree()),this.uniques)}buildRelationIdsFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildRelationIdsFromTree()),this.relationIds)}buildRelationCountsFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildRelationCountsFromTree()),this.relationCounts)}}class zp{constructor(e){this.entityMetadata=e.entityMetadata,this.target=e.args.target,this.propertyName=e.args.propertyName,this.relationNameOrFactory=e.args.relation,this.alias=e.args.alias,this.queryBuilderFactory=e.args.queryBuilderFactory}setValue(e){const t=this.relation.getEntityValue(e);if(Array.isArray(t))e[this.propertyName]=t.map(n=>this.relation.inverseEntityMetadata.getEntityIdMixedMap(n)).filter(n=>n!=null);else{const n=this.relation.inverseEntityMetadata.getEntityIdMixedMap(t);n!==void 0&&(e[this.propertyName]=n)}}build(){const e=typeof this.relationNameOrFactory=="function"?this.relationNameOrFactory(this.entityMetadata.propertiesMap):this.relationNameOrFactory,t=this.entityMetadata.findRelationWithPropertyPath(e);if(!t)throw new x(`Cannot find relation ${e}. Wrong relation specified for @RelationId decorator.`);this.relation=t}}class Kp{constructor(e){this.entityMetadata=e.entityMetadata,this.target=e.args.target,this.propertyName=e.args.propertyName,this.relationNameOrFactory=e.args.relation,this.alias=e.args.alias,this.queryBuilderFactory=e.args.queryBuilderFactory}build(){const e=typeof this.relationNameOrFactory=="function"?this.relationNameOrFactory(this.entityMetadata.propertiesMap):this.relationNameOrFactory,t=this.entityMetadata.findRelationWithPropertyPath(e);if(!t)throw new x(`Cannot find relation ${e}. Wrong relation specified for @RelationCount decorator.`);this.relation=t}}class At{}At.AFTER_LOAD="after-load";At.BEFORE_INSERT="before-insert";At.AFTER_INSERT="after-insert";At.BEFORE_UPDATE="before-update";At.AFTER_UPDATE="after-update";At.BEFORE_REMOVE="before-remove";At.AFTER_REMOVE="after-remove";At.BEFORE_SOFT_REMOVE="before-soft-remove";At.AFTER_SOFT_REMOVE="after-soft-remove";At.BEFORE_RECOVER="before-recover";At.AFTER_RECOVER="after-recover";class os{constructor(e){this.columns=[],this.referencedColumns=[],this.columnNames=[],this.referencedColumnNames=[],this.entityMetadata=e.entityMetadata,this.referencedEntityMetadata=e.referencedEntityMetadata,this.columns=e.columns,this.referencedColumns=e.referencedColumns,this.onDelete=e.onDelete||"NO ACTION",this.onUpdate=e.onUpdate||"NO ACTION",this.deferrable=e.deferrable,this.givenName=e.name,e.namingStrategy&&this.build(e.namingStrategy)}build(e){this.columnNames=this.columns.map(t=>t.databaseName),this.referencedColumnNames=this.referencedColumns.map(t=>t.databaseName),this.referencedTablePath=this.referencedEntityMetadata.tablePath,this.name=this.givenName?this.givenName:e.foreignKeyName(this.entityMetadata.tableName,this.columnNames,this.referencedEntityMetadata.tableName,this.referencedColumnNames)}}class cM{constructor(e){this.connection=e}build(e,t){var h,d;const n=this.collectReferencedColumns(e,t),r=this.collectInverseReferencedColumns(e,t),i=t.name||this.connection.namingStrategy.joinTableName(e.entityMetadata.tableNameWithoutPrefix,e.inverseEntityMetadata.tableNameWithoutPrefix,e.propertyPath,e.inverseRelation?e.inverseRelation.propertyName:""),a=new Xn({connection:this.connection,args:{target:"",name:i,type:"junction",database:t.database||e.entityMetadata.database,schema:t.schema||e.entityMetadata.schema,synchronize:t.synchronize}});a.build();const o=n.map(p=>{const m=t.joinColumns?t.joinColumns.find(b=>(!b.referencedColumnName||b.referencedColumnName===p.propertyName)&&!!b.name):void 0,w=m&&m.name?m.name:this.connection.namingStrategy.joinTableColumnName(e.entityMetadata.tableNameWithoutPrefix,p.propertyName,p.databaseName);return new Pn({connection:this.connection,entityMetadata:a,referencedColumn:p,args:{target:"",mode:"virtual",propertyName:w,options:{name:w,length:!p.length&&(ie.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&this.connection.driver.normalizeType(p)!=="uuid"&&(p.generationStrategy==="uuid"||p.type==="uuid")?"36":p.length,width:p.width,type:p.type,precision:p.precision,scale:p.scale,charset:p.charset,collation:p.collation,zerofill:p.zerofill,unsigned:p.zerofill?!0:p.unsigned,enum:p.enum,enumName:p.enumName,foreignKeyConstraintName:m==null?void 0:m.foreignKeyConstraintName,nullable:!1,primary:!0}}})}),l=r.map(p=>{const m=t.inverseJoinColumns?t.inverseJoinColumns.find(b=>(!b.referencedColumnName||b.referencedColumnName===p.propertyName)&&!!b.name):void 0,w=m&&m.name?m.name:this.connection.namingStrategy.joinTableInverseColumnName(e.inverseEntityMetadata.tableNameWithoutPrefix,p.propertyName,p.databaseName);return new Pn({connection:this.connection,entityMetadata:a,referencedColumn:p,args:{target:"",mode:"virtual",propertyName:w,options:{length:!p.length&&(ie.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&this.connection.driver.normalizeType(p)!=="uuid"&&(p.generationStrategy==="uuid"||p.type==="uuid")?"36":p.length,width:p.width,type:p.type,precision:p.precision,scale:p.scale,charset:p.charset,collation:p.collation,zerofill:p.zerofill,unsigned:p.zerofill?!0:p.unsigned,enum:p.enum,enumName:p.enumName,foreignKeyConstraintName:m==null?void 0:m.foreignKeyConstraintName,name:w,nullable:!1,primary:!0}}})});return this.changeDuplicatedColumnNames(o,l),a.ownerColumns=o,a.inverseColumns=l,a.ownColumns=[...o,...l],a.ownColumns.forEach(p=>p.relationMetadata=e),a.foreignKeys=e.createForeignKeyConstraints?[new os({entityMetadata:a,referencedEntityMetadata:e.entityMetadata,columns:o,referencedColumns:n,name:(h=o[0])==null?void 0:h.foreignKeyConstraintName,onDelete:this.connection.driver.options.type==="spanner"?"NO ACTION":e.onDelete||"CASCADE",onUpdate:this.connection.driver.options.type==="oracle"||this.connection.driver.options.type==="spanner"?"NO ACTION":e.onUpdate||"CASCADE"}),new os({entityMetadata:a,referencedEntityMetadata:e.inverseEntityMetadata,columns:l,referencedColumns:r,name:(d=l[0])==null?void 0:d.foreignKeyConstraintName,onDelete:this.connection.driver.options.type==="spanner"?"NO ACTION":e.inverseRelation?e.inverseRelation.onDelete:"CASCADE",onUpdate:this.connection.driver.options.type==="oracle"||this.connection.driver.options.type==="spanner"?"NO ACTION":e.inverseRelation?e.inverseRelation.onUpdate:"CASCADE"})]:[],a.ownIndices=[new Yn({entityMetadata:a,columns:o,args:{target:a.target,synchronize:!0}}),new Yn({entityMetadata:a,columns:l,args:{target:a.target,synchronize:!0}})],a}collectReferencedColumns(e,t){const n=t.joinColumns?t.joinColumns.find(r=>!!r.referencedColumnName):!1;return!t.joinColumns||t.joinColumns&&!n?e.entityMetadata.columns.filter(r=>r.isPrimary):t.joinColumns.map(r=>{const i=e.entityMetadata.columns.find(a=>a.propertyName===r.referencedColumnName);if(!i)throw new x(`Referenced column ${r.referencedColumnName} was not found in entity ${e.entityMetadata.name}`);return i})}collectInverseReferencedColumns(e,t){const n=!!t.inverseJoinColumns,r=n?t.inverseJoinColumns.find(i=>!!i.referencedColumnName):!1;return!n||n&&!r?e.inverseEntityMetadata.primaryColumns:t.inverseJoinColumns.map(i=>{const a=e.inverseEntityMetadata.ownColumns.find(o=>o.propertyName===i.referencedColumnName);if(!a)throw new x(`Referenced column ${i.referencedColumnName} was not found in entity ${e.inverseEntityMetadata.name}`);return a})}changeDuplicatedColumnNames(e,t){e.forEach(n=>{t.forEach(r=>{if(n.givenDatabaseName===r.givenDatabaseName){const i=this.connection.namingStrategy.joinTableColumnDuplicationPrefix(n.propertyName,1);n.propertyName=i,n.givenDatabaseName=i;const a=this.connection.namingStrategy.joinTableColumnDuplicationPrefix(r.propertyName,2);r.propertyName=a,r.givenDatabaseName=a}})})}}class uM{constructor(e){this.connection=e}build(e){const t=new Xn({parentClosureEntityMetadata:e,connection:this.connection,args:{target:"",name:e.treeOptions&&e.treeOptions.closureTableName?e.treeOptions.closureTableName:e.tableNameWithoutPrefix,type:"closure-junction"}});return t.build(),e.primaryColumns.forEach(n=>{t.ownColumns.push(new Pn({connection:this.connection,entityMetadata:t,closureType:"ancestor",referencedColumn:n,args:{target:"",mode:"virtual",propertyName:e.treeOptions&&e.treeOptions.ancestorColumnName?e.treeOptions.ancestorColumnName(n):n.propertyName+"_ancestor",options:{primary:!0,length:n.length,type:n.type,unsigned:n.unsigned,width:n.width,precision:n.precision,scale:n.scale,zerofill:n.zerofill,charset:n.charset,collation:n.collation}}})),t.ownColumns.push(new Pn({connection:this.connection,entityMetadata:t,closureType:"descendant",referencedColumn:n,args:{target:"",mode:"virtual",propertyName:e.treeOptions&&e.treeOptions.descendantColumnName?e.treeOptions.descendantColumnName(n):n.propertyName+"_descendant",options:{primary:!0,length:n.length,type:n.type,unsigned:n.unsigned,width:n.width,precision:n.precision,scale:n.scale,zerofill:n.zerofill,charset:n.charset,collation:n.collation}}}))}),t.ownIndices=[new Yn({entityMetadata:t,columns:[t.ownColumns[0]],args:{target:t.target,synchronize:!0}}),new Yn({entityMetadata:t,columns:[t.ownColumns[1]],args:{target:t.target,synchronize:!0}})],e.treeLevelColumn&&t.ownColumns.push(new Pn({connection:this.connection,entityMetadata:t,args:{target:"",mode:"virtual",propertyName:"level",options:{type:this.connection.driver.mappedDataTypes.treeLevel}}})),t.foreignKeys=[new os({entityMetadata:t,referencedEntityMetadata:e,columns:[t.ownColumns[0]],referencedColumns:e.primaryColumns,onDelete:this.connection.driver.options.type==="mssql"?"NO ACTION":"CASCADE"}),new os({entityMetadata:t,referencedEntityMetadata:e,columns:[t.ownColumns[1]],referencedColumns:e.primaryColumns,onDelete:this.connection.driver.options.type==="mssql"?"NO ACTION":"CASCADE"})],t}}class To{constructor(e){this.columns=[],this.columnNamesWithOrderingMap={},this.entityMetadata=e.entityMetadata,this.embeddedMetadata=e.embeddedMetadata,e.columns&&(this.columns=e.columns),e.args&&(this.target=e.args.target,this.givenName=e.args.name,this.givenColumnNames=e.args.columns,this.deferrable=e.args.deferrable)}build(e){const t={};if(this.givenColumnNames){let n=[];if(Array.isArray(this.givenColumnNames))n=this.givenColumnNames.map(r=>this.embeddedMetadata?this.embeddedMetadata.propertyPath+"."+r:r.trim()),n.forEach(r=>t[r]=1);else{const r=this.givenColumnNames(this.entityMetadata.propertiesMap);Array.isArray(r)?(n=r.map(i=>String(i)),n.forEach(i=>t[i]=1)):(n=Object.keys(r).map(i=>String(i)),Object.keys(r).forEach(i=>t[i]=r[i]))}this.columns=n.map(r=>{const i=this.entityMetadata.columns.find(h=>h.propertyPath===r);if(i)return[i];const a=this.entityMetadata.relations.find(h=>h.isWithJoinColumn&&h.propertyName===r);if(a)return a.joinColumns;const o=this.givenName?'"'+this.givenName+'" ':"",l=this.entityMetadata.targetName;throw new x(`Unique constraint ${o}contains column that is missing in the entity (${l}): `+r)}).reduce((r,i)=>r.concat(i))}return this.columnNamesWithOrderingMap=Object.keys(t).reduce((n,r)=>{const i=this.entityMetadata.columns.find(a=>a.propertyPath===r);return i&&(n[i.databasePath]=t[r]),n},{}),this.name=this.givenName?this.givenName:e.uniqueConstraintName(this.entityMetadata.tableName,this.columns.map(n=>n.databaseName)),this}}class lM{constructor(e){this.connection=e}build(e,t){var o;const n=this.collectReferencedColumns(e,t),r=this.collectColumns(e,t,n);if(!n.length||!t.createForeignKeyConstraints)return{foreignKey:void 0,columns:r,uniqueConstraint:void 0};const i=new os({name:(o=e[0])==null?void 0:o.foreignKeyConstraintName,entityMetadata:t.entityMetadata,referencedEntityMetadata:t.inverseEntityMetadata,namingStrategy:this.connection.namingStrategy,columns:r,referencedColumns:n,onDelete:t.onDelete,onUpdate:t.onUpdate,deferrable:t.deferrable});if(r.every(l=>l.isPrimary)||!t.isOneToOne)return{foreignKey:i,columns:r,uniqueConstraint:void 0};const a=new To({entityMetadata:t.entityMetadata,columns:i.columns,args:{name:this.connection.namingStrategy.relationConstraintName(t.entityMetadata.tableName,i.columns.map(l=>l.databaseName)),target:t.entityMetadata.target}});return a.build(this.connection.namingStrategy),{foreignKey:i,columns:r,uniqueConstraint:a}}collectReferencedColumns(e,t){const n=e.find(a=>!!a.referencedColumnName),r=e.length===0&&t.isManyToOne,i=e.length>0&&!n;return r||i?t.inverseEntityMetadata.primaryColumns:e.map(a=>{const o=t.inverseEntityMetadata.ownColumns.find(l=>l.propertyName===a.referencedColumnName);if(!o)throw new x(`Referenced column ${a.referencedColumnName} was not found in entity ${t.inverseEntityMetadata.name}`);return o})}collectColumns(e,t,n){return n.map(r=>{const i=e.find(h=>(!h.referencedColumnName||h.referencedColumnName===r.propertyName)&&!!h.name),a=i?i.name:this.connection.namingStrategy.joinColumnName(t.propertyName,r.propertyName);let l=(t.embeddedMetadata?t.embeddedMetadata.columns:t.entityMetadata.ownColumns).find(h=>h.databaseNameWithoutPrefixes===a);return l?l.referencedColumn&&(l=re.cloneObject(l)):(l=new Pn({connection:this.connection,entityMetadata:t.entityMetadata,embeddedMetadata:t.embeddedMetadata,args:{target:"",mode:"virtual",propertyName:t.propertyName,options:{name:a,type:r.type,length:!r.length&&(ie.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&this.connection.driver.normalizeType(r)!=="uuid"&&(r.generationStrategy==="uuid"||r.type==="uuid")?"36":r.length,width:r.width,charset:r.charset,collation:r.collation,precision:r.precision,scale:r.scale,zerofill:r.zerofill,unsigned:r.unsigned,comment:r.comment,enum:r.enum,enumName:r.enumName,primary:t.isPrimary,nullable:t.isNullable}}}),t.entityMetadata.registerColumn(l)),l.referencedColumn=r,l.type=r.type,l.relationMetadata=t,l.build(this.connection),l})}}class Jp{constructor(e){this.entityMetadata=e.entityMetadata,this.embeddedMetadata=e.embeddedMetadata,this.target=e.args.target,this.propertyName=e.args.propertyName,this.type=e.args.type}isAllowed(e){return this.entityMetadata.target===e.constructor||typeof this.entityMetadata.target=="function"&&e.constructor.prototype instanceof this.entityMetadata.target}execute(e){if(!this.embeddedMetadata){const t=e[this.propertyName];if(!t)throw new Error(`Entity listener method "${this.propertyName}" does not exist in entity "${e.constructor.name}".`);if(typeof t!="function")throw new Error(`Entity listener method "${this.propertyName}" in entity "${e.constructor.name}" must be a function but got "${typeof t}".`);return t.call(e)}this.callEntityEmbeddedMethod(e,this.embeddedMetadata.propertyPath.split("."))}callEntityEmbeddedMethod(e,t){const n=t.shift();!n||!e[n]||(t.length===0?Array.isArray(e[n])?e[n].map(r=>r[this.propertyName]()):e[n][this.propertyName]():e[n]&&this.callEntityEmbeddedMethod(e[n],t))}}class hM{constructor(e){this.entityMetadata=e.entityMetadata,e.args&&(this.target=e.args.target,this.expression=e.args.expression,this.givenName=e.args.name)}build(e){return this.name=this.givenName?this.givenName:e.checkConstraintName(this.entityMetadata.tableName,this.expression),this}}class dM{constructor(e){this.entityMetadata=e.entityMetadata,e.args&&(this.target=e.args.target,this.expression=e.args.expression,this.givenName=e.args.name)}build(e){return this.name=this.givenName?this.givenName:e.exclusionConstraintName(this.entityMetadata.tableName,this.expression),this}}class Xp{constructor(e,t){this.connection=e,this.metadataArgsStorage=t,this.junctionEntityMetadataBuilder=new cM(e),this.closureJunctionEntityMetadataBuilder=new uM(e),this.relationJoinColumnBuilder=new lM(e)}build(e){const r=(e?this.metadataArgsStorage.filterTables(e):this.metadataArgsStorage.tables).filter(i=>i.type==="regular"||i.type==="closure"||i.type==="entity-child"||i.type==="view").map(i=>this.createEntityMetadata(i));return r.forEach(i=>this.computeParentEntityMetadata(r,i)),r.forEach(i=>{i.childEntityMetadatas=r.filter(a=>typeof i.target=="function"&&typeof a.target=="function"&&yo.isInherited(a.target,i.target))}),r.filter(i=>i.tableType!=="entity-child").forEach(i=>i.build()),r.filter(i=>i.tableType==="entity-child").forEach(i=>i.build()),r.filter(i=>i.tableType!=="entity-child").forEach(i=>this.computeEntityMetadataStep1(r,i)),r.filter(i=>i.tableType==="entity-child").forEach(i=>this.computeEntityMetadataStep1(r,i)),r.forEach(i=>this.computeEntityMetadataStep2(i)),r.forEach(i=>this.computeInverseProperties(i,r)),r.filter(i=>i.tableType!=="entity-child").forEach(i=>{i.relations.filter(a=>a.isOneToOne||a.isManyToOne).forEach(a=>{const o=this.metadataArgsStorage.filterJoinColumns(a.target,a.propertyName),{foreignKey:l,columns:h,uniqueConstraint:d}=this.relationJoinColumnBuilder.build(o,a);if(l&&(a.registerForeignKeys(l),i.foreignKeys.push(l)),h&&a.registerJoinColumns(h),d)if(ie.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"||this.connection.driver.options.type==="mssql"||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"){const p=new Yn({entityMetadata:d.entityMetadata,columns:d.columns,args:{target:d.target,name:d.name,unique:!0,synchronize:!0}});this.connection.driver.options.type==="mssql"&&(p.where=p.columns.map(m=>`${this.connection.driver.escape(m.databaseName)} IS NOT NULL`).join(" AND ")),this.connection.driver.options.type==="spanner"&&(p.isNullFiltered=!0),a.embeddedMetadata?a.embeddedMetadata.indices.push(p):a.entityMetadata.ownIndices.push(p),this.computeEntityMetadataStep2(i)}else a.embeddedMetadata?a.embeddedMetadata.uniques.push(d):a.entityMetadata.ownUniques.push(d),this.computeEntityMetadataStep2(i);if(l&&this.connection.driver.options.type==="cockroachdb"){const p=new Yn({entityMetadata:a.entityMetadata,columns:l.columns,args:{target:a.entityMetadata.target,synchronize:!0}});a.embeddedMetadata?a.embeddedMetadata.indices.push(p):a.entityMetadata.ownIndices.push(p),this.computeEntityMetadataStep2(i)}}),i.relations.filter(a=>a.isManyToMany).forEach(a=>{const o=this.metadataArgsStorage.findJoinTable(a.target,a.propertyName);if(!o)return;const l=this.junctionEntityMetadataBuilder.build(a,o);a.registerForeignKeys(...l.foreignKeys),a.registerJoinColumns(l.ownIndices[0].columns,l.ownIndices[1].columns),a.registerJunctionEntityMetadata(l),this.computeEntityMetadataStep2(l),this.computeInverseProperties(l,r),r.push(l)})}),r.forEach(i=>{i.relationsWithJoinColumns=i.relations.filter(a=>a.isWithJoinColumn),i.hasNonNullableRelations=i.relationsWithJoinColumns.some(a=>!a.isNullable||a.isPrimary)}),r.filter(i=>i.treeType==="closure-table").forEach(i=>{const a=this.closureJunctionEntityMetadataBuilder.build(i);i.closureJunctionTable=a,this.computeEntityMetadataStep2(a),this.computeInverseProperties(a,r),r.push(a)}),r.filter(i=>i.inheritancePattern==="STI"&&i.discriminatorColumn).forEach(i=>this.createKeysForTableInheritance(i)),r.forEach(i=>{i.indices.forEach(a=>a.build(this.connection.namingStrategy))}),r.forEach(i=>{i.uniques.forEach(a=>a.build(this.connection.namingStrategy))}),r.forEach(i=>{i.checks.forEach(a=>a.build(this.connection.namingStrategy))}),r.forEach(i=>{i.exclusions.forEach(a=>a.build(this.connection.namingStrategy))}),r.forEach(i=>this.createForeignKeys(i,r)),r.filter(i=>typeof i.target=="function").forEach(i=>{i.relations.filter(a=>a.isLazy).forEach(a=>{this.connection.relationLoader.enableLazyLoad(a,i.target.prototype)})}),r.forEach(i=>{i.columns.forEach(a=>{const o=this.metadataArgsStorage.findGenerated(a.target,a.propertyName);o&&(a.isGenerated=!0,a.generationStrategy=o.strategy,o.strategy==="uuid"?a.type="uuid":o.strategy==="rowid"?a.type="int":a.type=a.type||Number,a.build(this.connection),this.computeEntityMetadataStep2(i))})}),r}createEntityMetadata(e){const t=typeof e.target=="function"?yo.getInheritanceTree(e.target):[e.target],n=this.metadataArgsStorage.findInheritanceType(e.target),r=this.metadataArgsStorage.findTree(e.target);let i;return(n&&n.pattern==="STI"||e.type==="entity-child")&&(i=this.metadataArgsStorage.filterSingleTableChildren(e.target).map(a=>a.target).filter(a=>typeof a=="function"),t.push(...i)),new Xn({connection:this.connection,args:e,inheritanceTree:t,tableTree:r,inheritancePattern:n?n.pattern:void 0})}computeParentEntityMetadata(e,t){t.tableType==="entity-child"&&(t.parentEntityMetadata=e.find(n=>n.inheritanceTree.indexOf(t.target)!==-1&&n.inheritancePattern==="STI"))}computeEntityMetadataStep1(e,t){const n=this.metadataArgsStorage.findInheritanceType(t.target),r=this.metadataArgsStorage.findDiscriminatorValue(t.target);if(typeof r<"u"?t.discriminatorValue=r.value:t.discriminatorValue=t.target.name,t.embeddeds=this.createEmbeddedsRecursively(t,this.metadataArgsStorage.filterEmbeddeds(t.inheritanceTree)).map(a=>(t.inheritancePattern==="STI"&&(a.columns=a.columns.map(o=>(o.isNullable=!0,o))),a)),t.ownColumns=this.metadataArgsStorage.filterColumns(t.inheritanceTree).map(a=>{if(t.tableType==="entity-child")return t.parentEntityMetadata.ownColumns.find(h=>h.propertyName===a.propertyName);if(t.tableType==="regular"&&a.target!==t.target){const h=this.metadataArgsStorage.columns.find(d=>d.propertyName===a.propertyName&&d.target===t.target);h&&h.options.default&&(a.options.default=h.options.default)}const o=new Pn({connection:this.connection,entityMetadata:t,args:a});return e.find(h=>h.tableType==="entity-child"&&h.target===a.target)&&(o.isNullable=!0),o}),n&&n.column){const a=n.column&&n.column.name?n.column.name:"type";let o=t.ownColumns.find(l=>l.propertyName===a);o?o.isDiscriminator=!0:(o=new Pn({connection:this.connection,entityMetadata:t,args:{target:t.target,mode:"virtual",propertyName:a,options:n.column||{name:a,type:"varchar",nullable:!1}}}),o.isVirtual=!0,o.isDiscriminator=!0,t.ownColumns.push(o))}if(t.tableType==="entity-child"){const a=t.parentEntityMetadata.ownColumns.find(o=>o.isDiscriminator);a&&!t.ownColumns.find(o=>o===a)&&t.ownColumns.push(a),t.inheritancePattern=t.parentEntityMetadata.inheritancePattern,!t.treeType&&t.parentEntityMetadata.treeType&&(t.treeType=t.parentEntityMetadata.treeType,t.treeOptions=t.parentEntityMetadata.treeOptions,t.treeParentRelation=t.parentEntityMetadata.treeParentRelation,t.treeLevelColumn=t.parentEntityMetadata.treeLevelColumn)}const{namingStrategy:i}=this.connection;if(t.treeType==="materialized-path")t.ownColumns.push(new Pn({connection:this.connection,entityMetadata:t,materializedPath:!0,args:{target:t.target,mode:"virtual",propertyName:"mpath",options:{name:i.materializedPathColumnName,type:String,nullable:!0,default:""}}}));else if(t.treeType==="nested-set"){const{left:a,right:o}=i.nestedSetColumnNames;t.ownColumns.push(new Pn({connection:this.connection,entityMetadata:t,nestedSetLeft:!0,args:{target:t.target,mode:"virtual",propertyName:a,options:{name:a,type:Number,nullable:!1,default:1}}})),t.ownColumns.push(new Pn({connection:this.connection,entityMetadata:t,nestedSetRight:!0,args:{target:t.target,mode:"virtual",propertyName:o,options:{name:o,type:Number,nullable:!1,default:2}}}))}if(t.ownRelations=this.metadataArgsStorage.filterRelations(t.inheritanceTree).map(a=>{if(t.tableType==="entity-child"){const o=t.parentEntityMetadata.ownRelations.find(h=>h.propertyName===a.propertyName),l=typeof a.type=="function"?a.type():a.type;if(o.type!==l){const h=Object.create(o);return h.type=l,h}return o}return new Gp({entityMetadata:t,args:a})}),t.relationIds=this.metadataArgsStorage.filterRelationIds(t.inheritanceTree).map(a=>t.tableType==="entity-child"?t.parentEntityMetadata.relationIds.find(o=>o.propertyName===a.propertyName):new zp({entityMetadata:t,args:a})),t.relationCounts=this.metadataArgsStorage.filterRelationCounts(t.inheritanceTree).map(a=>t.tableType==="entity-child"?t.parentEntityMetadata.relationCounts.find(o=>o.propertyName===a.propertyName):new Kp({entityMetadata:t,args:a})),t.ownListeners=this.metadataArgsStorage.filterListeners(t.inheritanceTree).map(a=>new Jp({entityMetadata:t,args:a})),t.checks=this.metadataArgsStorage.filterChecks(t.inheritanceTree).map(a=>new hM({entityMetadata:t,args:a})),this.connection.driver.options.type==="postgres"&&(t.exclusions=this.metadataArgsStorage.filterExclusions(t.inheritanceTree).map(a=>new dM({entityMetadata:t,args:a}))),this.connection.driver.options.type==="cockroachdb"){t.ownIndices=this.metadataArgsStorage.filterIndices(t.inheritanceTree).filter(o=>!o.unique).map(o=>new Yn({entityMetadata:t,args:o}));const a=this.metadataArgsStorage.filterIndices(t.inheritanceTree).filter(o=>o.unique).map(o=>new To({entityMetadata:t,args:{target:o.target,name:o.name,columns:o.columns}}));t.ownUniques.push(...a)}else t.ownIndices=this.metadataArgsStorage.filterIndices(t.inheritanceTree).map(a=>new Yn({entityMetadata:t,args:a}));if(ie.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"){const a=this.metadataArgsStorage.filterUniques(t.inheritanceTree).map(o=>new Yn({entityMetadata:t,args:{target:o.target,name:o.name,columns:o.columns,unique:!0,synchronize:!0}}));t.ownIndices.push(...a)}else{const a=this.metadataArgsStorage.filterUniques(t.inheritanceTree).map(o=>new To({entityMetadata:t,args:o}));t.ownUniques.push(...a)}}createEmbeddedsRecursively(e,t){return t.map(n=>{const r=new oM({entityMetadata:e,args:n}),i=typeof r.type=="function"?yo.getInheritanceTree(r.type):[r.type];return r.columns=this.metadataArgsStorage.filterColumns(i).map(a=>new Pn({connection:this.connection,entityMetadata:e,embeddedMetadata:r,args:a})),r.relations=this.metadataArgsStorage.filterRelations(i).map(a=>new Gp({entityMetadata:e,embeddedMetadata:r,args:a})),r.listeners=this.metadataArgsStorage.filterListeners(i).map(a=>new Jp({entityMetadata:e,embeddedMetadata:r,args:a})),r.indices=this.metadataArgsStorage.filterIndices(i).map(a=>new Yn({entityMetadata:e,embeddedMetadata:r,args:a})),r.uniques=this.metadataArgsStorage.filterUniques(i).map(a=>new To({entityMetadata:e,embeddedMetadata:r,args:a})),r.relationIds=this.metadataArgsStorage.filterRelationIds(i).map(a=>new zp({entityMetadata:e,args:a})),r.relationCounts=this.metadataArgsStorage.filterRelationCounts(i).map(a=>new Kp({entityMetadata:e,args:a})),r.embeddeds=this.createEmbeddedsRecursively(e,this.metadataArgsStorage.filterEmbeddeds(i)),r.embeddeds.forEach(a=>a.parentEmbeddedMetadata=r),e.allEmbeddeds.push(r),r})}computeEntityMetadataStep2(e){e.embeddeds.forEach(t=>t.build(this.connection)),e.embeddeds.forEach(t=>{t.columnsFromTree.forEach(n=>n.build(this.connection)),t.relationsFromTree.forEach(n=>n.build())}),e.ownColumns.forEach(t=>t.build(this.connection)),e.ownRelations.forEach(t=>t.build()),e.relations=e.embeddeds.reduce((t,n)=>t.concat(n.relationsFromTree),e.ownRelations),e.eagerRelations=e.relations.filter(t=>t.isEager),e.lazyRelations=e.relations.filter(t=>t.isLazy),e.oneToOneRelations=e.relations.filter(t=>t.isOneToOne),e.oneToManyRelations=e.relations.filter(t=>t.isOneToMany),e.manyToOneRelations=e.relations.filter(t=>t.isManyToOne),e.manyToManyRelations=e.relations.filter(t=>t.isManyToMany),e.ownerOneToOneRelations=e.relations.filter(t=>t.isOneToOneOwner),e.ownerManyToManyRelations=e.relations.filter(t=>t.isManyToManyOwner),e.treeParentRelation=e.relations.find(t=>t.isTreeParent),e.treeChildrenRelation=e.relations.find(t=>t.isTreeChildren),e.columns=e.embeddeds.reduce((t,n)=>t.concat(n.columnsFromTree),e.ownColumns),e.listeners=e.embeddeds.reduce((t,n)=>t.concat(n.listenersFromTree),e.ownListeners),e.afterLoadListeners=e.listeners.filter(t=>t.type===At.AFTER_LOAD),e.afterInsertListeners=e.listeners.filter(t=>t.type===At.AFTER_INSERT),e.afterUpdateListeners=e.listeners.filter(t=>t.type===At.AFTER_UPDATE),e.afterRemoveListeners=e.listeners.filter(t=>t.type===At.AFTER_REMOVE),e.afterSoftRemoveListeners=e.listeners.filter(t=>t.type===At.AFTER_SOFT_REMOVE),e.afterRecoverListeners=e.listeners.filter(t=>t.type===At.AFTER_RECOVER),e.beforeInsertListeners=e.listeners.filter(t=>t.type===At.BEFORE_INSERT),e.beforeUpdateListeners=e.listeners.filter(t=>t.type===At.BEFORE_UPDATE),e.beforeRemoveListeners=e.listeners.filter(t=>t.type===At.BEFORE_REMOVE),e.beforeSoftRemoveListeners=e.listeners.filter(t=>t.type===At.BEFORE_SOFT_REMOVE),e.beforeRecoverListeners=e.listeners.filter(t=>t.type===At.BEFORE_RECOVER),e.indices=e.embeddeds.reduce((t,n)=>t.concat(n.indicesFromTree),e.ownIndices),e.uniques=e.embeddeds.reduce((t,n)=>t.concat(n.uniquesFromTree),e.ownUniques),e.primaryColumns=e.columns.filter(t=>t.isPrimary),e.nonVirtualColumns=e.columns.filter(t=>!t.isVirtual),e.ancestorColumns=e.columns.filter(t=>t.closureType==="ancestor"),e.descendantColumns=e.columns.filter(t=>t.closureType==="descendant"),e.hasMultiplePrimaryKeys=e.primaryColumns.length>1,e.generatedColumns=e.columns.filter(t=>t.isGenerated||t.isObjectId),e.hasUUIDGeneratedColumns=e.columns.filter(t=>t.isGenerated||t.generationStrategy==="uuid").length>0,e.createDateColumn=e.columns.find(t=>t.isCreateDate),e.updateDateColumn=e.columns.find(t=>t.isUpdateDate),e.deleteDateColumn=e.columns.find(t=>t.isDeleteDate),e.versionColumn=e.columns.find(t=>t.isVersion),e.discriminatorColumn=e.columns.find(t=>t.isDiscriminator),e.treeLevelColumn=e.columns.find(t=>t.isTreeLevel),e.nestedSetLeftColumn=e.columns.find(t=>t.isNestedSetLeft),e.nestedSetRightColumn=e.columns.find(t=>t.isNestedSetRight),e.materializedPathColumn=e.columns.find(t=>t.isMaterializedPath),e.objectIdColumn=e.columns.find(t=>t.isObjectId),e.foreignKeys.forEach(t=>t.build(this.connection.namingStrategy)),e.propertiesMap=e.createPropertiesMap(),e.relationIds.forEach(t=>t.build()),e.relationCounts.forEach(t=>t.build()),e.embeddeds.forEach(t=>{t.relationIdsFromTree.forEach(n=>n.build()),t.relationCountsFromTree.forEach(n=>n.build())})}computeInverseProperties(e,t){e.relations.forEach(n=>{const r=t.find(i=>i.target===n.type||typeof n.type=="string"&&(i.targetName===n.type||i.givenTableName===n.type));if(!r)throw new x("Entity metadata for "+e.name+"#"+n.propertyPath+" was not found. Check if you specified a correct entity object and if it's connected in the connection options.");n.inverseEntityMetadata=r,n.inverseSidePropertyPath=n.buildInverseSidePropertyPath(),n.inverseRelation=r.relations.find(i=>i.propertyPath===n.inverseSidePropertyPath)})}createKeysForTableInheritance(e){e.indices.some(({givenColumnNames:n})=>{var r;return!!n&&Array.isArray(n)&&n.length===1&&n[0]===((r=e.discriminatorColumn)==null?void 0:r.databaseName)})||e.indices.push(new Yn({entityMetadata:e,columns:[e.discriminatorColumn],args:{target:e.target,unique:!1}}))}createForeignKeys(e,t){this.metadataArgsStorage.filterForeignKeys(e.inheritanceTree).forEach(n=>{const r=typeof n.type=="function"?n.type():n.type,i=t.find(p=>typeof r=="string"?p.targetName===r||p.givenTableName===r:B.isEntitySchema(r)?p.target===r.options.name||p.target===r.options.target:p.target===r);if(!i)throw new x("Entity metadata for "+e.name+(n.propertyName?"#"+n.propertyName:"")+" was not found. Check if you specified a correct entity object and if it's connected in the connection options.");const a=n.columnNames??[],o=n.referencedColumnNames??[],l=[],h=[];n.propertyName&&(a.push(n.propertyName),n.inverseSide&&(typeof n.inverseSide=="function"?o.push(n.inverseSide(i.propertiesMap)):o.push(n.inverseSide))),o.length||h.push(...i.primaryColumns);const d=(p,m)=>{const w=m.columns.find(R=>R.propertyName===p||R.databaseName===p);if(w)return w;const b=n.name?'"'+n.name+'" ':"",S=m.targetName;throw new x(`Foreign key constraint ${b}contains column that is missing in the entity (${S}): ${p}`)};l.push(...a.map(p=>d(p,e))),h.push(...o.map(p=>d(p,i))),e.foreignKeys.push(new os({entityMetadata:e,referencedEntityMetadata:i,namingStrategy:this.connection.namingStrategy,columns:l,referencedColumns:h,...n}))})}}class Do extends x{static createEntitySchemaIsRequiredException(e){return new Do(`EntitySchema is required for ${e} embedded field`)}static createTargetIsRequired(e){return new Do(`Target field is required for ${e} embedded EntitySchema`)}constructor(e){super(e)}}class fM{transform(e){const t=new ey;return e.forEach(n=>{const r=n.options,i={target:r.target||r.name,name:r.tableName,database:r.database,schema:r.schema,type:r.type||"regular",orderBy:r.orderBy,synchronize:r.synchronize,withoutRowid:!!r.withoutRowid,expression:r.expression};t.tables.push(i);const{inheritance:a}=r;a&&t.inheritances.push({target:r.target,pattern:a.pattern??"STI",column:a.column?typeof a.column=="string"?{name:a.column}:a.column:void 0});const{discriminatorValue:o}=r;o&&t.discriminatorValues.push({target:r.target||r.name,value:o}),this.transformColumnsRecursive(r,t)}),t}transformColumnsRecursive(e,t){Object.keys(e.columns).forEach(n=>{const i=e.columns[n];let a="regular";i.createDate&&(a="createDate"),i.updateDate&&(a="updateDate"),i.deleteDate&&(a="deleteDate"),i.version&&(a="version"),i.treeChildrenCount&&(a="treeChildrenCount"),i.treeLevel&&(a="treeLevel"),i.objectId&&(a="objectId"),i.virtualProperty&&(a="virtual-property");const o={target:e.target||e.name,mode:a,propertyName:n,options:{type:i.type,name:i.objectId?"_id":i.name,primaryKeyConstraintName:i.primaryKeyConstraintName,length:i.length,width:i.width,nullable:i.nullable,readonly:i.readonly,update:i.update,select:i.select,insert:i.insert,primary:i.primary,unique:i.unique,comment:i.comment,default:i.default,onUpdate:i.onUpdate,precision:i.precision,scale:i.scale,zerofill:i.zerofill,unsigned:i.unsigned,charset:i.charset,collation:i.collation,enum:i.enum,enumName:i.enumName,asExpression:i.asExpression,generatedType:i.generatedType,hstoreType:i.hstoreType,array:i.array,transformer:i.transformer,spatialFeatureType:i.spatialFeatureType,srid:i.srid,query:i.query}};if(t.columns.push(o),i.generated){const l={target:e.target||e.name,propertyName:n,strategy:typeof i.generated=="string"?i.generated:"increment"};t.generations.push(l)}if(i.unique&&t.uniques.push({target:e.target||e.name,columns:[n]}),i.foreignKey){const l=i.foreignKey,h={target:e.target||e.name,type:l.target,propertyName:n,inverseSide:l.inverseSide,name:l.name,onDelete:l.onDelete,onUpdate:l.onUpdate,deferrable:l.deferrable};t.foreignKeys.push(h)}}),e.relations&&Object.keys(e.relations).forEach(n=>{const r=e.relations[n],i={target:e.target||e.name,propertyName:n,relationType:r.type,isLazy:r.lazy||!1,type:r.target,inverseSideProperty:r.inverseSide,isTreeParent:r.treeParent,isTreeChildren:r.treeChildren,options:{eager:r.eager||!1,cascade:r.cascade,nullable:r.nullable,onDelete:r.onDelete,onUpdate:r.onUpdate,deferrable:r.deferrable,createForeignKeyConstraints:r.createForeignKeyConstraints,persistence:r.persistence,orphanedRowAction:r.orphanedRowAction}};if(t.relations.push(i),r.joinColumn)if(typeof r.joinColumn=="boolean"){const a={target:e.target||e.name,propertyName:n};t.joinColumns.push(a)}else{const a=Array.isArray(r.joinColumn)?r.joinColumn:[r.joinColumn];for(const o of a){const l={target:e.target||e.name,propertyName:n,name:o.name,referencedColumnName:o.referencedColumnName,foreignKeyConstraintName:o.foreignKeyConstraintName};t.joinColumns.push(l)}}if(r.joinTable)if(typeof r.joinTable=="boolean"){const a={target:e.target||e.name,propertyName:n};t.joinTables.push(a)}else{const a={target:e.target||e.name,propertyName:n,name:r.joinTable.name,database:r.joinTable.database,schema:r.joinTable.schema,joinColumns:r.joinTable.joinColumn?[r.joinTable.joinColumn]:r.joinTable.joinColumns,inverseJoinColumns:r.joinTable.inverseJoinColumn?[r.joinTable.inverseJoinColumn]:r.joinTable.inverseJoinColumns};t.joinTables.push(a)}}),e.relationIds&&Object.keys(e.relationIds).forEach(n=>{const r=e.relationIds[n],i={propertyName:n,relation:r.relationName,target:e.target||e.name,alias:r.alias,queryBuilderFactory:r.queryBuilderFactory};t.relationIds.push(i)}),e.indices&&e.indices.forEach(n=>{const r={target:e.target||e.name,name:n.name,unique:n.unique===!0,spatial:n.spatial===!0,fulltext:n.fulltext===!0,nullFiltered:n.nullFiltered===!0,parser:n.parser,synchronize:n.synchronize!==!1,where:n.where,sparse:n.sparse,columns:n.columns};t.indices.push(r)}),e.foreignKeys&&e.foreignKeys.forEach(n=>{const r={target:e.target||e.name,type:n.target,columnNames:n.columnNames,referencedColumnNames:n.referencedColumnNames,name:n.name,onDelete:n.onDelete,onUpdate:n.onUpdate,deferrable:n.deferrable};t.foreignKeys.push(r)}),e.uniques&&e.uniques.forEach(n=>{const r={target:e.target||e.name,name:n.name,columns:n.columns,deferrable:n.deferrable};t.uniques.push(r)}),e.checks&&e.checks.forEach(n=>{const r={target:e.target||e.name,name:n.name,expression:n.expression};t.checks.push(r)}),e.exclusions&&e.exclusions.forEach(n=>{const r={target:e.target||e.name,name:n.name,expression:n.expression};t.exclusions.push(r)}),e.embeddeds&&Object.keys(e.embeddeds).forEach(n=>{const r=e.embeddeds[n];if(!r.schema)throw Do.createEntitySchemaIsRequiredException(n);const i=r.schema.options;t.embeddeds.push({target:e.target||e.name,propertyName:n,isArray:r.array===!0,prefix:r.prefix!==void 0?r.prefix:void 0,type:()=>(i==null?void 0:i.target)||i.name}),this.transformColumnsRecursive(i,t)})}}class pM{constructor(e){this.connection=e}async buildMigrations(e){const[t]=re.splitClassesAndStrings(e);return[...t,...await Ju(this.connection.logger)].map(r=>Cl(r))}async buildSubscribers(e){const[t]=re.splitClassesAndStrings(e||[]),n=[...t,...await Ju(this.connection.logger)];return Io().filterSubscribers(n).map(r=>Cl(r.target))}async buildEntityMetadatas(e){const[t]=re.splitClassesAndStrings(e||[]),n=t.filter(h=>!B.isEntitySchema(h)),r=t.filter(h=>B.isEntitySchema(h)),i=[...n,...await Ju(this.connection.logger)];i.forEach(h=>{B.isEntitySchema(h)&&r.push(h)});const a=new Xp(this.connection,Io()).build(i),o=new fM().transform(r),l=new Xp(this.connection,o).build();return[...a,...l]}}class rc{constructor(e){this.options=e}logQuery(e,t,n){this.isLogEnabledFor("query")&&this.writeLog("query",{type:"query",prefix:"query",message:e,format:"sql",parameters:t},n)}logQueryError(e,t,n,r){this.isLogEnabledFor("query-error")&&this.writeLog("warn",[{type:"query-error",prefix:"query failed",message:t,format:"sql",parameters:n},{type:"query-error",prefix:"error",message:e}],r)}logQuerySlow(e,t,n,r){this.isLogEnabledFor("query-slow")&&this.writeLog("warn",[{type:"query-slow",prefix:"query is slow",message:t,format:"sql",parameters:n,additionalInfo:{time:e}},{type:"query-slow",prefix:"execution time",message:e}],r)}logSchemaBuild(e,t){this.isLogEnabledFor("schema-build")&&this.writeLog("schema",{type:"schema-build",message:e},t)}logMigration(e,t){this.isLogEnabledFor("migration")&&this.writeLog("log",{type:"migration",message:e},t)}log(e,t,n){switch(e){case"log":if(!this.isLogEnabledFor("log"))return;this.writeLog("log",{type:"log",message:t},n);break;case"info":if(!this.isLogEnabledFor("info"))return;this.writeLog("info",{type:"info",prefix:"info",message:t},n);break;case"warn":if(!this.isLogEnabledFor("warn"))return;this.writeLog("warn",{type:"warn",message:t},n);break}}isLogEnabledFor(e){switch(e){case"query":return this.options==="all"||this.options===!0||Array.isArray(this.options)&&this.options.indexOf("query")!==-1;case"error":case"query-error":return this.options==="all"||this.options===!0||Array.isArray(this.options)&&this.options.indexOf("error")!==-1;case"query-slow":return!0;case"schema":case"schema-build":return this.options==="all"||Array.isArray(this.options)&&this.options.indexOf("schema")!==-1;case"migration":return!0;case"log":return this.options==="all"||Array.isArray(this.options)&&this.options.indexOf("log")!==-1;case"info":return this.options==="all"||Array.isArray(this.options)&&this.options.indexOf("info")!==-1;case"warn":return this.options==="all"||Array.isArray(this.options)&&this.options.indexOf("warn")!==-1;default:return!1}}prepareLogMessages(e,t,n){var i;t={addColonToPrefix:!0,appendParameterAsComment:!0,highlightSql:!0,formatSql:!1,...t};const r=Array.isArray(e)?e:[e];for(let a of r){if(typeof a!="object"&&(a={message:a}),a.format==="sql"){let o=String(a.message);t.formatSql&&(o=Xe.formatSql(o,(i=n==null?void 0:n.connection)==null?void 0:i.options.type)),t.appendParameterAsComment&&a.parameters&&a.parameters.length&&(o+=` -- PARAMETERS: ${this.stringifyParams(a.parameters)}`),t.highlightSql&&(o=Xe.highlightSql(o)),a.message=o}t.addColonToPrefix&&a.prefix&&(a.prefix+=":")}return r}stringifyParams(e){try{return JSON.stringify(e)}catch{return e}}}class mM extends rc{writeLog(e,t,n){const r=this.prepareLogMessages(t,{highlightSql:!1});for(const i of r)switch(i.type??e){case"log":case"schema-build":case"migration":console.log(i.message);break;case"info":case"query":i.prefix?console.info(i.prefix,i.message):console.info(i.message);break;case"warn":case"query-slow":i.prefix?console.warn(i.prefix,i.message):console.warn(i.message);break;case"error":case"query-error":i.prefix?console.error(i.prefix,i.message):console.error(i.message);break}}}class Zp extends rc{writeLog(e,t,n){const r=this.prepareLogMessages(t);for(const i of r)switch(i.type??e){case"log":case"schema-build":case"migration":Xe.log(String(i.message));break;case"info":case"query":i.prefix?Xe.logInfo(i.prefix,i.message):Xe.log(String(i.message));break;case"warn":case"query-slow":i.prefix?Xe.logWarn(i.prefix,i.message):console.warn(Xe.warn(String(i.message)));break;case"error":case"query-error":i.prefix?Xe.logError(i.prefix,String(i.message)):console.error(Xe.error(String(i.message)));break}}}class yM{logQuery(){throw new Error("This logger is not applicable in a browser context")}logQueryError(){throw new Error("This logger is not applicable in a browser context")}logQuerySlow(){throw new Error("This logger is not applicable in a browser context")}logSchemaBuild(){throw new Error("This logger is not applicable in a browser context")}logMigration(){throw new Error("This logger is not applicable in a browser context")}log(){throw new Error("This logger is not applicable in a browser context")}}class gM extends yM{}var vl={exports:{}},Xu,em;function EM(){if(em)return Xu;em=1;var s=1e3,e=s*60,t=e*60,n=t*24,r=n*7,i=n*365.25;Xu=function(d,p){p=p||{};var m=typeof d;if(m==="string"&&d.length>0)return a(d);if(m==="number"&&isFinite(d))return p.long?l(d):o(d);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(d))};function a(d){if(d=String(d),!(d.length>100)){var p=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(d);if(p){var m=parseFloat(p[1]),w=(p[2]||"ms").toLowerCase();switch(w){case"years":case"year":case"yrs":case"yr":case"y":return m*i;case"weeks":case"week":case"w":return m*r;case"days":case"day":case"d":return m*n;case"hours":case"hour":case"hrs":case"hr":case"h":return m*t;case"minutes":case"minute":case"mins":case"min":case"m":return m*e;case"seconds":case"second":case"secs":case"sec":case"s":return m*s;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return m;default:return}}}}function o(d){var p=Math.abs(d);return p>=n?Math.round(d/n)+"d":p>=t?Math.round(d/t)+"h":p>=e?Math.round(d/e)+"m":p>=s?Math.round(d/s)+"s":d+"ms"}function l(d){var p=Math.abs(d);return p>=n?h(d,p,n,"day"):p>=t?h(d,p,t,"hour"):p>=e?h(d,p,e,"minute"):p>=s?h(d,p,s,"second"):d+" ms"}function h(d,p,m,w){var b=p>=m*1.5;return Math.round(d/m)+" "+w+(b?"s":"")}return Xu}function wM(s){t.debug=t,t.default=t,t.coerce=l,t.disable=a,t.enable=r,t.enabled=o,t.humanize=EM(),t.destroy=h,Object.keys(s).forEach(d=>{t[d]=s[d]}),t.names=[],t.skips=[],t.formatters={};function e(d){let p=0;for(let m=0;m<d.length;m++)p=(p<<5)-p+d.charCodeAt(m),p|=0;return t.colors[Math.abs(p)%t.colors.length]}t.selectColor=e;function t(d){let p,m=null,w,b;function S(...R){if(!S.enabled)return;const $=S,q=Number(new Date),O=q-(p||q);$.diff=O,$.prev=p,$.curr=q,p=q,R[0]=t.coerce(R[0]),typeof R[0]!="string"&&R.unshift("%O");let J=0;R[0]=R[0].replace(/%([a-zA-Z%])/g,(ge,pe)=>{if(ge==="%%")return"%";J++;const me=t.formatters[pe];if(typeof me=="function"){const V=R[J];ge=me.call($,V),R.splice(J,1),J--}return ge}),t.formatArgs.call($,R),($.log||t.log).apply($,R)}return S.namespace=d,S.useColors=t.useColors(),S.color=t.selectColor(d),S.extend=n,S.destroy=t.destroy,Object.defineProperty(S,"enabled",{enumerable:!0,configurable:!1,get:()=>m!==null?m:(w!==t.namespaces&&(w=t.namespaces,b=t.enabled(d)),b),set:R=>{m=R}}),typeof t.init=="function"&&t.init(S),S}function n(d,p){const m=t(this.namespace+(typeof p>"u"?":":p)+d);return m.log=this.log,m}function r(d){t.save(d),t.namespaces=d,t.names=[],t.skips=[];const p=(typeof d=="string"?d:"").trim().replace(/\s+/g,",").split(",").filter(Boolean);for(const m of p)m[0]==="-"?t.skips.push(m.slice(1)):t.names.push(m)}function i(d,p){let m=0,w=0,b=-1,S=0;for(;m<d.length;)if(w<p.length&&(p[w]===d[m]||p[w]==="*"))p[w]==="*"?(b=w,S=m,w++):(m++,w++);else if(b!==-1)w=b+1,S++,m=S;else return!1;for(;w<p.length&&p[w]==="*";)w++;return w===p.length}function a(){const d=[...t.names,...t.skips.map(p=>"-"+p)].join(",");return t.enable(""),d}function o(d){for(const p of t.skips)if(i(d,p))return!1;for(const p of t.names)if(i(d,p))return!0;return!1}function l(d){return d instanceof Error?d.stack||d.message:d}function h(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.enable(t.load()),t}var bM=wM;(function(s,e){var t={};e.formatArgs=r,e.save=i,e.load=a,e.useColors=n,e.storage=o(),e.destroy=(()=>{let h=!1;return()=>{h||(h=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),e.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function n(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let h;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(h=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(h[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function r(h){if(h[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+h[0]+(this.useColors?"%c ":" ")+"+"+s.exports.humanize(this.diff),!this.useColors)return;const d="color: "+this.color;h.splice(1,0,d,"color: inherit");let p=0,m=0;h[0].replace(/%[a-zA-Z%]/g,w=>{w!=="%%"&&(p++,w==="%c"&&(m=p))}),h.splice(m,0,d)}e.log=console.debug||console.log||(()=>{});function i(h){try{h?e.storage.setItem("debug",h):e.storage.removeItem("debug")}catch{}}function a(){let h;try{h=e.storage.getItem("debug")||e.storage.getItem("DEBUG")}catch{}return!h&&typeof process<"u"&&"env"in process&&(h=t.DEBUG),h}function o(){try{return localStorage}catch{}}s.exports=bM(e);const{formatters:l}=s.exports;l.j=function(h){try{return JSON.stringify(h)}catch(d){return"[UnexpectedJSONParseError]: "+d.message}}})(vl,vl.exports);var xr=vl.exports;class TM extends rc{constructor(){super(...arguments),this.logger={log:xr.debug("typeorm:log"),info:xr.debug("typeorm:info"),warn:xr.debug("typeorm:warn"),error:xr.debug("typeorm:error"),query:xr.debug("typeorm:query:log"),"query-error":xr.debug("typeorm:query:error"),"query-slow":xr.debug("typeorm:query:slow"),"schema-build":xr.debug("typeorm:schema"),migration:xr.debug("typeorm:migration")}}isLogEnabledFor(e){switch(e){case"query":return this.logger.query.enabled;case"query-error":return this.logger["query-error"].enabled;case"query-slow":return!0;case"schema":case"schema-build":return this.logger["schema-build"].enabled;case"migration":return this.logger.migration.enabled;case"log":return this.logger.log.enabled;case"info":return this.logger.info.enabled;case"warn":return this.logger.warn.enabled;default:return!1}}writeLog(e,t,n){const r=this.prepareLogMessages(t,{appendParameterAsComment:!1});for(const i of r){const a=i.type??e;a in this.logger&&(i.prefix?this.logger[a](i.prefix,i.message):this.logger[a](i.message),i.parameters&&i.parameters.length&&this.logger[a]("parameters:",i.parameters))}}}class SM extends rc{writeLog(e,t,n){const r=this.prepareLogMessages(t,{highlightSql:!0,formatSql:!0},n);for(const i of r)switch(i.type??e){case"log":case"schema-build":case"migration":Xe.log(String(i.message));break;case"info":case"query":i.prefix?Xe.logInfo(i.prefix,i.message):Xe.log(String(i.message));break;case"warn":case"query-slow":i.prefix?Xe.logWarn(i.prefix,i.message):console.warn(Xe.warn(String(i.message)));break;case"error":case"query-error":i.prefix?Xe.logError(i.prefix,String(i.message)):console.error(Xe.error(String(i.message)));break}}}class tm{create(e,t){if(Re.isObject(e))return e;if(e)switch(e){case"simple-console":return new mM(t);case"file":return new gM(t);case"advanced-console":return new Zp(t);case"formatted-console":return new SM(t);case"debug":return new TM}return new Zp(t)}}class AM{constructor(e,t){this.connection=e,this.clientType=t,this.redis=this.loadRedis()}async connect(){const e=this.connection.options.cache;if(this.clientType==="redis"){const t={...e==null?void 0:e.options};let n=this.redis.createClient(t);typeof n.connect=="function"&&(t.legacyMode=!0,n=this.redis.createClient(t)),this.client=n,typeof this.connection.options.cache=="object"&&this.connection.options.cache.ignoreErrors&&this.client.on("error",i=>{this.connection.logger.log("warn",i)}),typeof this.client.connect=="function"&&await this.client.connect(),this.detectRedisVersion()}else if(this.clientType==="ioredis")e&&e.port?e.options?this.client=new this.redis(e.port,e.options):this.client=new this.redis(e.port):e&&e.options?this.client=new this.redis(e.options):this.client=new this.redis;else if(this.clientType==="ioredis/cluster")if(e&&e.options&&Array.isArray(e.options))this.client=new this.redis.Cluster(e.options);else if(e&&e.options&&e.options.startupNodes)this.client=new this.redis.Cluster(e.options.startupNodes,e.options.options);else throw new x(`options.startupNodes required for ${this.clientType}.`)}async disconnect(){if(this.isRedis5OrHigher()){await this.client.quit(),this.client=void 0;return}return new Promise((e,t)=>{this.client.quit((n,r)=>{if(n)return t(n);e(),this.client=void 0})})}async synchronize(e){}getFromCache(e,t){const n=e.identifier||e.query;return n?this.isRedis5OrHigher()?this.client.get(n).then(r=>r?JSON.parse(r):void 0):new Promise((r,i)=>{this.client.get(n,(a,o)=>{if(a)return i(a);r(o?JSON.parse(o):void 0)})}):Promise.resolve(void 0)}isExpired(e){return e.time+e.duration<Date.now()}async storeInCache(e,t,n){const r=e.identifier||e.query;if(!r)return;const i=JSON.stringify(e),a=e.duration;if(this.isRedis5OrHigher()){await this.client.set(r,i,{PX:a});return}return new Promise((o,l)=>{this.client.set(r,i,"PX",a,(h,d)=>{if(h)return l(h);o()})})}async clear(e){if(this.isRedis5OrHigher()){await this.client.flushDb();return}return new Promise((t,n)=>{this.client.flushdb((r,i)=>{if(r)return n(r);t()})})}async remove(e,t){await Promise.all(e.map(n=>this.deleteKey(n)))}async deleteKey(e){if(this.isRedis5OrHigher()){await this.client.del(e);return}return new Promise((t,n)=>{this.client.del(e,(r,i)=>{if(r)return n(r);t()})})}loadRedis(){try{return this.clientType==="ioredis/cluster"?Xe.load("ioredis"):Xe.load(this.clientType)}catch{throw new x(`Cannot use cache because ${this.clientType} is not installed. Please run "npm i ${this.clientType}".`)}}detectRedisVersion(){if(this.clientType==="redis")try{const e=this.client.set;e&&e.length<=3?this.redisMajorVersion=5:this.redisMajorVersion=3}catch{this.redisMajorVersion=3}}isRedis5OrHigher(){return this.clientType!=="redis"?!1:this.redisMajorVersion!==void 0&&this.redisMajorVersion>=5}}class NM{constructor(e){this.connection=e;const{schema:t}=this.connection.driver.options,n=this.connection.driver.database,i=(typeof this.connection.options.cache=="object"?this.connection.options.cache:{}).tableName||"query-result-cache";this.queryResultCacheDatabase=n,this.queryResultCacheSchema=t,this.queryResultCacheTable=this.connection.driver.buildTableName(i,t,n)}async connect(){}async disconnect(){}async synchronize(e){e=this.getQueryRunner(e);const t=this.connection.driver;await e.hasTable(this.queryResultCacheTable)||await e.createTable(new gt({database:this.queryResultCacheDatabase,schema:this.queryResultCacheSchema,name:this.queryResultCacheTable,columns:[{name:"id",isPrimary:!0,isNullable:!1,type:t.normalizeType({type:t.mappedDataTypes.cacheId}),generationStrategy:t.options.type==="spanner"?"uuid":"increment",isGenerated:!0},{name:"identifier",type:t.normalizeType({type:t.mappedDataTypes.cacheIdentifier}),isNullable:!0},{name:"time",type:t.normalizeType({type:t.mappedDataTypes.cacheTime}),isPrimary:!1,isNullable:!1},{name:"duration",type:t.normalizeType({type:t.mappedDataTypes.cacheDuration}),isPrimary:!1,isNullable:!1},{name:"query",type:t.normalizeType({type:t.mappedDataTypes.cacheQuery}),isPrimary:!1,isNullable:!1},{name:"result",type:t.normalizeType({type:t.mappedDataTypes.cacheResult}),isNullable:!1}]}))}getFromCache(e,t){t=this.getQueryRunner(t);const n=this.connection.createQueryBuilder(t).select().from(this.queryResultCacheTable,"cache");return e.identifier?n.where(`${n.escape("cache")}.${n.escape("identifier")} = :identifier`).setParameters({identifier:this.connection.driver.options.type==="mssql"?new Hn(e.identifier,"nvarchar"):e.identifier}).cache(!1).getRawOne():e.query?this.connection.driver.options.type==="oracle"?n.where(`dbms_lob.compare(${n.escape("cache")}.${n.escape("query")}, :query) = 0`,{query:e.query}).cache(!1).getRawOne():n.where(`${n.escape("cache")}.${n.escape("query")} = :query`).setParameters({query:this.connection.driver.options.type==="mssql"?new Hn(e.query,"nvarchar"):e.query}).cache(!1).getRawOne():Promise.resolve(void 0)}isExpired(e){const t=typeof e.duration=="string"?parseInt(e.duration):e.duration;return(typeof e.time=="string"?parseInt(e.time):e.time)+t<Date.now()}async storeInCache(e,t,n){const r=n===void 0||(n==null?void 0:n.getReplicationMode())==="slave";(n===void 0||r)&&(n=this.connection.createQueryRunner("master"));let i=e;if(this.connection.driver.options.type==="mssql"&&(i={identifier:new Hn(e.identifier,"nvarchar"),time:new Hn(e.time,"bigint"),duration:new Hn(e.duration,"int"),query:new Hn(e.query,"nvarchar"),result:new Hn(e.result,"nvarchar")}),t&&t.identifier){const a=n.manager.createQueryBuilder().update(this.queryResultCacheTable).set(i);a.where(`${a.escape("identifier")} = :condition`,{condition:i.identifier}),await a.execute()}else if(t&&t.query){const a=n.manager.createQueryBuilder().update(this.queryResultCacheTable).set(i);this.connection.driver.options.type==="oracle"?a.where('dbms_lob.compare("query", :condition) = 0',{condition:i.query}):a.where(`${a.escape("query")} = :condition`,{condition:i.query}),await a.execute()}else this.connection.driver.options.type==="spanner"&&!i.id&&(i.id=ih()),await n.manager.createQueryBuilder().insert().into(this.queryResultCacheTable).values(i).execute();r&&await n.release()}async clear(e){return this.getQueryRunner(e).clearTable(this.queryResultCacheTable)}async remove(e,t){const n=t||this.getQueryRunner();await Promise.all(e.map(r=>{const i=n.manager.createQueryBuilder();return i.delete().from(this.queryResultCacheTable).where(`${i.escape("identifier")} = :identifier`,{identifier:r}).execute()})),t||await n.release()}getQueryRunner(e){return e||this.connection.createQueryRunner()}}class nm{constructor(e){this.connection=e}create(){if(!this.connection.options.cache)throw new x("To use cache you need to enable it in connection options by setting cache: true or providing some caching options. Example: { host: ..., username: ..., cache: true }");const e=this.connection.options.cache;return e.provider&&typeof e.provider=="function"?e.provider(this.connection):e.type==="redis"||e.type==="ioredis"||e.type==="ioredis/cluster"?new AM(this.connection,e.type):new NM(this.connection)}}class CM{constructor(e){this.connection=e}load(e,t,n,r){return n&&n.isReleased&&(n=void 0),e.isManyToOne||e.isOneToOneOwner?this.loadManyToOneOrOneToOneOwner(e,t,n,r):e.isOneToMany||e.isOneToOneNotOwner?this.loadOneToManyOrOneToOneNotOwner(e,t,n,r):e.isManyToManyOwner?this.loadManyToManyOwner(e,t,n,r):this.loadManyToManyNotOwner(e,t,n,r)}loadManyToOneOrOneToOneOwner(e,t,n,r){const i=Array.isArray(t)?t:[t],a=e.entityMetadata.name,o=r||this.connection.createQueryBuilder(n).select(e.propertyName).from(e.type,e.propertyName),l=o.expressionMap.mainAlias.name,h=e.entityMetadata.primaryColumns,p=(e.isOwning?e.joinColumns:e.inverseRelation.joinColumns).map(m=>`${e.entityMetadata.name}.${m.propertyName} = ${l}.${m.referencedColumn.propertyName}`).join(" AND ");if(o.innerJoin(e.entityMetadata.target,a,p),h.length===1)o.where(`${a}.${h[0].propertyPath} IN (:...${a+"_"+h[0].propertyName})`),o.setParameter(a+"_"+h[0].propertyName,i.map(m=>h[0].getEntityValue(m,!0)));else{const m=i.map((w,b)=>h.map((S,R)=>{const $=a+"_entity_"+b+"_"+R;return o.setParameter($,S.getEntityValue(w,!0)),a+"."+S.propertyPath+" = :"+$}).join(" AND ")).map(w=>"("+w+")").join(" OR ");o.where(m)}return Ht.joinEagerRelations(o,o.alias,o.expressionMap.mainAlias.metadata),o.getMany()}loadOneToManyOrOneToOneNotOwner(e,t,n,r){const i=Array.isArray(t)?t:[t],a=e.inverseRelation.joinColumns,o=r||this.connection.createQueryBuilder(n).select(e.propertyName).from(e.inverseRelation.entityMetadata.target,e.propertyName),l=o.expressionMap.mainAlias.name;if(a.length===1)o.where(`${l}.${a[0].propertyPath} IN (:...${l+"_"+a[0].propertyName})`),o.setParameter(l+"_"+a[0].propertyName,i.map(h=>a[0].referencedColumn.getEntityValue(h,!0)));else{const h=i.map((d,p)=>a.map((m,w)=>{const b=l+"_entity_"+p+"_"+w;return o.setParameter(b,m.referencedColumn.getEntityValue(d,!0)),l+"."+m.propertyPath+" = :"+b}).join(" AND ")).map(d=>"("+d+")").join(" OR ");o.where(h)}return Ht.joinEagerRelations(o,o.alias,o.expressionMap.mainAlias.metadata),o.getMany()}loadManyToManyOwner(e,t,n,r){const i=Array.isArray(t)?t:[t],a=e.joinColumns.reduce((m,w)=>(m[w.propertyName]=i.map(b=>w.referencedColumn.getEntityValue(b,!0)),m),{}),o=r||this.connection.createQueryBuilder(n).select(e.propertyName).from(e.type,e.propertyName),l=o.expressionMap.mainAlias.name,h=e.junctionEntityMetadata.tableName,d=e.joinColumns.map(m=>`${h}.${m.propertyName} IN (:...${m.propertyName})`),p=e.inverseJoinColumns.map(m=>`${h}.${m.propertyName}=${l}.${m.referencedColumn.propertyName}`);return o.innerJoin(h,h,[...d,...p].join(" AND ")).setParameters(a),Ht.joinEagerRelations(o,o.alias,o.expressionMap.mainAlias.metadata),o.getMany()}loadManyToManyNotOwner(e,t,n,r){const i=Array.isArray(t)?t:[t],a=r||this.connection.createQueryBuilder(n).select(e.propertyName).from(e.type,e.propertyName),o=a.expressionMap.mainAlias.name,l=e.junctionEntityMetadata.tableName,h=e.inverseRelation.joinColumns.map(m=>`${l}.${m.propertyName} = ${o}.${m.referencedColumn.propertyName}`),d=e.inverseRelation.inverseJoinColumns.map(m=>`${l}.${m.propertyName} IN (:...${m.propertyName})`),p=e.inverseRelation.inverseJoinColumns.reduce((m,w)=>(m[w.propertyName]=i.map(b=>w.referencedColumn.getEntityValue(b,!0)),m),{});return a.innerJoin(l,l,[...h,...d].join(" AND ")).setParameters(p),Ht.joinEagerRelations(a,a.alias,a.expressionMap.mainAlias.metadata),a.getMany()}enableLazyLoad(e,t,n){const r=this,i="__"+e.propertyName+"__",a="__promise_"+e.propertyName+"__",o="__has_"+e.propertyName+"__",l=(d,p)=>(d[i]=p,d[o]=!0,delete d[a],p),h=(d,p)=>(delete d[o],delete d[i],d[a]=p,p.then(m=>d[a]===p?l(d,m):m),p);Object.defineProperty(t,e.propertyName,{get:function(){if(this[o]===!0||this[i]!==void 0)return Promise.resolve(this[i]);if(this[a])return this[a];const d=r.load(e,this,n).then(p=>e.isOneToOne||e.isManyToOne?p.length===0?null:p[0]:p);return h(this,d)},set:function(d){d instanceof Promise?h(this,d):l(this,d)},configurable:!0,enumerable:!1})}}Cy();class vM{constructor(e){this["@instanceof"]=Symbol.for("DataSource"),this.migrations=[],this.subscribers=[],this.entityMetadatas=[],this.entityMetadatasMap=new Map,Cy(),this.name=e.name||"default",this.options=e,this.logger=new tm().create(this.options.logger,this.options.logging),this.driver=new sM().create(this),this.manager=this.createEntityManager(),this.namingStrategy=e.namingStrategy||new ix,this.metadataTableName=e.metadataTableName||"typeorm_metadata",this.queryResultCache=e.cache?new nm(this).create():void 0,this.relationLoader=new CM(this),this.relationIdLoader=new Ay(this),this.isInitialized=!1}get isConnected(){return this.isInitialized}get mongoManager(){if(!B.isMongoEntityManager(this.manager))throw new x("MongoEntityManager is only available for MongoDB databases.");return this.manager}get sqljsManager(){if(!B.isSqljsEntityManager(this.manager))throw new x("SqljsEntityManager is only available for Sqljs databases.");return this.manager}setOptions(e){return Object.assign(this.options,e),(e.logger||e.logging)&&(this.logger=new tm().create(e.logger||this.options.logger,e.logging||this.options.logging)),e.namingStrategy&&(this.namingStrategy=e.namingStrategy),e.cache&&(this.queryResultCache=new nm(this).create()),e.database&&(this.driver.database=ie.buildDriverOptions(this.options).database),this}async initialize(){if(this.isInitialized)throw new y0(this.name);await this.driver.connect(),this.queryResultCache&&await this.queryResultCache.connect(),Re.assign(this,{isInitialized:!0});try{await this.buildMetadatas(),await this.driver.afterConnect(),this.options.dropSchema&&await this.dropDatabase(),this.options.migrationsRun&&await this.runMigrations({transaction:this.options.migrationsTransactionMode}),this.options.synchronize&&await this.synchronize()}catch(e){throw await this.destroy(),e}return this}async connect(){return this.initialize()}async destroy(){if(!this.isInitialized)throw new Fs(this.name);await this.driver.disconnect(),this.queryResultCache&&await this.queryResultCache.disconnect(),Re.assign(this,{isInitialized:!1})}async close(){return this.destroy()}async synchronize(e=!1){if(!this.isInitialized)throw new Fs(this.name);e&&await this.dropDatabase(),await this.driver.createSchemaBuilder().build()}async dropDatabase(){const e=this.createQueryRunner();try{if(this.driver.options.type==="mssql"||ie.isMySQLFamily(this.driver)||this.driver.options.type==="aurora-mysql"||ie.isSQLiteFamily(this.driver)){const t=[];if(this.entityMetadatas.forEach(n=>{n.database&&t.indexOf(n.database)===-1&&t.push(n.database)}),t.length===0&&this.driver.database&&t.push(this.driver.database),t.length===0)await e.clearDatabase();else for(const n of t)await e.clearDatabase(n)}else await e.clearDatabase()}finally{await e.release()}}async runMigrations(e){var r;if(!this.isInitialized)throw new Fs(this.name);const t=new Gu(this);return t.transaction=(e==null?void 0:e.transaction)||((r=this.options)==null?void 0:r.migrationsTransactionMode)||"all",t.fake=e&&e.fake||!1,await t.executePendingMigrations()}async undoLastMigration(e){if(!this.isInitialized)throw new Fs(this.name);const t=new Gu(this);t.transaction=e&&e.transaction||"all",t.fake=e&&e.fake||!1,await t.undoLastMigration()}async showMigrations(){if(!this.isInitialized)throw new Fs(this.name);return await new Gu(this).showMigrations()}hasMetadata(e){return!!this.findMetadata(e)}getMetadata(e){const t=this.findMetadata(e);if(!t)throw new T0(e);return t}getRepository(e){return this.manager.getRepository(e)}getTreeRepository(e){return this.manager.getTreeRepository(e)}getMongoRepository(e){if(this.driver.options.type!=="mongodb")throw new x("You can use getMongoRepository only for MongoDB connections.");return this.manager.getRepository(e)}getCustomRepository(e){return this.manager.getCustomRepository(e)}async transaction(e,t){return this.manager.transaction(e,t)}async query(e,t,n){if(B.isMongoEntityManager(this.manager))throw new x("Queries aren't supported by MongoDB.");if(n&&n.isReleased)throw new sy;const r=n||this.createQueryRunner();try{return await r.query(e,t)}finally{n||await r.release()}}async sql(e,...t){const{query:n,parameters:r}=ec({driver:this.driver,strings:e,expressions:t});return await this.query(n,r)}createQueryBuilder(e,t,n){if(B.isMongoEntityManager(this.manager))throw new x("Query Builder is not supported by MongoDB.");if(t){t=ie.buildAlias(this.driver,void 0,t);const r=this.getMetadata(e);return new zs(this,n).select(t).from(r.target,t)}else return new zs(this,e)}createQueryRunner(e="master"){const t=this.driver.createQueryRunner(e),n=this.createEntityManager(t);return Object.assign(t,{manager:n}),t}getManyToManyMetadata(e,t){const n=this.getMetadata(e).findRelationWithPropertyPath(t);if(!n)throw new x(`Relation "${t}" was not found in ${e} entity.`);if(!n.isManyToMany)throw new x(`Relation "${e}#${t}" does not have a many-to-many relationship.You can use this method only on many-to-many relations.`);return n.junctionEntityMetadata}createEntityManager(e){return new Ix().create(this,e)}findMetadata(e){const t=this.entityMetadatasMap.get(e);if(t)return t;for(const[n,r]of this.entityMetadatasMap){if(B.isEntitySchema(e)&&r.name===e.options.name)return r;if(typeof e=="string"){if(e.indexOf(".")!==-1){if(r.tablePath===e)return r}else if(r.name===e||r.tableName===e)return r}if(Re.isObjectWithName(e)&&typeof e.name=="string"){if(e.name.indexOf(".")!==-1){if(r.tablePath===e.name)return r}else if(r.name===e.name||r.tableName===e.name)return r}}}async buildMetadatas(){const e=new pM(this),t=new ax,n=Re.mixedListToArray(this.options.subscribers||[]),r=await e.buildSubscribers(n);Re.assign(this,{subscribers:r});const i=Re.mixedListToArray(this.options.entities||[]),a=await e.buildEntityMetadatas(i);Re.assign(this,{entityMetadatas:a,entityMetadatasMap:new Map(a.map(h=>[h.target,h]))});const o=Re.mixedListToArray(this.options.migrations||[]),l=await e.buildMigrations(o);Re.assign(this,{migrations:l}),t.validateMany(this.entityMetadatas.filter(h=>h.tableType!=="view"),this.driver);for(const h of a)B.isBaseEntityConstructor(h.target)&&h.target.useDataSource(this)}defaultReplicationModeForReads(){if("replication"in this.driver.options&&this.driver.options.replication){const e=this.driver.options.replication.defaultMode;if(e)return e}return"slave"}}class RM{constructor(){this.connectionMap=new Map}get connections(){return Array.from(this.connectionMap.values())}has(e){return this.connectionMap.has(e)}get(e="default"){const t=this.connectionMap.get(e);if(!t)throw new _0(e);return t}create(e){const t=this.connectionMap.get(e.name||"default");if(t&&t.isInitialized)throw new m0(e.name||"default");const n=new vM(e);return this.connectionMap.set(n.name,n),n}}function Io(){const s=Xe.getGlobalVariable();return s.typeormMetadataArgsStorage||(s.typeormMetadataArgsStorage=new ey),s.typeormMetadataArgsStorage}async function _M(s="default"){return new ny().get(s)}function yr(){return Cl(RM)}async function H1(s){const e=typeof s=="string"?s:"default",t=Re.isObject(s)?s:await _M(e);return yr().create(t).connect()}async function Y1(s){s||(s=await new ny().all());const e=s.map(t=>yr().create(t));for(const t of e)await t.connect();return e}function Rl(s="default"){return yr().get(s)}function G1(s="default"){return yr().get(s).manager}function z1(s="default"){return yr().get(s).manager}function K1(s="default"){return yr().get(s).manager}function xM(s,e="default"){return yr().get(e).getRepository(s)}function J1(s,e="default"){return yr().get(e).getTreeRepository(s)}function X1(s,e="default"){return yr().get(e).getCustomRepository(s)}function Z1(s,e="default"){return yr().get(e).getMongoRepository(s)}function eq(s,e,t="default"){return s?xM(s,t).createQueryBuilder(e):Rl(t).createQueryBuilder()}function MM(s){return new ps("like",s)}class My{constructor(){this.mappings={}}registerMapping(e,t){this.mappings[e]=t}mapRawToEntity(e,t){if(!this.mappings[e])throw new Error(`No mappings registered for entity: ${e}`);const n=this.mappings[e];return t.map(r=>{const i={};for(const a in n)n.hasOwnProperty(a)&&r.hasOwnProperty(n[a])&&(i[a]=r[n[a]]);return i})}registerMappingFromEntity(e){const n=Rl().getMetadata(e),r={};console.log("EntityAdapter::registerMappingFromEntity()/metadata.name:",n.name),n.columns.forEach(i=>{console.log("EntityAdapter::registerMappingFromEntity()/column.databaseName:",i.databaseName),r[i.propertyName]=i.databaseName}),console.log("EntityAdapter::registerMappingFromEntity()/mapping:",r),this.registerMapping(n.name,r)}getEntityName(e){return Rl().getMetadata(e).name}getDbSelect(e,t){if(!this.mappings[e])throw new Error(`No mappings registered for entity: ${e}`);const n=this.mappings[e];return t.map(i=>{if(!n[i])throw new Error(`Field "${i}" does not exist in the registered mapping for entity: ${e}`);return n[i]})}}//! moment.js
//! version : 2.30.1
//! authors : Tim Wood, Iskren Chernev, Moment.js contributors
//! license : MIT
//! momentjs.com
var Py;function le(){return Py.apply(null,arguments)}function PM(s){Py=s}function Zn(s){return s instanceof Array||Object.prototype.toString.call(s)==="[object Array]"}function Ni(s){return s!=null&&Object.prototype.toString.call(s)==="[object Object]"}function et(s,e){return Object.prototype.hasOwnProperty.call(s,e)}function ah(s){if(Object.getOwnPropertyNames)return Object.getOwnPropertyNames(s).length===0;var e;for(e in s)if(et(s,e))return!1;return!0}function un(s){return s===void 0}function Fr(s){return typeof s=="number"||Object.prototype.toString.call(s)==="[object Number]"}function sa(s){return s instanceof Date||Object.prototype.toString.call(s)==="[object Date]"}function Oy(s,e){var t=[],n,r=s.length;for(n=0;n<r;++n)t.push(e(s[n],n));return t}function ii(s,e){for(var t in e)et(e,t)&&(s[t]=e[t]);return et(e,"toString")&&(s.toString=e.toString),et(e,"valueOf")&&(s.valueOf=e.valueOf),s}function gr(s,e,t,n){return tg(s,e,t,n,!0).utc()}function OM(){return{empty:!1,unusedTokens:[],unusedInput:[],overflow:-2,charsLeftOver:0,nullInput:!1,invalidEra:null,invalidMonth:null,invalidFormat:!1,userInvalidated:!1,iso:!1,parsedDateParts:[],era:null,meridiem:null,rfc2822:!1,weekdayMismatch:!1}}function Be(s){return s._pf==null&&(s._pf=OM()),s._pf}var _l;Array.prototype.some?_l=Array.prototype.some:_l=function(s){var e=Object(this),t=e.length>>>0,n;for(n=0;n<t;n++)if(n in e&&s.call(this,e[n],n,e))return!0;return!1};function oh(s){var e=null,t=!1,n=s._d&&!isNaN(s._d.getTime());if(n&&(e=Be(s),t=_l.call(e.parsedDateParts,function(r){return r!=null}),n=e.overflow<0&&!e.empty&&!e.invalidEra&&!e.invalidMonth&&!e.invalidWeekday&&!e.weekdayMismatch&&!e.nullInput&&!e.invalidFormat&&!e.userInvalidated&&(!e.meridiem||e.meridiem&&t),s._strict&&(n=n&&e.charsLeftOver===0&&e.unusedTokens.length===0&&e.bigHour===void 0)),Object.isFrozen==null||!Object.isFrozen(s))s._isValid=n;else return n;return s._isValid}function ic(s){var e=gr(NaN);return s!=null?ii(Be(e),s):Be(e).userInvalidated=!0,e}var rm=le.momentProperties=[],Zu=!1;function ch(s,e){var t,n,r,i=rm.length;if(un(e._isAMomentObject)||(s._isAMomentObject=e._isAMomentObject),un(e._i)||(s._i=e._i),un(e._f)||(s._f=e._f),un(e._l)||(s._l=e._l),un(e._strict)||(s._strict=e._strict),un(e._tzm)||(s._tzm=e._tzm),un(e._isUTC)||(s._isUTC=e._isUTC),un(e._offset)||(s._offset=e._offset),un(e._pf)||(s._pf=Be(e)),un(e._locale)||(s._locale=e._locale),i>0)for(t=0;t<i;t++)n=rm[t],r=e[n],un(r)||(s[n]=r);return s}function aa(s){ch(this,s),this._d=new Date(s._d!=null?s._d.getTime():NaN),this.isValid()||(this._d=new Date(NaN)),Zu===!1&&(Zu=!0,le.updateOffset(this),Zu=!1)}function er(s){return s instanceof aa||s!=null&&s._isAMomentObject!=null}function Dy(s){le.suppressDeprecationWarnings===!1&&typeof console<"u"&&console.warn&&console.warn("Deprecation warning: "+s)}function Ln(s,e){var t=!0;return ii(function(){if(le.deprecationHandler!=null&&le.deprecationHandler(null,s),t){var n=[],r,i,a,o=arguments.length;for(i=0;i<o;i++){if(r="",typeof arguments[i]=="object"){r+=`
[`+i+"] ";for(a in arguments[0])et(arguments[0],a)&&(r+=a+": "+arguments[0][a]+", ");r=r.slice(0,-2)}else r=arguments[i];n.push(r)}Dy(s+`
Arguments: `+Array.prototype.slice.call(n).join("")+`
`+new Error().stack),t=!1}return e.apply(this,arguments)},e)}var im={};function Iy(s,e){le.deprecationHandler!=null&&le.deprecationHandler(s,e),im[s]||(Dy(e),im[s]=!0)}le.suppressDeprecationWarnings=!1;le.deprecationHandler=null;function Er(s){return typeof Function<"u"&&s instanceof Function||Object.prototype.toString.call(s)==="[object Function]"}function DM(s){var e,t;for(t in s)et(s,t)&&(e=s[t],Er(e)?this[t]=e:this["_"+t]=e);this._config=s,this._dayOfMonthOrdinalParseLenient=new RegExp((this._dayOfMonthOrdinalParse.source||this._ordinalParse.source)+"|"+/\d{1,2}/.source)}function xl(s,e){var t=ii({},s),n;for(n in e)et(e,n)&&(Ni(s[n])&&Ni(e[n])?(t[n]={},ii(t[n],s[n]),ii(t[n],e[n])):e[n]!=null?t[n]=e[n]:delete t[n]);for(n in s)et(s,n)&&!et(e,n)&&Ni(s[n])&&(t[n]=ii({},t[n]));return t}function uh(s){s!=null&&this.set(s)}var Ml;Object.keys?Ml=Object.keys:Ml=function(s){var e,t=[];for(e in s)et(s,e)&&t.push(e);return t};var IM={sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"};function $M(s,e,t){var n=this._calendar[s]||this._calendar.sameElse;return Er(n)?n.call(e,t):n}function pr(s,e,t){var n=""+Math.abs(s),r=e-n.length,i=s>=0;return(i?t?"+":"":"-")+Math.pow(10,Math.max(0,r)).toString().substr(1)+n}var lh=/(\[[^\[]*\])|(\\)?([Hh]mm(ss)?|Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|Qo?|N{1,5}|YYYYYY|YYYYY|YYYY|YY|y{2,4}|yo?|gg(ggg?)?|GG(GGG?)?|e|E|a|A|hh?|HH?|kk?|mm?|ss?|S{1,9}|x|X|zz?|ZZ?|.)/g,co=/(\[[^\[]*\])|(\\)?(LTS|LT|LL?L?L?|l{1,4})/g,el={},rs={};function Te(s,e,t,n){var r=n;typeof n=="string"&&(r=function(){return this[n]()}),s&&(rs[s]=r),e&&(rs[e[0]]=function(){return pr(r.apply(this,arguments),e[1],e[2])}),t&&(rs[t]=function(){return this.localeData().ordinal(r.apply(this,arguments),s)})}function LM(s){return s.match(/\[[\s\S]/)?s.replace(/^\[|\]$/g,""):s.replace(/\\/g,"")}function qM(s){var e=s.match(lh),t,n;for(t=0,n=e.length;t<n;t++)rs[e[t]]?e[t]=rs[e[t]]:e[t]=LM(e[t]);return function(r){var i="",a;for(a=0;a<n;a++)i+=Er(e[a])?e[a].call(r,s):e[a];return i}}function So(s,e){return s.isValid()?(e=$y(e,s.localeData()),el[e]=el[e]||qM(e),el[e](s)):s.localeData().invalidDate()}function $y(s,e){var t=5;function n(r){return e.longDateFormat(r)||r}for(co.lastIndex=0;t>=0&&co.test(s);)s=s.replace(co,n),co.lastIndex=0,t-=1;return s}var BM={LTS:"h:mm:ss A",LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY h:mm A",LLLL:"dddd, MMMM D, YYYY h:mm A"};function UM(s){var e=this._longDateFormat[s],t=this._longDateFormat[s.toUpperCase()];return e||!t?e:(this._longDateFormat[s]=t.match(lh).map(function(n){return n==="MMMM"||n==="MM"||n==="DD"||n==="dddd"?n.slice(1):n}).join(""),this._longDateFormat[s])}var FM="Invalid date";function kM(){return this._invalidDate}var jM="%d",WM=/\d{1,2}/;function QM(s){return this._ordinal.replace("%d",s)}var VM={future:"in %s",past:"%s ago",s:"a few seconds",ss:"%d seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",w:"a week",ww:"%d weeks",M:"a month",MM:"%d months",y:"a year",yy:"%d years"};function HM(s,e,t,n){var r=this._relativeTime[t];return Er(r)?r(s,e,t,n):r.replace(/%d/i,s)}function YM(s,e){var t=this._relativeTime[s>0?"future":"past"];return Er(t)?t(e):t.replace(/%s/i,e)}var sm={D:"date",dates:"date",date:"date",d:"day",days:"day",day:"day",e:"weekday",weekdays:"weekday",weekday:"weekday",E:"isoWeekday",isoweekdays:"isoWeekday",isoweekday:"isoWeekday",DDD:"dayOfYear",dayofyears:"dayOfYear",dayofyear:"dayOfYear",h:"hour",hours:"hour",hour:"hour",ms:"millisecond",milliseconds:"millisecond",millisecond:"millisecond",m:"minute",minutes:"minute",minute:"minute",M:"month",months:"month",month:"month",Q:"quarter",quarters:"quarter",quarter:"quarter",s:"second",seconds:"second",second:"second",gg:"weekYear",weekyears:"weekYear",weekyear:"weekYear",GG:"isoWeekYear",isoweekyears:"isoWeekYear",isoweekyear:"isoWeekYear",w:"week",weeks:"week",week:"week",W:"isoWeek",isoweeks:"isoWeek",isoweek:"isoWeek",y:"year",years:"year",year:"year"};function qn(s){return typeof s=="string"?sm[s]||sm[s.toLowerCase()]:void 0}function hh(s){var e={},t,n;for(n in s)et(s,n)&&(t=qn(n),t&&(e[t]=s[n]));return e}var GM={date:9,day:11,weekday:11,isoWeekday:11,dayOfYear:4,hour:13,millisecond:16,minute:14,month:8,quarter:7,second:15,weekYear:1,isoWeekYear:1,week:5,isoWeek:5,year:1};function zM(s){var e=[],t;for(t in s)et(s,t)&&e.push({unit:t,priority:GM[t]});return e.sort(function(n,r){return n.priority-r.priority}),e}var Ly=/\d/,bn=/\d\d/,qy=/\d{3}/,dh=/\d{4}/,sc=/[+-]?\d{6}/,mt=/\d\d?/,By=/\d\d\d\d?/,Uy=/\d\d\d\d\d\d?/,ac=/\d{1,3}/,fh=/\d{1,4}/,oc=/[+-]?\d{1,6}/,ys=/\d+/,cc=/[+-]?\d+/,KM=/Z|[+-]\d\d:?\d\d/gi,uc=/Z|[+-]\d\d(?::?\d\d)?/gi,JM=/[+-]?\d+(\.\d{1,3})?/,oa=/[0-9]{0,256}['a-z\u00A0-\u05FF\u0700-\uD7FF\uF900-\uFDCF\uFDF0-\uFF07\uFF10-\uFFEF]{1,256}|[\u0600-\u06FF\/]{1,256}(\s*?[\u0600-\u06FF]{1,256}){1,2}/i,gs=/^[1-9]\d?/,ph=/^([1-9]\d|\d)/,$o;$o={};function de(s,e,t){$o[s]=Er(e)?e:function(n,r){return n&&t?t:e}}function XM(s,e){return et($o,s)?$o[s](e._strict,e._locale):new RegExp(ZM(s))}function ZM(s){return Lr(s.replace("\\","").replace(/\\(\[)|\\(\])|\[([^\]\[]*)\]|\\(.)/g,function(e,t,n,r,i){return t||n||r||i}))}function Lr(s){return s.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function On(s){return s<0?Math.ceil(s)||0:Math.floor(s)}function Ve(s){var e=+s,t=0;return e!==0&&isFinite(e)&&(t=On(e)),t}var Pl={};function ot(s,e){var t,n=e,r;for(typeof s=="string"&&(s=[s]),Fr(e)&&(n=function(i,a){a[e]=Ve(i)}),r=s.length,t=0;t<r;t++)Pl[s[t]]=n}function ca(s,e){ot(s,function(t,n,r,i){r._w=r._w||{},e(t,r._w,r,i)})}function eP(s,e,t){e!=null&&et(Pl,s)&&Pl[s](e,t._a,t,s)}function lc(s){return s%4===0&&s%100!==0||s%400===0}var Kt=0,Dr=1,lr=2,Dt=3,zn=4,Ir=5,Si=6,tP=7,nP=8;Te("Y",0,0,function(){var s=this.year();return s<=9999?pr(s,4):"+"+s});Te(0,["YY",2],0,function(){return this.year()%100});Te(0,["YYYY",4],0,"year");Te(0,["YYYYY",5],0,"year");Te(0,["YYYYYY",6,!0],0,"year");de("Y",cc);de("YY",mt,bn);de("YYYY",fh,dh);de("YYYYY",oc,sc);de("YYYYYY",oc,sc);ot(["YYYYY","YYYYYY"],Kt);ot("YYYY",function(s,e){e[Kt]=s.length===2?le.parseTwoDigitYear(s):Ve(s)});ot("YY",function(s,e){e[Kt]=le.parseTwoDigitYear(s)});ot("Y",function(s,e){e[Kt]=parseInt(s,10)});function Ys(s){return lc(s)?366:365}le.parseTwoDigitYear=function(s){return Ve(s)+(Ve(s)>68?1900:2e3)};var Fy=Es("FullYear",!0);function rP(){return lc(this.year())}function Es(s,e){return function(t){return t!=null?(ky(this,s,t),le.updateOffset(this,e),this):Ks(this,s)}}function Ks(s,e){if(!s.isValid())return NaN;var t=s._d,n=s._isUTC;switch(e){case"Milliseconds":return n?t.getUTCMilliseconds():t.getMilliseconds();case"Seconds":return n?t.getUTCSeconds():t.getSeconds();case"Minutes":return n?t.getUTCMinutes():t.getMinutes();case"Hours":return n?t.getUTCHours():t.getHours();case"Date":return n?t.getUTCDate():t.getDate();case"Day":return n?t.getUTCDay():t.getDay();case"Month":return n?t.getUTCMonth():t.getMonth();case"FullYear":return n?t.getUTCFullYear():t.getFullYear();default:return NaN}}function ky(s,e,t){var n,r,i,a,o;if(!(!s.isValid()||isNaN(t))){switch(n=s._d,r=s._isUTC,e){case"Milliseconds":return void(r?n.setUTCMilliseconds(t):n.setMilliseconds(t));case"Seconds":return void(r?n.setUTCSeconds(t):n.setSeconds(t));case"Minutes":return void(r?n.setUTCMinutes(t):n.setMinutes(t));case"Hours":return void(r?n.setUTCHours(t):n.setHours(t));case"Date":return void(r?n.setUTCDate(t):n.setDate(t));case"FullYear":break;default:return}i=t,a=s.month(),o=s.date(),o=o===29&&a===1&&!lc(i)?28:o,r?n.setUTCFullYear(i,a,o):n.setFullYear(i,a,o)}}function iP(s){return s=qn(s),Er(this[s])?this[s]():this}function sP(s,e){if(typeof s=="object"){s=hh(s);var t=zM(s),n,r=t.length;for(n=0;n<r;n++)this[t[n].unit](s[t[n].unit])}else if(s=qn(s),Er(this[s]))return this[s](e);return this}function aP(s,e){return(s%e+e)%e}var _t;Array.prototype.indexOf?_t=Array.prototype.indexOf:_t=function(s){var e;for(e=0;e<this.length;++e)if(this[e]===s)return e;return-1};function mh(s,e){if(isNaN(s)||isNaN(e))return NaN;var t=aP(e,12);return s+=(e-t)/12,t===1?lc(s)?29:28:31-t%7%2}Te("M",["MM",2],"Mo",function(){return this.month()+1});Te("MMM",0,0,function(s){return this.localeData().monthsShort(this,s)});Te("MMMM",0,0,function(s){return this.localeData().months(this,s)});de("M",mt,gs);de("MM",mt,bn);de("MMM",function(s,e){return e.monthsShortRegex(s)});de("MMMM",function(s,e){return e.monthsRegex(s)});ot(["M","MM"],function(s,e){e[Dr]=Ve(s)-1});ot(["MMM","MMMM"],function(s,e,t,n){var r=t._locale.monthsParse(s,n,t._strict);r!=null?e[Dr]=r:Be(t).invalidMonth=s});var oP="January_February_March_April_May_June_July_August_September_October_November_December".split("_"),jy="Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),Wy=/D[oD]?(\[[^\[\]]*\]|\s)+MMMM?/,cP=oa,uP=oa;function lP(s,e){return s?Zn(this._months)?this._months[s.month()]:this._months[(this._months.isFormat||Wy).test(e)?"format":"standalone"][s.month()]:Zn(this._months)?this._months:this._months.standalone}function hP(s,e){return s?Zn(this._monthsShort)?this._monthsShort[s.month()]:this._monthsShort[Wy.test(e)?"format":"standalone"][s.month()]:Zn(this._monthsShort)?this._monthsShort:this._monthsShort.standalone}function dP(s,e,t){var n,r,i,a=s.toLocaleLowerCase();if(!this._monthsParse)for(this._monthsParse=[],this._longMonthsParse=[],this._shortMonthsParse=[],n=0;n<12;++n)i=gr([2e3,n]),this._shortMonthsParse[n]=this.monthsShort(i,"").toLocaleLowerCase(),this._longMonthsParse[n]=this.months(i,"").toLocaleLowerCase();return t?e==="MMM"?(r=_t.call(this._shortMonthsParse,a),r!==-1?r:null):(r=_t.call(this._longMonthsParse,a),r!==-1?r:null):e==="MMM"?(r=_t.call(this._shortMonthsParse,a),r!==-1?r:(r=_t.call(this._longMonthsParse,a),r!==-1?r:null)):(r=_t.call(this._longMonthsParse,a),r!==-1?r:(r=_t.call(this._shortMonthsParse,a),r!==-1?r:null))}function fP(s,e,t){var n,r,i;if(this._monthsParseExact)return dP.call(this,s,e,t);for(this._monthsParse||(this._monthsParse=[],this._longMonthsParse=[],this._shortMonthsParse=[]),n=0;n<12;n++){if(r=gr([2e3,n]),t&&!this._longMonthsParse[n]&&(this._longMonthsParse[n]=new RegExp("^"+this.months(r,"").replace(".","")+"$","i"),this._shortMonthsParse[n]=new RegExp("^"+this.monthsShort(r,"").replace(".","")+"$","i")),!t&&!this._monthsParse[n]&&(i="^"+this.months(r,"")+"|^"+this.monthsShort(r,""),this._monthsParse[n]=new RegExp(i.replace(".",""),"i")),t&&e==="MMMM"&&this._longMonthsParse[n].test(s))return n;if(t&&e==="MMM"&&this._shortMonthsParse[n].test(s))return n;if(!t&&this._monthsParse[n].test(s))return n}}function Qy(s,e){if(!s.isValid())return s;if(typeof e=="string"){if(/^\d+$/.test(e))e=Ve(e);else if(e=s.localeData().monthsParse(e),!Fr(e))return s}var t=e,n=s.date();return n=n<29?n:Math.min(n,mh(s.year(),t)),s._isUTC?s._d.setUTCMonth(t,n):s._d.setMonth(t,n),s}function Vy(s){return s!=null?(Qy(this,s),le.updateOffset(this,!0),this):Ks(this,"Month")}function pP(){return mh(this.year(),this.month())}function mP(s){return this._monthsParseExact?(et(this,"_monthsRegex")||Hy.call(this),s?this._monthsShortStrictRegex:this._monthsShortRegex):(et(this,"_monthsShortRegex")||(this._monthsShortRegex=cP),this._monthsShortStrictRegex&&s?this._monthsShortStrictRegex:this._monthsShortRegex)}function yP(s){return this._monthsParseExact?(et(this,"_monthsRegex")||Hy.call(this),s?this._monthsStrictRegex:this._monthsRegex):(et(this,"_monthsRegex")||(this._monthsRegex=uP),this._monthsStrictRegex&&s?this._monthsStrictRegex:this._monthsRegex)}function Hy(){function s(l,h){return h.length-l.length}var e=[],t=[],n=[],r,i,a,o;for(r=0;r<12;r++)i=gr([2e3,r]),a=Lr(this.monthsShort(i,"")),o=Lr(this.months(i,"")),e.push(a),t.push(o),n.push(o),n.push(a);e.sort(s),t.sort(s),n.sort(s),this._monthsRegex=new RegExp("^("+n.join("|")+")","i"),this._monthsShortRegex=this._monthsRegex,this._monthsStrictRegex=new RegExp("^("+t.join("|")+")","i"),this._monthsShortStrictRegex=new RegExp("^("+e.join("|")+")","i")}function gP(s,e,t,n,r,i,a){var o;return s<100&&s>=0?(o=new Date(s+400,e,t,n,r,i,a),isFinite(o.getFullYear())&&o.setFullYear(s)):o=new Date(s,e,t,n,r,i,a),o}function Js(s){var e,t;return s<100&&s>=0?(t=Array.prototype.slice.call(arguments),t[0]=s+400,e=new Date(Date.UTC.apply(null,t)),isFinite(e.getUTCFullYear())&&e.setUTCFullYear(s)):e=new Date(Date.UTC.apply(null,arguments)),e}function Lo(s,e,t){var n=7+e-t,r=(7+Js(s,0,n).getUTCDay()-e)%7;return-r+n-1}function Yy(s,e,t,n,r){var i=(7+t-n)%7,a=Lo(s,n,r),o=1+7*(e-1)+i+a,l,h;return o<=0?(l=s-1,h=Ys(l)+o):o>Ys(s)?(l=s+1,h=o-Ys(s)):(l=s,h=o),{year:l,dayOfYear:h}}function Xs(s,e,t){var n=Lo(s.year(),e,t),r=Math.floor((s.dayOfYear()-n-1)/7)+1,i,a;return r<1?(a=s.year()-1,i=r+qr(a,e,t)):r>qr(s.year(),e,t)?(i=r-qr(s.year(),e,t),a=s.year()+1):(a=s.year(),i=r),{week:i,year:a}}function qr(s,e,t){var n=Lo(s,e,t),r=Lo(s+1,e,t);return(Ys(s)-n+r)/7}Te("w",["ww",2],"wo","week");Te("W",["WW",2],"Wo","isoWeek");de("w",mt,gs);de("ww",mt,bn);de("W",mt,gs);de("WW",mt,bn);ca(["w","ww","W","WW"],function(s,e,t,n){e[n.substr(0,1)]=Ve(s)});function EP(s){return Xs(s,this._week.dow,this._week.doy).week}var wP={dow:0,doy:6};function bP(){return this._week.dow}function TP(){return this._week.doy}function SP(s){var e=this.localeData().week(this);return s==null?e:this.add((s-e)*7,"d")}function AP(s){var e=Xs(this,1,4).week;return s==null?e:this.add((s-e)*7,"d")}Te("d",0,"do","day");Te("dd",0,0,function(s){return this.localeData().weekdaysMin(this,s)});Te("ddd",0,0,function(s){return this.localeData().weekdaysShort(this,s)});Te("dddd",0,0,function(s){return this.localeData().weekdays(this,s)});Te("e",0,0,"weekday");Te("E",0,0,"isoWeekday");de("d",mt);de("e",mt);de("E",mt);de("dd",function(s,e){return e.weekdaysMinRegex(s)});de("ddd",function(s,e){return e.weekdaysShortRegex(s)});de("dddd",function(s,e){return e.weekdaysRegex(s)});ca(["dd","ddd","dddd"],function(s,e,t,n){var r=t._locale.weekdaysParse(s,n,t._strict);r!=null?e.d=r:Be(t).invalidWeekday=s});ca(["d","e","E"],function(s,e,t,n){e[n]=Ve(s)});function NP(s,e){return typeof s!="string"?s:isNaN(s)?(s=e.weekdaysParse(s),typeof s=="number"?s:null):parseInt(s,10)}function CP(s,e){return typeof s=="string"?e.weekdaysParse(s)%7||7:isNaN(s)?null:s}function yh(s,e){return s.slice(e,7).concat(s.slice(0,e))}var vP="Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),Gy="Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),RP="Su_Mo_Tu_We_Th_Fr_Sa".split("_"),_P=oa,xP=oa,MP=oa;function PP(s,e){var t=Zn(this._weekdays)?this._weekdays:this._weekdays[s&&s!==!0&&this._weekdays.isFormat.test(e)?"format":"standalone"];return s===!0?yh(t,this._week.dow):s?t[s.day()]:t}function OP(s){return s===!0?yh(this._weekdaysShort,this._week.dow):s?this._weekdaysShort[s.day()]:this._weekdaysShort}function DP(s){return s===!0?yh(this._weekdaysMin,this._week.dow):s?this._weekdaysMin[s.day()]:this._weekdaysMin}function IP(s,e,t){var n,r,i,a=s.toLocaleLowerCase();if(!this._weekdaysParse)for(this._weekdaysParse=[],this._shortWeekdaysParse=[],this._minWeekdaysParse=[],n=0;n<7;++n)i=gr([2e3,1]).day(n),this._minWeekdaysParse[n]=this.weekdaysMin(i,"").toLocaleLowerCase(),this._shortWeekdaysParse[n]=this.weekdaysShort(i,"").toLocaleLowerCase(),this._weekdaysParse[n]=this.weekdays(i,"").toLocaleLowerCase();return t?e==="dddd"?(r=_t.call(this._weekdaysParse,a),r!==-1?r:null):e==="ddd"?(r=_t.call(this._shortWeekdaysParse,a),r!==-1?r:null):(r=_t.call(this._minWeekdaysParse,a),r!==-1?r:null):e==="dddd"?(r=_t.call(this._weekdaysParse,a),r!==-1||(r=_t.call(this._shortWeekdaysParse,a),r!==-1)?r:(r=_t.call(this._minWeekdaysParse,a),r!==-1?r:null)):e==="ddd"?(r=_t.call(this._shortWeekdaysParse,a),r!==-1||(r=_t.call(this._weekdaysParse,a),r!==-1)?r:(r=_t.call(this._minWeekdaysParse,a),r!==-1?r:null)):(r=_t.call(this._minWeekdaysParse,a),r!==-1||(r=_t.call(this._weekdaysParse,a),r!==-1)?r:(r=_t.call(this._shortWeekdaysParse,a),r!==-1?r:null))}function $P(s,e,t){var n,r,i;if(this._weekdaysParseExact)return IP.call(this,s,e,t);for(this._weekdaysParse||(this._weekdaysParse=[],this._minWeekdaysParse=[],this._shortWeekdaysParse=[],this._fullWeekdaysParse=[]),n=0;n<7;n++){if(r=gr([2e3,1]).day(n),t&&!this._fullWeekdaysParse[n]&&(this._fullWeekdaysParse[n]=new RegExp("^"+this.weekdays(r,"").replace(".","\\.?")+"$","i"),this._shortWeekdaysParse[n]=new RegExp("^"+this.weekdaysShort(r,"").replace(".","\\.?")+"$","i"),this._minWeekdaysParse[n]=new RegExp("^"+this.weekdaysMin(r,"").replace(".","\\.?")+"$","i")),this._weekdaysParse[n]||(i="^"+this.weekdays(r,"")+"|^"+this.weekdaysShort(r,"")+"|^"+this.weekdaysMin(r,""),this._weekdaysParse[n]=new RegExp(i.replace(".",""),"i")),t&&e==="dddd"&&this._fullWeekdaysParse[n].test(s))return n;if(t&&e==="ddd"&&this._shortWeekdaysParse[n].test(s))return n;if(t&&e==="dd"&&this._minWeekdaysParse[n].test(s))return n;if(!t&&this._weekdaysParse[n].test(s))return n}}function LP(s){if(!this.isValid())return s!=null?this:NaN;var e=Ks(this,"Day");return s!=null?(s=NP(s,this.localeData()),this.add(s-e,"d")):e}function qP(s){if(!this.isValid())return s!=null?this:NaN;var e=(this.day()+7-this.localeData()._week.dow)%7;return s==null?e:this.add(s-e,"d")}function BP(s){if(!this.isValid())return s!=null?this:NaN;if(s!=null){var e=CP(s,this.localeData());return this.day(this.day()%7?e:e-7)}else return this.day()||7}function UP(s){return this._weekdaysParseExact?(et(this,"_weekdaysRegex")||gh.call(this),s?this._weekdaysStrictRegex:this._weekdaysRegex):(et(this,"_weekdaysRegex")||(this._weekdaysRegex=_P),this._weekdaysStrictRegex&&s?this._weekdaysStrictRegex:this._weekdaysRegex)}function FP(s){return this._weekdaysParseExact?(et(this,"_weekdaysRegex")||gh.call(this),s?this._weekdaysShortStrictRegex:this._weekdaysShortRegex):(et(this,"_weekdaysShortRegex")||(this._weekdaysShortRegex=xP),this._weekdaysShortStrictRegex&&s?this._weekdaysShortStrictRegex:this._weekdaysShortRegex)}function kP(s){return this._weekdaysParseExact?(et(this,"_weekdaysRegex")||gh.call(this),s?this._weekdaysMinStrictRegex:this._weekdaysMinRegex):(et(this,"_weekdaysMinRegex")||(this._weekdaysMinRegex=MP),this._weekdaysMinStrictRegex&&s?this._weekdaysMinStrictRegex:this._weekdaysMinRegex)}function gh(){function s(d,p){return p.length-d.length}var e=[],t=[],n=[],r=[],i,a,o,l,h;for(i=0;i<7;i++)a=gr([2e3,1]).day(i),o=Lr(this.weekdaysMin(a,"")),l=Lr(this.weekdaysShort(a,"")),h=Lr(this.weekdays(a,"")),e.push(o),t.push(l),n.push(h),r.push(o),r.push(l),r.push(h);e.sort(s),t.sort(s),n.sort(s),r.sort(s),this._weekdaysRegex=new RegExp("^("+r.join("|")+")","i"),this._weekdaysShortRegex=this._weekdaysRegex,this._weekdaysMinRegex=this._weekdaysRegex,this._weekdaysStrictRegex=new RegExp("^("+n.join("|")+")","i"),this._weekdaysShortStrictRegex=new RegExp("^("+t.join("|")+")","i"),this._weekdaysMinStrictRegex=new RegExp("^("+e.join("|")+")","i")}function Eh(){return this.hours()%12||12}function jP(){return this.hours()||24}Te("H",["HH",2],0,"hour");Te("h",["hh",2],0,Eh);Te("k",["kk",2],0,jP);Te("hmm",0,0,function(){return""+Eh.apply(this)+pr(this.minutes(),2)});Te("hmmss",0,0,function(){return""+Eh.apply(this)+pr(this.minutes(),2)+pr(this.seconds(),2)});Te("Hmm",0,0,function(){return""+this.hours()+pr(this.minutes(),2)});Te("Hmmss",0,0,function(){return""+this.hours()+pr(this.minutes(),2)+pr(this.seconds(),2)});function zy(s,e){Te(s,0,0,function(){return this.localeData().meridiem(this.hours(),this.minutes(),e)})}zy("a",!0);zy("A",!1);function Ky(s,e){return e._meridiemParse}de("a",Ky);de("A",Ky);de("H",mt,ph);de("h",mt,gs);de("k",mt,gs);de("HH",mt,bn);de("hh",mt,bn);de("kk",mt,bn);de("hmm",By);de("hmmss",Uy);de("Hmm",By);de("Hmmss",Uy);ot(["H","HH"],Dt);ot(["k","kk"],function(s,e,t){var n=Ve(s);e[Dt]=n===24?0:n});ot(["a","A"],function(s,e,t){t._isPm=t._locale.isPM(s),t._meridiem=s});ot(["h","hh"],function(s,e,t){e[Dt]=Ve(s),Be(t).bigHour=!0});ot("hmm",function(s,e,t){var n=s.length-2;e[Dt]=Ve(s.substr(0,n)),e[zn]=Ve(s.substr(n)),Be(t).bigHour=!0});ot("hmmss",function(s,e,t){var n=s.length-4,r=s.length-2;e[Dt]=Ve(s.substr(0,n)),e[zn]=Ve(s.substr(n,2)),e[Ir]=Ve(s.substr(r)),Be(t).bigHour=!0});ot("Hmm",function(s,e,t){var n=s.length-2;e[Dt]=Ve(s.substr(0,n)),e[zn]=Ve(s.substr(n))});ot("Hmmss",function(s,e,t){var n=s.length-4,r=s.length-2;e[Dt]=Ve(s.substr(0,n)),e[zn]=Ve(s.substr(n,2)),e[Ir]=Ve(s.substr(r))});function WP(s){return(s+"").toLowerCase().charAt(0)==="p"}var QP=/[ap]\.?m?\.?/i,VP=Es("Hours",!0);function HP(s,e,t){return s>11?t?"pm":"PM":t?"am":"AM"}var Jy={calendar:IM,longDateFormat:BM,invalidDate:FM,ordinal:jM,dayOfMonthOrdinalParse:WM,relativeTime:VM,months:oP,monthsShort:jy,week:wP,weekdays:vP,weekdaysMin:RP,weekdaysShort:Gy,meridiemParse:QP},Et={},ks={},Zs;function YP(s,e){var t,n=Math.min(s.length,e.length);for(t=0;t<n;t+=1)if(s[t]!==e[t])return t;return n}function am(s){return s&&s.toLowerCase().replace("_","-")}function GP(s){for(var e=0,t,n,r,i;e<s.length;){for(i=am(s[e]).split("-"),t=i.length,n=am(s[e+1]),n=n?n.split("-"):null;t>0;){if(r=hc(i.slice(0,t).join("-")),r)return r;if(n&&n.length>=t&&YP(i,n)>=t-1)break;t--}e++}return Zs}function zP(s){return!!(s&&s.match("^[^/\\\\]*$"))}function hc(s){var e=null,t;if(Et[s]===void 0&&typeof module<"u"&&module&&module.exports&&zP(s))try{e=Zs._abbr,t=require,t("./locale/"+s),oi(e)}catch{Et[s]=null}return Et[s]}function oi(s,e){var t;return s&&(un(e)?t=kr(s):t=wh(s,e),t?Zs=t:typeof console<"u"&&console.warn&&console.warn("Locale "+s+" not found. Did you forget to load it?")),Zs._abbr}function wh(s,e){if(e!==null){var t,n=Jy;if(e.abbr=s,Et[s]!=null)Iy("defineLocaleOverride","use moment.updateLocale(localeName, config) to change an existing locale. moment.defineLocale(localeName, config) should only be used for creating a new locale See http://momentjs.com/guides/#/warnings/define-locale/ for more info."),n=Et[s]._config;else if(e.parentLocale!=null)if(Et[e.parentLocale]!=null)n=Et[e.parentLocale]._config;else if(t=hc(e.parentLocale),t!=null)n=t._config;else return ks[e.parentLocale]||(ks[e.parentLocale]=[]),ks[e.parentLocale].push({name:s,config:e}),null;return Et[s]=new uh(xl(n,e)),ks[s]&&ks[s].forEach(function(r){wh(r.name,r.config)}),oi(s),Et[s]}else return delete Et[s],null}function KP(s,e){if(e!=null){var t,n,r=Jy;Et[s]!=null&&Et[s].parentLocale!=null?Et[s].set(xl(Et[s]._config,e)):(n=hc(s),n!=null&&(r=n._config),e=xl(r,e),n==null&&(e.abbr=s),t=new uh(e),t.parentLocale=Et[s],Et[s]=t),oi(s)}else Et[s]!=null&&(Et[s].parentLocale!=null?(Et[s]=Et[s].parentLocale,s===oi()&&oi(s)):Et[s]!=null&&delete Et[s]);return Et[s]}function kr(s){var e;if(s&&s._locale&&s._locale._abbr&&(s=s._locale._abbr),!s)return Zs;if(!Zn(s)){if(e=hc(s),e)return e;s=[s]}return GP(s)}function JP(){return Ml(Et)}function bh(s){var e,t=s._a;return t&&Be(s).overflow===-2&&(e=t[Dr]<0||t[Dr]>11?Dr:t[lr]<1||t[lr]>mh(t[Kt],t[Dr])?lr:t[Dt]<0||t[Dt]>24||t[Dt]===24&&(t[zn]!==0||t[Ir]!==0||t[Si]!==0)?Dt:t[zn]<0||t[zn]>59?zn:t[Ir]<0||t[Ir]>59?Ir:t[Si]<0||t[Si]>999?Si:-1,Be(s)._overflowDayOfYear&&(e<Kt||e>lr)&&(e=lr),Be(s)._overflowWeeks&&e===-1&&(e=tP),Be(s)._overflowWeekday&&e===-1&&(e=nP),Be(s).overflow=e),s}var XP=/^\s*((?:[+-]\d{6}|\d{4})-(?:\d\d-\d\d|W\d\d-\d|W\d\d|\d\d\d|\d\d))(?:(T| )(\d\d(?::\d\d(?::\d\d(?:[.,]\d+)?)?)?)([+-]\d\d(?::?\d\d)?|\s*Z)?)?$/,ZP=/^\s*((?:[+-]\d{6}|\d{4})(?:\d\d\d\d|W\d\d\d|W\d\d|\d\d\d|\d\d|))(?:(T| )(\d\d(?:\d\d(?:\d\d(?:[.,]\d+)?)?)?)([+-]\d\d(?::?\d\d)?|\s*Z)?)?$/,eO=/Z|[+-]\d\d(?::?\d\d)?/,uo=[["YYYYYY-MM-DD",/[+-]\d{6}-\d\d-\d\d/],["YYYY-MM-DD",/\d{4}-\d\d-\d\d/],["GGGG-[W]WW-E",/\d{4}-W\d\d-\d/],["GGGG-[W]WW",/\d{4}-W\d\d/,!1],["YYYY-DDD",/\d{4}-\d{3}/],["YYYY-MM",/\d{4}-\d\d/,!1],["YYYYYYMMDD",/[+-]\d{10}/],["YYYYMMDD",/\d{8}/],["GGGG[W]WWE",/\d{4}W\d{3}/],["GGGG[W]WW",/\d{4}W\d{2}/,!1],["YYYYDDD",/\d{7}/],["YYYYMM",/\d{6}/,!1],["YYYY",/\d{4}/,!1]],tl=[["HH:mm:ss.SSSS",/\d\d:\d\d:\d\d\.\d+/],["HH:mm:ss,SSSS",/\d\d:\d\d:\d\d,\d+/],["HH:mm:ss",/\d\d:\d\d:\d\d/],["HH:mm",/\d\d:\d\d/],["HHmmss.SSSS",/\d\d\d\d\d\d\.\d+/],["HHmmss,SSSS",/\d\d\d\d\d\d,\d+/],["HHmmss",/\d\d\d\d\d\d/],["HHmm",/\d\d\d\d/],["HH",/\d\d/]],tO=/^\/?Date\((-?\d+)/i,nO=/^(?:(Mon|Tue|Wed|Thu|Fri|Sat|Sun),?\s)?(\d{1,2})\s(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s(\d{2,4})\s(\d\d):(\d\d)(?::(\d\d))?\s(?:(UT|GMT|[ECMP][SD]T)|([Zz])|([+-]\d{4}))$/,rO={UT:0,GMT:0,EDT:-4*60,EST:-5*60,CDT:-5*60,CST:-6*60,MDT:-6*60,MST:-7*60,PDT:-7*60,PST:-8*60};function Xy(s){var e,t,n=s._i,r=XP.exec(n)||ZP.exec(n),i,a,o,l,h=uo.length,d=tl.length;if(r){for(Be(s).iso=!0,e=0,t=h;e<t;e++)if(uo[e][1].exec(r[1])){a=uo[e][0],i=uo[e][2]!==!1;break}if(a==null){s._isValid=!1;return}if(r[3]){for(e=0,t=d;e<t;e++)if(tl[e][1].exec(r[3])){o=(r[2]||" ")+tl[e][0];break}if(o==null){s._isValid=!1;return}}if(!i&&o!=null){s._isValid=!1;return}if(r[4])if(eO.exec(r[4]))l="Z";else{s._isValid=!1;return}s._f=a+(o||"")+(l||""),Sh(s)}else s._isValid=!1}function iO(s,e,t,n,r,i){var a=[sO(s),jy.indexOf(e),parseInt(t,10),parseInt(n,10),parseInt(r,10)];return i&&a.push(parseInt(i,10)),a}function sO(s){var e=parseInt(s,10);return e<=49?2e3+e:e<=999?1900+e:e}function aO(s){return s.replace(/\([^()]*\)|[\n\t]/g," ").replace(/(\s\s+)/g," ").replace(/^\s\s*/,"").replace(/\s\s*$/,"")}function oO(s,e,t){if(s){var n=Gy.indexOf(s),r=new Date(e[0],e[1],e[2]).getDay();if(n!==r)return Be(t).weekdayMismatch=!0,t._isValid=!1,!1}return!0}function cO(s,e,t){if(s)return rO[s];if(e)return 0;var n=parseInt(t,10),r=n%100,i=(n-r)/100;return i*60+r}function Zy(s){var e=nO.exec(aO(s._i)),t;if(e){if(t=iO(e[4],e[3],e[2],e[5],e[6],e[7]),!oO(e[1],t,s))return;s._a=t,s._tzm=cO(e[8],e[9],e[10]),s._d=Js.apply(null,s._a),s._d.setUTCMinutes(s._d.getUTCMinutes()-s._tzm),Be(s).rfc2822=!0}else s._isValid=!1}function uO(s){var e=tO.exec(s._i);if(e!==null){s._d=new Date(+e[1]);return}if(Xy(s),s._isValid===!1)delete s._isValid;else return;if(Zy(s),s._isValid===!1)delete s._isValid;else return;s._strict?s._isValid=!1:le.createFromInputFallback(s)}le.createFromInputFallback=Ln("value provided is not in a recognized RFC2822 or ISO format. moment construction falls back to js Date(), which is not reliable across all browsers and versions. Non RFC2822/ISO date formats are discouraged. Please refer to http://momentjs.com/guides/#/warnings/js-date/ for more info.",function(s){s._d=new Date(s._i+(s._useUTC?" UTC":""))});function Xi(s,e,t){return s??e??t}function lO(s){var e=new Date(le.now());return s._useUTC?[e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate()]:[e.getFullYear(),e.getMonth(),e.getDate()]}function Th(s){var e,t,n=[],r,i,a;if(!s._d){for(r=lO(s),s._w&&s._a[lr]==null&&s._a[Dr]==null&&hO(s),s._dayOfYear!=null&&(a=Xi(s._a[Kt],r[Kt]),(s._dayOfYear>Ys(a)||s._dayOfYear===0)&&(Be(s)._overflowDayOfYear=!0),t=Js(a,0,s._dayOfYear),s._a[Dr]=t.getUTCMonth(),s._a[lr]=t.getUTCDate()),e=0;e<3&&s._a[e]==null;++e)s._a[e]=n[e]=r[e];for(;e<7;e++)s._a[e]=n[e]=s._a[e]==null?e===2?1:0:s._a[e];s._a[Dt]===24&&s._a[zn]===0&&s._a[Ir]===0&&s._a[Si]===0&&(s._nextDay=!0,s._a[Dt]=0),s._d=(s._useUTC?Js:gP).apply(null,n),i=s._useUTC?s._d.getUTCDay():s._d.getDay(),s._tzm!=null&&s._d.setUTCMinutes(s._d.getUTCMinutes()-s._tzm),s._nextDay&&(s._a[Dt]=24),s._w&&typeof s._w.d<"u"&&s._w.d!==i&&(Be(s).weekdayMismatch=!0)}}function hO(s){var e,t,n,r,i,a,o,l,h;e=s._w,e.GG!=null||e.W!=null||e.E!=null?(i=1,a=4,t=Xi(e.GG,s._a[Kt],Xs(pt(),1,4).year),n=Xi(e.W,1),r=Xi(e.E,1),(r<1||r>7)&&(l=!0)):(i=s._locale._week.dow,a=s._locale._week.doy,h=Xs(pt(),i,a),t=Xi(e.gg,s._a[Kt],h.year),n=Xi(e.w,h.week),e.d!=null?(r=e.d,(r<0||r>6)&&(l=!0)):e.e!=null?(r=e.e+i,(e.e<0||e.e>6)&&(l=!0)):r=i),n<1||n>qr(t,i,a)?Be(s)._overflowWeeks=!0:l!=null?Be(s)._overflowWeekday=!0:(o=Yy(t,n,r,i,a),s._a[Kt]=o.year,s._dayOfYear=o.dayOfYear)}le.ISO_8601=function(){};le.RFC_2822=function(){};function Sh(s){if(s._f===le.ISO_8601){Xy(s);return}if(s._f===le.RFC_2822){Zy(s);return}s._a=[],Be(s).empty=!0;var e=""+s._i,t,n,r,i,a,o=e.length,l=0,h,d;for(r=$y(s._f,s._locale).match(lh)||[],d=r.length,t=0;t<d;t++)i=r[t],n=(e.match(XM(i,s))||[])[0],n&&(a=e.substr(0,e.indexOf(n)),a.length>0&&Be(s).unusedInput.push(a),e=e.slice(e.indexOf(n)+n.length),l+=n.length),rs[i]?(n?Be(s).empty=!1:Be(s).unusedTokens.push(i),eP(i,n,s)):s._strict&&!n&&Be(s).unusedTokens.push(i);Be(s).charsLeftOver=o-l,e.length>0&&Be(s).unusedInput.push(e),s._a[Dt]<=12&&Be(s).bigHour===!0&&s._a[Dt]>0&&(Be(s).bigHour=void 0),Be(s).parsedDateParts=s._a.slice(0),Be(s).meridiem=s._meridiem,s._a[Dt]=dO(s._locale,s._a[Dt],s._meridiem),h=Be(s).era,h!==null&&(s._a[Kt]=s._locale.erasConvertYear(h,s._a[Kt])),Th(s),bh(s)}function dO(s,e,t){var n;return t==null?e:s.meridiemHour!=null?s.meridiemHour(e,t):(s.isPM!=null&&(n=s.isPM(t),n&&e<12&&(e+=12),!n&&e===12&&(e=0)),e)}function fO(s){var e,t,n,r,i,a,o=!1,l=s._f.length;if(l===0){Be(s).invalidFormat=!0,s._d=new Date(NaN);return}for(r=0;r<l;r++)i=0,a=!1,e=ch({},s),s._useUTC!=null&&(e._useUTC=s._useUTC),e._f=s._f[r],Sh(e),oh(e)&&(a=!0),i+=Be(e).charsLeftOver,i+=Be(e).unusedTokens.length*10,Be(e).score=i,o?i<n&&(n=i,t=e):(n==null||i<n||a)&&(n=i,t=e,a&&(o=!0));ii(s,t||e)}function pO(s){if(!s._d){var e=hh(s._i),t=e.day===void 0?e.date:e.day;s._a=Oy([e.year,e.month,t,e.hour,e.minute,e.second,e.millisecond],function(n){return n&&parseInt(n,10)}),Th(s)}}function mO(s){var e=new aa(bh(eg(s)));return e._nextDay&&(e.add(1,"d"),e._nextDay=void 0),e}function eg(s){var e=s._i,t=s._f;return s._locale=s._locale||kr(s._l),e===null||t===void 0&&e===""?ic({nullInput:!0}):(typeof e=="string"&&(s._i=e=s._locale.preparse(e)),er(e)?new aa(bh(e)):(sa(e)?s._d=e:Zn(t)?fO(s):t?Sh(s):yO(s),oh(s)||(s._d=null),s))}function yO(s){var e=s._i;un(e)?s._d=new Date(le.now()):sa(e)?s._d=new Date(e.valueOf()):typeof e=="string"?uO(s):Zn(e)?(s._a=Oy(e.slice(0),function(t){return parseInt(t,10)}),Th(s)):Ni(e)?pO(s):Fr(e)?s._d=new Date(e):le.createFromInputFallback(s)}function tg(s,e,t,n,r){var i={};return(e===!0||e===!1)&&(n=e,e=void 0),(t===!0||t===!1)&&(n=t,t=void 0),(Ni(s)&&ah(s)||Zn(s)&&s.length===0)&&(s=void 0),i._isAMomentObject=!0,i._useUTC=i._isUTC=r,i._l=t,i._i=s,i._f=e,i._strict=n,mO(i)}function pt(s,e,t,n){return tg(s,e,t,n,!1)}var gO=Ln("moment().min is deprecated, use moment.max instead. http://momentjs.com/guides/#/warnings/min-max/",function(){var s=pt.apply(null,arguments);return this.isValid()&&s.isValid()?s<this?this:s:ic()}),EO=Ln("moment().max is deprecated, use moment.min instead. http://momentjs.com/guides/#/warnings/min-max/",function(){var s=pt.apply(null,arguments);return this.isValid()&&s.isValid()?s>this?this:s:ic()});function ng(s,e){var t,n;if(e.length===1&&Zn(e[0])&&(e=e[0]),!e.length)return pt();for(t=e[0],n=1;n<e.length;++n)(!e[n].isValid()||e[n][s](t))&&(t=e[n]);return t}function wO(){var s=[].slice.call(arguments,0);return ng("isBefore",s)}function bO(){var s=[].slice.call(arguments,0);return ng("isAfter",s)}var TO=function(){return Date.now?Date.now():+new Date},js=["year","quarter","month","week","day","hour","minute","second","millisecond"];function SO(s){var e,t=!1,n,r=js.length;for(e in s)if(et(s,e)&&!(_t.call(js,e)!==-1&&(s[e]==null||!isNaN(s[e]))))return!1;for(n=0;n<r;++n)if(s[js[n]]){if(t)return!1;parseFloat(s[js[n]])!==Ve(s[js[n]])&&(t=!0)}return!0}function AO(){return this._isValid}function NO(){return nr(NaN)}function dc(s){var e=hh(s),t=e.year||0,n=e.quarter||0,r=e.month||0,i=e.week||e.isoWeek||0,a=e.day||0,o=e.hour||0,l=e.minute||0,h=e.second||0,d=e.millisecond||0;this._isValid=SO(e),this._milliseconds=+d+h*1e3+l*6e4+o*1e3*60*60,this._days=+a+i*7,this._months=+r+n*3+t*12,this._data={},this._locale=kr(),this._bubble()}function Ao(s){return s instanceof dc}function Ol(s){return s<0?Math.round(-1*s)*-1:Math.round(s)}function CO(s,e,t){var n=Math.min(s.length,e.length),r=Math.abs(s.length-e.length),i=0,a;for(a=0;a<n;a++)Ve(s[a])!==Ve(e[a])&&i++;return i+r}function rg(s,e){Te(s,0,0,function(){var t=this.utcOffset(),n="+";return t<0&&(t=-t,n="-"),n+pr(~~(t/60),2)+e+pr(~~t%60,2)})}rg("Z",":");rg("ZZ","");de("Z",uc);de("ZZ",uc);ot(["Z","ZZ"],function(s,e,t){t._useUTC=!0,t._tzm=Ah(uc,s)});var vO=/([\+\-]|\d\d)/gi;function Ah(s,e){var t=(e||"").match(s),n,r,i;return t===null?null:(n=t[t.length-1]||[],r=(n+"").match(vO)||["-",0,0],i=+(r[1]*60)+Ve(r[2]),i===0?0:r[0]==="+"?i:-i)}function Nh(s,e){var t,n;return e._isUTC?(t=e.clone(),n=(er(s)||sa(s)?s.valueOf():pt(s).valueOf())-t.valueOf(),t._d.setTime(t._d.valueOf()+n),le.updateOffset(t,!1),t):pt(s).local()}function Dl(s){return-Math.round(s._d.getTimezoneOffset())}le.updateOffset=function(){};function RO(s,e,t){var n=this._offset||0,r;if(!this.isValid())return s!=null?this:NaN;if(s!=null){if(typeof s=="string"){if(s=Ah(uc,s),s===null)return this}else Math.abs(s)<16&&!t&&(s=s*60);return!this._isUTC&&e&&(r=Dl(this)),this._offset=s,this._isUTC=!0,r!=null&&this.add(r,"m"),n!==s&&(!e||this._changeInProgress?ag(this,nr(s-n,"m"),1,!1):this._changeInProgress||(this._changeInProgress=!0,le.updateOffset(this,!0),this._changeInProgress=null)),this}else return this._isUTC?n:Dl(this)}function _O(s,e){return s!=null?(typeof s!="string"&&(s=-s),this.utcOffset(s,e),this):-this.utcOffset()}function xO(s){return this.utcOffset(0,s)}function MO(s){return this._isUTC&&(this.utcOffset(0,s),this._isUTC=!1,s&&this.subtract(Dl(this),"m")),this}function PO(){if(this._tzm!=null)this.utcOffset(this._tzm,!1,!0);else if(typeof this._i=="string"){var s=Ah(KM,this._i);s!=null?this.utcOffset(s):this.utcOffset(0,!0)}return this}function OO(s){return this.isValid()?(s=s?pt(s).utcOffset():0,(this.utcOffset()-s)%60===0):!1}function DO(){return this.utcOffset()>this.clone().month(0).utcOffset()||this.utcOffset()>this.clone().month(5).utcOffset()}function IO(){if(!un(this._isDSTShifted))return this._isDSTShifted;var s={},e;return ch(s,this),s=eg(s),s._a?(e=s._isUTC?gr(s._a):pt(s._a),this._isDSTShifted=this.isValid()&&CO(s._a,e.toArray())>0):this._isDSTShifted=!1,this._isDSTShifted}function $O(){return this.isValid()?!this._isUTC:!1}function LO(){return this.isValid()?this._isUTC:!1}function ig(){return this.isValid()?this._isUTC&&this._offset===0:!1}var qO=/^(-|\+)?(?:(\d*)[. ])?(\d+):(\d+)(?::(\d+)(\.\d*)?)?$/,BO=/^(-|\+)?P(?:([-+]?[0-9,.]*)Y)?(?:([-+]?[0-9,.]*)M)?(?:([-+]?[0-9,.]*)W)?(?:([-+]?[0-9,.]*)D)?(?:T(?:([-+]?[0-9,.]*)H)?(?:([-+]?[0-9,.]*)M)?(?:([-+]?[0-9,.]*)S)?)?$/;function nr(s,e){var t=s,n=null,r,i,a;return Ao(s)?t={ms:s._milliseconds,d:s._days,M:s._months}:Fr(s)||!isNaN(+s)?(t={},e?t[e]=+s:t.milliseconds=+s):(n=qO.exec(s))?(r=n[1]==="-"?-1:1,t={y:0,d:Ve(n[lr])*r,h:Ve(n[Dt])*r,m:Ve(n[zn])*r,s:Ve(n[Ir])*r,ms:Ve(Ol(n[Si]*1e3))*r}):(n=BO.exec(s))?(r=n[1]==="-"?-1:1,t={y:wi(n[2],r),M:wi(n[3],r),w:wi(n[4],r),d:wi(n[5],r),h:wi(n[6],r),m:wi(n[7],r),s:wi(n[8],r)}):t==null?t={}:typeof t=="object"&&("from"in t||"to"in t)&&(a=UO(pt(t.from),pt(t.to)),t={},t.ms=a.milliseconds,t.M=a.months),i=new dc(t),Ao(s)&&et(s,"_locale")&&(i._locale=s._locale),Ao(s)&&et(s,"_isValid")&&(i._isValid=s._isValid),i}nr.fn=dc.prototype;nr.invalid=NO;function wi(s,e){var t=s&&parseFloat(s.replace(",","."));return(isNaN(t)?0:t)*e}function om(s,e){var t={};return t.months=e.month()-s.month()+(e.year()-s.year())*12,s.clone().add(t.months,"M").isAfter(e)&&--t.months,t.milliseconds=+e-+s.clone().add(t.months,"M"),t}function UO(s,e){var t;return s.isValid()&&e.isValid()?(e=Nh(e,s),s.isBefore(e)?t=om(s,e):(t=om(e,s),t.milliseconds=-t.milliseconds,t.months=-t.months),t):{milliseconds:0,months:0}}function sg(s,e){return function(t,n){var r,i;return n!==null&&!isNaN(+n)&&(Iy(e,"moment()."+e+"(period, number) is deprecated. Please use moment()."+e+"(number, period). See http://momentjs.com/guides/#/warnings/add-inverted-param/ for more info."),i=t,t=n,n=i),r=nr(t,n),ag(this,r,s),this}}function ag(s,e,t,n){var r=e._milliseconds,i=Ol(e._days),a=Ol(e._months);s.isValid()&&(n=n??!0,a&&Qy(s,Ks(s,"Month")+a*t),i&&ky(s,"Date",Ks(s,"Date")+i*t),r&&s._d.setTime(s._d.valueOf()+r*t),n&&le.updateOffset(s,i||a))}var FO=sg(1,"add"),kO=sg(-1,"subtract");function og(s){return typeof s=="string"||s instanceof String}function jO(s){return er(s)||sa(s)||og(s)||Fr(s)||QO(s)||WO(s)||s===null||s===void 0}function WO(s){var e=Ni(s)&&!ah(s),t=!1,n=["years","year","y","months","month","M","days","day","d","dates","date","D","hours","hour","h","minutes","minute","m","seconds","second","s","milliseconds","millisecond","ms"],r,i,a=n.length;for(r=0;r<a;r+=1)i=n[r],t=t||et(s,i);return e&&t}function QO(s){var e=Zn(s),t=!1;return e&&(t=s.filter(function(n){return!Fr(n)&&og(s)}).length===0),e&&t}function VO(s){var e=Ni(s)&&!ah(s),t=!1,n=["sameDay","nextDay","lastDay","nextWeek","lastWeek","sameElse"],r,i;for(r=0;r<n.length;r+=1)i=n[r],t=t||et(s,i);return e&&t}function HO(s,e){var t=s.diff(e,"days",!0);return t<-6?"sameElse":t<-1?"lastWeek":t<0?"lastDay":t<1?"sameDay":t<2?"nextDay":t<7?"nextWeek":"sameElse"}function YO(s,e){arguments.length===1&&(arguments[0]?jO(arguments[0])?(s=arguments[0],e=void 0):VO(arguments[0])&&(e=arguments[0],s=void 0):(s=void 0,e=void 0));var t=s||pt(),n=Nh(t,this).startOf("day"),r=le.calendarFormat(this,n)||"sameElse",i=e&&(Er(e[r])?e[r].call(this,t):e[r]);return this.format(i||this.localeData().calendar(r,this,pt(t)))}function GO(){return new aa(this)}function zO(s,e){var t=er(s)?s:pt(s);return this.isValid()&&t.isValid()?(e=qn(e)||"millisecond",e==="millisecond"?this.valueOf()>t.valueOf():t.valueOf()<this.clone().startOf(e).valueOf()):!1}function KO(s,e){var t=er(s)?s:pt(s);return this.isValid()&&t.isValid()?(e=qn(e)||"millisecond",e==="millisecond"?this.valueOf()<t.valueOf():this.clone().endOf(e).valueOf()<t.valueOf()):!1}function JO(s,e,t,n){var r=er(s)?s:pt(s),i=er(e)?e:pt(e);return this.isValid()&&r.isValid()&&i.isValid()?(n=n||"()",(n[0]==="("?this.isAfter(r,t):!this.isBefore(r,t))&&(n[1]===")"?this.isBefore(i,t):!this.isAfter(i,t))):!1}function XO(s,e){var t=er(s)?s:pt(s),n;return this.isValid()&&t.isValid()?(e=qn(e)||"millisecond",e==="millisecond"?this.valueOf()===t.valueOf():(n=t.valueOf(),this.clone().startOf(e).valueOf()<=n&&n<=this.clone().endOf(e).valueOf())):!1}function ZO(s,e){return this.isSame(s,e)||this.isAfter(s,e)}function eD(s,e){return this.isSame(s,e)||this.isBefore(s,e)}function tD(s,e,t){var n,r,i;if(!this.isValid())return NaN;if(n=Nh(s,this),!n.isValid())return NaN;switch(r=(n.utcOffset()-this.utcOffset())*6e4,e=qn(e),e){case"year":i=No(this,n)/12;break;case"month":i=No(this,n);break;case"quarter":i=No(this,n)/3;break;case"second":i=(this-n)/1e3;break;case"minute":i=(this-n)/6e4;break;case"hour":i=(this-n)/36e5;break;case"day":i=(this-n-r)/864e5;break;case"week":i=(this-n-r)/6048e5;break;default:i=this-n}return t?i:On(i)}function No(s,e){if(s.date()<e.date())return-No(e,s);var t=(e.year()-s.year())*12+(e.month()-s.month()),n=s.clone().add(t,"months"),r,i;return e-n<0?(r=s.clone().add(t-1,"months"),i=(e-n)/(n-r)):(r=s.clone().add(t+1,"months"),i=(e-n)/(r-n)),-(t+i)||0}le.defaultFormat="YYYY-MM-DDTHH:mm:ssZ";le.defaultFormatUtc="YYYY-MM-DDTHH:mm:ss[Z]";function nD(){return this.clone().locale("en").format("ddd MMM DD YYYY HH:mm:ss [GMT]ZZ")}function rD(s){if(!this.isValid())return null;var e=s!==!0,t=e?this.clone().utc():this;return t.year()<0||t.year()>9999?So(t,e?"YYYYYY-MM-DD[T]HH:mm:ss.SSS[Z]":"YYYYYY-MM-DD[T]HH:mm:ss.SSSZ"):Er(Date.prototype.toISOString)?e?this.toDate().toISOString():new Date(this.valueOf()+this.utcOffset()*60*1e3).toISOString().replace("Z",So(t,"Z")):So(t,e?"YYYY-MM-DD[T]HH:mm:ss.SSS[Z]":"YYYY-MM-DD[T]HH:mm:ss.SSSZ")}function iD(){if(!this.isValid())return"moment.invalid(/* "+this._i+" */)";var s="moment",e="",t,n,r,i;return this.isLocal()||(s=this.utcOffset()===0?"moment.utc":"moment.parseZone",e="Z"),t="["+s+'("]',n=0<=this.year()&&this.year()<=9999?"YYYY":"YYYYYY",r="-MM-DD[T]HH:mm:ss.SSS",i=e+'[")]',this.format(t+n+r+i)}function sD(s){s||(s=this.isUtc()?le.defaultFormatUtc:le.defaultFormat);var e=So(this,s);return this.localeData().postformat(e)}function aD(s,e){return this.isValid()&&(er(s)&&s.isValid()||pt(s).isValid())?nr({to:this,from:s}).locale(this.locale()).humanize(!e):this.localeData().invalidDate()}function oD(s){return this.from(pt(),s)}function cD(s,e){return this.isValid()&&(er(s)&&s.isValid()||pt(s).isValid())?nr({from:this,to:s}).locale(this.locale()).humanize(!e):this.localeData().invalidDate()}function uD(s){return this.to(pt(),s)}function cg(s){var e;return s===void 0?this._locale._abbr:(e=kr(s),e!=null&&(this._locale=e),this)}var ug=Ln("moment().lang() is deprecated. Instead, use moment().localeData() to get the language configuration. Use moment().locale() to change languages.",function(s){return s===void 0?this.localeData():this.locale(s)});function lg(){return this._locale}var qo=1e3,is=60*qo,Bo=60*is,hg=(365*400+97)*24*Bo;function ss(s,e){return(s%e+e)%e}function dg(s,e,t){return s<100&&s>=0?new Date(s+400,e,t)-hg:new Date(s,e,t).valueOf()}function fg(s,e,t){return s<100&&s>=0?Date.UTC(s+400,e,t)-hg:Date.UTC(s,e,t)}function lD(s){var e,t;if(s=qn(s),s===void 0||s==="millisecond"||!this.isValid())return this;switch(t=this._isUTC?fg:dg,s){case"year":e=t(this.year(),0,1);break;case"quarter":e=t(this.year(),this.month()-this.month()%3,1);break;case"month":e=t(this.year(),this.month(),1);break;case"week":e=t(this.year(),this.month(),this.date()-this.weekday());break;case"isoWeek":e=t(this.year(),this.month(),this.date()-(this.isoWeekday()-1));break;case"day":case"date":e=t(this.year(),this.month(),this.date());break;case"hour":e=this._d.valueOf(),e-=ss(e+(this._isUTC?0:this.utcOffset()*is),Bo);break;case"minute":e=this._d.valueOf(),e-=ss(e,is);break;case"second":e=this._d.valueOf(),e-=ss(e,qo);break}return this._d.setTime(e),le.updateOffset(this,!0),this}function hD(s){var e,t;if(s=qn(s),s===void 0||s==="millisecond"||!this.isValid())return this;switch(t=this._isUTC?fg:dg,s){case"year":e=t(this.year()+1,0,1)-1;break;case"quarter":e=t(this.year(),this.month()-this.month()%3+3,1)-1;break;case"month":e=t(this.year(),this.month()+1,1)-1;break;case"week":e=t(this.year(),this.month(),this.date()-this.weekday()+7)-1;break;case"isoWeek":e=t(this.year(),this.month(),this.date()-(this.isoWeekday()-1)+7)-1;break;case"day":case"date":e=t(this.year(),this.month(),this.date()+1)-1;break;case"hour":e=this._d.valueOf(),e+=Bo-ss(e+(this._isUTC?0:this.utcOffset()*is),Bo)-1;break;case"minute":e=this._d.valueOf(),e+=is-ss(e,is)-1;break;case"second":e=this._d.valueOf(),e+=qo-ss(e,qo)-1;break}return this._d.setTime(e),le.updateOffset(this,!0),this}function dD(){return this._d.valueOf()-(this._offset||0)*6e4}function fD(){return Math.floor(this.valueOf()/1e3)}function pD(){return new Date(this.valueOf())}function mD(){var s=this;return[s.year(),s.month(),s.date(),s.hour(),s.minute(),s.second(),s.millisecond()]}function yD(){var s=this;return{years:s.year(),months:s.month(),date:s.date(),hours:s.hours(),minutes:s.minutes(),seconds:s.seconds(),milliseconds:s.milliseconds()}}function gD(){return this.isValid()?this.toISOString():null}function ED(){return oh(this)}function wD(){return ii({},Be(this))}function bD(){return Be(this).overflow}function TD(){return{input:this._i,format:this._f,locale:this._locale,isUTC:this._isUTC,strict:this._strict}}Te("N",0,0,"eraAbbr");Te("NN",0,0,"eraAbbr");Te("NNN",0,0,"eraAbbr");Te("NNNN",0,0,"eraName");Te("NNNNN",0,0,"eraNarrow");Te("y",["y",1],"yo","eraYear");Te("y",["yy",2],0,"eraYear");Te("y",["yyy",3],0,"eraYear");Te("y",["yyyy",4],0,"eraYear");de("N",Ch);de("NN",Ch);de("NNN",Ch);de("NNNN",OD);de("NNNNN",DD);ot(["N","NN","NNN","NNNN","NNNNN"],function(s,e,t,n){var r=t._locale.erasParse(s,n,t._strict);r?Be(t).era=r:Be(t).invalidEra=s});de("y",ys);de("yy",ys);de("yyy",ys);de("yyyy",ys);de("yo",ID);ot(["y","yy","yyy","yyyy"],Kt);ot(["yo"],function(s,e,t,n){var r;t._locale._eraYearOrdinalRegex&&(r=s.match(t._locale._eraYearOrdinalRegex)),t._locale.eraYearOrdinalParse?e[Kt]=t._locale.eraYearOrdinalParse(s,r):e[Kt]=parseInt(s,10)});function SD(s,e){var t,n,r,i=this._eras||kr("en")._eras;for(t=0,n=i.length;t<n;++t){switch(typeof i[t].since){case"string":r=le(i[t].since).startOf("day"),i[t].since=r.valueOf();break}switch(typeof i[t].until){case"undefined":i[t].until=1/0;break;case"string":r=le(i[t].until).startOf("day").valueOf(),i[t].until=r.valueOf();break}}return i}function AD(s,e,t){var n,r,i=this.eras(),a,o,l;for(s=s.toUpperCase(),n=0,r=i.length;n<r;++n)if(a=i[n].name.toUpperCase(),o=i[n].abbr.toUpperCase(),l=i[n].narrow.toUpperCase(),t)switch(e){case"N":case"NN":case"NNN":if(o===s)return i[n];break;case"NNNN":if(a===s)return i[n];break;case"NNNNN":if(l===s)return i[n];break}else if([a,o,l].indexOf(s)>=0)return i[n]}function ND(s,e){var t=s.since<=s.until?1:-1;return e===void 0?le(s.since).year():le(s.since).year()+(e-s.offset)*t}function CD(){var s,e,t,n=this.localeData().eras();for(s=0,e=n.length;s<e;++s)if(t=this.clone().startOf("day").valueOf(),n[s].since<=t&&t<=n[s].until||n[s].until<=t&&t<=n[s].since)return n[s].name;return""}function vD(){var s,e,t,n=this.localeData().eras();for(s=0,e=n.length;s<e;++s)if(t=this.clone().startOf("day").valueOf(),n[s].since<=t&&t<=n[s].until||n[s].until<=t&&t<=n[s].since)return n[s].narrow;return""}function RD(){var s,e,t,n=this.localeData().eras();for(s=0,e=n.length;s<e;++s)if(t=this.clone().startOf("day").valueOf(),n[s].since<=t&&t<=n[s].until||n[s].until<=t&&t<=n[s].since)return n[s].abbr;return""}function _D(){var s,e,t,n,r=this.localeData().eras();for(s=0,e=r.length;s<e;++s)if(t=r[s].since<=r[s].until?1:-1,n=this.clone().startOf("day").valueOf(),r[s].since<=n&&n<=r[s].until||r[s].until<=n&&n<=r[s].since)return(this.year()-le(r[s].since).year())*t+r[s].offset;return this.year()}function xD(s){return et(this,"_erasNameRegex")||vh.call(this),s?this._erasNameRegex:this._erasRegex}function MD(s){return et(this,"_erasAbbrRegex")||vh.call(this),s?this._erasAbbrRegex:this._erasRegex}function PD(s){return et(this,"_erasNarrowRegex")||vh.call(this),s?this._erasNarrowRegex:this._erasRegex}function Ch(s,e){return e.erasAbbrRegex(s)}function OD(s,e){return e.erasNameRegex(s)}function DD(s,e){return e.erasNarrowRegex(s)}function ID(s,e){return e._eraYearOrdinalRegex||ys}function vh(){var s=[],e=[],t=[],n=[],r,i,a,o,l,h=this.eras();for(r=0,i=h.length;r<i;++r)a=Lr(h[r].name),o=Lr(h[r].abbr),l=Lr(h[r].narrow),e.push(a),s.push(o),t.push(l),n.push(a),n.push(o),n.push(l);this._erasRegex=new RegExp("^("+n.join("|")+")","i"),this._erasNameRegex=new RegExp("^("+e.join("|")+")","i"),this._erasAbbrRegex=new RegExp("^("+s.join("|")+")","i"),this._erasNarrowRegex=new RegExp("^("+t.join("|")+")","i")}Te(0,["gg",2],0,function(){return this.weekYear()%100});Te(0,["GG",2],0,function(){return this.isoWeekYear()%100});function fc(s,e){Te(0,[s,s.length],0,e)}fc("gggg","weekYear");fc("ggggg","weekYear");fc("GGGG","isoWeekYear");fc("GGGGG","isoWeekYear");de("G",cc);de("g",cc);de("GG",mt,bn);de("gg",mt,bn);de("GGGG",fh,dh);de("gggg",fh,dh);de("GGGGG",oc,sc);de("ggggg",oc,sc);ca(["gggg","ggggg","GGGG","GGGGG"],function(s,e,t,n){e[n.substr(0,2)]=Ve(s)});ca(["gg","GG"],function(s,e,t,n){e[n]=le.parseTwoDigitYear(s)});function $D(s){return pg.call(this,s,this.week(),this.weekday()+this.localeData()._week.dow,this.localeData()._week.dow,this.localeData()._week.doy)}function LD(s){return pg.call(this,s,this.isoWeek(),this.isoWeekday(),1,4)}function qD(){return qr(this.year(),1,4)}function BD(){return qr(this.isoWeekYear(),1,4)}function UD(){var s=this.localeData()._week;return qr(this.year(),s.dow,s.doy)}function FD(){var s=this.localeData()._week;return qr(this.weekYear(),s.dow,s.doy)}function pg(s,e,t,n,r){var i;return s==null?Xs(this,n,r).year:(i=qr(s,n,r),e>i&&(e=i),kD.call(this,s,e,t,n,r))}function kD(s,e,t,n,r){var i=Yy(s,e,t,n,r),a=Js(i.year,0,i.dayOfYear);return this.year(a.getUTCFullYear()),this.month(a.getUTCMonth()),this.date(a.getUTCDate()),this}Te("Q",0,"Qo","quarter");de("Q",Ly);ot("Q",function(s,e){e[Dr]=(Ve(s)-1)*3});function jD(s){return s==null?Math.ceil((this.month()+1)/3):this.month((s-1)*3+this.month()%3)}Te("D",["DD",2],"Do","date");de("D",mt,gs);de("DD",mt,bn);de("Do",function(s,e){return s?e._dayOfMonthOrdinalParse||e._ordinalParse:e._dayOfMonthOrdinalParseLenient});ot(["D","DD"],lr);ot("Do",function(s,e){e[lr]=Ve(s.match(mt)[0])});var mg=Es("Date",!0);Te("DDD",["DDDD",3],"DDDo","dayOfYear");de("DDD",ac);de("DDDD",qy);ot(["DDD","DDDD"],function(s,e,t){t._dayOfYear=Ve(s)});function WD(s){var e=Math.round((this.clone().startOf("day")-this.clone().startOf("year"))/864e5)+1;return s==null?e:this.add(s-e,"d")}Te("m",["mm",2],0,"minute");de("m",mt,ph);de("mm",mt,bn);ot(["m","mm"],zn);var QD=Es("Minutes",!1);Te("s",["ss",2],0,"second");de("s",mt,ph);de("ss",mt,bn);ot(["s","ss"],Ir);var VD=Es("Seconds",!1);Te("S",0,0,function(){return~~(this.millisecond()/100)});Te(0,["SS",2],0,function(){return~~(this.millisecond()/10)});Te(0,["SSS",3],0,"millisecond");Te(0,["SSSS",4],0,function(){return this.millisecond()*10});Te(0,["SSSSS",5],0,function(){return this.millisecond()*100});Te(0,["SSSSSS",6],0,function(){return this.millisecond()*1e3});Te(0,["SSSSSSS",7],0,function(){return this.millisecond()*1e4});Te(0,["SSSSSSSS",8],0,function(){return this.millisecond()*1e5});Te(0,["SSSSSSSSS",9],0,function(){return this.millisecond()*1e6});de("S",ac,Ly);de("SS",ac,bn);de("SSS",ac,qy);var si,yg;for(si="SSSS";si.length<=9;si+="S")de(si,ys);function HD(s,e){e[Si]=Ve(("0."+s)*1e3)}for(si="S";si.length<=9;si+="S")ot(si,HD);yg=Es("Milliseconds",!1);Te("z",0,0,"zoneAbbr");Te("zz",0,0,"zoneName");function YD(){return this._isUTC?"UTC":""}function GD(){return this._isUTC?"Coordinated Universal Time":""}var se=aa.prototype;se.add=FO;se.calendar=YO;se.clone=GO;se.diff=tD;se.endOf=hD;se.format=sD;se.from=aD;se.fromNow=oD;se.to=cD;se.toNow=uD;se.get=iP;se.invalidAt=bD;se.isAfter=zO;se.isBefore=KO;se.isBetween=JO;se.isSame=XO;se.isSameOrAfter=ZO;se.isSameOrBefore=eD;se.isValid=ED;se.lang=ug;se.locale=cg;se.localeData=lg;se.max=EO;se.min=gO;se.parsingFlags=wD;se.set=sP;se.startOf=lD;se.subtract=kO;se.toArray=mD;se.toObject=yD;se.toDate=pD;se.toISOString=rD;se.inspect=iD;typeof Symbol<"u"&&Symbol.for!=null&&(se[Symbol.for("nodejs.util.inspect.custom")]=function(){return"Moment<"+this.format()+">"});se.toJSON=gD;se.toString=nD;se.unix=fD;se.valueOf=dD;se.creationData=TD;se.eraName=CD;se.eraNarrow=vD;se.eraAbbr=RD;se.eraYear=_D;se.year=Fy;se.isLeapYear=rP;se.weekYear=$D;se.isoWeekYear=LD;se.quarter=se.quarters=jD;se.month=Vy;se.daysInMonth=pP;se.week=se.weeks=SP;se.isoWeek=se.isoWeeks=AP;se.weeksInYear=UD;se.weeksInWeekYear=FD;se.isoWeeksInYear=qD;se.isoWeeksInISOWeekYear=BD;se.date=mg;se.day=se.days=LP;se.weekday=qP;se.isoWeekday=BP;se.dayOfYear=WD;se.hour=se.hours=VP;se.minute=se.minutes=QD;se.second=se.seconds=VD;se.millisecond=se.milliseconds=yg;se.utcOffset=RO;se.utc=xO;se.local=MO;se.parseZone=PO;se.hasAlignedHourOffset=OO;se.isDST=DO;se.isLocal=$O;se.isUtcOffset=LO;se.isUtc=ig;se.isUTC=ig;se.zoneAbbr=YD;se.zoneName=GD;se.dates=Ln("dates accessor is deprecated. Use date instead.",mg);se.months=Ln("months accessor is deprecated. Use month instead",Vy);se.years=Ln("years accessor is deprecated. Use year instead",Fy);se.zone=Ln("moment().zone is deprecated, use moment().utcOffset instead. http://momentjs.com/guides/#/warnings/zone/",_O);se.isDSTShifted=Ln("isDSTShifted is deprecated. See http://momentjs.com/guides/#/warnings/dst-shifted/ for more information",IO);function zD(s){return pt(s*1e3)}function KD(){return pt.apply(null,arguments).parseZone()}function gg(s){return s}var tt=uh.prototype;tt.calendar=$M;tt.longDateFormat=UM;tt.invalidDate=kM;tt.ordinal=QM;tt.preparse=gg;tt.postformat=gg;tt.relativeTime=HM;tt.pastFuture=YM;tt.set=DM;tt.eras=SD;tt.erasParse=AD;tt.erasConvertYear=ND;tt.erasAbbrRegex=MD;tt.erasNameRegex=xD;tt.erasNarrowRegex=PD;tt.months=lP;tt.monthsShort=hP;tt.monthsParse=fP;tt.monthsRegex=yP;tt.monthsShortRegex=mP;tt.week=EP;tt.firstDayOfYear=TP;tt.firstDayOfWeek=bP;tt.weekdays=PP;tt.weekdaysMin=DP;tt.weekdaysShort=OP;tt.weekdaysParse=$P;tt.weekdaysRegex=UP;tt.weekdaysShortRegex=FP;tt.weekdaysMinRegex=kP;tt.isPM=WP;tt.meridiem=HP;function Uo(s,e,t,n){var r=kr(),i=gr().set(n,e);return r[t](i,s)}function Eg(s,e,t){if(Fr(s)&&(e=s,s=void 0),s=s||"",e!=null)return Uo(s,e,t,"month");var n,r=[];for(n=0;n<12;n++)r[n]=Uo(s,n,t,"month");return r}function Rh(s,e,t,n){typeof s=="boolean"?(Fr(e)&&(t=e,e=void 0),e=e||""):(e=s,t=e,s=!1,Fr(e)&&(t=e,e=void 0),e=e||"");var r=kr(),i=s?r._week.dow:0,a,o=[];if(t!=null)return Uo(e,(t+i)%7,n,"day");for(a=0;a<7;a++)o[a]=Uo(e,(a+i)%7,n,"day");return o}function JD(s,e){return Eg(s,e,"months")}function XD(s,e){return Eg(s,e,"monthsShort")}function ZD(s,e,t){return Rh(s,e,t,"weekdays")}function eI(s,e,t){return Rh(s,e,t,"weekdaysShort")}function tI(s,e,t){return Rh(s,e,t,"weekdaysMin")}oi("en",{eras:[{since:"0001-01-01",until:1/0,offset:1,name:"Anno Domini",narrow:"AD",abbr:"AD"},{since:"0000-12-31",until:-1/0,offset:1,name:"Before Christ",narrow:"BC",abbr:"BC"}],dayOfMonthOrdinalParse:/\d{1,2}(th|st|nd|rd)/,ordinal:function(s){var e=s%10,t=Ve(s%100/10)===1?"th":e===1?"st":e===2?"nd":e===3?"rd":"th";return s+t}});le.lang=Ln("moment.lang is deprecated. Use moment.locale instead.",oi);le.langData=Ln("moment.langData is deprecated. Use moment.localeData instead.",kr);var Mr=Math.abs;function nI(){var s=this._data;return this._milliseconds=Mr(this._milliseconds),this._days=Mr(this._days),this._months=Mr(this._months),s.milliseconds=Mr(s.milliseconds),s.seconds=Mr(s.seconds),s.minutes=Mr(s.minutes),s.hours=Mr(s.hours),s.months=Mr(s.months),s.years=Mr(s.years),this}function wg(s,e,t,n){var r=nr(e,t);return s._milliseconds+=n*r._milliseconds,s._days+=n*r._days,s._months+=n*r._months,s._bubble()}function rI(s,e){return wg(this,s,e,1)}function iI(s,e){return wg(this,s,e,-1)}function cm(s){return s<0?Math.floor(s):Math.ceil(s)}function sI(){var s=this._milliseconds,e=this._days,t=this._months,n=this._data,r,i,a,o,l;return s>=0&&e>=0&&t>=0||s<=0&&e<=0&&t<=0||(s+=cm(Il(t)+e)*864e5,e=0,t=0),n.milliseconds=s%1e3,r=On(s/1e3),n.seconds=r%60,i=On(r/60),n.minutes=i%60,a=On(i/60),n.hours=a%24,e+=On(a/24),l=On(bg(e)),t+=l,e-=cm(Il(l)),o=On(t/12),t%=12,n.days=e,n.months=t,n.years=o,this}function bg(s){return s*4800/146097}function Il(s){return s*146097/4800}function aI(s){if(!this.isValid())return NaN;var e,t,n=this._milliseconds;if(s=qn(s),s==="month"||s==="quarter"||s==="year")switch(e=this._days+n/864e5,t=this._months+bg(e),s){case"month":return t;case"quarter":return t/3;case"year":return t/12}else switch(e=this._days+Math.round(Il(this._months)),s){case"week":return e/7+n/6048e5;case"day":return e+n/864e5;case"hour":return e*24+n/36e5;case"minute":return e*1440+n/6e4;case"second":return e*86400+n/1e3;case"millisecond":return Math.floor(e*864e5)+n;default:throw new Error("Unknown unit "+s)}}function jr(s){return function(){return this.as(s)}}var Tg=jr("ms"),oI=jr("s"),cI=jr("m"),uI=jr("h"),lI=jr("d"),hI=jr("w"),dI=jr("M"),fI=jr("Q"),pI=jr("y"),mI=Tg;function yI(){return nr(this)}function gI(s){return s=qn(s),this.isValid()?this[s+"s"]():NaN}function Pi(s){return function(){return this.isValid()?this._data[s]:NaN}}var EI=Pi("milliseconds"),wI=Pi("seconds"),bI=Pi("minutes"),TI=Pi("hours"),SI=Pi("days"),AI=Pi("months"),NI=Pi("years");function CI(){return On(this.days()/7)}var Or=Math.round,es={ss:44,s:45,m:45,h:22,d:26,w:null,M:11};function vI(s,e,t,n,r){return r.relativeTime(e||1,!!t,s,n)}function RI(s,e,t,n){var r=nr(s).abs(),i=Or(r.as("s")),a=Or(r.as("m")),o=Or(r.as("h")),l=Or(r.as("d")),h=Or(r.as("M")),d=Or(r.as("w")),p=Or(r.as("y")),m=i<=t.ss&&["s",i]||i<t.s&&["ss",i]||a<=1&&["m"]||a<t.m&&["mm",a]||o<=1&&["h"]||o<t.h&&["hh",o]||l<=1&&["d"]||l<t.d&&["dd",l];return t.w!=null&&(m=m||d<=1&&["w"]||d<t.w&&["ww",d]),m=m||h<=1&&["M"]||h<t.M&&["MM",h]||p<=1&&["y"]||["yy",p],m[2]=e,m[3]=+s>0,m[4]=n,vI.apply(null,m)}function _I(s){return s===void 0?Or:typeof s=="function"?(Or=s,!0):!1}function xI(s,e){return es[s]===void 0?!1:e===void 0?es[s]:(es[s]=e,s==="s"&&(es.ss=e-1),!0)}function MI(s,e){if(!this.isValid())return this.localeData().invalidDate();var t=!1,n=es,r,i;return typeof s=="object"&&(e=s,s=!1),typeof s=="boolean"&&(t=s),typeof e=="object"&&(n=Object.assign({},es,e),e.s!=null&&e.ss==null&&(n.ss=e.s-1)),r=this.localeData(),i=RI(this,!t,n,r),t&&(i=r.pastFuture(+this,i)),r.postformat(i)}var nl=Math.abs;function Ki(s){return(s>0)-(s<0)||+s}function pc(){if(!this.isValid())return this.localeData().invalidDate();var s=nl(this._milliseconds)/1e3,e=nl(this._days),t=nl(this._months),n,r,i,a,o=this.asSeconds(),l,h,d,p;return o?(n=On(s/60),r=On(n/60),s%=60,n%=60,i=On(t/12),t%=12,a=s?s.toFixed(3).replace(/\.?0+$/,""):"",l=o<0?"-":"",h=Ki(this._months)!==Ki(o)?"-":"",d=Ki(this._days)!==Ki(o)?"-":"",p=Ki(this._milliseconds)!==Ki(o)?"-":"",l+"P"+(i?h+i+"Y":"")+(t?h+t+"M":"")+(e?d+e+"D":"")+(r||n||s?"T":"")+(r?p+r+"H":"")+(n?p+n+"M":"")+(s?p+a+"S":"")):"P0D"}var Je=dc.prototype;Je.isValid=AO;Je.abs=nI;Je.add=rI;Je.subtract=iI;Je.as=aI;Je.asMilliseconds=Tg;Je.asSeconds=oI;Je.asMinutes=cI;Je.asHours=uI;Je.asDays=lI;Je.asWeeks=hI;Je.asMonths=dI;Je.asQuarters=fI;Je.asYears=pI;Je.valueOf=mI;Je._bubble=sI;Je.clone=yI;Je.get=gI;Je.milliseconds=EI;Je.seconds=wI;Je.minutes=bI;Je.hours=TI;Je.days=SI;Je.weeks=CI;Je.months=AI;Je.years=NI;Je.humanize=MI;Je.toISOString=pc;Je.toString=pc;Je.toJSON=pc;Je.locale=cg;Je.localeData=lg;Je.toIsoString=Ln("toIsoString() is deprecated. Please use toISOString() instead (notice the capitals)",pc);Je.lang=ug;Te("X",0,0,"unix");Te("x",0,0,"valueOf");de("x",cc);de("X",JM);ot("X",function(s,e,t){t._d=new Date(parseFloat(s)*1e3)});ot("x",function(s,e,t){t._d=new Date(Ve(s))});//! moment.js
le.version="2.30.1";PM(pt);le.fn=se;le.min=wO;le.max=bO;le.now=TO;le.utc=gr;le.unix=zD;le.months=JD;le.isDate=sa;le.locale=oi;le.invalid=ic;le.duration=nr;le.isMoment=er;le.weekdays=ZD;le.parseZone=KD;le.localeData=kr;le.isDuration=Ao;le.monthsShort=XD;le.weekdaysMin=tI;le.defineLocale=wh;le.updateLocale=KP;le.locales=JP;le.weekdaysShort=eI;le.normalizeUnits=qn;le.relativeTimeRounding=_I;le.relativeTimeThreshold=xI;le.calendarFormat=HO;le.prototype=se;le.HTML5_FMT={DATETIME_LOCAL:"YYYY-MM-DDTHH:mm",DATETIME_LOCAL_SECONDS:"YYYY-MM-DDTHH:mm:ss",DATETIME_LOCAL_MS:"YYYY-MM-DDTHH:mm:ss.SSS",DATE:"YYYY-MM-DD",TIME:"HH:mm",TIME_SECONDS:"HH:mm:ss",TIME_MS:"HH:mm:ss.SSS",WEEK:"GGGG-[W]WW",MONTH:"YYYY-MM"};const um=ci(),PI=um==="browser"||um==="pwa",Pe=(...s)=>(e,t)=>e;let Ze={};PI?Ze={Entity:Pe,Column:Pe,PrimaryGeneratedColumn:Pe,PrimaryColumn:Pe,ManyToOne:Pe,OneToMany:Pe,JoinColumn:Pe,JoinTable:Pe,CreateDateColumn:Pe,UpdateDateColumn:Pe,VersionColumn:Pe,Index:Pe,Unique:Pe,ViewEntity:Pe,ViewColumn:Pe}:(Ze={Entity:Pe,Column:Pe,PrimaryGeneratedColumn:Pe,PrimaryColumn:Pe,ManyToOne:Pe,OneToMany:Pe,JoinColumn:Pe,JoinTable:Pe,CreateDateColumn:Pe,UpdateDateColumn:Pe,VersionColumn:Pe,Index:Pe,Unique:Pe,ViewEntity:Pe,ViewColumn:Pe},(async()=>{try{const s=await Br(()=>import("./index-DkfF8G70.js"),__vite__mapDeps([0,1,2,3,4]));s&&(Ze.Entity=s.Entity??Pe,Ze.Column=s.Column??Pe,Ze.PrimaryGeneratedColumn=s.PrimaryGeneratedColumn??Pe,Ze.PrimaryColumn=s.PrimaryColumn??Pe,Ze.ManyToOne=s.ManyToOne??Pe,Ze.OneToMany=s.OneToMany??Pe,Ze.JoinColumn=s.JoinColumn??Pe,Ze.JoinTable=s.JoinTable??Pe,Ze.CreateDateColumn=s.CreateDateColumn??Pe,Ze.UpdateDateColumn=s.UpdateDateColumn??Pe,Ze.VersionColumn=s.VersionColumn??Pe,Ze.Index=s.Index??Pe,Ze.Unique=s.Unique??Pe,Ze.ViewEntity=s.ViewEntity??Pe,Ze.ViewColumn=s.ViewColumn??Pe,console.log("[ORM SHIM] TypeORM loaded successfully"))}catch(s){console.warn("[ORM SHIM] TypeORM not available - using no-op decorators and shimmed types:",s)}})());const OI=Ze.Entity,wr=Ze.Column,DI=Ze.PrimaryGeneratedColumn;Ze.PrimaryColumn;Ze.ManyToOne;Ze.OneToMany;Ze.JoinColumn;Ze.JoinTable;Ze.CreateDateColumn;Ze.UpdateDateColumn;Ze.VersionColumn;Ze.Index;Ze.Unique;Ze.ViewEntity;Ze.ViewColumn;var II=Object.defineProperty,$I=Object.getOwnPropertyDescriptor,Bn=(s,e,t,n)=>{for(var r=n>1?void 0:n?$I(e,t):e,i=s.length-1,a;i>=0;i--)(a=s[i])&&(r=(n?a(e,t,r):a(r))||r);return n&&r&&II(e,t,r),r};let tn=class{};Bn([DI({name:"doc_id"})],tn.prototype,"docId",2);Bn([wr({name:"doc_guid"})],tn.prototype,"docGuid",2);Bn([wr({name:"doc_name"})],tn.prototype,"docName",2);Bn([wr({name:"doc_description"})],tn.prototype,"docDescription",2);Bn([wr({name:"company_id"})],tn.prototype,"companyId",2);Bn([wr({name:"doc_from"})],tn.prototype,"docFrom",2);Bn([wr({name:"doc_type_id"})],tn.prototype,"docTypeId",2);Bn([wr({name:"doc_date"})],tn.prototype,"docDate",2);Bn([wr({name:"attach_guid"})],tn.prototype,"attach_guid",2);Bn([wr({name:"doc_expire_date"})],tn.prototype,"docExpireDate",2);Bn([wr({name:"doc_enabled"})],tn.prototype,"docEnabled",2);tn=Bn([OI({name:"doc",synchronize:!1})],tn);var $l=function(s,e){return $l=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])},$l(s,e)};function ws(s,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");$l(s,e);function t(){this.constructor=s}s.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}function LI(s,e,t,n){function r(i){return i instanceof t?i:new t(function(a){a(i)})}return new(t||(t=Promise))(function(i,a){function o(d){try{h(n.next(d))}catch(p){a(p)}}function l(d){try{h(n.throw(d))}catch(p){a(p)}}function h(d){d.done?i(d.value):r(d.value).then(o,l)}h((n=n.apply(s,e||[])).next())})}function Sg(s,e){var t={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},n,r,i,a=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return a.next=o(0),a.throw=o(1),a.return=o(2),typeof Symbol=="function"&&(a[Symbol.iterator]=function(){return this}),a;function o(h){return function(d){return l([h,d])}}function l(h){if(n)throw new TypeError("Generator is already executing.");for(;a&&(a=0,h[0]&&(t=0)),t;)try{if(n=1,r&&(i=h[0]&2?r.return:h[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,h[1])).done)return i;switch(r=0,i&&(h=[h[0]&2,i.value]),h[0]){case 0:case 1:i=h;break;case 4:return t.label++,{value:h[1],done:!1};case 5:t.label++,r=h[1],h=[0];continue;case 7:h=t.ops.pop(),t.trys.pop();continue;default:if(i=t.trys,!(i=i.length>0&&i[i.length-1])&&(h[0]===6||h[0]===2)){t=0;continue}if(h[0]===3&&(!i||h[1]>i[0]&&h[1]<i[3])){t.label=h[1];break}if(h[0]===6&&t.label<i[1]){t.label=i[1],i=h;break}if(i&&t.label<i[2]){t.label=i[2],t.ops.push(h);break}i[2]&&t.ops.pop(),t.trys.pop();continue}h=e.call(s,t)}catch(d){h=[6,d],r=0}finally{n=i=0}if(h[0]&5)throw h[1];return{value:h[0]?h[1]:void 0,done:!0}}}function cs(s){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&s[e],n=0;if(t)return t.call(s);if(s&&typeof s.length=="number")return{next:function(){return s&&n>=s.length&&(s=void 0),{value:s&&s[n++],done:!s}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function ea(s,e){var t=typeof Symbol=="function"&&s[Symbol.iterator];if(!t)return s;var n=t.call(s),r,i=[],a;try{for(;(e===void 0||e-- >0)&&!(r=n.next()).done;)i.push(r.value)}catch(o){a={error:o}}finally{try{r&&!r.done&&(t=n.return)&&t.call(n)}finally{if(a)throw a.error}}return i}function Fo(s,e,t){if(t||arguments.length===2)for(var n=0,r=e.length,i;n<r;n++)(i||!(n in e))&&(i||(i=Array.prototype.slice.call(e,0,n)),i[n]=e[n]);return s.concat(i||Array.prototype.slice.call(e))}function as(s){return this instanceof as?(this.v=s,this):new as(s)}function qI(s,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=t.apply(s,e||[]),r,i=[];return r=Object.create((typeof AsyncIterator=="function"?AsyncIterator:Object).prototype),o("next"),o("throw"),o("return",a),r[Symbol.asyncIterator]=function(){return this},r;function a(w){return function(b){return Promise.resolve(b).then(w,p)}}function o(w,b){n[w]&&(r[w]=function(S){return new Promise(function(R,$){i.push([w,S,R,$])>1||l(w,S)})},b&&(r[w]=b(r[w])))}function l(w,b){try{h(n[w](b))}catch(S){m(i[0][3],S)}}function h(w){w.value instanceof as?Promise.resolve(w.value.v).then(d,p):m(i[0][2],w)}function d(w){l("next",w)}function p(w){l("throw",w)}function m(w,b){w(b),i.shift(),i.length&&l(i[0][0],i[0][1])}}function BI(s){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=s[Symbol.asyncIterator],t;return e?e.call(s):(s=typeof cs=="function"?cs(s):s[Symbol.iterator](),t={},n("next"),n("throw"),n("return"),t[Symbol.asyncIterator]=function(){return this},t);function n(i){t[i]=s[i]&&function(a){return new Promise(function(o,l){a=s[i](a),r(o,l,a.done,a.value)})}}function r(i,a,o,l){Promise.resolve(l).then(function(h){i({value:h,done:o})},a)}}function ft(s){return typeof s=="function"}function Ag(s){var e=function(n){Error.call(n),n.stack=new Error().stack},t=s(e);return t.prototype=Object.create(Error.prototype),t.prototype.constructor=t,t}var rl=Ag(function(s){return function(t){s(this),this.message=t?t.length+` errors occurred during unsubscription:
`+t.map(function(n,r){return r+1+") "+n.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=t}});function Ll(s,e){if(s){var t=s.indexOf(e);0<=t&&s.splice(t,1)}}var mc=function(){function s(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._finalizers=null}return s.prototype.unsubscribe=function(){var e,t,n,r,i;if(!this.closed){this.closed=!0;var a=this._parentage;if(a)if(this._parentage=null,Array.isArray(a))try{for(var o=cs(a),l=o.next();!l.done;l=o.next()){var h=l.value;h.remove(this)}}catch(S){e={error:S}}finally{try{l&&!l.done&&(t=o.return)&&t.call(o)}finally{if(e)throw e.error}}else a.remove(this);var d=this.initialTeardown;if(ft(d))try{d()}catch(S){i=S instanceof rl?S.errors:[S]}var p=this._finalizers;if(p){this._finalizers=null;try{for(var m=cs(p),w=m.next();!w.done;w=m.next()){var b=w.value;try{lm(b)}catch(S){i=i??[],S instanceof rl?i=Fo(Fo([],ea(i)),ea(S.errors)):i.push(S)}}}catch(S){n={error:S}}finally{try{w&&!w.done&&(r=m.return)&&r.call(m)}finally{if(n)throw n.error}}}if(i)throw new rl(i)}},s.prototype.add=function(e){var t;if(e&&e!==this)if(this.closed)lm(e);else{if(e instanceof s){if(e.closed||e._hasParent(this))return;e._addParent(this)}(this._finalizers=(t=this._finalizers)!==null&&t!==void 0?t:[]).push(e)}},s.prototype._hasParent=function(e){var t=this._parentage;return t===e||Array.isArray(t)&&t.includes(e)},s.prototype._addParent=function(e){var t=this._parentage;this._parentage=Array.isArray(t)?(t.push(e),t):t?[t,e]:e},s.prototype._removeParent=function(e){var t=this._parentage;t===e?this._parentage=null:Array.isArray(t)&&Ll(t,e)},s.prototype.remove=function(e){var t=this._finalizers;t&&Ll(t,e),e instanceof s&&e._removeParent(this)},s.EMPTY=function(){var e=new s;return e.closed=!0,e}(),s}(),Ng=mc.EMPTY;function Cg(s){return s instanceof mc||s&&"closed"in s&&ft(s.remove)&&ft(s.add)&&ft(s.unsubscribe)}function lm(s){ft(s)?s():s.unsubscribe()}var UI={Promise:void 0},FI={setTimeout:function(s,e){for(var t=[],n=2;n<arguments.length;n++)t[n-2]=arguments[n];return setTimeout.apply(void 0,Fo([s,e],ea(t)))},clearTimeout:function(s){return clearTimeout(s)},delegate:void 0};function vg(s){FI.setTimeout(function(){throw s})}function hm(){}function Co(s){s()}var _h=function(s){ws(e,s);function e(t){var n=s.call(this)||this;return n.isStopped=!1,t?(n.destination=t,Cg(t)&&t.add(n)):n.destination=WI,n}return e.create=function(t,n,r){return new ql(t,n,r)},e.prototype.next=function(t){this.isStopped||this._next(t)},e.prototype.error=function(t){this.isStopped||(this.isStopped=!0,this._error(t))},e.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},e.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,s.prototype.unsubscribe.call(this),this.destination=null)},e.prototype._next=function(t){this.destination.next(t)},e.prototype._error=function(t){try{this.destination.error(t)}finally{this.unsubscribe()}},e.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},e}(mc),kI=function(){function s(e){this.partialObserver=e}return s.prototype.next=function(e){var t=this.partialObserver;if(t.next)try{t.next(e)}catch(n){lo(n)}},s.prototype.error=function(e){var t=this.partialObserver;if(t.error)try{t.error(e)}catch(n){lo(n)}else lo(e)},s.prototype.complete=function(){var e=this.partialObserver;if(e.complete)try{e.complete()}catch(t){lo(t)}},s}(),ql=function(s){ws(e,s);function e(t,n,r){var i=s.call(this)||this,a;return ft(t)||!t?a={next:t??void 0,error:n??void 0,complete:r??void 0}:a=t,i.destination=new kI(a),i}return e}(_h);function lo(s){vg(s)}function jI(s){throw s}var WI={closed:!0,next:hm,error:jI,complete:hm},xh=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}();function QI(s){return s}function VI(s){return s.length===0?QI:s.length===1?s[0]:function(t){return s.reduce(function(n,r){return r(n)},t)}}var wn=function(){function s(e){e&&(this._subscribe=e)}return s.prototype.lift=function(e){var t=new s;return t.source=this,t.operator=e,t},s.prototype.subscribe=function(e,t,n){var r=this,i=YI(e)?e:new ql(e,t,n);return Co(function(){var a=r,o=a.operator,l=a.source;i.add(o?o.call(i,l):l?r._subscribe(i):r._trySubscribe(i))}),i},s.prototype._trySubscribe=function(e){try{return this._subscribe(e)}catch(t){e.error(t)}},s.prototype.forEach=function(e,t){var n=this;return t=dm(t),new t(function(r,i){var a=new ql({next:function(o){try{e(o)}catch(l){i(l),a.unsubscribe()}},error:i,complete:r});n.subscribe(a)})},s.prototype._subscribe=function(e){var t;return(t=this.source)===null||t===void 0?void 0:t.subscribe(e)},s.prototype[xh]=function(){return this},s.prototype.pipe=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return VI(e)(this)},s.prototype.toPromise=function(e){var t=this;return e=dm(e),new e(function(n,r){var i;t.subscribe(function(a){return i=a},function(a){return r(a)},function(){return n(i)})})},s.create=function(e){return new s(e)},s}();function dm(s){var e;return(e=s??UI.Promise)!==null&&e!==void 0?e:Promise}function HI(s){return s&&ft(s.next)&&ft(s.error)&&ft(s.complete)}function YI(s){return s&&s instanceof _h||HI(s)&&Cg(s)}function GI(s){return ft(s==null?void 0:s.lift)}function yc(s){return function(e){if(GI(e))return e.lift(function(t){try{return s(t,this)}catch(n){this.error(n)}});throw new TypeError("Unable to lift unknown Observable type")}}function ko(s,e,t,n,r){return new zI(s,e,t,n,r)}var zI=function(s){ws(e,s);function e(t,n,r,i,a,o){var l=s.call(this,t)||this;return l.onFinalize=a,l.shouldUnsubscribe=o,l._next=n?function(h){try{n(h)}catch(d){t.error(d)}}:s.prototype._next,l._error=i?function(h){try{i(h)}catch(d){t.error(d)}finally{this.unsubscribe()}}:s.prototype._error,l._complete=r?function(){try{r()}catch(h){t.error(h)}finally{this.unsubscribe()}}:s.prototype._complete,l}return e.prototype.unsubscribe=function(){var t;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var n=this.closed;s.prototype.unsubscribe.call(this),!n&&((t=this.onFinalize)===null||t===void 0||t.call(this))}},e}(_h),KI=Ag(function(s){return function(){s(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),Rg=function(s){ws(e,s);function e(){var t=s.call(this)||this;return t.closed=!1,t.currentObservers=null,t.observers=[],t.isStopped=!1,t.hasError=!1,t.thrownError=null,t}return e.prototype.lift=function(t){var n=new fm(this,this);return n.operator=t,n},e.prototype._throwIfClosed=function(){if(this.closed)throw new KI},e.prototype.next=function(t){var n=this;Co(function(){var r,i;if(n._throwIfClosed(),!n.isStopped){n.currentObservers||(n.currentObservers=Array.from(n.observers));try{for(var a=cs(n.currentObservers),o=a.next();!o.done;o=a.next()){var l=o.value;l.next(t)}}catch(h){r={error:h}}finally{try{o&&!o.done&&(i=a.return)&&i.call(a)}finally{if(r)throw r.error}}}})},e.prototype.error=function(t){var n=this;Co(function(){if(n._throwIfClosed(),!n.isStopped){n.hasError=n.isStopped=!0,n.thrownError=t;for(var r=n.observers;r.length;)r.shift().error(t)}})},e.prototype.complete=function(){var t=this;Co(function(){if(t._throwIfClosed(),!t.isStopped){t.isStopped=!0;for(var n=t.observers;n.length;)n.shift().complete()}})},e.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(e.prototype,"observed",{get:function(){var t;return((t=this.observers)===null||t===void 0?void 0:t.length)>0},enumerable:!1,configurable:!0}),e.prototype._trySubscribe=function(t){return this._throwIfClosed(),s.prototype._trySubscribe.call(this,t)},e.prototype._subscribe=function(t){return this._throwIfClosed(),this._checkFinalizedStatuses(t),this._innerSubscribe(t)},e.prototype._innerSubscribe=function(t){var n=this,r=this,i=r.hasError,a=r.isStopped,o=r.observers;return i||a?Ng:(this.currentObservers=null,o.push(t),new mc(function(){n.currentObservers=null,Ll(o,t)}))},e.prototype._checkFinalizedStatuses=function(t){var n=this,r=n.hasError,i=n.thrownError,a=n.isStopped;r?t.error(i):a&&t.complete()},e.prototype.asObservable=function(){var t=new wn;return t.source=this,t},e.create=function(t,n){return new fm(t,n)},e}(wn),fm=function(s){ws(e,s);function e(t,n){var r=s.call(this)||this;return r.destination=t,r.source=n,r}return e.prototype.next=function(t){var n,r;(r=(n=this.destination)===null||n===void 0?void 0:n.next)===null||r===void 0||r.call(n,t)},e.prototype.error=function(t){var n,r;(r=(n=this.destination)===null||n===void 0?void 0:n.error)===null||r===void 0||r.call(n,t)},e.prototype.complete=function(){var t,n;(n=(t=this.destination)===null||t===void 0?void 0:t.complete)===null||n===void 0||n.call(t)},e.prototype._subscribe=function(t){var n,r;return(r=(n=this.source)===null||n===void 0?void 0:n.subscribe(t))!==null&&r!==void 0?r:Ng},e}(Rg),JI=function(s){ws(e,s);function e(t){var n=s.call(this)||this;return n._value=t,n}return Object.defineProperty(e.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),e.prototype._subscribe=function(t){var n=s.prototype._subscribe.call(this,t);return!n.closed&&t.next(this._value),n},e.prototype.getValue=function(){var t=this,n=t.hasError,r=t.thrownError,i=t._value;if(n)throw r;return this._throwIfClosed(),i},e.prototype.next=function(t){s.prototype.next.call(this,this._value=t)},e}(Rg),Mh=function(s){return s&&typeof s.length=="number"&&typeof s!="function"};function _g(s){return ft(s==null?void 0:s.then)}function xg(s){return ft(s[xh])}function Mg(s){return Symbol.asyncIterator&&ft(s==null?void 0:s[Symbol.asyncIterator])}function Pg(s){return new TypeError("You provided "+(s!==null&&typeof s=="object"?"an invalid object":"'"+s+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}function XI(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var Og=XI();function Dg(s){return ft(s==null?void 0:s[Og])}function Ig(s){return qI(this,arguments,function(){var t,n,r,i;return Sg(this,function(a){switch(a.label){case 0:t=s.getReader(),a.label=1;case 1:a.trys.push([1,,9,10]),a.label=2;case 2:return[4,as(t.read())];case 3:return n=a.sent(),r=n.value,i=n.done,i?[4,as(void 0)]:[3,5];case 4:return[2,a.sent()];case 5:return[4,as(r)];case 6:return[4,a.sent()];case 7:return a.sent(),[3,2];case 8:return[3,10];case 9:return t.releaseLock(),[7];case 10:return[2]}})})}function $g(s){return ft(s==null?void 0:s.getReader)}function bs(s){if(s instanceof wn)return s;if(s!=null){if(xg(s))return ZI(s);if(Mh(s))return e$(s);if(_g(s))return t$(s);if(Mg(s))return Lg(s);if(Dg(s))return n$(s);if($g(s))return r$(s)}throw Pg(s)}function ZI(s){return new wn(function(e){var t=s[xh]();if(ft(t.subscribe))return t.subscribe(e);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function e$(s){return new wn(function(e){for(var t=0;t<s.length&&!e.closed;t++)e.next(s[t]);e.complete()})}function t$(s){return new wn(function(e){s.then(function(t){e.closed||(e.next(t),e.complete())},function(t){return e.error(t)}).then(null,vg)})}function n$(s){return new wn(function(e){var t,n;try{for(var r=cs(s),i=r.next();!i.done;i=r.next()){var a=i.value;if(e.next(a),e.closed)return}}catch(o){t={error:o}}finally{try{i&&!i.done&&(n=r.return)&&n.call(r)}finally{if(t)throw t.error}}e.complete()})}function Lg(s){return new wn(function(e){i$(s,e).catch(function(t){return e.error(t)})})}function r$(s){return Lg(Ig(s))}function i$(s,e){var t,n,r,i;return LI(this,void 0,void 0,function(){var a,o;return Sg(this,function(l){switch(l.label){case 0:l.trys.push([0,5,6,11]),t=BI(s),l.label=1;case 1:return[4,t.next()];case 2:if(n=l.sent(),!!n.done)return[3,4];if(a=n.value,e.next(a),e.closed)return[2];l.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return o=l.sent(),r={error:o},[3,11];case 6:return l.trys.push([6,,9,10]),n&&!n.done&&(i=t.return)?[4,i.call(t)]:[3,8];case 7:l.sent(),l.label=8;case 8:return[3,10];case 9:if(r)throw r.error;return[7];case 10:return[7];case 11:return e.complete(),[2]}})})}function Ci(s,e,t,n,r){n===void 0&&(n=0),r===void 0&&(r=!1);var i=e.schedule(function(){t(),r?s.add(this.schedule(null,n)):this.unsubscribe()},n);if(s.add(i),!r)return i}function qg(s,e){return e===void 0&&(e=0),yc(function(t,n){t.subscribe(ko(n,function(r){return Ci(n,s,function(){return n.next(r)},e)},function(){return Ci(n,s,function(){return n.complete()},e)},function(r){return Ci(n,s,function(){return n.error(r)},e)}))})}function Bg(s,e){return e===void 0&&(e=0),yc(function(t,n){n.add(s.schedule(function(){return t.subscribe(n)},e))})}function s$(s,e){return bs(s).pipe(Bg(e),qg(e))}function a$(s,e){return bs(s).pipe(Bg(e),qg(e))}function o$(s,e){return new wn(function(t){var n=0;return e.schedule(function(){n===s.length?t.complete():(t.next(s[n++]),t.closed||this.schedule())})})}function c$(s,e){return new wn(function(t){var n;return Ci(t,e,function(){n=s[Og](),Ci(t,e,function(){var r,i,a;try{r=n.next(),i=r.value,a=r.done}catch(o){t.error(o);return}a?t.complete():t.next(i)},0,!0)}),function(){return ft(n==null?void 0:n.return)&&n.return()}})}function Ug(s,e){if(!s)throw new Error("Iterable cannot be null");return new wn(function(t){Ci(t,e,function(){var n=s[Symbol.asyncIterator]();Ci(t,e,function(){n.next().then(function(r){r.done?t.complete():t.next(r.value)})},0,!0)})})}function u$(s,e){return Ug(Ig(s),e)}function l$(s,e){if(s!=null){if(xg(s))return s$(s,e);if(Mh(s))return o$(s,e);if(_g(s))return a$(s,e);if(Mg(s))return Ug(s,e);if(Dg(s))return c$(s,e);if($g(s))return u$(s,e)}throw Pg(s)}function Pr(s,e){return e?l$(s,e):bs(s)}function Fg(s,e){return yc(function(t,n){var r=0;t.subscribe(ko(n,function(i){n.next(s.call(e,i,r++))}))})}var h$=Array.isArray;function d$(s,e){return h$(e)?s.apply(void 0,Fo([],ea(e))):s(e)}function f$(s){return Fg(function(e){return d$(s,e)})}function p$(s,e,t,n,r,i,a,o){var l=[],h=0,d=0,p=!1,m=function(){p&&!l.length&&!h&&e.complete()},w=function(S){return h<n?b(S):l.push(S)},b=function(S){h++;var R=!1;bs(t(S,d++)).subscribe(ko(e,function($){e.next($)},function(){R=!0},void 0,function(){if(R)try{h--;for(var $=function(){var q=l.shift();a||b(q)};l.length&&h<n;)$();m()}catch(q){e.error(q)}}))};return s.subscribe(ko(e,w,function(){p=!0,m()})),function(){}}function kg(s,e,t){return t===void 0&&(t=1/0),ft(e)?kg(function(n,r){return Fg(function(i,a){return e(n,i,r,a)})(bs(s(n,r)))},t):(typeof e=="number"&&(t=e),yc(function(n,r){return p$(n,r,s,t)}))}var m$=["addListener","removeListener"],y$=["addEventListener","removeEventListener"],g$=["on","off"];function ts(s,e,t,n){if(ft(t)&&(n=t,t=void 0),n)return ts(s,e,t).pipe(f$(n));var r=ea(b$(s)?y$.map(function(o){return function(l){return s[o](e,l,t)}}):E$(s)?m$.map(pm(s,e)):w$(s)?g$.map(pm(s,e)):[],2),i=r[0],a=r[1];if(!i&&Mh(s))return kg(function(o){return ts(o,e,t)})(bs(s));if(!i)throw new TypeError("Invalid event target");return new wn(function(o){var l=function(){for(var h=[],d=0;d<arguments.length;d++)h[d]=arguments[d];return o.next(1<h.length?h:h[0])};return i(l),function(){return a(l)}})}function pm(s,e){return function(t){return function(n){return s[t](e,n)}}}function E$(s){return ft(s.addListener)&&ft(s.removeListener)}function w$(s){return ft(s.on)&&ft(s.off)}function b$(s){return ft(s.addEventListener)&&ft(s.removeEventListener)}class mm{constructor(e){this.repository=e,this.entityAdapter=new My}test(e,t){e.where&&Array.isArray(e.where)&&e.where.length>0?(console.log("QueryBuilderHelper::createQueryBuilder/04:"),e.where.forEach((n,r)=>{const i=Object.keys(n)[0];console.log("QueryBuilderHelper::createQueryBuilder/key:",i);const a=n[i];console.log("QueryBuilderHelper::createQueryBuilder/value:",a),console.log("QueryBuilderHelper::createQueryBuilder/value._type:",a._type);const o=`${this.repository.metadata.name}.${this.getDatabaseColumnName(i)}`;if(a._type==="like"){let l=a._value;l.startsWith("'")&&l.endsWith("'")&&(l=l.slice(1,-1)),t.orWhere(`${o} LIKE :${i}`,{[i]:l})}else t[r===0?"where":"orWhere"](`${o} = :${i}`,{[i]:a})})):e.where&&typeof e.where=="object"&&this.isEmptyObject(e.where)&&console.log("QueryBuilderHelper::createQueryBuilder/05:")}transformWhereClause(e){return console.log("QueryBuilderHelper::transformWhereClause()/01"),console.log("QueryBuilderHelper::transformWhereClause()/where:",e),Array.isArray(e)?(console.log("QueryBuilderHelper::transformWhereClause()/where:",e),console.log("QueryBuilderHelper::transformWhereClause()/02"),e.map(t=>{console.log("QueryBuilderHelper::transformWhereClause()/03"),console.log("QueryBuilderHelper::transformWhereClause()/condition:",t);const n=Object.keys(t)[0];console.log("QueryBuilderHelper::transformWhereClause()/04");const r=t[n];if(console.log("QueryBuilderHelper::transformWhereClause()/05"),typeof r=="string"&&r.startsWith("Like(")&&r.endsWith(")")){console.log("QueryBuilderHelper::transformWhereClause()/06");const i=r.match(/^Like\((.*)\)$/);if(console.log("QueryBuilderHelper::transformWhereClause()/value:",r),console.log("QueryBuilderHelper::transformWhereClause()/match:",i),console.log("QueryBuilderHelper::transformWhereClause()/07"),i){console.log("QueryBuilderHelper::transformWhereClause()/08");const a=i[1];console.log("QueryBuilderHelper::transformWhereClause()/param:",a);const o={[n]:MM(a)};return console.log("QueryBuilderHelper::transformWhereClause()/ret:",o),o}}return console.log("QueryBuilderHelper::transformWhereClause()/09"),t})):(console.log("QueryBuilderHelper::transformWhereClause()/10"),e)}transformQueryInput(e){const t=this.transformWhereClause(e.where);return console.log("QueryBuilderHelper::transformQueryInput()/w:",t),{...e,where:t}}createQueryBuilder(e){var r;const t=(r=e.cmd)==null?void 0:r.query,n=this.repository.createQueryBuilder(this.repository.metadata.name);if(t!=null&&t.select&&t.select.length>0){this.entityAdapter.registerMappingFromEntity(e.serviceModel);const i=this.entityAdapter.getDbSelect(this.repository.metadata.name,t.select);n.select(i)}else{const i=this.repository.metadata.columns.map(a=>`${this.repository.metadata.name}.${a.databaseName}`);n.select(i)}return t!=null&&t.distinct&&n.distinct(!0),t!=null&&t.where&&(typeof t.where=="object"&&!Array.isArray(t.where)&&!this.isEmptyObject(t.where)?this.processObjectWhereClause(n,t.where):Array.isArray(t.where)&&t.where.length>0&&this.processArrayWhereClause(n,t.where)),t!=null&&t.take&&n.take(t.take),t!=null&&t.skip&&n.skip(t.skip),n}processObjectWhereClause(e,t){Object.keys(t).forEach((n,r)=>{const[i,a]=n.split("%"),o=`${this.repository.metadata.name}.${this.getDatabaseColumnName(i)}`,l=t[n],h=this.getSqlOperator(a),d=a==="BETWEEN"&&typeof l=="object"?`${o} BETWEEN :${i}Start AND :${i}End`:`${o} ${h} :${i}`,p=a==="BETWEEN"&&typeof l=="object"?{[`${i}Start`]:l.start,[`${i}End`]:l.end}:{[i]:l};r===0?e.where(d,p):e.andWhere(d,p)})}getSqlOperator(e){return{">":">","<":"<","=":"=",BETWEEN:"BETWEEN",LIKE:"LIKE"}[e]||"="}processArrayWhereClause2(e,t){console.log("QueryBuilderHelper::processArrayWhereClause2/04:"),console.log("QueryBuilderHelper::processArrayWhereClause2/where:",t);let n=JSON.stringify(t);console.log("QueryBuilderHelper::processArrayWhereClause2/where1:",n);const r=':"Like\\(',i=`')"}`,a=new RegExp(r,"g");n=n.replace(a,i),console.log("QueryBuilderHelper::processArrayWhereClause2/strWhere:",n),t=JSON.parse(n),console.log("QueryBuilderHelper::processArrayWhereClause2/where2:",t),t.forEach((o,l)=>{const h=Object.keys(o)[0];console.log("QueryBuilderHelper::processArrayWhereClause2/key:",h);const d=o[h];console.log("QueryBuilderHelper::processArrayWhereClause2/value:",d),console.log("QueryBuilderHelper::processArrayWhereClause2/value._type:",d._type);const p=`${this.repository.metadata.name}.${this.getDatabaseColumnName(h)}`;if(d._type==="like"){let m=d._value;console.log("QueryBuilderHelper::processArrayWhereClause2/likeValue:",m),m.startsWith("'")&&m.endsWith("'")&&(m=m.slice(1,-1)),console.log("QueryBuilderHelper::processArrayWhereClause2/`${dbField} LIKE :${key}`:",`${p} LIKE :${h}`),console.log("QueryBuilderHelper::processArrayWhereClause2/{ [key]: likeValue }:",{[h]:m}),e.orWhere(`${p} LIKE :${h}`,{[h]:m})}else e[l===0?"where":"orWhere"](`${p} = :${h}`,{[h]:d})})}processArrayWhereClause(e,t){console.log("QueryBuilderHelper::processArrayWhereClause()/01"),console.log("QueryBuilderHelper::processArrayWhereClause()/whereArray:",t),t.forEach((n,r)=>{const i=Object.keys(n)[0],a=n[i],o=`${this.repository.metadata.name}.${this.getDatabaseColumnName(i)}`;if(console.log("QueryBuilderHelper::processArrayWhereClause()/key:",i),console.log("QueryBuilderHelper::processArrayWhereClause()/value:",a),console.log("QueryBuilderHelper::processArrayWhereClause()/dbField:",o),console.log("QueryBuilderHelper::processArrayWhereClause()/02"),typeof a=="string"&&a.startsWith("Like(")&&a.endsWith(")")){console.log("QueryBuilderHelper::processArrayWhereClause()/03");const l=a.match(/^Like\((.*)\)$/);if(console.log("QueryBuilderHelper::processArrayWhereClause()/dbField:",o),l){console.log("QueryBuilderHelper::processArrayWhereClause()/04"),console.log("QueryBuilderHelper::processArrayWhereClause()/match:",l);let h=l[1];console.log("QueryBuilderHelper::processArrayWhereClause()/likeValue:",h),h.startsWith("'")&&h.endsWith("'")&&(h=h.slice(1,-1)),r===0?(console.log("QueryBuilderHelper::processArrayWhereClause()/05"),console.log("QueryBuilderHelper::processArrayWhereClause()/likeValue:",h),console.log("QueryBuilderHelper::processArrayWhereClause()/`${dbField} LIKE :${key}`:",`${o} LIKE :${i}`),console.log("QueryBuilderHelper::processArrayWhereClause()/{ [key]: likeValue }:",{[i]:h}),e.where(`${o} LIKE :${i}`,{[i]:h})):(console.log("QueryBuilderHelper::processArrayWhereClause()/06"),console.log("QueryBuilderHelper::processArrayWhereClause()/`${dbField} LIKE :${key}`:",`${o} LIKE :${i}`),console.log("QueryBuilderHelper::processArrayWhereClause()/{ [key]: likeValue }:",{[i]:h}),e.orWhere(`${o} LIKE :${i}`,{[i]:h}))}}else console.log("QueryBuilderHelper::processArrayWhereClause()/07"),r===0?(console.log("QueryBuilderHelper::processArrayWhereClause()/08"),console.log("QueryBuilderHelper::processArrayWhereClause()/`${dbField} LIKE :${key}`:",`${o} LIKE :${i}`),console.log("QueryBuilderHelper::processArrayWhereClause()/{ [key]: likeValue }:",{[i]:a}),e.where(`${o} = :${i}`,{[i]:a})):(console.log("QueryBuilderHelper::processArrayWhereClause()/09"),console.log("QueryBuilderHelper::processArrayWhereClause()/`${dbField} LIKE :${key}`:",`${o} LIKE :${i}`),console.log("QueryBuilderHelper::processArrayWhereClause()/{ [key]: likeValue }:",{[i]:a}),e.orWhere(`${o} = :${i}`,{[i]:a}))})}getDatabaseColumnName(e){const t=this.repository.metadata.findColumnWithPropertyName(e);return t?t.databaseName:e}isEmptyObject(e){return Object.keys(e).length===0}addJSONSelect(e,t){const n=this.repository.createQueryBuilder(this.repository.metadata.name);return t.forEach(r=>{n.addSelect(`JSON_UNQUOTE(JSON_EXTRACT(${e}, '$.${r}'))`,r)}),this}updateJSONField(e,t){const n=this.repository.createQueryBuilder().update(this.repository.metadata.name),r=Object.keys(t).map(i=>`JSON_SET(${e}, '$.${i}', '${t[i]}')`).join(", ");return n.set({[e]:()=>r}),this}}function T$(s){return s.toLowerCase().replace(/[-_](\w)/g,(e,t)=>t.toUpperCase())}function ym(s){const e=T$(s);return e.charAt(0).toUpperCase()+e.slice(1)}function S$(s){return s.replace(/([a-z])([A-Z])/g,"$1-$2").replace(/[\s_]+/g,"-").toLowerCase()}function jg(s,e){return function(){return s.apply(e,arguments)}}const{toString:A$}=Object.prototype,{getPrototypeOf:Ph}=Object,{iterator:gc,toStringTag:Wg}=Symbol,Ec=(s=>e=>{const t=A$.call(e);return s[t]||(s[t]=t.slice(8,-1).toLowerCase())})(Object.create(null)),rr=s=>(s=s.toLowerCase(),e=>Ec(e)===s),wc=s=>e=>typeof e===s,{isArray:Ts}=Array,us=wc("undefined");function ua(s){return s!==null&&!us(s)&&s.constructor!==null&&!us(s.constructor)&&hn(s.constructor.isBuffer)&&s.constructor.isBuffer(s)}const Qg=rr("ArrayBuffer");function N$(s){let e;return typeof ArrayBuffer<"u"&&ArrayBuffer.isView?e=ArrayBuffer.isView(s):e=s&&s.buffer&&Qg(s.buffer),e}const C$=wc("string"),hn=wc("function"),Vg=wc("number"),la=s=>s!==null&&typeof s=="object",v$=s=>s===!0||s===!1,vo=s=>{if(Ec(s)!=="object")return!1;const e=Ph(s);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Wg in s)&&!(gc in s)},R$=s=>{if(!la(s)||ua(s))return!1;try{return Object.keys(s).length===0&&Object.getPrototypeOf(s)===Object.prototype}catch{return!1}},_$=rr("Date"),x$=rr("File"),M$=rr("Blob"),P$=rr("FileList"),O$=s=>la(s)&&hn(s.pipe),D$=s=>{let e;return s&&(typeof FormData=="function"&&s instanceof FormData||hn(s.append)&&((e=Ec(s))==="formdata"||e==="object"&&hn(s.toString)&&s.toString()==="[object FormData]"))},I$=rr("URLSearchParams"),[$$,L$,q$,B$]=["ReadableStream","Request","Response","Headers"].map(rr),U$=s=>s.trim?s.trim():s.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"");function ha(s,e,{allOwnKeys:t=!1}={}){if(s===null||typeof s>"u")return;let n,r;if(typeof s!="object"&&(s=[s]),Ts(s))for(n=0,r=s.length;n<r;n++)e.call(null,s[n],n,s);else{if(ua(s))return;const i=t?Object.getOwnPropertyNames(s):Object.keys(s),a=i.length;let o;for(n=0;n<a;n++)o=i[n],e.call(null,s[o],o,s)}}function Hg(s,e){if(ua(s))return null;e=e.toLowerCase();const t=Object.keys(s);let n=t.length,r;for(;n-- >0;)if(r=t[n],e===r.toLowerCase())return r;return null}const Ai=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:global,Yg=s=>!us(s)&&s!==Ai;function Bl(){const{caseless:s,skipUndefined:e}=Yg(this)&&this||{},t={},n=(r,i)=>{const a=s&&Hg(t,i)||i;vo(t[a])&&vo(r)?t[a]=Bl(t[a],r):vo(r)?t[a]=Bl({},r):Ts(r)?t[a]=r.slice():(!e||!us(r))&&(t[a]=r)};for(let r=0,i=arguments.length;r<i;r++)arguments[r]&&ha(arguments[r],n);return t}const F$=(s,e,t,{allOwnKeys:n}={})=>(ha(e,(r,i)=>{t&&hn(r)?s[i]=jg(r,t):s[i]=r},{allOwnKeys:n}),s),k$=s=>(s.charCodeAt(0)===65279&&(s=s.slice(1)),s),j$=(s,e,t,n)=>{s.prototype=Object.create(e.prototype,n),s.prototype.constructor=s,Object.defineProperty(s,"super",{value:e.prototype}),t&&Object.assign(s.prototype,t)},W$=(s,e,t,n)=>{let r,i,a;const o={};if(e=e||{},s==null)return e;do{for(r=Object.getOwnPropertyNames(s),i=r.length;i-- >0;)a=r[i],(!n||n(a,s,e))&&!o[a]&&(e[a]=s[a],o[a]=!0);s=t!==!1&&Ph(s)}while(s&&(!t||t(s,e))&&s!==Object.prototype);return e},Q$=(s,e,t)=>{s=String(s),(t===void 0||t>s.length)&&(t=s.length),t-=e.length;const n=s.indexOf(e,t);return n!==-1&&n===t},V$=s=>{if(!s)return null;if(Ts(s))return s;let e=s.length;if(!Vg(e))return null;const t=new Array(e);for(;e-- >0;)t[e]=s[e];return t},H$=(s=>e=>s&&e instanceof s)(typeof Uint8Array<"u"&&Ph(Uint8Array)),Y$=(s,e)=>{const n=(s&&s[gc]).call(s);let r;for(;(r=n.next())&&!r.done;){const i=r.value;e.call(s,i[0],i[1])}},G$=(s,e)=>{let t;const n=[];for(;(t=s.exec(e))!==null;)n.push(t);return n},z$=rr("HTMLFormElement"),K$=s=>s.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(t,n,r){return n.toUpperCase()+r}),gm=(({hasOwnProperty:s})=>(e,t)=>s.call(e,t))(Object.prototype),J$=rr("RegExp"),Gg=(s,e)=>{const t=Object.getOwnPropertyDescriptors(s),n={};ha(t,(r,i)=>{let a;(a=e(r,i,s))!==!1&&(n[i]=a||r)}),Object.defineProperties(s,n)},X$=s=>{Gg(s,(e,t)=>{if(hn(s)&&["arguments","caller","callee"].indexOf(t)!==-1)return!1;const n=s[t];if(hn(n)){if(e.enumerable=!1,"writable"in e){e.writable=!1;return}e.set||(e.set=()=>{throw Error("Can not rewrite read-only method '"+t+"'")})}})},Z$=(s,e)=>{const t={},n=r=>{r.forEach(i=>{t[i]=!0})};return Ts(s)?n(s):n(String(s).split(e)),t},eL=()=>{},tL=(s,e)=>s!=null&&Number.isFinite(s=+s)?s:e;function nL(s){return!!(s&&hn(s.append)&&s[Wg]==="FormData"&&s[gc])}const rL=s=>{const e=new Array(10),t=(n,r)=>{if(la(n)){if(e.indexOf(n)>=0)return;if(ua(n))return n;if(!("toJSON"in n)){e[r]=n;const i=Ts(n)?[]:{};return ha(n,(a,o)=>{const l=t(a,r+1);!us(l)&&(i[o]=l)}),e[r]=void 0,i}}return n};return t(s,0)},iL=rr("AsyncFunction"),sL=s=>s&&(la(s)||hn(s))&&hn(s.then)&&hn(s.catch),zg=((s,e)=>s?setImmediate:e?((t,n)=>(Ai.addEventListener("message",({source:r,data:i})=>{r===Ai&&i===t&&n.length&&n.shift()()},!1),r=>{n.push(r),Ai.postMessage(t,"*")}))(`axios@${Math.random()}`,[]):t=>setTimeout(t))(typeof setImmediate=="function",hn(Ai.postMessage)),aL=typeof queueMicrotask<"u"?queueMicrotask.bind(Ai):typeof process<"u"&&process.nextTick||zg,oL=s=>s!=null&&hn(s[gc]),j={isArray:Ts,isArrayBuffer:Qg,isBuffer:ua,isFormData:D$,isArrayBufferView:N$,isString:C$,isNumber:Vg,isBoolean:v$,isObject:la,isPlainObject:vo,isEmptyObject:R$,isReadableStream:$$,isRequest:L$,isResponse:q$,isHeaders:B$,isUndefined:us,isDate:_$,isFile:x$,isBlob:M$,isRegExp:J$,isFunction:hn,isStream:O$,isURLSearchParams:I$,isTypedArray:H$,isFileList:P$,forEach:ha,merge:Bl,extend:F$,trim:U$,stripBOM:k$,inherits:j$,toFlatObject:W$,kindOf:Ec,kindOfTest:rr,endsWith:Q$,toArray:V$,forEachEntry:Y$,matchAll:G$,isHTMLForm:z$,hasOwnProperty:gm,hasOwnProp:gm,reduceDescriptors:Gg,freezeMethods:X$,toObjectSet:Z$,toCamelCase:K$,noop:eL,toFiniteNumber:tL,findKey:Hg,global:Ai,isContextDefined:Yg,isSpecCompliantForm:nL,toJSONObject:rL,isAsyncFn:iL,isThenable:sL,setImmediate:zg,asap:aL,isIterable:oL};function $e(s,e,t,n,r){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=s,this.name="AxiosError",e&&(this.code=e),t&&(this.config=t),n&&(this.request=n),r&&(this.response=r,this.status=r.status?r.status:null)}j.inherits($e,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:j.toJSONObject(this.config),code:this.code,status:this.status}}});const Kg=$e.prototype,Jg={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(s=>{Jg[s]={value:s}});Object.defineProperties($e,Jg);Object.defineProperty(Kg,"isAxiosError",{value:!0});$e.from=(s,e,t,n,r,i)=>{const a=Object.create(Kg);j.toFlatObject(s,a,function(d){return d!==Error.prototype},h=>h!=="isAxiosError");const o=s&&s.message?s.message:"Error",l=e==null&&s?s.code:e;return $e.call(a,o,l,t,n,r),s&&a.cause==null&&Object.defineProperty(a,"cause",{value:s,configurable:!0}),a.name=s&&s.name||"Error",i&&Object.assign(a,i),a};const cL=null;function Ul(s){return j.isPlainObject(s)||j.isArray(s)}function Xg(s){return j.endsWith(s,"[]")?s.slice(0,-2):s}function Em(s,e,t){return s?s.concat(e).map(function(r,i){return r=Xg(r),!t&&i?"["+r+"]":r}).join(t?".":""):e}function uL(s){return j.isArray(s)&&!s.some(Ul)}const lL=j.toFlatObject(j,{},null,function(e){return/^is[A-Z]/.test(e)});function bc(s,e,t){if(!j.isObject(s))throw new TypeError("target must be an object");e=e||new FormData,t=j.toFlatObject(t,{metaTokens:!0,dots:!1,indexes:!1},!1,function(S,R){return!j.isUndefined(R[S])});const n=t.metaTokens,r=t.visitor||d,i=t.dots,a=t.indexes,l=(t.Blob||typeof Blob<"u"&&Blob)&&j.isSpecCompliantForm(e);if(!j.isFunction(r))throw new TypeError("visitor must be a function");function h(b){if(b===null)return"";if(j.isDate(b))return b.toISOString();if(j.isBoolean(b))return b.toString();if(!l&&j.isBlob(b))throw new $e("Blob is not supported. Use a Buffer instead.");return j.isArrayBuffer(b)||j.isTypedArray(b)?l&&typeof Blob=="function"?new Blob([b]):Buffer.from(b):b}function d(b,S,R){let $=b;if(b&&!R&&typeof b=="object"){if(j.endsWith(S,"{}"))S=n?S:S.slice(0,-2),b=JSON.stringify(b);else if(j.isArray(b)&&uL(b)||(j.isFileList(b)||j.endsWith(S,"[]"))&&($=j.toArray(b)))return S=Xg(S),$.forEach(function(O,J){!(j.isUndefined(O)||O===null)&&e.append(a===!0?Em([S],J,i):a===null?S:S+"[]",h(O))}),!1}return Ul(b)?!0:(e.append(Em(R,S,i),h(b)),!1)}const p=[],m=Object.assign(lL,{defaultVisitor:d,convertValue:h,isVisitable:Ul});function w(b,S){if(!j.isUndefined(b)){if(p.indexOf(b)!==-1)throw Error("Circular reference detected in "+S.join("."));p.push(b),j.forEach(b,function($,q){(!(j.isUndefined($)||$===null)&&r.call(e,$,j.isString(q)?q.trim():q,S,m))===!0&&w($,S?S.concat(q):[q])}),p.pop()}}if(!j.isObject(s))throw new TypeError("data must be an object");return w(s),e}function wm(s){const e={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(s).replace(/[!'()~]|%20|%00/g,function(n){return e[n]})}function Oh(s,e){this._pairs=[],s&&bc(s,this,e)}const Zg=Oh.prototype;Zg.append=function(e,t){this._pairs.push([e,t])};Zg.toString=function(e){const t=e?function(n){return e.call(this,n,wm)}:wm;return this._pairs.map(function(r){return t(r[0])+"="+t(r[1])},"").join("&")};function hL(s){return encodeURIComponent(s).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+")}function eE(s,e,t){if(!e)return s;const n=t&&t.encode||hL;j.isFunction(t)&&(t={serialize:t});const r=t&&t.serialize;let i;if(r?i=r(e,t):i=j.isURLSearchParams(e)?e.toString():new Oh(e,t).toString(n),i){const a=s.indexOf("#");a!==-1&&(s=s.slice(0,a)),s+=(s.indexOf("?")===-1?"?":"&")+i}return s}class bm{constructor(){this.handlers=[]}use(e,t,n){return this.handlers.push({fulfilled:e,rejected:t,synchronous:n?n.synchronous:!1,runWhen:n?n.runWhen:null}),this.handlers.length-1}eject(e){this.handlers[e]&&(this.handlers[e]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(e){j.forEach(this.handlers,function(n){n!==null&&e(n)})}}const tE={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},dL=typeof URLSearchParams<"u"?URLSearchParams:Oh,fL=typeof FormData<"u"?FormData:null,pL=typeof Blob<"u"?Blob:null,mL={isBrowser:!0,classes:{URLSearchParams:dL,FormData:fL,Blob:pL},protocols:["http","https","file","blob","url","data"]},Dh=typeof window<"u"&&typeof document<"u",Fl=typeof navigator=="object"&&navigator||void 0,yL=Dh&&(!Fl||["ReactNative","NativeScript","NS"].indexOf(Fl.product)<0),gL=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&typeof self.importScripts=="function",EL=Dh&&window.location.href||"http://localhost",wL=Object.freeze(Object.defineProperty({__proto__:null,hasBrowserEnv:Dh,hasStandardBrowserEnv:yL,hasStandardBrowserWebWorkerEnv:gL,navigator:Fl,origin:EL},Symbol.toStringTag,{value:"Module"})),Yt={...wL,...mL};function bL(s,e){return bc(s,new Yt.classes.URLSearchParams,{visitor:function(t,n,r,i){return Yt.isNode&&j.isBuffer(t)?(this.append(n,t.toString("base64")),!1):i.defaultVisitor.apply(this,arguments)},...e})}function TL(s){return j.matchAll(/\w+|\[(\w*)]/g,s).map(e=>e[0]==="[]"?"":e[1]||e[0])}function SL(s){const e={},t=Object.keys(s);let n;const r=t.length;let i;for(n=0;n<r;n++)i=t[n],e[i]=s[i];return e}function nE(s){function e(t,n,r,i){let a=t[i++];if(a==="__proto__")return!0;const o=Number.isFinite(+a),l=i>=t.length;return a=!a&&j.isArray(r)?r.length:a,l?(j.hasOwnProp(r,a)?r[a]=[r[a],n]:r[a]=n,!o):((!r[a]||!j.isObject(r[a]))&&(r[a]=[]),e(t,n,r[a],i)&&j.isArray(r[a])&&(r[a]=SL(r[a])),!o)}if(j.isFormData(s)&&j.isFunction(s.entries)){const t={};return j.forEachEntry(s,(n,r)=>{e(TL(n),r,t,0)}),t}return null}function AL(s,e,t){if(j.isString(s))try{return(e||JSON.parse)(s),j.trim(s)}catch(n){if(n.name!=="SyntaxError")throw n}return(t||JSON.stringify)(s)}const da={transitional:tE,adapter:["xhr","http","fetch"],transformRequest:[function(e,t){const n=t.getContentType()||"",r=n.indexOf("application/json")>-1,i=j.isObject(e);if(i&&j.isHTMLForm(e)&&(e=new FormData(e)),j.isFormData(e))return r?JSON.stringify(nE(e)):e;if(j.isArrayBuffer(e)||j.isBuffer(e)||j.isStream(e)||j.isFile(e)||j.isBlob(e)||j.isReadableStream(e))return e;if(j.isArrayBufferView(e))return e.buffer;if(j.isURLSearchParams(e))return t.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),e.toString();let o;if(i){if(n.indexOf("application/x-www-form-urlencoded")>-1)return bL(e,this.formSerializer).toString();if((o=j.isFileList(e))||n.indexOf("multipart/form-data")>-1){const l=this.env&&this.env.FormData;return bc(o?{"files[]":e}:e,l&&new l,this.formSerializer)}}return i||r?(t.setContentType("application/json",!1),AL(e)):e}],transformResponse:[function(e){const t=this.transitional||da.transitional,n=t&&t.forcedJSONParsing,r=this.responseType==="json";if(j.isResponse(e)||j.isReadableStream(e))return e;if(e&&j.isString(e)&&(n&&!this.responseType||r)){const a=!(t&&t.silentJSONParsing)&&r;try{return JSON.parse(e,this.parseReviver)}catch(o){if(a)throw o.name==="SyntaxError"?$e.from(o,$e.ERR_BAD_RESPONSE,this,null,this.response):o}}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:Yt.classes.FormData,Blob:Yt.classes.Blob},validateStatus:function(e){return e>=200&&e<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};j.forEach(["delete","get","head","post","put","patch"],s=>{da.headers[s]={}});const NL=j.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),CL=s=>{const e={};let t,n,r;return s&&s.split(`
`).forEach(function(a){r=a.indexOf(":"),t=a.substring(0,r).trim().toLowerCase(),n=a.substring(r+1).trim(),!(!t||e[t]&&NL[t])&&(t==="set-cookie"?e[t]?e[t].push(n):e[t]=[n]:e[t]=e[t]?e[t]+", "+n:n)}),e},Tm=Symbol("internals");function Ws(s){return s&&String(s).trim().toLowerCase()}function Ro(s){return s===!1||s==null?s:j.isArray(s)?s.map(Ro):String(s)}function vL(s){const e=Object.create(null),t=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let n;for(;n=t.exec(s);)e[n[1]]=n[2];return e}const RL=s=>/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(s.trim());function il(s,e,t,n,r){if(j.isFunction(n))return n.call(this,e,t);if(r&&(e=t),!!j.isString(e)){if(j.isString(n))return e.indexOf(n)!==-1;if(j.isRegExp(n))return n.test(e)}}function _L(s){return s.trim().toLowerCase().replace(/([a-z\d])(\w*)/g,(e,t,n)=>t.toUpperCase()+n)}function xL(s,e){const t=j.toCamelCase(" "+e);["get","set","has"].forEach(n=>{Object.defineProperty(s,n+t,{value:function(r,i,a){return this[n].call(this,e,r,i,a)},configurable:!0})})}let dn=class{constructor(e){e&&this.set(e)}set(e,t,n){const r=this;function i(o,l,h){const d=Ws(l);if(!d)throw new Error("header name must be a non-empty string");const p=j.findKey(r,d);(!p||r[p]===void 0||h===!0||h===void 0&&r[p]!==!1)&&(r[p||l]=Ro(o))}const a=(o,l)=>j.forEach(o,(h,d)=>i(h,d,l));if(j.isPlainObject(e)||e instanceof this.constructor)a(e,t);else if(j.isString(e)&&(e=e.trim())&&!RL(e))a(CL(e),t);else if(j.isObject(e)&&j.isIterable(e)){let o={},l,h;for(const d of e){if(!j.isArray(d))throw TypeError("Object iterator must return a key-value pair");o[h=d[0]]=(l=o[h])?j.isArray(l)?[...l,d[1]]:[l,d[1]]:d[1]}a(o,t)}else e!=null&&i(t,e,n);return this}get(e,t){if(e=Ws(e),e){const n=j.findKey(this,e);if(n){const r=this[n];if(!t)return r;if(t===!0)return vL(r);if(j.isFunction(t))return t.call(this,r,n);if(j.isRegExp(t))return t.exec(r);throw new TypeError("parser must be boolean|regexp|function")}}}has(e,t){if(e=Ws(e),e){const n=j.findKey(this,e);return!!(n&&this[n]!==void 0&&(!t||il(this,this[n],n,t)))}return!1}delete(e,t){const n=this;let r=!1;function i(a){if(a=Ws(a),a){const o=j.findKey(n,a);o&&(!t||il(n,n[o],o,t))&&(delete n[o],r=!0)}}return j.isArray(e)?e.forEach(i):i(e),r}clear(e){const t=Object.keys(this);let n=t.length,r=!1;for(;n--;){const i=t[n];(!e||il(this,this[i],i,e,!0))&&(delete this[i],r=!0)}return r}normalize(e){const t=this,n={};return j.forEach(this,(r,i)=>{const a=j.findKey(n,i);if(a){t[a]=Ro(r),delete t[i];return}const o=e?_L(i):String(i).trim();o!==i&&delete t[i],t[o]=Ro(r),n[o]=!0}),this}concat(...e){return this.constructor.concat(this,...e)}toJSON(e){const t=Object.create(null);return j.forEach(this,(n,r)=>{n!=null&&n!==!1&&(t[r]=e&&j.isArray(n)?n.join(", "):n)}),t}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(([e,t])=>e+": "+t).join(`
`)}getSetCookie(){return this.get("set-cookie")||[]}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(e){return e instanceof this?e:new this(e)}static concat(e,...t){const n=new this(e);return t.forEach(r=>n.set(r)),n}static accessor(e){const n=(this[Tm]=this[Tm]={accessors:{}}).accessors,r=this.prototype;function i(a){const o=Ws(a);n[o]||(xL(r,a),n[o]=!0)}return j.isArray(e)?e.forEach(i):i(e),this}};dn.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]);j.reduceDescriptors(dn.prototype,({value:s},e)=>{let t=e[0].toUpperCase()+e.slice(1);return{get:()=>s,set(n){this[t]=n}}});j.freezeMethods(dn);function sl(s,e){const t=this||da,n=e||t,r=dn.from(n.headers);let i=n.data;return j.forEach(s,function(o){i=o.call(t,i,r.normalize(),e?e.status:void 0)}),r.normalize(),i}function rE(s){return!!(s&&s.__CANCEL__)}function Ss(s,e,t){$e.call(this,s??"canceled",$e.ERR_CANCELED,e,t),this.name="CanceledError"}j.inherits(Ss,$e,{__CANCEL__:!0});function iE(s,e,t){const n=t.config.validateStatus;!t.status||!n||n(t.status)?s(t):e(new $e("Request failed with status code "+t.status,[$e.ERR_BAD_REQUEST,$e.ERR_BAD_RESPONSE][Math.floor(t.status/100)-4],t.config,t.request,t))}function ML(s){const e=/^([-+\w]{1,25})(:?\/\/|:)/.exec(s);return e&&e[1]||""}function PL(s,e){s=s||10;const t=new Array(s),n=new Array(s);let r=0,i=0,a;return e=e!==void 0?e:1e3,function(l){const h=Date.now(),d=n[i];a||(a=h),t[r]=l,n[r]=h;let p=i,m=0;for(;p!==r;)m+=t[p++],p=p%s;if(r=(r+1)%s,r===i&&(i=(i+1)%s),h-a<e)return;const w=d&&h-d;return w?Math.round(m*1e3/w):void 0}}function OL(s,e){let t=0,n=1e3/e,r,i;const a=(h,d=Date.now())=>{t=d,r=null,i&&(clearTimeout(i),i=null),s(...h)};return[(...h)=>{const d=Date.now(),p=d-t;p>=n?a(h,d):(r=h,i||(i=setTimeout(()=>{i=null,a(r)},n-p)))},()=>r&&a(r)]}const jo=(s,e,t=3)=>{let n=0;const r=PL(50,250);return OL(i=>{const a=i.loaded,o=i.lengthComputable?i.total:void 0,l=a-n,h=r(l),d=a<=o;n=a;const p={loaded:a,total:o,progress:o?a/o:void 0,bytes:l,rate:h||void 0,estimated:h&&o&&d?(o-a)/h:void 0,event:i,lengthComputable:o!=null,[e?"download":"upload"]:!0};s(p)},t)},Sm=(s,e)=>{const t=s!=null;return[n=>e[0]({lengthComputable:t,total:s,loaded:n}),e[1]]},Am=s=>(...e)=>j.asap(()=>s(...e)),DL=Yt.hasStandardBrowserEnv?((s,e)=>t=>(t=new URL(t,Yt.origin),s.protocol===t.protocol&&s.host===t.host&&(e||s.port===t.port)))(new URL(Yt.origin),Yt.navigator&&/(msie|trident)/i.test(Yt.navigator.userAgent)):()=>!0,IL=Yt.hasStandardBrowserEnv?{write(s,e,t,n,r,i){const a=[s+"="+encodeURIComponent(e)];j.isNumber(t)&&a.push("expires="+new Date(t).toGMTString()),j.isString(n)&&a.push("path="+n),j.isString(r)&&a.push("domain="+r),i===!0&&a.push("secure"),document.cookie=a.join("; ")},read(s){const e=document.cookie.match(new RegExp("(^|;\\s*)("+s+")=([^;]*)"));return e?decodeURIComponent(e[3]):null},remove(s){this.write(s,"",Date.now()-864e5)}}:{write(){},read(){return null},remove(){}};function $L(s){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(s)}function LL(s,e){return e?s.replace(/\/?\/$/,"")+"/"+e.replace(/^\/+/,""):s}function sE(s,e,t){let n=!$L(e);return s&&(n||t==!1)?LL(s,e):e}const Nm=s=>s instanceof dn?{...s}:s;function _i(s,e){e=e||{};const t={};function n(h,d,p,m){return j.isPlainObject(h)&&j.isPlainObject(d)?j.merge.call({caseless:m},h,d):j.isPlainObject(d)?j.merge({},d):j.isArray(d)?d.slice():d}function r(h,d,p,m){if(j.isUndefined(d)){if(!j.isUndefined(h))return n(void 0,h,p,m)}else return n(h,d,p,m)}function i(h,d){if(!j.isUndefined(d))return n(void 0,d)}function a(h,d){if(j.isUndefined(d)){if(!j.isUndefined(h))return n(void 0,h)}else return n(void 0,d)}function o(h,d,p){if(p in e)return n(h,d);if(p in s)return n(void 0,h)}const l={url:i,method:i,data:i,baseURL:a,transformRequest:a,transformResponse:a,paramsSerializer:a,timeout:a,timeoutMessage:a,withCredentials:a,withXSRFToken:a,adapter:a,responseType:a,xsrfCookieName:a,xsrfHeaderName:a,onUploadProgress:a,onDownloadProgress:a,decompress:a,maxContentLength:a,maxBodyLength:a,beforeRedirect:a,transport:a,httpAgent:a,httpsAgent:a,cancelToken:a,socketPath:a,responseEncoding:a,validateStatus:o,headers:(h,d,p)=>r(Nm(h),Nm(d),p,!0)};return j.forEach(Object.keys({...s,...e}),function(d){const p=l[d]||r,m=p(s[d],e[d],d);j.isUndefined(m)&&p!==o||(t[d]=m)}),t}const aE=s=>{const e=_i({},s);let{data:t,withXSRFToken:n,xsrfHeaderName:r,xsrfCookieName:i,headers:a,auth:o}=e;if(e.headers=a=dn.from(a),e.url=eE(sE(e.baseURL,e.url,e.allowAbsoluteUrls),s.params,s.paramsSerializer),o&&a.set("Authorization","Basic "+btoa((o.username||"")+":"+(o.password?unescape(encodeURIComponent(o.password)):""))),j.isFormData(t)){if(Yt.hasStandardBrowserEnv||Yt.hasStandardBrowserWebWorkerEnv)a.setContentType(void 0);else if(j.isFunction(t.getHeaders)){const l=t.getHeaders(),h=["content-type","content-length"];Object.entries(l).forEach(([d,p])=>{h.includes(d.toLowerCase())&&a.set(d,p)})}}if(Yt.hasStandardBrowserEnv&&(n&&j.isFunction(n)&&(n=n(e)),n||n!==!1&&DL(e.url))){const l=r&&i&&IL.read(i);l&&a.set(r,l)}return e},qL=typeof XMLHttpRequest<"u",BL=qL&&function(s){return new Promise(function(t,n){const r=aE(s);let i=r.data;const a=dn.from(r.headers).normalize();let{responseType:o,onUploadProgress:l,onDownloadProgress:h}=r,d,p,m,w,b;function S(){w&&w(),b&&b(),r.cancelToken&&r.cancelToken.unsubscribe(d),r.signal&&r.signal.removeEventListener("abort",d)}let R=new XMLHttpRequest;R.open(r.method.toUpperCase(),r.url,!0),R.timeout=r.timeout;function $(){if(!R)return;const O=dn.from("getAllResponseHeaders"in R&&R.getAllResponseHeaders()),ne={data:!o||o==="text"||o==="json"?R.responseText:R.response,status:R.status,statusText:R.statusText,headers:O,config:s,request:R};iE(function(pe){t(pe),S()},function(pe){n(pe),S()},ne),R=null}"onloadend"in R?R.onloadend=$:R.onreadystatechange=function(){!R||R.readyState!==4||R.status===0&&!(R.responseURL&&R.responseURL.indexOf("file:")===0)||setTimeout($)},R.onabort=function(){R&&(n(new $e("Request aborted",$e.ECONNABORTED,s,R)),R=null)},R.onerror=function(J){const ne=J&&J.message?J.message:"Network Error",ge=new $e(ne,$e.ERR_NETWORK,s,R);ge.event=J||null,n(ge),R=null},R.ontimeout=function(){let J=r.timeout?"timeout of "+r.timeout+"ms exceeded":"timeout exceeded";const ne=r.transitional||tE;r.timeoutErrorMessage&&(J=r.timeoutErrorMessage),n(new $e(J,ne.clarifyTimeoutError?$e.ETIMEDOUT:$e.ECONNABORTED,s,R)),R=null},i===void 0&&a.setContentType(null),"setRequestHeader"in R&&j.forEach(a.toJSON(),function(J,ne){R.setRequestHeader(ne,J)}),j.isUndefined(r.withCredentials)||(R.withCredentials=!!r.withCredentials),o&&o!=="json"&&(R.responseType=r.responseType),h&&([m,b]=jo(h,!0),R.addEventListener("progress",m)),l&&R.upload&&([p,w]=jo(l),R.upload.addEventListener("progress",p),R.upload.addEventListener("loadend",w)),(r.cancelToken||r.signal)&&(d=O=>{R&&(n(!O||O.type?new Ss(null,s,R):O),R.abort(),R=null)},r.cancelToken&&r.cancelToken.subscribe(d),r.signal&&(r.signal.aborted?d():r.signal.addEventListener("abort",d)));const q=ML(r.url);if(q&&Yt.protocols.indexOf(q)===-1){n(new $e("Unsupported protocol "+q+":",$e.ERR_BAD_REQUEST,s));return}R.send(i||null)})},UL=(s,e)=>{const{length:t}=s=s?s.filter(Boolean):[];if(e||t){let n=new AbortController,r;const i=function(h){if(!r){r=!0,o();const d=h instanceof Error?h:this.reason;n.abort(d instanceof $e?d:new Ss(d instanceof Error?d.message:d))}};let a=e&&setTimeout(()=>{a=null,i(new $e(`timeout ${e} of ms exceeded`,$e.ETIMEDOUT))},e);const o=()=>{s&&(a&&clearTimeout(a),a=null,s.forEach(h=>{h.unsubscribe?h.unsubscribe(i):h.removeEventListener("abort",i)}),s=null)};s.forEach(h=>h.addEventListener("abort",i));const{signal:l}=n;return l.unsubscribe=()=>j.asap(o),l}},FL=function*(s,e){let t=s.byteLength;if(t<e){yield s;return}let n=0,r;for(;n<t;)r=n+e,yield s.slice(n,r),n=r},kL=async function*(s,e){for await(const t of jL(s))yield*FL(t,e)},jL=async function*(s){if(s[Symbol.asyncIterator]){yield*s;return}const e=s.getReader();try{for(;;){const{done:t,value:n}=await e.read();if(t)break;yield n}}finally{await e.cancel()}},Cm=(s,e,t,n)=>{const r=kL(s,e);let i=0,a,o=l=>{a||(a=!0,n&&n(l))};return new ReadableStream({async pull(l){try{const{done:h,value:d}=await r.next();if(h){o(),l.close();return}let p=d.byteLength;if(t){let m=i+=p;t(m)}l.enqueue(new Uint8Array(d))}catch(h){throw o(h),h}},cancel(l){return o(l),r.return()}},{highWaterMark:2})},vm=64*1024,{isFunction:ho}=j,WL=(({Request:s,Response:e})=>({Request:s,Response:e}))(j.global),{ReadableStream:Rm,TextEncoder:_m}=j.global,xm=(s,...e)=>{try{return!!s(...e)}catch{return!1}},QL=s=>{s=j.merge.call({skipUndefined:!0},WL,s);const{fetch:e,Request:t,Response:n}=s,r=e?ho(e):typeof fetch=="function",i=ho(t),a=ho(n);if(!r)return!1;const o=r&&ho(Rm),l=r&&(typeof _m=="function"?(b=>S=>b.encode(S))(new _m):async b=>new Uint8Array(await new t(b).arrayBuffer())),h=i&&o&&xm(()=>{let b=!1;const S=new t(Yt.origin,{body:new Rm,method:"POST",get duplex(){return b=!0,"half"}}).headers.has("Content-Type");return b&&!S}),d=a&&o&&xm(()=>j.isReadableStream(new n("").body)),p={stream:d&&(b=>b.body)};r&&["text","arrayBuffer","blob","formData","stream"].forEach(b=>{!p[b]&&(p[b]=(S,R)=>{let $=S&&S[b];if($)return $.call(S);throw new $e(`Response type '${b}' is not supported`,$e.ERR_NOT_SUPPORT,R)})});const m=async b=>{if(b==null)return 0;if(j.isBlob(b))return b.size;if(j.isSpecCompliantForm(b))return(await new t(Yt.origin,{method:"POST",body:b}).arrayBuffer()).byteLength;if(j.isArrayBufferView(b)||j.isArrayBuffer(b))return b.byteLength;if(j.isURLSearchParams(b)&&(b=b+""),j.isString(b))return(await l(b)).byteLength},w=async(b,S)=>{const R=j.toFiniteNumber(b.getContentLength());return R??m(S)};return async b=>{let{url:S,method:R,data:$,signal:q,cancelToken:O,timeout:J,onDownloadProgress:ne,onUploadProgress:ge,responseType:pe,headers:me,withCredentials:V="same-origin",fetchOptions:Ae}=aE(b),D=e||fetch;pe=pe?(pe+"").toLowerCase():"text";let ae=UL([q,O&&O.toAbortSignal()],J),Q=null;const te=ae&&ae.unsubscribe&&(()=>{ae.unsubscribe()});let ce;try{if(ge&&h&&R!=="get"&&R!=="head"&&(ce=await w(me,$))!==0){let _e=new t(S,{method:"POST",body:$,duplex:"half"}),We;if(j.isFormData($)&&(We=_e.headers.get("content-type"))&&me.setContentType(We),_e.body){const[F,Y]=Sm(ce,jo(Am(ge)));$=Cm(_e.body,vm,F,Y)}}j.isString(V)||(V=V?"include":"omit");const fe=i&&"credentials"in t.prototype,oe={...Ae,signal:ae,method:R.toUpperCase(),headers:me.normalize().toJSON(),body:$,duplex:"half",credentials:fe?V:void 0};Q=i&&new t(S,oe);let ye=await(i?D(Q,Ae):D(S,oe));const Ge=d&&(pe==="stream"||pe==="response");if(d&&(ne||Ge&&te)){const _e={};["status","statusText","headers"].forEach(Z=>{_e[Z]=ye[Z]});const We=j.toFiniteNumber(ye.headers.get("content-length")),[F,Y]=ne&&Sm(We,jo(Am(ne),!0))||[];ye=new n(Cm(ye.body,vm,F,()=>{Y&&Y(),te&&te()}),_e)}pe=pe||"text";let ze=await p[j.findKey(p,pe)||"text"](ye,b);return!Ge&&te&&te(),await new Promise((_e,We)=>{iE(_e,We,{data:ze,headers:dn.from(ye.headers),status:ye.status,statusText:ye.statusText,config:b,request:Q})})}catch(fe){throw te&&te(),fe&&fe.name==="TypeError"&&/Load failed|fetch/i.test(fe.message)?Object.assign(new $e("Network Error",$e.ERR_NETWORK,b,Q),{cause:fe.cause||fe}):$e.from(fe,fe&&fe.code,b,Q)}}},VL=new Map,oE=s=>{let e=s?s.env:{};const{fetch:t,Request:n,Response:r}=e,i=[n,r,t];let a=i.length,o=a,l,h,d=VL;for(;o--;)l=i[o],h=d.get(l),h===void 0&&d.set(l,h=o?new Map:QL(e)),d=h;return h};oE();const kl={http:cL,xhr:BL,fetch:{get:oE}};j.forEach(kl,(s,e)=>{if(s){try{Object.defineProperty(s,"name",{value:e})}catch{}Object.defineProperty(s,"adapterName",{value:e})}});const Mm=s=>`- ${s}`,HL=s=>j.isFunction(s)||s===null||s===!1,cE={getAdapter:(s,e)=>{s=j.isArray(s)?s:[s];const{length:t}=s;let n,r;const i={};for(let a=0;a<t;a++){n=s[a];let o;if(r=n,!HL(n)&&(r=kl[(o=String(n)).toLowerCase()],r===void 0))throw new $e(`Unknown adapter '${o}'`);if(r&&(j.isFunction(r)||(r=r.get(e))))break;i[o||"#"+a]=r}if(!r){const a=Object.entries(i).map(([l,h])=>`adapter ${l} `+(h===!1?"is not supported by the environment":"is not available in the build"));let o=t?a.length>1?`since :
`+a.map(Mm).join(`
`):" "+Mm(a[0]):"as no adapter specified";throw new $e("There is no suitable adapter to dispatch the request "+o,"ERR_NOT_SUPPORT")}return r},adapters:kl};function al(s){if(s.cancelToken&&s.cancelToken.throwIfRequested(),s.signal&&s.signal.aborted)throw new Ss(null,s)}function Pm(s){return al(s),s.headers=dn.from(s.headers),s.data=sl.call(s,s.transformRequest),["post","put","patch"].indexOf(s.method)!==-1&&s.headers.setContentType("application/x-www-form-urlencoded",!1),cE.getAdapter(s.adapter||da.adapter,s)(s).then(function(n){return al(s),n.data=sl.call(s,s.transformResponse,n),n.headers=dn.from(n.headers),n},function(n){return rE(n)||(al(s),n&&n.response&&(n.response.data=sl.call(s,s.transformResponse,n.response),n.response.headers=dn.from(n.response.headers))),Promise.reject(n)})}const uE="1.12.2",Tc={};["object","boolean","number","function","string","symbol"].forEach((s,e)=>{Tc[s]=function(n){return typeof n===s||"a"+(e<1?"n ":" ")+s}});const Om={};Tc.transitional=function(e,t,n){function r(i,a){return"[Axios v"+uE+"] Transitional option '"+i+"'"+a+(n?". "+n:"")}return(i,a,o)=>{if(e===!1)throw new $e(r(a," has been removed"+(t?" in "+t:"")),$e.ERR_DEPRECATED);return t&&!Om[a]&&(Om[a]=!0,console.warn(r(a," has been deprecated since v"+t+" and will be removed in the near future"))),e?e(i,a,o):!0}};Tc.spelling=function(e){return(t,n)=>(console.warn(`${n} is likely a misspelling of ${e}`),!0)};function YL(s,e,t){if(typeof s!="object")throw new $e("options must be an object",$e.ERR_BAD_OPTION_VALUE);const n=Object.keys(s);let r=n.length;for(;r-- >0;){const i=n[r],a=e[i];if(a){const o=s[i],l=o===void 0||a(o,i,s);if(l!==!0)throw new $e("option "+i+" must be "+l,$e.ERR_BAD_OPTION_VALUE);continue}if(t!==!0)throw new $e("Unknown option "+i,$e.ERR_BAD_OPTION)}}const _o={assertOptions:YL,validators:Tc},cr=_o.validators;let vi=class{constructor(e){this.defaults=e||{},this.interceptors={request:new bm,response:new bm}}async request(e,t){try{return await this._request(e,t)}catch(n){if(n instanceof Error){let r={};Error.captureStackTrace?Error.captureStackTrace(r):r=new Error;const i=r.stack?r.stack.replace(/^.+\n/,""):"";try{n.stack?i&&!String(n.stack).endsWith(i.replace(/^.+\n.+\n/,""))&&(n.stack+=`
`+i):n.stack=i}catch{}}throw n}}_request(e,t){typeof e=="string"?(t=t||{},t.url=e):t=e||{},t=_i(this.defaults,t);const{transitional:n,paramsSerializer:r,headers:i}=t;n!==void 0&&_o.assertOptions(n,{silentJSONParsing:cr.transitional(cr.boolean),forcedJSONParsing:cr.transitional(cr.boolean),clarifyTimeoutError:cr.transitional(cr.boolean)},!1),r!=null&&(j.isFunction(r)?t.paramsSerializer={serialize:r}:_o.assertOptions(r,{encode:cr.function,serialize:cr.function},!0)),t.allowAbsoluteUrls!==void 0||(this.defaults.allowAbsoluteUrls!==void 0?t.allowAbsoluteUrls=this.defaults.allowAbsoluteUrls:t.allowAbsoluteUrls=!0),_o.assertOptions(t,{baseUrl:cr.spelling("baseURL"),withXsrfToken:cr.spelling("withXSRFToken")},!0),t.method=(t.method||this.defaults.method||"get").toLowerCase();let a=i&&j.merge(i.common,i[t.method]);i&&j.forEach(["delete","get","head","post","put","patch","common"],b=>{delete i[b]}),t.headers=dn.concat(a,i);const o=[];let l=!0;this.interceptors.request.forEach(function(S){typeof S.runWhen=="function"&&S.runWhen(t)===!1||(l=l&&S.synchronous,o.unshift(S.fulfilled,S.rejected))});const h=[];this.interceptors.response.forEach(function(S){h.push(S.fulfilled,S.rejected)});let d,p=0,m;if(!l){const b=[Pm.bind(this),void 0];for(b.unshift(...o),b.push(...h),m=b.length,d=Promise.resolve(t);p<m;)d=d.then(b[p++],b[p++]);return d}m=o.length;let w=t;for(;p<m;){const b=o[p++],S=o[p++];try{w=b(w)}catch(R){S.call(this,R);break}}try{d=Pm.call(this,w)}catch(b){return Promise.reject(b)}for(p=0,m=h.length;p<m;)d=d.then(h[p++],h[p++]);return d}getUri(e){e=_i(this.defaults,e);const t=sE(e.baseURL,e.url,e.allowAbsoluteUrls);return eE(t,e.params,e.paramsSerializer)}};j.forEach(["delete","get","head","options"],function(e){vi.prototype[e]=function(t,n){return this.request(_i(n||{},{method:e,url:t,data:(n||{}).data}))}});j.forEach(["post","put","patch"],function(e){function t(n){return function(i,a,o){return this.request(_i(o||{},{method:e,headers:n?{"Content-Type":"multipart/form-data"}:{},url:i,data:a}))}}vi.prototype[e]=t(),vi.prototype[e+"Form"]=t(!0)});let GL=class lE{constructor(e){if(typeof e!="function")throw new TypeError("executor must be a function.");let t;this.promise=new Promise(function(i){t=i});const n=this;this.promise.then(r=>{if(!n._listeners)return;let i=n._listeners.length;for(;i-- >0;)n._listeners[i](r);n._listeners=null}),this.promise.then=r=>{let i;const a=new Promise(o=>{n.subscribe(o),i=o}).then(r);return a.cancel=function(){n.unsubscribe(i)},a},e(function(i,a,o){n.reason||(n.reason=new Ss(i,a,o),t(n.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(e){if(this.reason){e(this.reason);return}this._listeners?this._listeners.push(e):this._listeners=[e]}unsubscribe(e){if(!this._listeners)return;const t=this._listeners.indexOf(e);t!==-1&&this._listeners.splice(t,1)}toAbortSignal(){const e=new AbortController,t=n=>{e.abort(n)};return this.subscribe(t),e.signal.unsubscribe=()=>this.unsubscribe(t),e.signal}static source(){let e;return{token:new lE(function(r){e=r}),cancel:e}}};function zL(s){return function(t){return s.apply(null,t)}}function KL(s){return j.isObject(s)&&s.isAxiosError===!0}const jl={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries(jl).forEach(([s,e])=>{jl[e]=s});function hE(s){const e=new vi(s),t=jg(vi.prototype.request,e);return j.extend(t,vi.prototype,e,{allOwnKeys:!0}),j.extend(t,e,null,{allOwnKeys:!0}),t.create=function(r){return hE(_i(s,r))},t}const xt=hE(da);xt.Axios=vi;xt.CanceledError=Ss;xt.CancelToken=GL;xt.isCancel=rE;xt.VERSION=uE;xt.toFormData=bc;xt.AxiosError=$e;xt.Cancel=xt.CanceledError;xt.all=function(e){return Promise.all(e)};xt.spread=zL;xt.isAxiosError=KL;xt.mergeConfig=_i;xt.AxiosHeaders=dn;xt.formToJSON=s=>nE(j.isHTMLForm(s)?new FormData(s):s);xt.getAdapter=cE.getAdapter;xt.HttpStatusCode=jl;xt.default=xt;const{Axios:rq,AxiosError:iq,CanceledError:sq,isCancel:aq,CancelToken:oq,VERSION:cq,all:uq,Cancel:lq,isAxiosError:hq,spread:dq,toFormData:fq,AxiosHeaders:pq,HttpStatusCode:mq,formToJSON:yq,getAdapter:gq,mergeConfig:Eq}=xt;var Sc={},dE={},JL=Ko(),XL=ls,Wl=XL("Object.prototype.toString"),Ac=function(e){return JL&&e&&typeof e=="object"&&Symbol.toStringTag in e?!1:Wl(e)==="[object Arguments]"},fE=function(e){return Ac(e)?!0:e!==null&&typeof e=="object"&&"length"in e&&typeof e.length=="number"&&e.length>=0&&Wl(e)!=="[object Array]"&&"callee"in e&&Wl(e.callee)==="[object Function]"},ZL=function(){return Ac(arguments)}();Ac.isLegacyArguments=fE;var e1=ZL?Ac:fE,Dm=ls,t1=Ko(),n1=rv(),r1=Qo,Ql;if(t1){var i1=Dm("RegExp.prototype.exec"),Im={},ol=function(){throw Im},$m={toString:ol,valueOf:ol};typeof Symbol.toPrimitive=="symbol"&&($m[Symbol.toPrimitive]=ol),Ql=function(e){if(!e||typeof e!="object")return!1;var t=r1(e,"lastIndex"),n=t&&n1(t,"value");if(!n)return!1;try{i1(e,$m)}catch(r){return r===Im}}}else{var s1=Dm("Object.prototype.toString"),a1="[object RegExp]";Ql=function(e){return!e||typeof e!="object"&&typeof e!="function"?!1:s1(e)===a1}}var o1=Ql,c1=ls,u1=o1,l1=c1("RegExp.prototype.exec"),h1=Wo,d1=function(e){if(!u1(e))throw new h1("`regex` must be a RegExp");return function(n){return l1(e,n)!==null}},cl,Lm;function f1(){if(Lm)return cl;Lm=1;const s=(function*(){}).constructor;return cl=()=>s,cl}var pE=ls,p1=d1,m1=p1(/^\s*(?:function)?\*/),y1=Ko(),qm=Fm(),g1=pE("Object.prototype.toString"),E1=pE("Function.prototype.toString"),w1=f1(),b1=function(e){if(typeof e!="function")return!1;if(m1(E1(e)))return!0;if(!y1){var t=g1(e);return t==="[object GeneratorFunction]"}if(!qm)return!1;var n=w1();return n&&qm(e)===n.prototype};(function(s){var e=e1,t=b1,n=dy,r=fy;function i(X){return X.call.bind(X)}var a=typeof BigInt<"u",o=typeof Symbol<"u",l=i(Object.prototype.toString),h=i(Number.prototype.valueOf),d=i(String.prototype.valueOf),p=i(Boolean.prototype.valueOf);if(a)var m=i(BigInt.prototype.valueOf);if(o)var w=i(Symbol.prototype.valueOf);function b(X,ir){if(typeof X!="object")return!1;try{return ir(X),!0}catch{return!1}}s.isArgumentsObject=e,s.isGeneratorFunction=t,s.isTypedArray=r;function S(X){return typeof Promise<"u"&&X instanceof Promise||X!==null&&typeof X=="object"&&typeof X.then=="function"&&typeof X.catch=="function"}s.isPromise=S;function R(X){return typeof ArrayBuffer<"u"&&ArrayBuffer.isView?ArrayBuffer.isView(X):r(X)||F(X)}s.isArrayBufferView=R;function $(X){return n(X)==="Uint8Array"}s.isUint8Array=$;function q(X){return n(X)==="Uint8ClampedArray"}s.isUint8ClampedArray=q;function O(X){return n(X)==="Uint16Array"}s.isUint16Array=O;function J(X){return n(X)==="Uint32Array"}s.isUint32Array=J;function ne(X){return n(X)==="Int8Array"}s.isInt8Array=ne;function ge(X){return n(X)==="Int16Array"}s.isInt16Array=ge;function pe(X){return n(X)==="Int32Array"}s.isInt32Array=pe;function me(X){return n(X)==="Float32Array"}s.isFloat32Array=me;function V(X){return n(X)==="Float64Array"}s.isFloat64Array=V;function Ae(X){return n(X)==="BigInt64Array"}s.isBigInt64Array=Ae;function D(X){return n(X)==="BigUint64Array"}s.isBigUint64Array=D;function ae(X){return l(X)==="[object Map]"}ae.working=typeof Map<"u"&&ae(new Map);function Q(X){return typeof Map>"u"?!1:ae.working?ae(X):X instanceof Map}s.isMap=Q;function te(X){return l(X)==="[object Set]"}te.working=typeof Set<"u"&&te(new Set);function ce(X){return typeof Set>"u"?!1:te.working?te(X):X instanceof Set}s.isSet=ce;function fe(X){return l(X)==="[object WeakMap]"}fe.working=typeof WeakMap<"u"&&fe(new WeakMap);function oe(X){return typeof WeakMap>"u"?!1:fe.working?fe(X):X instanceof WeakMap}s.isWeakMap=oe;function ye(X){return l(X)==="[object WeakSet]"}ye.working=typeof WeakSet<"u"&&ye(new WeakSet);function Ge(X){return ye(X)}s.isWeakSet=Ge;function ze(X){return l(X)==="[object ArrayBuffer]"}ze.working=typeof ArrayBuffer<"u"&&ze(new ArrayBuffer);function _e(X){return typeof ArrayBuffer>"u"?!1:ze.working?ze(X):X instanceof ArrayBuffer}s.isArrayBuffer=_e;function We(X){return l(X)==="[object DataView]"}We.working=typeof ArrayBuffer<"u"&&typeof DataView<"u"&&We(new DataView(new ArrayBuffer(1),0,1));function F(X){return typeof DataView>"u"?!1:We.working?We(X):X instanceof DataView}s.isDataView=F;var Y=typeof SharedArrayBuffer<"u"?SharedArrayBuffer:void 0;function Z(X){return l(X)==="[object SharedArrayBuffer]"}function Ee(X){return typeof Y>"u"?!1:(typeof Z.working>"u"&&(Z.working=Z(new Y)),Z.working?Z(X):X instanceof Y)}s.isSharedArrayBuffer=Ee;function Oe(X){return l(X)==="[object AsyncFunction]"}s.isAsyncFunction=Oe;function Me(X){return l(X)==="[object Map Iterator]"}s.isMapIterator=Me;function xe(X){return l(X)==="[object Set Iterator]"}s.isSetIterator=xe;function ke(X){return l(X)==="[object Generator]"}s.isGeneratorObject=ke;function Ke(X){return l(X)==="[object WebAssembly.Module]"}s.isWebAssemblyCompiledModule=Ke;function wt(X){return b(X,h)}s.isNumberObject=wt;function Bt(X){return b(X,d)}s.isStringObject=Bt;function Tt(X){return b(X,p)}s.isBooleanObject=Tt;function nn(X){return a&&b(X,m)}s.isBigIntObject=nn;function Wr(X){return o&&b(X,w)}s.isSymbolObject=Wr;function Jt(X){return wt(X)||Bt(X)||Tt(X)||nn(X)||Wr(X)}s.isBoxedPrimitive=Jt;function Oi(X){return typeof Uint8Array<"u"&&(_e(X)||Ee(X))}s.isAnyArrayBuffer=Oi,["isProxy","isExternal","isModuleNamespaceObject"].forEach(function(X){Object.defineProperty(s,X,{enumerable:!1,value:function(){throw new Error(X+" is not supported in userland")}})})})(dE);var T1=function(e){return e&&typeof e=="object"&&typeof e.copy=="function"&&typeof e.fill=="function"&&typeof e.readUInt8=="function"};(function(s){var e={},t=Object.getOwnPropertyDescriptors||function(Y){for(var Z=Object.keys(Y),Ee={},Oe=0;Oe<Z.length;Oe++)Ee[Z[Oe]]=Object.getOwnPropertyDescriptor(Y,Z[Oe]);return Ee},n=/%[sdj%]/g;s.format=function(F){if(!ge(F)){for(var Y=[],Z=0;Z<arguments.length;Z++)Y.push(o(arguments[Z]));return Y.join(" ")}for(var Z=1,Ee=arguments,Oe=Ee.length,Me=String(F).replace(n,function(ke){if(ke==="%%")return"%";if(Z>=Oe)return ke;switch(ke){case"%s":return String(Ee[Z++]);case"%d":return Number(Ee[Z++]);case"%j":try{return JSON.stringify(Ee[Z++])}catch{return"[Circular]"}default:return ke}}),xe=Ee[Z];Z<Oe;xe=Ee[++Z])O(xe)||!Ae(xe)?Me+=" "+xe:Me+=" "+o(xe);return Me},s.deprecate=function(F,Y){if(typeof process<"u"&&process.noDeprecation===!0)return F;if(typeof process>"u")return function(){return s.deprecate(F,Y).apply(this,arguments)};var Z=!1;function Ee(){if(!Z){if(process.throwDeprecation)throw new Error(Y);process.traceDeprecation?console.trace(Y):console.error(Y),Z=!0}return F.apply(this,arguments)}return Ee};var r={},i=/^$/;if(e.NODE_DEBUG){var a=e.NODE_DEBUG;a=a.replace(/[|\\{}()[\]^$+?.]/g,"\\$&").replace(/\*/g,".*").replace(/,/g,"$|^").toUpperCase(),i=new RegExp("^"+a+"$","i")}s.debuglog=function(F){if(F=F.toUpperCase(),!r[F])if(i.test(F)){var Y=process.pid;r[F]=function(){var Z=s.format.apply(s,arguments);console.error("%s %d: %s",F,Y,Z)}}else r[F]=function(){};return r[F]};function o(F,Y){var Z={seen:[],stylize:h};return arguments.length>=3&&(Z.depth=arguments[2]),arguments.length>=4&&(Z.colors=arguments[3]),q(Y)?Z.showHidden=Y:Y&&s._extend(Z,Y),me(Z.showHidden)&&(Z.showHidden=!1),me(Z.depth)&&(Z.depth=2),me(Z.colors)&&(Z.colors=!1),me(Z.customInspect)&&(Z.customInspect=!0),Z.colors&&(Z.stylize=l),p(Z,F,Z.depth)}s.inspect=o,o.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},o.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"};function l(F,Y){var Z=o.styles[Y];return Z?"\x1B["+o.colors[Z][0]+"m"+F+"\x1B["+o.colors[Z][1]+"m":F}function h(F,Y){return F}function d(F){var Y={};return F.forEach(function(Z,Ee){Y[Z]=!0}),Y}function p(F,Y,Z){if(F.customInspect&&Y&&Q(Y.inspect)&&Y.inspect!==s.inspect&&!(Y.constructor&&Y.constructor.prototype===Y)){var Ee=Y.inspect(Z,F);return ge(Ee)||(Ee=p(F,Ee,Z)),Ee}var Oe=m(F,Y);if(Oe)return Oe;var Me=Object.keys(Y),xe=d(Me);if(F.showHidden&&(Me=Object.getOwnPropertyNames(Y)),ae(Y)&&(Me.indexOf("message")>=0||Me.indexOf("description")>=0))return w(Y);if(Me.length===0){if(Q(Y)){var ke=Y.name?": "+Y.name:"";return F.stylize("[Function"+ke+"]","special")}if(V(Y))return F.stylize(RegExp.prototype.toString.call(Y),"regexp");if(D(Y))return F.stylize(Date.prototype.toString.call(Y),"date");if(ae(Y))return w(Y)}var Ke="",wt=!1,Bt=["{","}"];if($(Y)&&(wt=!0,Bt=["[","]"]),Q(Y)){var Tt=Y.name?": "+Y.name:"";Ke=" [Function"+Tt+"]"}if(V(Y)&&(Ke=" "+RegExp.prototype.toString.call(Y)),D(Y)&&(Ke=" "+Date.prototype.toUTCString.call(Y)),ae(Y)&&(Ke=" "+w(Y)),Me.length===0&&(!wt||Y.length==0))return Bt[0]+Ke+Bt[1];if(Z<0)return V(Y)?F.stylize(RegExp.prototype.toString.call(Y),"regexp"):F.stylize("[Object]","special");F.seen.push(Y);var nn;return wt?nn=b(F,Y,Z,xe,Me):nn=Me.map(function(Wr){return S(F,Y,Z,xe,Wr,wt)}),F.seen.pop(),R(nn,Ke,Bt)}function m(F,Y){if(me(Y))return F.stylize("undefined","undefined");if(ge(Y)){var Z="'"+JSON.stringify(Y).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return F.stylize(Z,"string")}if(ne(Y))return F.stylize(""+Y,"number");if(q(Y))return F.stylize(""+Y,"boolean");if(O(Y))return F.stylize("null","null")}function w(F){return"["+Error.prototype.toString.call(F)+"]"}function b(F,Y,Z,Ee,Oe){for(var Me=[],xe=0,ke=Y.length;xe<ke;++xe)Ge(Y,String(xe))?Me.push(S(F,Y,Z,Ee,String(xe),!0)):Me.push("");return Oe.forEach(function(Ke){Ke.match(/^\d+$/)||Me.push(S(F,Y,Z,Ee,Ke,!0))}),Me}function S(F,Y,Z,Ee,Oe,Me){var xe,ke,Ke;if(Ke=Object.getOwnPropertyDescriptor(Y,Oe)||{value:Y[Oe]},Ke.get?Ke.set?ke=F.stylize("[Getter/Setter]","special"):ke=F.stylize("[Getter]","special"):Ke.set&&(ke=F.stylize("[Setter]","special")),Ge(Ee,Oe)||(xe="["+Oe+"]"),ke||(F.seen.indexOf(Ke.value)<0?(O(Z)?ke=p(F,Ke.value,null):ke=p(F,Ke.value,Z-1),ke.indexOf(`
`)>-1&&(Me?ke=ke.split(`
`).map(function(wt){return"  "+wt}).join(`
`).slice(2):ke=`
`+ke.split(`
`).map(function(wt){return"   "+wt}).join(`
`))):ke=F.stylize("[Circular]","special")),me(xe)){if(Me&&Oe.match(/^\d+$/))return ke;xe=JSON.stringify(""+Oe),xe.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(xe=xe.slice(1,-1),xe=F.stylize(xe,"name")):(xe=xe.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),xe=F.stylize(xe,"string"))}return xe+": "+ke}function R(F,Y,Z){var Ee=F.reduce(function(Oe,Me){return Me.indexOf(`
`)>=0,Oe+Me.replace(/\u001b\[\d\d?m/g,"").length+1},0);return Ee>60?Z[0]+(Y===""?"":Y+`
 `)+" "+F.join(`,
  `)+" "+Z[1]:Z[0]+Y+" "+F.join(", ")+" "+Z[1]}s.types=dE;function $(F){return Array.isArray(F)}s.isArray=$;function q(F){return typeof F=="boolean"}s.isBoolean=q;function O(F){return F===null}s.isNull=O;function J(F){return F==null}s.isNullOrUndefined=J;function ne(F){return typeof F=="number"}s.isNumber=ne;function ge(F){return typeof F=="string"}s.isString=ge;function pe(F){return typeof F=="symbol"}s.isSymbol=pe;function me(F){return F===void 0}s.isUndefined=me;function V(F){return Ae(F)&&ce(F)==="[object RegExp]"}s.isRegExp=V,s.types.isRegExp=V;function Ae(F){return typeof F=="object"&&F!==null}s.isObject=Ae;function D(F){return Ae(F)&&ce(F)==="[object Date]"}s.isDate=D,s.types.isDate=D;function ae(F){return Ae(F)&&(ce(F)==="[object Error]"||F instanceof Error)}s.isError=ae,s.types.isNativeError=ae;function Q(F){return typeof F=="function"}s.isFunction=Q;function te(F){return F===null||typeof F=="boolean"||typeof F=="number"||typeof F=="string"||typeof F=="symbol"||typeof F>"u"}s.isPrimitive=te,s.isBuffer=T1;function ce(F){return Object.prototype.toString.call(F)}function fe(F){return F<10?"0"+F.toString(10):F.toString(10)}var oe=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function ye(){var F=new Date,Y=[fe(F.getHours()),fe(F.getMinutes()),fe(F.getSeconds())].join(":");return[F.getDate(),oe[F.getMonth()],Y].join(" ")}s.log=function(){console.log("%s - %s",ye(),s.format.apply(s,arguments))},s.inherits=xi,s._extend=function(F,Y){if(!Y||!Ae(Y))return F;for(var Z=Object.keys(Y),Ee=Z.length;Ee--;)F[Z[Ee]]=Y[Z[Ee]];return F};function Ge(F,Y){return Object.prototype.hasOwnProperty.call(F,Y)}var ze=typeof Symbol<"u"?Symbol("util.promisify.custom"):void 0;s.promisify=function(Y){if(typeof Y!="function")throw new TypeError('The "original" argument must be of type Function');if(ze&&Y[ze]){var Z=Y[ze];if(typeof Z!="function")throw new TypeError('The "util.promisify.custom" argument must be of type Function');return Object.defineProperty(Z,ze,{value:Z,enumerable:!1,writable:!1,configurable:!0}),Z}function Z(){for(var Ee,Oe,Me=new Promise(function(Ke,wt){Ee=Ke,Oe=wt}),xe=[],ke=0;ke<arguments.length;ke++)xe.push(arguments[ke]);xe.push(function(Ke,wt){Ke?Oe(Ke):Ee(wt)});try{Y.apply(this,xe)}catch(Ke){Oe(Ke)}return Me}return Object.setPrototypeOf(Z,Object.getPrototypeOf(Y)),ze&&Object.defineProperty(Z,ze,{value:Z,enumerable:!1,writable:!1,configurable:!0}),Object.defineProperties(Z,t(Y))},s.promisify.custom=ze;function _e(F,Y){if(!F){var Z=new Error("Promise was rejected with a falsy value");Z.reason=F,F=Z}return Y(F)}function We(F){if(typeof F!="function")throw new TypeError('The "original" argument must be of type Function');function Y(){for(var Z=[],Ee=0;Ee<arguments.length;Ee++)Z.push(arguments[Ee]);var Oe=Z.pop();if(typeof Oe!="function")throw new TypeError("The last argument must be of type Function");var Me=this,xe=function(){return Oe.apply(Me,arguments)};F.apply(this,Z).then(function(ke){process.nextTick(xe.bind(null,null,ke))},function(ke){process.nextTick(_e.bind(null,ke,xe))})}return Object.setPrototypeOf(Y,Object.getPrototypeOf(F)),Object.defineProperties(Y,t(F)),Y}s.callbackify=We})(Sc);const S1=Um(Sc),A1=sv({__proto__:null,default:S1},[Sc]);class N1{constructor(e=ri){this.cfg=e,this.instances=new Map}get env(){return this.cfg.env||{app:"cd-shell",debug:!1}}log(...e){this.env.debug&&console.log("[HttpService]",...e)}async ensureInstance(e,t){var a,o,l,h;const n=e||"cdApiLocal";if(this.instances.has(n))return;const r=t||((a=this.cfg.cdApi)==null?void 0:a.endpoint)||((l=(o=this.cfg.profiles)==null?void 0:o[n])==null?void 0:l.endpoint);if(!r)throw new Error(`No endpoint found for profile '${n}'.`);const i=xt.create({baseURL:r,timeout:((h=this.cfg.cdApi)==null?void 0:h.timeout)||15e3,headers:{"Content-Type":"application/json"}});this.instances.set(n,i),this.cdApiAxiosConfig={method:"POST",url:r,data:null},this.log(`Initialized Axios instance [${n}] → ${r}`)}async request(e,t="cdApiLocal"){var r,i,a,o;const n=this.instances.get(t);if(!n)return{state:!1,data:null,message:`Instance ${t} missing.`};try{return this.log("Request Config:",e),{state:!0,data:(await n.request(e)).data,message:"Request succeeded"}}catch(l){const h=((o=(a=(i=(r=l.response)==null?void 0:r.data)==null?void 0:i.app_state)==null?void 0:a.info)==null?void 0:o.app_msg)||l.message||"Unknown error";return this.log("Request Error:",h),{state:!1,data:null,message:`HTTP Error: ${Sc.inspect(h,{depth:3})}`}}}async proc(e,t){var o,l,h;const n=this.env.app,r=t||"cdApiLocal",i=n==="cd-cli"?(l=(o=this.cfg.profiles)==null?void 0:o[r])==null?void 0:l.endpoint:(h=this.cfg.cdApi)==null?void 0:h.endpoint;await this.ensureInstance(r,i);const a={...this.cdApiAxiosConfig||{},data:e};return this.request(a,r)}}class C1{constructor(){this.listeners=[]}on(e){return this.listeners.push(e),()=>this.off(e)}off(e){this.listeners=this.listeners.filter(t=>t!==e)}async emit(e){for(const t of this.listeners)try{await t(e)}catch(n){console.error("[FxEventEmitter] Handler error:",n)}}clear(){this.listeners=[]}hasListeners(){return this.listeners.length>0}}var v1={};const Ih=ci()==="node"||ci()==="cli";let Vl=()=>{throw new Error("Redis not available in browser environment")};Ih&&Br(()=>import("./index-MsEZ4Scr.js").then(s=>s.i),__vite__mapDeps([5,1,2,6,3])).then(s=>{Vl=s.createClient}).catch(()=>{console.warn("Redis module not available")});let mE=s=>JSON.stringify(s,null,2);Ih&&Br(()=>Promise.resolve().then(()=>A1),void 0).then(s=>{mE=s.inspect}).catch(()=>{});let Hs={blue:s=>s,green:s=>s,red:s=>s,yellow:s=>s};Ih&&Br(()=>import("./index-JiKw9JSs.js"),[]).then(s=>{Hs=s.default||s}).catch(()=>{console.warn("Chalk not available, using no-color fallback")});const R1="invalid request";class yE extends s0{constructor(){super(),this.err=[],this.cuid=1e3,this.cdToken="",this.i={messages:[],code:"",app_msg:""},this.isRegRequest=!1,this.fx=new C1,this.ds=null,this.isInvalidFields=[],this.http=new N1,this.intersectionLegacy=(e,t)=>{const n=[];for(const r of e)t.includes(r)&&n.push(r);return n},this.intersectMany=(...e)=>{let t=e[0].slice();for(let n=1;n<e.length;n++)t=this.intersectionLegacy(t,e[n]);return t},this.entityAdapter=new My,this.cdResp=this.initCdResp()}async init(e,t){console.log("BaseService::init()/01:")}async setRepo(e){this.repo=this.ds.getRepository(e.serviceModel)}async initSqlite(e,t){try{console.log("BaseService::initSqlite()/01"),this.sqliteConn?console.log("BaseService::initSqlite()/02"):(console.log("BaseService::initSqlite()/03"),this.sqliteConn=await this.db)}catch(n){console.log("BaseService::initSqlite()/04"),this.err.push(n.toString())}}get svSess(){if(!this._svSess){const{SessionService:e}=require("../cd-user/services/session.service");this._svSess=new e}return this._svSess}initCdResp(){return{app_state:{success:!1,info:{messages:[],code:"",app_msg:""},sess:{cd_token:this.getGuid(),jwt:null,ttl:0},cache:{},sConfig:{usePush:ri.usePolling,usePolling:ri.usePush,useCacheStore:ri.useCacheStore}},data:null}}async resolveCls(e,t,n){try{console.log("BaseService::resolveCls()/01:"),console.log("BaseService::resolveCls/clsCtx.path:",n.path);const r=await import(n.path);console.log("BaseService::resolveCls()/02:");const i=r[n.clsName];console.log("BaseService::resolveCls()/03:");const a=new i;this.ds=n.dataSource,console.log("BaseService::resolveCls()/04:"),this.sess&&(e.post.sessData=this.sess),await a[n.action](e,t)}catch(r){this.serviceErr(e,t,r,"BaseService:resolveCls")}}async invokeCdRequest(e){if(console.log("BaseService::invokeCdRequest() → Starting dispatch..."),!e)return{state:!1,message:"cdRequest is undefined or null."};const{ctx:t,m:n,c:r,a:i,args:a,dat:o}=e;try{const l=t.toLowerCase()==="sys"?"sys":"app",h=`${r}Controller`,d=S$(r),p=`../../${l}/${n}/controllers/${d}.controller.js`;console.log(`BaseService::invokeCdRequest() → Importing: ${p}`);const m=await import(p),w=m==null?void 0:m[h];if(!w)return{state:!1,message:`Controller not found: ${h} at ${p}`};const b=new w;if(typeof b[i]!="function")return{state:!1,message:`Action method not found: ${i}`};const S=await b[i](...a?Object.values(a):[],o);return S!=null&&S.state||console.error(`BaseService::invokeCdRequest() → Task failed: ${S.message}`),S}catch(l){const h=`Error executing cdRequest: ${l.message}`;return console.error(`BaseService::invokeCdRequest() → ${h}`),{state:!1,message:h}}}async create(e,t,n){try{if(!n.serviceModel||!n.data||!this.db)return{data:null,state:!1,message:"Invalid input"};let r;try{r=await this.saveDoc(e,t,n)}catch(l){this.serviceErr(e,t,l,"BaseService:create/savDoc")}e?await this.setPlData(e,{key:"docId",value:r.docId}):n.data.docId=r.docId;const i=this.db.getRepository(n.serviceModel),a=i.create(n.data),o=await i.save(a);return e?o:{data:o,state:!0,message:"Created successfully"}}catch(r){return this.err.push(r.toString()),this.err,await this.serviceErr(e,t,r,"BaseService:create"),e?this.cdResp:{state:!1,data:null,message:r.toString()}}}async createI(e,t,n){if(!n||!n.controllerData)return{data:null,state:!1,message:"Invalid input"};const r=n.serviceInput;let i;try{i=await this.saveDoc(e,t,r)}catch(a){this.serviceErr(e,t,a,"BaseService:createI/savDoc")}n.controllerData.docId=i.docId;try{const a=this.db.getRepository(n.serviceInput.serviceModel),o=a.create(r.data),l=await a.save(o);return e?l:{data:l,state:!0,message:"Created successfully"}}catch(a){return this.err.push(a.toString()),this.err,await this.serviceErr(e,t,a,"BaseService:createI"),e?this.cdResp:{state:!1,data:null,message:a.toString()}}}async createSL(e,t,n){try{const r=await this.sqliteConn.getRepository(n.serviceModel),i=this.getPlData(e);return await r.save(i)}catch(r){return this.err.push(r.toString()),this.err,await this.serviceErr(e,t,r,"BillService:create"),this.cdResp}}connSLClose(){this.sqliteConn&&this.sqliteConn.close()}async saveDoc(e,t,n){const r=await this.setDoc(e,t,n);return await this.db.getRepository(tn).save(r)}async setDoc(e,t,n){this.cdToken||await this.setSess(e,t);const r=new tn,{DocService:i}=await Br(async()=>{const{DocService:o}=await import("./doc.service-IrVtuMVH.js");return{DocService:o}},__vite__mapDeps([7,1,2,8,4,3])),a=new i;return r.docFrom=this.cuid,r.docName=n.docName,r.docTypeId=await a.getDocTypeId(e,t,r),r.docDate=await this.mysqlNow(),await r}async read(e,t,n){var r;try{if(!n.serviceModel||!((r=n.cmd)!=null&&r.query)||!this.db)return{data:null,state:!1,message:"Invalid query"};const a=await this.db.getRepository(n.serviceModel).find(n.cmd.query);return e?a:{data:a,state:!0,message:"Read successfully"}}catch(i){return await this.serviceErr(e,t,i,"BaseService:read"),e?this.cdResp:{state:!1,data:null,message:i.toString()}}}read$(e,t,n){return Pr(this.read(e,t,n))}async readCount(e,t,n){var r;try{if(!n.serviceModel||!((r=n.cmd)!=null&&r.query)||!this.db)return{data:null,state:!1,message:"Invalid query"};const i=this.db.getRepository(n.serviceModel);let a;e?a=this.getQuery(e):a=n.cmd.query,console.log("BaseService::readCount()/q:",a);const[o,l]=await i.findAndCount(a);return{items:o,count:l}}catch(i){return await this.serviceErr(e,t,i,"BaseService:readCount")}}async feildMapSL(e,t,n){return await this.initSqlite(e,t),console.log("BaseService::feildMapSL()/serviceInput:",n.serviceModel),await(await this.ds.getMetadata(n.serviceModel).columns).map(async i=>({propertyPath:await i.propertyPath,givenDatabaseName:await i.givenDatabaseName,dType:await i.type}))}async readSL(e,t,n){var r;try{this.initSqlite(e,t),await this.setRepo(n);const i=this.repo;let a=null;switch((r=n.cmd)==null?void 0:r.action){case"find":try{return a=await i.find(n.cmd.query),n.extraInfo?{result:a,fieldMap:await this.feildMapSL(e,t,n)}:await a}catch(o){return await this.serviceErr(e,t,o,"BillService:read")}break;case"count":try{return a=await i.count(n.cmd.query),console.log("BillService::read()/r:",a),a}catch(o){return await this.serviceErr(e,t,o,"BillService:read")}break}}catch(i){return await this.serviceErr(e,t,i,"BillService:read")}}readCount$(e,t,n){return console.log("BaseService::readCount$()/serviceInput:",n),Pr(this.readCount(e,t,n))}async readCountSL(e,t,n){await this.initSqlite(e,t);try{await this.setRepo(n);const r=this.repo,i=await this.getEntityPropertyMapSL(e,t,n.serviceModel),[a,o]=await r.findAndCount(this.getQuery(e));return{metaData:i,items:a,count:o}}catch(r){return await this.serviceErr(e,t,r,"BaseService:readCount")}}async getEntityPropertyMapSL(e,t,n){await this.initSqlite(e,t);const i=await(await this.ds.getMetadata(n)).columns,a=[];return await i.map(async o=>{const l={propertyAliasName:await o.propertyAliasName,databaseNameWithoutPrefixes:await o.databaseNameWithoutPrefixes,type:await o.type};return a.push(l),l}),a}readCountSL$(e,t,n){return Pr(this.readCountSL(e,t,n))}readSL$(e,t,n){return Pr(this.readSL(e,t,n))}async readQB(e,t,n){var a;if(!n.serviceModel||!((a=n.cmd)!=null&&a.query)||!this.db)return{data:null,state:!1,message:"Invalid query"};const r=this.db.getRepository(n.serviceModel),i=new mm(r);try{const o=i.createQueryBuilder(n);console.log("BaseService::readQB/sql:",o.getSql());let l=await o.getRawMany();console.log("BaseService::readQB()/items:",l);const h=this.entityAdapter.getEntityName(n.serviceModel);l=this.entityAdapter.mapRawToEntity(h,l),console.log("BaseService::readQB()/Fetched-Items:",l);const d=await o.getCount();return console.log("Fetched Count:",d),{items:l,count:d}}catch(o){return console.error("Error in readQB:",o),await this.serviceErr(e,t,o,"BaseService:readQB")}}readQB$(e,t,n){return console.log("BaseService::readQB$()/serviceInput:",n),Pr(this.readQB(e,t,n))}async readJSONColumnQB(e,t,n,r,i){var h;if(!n.serviceModel||!((h=n.cmd)!=null&&h.query)||!this.db)return{data:null,state:!1,message:"Invalid query"};const a=this.db.getRepository(n.serviceModel),l=new mm(a).createQueryBuilder(n);i.forEach(d=>{l.addSelect(`JSON_UNQUOTE(JSON_EXTRACT(${r}, '$.${d}'))`,d)});try{const d=await l.getRawMany(),p=this.entityAdapter.getEntityName(n.serviceModel);return{items:this.entityAdapter.mapRawToEntity(p,d),count:await l.getCount()}}catch(d){return await this.serviceErr(e,t,d,"BaseService:readJSONColumnQB")}}transformFilters(e){const t={};return e.forEach(n=>{const{field:r,operator:i,val:a,dataType:o}=n;let l=a;switch(o==="number"?l=Number(a):o==="boolean"&&(l=a==="true"),i){case"=":t[r]=l;break;case"LIKE":t[r]={like:`%${l}%`};break;case">":t[r]={gt:l};break;case"<":t[r]={lt:l};break;case"IN":t[r]={in:a.split(",")};break;default:throw new Error(`Unsupported operator: ${i}`)}}),t}async update(e,t,n){var r;try{if(!n.serviceModel||!((r=n.cmd)!=null&&r.query)||!this.db||!n.cmd.query.update)return{data:null,state:!1,message:"Invalid update request"};const i=this.db.getRepository(n.serviceModel),a=n.cmd.query.update,o=await i.update(n.cmd.query.where,a);return e?o:{data:o,state:!0,message:"Updated successfully"}}catch(i){return await this.serviceErr(e,t,i,"BaseService:update"),e?this.cdResp:{state:!1,data:null,message:i.toString()}}}update$(e,t,n){return Pr(this.update(e,t,n))}async updateI(e,t,n){try{if(!n||!n.controllerData)return{data:null,state:!1,message:"Invalid input"};const r=n.serviceInput,i=this.db.getRepository(r.serviceModel),a=r.cmd.query.update,o=await i.update(r.cmd.query.where,a);return e?o:{data:o,state:!0,message:"Updated successfully"}}catch(r){return await this.serviceErr(e,t,r,"BaseService:updateI"),e?this.cdResp:{state:!1,data:null,message:r.toString()}}}async updateSL(e,t,n){var o,l;console.log("BillService::updateSL()/01"),await this.initSqlite(e,t);const r=this.svSess;await this.setRepo(n);const a=await this.repo.update((o=n.cmd)==null?void 0:o.query.where,await this.fieldsAdaptorSL(e,t,(l=n.cmd)==null?void 0:l.query.update,n));console.log("result:",a),r.sessResp.ttl=r.getTtl(),this.setAppState(!0,this.i,r.sessResp),this.cdResp.data=a,this.respond(e,t)}updateSL$(e,t,n){return Pr(this.updateSL(e,t,n))}async fieldsAdaptorSL(e,t,n,r){const i=await this.feildMapSL(e,t,r);for(const a in n)if(a){const o=i.filter(l=>l.propertyPath===a);o[0]&&this.fieldIsBoolean(o[0].dType)&&(this.isTrueish(n[a])?n[a]=!0:n[a]=!1)}return n}fieldIsBoolean(e){return e.toString()==="function Boolean() { [native code] }"}isTrueish(e){let t=!1;switch(e){case!0:t=!0;break;case"true":t=!0;break;case 1:t=!0;break;case"1":t=!0;break}return t}async delete(e,t,n){var r;try{if(!n.serviceModel||!((r=n.cmd)!=null&&r.query)||!this.db)return{data:null,state:!1,message:"Invalid delete request"};const a=await this.db.getRepository(n.serviceModel).delete(n.cmd.query.where);return e?a:{data:a,state:!0,message:"Updated successfully"}}catch(i){return await this.serviceErr(e,t,i,"BaseService:delete"),e?this.cdResp:{state:!1,data:null,message:i.toString()}}}delete$(e,t,n){return Pr(this.delete(e,t,n))}async deleteSL(e,t,n){var o;console.log("BillService::updateSL()/01");let r=[];const a=await(await this.sqliteConn.getRepository(n.serviceModel)).delete((o=n.cmd)==null?void 0:o.query.where);return console.log("BaseService::deleteSL()/result:",a),"affected"in a?(this.cdResp.app_state.success=!0,this.cdResp.app_state.info&&(this.cdResp.app_state.info.app_msg=`${a.affected} record/s deleted`),r=a):(this.cdResp.app_state.success=!1,this.cdResp.app_state.info&&(this.cdResp.app_state.info.app_msg="some error occorred")),r}deleteSL$(e,t,n){return Pr(this.deleteSL(e,t,n))}isEmptyObject(e){return Object.keys(e).length===0}async bFetch(e,t,n){try{if(console.log("BaseService::fetch()/01"),!n.fetchInput)throw new Error("fetchInput is undefined");const i=await(await fetch(n.fetchInput.url,n.fetchInput.optins)).text();let a;try{a=JSON.parse(i)}catch{a=i}return a}catch(r){this.err.push(r.toString());const i={messages:this.err,code:"BaseService:update"};return await this.serviceErr(e,t,r,i.code),this.cdResp}}async serviceErr(e,t,n,r,i=null){const a=this.svSess;try{a.sessResp.cd_token=e.post.dat.token}catch(l){a.sessResp.cd_token="",this.err.push(l.toString())}a.sessResp.ttl=a.getTtl(),this.setAppState(!0,this.i,a.sessResp),this.err.push(n.toString());const o={messages:await this.err,code:r,app_msg:`Error at ${r}: ${n.toString()}`};return await this.setAppState(!1,o,a.sessResp),this.cdResp.data=[],await this.respond(e,t)}async returnErr(e,t,n){const r=this.getSess(e,t);return await this.setAppState(!1,n,r),await this.respond(e,t)}entryPath(e){console.log("BaseService::entryPath/pl:",e);const t=`../../${e.ctx.toLowerCase()}/${this.toCdName(e.m)}/controllers/${this.toCdName(e.c)}.controller`;return console.log("BaseService::entryPath()/ret:",t),t}toCdName(e){console.log("BaseService::entryPath/camel:",e);const t=e.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return console.log("BaseService::toCdName()/ret:",t),t}async valid(e,t){const n=e.post;return this.pl=n,await this.noToken(e,t)?!0:(this.cdToken||await this.setSess(e,t),!(!this.instanceOfCdResponse(n)||!this.validFields(e,t)))}async noToken(e,t){const n=e.post,r=n.ctx,i=n.m,a=n.c,o=n.a;let l=!1;return(!r||!i||!a||!o)&&this.setInvalidRequest(e,t,"BaseService:noTocken:01"),i==="User"&&(o==="Login"||o==="Register")&&(i==="User"&&o==="Register"&&(this.isRegRequest=!0),l=!0),i==="Moduleman"&&a==="Consumer"&&o==="GetAll"&&(l=!0),i==="Moduleman"&&a==="Modules"&&o==="GetAll"&&(l=!0),i==="CdPush"&&a==="Websocket"&&o==="Create"&&(l=!0),"MSISDN"in n&&(l=!0),l}isRegisterRequest(){return this.isRegRequest}validFields(e,t){return!0}async validateUnique(e,t,n){var h;if(console.log("BaseService::validateUnique()/01"),console.log("BaseService::validateUnique()/req.post:",{reqPost:JSON.stringify(e.post)}),!n.serviceModel||!((h=n.cmd)!=null&&h.query)||!this.db)return{data:null,state:!1,message:"Invalid query"};const r=this.db.getRepository(n.serviceModel);await this.getEntityPropertyMap(e,t,n).then(d=>d);const i=await this.getQueryItems(e,n);console.log("BaseService::validateUnique()/strQueryItems:",i);const a=await i;console.log("BaseService::validateUnique()/filterItems:",a);const o=await r.count({where:await a});console.log("BaseService::validateUnique()/results:",{result:o});let l=!1;if(o===0)l=!0;else{this.err.push("duplicate not allowed");const d={messages:this.err,code:"BaseService:validateUnique",app_msg:""};await this.setAppState(!1,d,null)}return console.log("BaseService::validateUnique()/ret:",{return:l}),l}async validateUniqueI(e,t,n){console.log("BaseService::validateUniqueI()/01"),console.log("BaseService::validateUniqueI()/req.post:",e.post),console.log("BaseService::validateUniqueI()/req.post.dat.f_vals[0]:",e.post.dat.f_vals[0]),console.log("BaseService::validateUniqueI()/params:",n),await this.init(e,t);const r=this.db.getRepository(n.serviceInput.serviceModel);console.log("BaseService::validateUniqueI()/repo/model:",{model:n.serviceInput.serviceModel}),console.log("BaseService::validateUniqueI()/params.serviceInput:",n.serviceInput);const i=await this.duplicateFilter(n.controllerData,n.serviceInput.serviceInstance.cRules.noDuplicate);console.log("BaseService::validateUniqueI()/filterItems:",i);const a=await r.count({where:await i});console.log("BaseService::validateUniqueI()/results:",a);let o=!1;if(a===0)o=!0;else{this.err.push("duplicate not allowed");const l={messages:this.err,code:"BaseService:validateUniqueI",app_msg:""};await this.setAppState(!1,l,null)}return console.log("BaseService::validateUniqueI()/ret:",{return:o}),o}async duplicateFilter(e,t){console.log("BaseService::duplicateFilter()/controllerData:",e),console.log("BaseService::duplicateFilter()/noDuplicate:",t);const n={};for(const r of t)Object.prototype.hasOwnProperty.call(e,r)&&(n[r]=e[r]);return n}async validateRequired(e,t,n){const r=this.svSess,i=n.required;return this.isInvalidFields=await i.filter(a=>{if(!(a in this.getPlData(e)))return a}),this.isInvalidFields.length>0?(this.i.app_msg=`the required fields ${this.isInvalidFields.join(", ")} is missing`,this.i.messages.push(this.i.app_msg),this.setAppState(!1,this.i,r.sessResp),!1):!0}async getEntityPropertyMap(e,t,n){var o;const r=(o=this.db)==null?void 0:o.getMetadata(n.serviceModel);return r?await(await r.columns).map(async l=>await{propertyAliasName:l.propertyAliasName,databaseNameWithoutPrefixes:l.databaseNameWithoutPrefixes,type:l.type}):void 0}async getQueryItems(e,t,n){console.log("BaseService::getQueryItems()/params:",t),console.log("BaseService::getQueryItems()/req.post.dat.f_vals[0].data:",e.post.dat.f_vals[0].data),n===null&&(n=e.post.dat.f_vals[0].data);const i=Object.entries(n).map(h=>{const d=h[0],p=h[1];return JSON.parse(`[{"key":"${d}","val":"${p}","obj":{"${d}":"${p}"}}]`)}),a=t.serviceInstance.cRules.noDuplicate,o=i.filter(h=>this.isNoDuplicate(h,a)),l={};return o.forEach(async h=>{l[h[0].key]=h[0].val}),await l}isNoDuplicate(e,t=[]){return t.filter(n=>n===e[0].key).length>0}instanceOfCdResponse(e){return"ctx"in e&&"m"in e&&"c"in e&&"a"in e&&"dat"in e&&"args"in e}async setAppState(e,t,n){e===!1&&(this.cdResp.data=[]),this.cdResp.app_state={success:e,info:t,sess:n,cache:{},sConfig:{usePush:ri.usePolling,usePolling:ri.usePush,useCacheStore:ri.useCacheStore}}}setInvalidRequest(e,t,n){this.err.push(R1);const r={messages:this.err,code:n,app_msg:""},i=this.getSess(e,t);this.setAppState(!1,r,i),t.status(200).json(this.cdResp)}getSess(e,t){return null}sessIsValid(e){}async respond(e,t){let n;try{n=t.status(200).json(this.cdResp)}catch(r){this.err.push(r.toString())}return n}async setSess(e,t){const n=this.svSess;if(await!this.cdToken)try{if("sessData"in e.post)this.sess=[e.post.sessData];else{const r=await n.getSession({where:{cdToken:this.cdToken}});if(!r.state||!r.data)return;const i=r.data;i&&(this.sess=i)}this.sess?this.sess.length>0?(this.setCuid(this.sess[0].currentUserId),this.cdToken=await this.sess[0].cdToken):await this.noToken(e,t)===!1&&(this.i={messages:this.err,code:"BaseService:setSess1",app_msg:"invalid session"},await this.serviceErr(e,t,this.i.app_msg,this.i.code)):(this.i={messages:this.err,code:"BaseService:setSess2",app_msg:"invalid session"},await this.serviceErr(e,t,this.i.app_msg,this.i.code),this.respond(e,t))}catch(r){this.i={messages:this.err,code:"BaseService:setSess3",app_msg:r.toString()},await this.setAlertMessage(r.toString(),n,!1)}}async setAlertMessage(e,t,n){this.i.app_msg=e,this.err.push(this.i.app_msg),await this.setAppState(n,this.i,t.sessResp)}async mysqlNow(){console.log("BaseService::mysqlNow()/01");const t=await le(new Date,"ddd MMM DD YYYY HH:mm:ss");console.log("BaseService::mysqlNow()/02");const n=await t.format("YYYY-MM-DD HH:mm:ss");return console.log("BaseService::mysqlNow()/03"),n}getGuid(){return ih()}setCuid(e){this.cuid=e}validateJsonUpdate(e,t){const n=[];function r(i,a){if(i.length===0)return!0;const[o,...l]=i;return Array.isArray(a)&&o==="[0]"?r(l,a[0]):a&&typeof a=="object"?o in a?r(l,a[o]):(n.push(`Invalid path key '${o}' at '${i.join(".")}'`),!1):(n.push(`Unexpected type at '${i.join(".")}'. Expected object or array.`),!1)}return e.forEach(i=>{if(!i.modelField||i.modelField!=="cdDevProjectData"){n.push(`Invalid modelField: '${i.modelField}'`);return}const{path:a}=i;if(!Array.isArray(a)||a.length===0){n.push(`Invalid path: '${JSON.stringify(a)}'`);return}r(a,t)}),{valid:n.length===0,errors:n}}updateJsonData(e,t){console.log("BaseService::updateJsonData()/jsonUpdate1:",e),console.log("BaseService::updateJsonData()/jsonData1:",t);try{if(!e||typeof e!="object")return this.err.push("Invalid jsonUpdate object."),null;if(!Array.isArray(e.path)||e.path.length===0)return this.err.push("Invalid jsonUpdate path: Must be a non-empty array."),null;if(typeof t!="object"||t===null)return this.err.push("Invalid jsonData: Must be a non-null object."),null;let n=t;const r=e.path.length;for(let a=0;a<r-1;a++){const o=e.path[a];if(console.log("BaseService::updateJsonData()/key0:",o),o.startsWith("[")&&o.endsWith("]")){console.log("BaseService::updateJsonData()/key1:",o);const l=parseInt(o.slice(1,-1),10);if(isNaN(l)||!Array.isArray(n))return this.err.push(`Invalid path at '${o}': Expected a valid array index in an array.`),null;n=n[l]}else{if(console.log("BaseService::updateJsonData()/key2:",o),console.log("BaseService::updateJsonData()/target:",n),!Object.prototype.hasOwnProperty.call(n,o))return this.err.push(`Path error: Key '${o}' does not exist.`),null;n=n[o]}}const i=e.path[r-1];if(console.log("BaseService::updateJsonData()/finalKey1:",i),i.startsWith("[")&&i.endsWith("]")){console.log("BaseService::updateJsonData()/finalKey2:",i);const a=parseInt(i.slice(1,-1),10);if(isNaN(a)||!Array.isArray(n))return this.err.push(`Invalid path at final key '${i}': Expected a valid array index in an array.`),null;console.log("BaseService::updateJsonData()/target2:",n),n[a]=e.value}else console.log("BaseService::updateJsonData()/jsonUpdate.value:",e.value),console.log("BaseService::updateJsonData()/target3:",n),console.log("BaseService::updateJsonData()/finalKey3:",i),n[i]=e.value;return console.log("BaseService::updateJsonData()/jsonData3:",t),t}catch(n){return this.err.push(n.toString()),null}}async updateJSONColumnQB(e,t,n,r,i){var h,d,p;await this.init(e,t),console.log("BaseService::updateJSONColumnQB()/repo/model:",n.serviceModel),await this.setRepo(n);const a=(m,w,b="")=>Object.keys(w).map(S=>{const R=`${b}${b?".":""}${S}`;return typeof w[S]=="object"&&w[S]!==null?a(m,w[S],R).join(", "):`JSON_SET(COALESCE(${m}, '{}'), '$.${R}', '${w[S]}')`}).filter(Boolean),o=a(r,i).join(", "),l=this.repo.createQueryBuilder().update(n.serviceModel);if((h=n.cmd)!=null&&h.query.update?l.set(n.cmd.query.update):l.set({[r]:()=>o}),(d=n.cmd)!=null&&d.query.where)Object.keys(n.cmd.query.where).forEach(m=>{var w;l.andWhere(`${m} = :${m}`,{[m]:(w=n.cmd)==null?void 0:w.query.where[m]})});else{const m=n.primaryKey;m&&l.where(`${m} = :${m}`,{[m]:(p=n.cmd)==null?void 0:p.query[m]})}try{return await l.execute()}catch(m){return await this.serviceErr(e,t,m,"BaseService:updateJSONColumnQB")}}async getPlData(e,t=null,n=null){console.info("BaseService::getPlData()/01");let r=null;const i=this.svSess;if(await this.validatePlData(e,t))try{return t?(console.info("BaseService::getPlData()/02"),n?r=e.post.dat.f_vals[n][t]:r=e.post.dat.f_vals[0][t]):(console.info("BaseService::getPlData()/03"),n?r=e.post.dat.f_vals[n].data:r=e.post.dat.f_vals[0].data),console.info("BaseService::getPlData()/04"),console.log("BaseService::getData()/ret:",r),r}catch(a){return this.setAlertMessage(a.toString(),i,!1),{}}else return this.setAlertMessage("invalid validation request",i,!1),{}}async getPlQuery(e,t=null,n=null){console.info("BaseService::getPlQuery()/01");let r=null;const i=this.svSess;if(await this.validatePlData(e,t))try{return t?(console.info("BaseService::getPlQuery()/02"),n?r=e.post.dat.f_vals[n][t]:r=e.post.dat.f_vals[0][t]):(console.info("BaseService::getPlQuery()/03"),n?r=e.post.dat.f_vals[n].query:r=e.post.dat.f_vals[0].query),console.info("BaseService::getPlQuery()/04"),console.log("BaseService::getQuery()/ret:",r),r}catch(a){return this.setAlertMessage(a.toString(),i,!1),{}}else return this.setAlertMessage("invalid validation request",i,!1),{}}async setPlData(e,t,n){console.info("BaseService::setPlData()/item:",t),n?(console.info("BaseService::setPlData()/extData:",{extData:n}),console.info("BaseService::setPlData()/req.post.dat.f_vals[0][extData]:",e.post.dat.f_vals[0][n]),e.post.dat.f_vals[0][n][t.key]=t.value):e.post.dat.f_vals[0].data[t.key]=t.value,console.info("BaseService::setPlData()/req.post.dat.f_vals[0]:",e.post.dat.f_vals[0])}async setPlDataM(e,t,n,r){console.info("BaseService::setPlDataM()/item:",n),r&&(console.log("BaseService::setPlDataM()/extData:",{context:r}),console.log("BaseService::setPlDataM()/data:",t[r]),t[r][n.key]=n.value),console.info("BaseService::setPlDataM()/data:",t)}async validatePlData(e,t){const n=this.svSess;let r=!1;return t?t in e.post.dat.f_vals[0]?r=!0:this.setAlertMessage("BaseService::validatePlData/requested property is missing",n,!1):"data"in e.post.dat.f_vals[0]?r=!0:this.setAlertMessage("BaseService::validatePlData/requested property is missing",n,!1),r}getReqToken(e){return e.post.dat.token}async redisInit(e,t){this.redisClient=Vl(),this.redisClient.on("error",async n=>(console.log("BaseService::redisCreate()/02"),this.err.push(n.toString()),this.err,await this.serviceErr(e,t,this.err,"BaseService:redisCreate"),this.cdResp)),await this.redisClient.connect()}async wsRedisInit(){console.log("BaseService::wsRedisInit()/01"),this.redisClient=Vl(),console.log("BaseService::wsRedisInit()/this.redisClient:",this.redisClient),this.redisClient.on("error",async e=>(console.log("BaseService::redisCreate()/err:",e),this.err.push(e.toString()),this.err,await this.wsServiceErr(this.err,"BaseService:redisCreate"),this.cdResp)),await this.redisClient.connect()}async redisCreate(e,t){await this.redisInit(e,t),console.log("BaseService::redisCreate()/01");const n=await this.getPlData(e);console.log("BaseService::redisCreate()/pl:",n);try{const r=await this.redisClient.set(n.key,n.value);console.log("BaseService::redisCreate()/setRet:",r);const i=await this.redisClient.get(n.key);return console.log("BaseService::redisCreate()/readBack:",i),{status:r,saved:i}}catch(r){return console.log("BaseService::redisCreate()/04"),this.err.push(r.toString()),this.err,await this.serviceErr(e,t,this.err,"BaseService:redisCreate"),this.cdResp}}async wsRedisCreate(e,t){await this.wsRedisInit();try{const n=await this.redisClient.set(e,t);console.log(`BaseService::wsRedisCreate()/setRet:${JSON.stringify(n)}`);const r=await this.redisClient.get(e);return console.log(`BaseService::wsRedisCreate()/readBack:${JSON.stringify(r)}`),{status:n,saved:r}}catch(n){return console.log("BaseService::wsRedisCreate()/04"),this.err.push(n.toString()),this.err,await this.wsServiceErr(this.err,"BaseService:redisCreate"),this.cdResp}}async redisRead(e,t,n){console.log("BaseService::redisRead()/01"),await this.redisInit(e,t),console.log("BaseService::redisRead()/02");const r=await this.getPlData(e);console.log("BaseService::redisRead()/pl:",r);try{const i=await this.redisClient.get(r.key);return console.log("BaseService::redisRead()/getRet:",i),i}catch(i){return console.log("BaseService::redisRead()/04"),this.err.push(i.toString()),this.err,await this.serviceErr(e,t,this.err,"BaseService:redisRead"),this.cdResp}}async wsRedisRead(e){console.log("BaseService::wsRedisRead()/k:",e);const n={r:JSON.stringify([]),error:""};try{const r="";return console.log("BaseService::redisRead()/ret:",{result:n}),n}catch(r){return console.log("BaseService::redisRead()/04"),this.err.push(r.toString()),this.err,await this.wsServiceErr(this.err,"BaseService:redisRead"),n.error=r.toString(),n}}redisDelete(e,t,n){this.redisClient.del("foo",(r,i)=>{if(r)throw r;console.log(i)})}async redisAsyncRead(e,t,n){return new Promise((r,i)=>{this.redisClient.get("myhash",(a,o)=>{a&&i(a),r(o)})})}async wsServiceErr(e,t,n=null){console.log(`Error as BaseService::wsServiceErr, e: ${e.toString()} `);const r=this.svSess;n&&(r.sessResp.cd_token=n),r.sessResp.ttl=r.getTtl(),this.setAppState(!0,this.i,r.sessResp),this.err.push(e.toString());const i={messages:await this.err,code:t,app_msg:`Error at ${t}: ${e.toString()}`};await this.setAppState(!1,i,r.sessResp),this.cdResp.data=[]}successResponse(e,t,n,r=null){r&&(this.i.app_msg=r);const i=this.svSess;i.sessResp.cd_token=e.post.dat.token,i.sessResp.ttl=i.getTtl(),this.setAppState(!0,this.i,i.sessResp),this.cdResp.data=n,this.respond(e,t)}getQuery(e){const t=e.post.dat.f_vals[0].query;return console.info(`BaseService::getQuery()/q:${t}`),this.pl=e.post,t||{}}intersect(e,t,n){return i0.intersectionBy(e,t,n)}isEmpty(e){return e==null||e.length===0}siGet(e,t,n){return{serviceModel:n,docName:t,cmd:{action:"find",query:e},dSource:1}}serviceInputGet(e,t,n){return{serviceModel:n,docName:t,cmd:{action:"find",query:e},dSource:1}}serviceInputCRUD(e){var i,a,o;const t=e.modelName||(((a=(i=e.serviceModel)==null?void 0:i.constructor)==null?void 0:a.name)??"UnknownModel"),n=this.getCallerFunctionName(),r=((o=e.constructor)==null?void 0:o.name)||"UnknownService";return{serviceInstance:e,serviceModel:e.serviceModel.constructor,modelName:t,serviceModelInstance:e.serviceModel,docName:`${n} ${r}`,dSource:1}}getCallerInfo(e=3){var l;const n=(((l=new Error().stack)==null?void 0:l.split(`
`))||[])[e]||"",r=n.match(/at (\w+)/),i=(r==null?void 0:r[1])||"unknownMethod",a=n.match(/:(\d+):\d+\)?$/),o=(a==null?void 0:a[1])||"??";return{method:i,line:o}}getCallerFunctionName(e=3){var a;const i=((((a=new Error().stack)==null?void 0:a.split(`
`))||[])[e]||"").match(/at (\w+)/);return(i==null?void 0:i[1])??"unknownMethod"}async beforeCreateGeneric(e,t){for(const[n,r]of Object.entries(t)){const i=r==="GUID"?this.getGuid():r;this.setPlData(e,{key:n,value:i})}return!0}getPlValue(e,t,n=null){const r=this.getPlData(e,null,n);return r==null?void 0:r[t]}async exists(e,t,n,r,i){const a=this.svSess;if(i==null)return this.i.app_msg=`${n} is required for existence check`,this.err.push(this.i.app_msg),await this.setAppState(!1,this.i,a.sessResp),!1;const o={serviceModel:r,docName:`BaseService::exists(${n})`,cmd:{action:"find",query:{where:{[n]:i}}},dSource:1};try{const l=await this.read(e,t,o);return Array.isArray(l)?l.length>0:"data"in l&&Array.isArray(l.data)?l.data.length>0:!1}catch(l){return console.error(`BaseService::exists() - Error: ${l.message}`),this.i.app_msg=`Existence check failed for ${n}`,this.err.push(this.i.app_msg),await this.setAppState(!1,this.i,a.sessResp),!1}}async validateCreateGeneric(e,t,n,r,i){var o;const a=this.svSess;for(let l of n.required||[])if(!this.getPlValue(e,l))return this.i.app_msg=`${l} is required`,this.err.push(this.i.app_msg),await this.setAppState(!1,this.i,a.sessResp),!1;for(let l of Object.keys(r)){const h=r[l],d=this.getPlValue(e,l);if(!await this.exists(e,t,l,h,d))return!1}return await this.validateUnique(e,t,i)?await this.validateRequired(e,t,n)?!0:(this.setAlertMessage(`Missing required fields: ${this.isInvalidFields.join(", ")}`,a,!0),!1):(this.setAlertMessage(`Duplicate entry for ${(o=n.noDuplicate)==null?void 0:o.join(", ")}`,a,!1),!1)}logTimeStamp(e){throw new Error("Method not implemented.")}async logWithContext(e,t,n,r="debug"){var d;const i=this.getCallerInfo(4),a=((d=e.constructor)==null?void 0:d.name)||"UnknownClass",l=`[${new Date().toLocaleString("en-KE",{timeZone:v1.TZ||"Africa/Nairobi"})}] [${a}::${i.method}():${i.line}]`,h=n?`${l}: ${t} — ${mE(n,{depth:3,colors:!0})}`:`${l}: ${t}`;switch(r){case"info":console.log(Hs.green(h));break;case"warn":console.warn(Hs.yellow(h));break;case"error":console.error(Hs.red(h));break;default:console.debug(Hs.blueBright(h));break}}buildBaseRequest(e,t,n,r,i={}){const a={ctx:ym(e.ctx),m:e.name,c:ym(t.name),a:n,dat:{f_vals:[r],token:this.cdToken},args:i};return this.logWithContext(this,"BaseService.buildBaseRequest",{cdRequest:a},"debug"),a}stripManagedFields(e){const t={};for(const[n,r]of Object.entries(e)){if(a0.some(i=>n.endsWith(i)||n===i)){this.logWithContext(this,"stripManagedFields:removed",{key:n,value:r},"debug");continue}t[n]=r}return t}async handleRequest(e,t={}){var n;try{this.logWithContext(this,"handleRequest:start",{request:e},"debug");const r=await this.http.proc(e);if(!r.state||!r.data){const a=`Failed to contact cd-api for module '${e.m}'.`;return t.raw?{app_state:{success:!1,info:{app_msg:a}}}:{state:ni.NetworkError,data:null,message:a}}const i=r.data;if(t.raw)return i;if(!i.app_state.success){const a=((n=i.app_state.info)==null?void 0:n.app_msg)||"Unknown application error";return{state:ni.Error,data:null,message:a}}return{state:ni.Success,data:i.data,message:`Module '${e.m}' ${e.a} succeeded`}}catch(r){const i=r.message||r;return t.raw?{app_state:{success:!1,info:{app_msg:i}}}:{state:ni.SystemError,data:null,message:`handleRequest exception: ${i}`}}}async emitHttpFx(e,t={}){var n,r,i,a,o,l,h,d,p;try{const w=(await this.http.proc(e)).data;return w.app_state.success?(t.notify&&((h=(o=window.cdShell)==null?void 0:o.notify)==null||h.success(`Welcome ${((l=w.data)==null?void 0:l.userName)||"User"}`)),{state:ni.Success,data:w.data}):(t.notify&&((i=(n=window.cdShell)==null?void 0:n.notify)==null||i.error(((r=w.app_state.info)==null?void 0:r.app_msg)||"Login failed")),{state:ni.Error,data:null,message:(a=w.app_state.info)==null?void 0:a.app_msg})}catch(m){return(p=(d=window.cdShell)==null?void 0:d.notify)==null||p.error(m.message||"Network error"),{state:ni.SystemError,data:null,message:m.message}}}}const wq=Object.freeze(Object.defineProperty({__proto__:null,BaseService:yE},Symbol.toStringTag,{value:"Module"}));class _1{constructor(e,t){this.apiUrl=e,this.workspacePath=t,this.socket=null,console.info("[IdePushClientService] Initializing..."),this.connect(),this.mockWatchSave()}connect(){try{console.info(`[IdePushClientService] Connecting to ${this.apiUrl}...`);const e={path:"/socket.io",transports:["polling"],secure:!0,reconnection:!0,reconnectionAttempts:3,reconnectionDelay:2e3};console.info(`[IdePushClientService] socket.io options: ${JSON.stringify(e)}...`),this.socket=ns(this.apiUrl,e),this.socket.on("connect",()=>{console.info("[IdePushClientService] ✅ Connected to cd-api")}),this.socket.on("disconnect",()=>{console.warn("[IdePushClientService] ⚠️ Disconnected from cd-api")})}catch(e){console.error("[IdePushClientService] Connection error:",e.message)}}mockWatchSave(){console.info(`[IdePushClientService] Mock watcher active on: ${this.workspacePath}`)}sendSaveEvent(e){console.info(`[IdePushClientService] Sending save event for: ${e}`),this.socket&&this.socket.connected?this.socket.emit("ide-push-save",{file:e,ts:Date.now()}):console.warn("[IdePushClientService] Cannot send save event — socket not connected.")}}class x1{constructor(){this.env=null,this.jwtToken="",this.message$=new JI(""),this.pushDataList=[],this.listenSecure=(e,t=null,n=null)=>(console.log("cdUiLib::SioClientService::listenSecure()/01/emittEvent:",e),console.log("cdUiLib::SioClientService::listenSecure()/this.socket:",this.socket),this.socket?this.socket.on(e,r=>{if(r){console.log("cdUiLib::SioClientService::listenSecure()/emittEvent/01/emittEvent:",e),console.log("cdUiLib::SioClientService::listenSecure()/payLoadStr:",r);const i=r;n&&n(t,e,i),"pushData"in i&&n?(console.log("cdUiLib::SioClientService::listenSecure/2"),"triggerEvent"in i.pushData?(console.log("cdUiLib::SioClientService::listenSecure/3"),i.pushData.triggerEvent):console.log("cdUiLib::SioClientService::listenSecure()/triggerEvent missing in payLoad.pushData")):console.log("cdUiLib::SioClientService::listenSecure()/pushData missing in payLoad"),console.log("cdUiLib::SioClientService::listenSecure/4"),console.log("listenSecure()/emittEvent/04/emittEvent:",e),e==="push-msg-relayed"?console.log("cdUiLib::SioClientService::listenSecure/5"):(console.log("cdUiLib::SioClientService::listenSecure/6"),e==="push-msg-pushed"&&this.notificationAcceptDelivery(r),e==="push-delivered"&&this.notificationMsgComplete(r))}}):console.log("cdUiLib::SioClientService::listenSecure()/error: socket is invalid"),this.message$.asObservable())}setEnv(e){this.env=e}registerResource(e){const t=e,n={appId:this.env.appId,ngModule:"UserModule",resourceName:"SessionService",resourceGuid:e,jwtToken:"",socket:null,commTrack:{initTime:Number(new Date),relayTime:null,relayed:!1,pushed:!1,pushTime:null,deliveryTime:null,delivered:!1,completed:!1,completedTime:null}};localStorage.setItem(t,JSON.stringify(n))}initSio(e,t){console.log("cdUiLib::SioClientService::initSio()/01"),this.socket=ns(this.env.sioEndpoint,this.env.sioOptions),console.log("cdUiLib::SioClientService::initSio()/this.socket:",this.socket),t&&(this.listenSecure("push-registered-client",e,t).subscribe(n=>{console.log("initSio::listenSecure/action=push-registered-client"),console.log("initSio::listenSecure/action=push-registered-client/payLoadStr:",n),t(e,"push-registered-client",n)}),this.listenSecure("push-msg-pushed",e,t).subscribe(n=>{console.log("initSio::listenSecure/action=push-msg-pushed"),console.log("initSio::listenSecure/action=push-msg-pushed/payLoadStr:",n),t(e,"push-msg-pushed",n)})),this.listenSecure("push-msg-relayed").subscribe(n=>{if(console.log("cdUiLib::SioClientService::initSio()/listenSecure()/push-msg-relayed/:payLoadStr:",n),n){const r=JSON.parse(n);console.log("cdUiLib::SioClientService::initSio()/listenSecure(msg-relayed)payLoad:",r),this.updateRelayed(r)}}),this.listenSecure("push-msg-pushed").subscribe(n=>{if(console.log("cdUiLib::SioClientService::initSio()/listenSecure()/push-delivered/:payLoadStr:",n),n){const r=JSON.parse(n);this.notificationAcceptDelivery(r)}}),this.listenSecure("push-delivered").subscribe(n=>{if(console.log("cdUiLib::SioClientService::initSio()/listenSecure()/push-delivered/:payLoadStr:",n),n){const r=JSON.parse(n);this.notificationMsgComplete(r)}})}sendMessage(e){console.log("cdUiLib::SioClientService::sendMessage()/msg",e),this.socket?this.socket.emit("message",e):console.log("cdUiLib::SioClientService::sendMessage() error: socket is invalid")}sendPayLoad(e){if(console.log("cdUiLib::SioClientService::sendPayLoad/01/pushEnvelope:",e),"pushData"in e)if("pushGuid"in e.pushData)if(console.log("cdUiLib::SioClientService::sendPayLoad/02/this.socket:",this.socket),this.socket){console.log("cdUiLib::SioClientService::sendPayLoad/:socket is available");const t=JSON.stringify(e);this.socket.emit(e.pushData.triggerEvent,t)}else console.error("cdUiLib::SioClientService::sendPayLoad/:unable to push message. socket is null");else console.error("cdUiLib::SioClientService::sendPayLoad/01/triggerEvent missing in payLoad.pushData");else console.error("cdUiLib::SioClientService::sendPayLoad/01/pushData missing in pushEnvelope")}updateRelayed(e){console.log("updateRelayed()/01"),console.log("updateRelayed()/payLoad:",e)}notificationAcceptDelivery(e){console.log("cdUiLib::SioClientService::notificationAcceptDelivery()/01"),console.log("cdUiLib::SioClientService::notificationAcceptDelivery()/senderAcceptDelivery:",e),e.pushData.commTrack.deliveryTime=Number(new Date),e.pushData.commTrack.delivered=!0,e.pushData.isNotification=!0,e.pushData.triggerEvent="msg-received",this.sendPayLoad(e)}notificationMsgComplete(e){console.log("cdUiLib::SioClientService::notificationMsgComplete()/01"),console.log("cdUiLib::SioClientService::notificationMsgComplete()/1:",e),e.pushData.commTrack.completedTime=Number(new Date),e.pushData.commTrack.completed=!0,e.pushData.isNotification=!0,e.pushData.triggerEvent="msg-completed",console.log("cdUiLib::SioClientService::notificationMsgComplete/2:",e),this.sendPayLoad(e)}sendMessageV2(e,t){console.log("SioClientTestService::sendMessage2()/:triggerEvent:",e),console.log("SioClientTestService::sendMessage2()/:payLoadStr:",t);const n=JSON.stringify(t);return this.socket.emit(e,n),new wn(r=>{this.socket.on("messageSent",i=>{r.next(i),r.complete()}),this.socket.on("error",i=>{r.error(i)})})}sioListen(e){return ts(this.socket,e)}onUserJoined(){return ts(this.socket,"userJoined")}onUserLeft(){return ts(this.socket,"userLeft")}onCustomEvent(e){return ts(this.socket,e)}}class M1{constructor(){this.b=new yE,this.svSioClient=new x1,this.svIdePushClient=new _1,console.debug("[DevSyncClientService] 1"),this.config=ri.devSync,this.store=n0.createEnvironmentAwareStore(this.config.storageType),this.config.autoInitialize&&this.initialize()}async initialize(){await this.connect(),await this.setAppId(),await this.registerClient(),this.listenForEvents()}async connect(){this.socket=ns(this.config.sioEndpoint,{transports:["websocket"]}),this.socket.on("connect",()=>{console.log(`[DevSync] Connected (socket ID: ${this.socket.id})`)}),this.socket.on("disconnect",()=>{console.log("[DevSync] Disconnected")})}async setAppId(){const e=await this.store.get("devsync.appId");if(e){this.appId=e,console.log(`[DevSync] Using existing appId: ${this.appId}`);return}this.appId="xxx-ddd",await this.store.save("devsync.appId",this.appId),console.log(`[DevSync] Generated new appId: ${this.appId}`)}async registerClient(){const e={appId:this.appId,socketId:this.socket.id,connectedAt:new Date().toISOString()};await this.store.save("devsync.sender",e),this.socket.emit("register-client",JSON.stringify(e))}listenForEvents(){["push-registered-client","push-msg-relayed","push-msg-pushed","push-delivered","push-msg-completed","push-notif"].forEach(t=>{this.socket.on(t,n=>{this.handleIncoming(t,n)})})}async handleIncoming(e,t){if(t!=null&&t.appId&&t.appId===this.appId){console.log(`[DevSync] Ignoring self (${e})`);return}console.log(`[DevSync] Event ${e} received`,t)}sendSioMessage(e){this.svSioClient.sendMessageV2(e.pushData.triggerEvent,e).subscribe({next:t=>{console.log("Message sent successfully:",t)},error:t=>{console.error("Error sending message:",t)},complete:()=>{console.log("Message sending complete")}})}async pushUpdate(e){const t={sender:this.appId,timestamp:Date.now(),data:e};this.socket.emit("send-pub",JSON.stringify(t)),console.log("[DevSync] Update sent")}}const Bm={username:"",password:"",__template(){return`
      <form id="signInForm" class="cd-sign-in">
        <h1 class="cd-heading">Sign In</h1>

        <label>Username</label>
        <input cd-model="username" placeholder="Username" />

        <label>Password</label>
        <input cd-model="password" type="password" placeholder="Password" />

        <button type="submit">Sign In</button>
      </form>
    `},__setup(){console.info("[cd-user] Initializing DevSyncClient (runtime)...");try{this.devSync=new M1,this.devSync.setAppId("vite-runtime"),this.devSync.registerClient({role:"runtime",controller:"sign-in"}),this.devSync.onPayload(e=>{this.onDevSyncMessage(e)}),console.log("[cd-user] DevSyncClient initialized successfully")}catch(e){console.error("[cd-user] Failed to initialize DevSyncClient:",e)}const s=document.getElementById("signInForm");if(!s){console.warn("[cd-user] signInForm not found");return}s.addEventListener("submit",e=>{e.preventDefault(),this.auth()}),console.log("[cd-user] Controller setup complete")},auth(){console.log("Auth triggered with:",this.username,this.password);const s={source:{appId:this.devSync.appId},target:"ide-agent",action:"AUTH_ATTEMPT",data:{username:this.username,password:this.password,timestamp:new Date().toISOString()}};this.devSync.emitPayload(s),alert(`Hello, ${this.username}!`)},onDevSyncMessage(s){const{source:e,action:t,data:n}=s;if(e.appId!==this.devSync.appId)switch(t){case"AUTH_RESULT":console.log("[cd-user] Auth result received:",n),alert(n.message);break;case"UPDATE_CONTROLLER":console.log("[cd-user] Controller update payload:",n),this.applyControllerUpdate(n);break;default:console.log("[cd-user] Unknown DevSync action:",t)}},applyControllerUpdate(s){console.log("[cd-user] Applying runtime update:",s)}},gE={ctx:"sys",moduleId:"cd-user",moduleName:"Auto-Generated Module",moduleGuid:"auto-guid",controller:Bm,template:Bm.__template(),menu:[]},P1=gE,bq=Object.freeze(Object.defineProperty({__proto__:null,cduserModule:gE,module:P1},Symbol.toStringTag,{value:"Module"}));export{Gi as $,G1 as A,yE as B,L1 as C,tn as D,OI as E,ps as F,z1 as G,K1 as H,B as I,xM as J,J1 as K,X1 as L,cx as M,Z1 as N,Re as O,DI as P,Nt as Q,ei as R,zs as S,x as T,rx as U,eq as V,V1 as W,Cl as X,m0 as Y,ro as Z,y0 as _,wr as a,Fp as a$,g0 as a0,E0 as a1,ml as a2,w0 as a3,ry as a4,In as a5,b0 as a6,yl as a7,T0 as a8,S0 as a9,B0 as aA,Fs as aB,U0 as aC,F0 as aD,U_ as aE,MM as aF,Ht as aG,rc as aH,Zp as aI,SM as aJ,mM as aK,yM as aL,gM as aM,Xn as aN,xy as aO,vx as aP,_y as aQ,Tx as aR,ox as aS,U1 as aT,ux as aU,vy as aV,F1 as aW,lx as aX,j1 as aY,hx as aZ,dx as a_,wp as aa,iy as ab,A0 as ac,sy as ad,bp as ae,Wu as af,N0 as ag,C0 as ah,zo as ai,v0 as aj,Gn as ak,R0 as al,ds as am,_0 as an,x0 as ao,M0 as ap,Us as aq,P0 as ar,O0 as as,D0 as at,I0 as au,$0 as av,Kn as aw,L0 as ax,q0 as ay,zt as az,Yo as b,fx as b0,px as b1,mx as b2,Jn as b3,ln as b4,Ri as b5,Dn as b6,Ct as b7,Gt as b8,gt as b9,Ur as ba,Hn as bb,wq as bc,bq as bd,At as c,vM as d,Oo as e,ix as f,Io as g,ny as h,RM as i,W_ as j,G_ as k,K_ as l,qp as m,Ny as n,j_ as o,tr as p,Up as q,Gu as r,ui as s,Ti as t,Sc as u,_M as v,yr as w,H1 as x,Y1 as y,Rl as z};
