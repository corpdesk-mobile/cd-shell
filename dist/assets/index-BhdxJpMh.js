const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CSOB4155.js","assets/index-pgZg770A.js","assets/index-C_EefWij.css","assets/__vite-browser-external_path-SE2pKm0_.js","assets/__vite-browser-external_fs-DMuOfmem.js","assets/index-CCs3NjLB.js","assets/dayjs.min-C2T4sop3.js","assets/index-heC92mhW.js","assets/url-DykbdbEo.js"])))=>i.map(i=>d[i]);
import"./__vite-browser-external_path-SE2pKm0_.js";import"./__vite-browser-external_fs-DMuOfmem.js";import{c as ir,g as Kf,_ as za}from"./index-pgZg770A.js";import{t as Ka,a as Ja,e as Iu,s as mA,g as yA,r as gA,b as EA,d as TA,f as wA,h as bA,c as qr,i as Jf,j as NA}from"./index-CCs3NjLB.js";import{d as AA}from"./dayjs.min-C2T4sop3.js";function CA(s,e){for(var t=0;t<e.length;t++){const n=e[t];if(typeof n!="string"&&!Array.isArray(n)){for(const i in n)if(i!=="default"&&!(i in s)){const r=Object.getOwnPropertyDescriptor(n,i);r&&Object.defineProperty(s,i,r.get?r:{enumerable:!0,get:()=>n[i]})}}}return Object.freeze(Object.defineProperty(s,Symbol.toStringTag,{value:"Module"}))}const ti=Object.create(null);ti.open="0";ti.close="1";ti.ping="2";ti.pong="3";ti.message="4";ti.upgrade="5";ti.noop="6";const Sa=Object.create(null);Object.keys(ti).forEach(s=>{Sa[ti[s]]=s});const ou={type:"error",data:"parser error"},Xf=typeof Blob=="function"||typeof Blob<"u"&&Object.prototype.toString.call(Blob)==="[object BlobConstructor]",Zf=typeof ArrayBuffer=="function",ep=s=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(s):s&&s.buffer instanceof ArrayBuffer,$u=({type:s,data:e},t,n)=>Xf&&e instanceof Blob?t?n(e):Hd(e,n):Zf&&(e instanceof ArrayBuffer||ep(e))?t?n(e):Hd(new Blob([e]),n):n(ti[s]+(e||"")),Hd=(s,e)=>{const t=new FileReader;return t.onload=function(){const n=t.result.split(",")[1];e("b"+(n||""))},t.readAsDataURL(s)};function Yd(s){return s instanceof Uint8Array?s:s instanceof ArrayBuffer?new Uint8Array(s):new Uint8Array(s.buffer,s.byteOffset,s.byteLength)}let Bc;function SA(s,e){if(Xf&&s.data instanceof Blob)return s.data.arrayBuffer().then(Yd).then(e);if(Zf&&(s.data instanceof ArrayBuffer||ep(s.data)))return e(Yd(s.data));$u(s,!1,t=>{Bc||(Bc=new TextEncoder),e(Bc.encode(t))})}const Gd="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",hs=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(let s=0;s<Gd.length;s++)hs[Gd.charCodeAt(s)]=s;const RA=s=>{let e=s.length*.75,t=s.length,n,i=0,r,a,c,l;s[s.length-1]==="="&&(e--,s[s.length-2]==="="&&e--);const h=new ArrayBuffer(e),f=new Uint8Array(h);for(n=0;n<t;n+=4)r=hs[s.charCodeAt(n)],a=hs[s.charCodeAt(n+1)],c=hs[s.charCodeAt(n+2)],l=hs[s.charCodeAt(n+3)],f[i++]=r<<2|a>>4,f[i++]=(a&15)<<4|c>>2,f[i++]=(c&3)<<6|l&63;return h},xA=typeof ArrayBuffer=="function",Lu=(s,e)=>{if(typeof s!="string")return{type:"message",data:tp(s,e)};const t=s.charAt(0);return t==="b"?{type:"message",data:_A(s.substring(1),e)}:Sa[t]?s.length>1?{type:Sa[t],data:s.substring(1)}:{type:Sa[t]}:ou},_A=(s,e)=>{if(xA){const t=RA(s);return tp(t,e)}else return{base64:!0,data:s}},tp=(s,e)=>{switch(e){case"blob":return s instanceof Blob?s:new Blob([s]);case"arraybuffer":default:return s instanceof ArrayBuffer?s:s.buffer}},np="",vA=(s,e)=>{const t=s.length,n=new Array(t);let i=0;s.forEach((r,a)=>{$u(r,!1,c=>{n[a]=c,++i===t&&e(n.join(np))})})},MA=(s,e)=>{const t=s.split(np),n=[];for(let i=0;i<t.length;i++){const r=Lu(t[i],e);if(n.push(r),r.type==="error")break}return n};function PA(){return new TransformStream({transform(s,e){SA(s,t=>{const n=t.length;let i;if(n<126)i=new Uint8Array(1),new DataView(i.buffer).setUint8(0,n);else if(n<65536){i=new Uint8Array(3);const r=new DataView(i.buffer);r.setUint8(0,126),r.setUint16(1,n)}else{i=new Uint8Array(9);const r=new DataView(i.buffer);r.setUint8(0,127),r.setBigUint64(1,BigInt(n))}s.data&&typeof s.data!="string"&&(i[0]|=128),e.enqueue(i),e.enqueue(t)})}})}let Fc;function ya(s){return s.reduce((e,t)=>e+t.length,0)}function ga(s,e){if(s[0].length===e)return s.shift();const t=new Uint8Array(e);let n=0;for(let i=0;i<e;i++)t[i]=s[0][n++],n===s[0].length&&(s.shift(),n=0);return s.length&&n<s[0].length&&(s[0]=s[0].slice(n)),t}function OA(s,e){Fc||(Fc=new TextDecoder);const t=[];let n=0,i=-1,r=!1;return new TransformStream({transform(a,c){for(t.push(a);;){if(n===0){if(ya(t)<1)break;const l=ga(t,1);r=(l[0]&128)===128,i=l[0]&127,i<126?n=3:i===126?n=1:n=2}else if(n===1){if(ya(t)<2)break;const l=ga(t,2);i=new DataView(l.buffer,l.byteOffset,l.length).getUint16(0),n=3}else if(n===2){if(ya(t)<8)break;const l=ga(t,8),h=new DataView(l.buffer,l.byteOffset,l.length),f=h.getUint32(0);if(f>Math.pow(2,21)-1){c.enqueue(ou);break}i=f*Math.pow(2,32)+h.getUint32(4),n=3}else{if(ya(t)<i)break;const l=ga(t,i);c.enqueue(Lu(r?l:Fc.decode(l),e)),n=0}if(i===0||i>s){c.enqueue(ou);break}}}})}const ip=4;function Rt(s){if(s)return DA(s)}function DA(s){for(var e in Rt.prototype)s[e]=Rt.prototype[e];return s}Rt.prototype.on=Rt.prototype.addEventListener=function(s,e){return this._callbacks=this._callbacks||{},(this._callbacks["$"+s]=this._callbacks["$"+s]||[]).push(e),this};Rt.prototype.once=function(s,e){function t(){this.off(s,t),e.apply(this,arguments)}return t.fn=e,this.on(s,t),this};Rt.prototype.off=Rt.prototype.removeListener=Rt.prototype.removeAllListeners=Rt.prototype.removeEventListener=function(s,e){if(this._callbacks=this._callbacks||{},arguments.length==0)return this._callbacks={},this;var t=this._callbacks["$"+s];if(!t)return this;if(arguments.length==1)return delete this._callbacks["$"+s],this;for(var n,i=0;i<t.length;i++)if(n=t[i],n===e||n.fn===e){t.splice(i,1);break}return t.length===0&&delete this._callbacks["$"+s],this};Rt.prototype.emit=function(s){this._callbacks=this._callbacks||{};for(var e=new Array(arguments.length-1),t=this._callbacks["$"+s],n=1;n<arguments.length;n++)e[n-1]=arguments[n];if(t){t=t.slice(0);for(var n=0,i=t.length;n<i;++n)t[n].apply(this,e)}return this};Rt.prototype.emitReserved=Rt.prototype.emit;Rt.prototype.listeners=function(s){return this._callbacks=this._callbacks||{},this._callbacks["$"+s]||[]};Rt.prototype.hasListeners=function(s){return!!this.listeners(s).length};const Xa=typeof Promise=="function"&&typeof Promise.resolve=="function"?e=>Promise.resolve().then(e):(e,t)=>t(e,0),bn=typeof self<"u"?self:typeof window<"u"?window:Function("return this")(),IA="arraybuffer";function rp(s,...e){return e.reduce((t,n)=>(s.hasOwnProperty(n)&&(t[n]=s[n]),t),{})}const $A=bn.setTimeout,LA=bn.clearTimeout;function Za(s,e){e.useNativeTimers?(s.setTimeoutFn=$A.bind(bn),s.clearTimeoutFn=LA.bind(bn)):(s.setTimeoutFn=bn.setTimeout.bind(bn),s.clearTimeoutFn=bn.clearTimeout.bind(bn))}const qA=1.33;function BA(s){return typeof s=="string"?FA(s):Math.ceil((s.byteLength||s.size)*qA)}function FA(s){let e=0,t=0;for(let n=0,i=s.length;n<i;n++)e=s.charCodeAt(n),e<128?t+=1:e<2048?t+=2:e<55296||e>=57344?t+=3:(n++,t+=4);return t}function sp(){return Date.now().toString(36).substring(3)+Math.random().toString(36).substring(2,5)}function UA(s){let e="";for(let t in s)s.hasOwnProperty(t)&&(e.length&&(e+="&"),e+=encodeURIComponent(t)+"="+encodeURIComponent(s[t]));return e}function kA(s){let e={},t=s.split("&");for(let n=0,i=t.length;n<i;n++){let r=t[n].split("=");e[decodeURIComponent(r[0])]=decodeURIComponent(r[1])}return e}class jA extends Error{constructor(e,t,n){super(e),this.description=t,this.context=n,this.type="TransportError"}}class qu extends Rt{constructor(e){super(),this.writable=!1,Za(this,e),this.opts=e,this.query=e.query,this.socket=e.socket,this.supportsBinary=!e.forceBase64}onError(e,t,n){return super.emitReserved("error",new jA(e,t,n)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return(this.readyState==="opening"||this.readyState==="open")&&(this.doClose(),this.onClose()),this}send(e){this.readyState==="open"&&this.write(e)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(e){const t=Lu(e,this.socket.binaryType);this.onPacket(t)}onPacket(e){super.emitReserved("packet",e)}onClose(e){this.readyState="closed",super.emitReserved("close",e)}pause(e){}createUri(e,t={}){return e+"://"+this._hostname()+this._port()+this.opts.path+this._query(t)}_hostname(){const e=this.opts.hostname;return e.indexOf(":")===-1?e:"["+e+"]"}_port(){return this.opts.port&&(this.opts.secure&&+(this.opts.port!==443)||!this.opts.secure&&Number(this.opts.port)!==80)?":"+this.opts.port:""}_query(e){const t=UA(e);return t.length?"?"+t:""}}class VA extends qu{constructor(){super(...arguments),this._polling=!1}get name(){return"polling"}doOpen(){this._poll()}pause(e){this.readyState="pausing";const t=()=>{this.readyState="paused",e()};if(this._polling||!this.writable){let n=0;this._polling&&(n++,this.once("pollComplete",function(){--n||t()})),this.writable||(n++,this.once("drain",function(){--n||t()}))}else t()}_poll(){this._polling=!0,this.doPoll(),this.emitReserved("poll")}onData(e){const t=n=>{if(this.readyState==="opening"&&n.type==="open"&&this.onOpen(),n.type==="close")return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(n)};MA(e,this.socket.binaryType).forEach(t),this.readyState!=="closed"&&(this._polling=!1,this.emitReserved("pollComplete"),this.readyState==="open"&&this._poll())}doClose(){const e=()=>{this.write([{type:"close"}])};this.readyState==="open"?e():this.once("open",e)}write(e){this.writable=!1,vA(e,t=>{this.doWrite(t,()=>{this.writable=!0,this.emitReserved("drain")})})}uri(){const e=this.opts.secure?"https":"http",t=this.query||{};return this.opts.timestampRequests!==!1&&(t[this.opts.timestampParam]=sp()),!this.supportsBinary&&!t.sid&&(t.b64=1),this.createUri(e,t)}}let ap=!1;try{ap=typeof XMLHttpRequest<"u"&&"withCredentials"in new XMLHttpRequest}catch{}const QA=ap;function WA(){}class HA extends VA{constructor(e){if(super(e),typeof location<"u"){const t=location.protocol==="https:";let n=location.port;n||(n=t?"443":"80"),this.xd=typeof location<"u"&&e.hostname!==location.hostname||n!==e.port}}doWrite(e,t){const n=this.request({method:"POST",data:e});n.on("success",t),n.on("error",(i,r)=>{this.onError("xhr post error",i,r)})}doPoll(){const e=this.request();e.on("data",this.onData.bind(this)),e.on("error",(t,n)=>{this.onError("xhr poll error",t,n)}),this.pollXhr=e}}class ei extends Rt{constructor(e,t,n){super(),this.createRequest=e,Za(this,n),this._opts=n,this._method=n.method||"GET",this._uri=t,this._data=n.data!==void 0?n.data:null,this._create()}_create(){var e;const t=rp(this._opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");t.xdomain=!!this._opts.xd;const n=this._xhr=this.createRequest(t);try{n.open(this._method,this._uri,!0);try{if(this._opts.extraHeaders){n.setDisableHeaderCheck&&n.setDisableHeaderCheck(!0);for(let i in this._opts.extraHeaders)this._opts.extraHeaders.hasOwnProperty(i)&&n.setRequestHeader(i,this._opts.extraHeaders[i])}}catch{}if(this._method==="POST")try{n.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch{}try{n.setRequestHeader("Accept","*/*")}catch{}(e=this._opts.cookieJar)===null||e===void 0||e.addCookies(n),"withCredentials"in n&&(n.withCredentials=this._opts.withCredentials),this._opts.requestTimeout&&(n.timeout=this._opts.requestTimeout),n.onreadystatechange=()=>{var i;n.readyState===3&&((i=this._opts.cookieJar)===null||i===void 0||i.parseCookies(n.getResponseHeader("set-cookie"))),n.readyState===4&&(n.status===200||n.status===1223?this._onLoad():this.setTimeoutFn(()=>{this._onError(typeof n.status=="number"?n.status:0)},0))},n.send(this._data)}catch(i){this.setTimeoutFn(()=>{this._onError(i)},0);return}typeof document<"u"&&(this._index=ei.requestsCount++,ei.requests[this._index]=this)}_onError(e){this.emitReserved("error",e,this._xhr),this._cleanup(!0)}_cleanup(e){if(!(typeof this._xhr>"u"||this._xhr===null)){if(this._xhr.onreadystatechange=WA,e)try{this._xhr.abort()}catch{}typeof document<"u"&&delete ei.requests[this._index],this._xhr=null}}_onLoad(){const e=this._xhr.responseText;e!==null&&(this.emitReserved("data",e),this.emitReserved("success"),this._cleanup())}abort(){this._cleanup()}}ei.requestsCount=0;ei.requests={};if(typeof document<"u"){if(typeof attachEvent=="function")attachEvent("onunload",zd);else if(typeof addEventListener=="function"){const s="onpagehide"in bn?"pagehide":"unload";addEventListener(s,zd,!1)}}function zd(){for(let s in ei.requests)ei.requests.hasOwnProperty(s)&&ei.requests[s].abort()}const YA=function(){const s=op({xdomain:!1});return s&&s.responseType!==null}();class GA extends HA{constructor(e){super(e);const t=e&&e.forceBase64;this.supportsBinary=YA&&!t}request(e={}){return Object.assign(e,{xd:this.xd},this.opts),new ei(op,this.uri(),e)}}function op(s){const e=s.xdomain;try{if(typeof XMLHttpRequest<"u"&&(!e||QA))return new XMLHttpRequest}catch{}if(!e)try{return new bn[["Active"].concat("Object").join("X")]("Microsoft.XMLHTTP")}catch{}}const cp=typeof navigator<"u"&&typeof navigator.product=="string"&&navigator.product.toLowerCase()==="reactnative";class zA extends qu{get name(){return"websocket"}doOpen(){const e=this.uri(),t=this.opts.protocols,n=cp?{}:rp(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(n.headers=this.opts.extraHeaders);try{this.ws=this.createSocket(e,t,n)}catch(i){return this.emitReserved("error",i)}this.ws.binaryType=this.socket.binaryType,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=e=>this.onClose({description:"websocket connection closed",context:e}),this.ws.onmessage=e=>this.onData(e.data),this.ws.onerror=e=>this.onError("websocket error",e)}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const n=e[t],i=t===e.length-1;$u(n,this.supportsBinary,r=>{try{this.doWrite(n,r)}catch{}i&&Xa(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){typeof this.ws<"u"&&(this.ws.onerror=()=>{},this.ws.close(),this.ws=null)}uri(){const e=this.opts.secure?"wss":"ws",t=this.query||{};return this.opts.timestampRequests&&(t[this.opts.timestampParam]=sp()),this.supportsBinary||(t.b64=1),this.createUri(e,t)}}const Uc=bn.WebSocket||bn.MozWebSocket;class KA extends zA{createSocket(e,t,n){return cp?new Uc(e,t,n):t?new Uc(e,t):new Uc(e)}doWrite(e,t){this.ws.send(t)}}class JA extends qu{get name(){return"webtransport"}doOpen(){try{this._transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name])}catch(e){return this.emitReserved("error",e)}this._transport.closed.then(()=>{this.onClose()}).catch(e=>{this.onError("webtransport error",e)}),this._transport.ready.then(()=>{this._transport.createBidirectionalStream().then(e=>{const t=OA(Number.MAX_SAFE_INTEGER,this.socket.binaryType),n=e.readable.pipeThrough(t).getReader(),i=PA();i.readable.pipeTo(e.writable),this._writer=i.writable.getWriter();const r=()=>{n.read().then(({done:c,value:l})=>{c||(this.onPacket(l),r())}).catch(c=>{})};r();const a={type:"open"};this.query.sid&&(a.data=`{"sid":"${this.query.sid}"}`),this._writer.write(a).then(()=>this.onOpen())})})}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const n=e[t],i=t===e.length-1;this._writer.write(n).then(()=>{i&&Xa(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){var e;(e=this._transport)===null||e===void 0||e.close()}}const XA={websocket:KA,webtransport:JA,polling:GA},ZA=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,eC=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function cu(s){if(s.length>8e3)throw"URI too long";const e=s,t=s.indexOf("["),n=s.indexOf("]");t!=-1&&n!=-1&&(s=s.substring(0,t)+s.substring(t,n).replace(/:/g,";")+s.substring(n,s.length));let i=ZA.exec(s||""),r={},a=14;for(;a--;)r[eC[a]]=i[a]||"";return t!=-1&&n!=-1&&(r.source=e,r.host=r.host.substring(1,r.host.length-1).replace(/;/g,":"),r.authority=r.authority.replace("[","").replace("]","").replace(/;/g,":"),r.ipv6uri=!0),r.pathNames=tC(r,r.path),r.queryKey=nC(r,r.query),r}function tC(s,e){const t=/\/{2,9}/g,n=e.replace(t,"/").split("/");return(e.slice(0,1)=="/"||e.length===0)&&n.splice(0,1),e.slice(-1)=="/"&&n.splice(n.length-1,1),n}function nC(s,e){const t={};return e.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(n,i,r){i&&(t[i]=r)}),t}const uu=typeof addEventListener=="function"&&typeof removeEventListener=="function",Ra=[];uu&&addEventListener("offline",()=>{Ra.forEach(s=>s())},!1);class Qi extends Rt{constructor(e,t){if(super(),this.binaryType=IA,this.writeBuffer=[],this._prevBufferLen=0,this._pingInterval=-1,this._pingTimeout=-1,this._maxPayload=-1,this._pingTimeoutTime=1/0,e&&typeof e=="object"&&(t=e,e=null),e){const n=cu(e);t.hostname=n.host,t.secure=n.protocol==="https"||n.protocol==="wss",t.port=n.port,n.query&&(t.query=n.query)}else t.host&&(t.hostname=cu(t.host).host);Za(this,t),this.secure=t.secure!=null?t.secure:typeof location<"u"&&location.protocol==="https:",t.hostname&&!t.port&&(t.port=this.secure?"443":"80"),this.hostname=t.hostname||(typeof location<"u"?location.hostname:"localhost"),this.port=t.port||(typeof location<"u"&&location.port?location.port:this.secure?"443":"80"),this.transports=[],this._transportsByName={},t.transports.forEach(n=>{const i=n.prototype.name;this.transports.push(i),this._transportsByName[i]=n}),this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!1},t),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),typeof this.opts.query=="string"&&(this.opts.query=kA(this.opts.query)),uu&&(this.opts.closeOnBeforeunload&&(this._beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this._beforeunloadEventListener,!1)),this.hostname!=="localhost"&&(this._offlineEventListener=()=>{this._onClose("transport close",{description:"network connection lost"})},Ra.push(this._offlineEventListener))),this.opts.withCredentials&&(this._cookieJar=void 0),this._open()}createTransport(e){const t=Object.assign({},this.opts.query);t.EIO=ip,t.transport=e,this.id&&(t.sid=this.id);const n=Object.assign({},this.opts,{query:t,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[e]);return new this._transportsByName[e](n)}_open(){if(this.transports.length===0){this.setTimeoutFn(()=>{this.emitReserved("error","No transports available")},0);return}const e=this.opts.rememberUpgrade&&Qi.priorWebsocketSuccess&&this.transports.indexOf("websocket")!==-1?"websocket":this.transports[0];this.readyState="opening";const t=this.createTransport(e);t.open(),this.setTransport(t)}setTransport(e){this.transport&&this.transport.removeAllListeners(),this.transport=e,e.on("drain",this._onDrain.bind(this)).on("packet",this._onPacket.bind(this)).on("error",this._onError.bind(this)).on("close",t=>this._onClose("transport close",t))}onOpen(){this.readyState="open",Qi.priorWebsocketSuccess=this.transport.name==="websocket",this.emitReserved("open"),this.flush()}_onPacket(e){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")switch(this.emitReserved("packet",e),this.emitReserved("heartbeat"),e.type){case"open":this.onHandshake(JSON.parse(e.data));break;case"ping":this._sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong"),this._resetPingTimeout();break;case"error":const t=new Error("server error");t.code=e.data,this._onError(t);break;case"message":this.emitReserved("data",e.data),this.emitReserved("message",e.data);break}}onHandshake(e){this.emitReserved("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this._pingInterval=e.pingInterval,this._pingTimeout=e.pingTimeout,this._maxPayload=e.maxPayload,this.onOpen(),this.readyState!=="closed"&&this._resetPingTimeout()}_resetPingTimeout(){this.clearTimeoutFn(this._pingTimeoutTimer);const e=this._pingInterval+this._pingTimeout;this._pingTimeoutTime=Date.now()+e,this._pingTimeoutTimer=this.setTimeoutFn(()=>{this._onClose("ping timeout")},e),this.opts.autoUnref&&this._pingTimeoutTimer.unref()}_onDrain(){this.writeBuffer.splice(0,this._prevBufferLen),this._prevBufferLen=0,this.writeBuffer.length===0?this.emitReserved("drain"):this.flush()}flush(){if(this.readyState!=="closed"&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const e=this._getWritablePackets();this.transport.send(e),this._prevBufferLen=e.length,this.emitReserved("flush")}}_getWritablePackets(){if(!(this._maxPayload&&this.transport.name==="polling"&&this.writeBuffer.length>1))return this.writeBuffer;let t=1;for(let n=0;n<this.writeBuffer.length;n++){const i=this.writeBuffer[n].data;if(i&&(t+=BA(i)),n>0&&t>this._maxPayload)return this.writeBuffer.slice(0,n);t+=2}return this.writeBuffer}_hasPingExpired(){if(!this._pingTimeoutTime)return!0;const e=Date.now()>this._pingTimeoutTime;return e&&(this._pingTimeoutTime=0,Xa(()=>{this._onClose("ping timeout")},this.setTimeoutFn)),e}write(e,t,n){return this._sendPacket("message",e,t,n),this}send(e,t,n){return this._sendPacket("message",e,t,n),this}_sendPacket(e,t,n,i){if(typeof t=="function"&&(i=t,t=void 0),typeof n=="function"&&(i=n,n=null),this.readyState==="closing"||this.readyState==="closed")return;n=n||{},n.compress=n.compress!==!1;const r={type:e,data:t,options:n};this.emitReserved("packetCreate",r),this.writeBuffer.push(r),i&&this.once("flush",i),this.flush()}close(){const e=()=>{this._onClose("forced close"),this.transport.close()},t=()=>{this.off("upgrade",t),this.off("upgradeError",t),e()},n=()=>{this.once("upgrade",t),this.once("upgradeError",t)};return(this.readyState==="opening"||this.readyState==="open")&&(this.readyState="closing",this.writeBuffer.length?this.once("drain",()=>{this.upgrading?n():e()}):this.upgrading?n():e()),this}_onError(e){if(Qi.priorWebsocketSuccess=!1,this.opts.tryAllTransports&&this.transports.length>1&&this.readyState==="opening")return this.transports.shift(),this._open();this.emitReserved("error",e),this._onClose("transport error",e)}_onClose(e,t){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing"){if(this.clearTimeoutFn(this._pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),uu&&(this._beforeunloadEventListener&&removeEventListener("beforeunload",this._beforeunloadEventListener,!1),this._offlineEventListener)){const n=Ra.indexOf(this._offlineEventListener);n!==-1&&Ra.splice(n,1)}this.readyState="closed",this.id=null,this.emitReserved("close",e,t),this.writeBuffer=[],this._prevBufferLen=0}}}Qi.protocol=ip;class iC extends Qi{constructor(){super(...arguments),this._upgrades=[]}onOpen(){if(super.onOpen(),this.readyState==="open"&&this.opts.upgrade)for(let e=0;e<this._upgrades.length;e++)this._probe(this._upgrades[e])}_probe(e){let t=this.createTransport(e),n=!1;Qi.priorWebsocketSuccess=!1;const i=()=>{n||(t.send([{type:"ping",data:"probe"}]),t.once("packet",p=>{if(!n)if(p.type==="pong"&&p.data==="probe"){if(this.upgrading=!0,this.emitReserved("upgrading",t),!t)return;Qi.priorWebsocketSuccess=t.name==="websocket",this.transport.pause(()=>{n||this.readyState!=="closed"&&(f(),this.setTransport(t),t.send([{type:"upgrade"}]),this.emitReserved("upgrade",t),t=null,this.upgrading=!1,this.flush())})}else{const m=new Error("probe error");m.transport=t.name,this.emitReserved("upgradeError",m)}}))};function r(){n||(n=!0,f(),t.close(),t=null)}const a=p=>{const m=new Error("probe error: "+p);m.transport=t.name,r(),this.emitReserved("upgradeError",m)};function c(){a("transport closed")}function l(){a("socket closed")}function h(p){t&&p.name!==t.name&&r()}const f=()=>{t.removeListener("open",i),t.removeListener("error",a),t.removeListener("close",c),this.off("close",l),this.off("upgrading",h)};t.once("open",i),t.once("error",a),t.once("close",c),this.once("close",l),this.once("upgrading",h),this._upgrades.indexOf("webtransport")!==-1&&e!=="webtransport"?this.setTimeoutFn(()=>{n||t.open()},200):t.open()}onHandshake(e){this._upgrades=this._filterUpgrades(e.upgrades),super.onHandshake(e)}_filterUpgrades(e){const t=[];for(let n=0;n<e.length;n++)~this.transports.indexOf(e[n])&&t.push(e[n]);return t}}let rC=class extends iC{constructor(e,t={}){const n=typeof e=="object"?e:t;(!n.transports||n.transports&&typeof n.transports[0]=="string")&&(n.transports=(n.transports||["polling","websocket","webtransport"]).map(i=>XA[i]).filter(i=>!!i)),super(e,n)}};function sC(s,e="",t){let n=s;t=t||typeof location<"u"&&location,s==null&&(s=t.protocol+"//"+t.host),typeof s=="string"&&(s.charAt(0)==="/"&&(s.charAt(1)==="/"?s=t.protocol+s:s=t.host+s),/^(https?|wss?):\/\//.test(s)||(typeof t<"u"?s=t.protocol+"//"+s:s="https://"+s),n=cu(s)),n.port||(/^(http|ws)$/.test(n.protocol)?n.port="80":/^(http|ws)s$/.test(n.protocol)&&(n.port="443")),n.path=n.path||"/";const r=n.host.indexOf(":")!==-1?"["+n.host+"]":n.host;return n.id=n.protocol+"://"+r+":"+n.port+e,n.href=n.protocol+"://"+r+(t&&t.port===n.port?"":":"+n.port),n}const aC=typeof ArrayBuffer=="function",oC=s=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(s):s.buffer instanceof ArrayBuffer,up=Object.prototype.toString,cC=typeof Blob=="function"||typeof Blob<"u"&&up.call(Blob)==="[object BlobConstructor]",uC=typeof File=="function"||typeof File<"u"&&up.call(File)==="[object FileConstructor]";function Bu(s){return aC&&(s instanceof ArrayBuffer||oC(s))||cC&&s instanceof Blob||uC&&s instanceof File}function xa(s,e){if(!s||typeof s!="object")return!1;if(Array.isArray(s)){for(let t=0,n=s.length;t<n;t++)if(xa(s[t]))return!0;return!1}if(Bu(s))return!0;if(s.toJSON&&typeof s.toJSON=="function"&&arguments.length===1)return xa(s.toJSON(),!0);for(const t in s)if(Object.prototype.hasOwnProperty.call(s,t)&&xa(s[t]))return!0;return!1}function lC(s){const e=[],t=s.data,n=s;return n.data=lu(t,e),n.attachments=e.length,{packet:n,buffers:e}}function lu(s,e){if(!s)return s;if(Bu(s)){const t={_placeholder:!0,num:e.length};return e.push(s),t}else if(Array.isArray(s)){const t=new Array(s.length);for(let n=0;n<s.length;n++)t[n]=lu(s[n],e);return t}else if(typeof s=="object"&&!(s instanceof Date)){const t={};for(const n in s)Object.prototype.hasOwnProperty.call(s,n)&&(t[n]=lu(s[n],e));return t}return s}function hC(s,e){return s.data=hu(s.data,e),delete s.attachments,s}function hu(s,e){if(!s)return s;if(s&&s._placeholder===!0){if(typeof s.num=="number"&&s.num>=0&&s.num<e.length)return e[s.num];throw new Error("illegal attachments")}else if(Array.isArray(s))for(let t=0;t<s.length;t++)s[t]=hu(s[t],e);else if(typeof s=="object")for(const t in s)Object.prototype.hasOwnProperty.call(s,t)&&(s[t]=hu(s[t],e));return s}const dC=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"],fC=5;var Qe;(function(s){s[s.CONNECT=0]="CONNECT",s[s.DISCONNECT=1]="DISCONNECT",s[s.EVENT=2]="EVENT",s[s.ACK=3]="ACK",s[s.CONNECT_ERROR=4]="CONNECT_ERROR",s[s.BINARY_EVENT=5]="BINARY_EVENT",s[s.BINARY_ACK=6]="BINARY_ACK"})(Qe||(Qe={}));class pC{constructor(e){this.replacer=e}encode(e){return(e.type===Qe.EVENT||e.type===Qe.ACK)&&xa(e)?this.encodeAsBinary({type:e.type===Qe.EVENT?Qe.BINARY_EVENT:Qe.BINARY_ACK,nsp:e.nsp,data:e.data,id:e.id}):[this.encodeAsString(e)]}encodeAsString(e){let t=""+e.type;return(e.type===Qe.BINARY_EVENT||e.type===Qe.BINARY_ACK)&&(t+=e.attachments+"-"),e.nsp&&e.nsp!=="/"&&(t+=e.nsp+","),e.id!=null&&(t+=e.id),e.data!=null&&(t+=JSON.stringify(e.data,this.replacer)),t}encodeAsBinary(e){const t=lC(e),n=this.encodeAsString(t.packet),i=t.buffers;return i.unshift(n),i}}function Kd(s){return Object.prototype.toString.call(s)==="[object Object]"}class Fu extends Rt{constructor(e){super(),this.reviver=e}add(e){let t;if(typeof e=="string"){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");t=this.decodeString(e);const n=t.type===Qe.BINARY_EVENT;n||t.type===Qe.BINARY_ACK?(t.type=n?Qe.EVENT:Qe.ACK,this.reconstructor=new mC(t),t.attachments===0&&super.emitReserved("decoded",t)):super.emitReserved("decoded",t)}else if(Bu(e)||e.base64)if(this.reconstructor)t=this.reconstructor.takeBinaryData(e),t&&(this.reconstructor=null,super.emitReserved("decoded",t));else throw new Error("got binary data when not reconstructing a packet");else throw new Error("Unknown type: "+e)}decodeString(e){let t=0;const n={type:Number(e.charAt(0))};if(Qe[n.type]===void 0)throw new Error("unknown packet type "+n.type);if(n.type===Qe.BINARY_EVENT||n.type===Qe.BINARY_ACK){const r=t+1;for(;e.charAt(++t)!=="-"&&t!=e.length;);const a=e.substring(r,t);if(a!=Number(a)||e.charAt(t)!=="-")throw new Error("Illegal attachments");n.attachments=Number(a)}if(e.charAt(t+1)==="/"){const r=t+1;for(;++t&&!(e.charAt(t)===","||t===e.length););n.nsp=e.substring(r,t)}else n.nsp="/";const i=e.charAt(t+1);if(i!==""&&Number(i)==i){const r=t+1;for(;++t;){const a=e.charAt(t);if(a==null||Number(a)!=a){--t;break}if(t===e.length)break}n.id=Number(e.substring(r,t+1))}if(e.charAt(++t)){const r=this.tryParse(e.substr(t));if(Fu.isPayloadValid(n.type,r))n.data=r;else throw new Error("invalid payload")}return n}tryParse(e){try{return JSON.parse(e,this.reviver)}catch{return!1}}static isPayloadValid(e,t){switch(e){case Qe.CONNECT:return Kd(t);case Qe.DISCONNECT:return t===void 0;case Qe.CONNECT_ERROR:return typeof t=="string"||Kd(t);case Qe.EVENT:case Qe.BINARY_EVENT:return Array.isArray(t)&&(typeof t[0]=="number"||typeof t[0]=="string"&&dC.indexOf(t[0])===-1);case Qe.ACK:case Qe.BINARY_ACK:return Array.isArray(t)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}}class mC{constructor(e){this.packet=e,this.buffers=[],this.reconPack=e}takeBinaryData(e){if(this.buffers.push(e),this.buffers.length===this.reconPack.attachments){const t=hC(this.reconPack,this.buffers);return this.finishedReconstruction(),t}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}const yC=Object.freeze(Object.defineProperty({__proto__:null,Decoder:Fu,Encoder:pC,get PacketType(){return Qe},protocol:fC},Symbol.toStringTag,{value:"Module"}));function $n(s,e,t){return s.on(e,t),function(){s.off(e,t)}}const gC=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class lp extends Rt{constructor(e,t,n){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=e,this.nsp=t,n&&n.auth&&(this.auth=n.auth),this._opts=Object.assign({},n),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const e=this.io;this.subs=[$n(e,"open",this.onopen.bind(this)),$n(e,"packet",this.onpacket.bind(this)),$n(e,"error",this.onerror.bind(this)),$n(e,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected?this:(this.subEvents(),this.io._reconnecting||this.io.open(),this.io._readyState==="open"&&this.onopen(),this)}open(){return this.connect()}send(...e){return e.unshift("message"),this.emit.apply(this,e),this}emit(e,...t){var n,i,r;if(gC.hasOwnProperty(e))throw new Error('"'+e.toString()+'" is a reserved event name');if(t.unshift(e),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(t),this;const a={type:Qe.EVENT,data:t};if(a.options={},a.options.compress=this.flags.compress!==!1,typeof t[t.length-1]=="function"){const f=this.ids++,p=t.pop();this._registerAckCallback(f,p),a.id=f}const c=(i=(n=this.io.engine)===null||n===void 0?void 0:n.transport)===null||i===void 0?void 0:i.writable,l=this.connected&&!(!((r=this.io.engine)===null||r===void 0)&&r._hasPingExpired());return this.flags.volatile&&!c||(l?(this.notifyOutgoingListeners(a),this.packet(a)):this.sendBuffer.push(a)),this.flags={},this}_registerAckCallback(e,t){var n;const i=(n=this.flags.timeout)!==null&&n!==void 0?n:this._opts.ackTimeout;if(i===void 0){this.acks[e]=t;return}const r=this.io.setTimeoutFn(()=>{delete this.acks[e];for(let c=0;c<this.sendBuffer.length;c++)this.sendBuffer[c].id===e&&this.sendBuffer.splice(c,1);t.call(this,new Error("operation has timed out"))},i),a=(...c)=>{this.io.clearTimeoutFn(r),t.apply(this,c)};a.withError=!0,this.acks[e]=a}emitWithAck(e,...t){return new Promise((n,i)=>{const r=(a,c)=>a?i(a):n(c);r.withError=!0,t.push(r),this.emit(e,...t)})}_addToQueue(e){let t;typeof e[e.length-1]=="function"&&(t=e.pop());const n={id:this._queueSeq++,tryCount:0,pending:!1,args:e,flags:Object.assign({fromQueue:!0},this.flags)};e.push((i,...r)=>n!==this._queue[0]?void 0:(i!==null?n.tryCount>this._opts.retries&&(this._queue.shift(),t&&t(i)):(this._queue.shift(),t&&t(null,...r)),n.pending=!1,this._drainQueue())),this._queue.push(n),this._drainQueue()}_drainQueue(e=!1){if(!this.connected||this._queue.length===0)return;const t=this._queue[0];t.pending&&!e||(t.pending=!0,t.tryCount++,this.flags=t.flags,this.emit.apply(this,t.args))}packet(e){e.nsp=this.nsp,this.io._packet(e)}onopen(){typeof this.auth=="function"?this.auth(e=>{this._sendConnectPacket(e)}):this._sendConnectPacket(this.auth)}_sendConnectPacket(e){this.packet({type:Qe.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},e):e})}onerror(e){this.connected||this.emitReserved("connect_error",e)}onclose(e,t){this.connected=!1,delete this.id,this.emitReserved("disconnect",e,t),this._clearAcks()}_clearAcks(){Object.keys(this.acks).forEach(e=>{if(!this.sendBuffer.some(n=>String(n.id)===e)){const n=this.acks[e];delete this.acks[e],n.withError&&n.call(this,new Error("socket has been disconnected"))}})}onpacket(e){if(e.nsp===this.nsp)switch(e.type){case Qe.CONNECT:e.data&&e.data.sid?this.onconnect(e.data.sid,e.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case Qe.EVENT:case Qe.BINARY_EVENT:this.onevent(e);break;case Qe.ACK:case Qe.BINARY_ACK:this.onack(e);break;case Qe.DISCONNECT:this.ondisconnect();break;case Qe.CONNECT_ERROR:this.destroy();const n=new Error(e.data.message);n.data=e.data.data,this.emitReserved("connect_error",n);break}}onevent(e){const t=e.data||[];e.id!=null&&t.push(this.ack(e.id)),this.connected?this.emitEvent(t):this.receiveBuffer.push(Object.freeze(t))}emitEvent(e){if(this._anyListeners&&this._anyListeners.length){const t=this._anyListeners.slice();for(const n of t)n.apply(this,e)}super.emit.apply(this,e),this._pid&&e.length&&typeof e[e.length-1]=="string"&&(this._lastOffset=e[e.length-1])}ack(e){const t=this;let n=!1;return function(...i){n||(n=!0,t.packet({type:Qe.ACK,id:e,data:i}))}}onack(e){const t=this.acks[e.id];typeof t=="function"&&(delete this.acks[e.id],t.withError&&e.data.unshift(null),t.apply(this,e.data))}onconnect(e,t){this.id=e,this.recovered=t&&this._pid===t,this._pid=t,this.connected=!0,this.emitBuffered(),this.emitReserved("connect"),this._drainQueue(!0)}emitBuffered(){this.receiveBuffer.forEach(e=>this.emitEvent(e)),this.receiveBuffer=[],this.sendBuffer.forEach(e=>{this.notifyOutgoingListeners(e),this.packet(e)}),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach(e=>e()),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:Qe.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(e){return this.flags.compress=e,this}get volatile(){return this.flags.volatile=!0,this}timeout(e){return this.flags.timeout=e,this}onAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(e),this}prependAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(e),this}offAny(e){if(!this._anyListeners)return this;if(e){const t=this._anyListeners;for(let n=0;n<t.length;n++)if(e===t[n])return t.splice(n,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(e),this}prependAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(e),this}offAnyOutgoing(e){if(!this._anyOutgoingListeners)return this;if(e){const t=this._anyOutgoingListeners;for(let n=0;n<t.length;n++)if(e===t[n])return t.splice(n,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(e){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const t=this._anyOutgoingListeners.slice();for(const n of t)n.apply(this,e.data)}}}function Br(s){s=s||{},this.ms=s.min||100,this.max=s.max||1e4,this.factor=s.factor||2,this.jitter=s.jitter>0&&s.jitter<=1?s.jitter:0,this.attempts=0}Br.prototype.duration=function(){var s=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var e=Math.random(),t=Math.floor(e*this.jitter*s);s=Math.floor(e*10)&1?s+t:s-t}return Math.min(s,this.max)|0};Br.prototype.reset=function(){this.attempts=0};Br.prototype.setMin=function(s){this.ms=s};Br.prototype.setMax=function(s){this.max=s};Br.prototype.setJitter=function(s){this.jitter=s};class du extends Rt{constructor(e,t){var n;super(),this.nsps={},this.subs=[],e&&typeof e=="object"&&(t=e,e=void 0),t=t||{},t.path=t.path||"/socket.io",this.opts=t,Za(this,t),this.reconnection(t.reconnection!==!1),this.reconnectionAttempts(t.reconnectionAttempts||1/0),this.reconnectionDelay(t.reconnectionDelay||1e3),this.reconnectionDelayMax(t.reconnectionDelayMax||5e3),this.randomizationFactor((n=t.randomizationFactor)!==null&&n!==void 0?n:.5),this.backoff=new Br({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(t.timeout==null?2e4:t.timeout),this._readyState="closed",this.uri=e;const i=t.parser||yC;this.encoder=new i.Encoder,this.decoder=new i.Decoder,this._autoConnect=t.autoConnect!==!1,this._autoConnect&&this.open()}reconnection(e){return arguments.length?(this._reconnection=!!e,e||(this.skipReconnect=!0),this):this._reconnection}reconnectionAttempts(e){return e===void 0?this._reconnectionAttempts:(this._reconnectionAttempts=e,this)}reconnectionDelay(e){var t;return e===void 0?this._reconnectionDelay:(this._reconnectionDelay=e,(t=this.backoff)===null||t===void 0||t.setMin(e),this)}randomizationFactor(e){var t;return e===void 0?this._randomizationFactor:(this._randomizationFactor=e,(t=this.backoff)===null||t===void 0||t.setJitter(e),this)}reconnectionDelayMax(e){var t;return e===void 0?this._reconnectionDelayMax:(this._reconnectionDelayMax=e,(t=this.backoff)===null||t===void 0||t.setMax(e),this)}timeout(e){return arguments.length?(this._timeout=e,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&this.backoff.attempts===0&&this.reconnect()}open(e){if(~this._readyState.indexOf("open"))return this;this.engine=new rC(this.uri,this.opts);const t=this.engine,n=this;this._readyState="opening",this.skipReconnect=!1;const i=$n(t,"open",function(){n.onopen(),e&&e()}),r=c=>{this.cleanup(),this._readyState="closed",this.emitReserved("error",c),e?e(c):this.maybeReconnectOnOpen()},a=$n(t,"error",r);if(this._timeout!==!1){const c=this._timeout,l=this.setTimeoutFn(()=>{i(),r(new Error("timeout")),t.close()},c);this.opts.autoUnref&&l.unref(),this.subs.push(()=>{this.clearTimeoutFn(l)})}return this.subs.push(i),this.subs.push(a),this}connect(e){return this.open(e)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");const e=this.engine;this.subs.push($n(e,"ping",this.onping.bind(this)),$n(e,"data",this.ondata.bind(this)),$n(e,"error",this.onerror.bind(this)),$n(e,"close",this.onclose.bind(this)),$n(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(e){try{this.decoder.add(e)}catch(t){this.onclose("parse error",t)}}ondecoded(e){Xa(()=>{this.emitReserved("packet",e)},this.setTimeoutFn)}onerror(e){this.emitReserved("error",e)}socket(e,t){let n=this.nsps[e];return n?this._autoConnect&&!n.active&&n.connect():(n=new lp(this,e,t),this.nsps[e]=n),n}_destroy(e){const t=Object.keys(this.nsps);for(const n of t)if(this.nsps[n].active)return;this._close()}_packet(e){const t=this.encoder.encode(e);for(let n=0;n<t.length;n++)this.engine.write(t[n],e.options)}cleanup(){this.subs.forEach(e=>e()),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close")}disconnect(){return this._close()}onclose(e,t){var n;this.cleanup(),(n=this.engine)===null||n===void 0||n.close(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",e,t),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const e=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{const t=this.backoff.duration();this._reconnecting=!0;const n=this.setTimeoutFn(()=>{e.skipReconnect||(this.emitReserved("reconnect_attempt",e.backoff.attempts),!e.skipReconnect&&e.open(i=>{i?(e._reconnecting=!1,e.reconnect(),this.emitReserved("reconnect_error",i)):e.onreconnect()}))},t);this.opts.autoUnref&&n.unref(),this.subs.push(()=>{this.clearTimeoutFn(n)})}}onreconnect(){const e=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",e)}}const as={};function kc(s,e){typeof s=="object"&&(e=s,s=void 0),e=e||{};const t=sC(s,e.path||"/socket.io"),n=t.source,i=t.id,r=t.path,a=as[i]&&r in as[i].nsps,c=e.forceNew||e["force new connection"]||e.multiplex===!1||a;let l;return c?l=new du(n,e):(as[i]||(as[i]=new du(n,e)),l=as[i]),t.query&&!e.query&&(e.query=t.queryKey),l.socket(t.path,e)}Object.assign(kc,{Manager:du,Socket:lp,io:kc,connect:kc});const qa=()=>typeof window<"u"&&typeof document<"u"?"serviceWorker"in navigator||window.matchMedia("(display-mode: standalone)").matches||window.location.protocol==="file:"?"pwa":"browser":typeof process<"u"&&process.versions!=null&&process.versions.node!=null?process.argv[1]?"cli":"node":"unknown",Jd=qa(),ki=Jd==="browser"||Jd==="pwa",EC={env:{NODE_ENV:ki?"production":"development"},version:ki?"v18.0.0":process.version,versions:ki?{node:"18.0.0"}:process.versions,platform:ki?"browser":process.platform,arch:ki?"x64":process.arch,cwd:()=>ki?"/":process.cwd(),nextTick:ki?(s,...e)=>Promise.resolve().then(()=>s(...e)):process.nextTick};ki&&typeof window<"u"&&(window.process=EC);var Ba={exports:{}};/**
 * @license
 * Lodash <https://lodash.com/>
 * Copyright OpenJS Foundation and other contributors <https://openjsf.org/>
 * Released under MIT license <https://lodash.com/license>
 * Based on Underscore.js 1.8.3 <http://underscorejs.org/LICENSE>
 * Copyright Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
 */Ba.exports;(function(s,e){(function(){var t,n="4.17.21",i=200,r="Unsupported core-js use. Try https://npms.io/search?q=ponyfill.",a="Expected a function",c="Invalid `variable` option passed into `_.template`",l="__lodash_hash_undefined__",h=500,f="__lodash_placeholder__",p=1,m=2,T=4,A=1,S=2,P=1,F=2,B=4,q=8,Z=16,re=32,Ee=64,Se=128,me=256,W=512,Re=30,D="...",se=800,V=16,ne=1,ce=2,ye=3,oe=1/0,Te=9007199254740991,Xe=17976931348623157e292,Ge=NaN,qe=4294967295,tt=qe-1,k=qe>>>1,Y=[["ary",Se],["bind",P],["bindKey",F],["curry",q],["curryRight",Z],["flip",W],["partial",re],["partialRight",Ee],["rearg",me]],X="[object Arguments]",de="[object Array]",Me="[object AsyncFunction]",_e="[object Boolean]",xe="[object Date]",Fe="[object DOMException]",We="[object Error]",yt="[object Function]",Dt="[object GeneratorFunction]",Et="[object Map]",zt="[object Number]",vi="[object Null]",Wt="[object Object]",hr="[object Promise]",K="[object Proxy]",Yn="[object RegExp]",It="[object Set]",Bt="[object String]",Mi="[object Symbol]",Co="[object Undefined]",Kt="[object WeakMap]",So="[object WeakSet]",b="[object ArrayBuffer]",g="[object DataView]",E="[object Float32Array]",R="[object Float64Array]",O="[object Int8Array]",U="[object Int16Array]",H="[object Int32Array]",De="[object Uint8Array]",ot="[object Uint8ClampedArray]",rt="[object Uint16Array]",ct="[object Uint32Array]",nt=/\b__p \+= '';/g,qm=/\b(__p \+=) '' \+/g,Bm=/(__e\(.*?\)|\b__t\)) \+\n'';/g,gl=/&(?:amp|lt|gt|quot|#39);/g,El=/[&<>"']/g,Fm=RegExp(gl.source),Um=RegExp(El.source),km=/<%-([\s\S]+?)%>/g,jm=/<%([\s\S]+?)%>/g,Tl=/<%=([\s\S]+?)%>/g,Vm=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,Qm=/^\w*$/,Wm=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,Ro=/[\\^$.*+?()[\]{}|]/g,Hm=RegExp(Ro.source),xo=/^\s+/,Ym=/\s/,Gm=/\{(?:\n\/\* \[wrapped with .+\] \*\/)?\n?/,zm=/\{\n\/\* \[wrapped with (.+)\] \*/,Km=/,? & /,Jm=/[^\x00-\x2f\x3a-\x40\x5b-\x60\x7b-\x7f]+/g,Xm=/[()=,{}\[\]\/\s]/,Zm=/\\(\\)?/g,ey=/\$\{([^\\}]*(?:\\.[^\\}]*)*)\}/g,wl=/\w*$/,ty=/^[-+]0x[0-9a-f]+$/i,ny=/^0b[01]+$/i,iy=/^\[object .+?Constructor\]$/,ry=/^0o[0-7]+$/i,sy=/^(?:0|[1-9]\d*)$/,ay=/[\xc0-\xd6\xd8-\xf6\xf8-\xff\u0100-\u017f]/g,_s=/($^)/,oy=/['\n\r\u2028\u2029\\]/g,vs="\\ud800-\\udfff",cy="\\u0300-\\u036f",uy="\\ufe20-\\ufe2f",ly="\\u20d0-\\u20ff",bl=cy+uy+ly,Nl="\\u2700-\\u27bf",Al="a-z\\xdf-\\xf6\\xf8-\\xff",hy="\\xac\\xb1\\xd7\\xf7",dy="\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf",fy="\\u2000-\\u206f",py=" \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000",Cl="A-Z\\xc0-\\xd6\\xd8-\\xde",Sl="\\ufe0e\\ufe0f",Rl=hy+dy+fy+py,_o="['’]",my="["+vs+"]",xl="["+Rl+"]",Ms="["+bl+"]",_l="\\d+",yy="["+Nl+"]",vl="["+Al+"]",Ml="[^"+vs+Rl+_l+Nl+Al+Cl+"]",vo="\\ud83c[\\udffb-\\udfff]",gy="(?:"+Ms+"|"+vo+")",Pl="[^"+vs+"]",Mo="(?:\\ud83c[\\udde6-\\uddff]){2}",Po="[\\ud800-\\udbff][\\udc00-\\udfff]",dr="["+Cl+"]",Ol="\\u200d",Dl="(?:"+vl+"|"+Ml+")",Ey="(?:"+dr+"|"+Ml+")",Il="(?:"+_o+"(?:d|ll|m|re|s|t|ve))?",$l="(?:"+_o+"(?:D|LL|M|RE|S|T|VE))?",Ll=gy+"?",ql="["+Sl+"]?",Ty="(?:"+Ol+"(?:"+[Pl,Mo,Po].join("|")+")"+ql+Ll+")*",wy="\\d*(?:1st|2nd|3rd|(?![123])\\dth)(?=\\b|[A-Z_])",by="\\d*(?:1ST|2ND|3RD|(?![123])\\dTH)(?=\\b|[a-z_])",Bl=ql+Ll+Ty,Ny="(?:"+[yy,Mo,Po].join("|")+")"+Bl,Ay="(?:"+[Pl+Ms+"?",Ms,Mo,Po,my].join("|")+")",Cy=RegExp(_o,"g"),Sy=RegExp(Ms,"g"),Oo=RegExp(vo+"(?="+vo+")|"+Ay+Bl,"g"),Ry=RegExp([dr+"?"+vl+"+"+Il+"(?="+[xl,dr,"$"].join("|")+")",Ey+"+"+$l+"(?="+[xl,dr+Dl,"$"].join("|")+")",dr+"?"+Dl+"+"+Il,dr+"+"+$l,by,wy,_l,Ny].join("|"),"g"),xy=RegExp("["+Ol+vs+bl+Sl+"]"),_y=/[a-z][A-Z]|[A-Z]{2}[a-z]|[0-9][a-zA-Z]|[a-zA-Z][0-9]|[^a-zA-Z0-9 ]/,vy=["Array","Buffer","DataView","Date","Error","Float32Array","Float64Array","Function","Int8Array","Int16Array","Int32Array","Map","Math","Object","Promise","RegExp","Set","String","Symbol","TypeError","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","WeakMap","_","clearTimeout","isFinite","parseInt","setTimeout"],My=-1,lt={};lt[E]=lt[R]=lt[O]=lt[U]=lt[H]=lt[De]=lt[ot]=lt[rt]=lt[ct]=!0,lt[X]=lt[de]=lt[b]=lt[_e]=lt[g]=lt[xe]=lt[We]=lt[yt]=lt[Et]=lt[zt]=lt[Wt]=lt[Yn]=lt[It]=lt[Bt]=lt[Kt]=!1;var ut={};ut[X]=ut[de]=ut[b]=ut[g]=ut[_e]=ut[xe]=ut[E]=ut[R]=ut[O]=ut[U]=ut[H]=ut[Et]=ut[zt]=ut[Wt]=ut[Yn]=ut[It]=ut[Bt]=ut[Mi]=ut[De]=ut[ot]=ut[rt]=ut[ct]=!0,ut[We]=ut[yt]=ut[Kt]=!1;var Py={À:"A",Á:"A",Â:"A",Ã:"A",Ä:"A",Å:"A",à:"a",á:"a",â:"a",ã:"a",ä:"a",å:"a",Ç:"C",ç:"c",Ð:"D",ð:"d",È:"E",É:"E",Ê:"E",Ë:"E",è:"e",é:"e",ê:"e",ë:"e",Ì:"I",Í:"I",Î:"I",Ï:"I",ì:"i",í:"i",î:"i",ï:"i",Ñ:"N",ñ:"n",Ò:"O",Ó:"O",Ô:"O",Õ:"O",Ö:"O",Ø:"O",ò:"o",ó:"o",ô:"o",õ:"o",ö:"o",ø:"o",Ù:"U",Ú:"U",Û:"U",Ü:"U",ù:"u",ú:"u",û:"u",ü:"u",Ý:"Y",ý:"y",ÿ:"y",Æ:"Ae",æ:"ae",Þ:"Th",þ:"th",ß:"ss",Ā:"A",Ă:"A",Ą:"A",ā:"a",ă:"a",ą:"a",Ć:"C",Ĉ:"C",Ċ:"C",Č:"C",ć:"c",ĉ:"c",ċ:"c",č:"c",Ď:"D",Đ:"D",ď:"d",đ:"d",Ē:"E",Ĕ:"E",Ė:"E",Ę:"E",Ě:"E",ē:"e",ĕ:"e",ė:"e",ę:"e",ě:"e",Ĝ:"G",Ğ:"G",Ġ:"G",Ģ:"G",ĝ:"g",ğ:"g",ġ:"g",ģ:"g",Ĥ:"H",Ħ:"H",ĥ:"h",ħ:"h",Ĩ:"I",Ī:"I",Ĭ:"I",Į:"I",İ:"I",ĩ:"i",ī:"i",ĭ:"i",į:"i",ı:"i",Ĵ:"J",ĵ:"j",Ķ:"K",ķ:"k",ĸ:"k",Ĺ:"L",Ļ:"L",Ľ:"L",Ŀ:"L",Ł:"L",ĺ:"l",ļ:"l",ľ:"l",ŀ:"l",ł:"l",Ń:"N",Ņ:"N",Ň:"N",Ŋ:"N",ń:"n",ņ:"n",ň:"n",ŋ:"n",Ō:"O",Ŏ:"O",Ő:"O",ō:"o",ŏ:"o",ő:"o",Ŕ:"R",Ŗ:"R",Ř:"R",ŕ:"r",ŗ:"r",ř:"r",Ś:"S",Ŝ:"S",Ş:"S",Š:"S",ś:"s",ŝ:"s",ş:"s",š:"s",Ţ:"T",Ť:"T",Ŧ:"T",ţ:"t",ť:"t",ŧ:"t",Ũ:"U",Ū:"U",Ŭ:"U",Ů:"U",Ű:"U",Ų:"U",ũ:"u",ū:"u",ŭ:"u",ů:"u",ű:"u",ų:"u",Ŵ:"W",ŵ:"w",Ŷ:"Y",ŷ:"y",Ÿ:"Y",Ź:"Z",Ż:"Z",Ž:"Z",ź:"z",ż:"z",ž:"z",Ĳ:"IJ",ĳ:"ij",Œ:"Oe",œ:"oe",ŉ:"'n",ſ:"s"},Oy={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},Dy={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"},Iy={"\\":"\\","'":"'","\n":"n","\r":"r","\u2028":"u2028","\u2029":"u2029"},$y=parseFloat,Ly=parseInt,Fl=typeof ir=="object"&&ir&&ir.Object===Object&&ir,qy=typeof self=="object"&&self&&self.Object===Object&&self,$t=Fl||qy||Function("return this")(),Do=e&&!e.nodeType&&e,Yi=Do&&!0&&s&&!s.nodeType&&s,Ul=Yi&&Yi.exports===Do,Io=Ul&&Fl.process,dn=function(){try{var I=Yi&&Yi.require&&Yi.require("util").types;return I||Io&&Io.binding&&Io.binding("util")}catch{}}(),kl=dn&&dn.isArrayBuffer,jl=dn&&dn.isDate,Vl=dn&&dn.isMap,Ql=dn&&dn.isRegExp,Wl=dn&&dn.isSet,Hl=dn&&dn.isTypedArray;function rn(I,Q,j){switch(j.length){case 0:return I.call(Q);case 1:return I.call(Q,j[0]);case 2:return I.call(Q,j[0],j[1]);case 3:return I.call(Q,j[0],j[1],j[2])}return I.apply(Q,j)}function By(I,Q,j,le){for(var Pe=-1,Ze=I==null?0:I.length;++Pe<Ze;){var xt=I[Pe];Q(le,xt,j(xt),I)}return le}function fn(I,Q){for(var j=-1,le=I==null?0:I.length;++j<le&&Q(I[j],j,I)!==!1;);return I}function Fy(I,Q){for(var j=I==null?0:I.length;j--&&Q(I[j],j,I)!==!1;);return I}function Yl(I,Q){for(var j=-1,le=I==null?0:I.length;++j<le;)if(!Q(I[j],j,I))return!1;return!0}function Pi(I,Q){for(var j=-1,le=I==null?0:I.length,Pe=0,Ze=[];++j<le;){var xt=I[j];Q(xt,j,I)&&(Ze[Pe++]=xt)}return Ze}function Ps(I,Q){var j=I==null?0:I.length;return!!j&&fr(I,Q,0)>-1}function $o(I,Q,j){for(var le=-1,Pe=I==null?0:I.length;++le<Pe;)if(j(Q,I[le]))return!0;return!1}function ft(I,Q){for(var j=-1,le=I==null?0:I.length,Pe=Array(le);++j<le;)Pe[j]=Q(I[j],j,I);return Pe}function Oi(I,Q){for(var j=-1,le=Q.length,Pe=I.length;++j<le;)I[Pe+j]=Q[j];return I}function Lo(I,Q,j,le){var Pe=-1,Ze=I==null?0:I.length;for(le&&Ze&&(j=I[++Pe]);++Pe<Ze;)j=Q(j,I[Pe],Pe,I);return j}function Uy(I,Q,j,le){var Pe=I==null?0:I.length;for(le&&Pe&&(j=I[--Pe]);Pe--;)j=Q(j,I[Pe],Pe,I);return j}function qo(I,Q){for(var j=-1,le=I==null?0:I.length;++j<le;)if(Q(I[j],j,I))return!0;return!1}var ky=Bo("length");function jy(I){return I.split("")}function Vy(I){return I.match(Jm)||[]}function Gl(I,Q,j){var le;return j(I,function(Pe,Ze,xt){if(Q(Pe,Ze,xt))return le=Ze,!1}),le}function Os(I,Q,j,le){for(var Pe=I.length,Ze=j+(le?1:-1);le?Ze--:++Ze<Pe;)if(Q(I[Ze],Ze,I))return Ze;return-1}function fr(I,Q,j){return Q===Q?tg(I,Q,j):Os(I,zl,j)}function Qy(I,Q,j,le){for(var Pe=j-1,Ze=I.length;++Pe<Ze;)if(le(I[Pe],Q))return Pe;return-1}function zl(I){return I!==I}function Kl(I,Q){var j=I==null?0:I.length;return j?Uo(I,Q)/j:Ge}function Bo(I){return function(Q){return Q==null?t:Q[I]}}function Fo(I){return function(Q){return I==null?t:I[Q]}}function Jl(I,Q,j,le,Pe){return Pe(I,function(Ze,xt,at){j=le?(le=!1,Ze):Q(j,Ze,xt,at)}),j}function Wy(I,Q){var j=I.length;for(I.sort(Q);j--;)I[j]=I[j].value;return I}function Uo(I,Q){for(var j,le=-1,Pe=I.length;++le<Pe;){var Ze=Q(I[le]);Ze!==t&&(j=j===t?Ze:j+Ze)}return j}function ko(I,Q){for(var j=-1,le=Array(I);++j<I;)le[j]=Q(j);return le}function Hy(I,Q){return ft(Q,function(j){return[j,I[j]]})}function Xl(I){return I&&I.slice(0,nh(I)+1).replace(xo,"")}function sn(I){return function(Q){return I(Q)}}function jo(I,Q){return ft(Q,function(j){return I[j]})}function Wr(I,Q){return I.has(Q)}function Zl(I,Q){for(var j=-1,le=I.length;++j<le&&fr(Q,I[j],0)>-1;);return j}function eh(I,Q){for(var j=I.length;j--&&fr(Q,I[j],0)>-1;);return j}function Yy(I,Q){for(var j=I.length,le=0;j--;)I[j]===Q&&++le;return le}var Gy=Fo(Py),zy=Fo(Oy);function Ky(I){return"\\"+Iy[I]}function Jy(I,Q){return I==null?t:I[Q]}function pr(I){return xy.test(I)}function Xy(I){return _y.test(I)}function Zy(I){for(var Q,j=[];!(Q=I.next()).done;)j.push(Q.value);return j}function Vo(I){var Q=-1,j=Array(I.size);return I.forEach(function(le,Pe){j[++Q]=[Pe,le]}),j}function th(I,Q){return function(j){return I(Q(j))}}function Di(I,Q){for(var j=-1,le=I.length,Pe=0,Ze=[];++j<le;){var xt=I[j];(xt===Q||xt===f)&&(I[j]=f,Ze[Pe++]=j)}return Ze}function Ds(I){var Q=-1,j=Array(I.size);return I.forEach(function(le){j[++Q]=le}),j}function eg(I){var Q=-1,j=Array(I.size);return I.forEach(function(le){j[++Q]=[le,le]}),j}function tg(I,Q,j){for(var le=j-1,Pe=I.length;++le<Pe;)if(I[le]===Q)return le;return-1}function ng(I,Q,j){for(var le=j+1;le--;)if(I[le]===Q)return le;return le}function mr(I){return pr(I)?rg(I):ky(I)}function Mn(I){return pr(I)?sg(I):jy(I)}function nh(I){for(var Q=I.length;Q--&&Ym.test(I.charAt(Q)););return Q}var ig=Fo(Dy);function rg(I){for(var Q=Oo.lastIndex=0;Oo.test(I);)++Q;return Q}function sg(I){return I.match(Oo)||[]}function ag(I){return I.match(Ry)||[]}var og=function I(Q){Q=Q==null?$t:yr.defaults($t.Object(),Q,yr.pick($t,vy));var j=Q.Array,le=Q.Date,Pe=Q.Error,Ze=Q.Function,xt=Q.Math,at=Q.Object,Qo=Q.RegExp,cg=Q.String,pn=Q.TypeError,Is=j.prototype,ug=Ze.prototype,gr=at.prototype,$s=Q["__core-js_shared__"],Ls=ug.toString,it=gr.hasOwnProperty,lg=0,ih=function(){var o=/[^.]+$/.exec($s&&$s.keys&&$s.keys.IE_PROTO||"");return o?"Symbol(src)_1."+o:""}(),qs=gr.toString,hg=Ls.call(at),dg=$t._,fg=Qo("^"+Ls.call(it).replace(Ro,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),Bs=Ul?Q.Buffer:t,Ii=Q.Symbol,Fs=Q.Uint8Array,rh=Bs?Bs.allocUnsafe:t,Us=th(at.getPrototypeOf,at),sh=at.create,ah=gr.propertyIsEnumerable,ks=Is.splice,oh=Ii?Ii.isConcatSpreadable:t,Hr=Ii?Ii.iterator:t,Gi=Ii?Ii.toStringTag:t,js=function(){try{var o=Zi(at,"defineProperty");return o({},"",{}),o}catch{}}(),pg=Q.clearTimeout!==$t.clearTimeout&&Q.clearTimeout,mg=le&&le.now!==$t.Date.now&&le.now,yg=Q.setTimeout!==$t.setTimeout&&Q.setTimeout,Vs=xt.ceil,Qs=xt.floor,Wo=at.getOwnPropertySymbols,gg=Bs?Bs.isBuffer:t,ch=Q.isFinite,Eg=Is.join,Tg=th(at.keys,at),_t=xt.max,Ft=xt.min,wg=le.now,bg=Q.parseInt,uh=xt.random,Ng=Is.reverse,Ho=Zi(Q,"DataView"),Yr=Zi(Q,"Map"),Yo=Zi(Q,"Promise"),Er=Zi(Q,"Set"),Gr=Zi(Q,"WeakMap"),zr=Zi(at,"create"),Ws=Gr&&new Gr,Tr={},Ag=er(Ho),Cg=er(Yr),Sg=er(Yo),Rg=er(Er),xg=er(Gr),Hs=Ii?Ii.prototype:t,Kr=Hs?Hs.valueOf:t,lh=Hs?Hs.toString:t;function N(o){if(Tt(o)&&!Oe(o)&&!(o instanceof ke)){if(o instanceof mn)return o;if(it.call(o,"__wrapped__"))return hd(o)}return new mn(o)}var wr=function(){function o(){}return function(u){if(!gt(u))return{};if(sh)return sh(u);o.prototype=u;var d=new o;return o.prototype=t,d}}();function Ys(){}function mn(o,u){this.__wrapped__=o,this.__actions__=[],this.__chain__=!!u,this.__index__=0,this.__values__=t}N.templateSettings={escape:km,evaluate:jm,interpolate:Tl,variable:"",imports:{_:N}},N.prototype=Ys.prototype,N.prototype.constructor=N,mn.prototype=wr(Ys.prototype),mn.prototype.constructor=mn;function ke(o){this.__wrapped__=o,this.__actions__=[],this.__dir__=1,this.__filtered__=!1,this.__iteratees__=[],this.__takeCount__=qe,this.__views__=[]}function _g(){var o=new ke(this.__wrapped__);return o.__actions__=Jt(this.__actions__),o.__dir__=this.__dir__,o.__filtered__=this.__filtered__,o.__iteratees__=Jt(this.__iteratees__),o.__takeCount__=this.__takeCount__,o.__views__=Jt(this.__views__),o}function vg(){if(this.__filtered__){var o=new ke(this);o.__dir__=-1,o.__filtered__=!0}else o=this.clone(),o.__dir__*=-1;return o}function Mg(){var o=this.__wrapped__.value(),u=this.__dir__,d=Oe(o),y=u<0,w=d?o.length:0,C=jE(0,w,this.__views__),v=C.start,M=C.end,L=M-v,G=y?M:v-1,z=this.__iteratees__,J=z.length,ae=0,fe=Ft(L,this.__takeCount__);if(!d||!y&&w==L&&fe==L)return Ih(o,this.__actions__);var Ne=[];e:for(;L--&&ae<fe;){G+=u;for(var Le=-1,Ae=o[G];++Le<J;){var Ue=z[Le],Ve=Ue.iteratee,cn=Ue.type,Gt=Ve(Ae);if(cn==ce)Ae=Gt;else if(!Gt){if(cn==ne)continue e;break e}}Ne[ae++]=Ae}return Ne}ke.prototype=wr(Ys.prototype),ke.prototype.constructor=ke;function zi(o){var u=-1,d=o==null?0:o.length;for(this.clear();++u<d;){var y=o[u];this.set(y[0],y[1])}}function Pg(){this.__data__=zr?zr(null):{},this.size=0}function Og(o){var u=this.has(o)&&delete this.__data__[o];return this.size-=u?1:0,u}function Dg(o){var u=this.__data__;if(zr){var d=u[o];return d===l?t:d}return it.call(u,o)?u[o]:t}function Ig(o){var u=this.__data__;return zr?u[o]!==t:it.call(u,o)}function $g(o,u){var d=this.__data__;return this.size+=this.has(o)?0:1,d[o]=zr&&u===t?l:u,this}zi.prototype.clear=Pg,zi.prototype.delete=Og,zi.prototype.get=Dg,zi.prototype.has=Ig,zi.prototype.set=$g;function ci(o){var u=-1,d=o==null?0:o.length;for(this.clear();++u<d;){var y=o[u];this.set(y[0],y[1])}}function Lg(){this.__data__=[],this.size=0}function qg(o){var u=this.__data__,d=Gs(u,o);if(d<0)return!1;var y=u.length-1;return d==y?u.pop():ks.call(u,d,1),--this.size,!0}function Bg(o){var u=this.__data__,d=Gs(u,o);return d<0?t:u[d][1]}function Fg(o){return Gs(this.__data__,o)>-1}function Ug(o,u){var d=this.__data__,y=Gs(d,o);return y<0?(++this.size,d.push([o,u])):d[y][1]=u,this}ci.prototype.clear=Lg,ci.prototype.delete=qg,ci.prototype.get=Bg,ci.prototype.has=Fg,ci.prototype.set=Ug;function ui(o){var u=-1,d=o==null?0:o.length;for(this.clear();++u<d;){var y=o[u];this.set(y[0],y[1])}}function kg(){this.size=0,this.__data__={hash:new zi,map:new(Yr||ci),string:new zi}}function jg(o){var u=aa(this,o).delete(o);return this.size-=u?1:0,u}function Vg(o){return aa(this,o).get(o)}function Qg(o){return aa(this,o).has(o)}function Wg(o,u){var d=aa(this,o),y=d.size;return d.set(o,u),this.size+=d.size==y?0:1,this}ui.prototype.clear=kg,ui.prototype.delete=jg,ui.prototype.get=Vg,ui.prototype.has=Qg,ui.prototype.set=Wg;function Ki(o){var u=-1,d=o==null?0:o.length;for(this.__data__=new ui;++u<d;)this.add(o[u])}function Hg(o){return this.__data__.set(o,l),this}function Yg(o){return this.__data__.has(o)}Ki.prototype.add=Ki.prototype.push=Hg,Ki.prototype.has=Yg;function Pn(o){var u=this.__data__=new ci(o);this.size=u.size}function Gg(){this.__data__=new ci,this.size=0}function zg(o){var u=this.__data__,d=u.delete(o);return this.size=u.size,d}function Kg(o){return this.__data__.get(o)}function Jg(o){return this.__data__.has(o)}function Xg(o,u){var d=this.__data__;if(d instanceof ci){var y=d.__data__;if(!Yr||y.length<i-1)return y.push([o,u]),this.size=++d.size,this;d=this.__data__=new ui(y)}return d.set(o,u),this.size=d.size,this}Pn.prototype.clear=Gg,Pn.prototype.delete=zg,Pn.prototype.get=Kg,Pn.prototype.has=Jg,Pn.prototype.set=Xg;function hh(o,u){var d=Oe(o),y=!d&&tr(o),w=!d&&!y&&Fi(o),C=!d&&!y&&!w&&Cr(o),v=d||y||w||C,M=v?ko(o.length,cg):[],L=M.length;for(var G in o)(u||it.call(o,G))&&!(v&&(G=="length"||w&&(G=="offset"||G=="parent")||C&&(G=="buffer"||G=="byteLength"||G=="byteOffset")||fi(G,L)))&&M.push(G);return M}function dh(o){var u=o.length;return u?o[rc(0,u-1)]:t}function Zg(o,u){return oa(Jt(o),Ji(u,0,o.length))}function eE(o){return oa(Jt(o))}function Go(o,u,d){(d!==t&&!On(o[u],d)||d===t&&!(u in o))&&li(o,u,d)}function Jr(o,u,d){var y=o[u];(!(it.call(o,u)&&On(y,d))||d===t&&!(u in o))&&li(o,u,d)}function Gs(o,u){for(var d=o.length;d--;)if(On(o[d][0],u))return d;return-1}function tE(o,u,d,y){return $i(o,function(w,C,v){u(y,w,d(w),v)}),y}function fh(o,u){return o&&zn(u,Pt(u),o)}function nE(o,u){return o&&zn(u,Zt(u),o)}function li(o,u,d){u=="__proto__"&&js?js(o,u,{configurable:!0,enumerable:!0,value:d,writable:!0}):o[u]=d}function zo(o,u){for(var d=-1,y=u.length,w=j(y),C=o==null;++d<y;)w[d]=C?t:vc(o,u[d]);return w}function Ji(o,u,d){return o===o&&(d!==t&&(o=o<=d?o:d),u!==t&&(o=o>=u?o:u)),o}function yn(o,u,d,y,w,C){var v,M=u&p,L=u&m,G=u&T;if(d&&(v=w?d(o,y,w,C):d(o)),v!==t)return v;if(!gt(o))return o;var z=Oe(o);if(z){if(v=QE(o),!M)return Jt(o,v)}else{var J=Ut(o),ae=J==yt||J==Dt;if(Fi(o))return qh(o,M);if(J==Wt||J==X||ae&&!w){if(v=L||ae?{}:nd(o),!M)return L?DE(o,nE(v,o)):OE(o,fh(v,o))}else{if(!ut[J])return w?o:{};v=WE(o,J,M)}}C||(C=new Pn);var fe=C.get(o);if(fe)return fe;C.set(o,v),Pd(o)?o.forEach(function(Ae){v.add(yn(Ae,u,d,Ae,o,C))}):vd(o)&&o.forEach(function(Ae,Ue){v.set(Ue,yn(Ae,u,d,Ue,o,C))});var Ne=G?L?mc:pc:L?Zt:Pt,Le=z?t:Ne(o);return fn(Le||o,function(Ae,Ue){Le&&(Ue=Ae,Ae=o[Ue]),Jr(v,Ue,yn(Ae,u,d,Ue,o,C))}),v}function iE(o){var u=Pt(o);return function(d){return ph(d,o,u)}}function ph(o,u,d){var y=d.length;if(o==null)return!y;for(o=at(o);y--;){var w=d[y],C=u[w],v=o[w];if(v===t&&!(w in o)||!C(v))return!1}return!0}function mh(o,u,d){if(typeof o!="function")throw new pn(a);return rs(function(){o.apply(t,d)},u)}function Xr(o,u,d,y){var w=-1,C=Ps,v=!0,M=o.length,L=[],G=u.length;if(!M)return L;d&&(u=ft(u,sn(d))),y?(C=$o,v=!1):u.length>=i&&(C=Wr,v=!1,u=new Ki(u));e:for(;++w<M;){var z=o[w],J=d==null?z:d(z);if(z=y||z!==0?z:0,v&&J===J){for(var ae=G;ae--;)if(u[ae]===J)continue e;L.push(z)}else C(u,J,y)||L.push(z)}return L}var $i=jh(Gn),yh=jh(Jo,!0);function rE(o,u){var d=!0;return $i(o,function(y,w,C){return d=!!u(y,w,C),d}),d}function zs(o,u,d){for(var y=-1,w=o.length;++y<w;){var C=o[y],v=u(C);if(v!=null&&(M===t?v===v&&!on(v):d(v,M)))var M=v,L=C}return L}function sE(o,u,d,y){var w=o.length;for(d=Ie(d),d<0&&(d=-d>w?0:w+d),y=y===t||y>w?w:Ie(y),y<0&&(y+=w),y=d>y?0:Dd(y);d<y;)o[d++]=u;return o}function gh(o,u){var d=[];return $i(o,function(y,w,C){u(y,w,C)&&d.push(y)}),d}function Lt(o,u,d,y,w){var C=-1,v=o.length;for(d||(d=YE),w||(w=[]);++C<v;){var M=o[C];u>0&&d(M)?u>1?Lt(M,u-1,d,y,w):Oi(w,M):y||(w[w.length]=M)}return w}var Ko=Vh(),Eh=Vh(!0);function Gn(o,u){return o&&Ko(o,u,Pt)}function Jo(o,u){return o&&Eh(o,u,Pt)}function Ks(o,u){return Pi(u,function(d){return pi(o[d])})}function Xi(o,u){u=qi(u,o);for(var d=0,y=u.length;o!=null&&d<y;)o=o[Kn(u[d++])];return d&&d==y?o:t}function Th(o,u,d){var y=u(o);return Oe(o)?y:Oi(y,d(o))}function Ht(o){return o==null?o===t?Co:vi:Gi&&Gi in at(o)?kE(o):eT(o)}function Xo(o,u){return o>u}function aE(o,u){return o!=null&&it.call(o,u)}function oE(o,u){return o!=null&&u in at(o)}function cE(o,u,d){return o>=Ft(u,d)&&o<_t(u,d)}function Zo(o,u,d){for(var y=d?$o:Ps,w=o[0].length,C=o.length,v=C,M=j(C),L=1/0,G=[];v--;){var z=o[v];v&&u&&(z=ft(z,sn(u))),L=Ft(z.length,L),M[v]=!d&&(u||w>=120&&z.length>=120)?new Ki(v&&z):t}z=o[0];var J=-1,ae=M[0];e:for(;++J<w&&G.length<L;){var fe=z[J],Ne=u?u(fe):fe;if(fe=d||fe!==0?fe:0,!(ae?Wr(ae,Ne):y(G,Ne,d))){for(v=C;--v;){var Le=M[v];if(!(Le?Wr(Le,Ne):y(o[v],Ne,d)))continue e}ae&&ae.push(Ne),G.push(fe)}}return G}function uE(o,u,d,y){return Gn(o,function(w,C,v){u(y,d(w),C,v)}),y}function Zr(o,u,d){u=qi(u,o),o=ad(o,u);var y=o==null?o:o[Kn(En(u))];return y==null?t:rn(y,o,d)}function wh(o){return Tt(o)&&Ht(o)==X}function lE(o){return Tt(o)&&Ht(o)==b}function hE(o){return Tt(o)&&Ht(o)==xe}function es(o,u,d,y,w){return o===u?!0:o==null||u==null||!Tt(o)&&!Tt(u)?o!==o&&u!==u:dE(o,u,d,y,es,w)}function dE(o,u,d,y,w,C){var v=Oe(o),M=Oe(u),L=v?de:Ut(o),G=M?de:Ut(u);L=L==X?Wt:L,G=G==X?Wt:G;var z=L==Wt,J=G==Wt,ae=L==G;if(ae&&Fi(o)){if(!Fi(u))return!1;v=!0,z=!1}if(ae&&!z)return C||(C=new Pn),v||Cr(o)?Zh(o,u,d,y,w,C):FE(o,u,L,d,y,w,C);if(!(d&A)){var fe=z&&it.call(o,"__wrapped__"),Ne=J&&it.call(u,"__wrapped__");if(fe||Ne){var Le=fe?o.value():o,Ae=Ne?u.value():u;return C||(C=new Pn),w(Le,Ae,d,y,C)}}return ae?(C||(C=new Pn),UE(o,u,d,y,w,C)):!1}function fE(o){return Tt(o)&&Ut(o)==Et}function ec(o,u,d,y){var w=d.length,C=w,v=!y;if(o==null)return!C;for(o=at(o);w--;){var M=d[w];if(v&&M[2]?M[1]!==o[M[0]]:!(M[0]in o))return!1}for(;++w<C;){M=d[w];var L=M[0],G=o[L],z=M[1];if(v&&M[2]){if(G===t&&!(L in o))return!1}else{var J=new Pn;if(y)var ae=y(G,z,L,o,u,J);if(!(ae===t?es(z,G,A|S,y,J):ae))return!1}}return!0}function bh(o){if(!gt(o)||zE(o))return!1;var u=pi(o)?fg:iy;return u.test(er(o))}function pE(o){return Tt(o)&&Ht(o)==Yn}function mE(o){return Tt(o)&&Ut(o)==It}function yE(o){return Tt(o)&&fa(o.length)&&!!lt[Ht(o)]}function Nh(o){return typeof o=="function"?o:o==null?en:typeof o=="object"?Oe(o)?Sh(o[0],o[1]):Ch(o):Qd(o)}function tc(o){if(!is(o))return Tg(o);var u=[];for(var d in at(o))it.call(o,d)&&d!="constructor"&&u.push(d);return u}function gE(o){if(!gt(o))return ZE(o);var u=is(o),d=[];for(var y in o)y=="constructor"&&(u||!it.call(o,y))||d.push(y);return d}function nc(o,u){return o<u}function Ah(o,u){var d=-1,y=Xt(o)?j(o.length):[];return $i(o,function(w,C,v){y[++d]=u(w,C,v)}),y}function Ch(o){var u=gc(o);return u.length==1&&u[0][2]?rd(u[0][0],u[0][1]):function(d){return d===o||ec(d,o,u)}}function Sh(o,u){return Tc(o)&&id(u)?rd(Kn(o),u):function(d){var y=vc(d,o);return y===t&&y===u?Mc(d,o):es(u,y,A|S)}}function Js(o,u,d,y,w){o!==u&&Ko(u,function(C,v){if(w||(w=new Pn),gt(C))EE(o,u,v,d,Js,y,w);else{var M=y?y(bc(o,v),C,v+"",o,u,w):t;M===t&&(M=C),Go(o,v,M)}},Zt)}function EE(o,u,d,y,w,C,v){var M=bc(o,d),L=bc(u,d),G=v.get(L);if(G){Go(o,d,G);return}var z=C?C(M,L,d+"",o,u,v):t,J=z===t;if(J){var ae=Oe(L),fe=!ae&&Fi(L),Ne=!ae&&!fe&&Cr(L);z=L,ae||fe||Ne?Oe(M)?z=M:At(M)?z=Jt(M):fe?(J=!1,z=qh(L,!0)):Ne?(J=!1,z=Bh(L,!0)):z=[]:ss(L)||tr(L)?(z=M,tr(M)?z=Id(M):(!gt(M)||pi(M))&&(z=nd(L))):J=!1}J&&(v.set(L,z),w(z,L,y,C,v),v.delete(L)),Go(o,d,z)}function Rh(o,u){var d=o.length;if(d)return u+=u<0?d:0,fi(u,d)?o[u]:t}function xh(o,u,d){u.length?u=ft(u,function(C){return Oe(C)?function(v){return Xi(v,C.length===1?C[0]:C)}:C}):u=[en];var y=-1;u=ft(u,sn(be()));var w=Ah(o,function(C,v,M){var L=ft(u,function(G){return G(C)});return{criteria:L,index:++y,value:C}});return Wy(w,function(C,v){return PE(C,v,d)})}function TE(o,u){return _h(o,u,function(d,y){return Mc(o,y)})}function _h(o,u,d){for(var y=-1,w=u.length,C={};++y<w;){var v=u[y],M=Xi(o,v);d(M,v)&&ts(C,qi(v,o),M)}return C}function wE(o){return function(u){return Xi(u,o)}}function ic(o,u,d,y){var w=y?Qy:fr,C=-1,v=u.length,M=o;for(o===u&&(u=Jt(u)),d&&(M=ft(o,sn(d)));++C<v;)for(var L=0,G=u[C],z=d?d(G):G;(L=w(M,z,L,y))>-1;)M!==o&&ks.call(M,L,1),ks.call(o,L,1);return o}function vh(o,u){for(var d=o?u.length:0,y=d-1;d--;){var w=u[d];if(d==y||w!==C){var C=w;fi(w)?ks.call(o,w,1):oc(o,w)}}return o}function rc(o,u){return o+Qs(uh()*(u-o+1))}function bE(o,u,d,y){for(var w=-1,C=_t(Vs((u-o)/(d||1)),0),v=j(C);C--;)v[y?C:++w]=o,o+=d;return v}function sc(o,u){var d="";if(!o||u<1||u>Te)return d;do u%2&&(d+=o),u=Qs(u/2),u&&(o+=o);while(u);return d}function Be(o,u){return Nc(sd(o,u,en),o+"")}function NE(o){return dh(Sr(o))}function AE(o,u){var d=Sr(o);return oa(d,Ji(u,0,d.length))}function ts(o,u,d,y){if(!gt(o))return o;u=qi(u,o);for(var w=-1,C=u.length,v=C-1,M=o;M!=null&&++w<C;){var L=Kn(u[w]),G=d;if(L==="__proto__"||L==="constructor"||L==="prototype")return o;if(w!=v){var z=M[L];G=y?y(z,L,M):t,G===t&&(G=gt(z)?z:fi(u[w+1])?[]:{})}Jr(M,L,G),M=M[L]}return o}var Mh=Ws?function(o,u){return Ws.set(o,u),o}:en,CE=js?function(o,u){return js(o,"toString",{configurable:!0,enumerable:!1,value:Oc(u),writable:!0})}:en;function SE(o){return oa(Sr(o))}function gn(o,u,d){var y=-1,w=o.length;u<0&&(u=-u>w?0:w+u),d=d>w?w:d,d<0&&(d+=w),w=u>d?0:d-u>>>0,u>>>=0;for(var C=j(w);++y<w;)C[y]=o[y+u];return C}function RE(o,u){var d;return $i(o,function(y,w,C){return d=u(y,w,C),!d}),!!d}function Xs(o,u,d){var y=0,w=o==null?y:o.length;if(typeof u=="number"&&u===u&&w<=k){for(;y<w;){var C=y+w>>>1,v=o[C];v!==null&&!on(v)&&(d?v<=u:v<u)?y=C+1:w=C}return w}return ac(o,u,en,d)}function ac(o,u,d,y){var w=0,C=o==null?0:o.length;if(C===0)return 0;u=d(u);for(var v=u!==u,M=u===null,L=on(u),G=u===t;w<C;){var z=Qs((w+C)/2),J=d(o[z]),ae=J!==t,fe=J===null,Ne=J===J,Le=on(J);if(v)var Ae=y||Ne;else G?Ae=Ne&&(y||ae):M?Ae=Ne&&ae&&(y||!fe):L?Ae=Ne&&ae&&!fe&&(y||!Le):fe||Le?Ae=!1:Ae=y?J<=u:J<u;Ae?w=z+1:C=z}return Ft(C,tt)}function Ph(o,u){for(var d=-1,y=o.length,w=0,C=[];++d<y;){var v=o[d],M=u?u(v):v;if(!d||!On(M,L)){var L=M;C[w++]=v===0?0:v}}return C}function Oh(o){return typeof o=="number"?o:on(o)?Ge:+o}function an(o){if(typeof o=="string")return o;if(Oe(o))return ft(o,an)+"";if(on(o))return lh?lh.call(o):"";var u=o+"";return u=="0"&&1/o==-oe?"-0":u}function Li(o,u,d){var y=-1,w=Ps,C=o.length,v=!0,M=[],L=M;if(d)v=!1,w=$o;else if(C>=i){var G=u?null:qE(o);if(G)return Ds(G);v=!1,w=Wr,L=new Ki}else L=u?[]:M;e:for(;++y<C;){var z=o[y],J=u?u(z):z;if(z=d||z!==0?z:0,v&&J===J){for(var ae=L.length;ae--;)if(L[ae]===J)continue e;u&&L.push(J),M.push(z)}else w(L,J,d)||(L!==M&&L.push(J),M.push(z))}return M}function oc(o,u){return u=qi(u,o),o=ad(o,u),o==null||delete o[Kn(En(u))]}function Dh(o,u,d,y){return ts(o,u,d(Xi(o,u)),y)}function Zs(o,u,d,y){for(var w=o.length,C=y?w:-1;(y?C--:++C<w)&&u(o[C],C,o););return d?gn(o,y?0:C,y?C+1:w):gn(o,y?C+1:0,y?w:C)}function Ih(o,u){var d=o;return d instanceof ke&&(d=d.value()),Lo(u,function(y,w){return w.func.apply(w.thisArg,Oi([y],w.args))},d)}function cc(o,u,d){var y=o.length;if(y<2)return y?Li(o[0]):[];for(var w=-1,C=j(y);++w<y;)for(var v=o[w],M=-1;++M<y;)M!=w&&(C[w]=Xr(C[w]||v,o[M],u,d));return Li(Lt(C,1),u,d)}function $h(o,u,d){for(var y=-1,w=o.length,C=u.length,v={};++y<w;){var M=y<C?u[y]:t;d(v,o[y],M)}return v}function uc(o){return At(o)?o:[]}function lc(o){return typeof o=="function"?o:en}function qi(o,u){return Oe(o)?o:Tc(o,u)?[o]:ld(et(o))}var xE=Be;function Bi(o,u,d){var y=o.length;return d=d===t?y:d,!u&&d>=y?o:gn(o,u,d)}var Lh=pg||function(o){return $t.clearTimeout(o)};function qh(o,u){if(u)return o.slice();var d=o.length,y=rh?rh(d):new o.constructor(d);return o.copy(y),y}function hc(o){var u=new o.constructor(o.byteLength);return new Fs(u).set(new Fs(o)),u}function _E(o,u){var d=u?hc(o.buffer):o.buffer;return new o.constructor(d,o.byteOffset,o.byteLength)}function vE(o){var u=new o.constructor(o.source,wl.exec(o));return u.lastIndex=o.lastIndex,u}function ME(o){return Kr?at(Kr.call(o)):{}}function Bh(o,u){var d=u?hc(o.buffer):o.buffer;return new o.constructor(d,o.byteOffset,o.length)}function Fh(o,u){if(o!==u){var d=o!==t,y=o===null,w=o===o,C=on(o),v=u!==t,M=u===null,L=u===u,G=on(u);if(!M&&!G&&!C&&o>u||C&&v&&L&&!M&&!G||y&&v&&L||!d&&L||!w)return 1;if(!y&&!C&&!G&&o<u||G&&d&&w&&!y&&!C||M&&d&&w||!v&&w||!L)return-1}return 0}function PE(o,u,d){for(var y=-1,w=o.criteria,C=u.criteria,v=w.length,M=d.length;++y<v;){var L=Fh(w[y],C[y]);if(L){if(y>=M)return L;var G=d[y];return L*(G=="desc"?-1:1)}}return o.index-u.index}function Uh(o,u,d,y){for(var w=-1,C=o.length,v=d.length,M=-1,L=u.length,G=_t(C-v,0),z=j(L+G),J=!y;++M<L;)z[M]=u[M];for(;++w<v;)(J||w<C)&&(z[d[w]]=o[w]);for(;G--;)z[M++]=o[w++];return z}function kh(o,u,d,y){for(var w=-1,C=o.length,v=-1,M=d.length,L=-1,G=u.length,z=_t(C-M,0),J=j(z+G),ae=!y;++w<z;)J[w]=o[w];for(var fe=w;++L<G;)J[fe+L]=u[L];for(;++v<M;)(ae||w<C)&&(J[fe+d[v]]=o[w++]);return J}function Jt(o,u){var d=-1,y=o.length;for(u||(u=j(y));++d<y;)u[d]=o[d];return u}function zn(o,u,d,y){var w=!d;d||(d={});for(var C=-1,v=u.length;++C<v;){var M=u[C],L=y?y(d[M],o[M],M,d,o):t;L===t&&(L=o[M]),w?li(d,M,L):Jr(d,M,L)}return d}function OE(o,u){return zn(o,Ec(o),u)}function DE(o,u){return zn(o,ed(o),u)}function ea(o,u){return function(d,y){var w=Oe(d)?By:tE,C=u?u():{};return w(d,o,be(y,2),C)}}function br(o){return Be(function(u,d){var y=-1,w=d.length,C=w>1?d[w-1]:t,v=w>2?d[2]:t;for(C=o.length>3&&typeof C=="function"?(w--,C):t,v&&Yt(d[0],d[1],v)&&(C=w<3?t:C,w=1),u=at(u);++y<w;){var M=d[y];M&&o(u,M,y,C)}return u})}function jh(o,u){return function(d,y){if(d==null)return d;if(!Xt(d))return o(d,y);for(var w=d.length,C=u?w:-1,v=at(d);(u?C--:++C<w)&&y(v[C],C,v)!==!1;);return d}}function Vh(o){return function(u,d,y){for(var w=-1,C=at(u),v=y(u),M=v.length;M--;){var L=v[o?M:++w];if(d(C[L],L,C)===!1)break}return u}}function IE(o,u,d){var y=u&P,w=ns(o);function C(){var v=this&&this!==$t&&this instanceof C?w:o;return v.apply(y?d:this,arguments)}return C}function Qh(o){return function(u){u=et(u);var d=pr(u)?Mn(u):t,y=d?d[0]:u.charAt(0),w=d?Bi(d,1).join(""):u.slice(1);return y[o]()+w}}function Nr(o){return function(u){return Lo(jd(kd(u).replace(Cy,"")),o,"")}}function ns(o){return function(){var u=arguments;switch(u.length){case 0:return new o;case 1:return new o(u[0]);case 2:return new o(u[0],u[1]);case 3:return new o(u[0],u[1],u[2]);case 4:return new o(u[0],u[1],u[2],u[3]);case 5:return new o(u[0],u[1],u[2],u[3],u[4]);case 6:return new o(u[0],u[1],u[2],u[3],u[4],u[5]);case 7:return new o(u[0],u[1],u[2],u[3],u[4],u[5],u[6])}var d=wr(o.prototype),y=o.apply(d,u);return gt(y)?y:d}}function $E(o,u,d){var y=ns(o);function w(){for(var C=arguments.length,v=j(C),M=C,L=Ar(w);M--;)v[M]=arguments[M];var G=C<3&&v[0]!==L&&v[C-1]!==L?[]:Di(v,L);if(C-=G.length,C<d)return zh(o,u,ta,w.placeholder,t,v,G,t,t,d-C);var z=this&&this!==$t&&this instanceof w?y:o;return rn(z,this,v)}return w}function Wh(o){return function(u,d,y){var w=at(u);if(!Xt(u)){var C=be(d,3);u=Pt(u),d=function(M){return C(w[M],M,w)}}var v=o(u,d,y);return v>-1?w[C?u[v]:v]:t}}function Hh(o){return di(function(u){var d=u.length,y=d,w=mn.prototype.thru;for(o&&u.reverse();y--;){var C=u[y];if(typeof C!="function")throw new pn(a);if(w&&!v&&sa(C)=="wrapper")var v=new mn([],!0)}for(y=v?y:d;++y<d;){C=u[y];var M=sa(C),L=M=="wrapper"?yc(C):t;L&&wc(L[0])&&L[1]==(Se|q|re|me)&&!L[4].length&&L[9]==1?v=v[sa(L[0])].apply(v,L[3]):v=C.length==1&&wc(C)?v[M]():v.thru(C)}return function(){var G=arguments,z=G[0];if(v&&G.length==1&&Oe(z))return v.plant(z).value();for(var J=0,ae=d?u[J].apply(this,G):z;++J<d;)ae=u[J].call(this,ae);return ae}})}function ta(o,u,d,y,w,C,v,M,L,G){var z=u&Se,J=u&P,ae=u&F,fe=u&(q|Z),Ne=u&W,Le=ae?t:ns(o);function Ae(){for(var Ue=arguments.length,Ve=j(Ue),cn=Ue;cn--;)Ve[cn]=arguments[cn];if(fe)var Gt=Ar(Ae),un=Yy(Ve,Gt);if(y&&(Ve=Uh(Ve,y,w,fe)),C&&(Ve=kh(Ve,C,v,fe)),Ue-=un,fe&&Ue<G){var Ct=Di(Ve,Gt);return zh(o,u,ta,Ae.placeholder,d,Ve,Ct,M,L,G-Ue)}var Dn=J?d:this,yi=ae?Dn[o]:o;return Ue=Ve.length,M?Ve=tT(Ve,M):Ne&&Ue>1&&Ve.reverse(),z&&L<Ue&&(Ve.length=L),this&&this!==$t&&this instanceof Ae&&(yi=Le||ns(yi)),yi.apply(Dn,Ve)}return Ae}function Yh(o,u){return function(d,y){return uE(d,o,u(y),{})}}function na(o,u){return function(d,y){var w;if(d===t&&y===t)return u;if(d!==t&&(w=d),y!==t){if(w===t)return y;typeof d=="string"||typeof y=="string"?(d=an(d),y=an(y)):(d=Oh(d),y=Oh(y)),w=o(d,y)}return w}}function dc(o){return di(function(u){return u=ft(u,sn(be())),Be(function(d){var y=this;return o(u,function(w){return rn(w,y,d)})})})}function ia(o,u){u=u===t?" ":an(u);var d=u.length;if(d<2)return d?sc(u,o):u;var y=sc(u,Vs(o/mr(u)));return pr(u)?Bi(Mn(y),0,o).join(""):y.slice(0,o)}function LE(o,u,d,y){var w=u&P,C=ns(o);function v(){for(var M=-1,L=arguments.length,G=-1,z=y.length,J=j(z+L),ae=this&&this!==$t&&this instanceof v?C:o;++G<z;)J[G]=y[G];for(;L--;)J[G++]=arguments[++M];return rn(ae,w?d:this,J)}return v}function Gh(o){return function(u,d,y){return y&&typeof y!="number"&&Yt(u,d,y)&&(d=y=t),u=mi(u),d===t?(d=u,u=0):d=mi(d),y=y===t?u<d?1:-1:mi(y),bE(u,d,y,o)}}function ra(o){return function(u,d){return typeof u=="string"&&typeof d=="string"||(u=Tn(u),d=Tn(d)),o(u,d)}}function zh(o,u,d,y,w,C,v,M,L,G){var z=u&q,J=z?v:t,ae=z?t:v,fe=z?C:t,Ne=z?t:C;u|=z?re:Ee,u&=~(z?Ee:re),u&B||(u&=-4);var Le=[o,u,w,fe,J,Ne,ae,M,L,G],Ae=d.apply(t,Le);return wc(o)&&od(Ae,Le),Ae.placeholder=y,cd(Ae,o,u)}function fc(o){var u=xt[o];return function(d,y){if(d=Tn(d),y=y==null?0:Ft(Ie(y),292),y&&ch(d)){var w=(et(d)+"e").split("e"),C=u(w[0]+"e"+(+w[1]+y));return w=(et(C)+"e").split("e"),+(w[0]+"e"+(+w[1]-y))}return u(d)}}var qE=Er&&1/Ds(new Er([,-0]))[1]==oe?function(o){return new Er(o)}:$c;function Kh(o){return function(u){var d=Ut(u);return d==Et?Vo(u):d==It?eg(u):Hy(u,o(u))}}function hi(o,u,d,y,w,C,v,M){var L=u&F;if(!L&&typeof o!="function")throw new pn(a);var G=y?y.length:0;if(G||(u&=-97,y=w=t),v=v===t?v:_t(Ie(v),0),M=M===t?M:Ie(M),G-=w?w.length:0,u&Ee){var z=y,J=w;y=w=t}var ae=L?t:yc(o),fe=[o,u,d,y,w,z,J,C,v,M];if(ae&&XE(fe,ae),o=fe[0],u=fe[1],d=fe[2],y=fe[3],w=fe[4],M=fe[9]=fe[9]===t?L?0:o.length:_t(fe[9]-G,0),!M&&u&(q|Z)&&(u&=-25),!u||u==P)var Ne=IE(o,u,d);else u==q||u==Z?Ne=$E(o,u,M):(u==re||u==(P|re))&&!w.length?Ne=LE(o,u,d,y):Ne=ta.apply(t,fe);var Le=ae?Mh:od;return cd(Le(Ne,fe),o,u)}function Jh(o,u,d,y){return o===t||On(o,gr[d])&&!it.call(y,d)?u:o}function Xh(o,u,d,y,w,C){return gt(o)&&gt(u)&&(C.set(u,o),Js(o,u,t,Xh,C),C.delete(u)),o}function BE(o){return ss(o)?t:o}function Zh(o,u,d,y,w,C){var v=d&A,M=o.length,L=u.length;if(M!=L&&!(v&&L>M))return!1;var G=C.get(o),z=C.get(u);if(G&&z)return G==u&&z==o;var J=-1,ae=!0,fe=d&S?new Ki:t;for(C.set(o,u),C.set(u,o);++J<M;){var Ne=o[J],Le=u[J];if(y)var Ae=v?y(Le,Ne,J,u,o,C):y(Ne,Le,J,o,u,C);if(Ae!==t){if(Ae)continue;ae=!1;break}if(fe){if(!qo(u,function(Ue,Ve){if(!Wr(fe,Ve)&&(Ne===Ue||w(Ne,Ue,d,y,C)))return fe.push(Ve)})){ae=!1;break}}else if(!(Ne===Le||w(Ne,Le,d,y,C))){ae=!1;break}}return C.delete(o),C.delete(u),ae}function FE(o,u,d,y,w,C,v){switch(d){case g:if(o.byteLength!=u.byteLength||o.byteOffset!=u.byteOffset)return!1;o=o.buffer,u=u.buffer;case b:return!(o.byteLength!=u.byteLength||!C(new Fs(o),new Fs(u)));case _e:case xe:case zt:return On(+o,+u);case We:return o.name==u.name&&o.message==u.message;case Yn:case Bt:return o==u+"";case Et:var M=Vo;case It:var L=y&A;if(M||(M=Ds),o.size!=u.size&&!L)return!1;var G=v.get(o);if(G)return G==u;y|=S,v.set(o,u);var z=Zh(M(o),M(u),y,w,C,v);return v.delete(o),z;case Mi:if(Kr)return Kr.call(o)==Kr.call(u)}return!1}function UE(o,u,d,y,w,C){var v=d&A,M=pc(o),L=M.length,G=pc(u),z=G.length;if(L!=z&&!v)return!1;for(var J=L;J--;){var ae=M[J];if(!(v?ae in u:it.call(u,ae)))return!1}var fe=C.get(o),Ne=C.get(u);if(fe&&Ne)return fe==u&&Ne==o;var Le=!0;C.set(o,u),C.set(u,o);for(var Ae=v;++J<L;){ae=M[J];var Ue=o[ae],Ve=u[ae];if(y)var cn=v?y(Ve,Ue,ae,u,o,C):y(Ue,Ve,ae,o,u,C);if(!(cn===t?Ue===Ve||w(Ue,Ve,d,y,C):cn)){Le=!1;break}Ae||(Ae=ae=="constructor")}if(Le&&!Ae){var Gt=o.constructor,un=u.constructor;Gt!=un&&"constructor"in o&&"constructor"in u&&!(typeof Gt=="function"&&Gt instanceof Gt&&typeof un=="function"&&un instanceof un)&&(Le=!1)}return C.delete(o),C.delete(u),Le}function di(o){return Nc(sd(o,t,pd),o+"")}function pc(o){return Th(o,Pt,Ec)}function mc(o){return Th(o,Zt,ed)}var yc=Ws?function(o){return Ws.get(o)}:$c;function sa(o){for(var u=o.name+"",d=Tr[u],y=it.call(Tr,u)?d.length:0;y--;){var w=d[y],C=w.func;if(C==null||C==o)return w.name}return u}function Ar(o){var u=it.call(N,"placeholder")?N:o;return u.placeholder}function be(){var o=N.iteratee||Dc;return o=o===Dc?Nh:o,arguments.length?o(arguments[0],arguments[1]):o}function aa(o,u){var d=o.__data__;return GE(u)?d[typeof u=="string"?"string":"hash"]:d.map}function gc(o){for(var u=Pt(o),d=u.length;d--;){var y=u[d],w=o[y];u[d]=[y,w,id(w)]}return u}function Zi(o,u){var d=Jy(o,u);return bh(d)?d:t}function kE(o){var u=it.call(o,Gi),d=o[Gi];try{o[Gi]=t;var y=!0}catch{}var w=qs.call(o);return y&&(u?o[Gi]=d:delete o[Gi]),w}var Ec=Wo?function(o){return o==null?[]:(o=at(o),Pi(Wo(o),function(u){return ah.call(o,u)}))}:Lc,ed=Wo?function(o){for(var u=[];o;)Oi(u,Ec(o)),o=Us(o);return u}:Lc,Ut=Ht;(Ho&&Ut(new Ho(new ArrayBuffer(1)))!=g||Yr&&Ut(new Yr)!=Et||Yo&&Ut(Yo.resolve())!=hr||Er&&Ut(new Er)!=It||Gr&&Ut(new Gr)!=Kt)&&(Ut=function(o){var u=Ht(o),d=u==Wt?o.constructor:t,y=d?er(d):"";if(y)switch(y){case Ag:return g;case Cg:return Et;case Sg:return hr;case Rg:return It;case xg:return Kt}return u});function jE(o,u,d){for(var y=-1,w=d.length;++y<w;){var C=d[y],v=C.size;switch(C.type){case"drop":o+=v;break;case"dropRight":u-=v;break;case"take":u=Ft(u,o+v);break;case"takeRight":o=_t(o,u-v);break}}return{start:o,end:u}}function VE(o){var u=o.match(zm);return u?u[1].split(Km):[]}function td(o,u,d){u=qi(u,o);for(var y=-1,w=u.length,C=!1;++y<w;){var v=Kn(u[y]);if(!(C=o!=null&&d(o,v)))break;o=o[v]}return C||++y!=w?C:(w=o==null?0:o.length,!!w&&fa(w)&&fi(v,w)&&(Oe(o)||tr(o)))}function QE(o){var u=o.length,d=new o.constructor(u);return u&&typeof o[0]=="string"&&it.call(o,"index")&&(d.index=o.index,d.input=o.input),d}function nd(o){return typeof o.constructor=="function"&&!is(o)?wr(Us(o)):{}}function WE(o,u,d){var y=o.constructor;switch(u){case b:return hc(o);case _e:case xe:return new y(+o);case g:return _E(o,d);case E:case R:case O:case U:case H:case De:case ot:case rt:case ct:return Bh(o,d);case Et:return new y;case zt:case Bt:return new y(o);case Yn:return vE(o);case It:return new y;case Mi:return ME(o)}}function HE(o,u){var d=u.length;if(!d)return o;var y=d-1;return u[y]=(d>1?"& ":"")+u[y],u=u.join(d>2?", ":" "),o.replace(Gm,`{
/* [wrapped with `+u+`] */
`)}function YE(o){return Oe(o)||tr(o)||!!(oh&&o&&o[oh])}function fi(o,u){var d=typeof o;return u=u??Te,!!u&&(d=="number"||d!="symbol"&&sy.test(o))&&o>-1&&o%1==0&&o<u}function Yt(o,u,d){if(!gt(d))return!1;var y=typeof u;return(y=="number"?Xt(d)&&fi(u,d.length):y=="string"&&u in d)?On(d[u],o):!1}function Tc(o,u){if(Oe(o))return!1;var d=typeof o;return d=="number"||d=="symbol"||d=="boolean"||o==null||on(o)?!0:Qm.test(o)||!Vm.test(o)||u!=null&&o in at(u)}function GE(o){var u=typeof o;return u=="string"||u=="number"||u=="symbol"||u=="boolean"?o!=="__proto__":o===null}function wc(o){var u=sa(o),d=N[u];if(typeof d!="function"||!(u in ke.prototype))return!1;if(o===d)return!0;var y=yc(d);return!!y&&o===y[0]}function zE(o){return!!ih&&ih in o}var KE=$s?pi:qc;function is(o){var u=o&&o.constructor,d=typeof u=="function"&&u.prototype||gr;return o===d}function id(o){return o===o&&!gt(o)}function rd(o,u){return function(d){return d==null?!1:d[o]===u&&(u!==t||o in at(d))}}function JE(o){var u=ha(o,function(y){return d.size===h&&d.clear(),y}),d=u.cache;return u}function XE(o,u){var d=o[1],y=u[1],w=d|y,C=w<(P|F|Se),v=y==Se&&d==q||y==Se&&d==me&&o[7].length<=u[8]||y==(Se|me)&&u[7].length<=u[8]&&d==q;if(!(C||v))return o;y&P&&(o[2]=u[2],w|=d&P?0:B);var M=u[3];if(M){var L=o[3];o[3]=L?Uh(L,M,u[4]):M,o[4]=L?Di(o[3],f):u[4]}return M=u[5],M&&(L=o[5],o[5]=L?kh(L,M,u[6]):M,o[6]=L?Di(o[5],f):u[6]),M=u[7],M&&(o[7]=M),y&Se&&(o[8]=o[8]==null?u[8]:Ft(o[8],u[8])),o[9]==null&&(o[9]=u[9]),o[0]=u[0],o[1]=w,o}function ZE(o){var u=[];if(o!=null)for(var d in at(o))u.push(d);return u}function eT(o){return qs.call(o)}function sd(o,u,d){return u=_t(u===t?o.length-1:u,0),function(){for(var y=arguments,w=-1,C=_t(y.length-u,0),v=j(C);++w<C;)v[w]=y[u+w];w=-1;for(var M=j(u+1);++w<u;)M[w]=y[w];return M[u]=d(v),rn(o,this,M)}}function ad(o,u){return u.length<2?o:Xi(o,gn(u,0,-1))}function tT(o,u){for(var d=o.length,y=Ft(u.length,d),w=Jt(o);y--;){var C=u[y];o[y]=fi(C,d)?w[C]:t}return o}function bc(o,u){if(!(u==="constructor"&&typeof o[u]=="function")&&u!="__proto__")return o[u]}var od=ud(Mh),rs=yg||function(o,u){return $t.setTimeout(o,u)},Nc=ud(CE);function cd(o,u,d){var y=u+"";return Nc(o,HE(y,nT(VE(y),d)))}function ud(o){var u=0,d=0;return function(){var y=wg(),w=V-(y-d);if(d=y,w>0){if(++u>=se)return arguments[0]}else u=0;return o.apply(t,arguments)}}function oa(o,u){var d=-1,y=o.length,w=y-1;for(u=u===t?y:u;++d<u;){var C=rc(d,w),v=o[C];o[C]=o[d],o[d]=v}return o.length=u,o}var ld=JE(function(o){var u=[];return o.charCodeAt(0)===46&&u.push(""),o.replace(Wm,function(d,y,w,C){u.push(w?C.replace(Zm,"$1"):y||d)}),u});function Kn(o){if(typeof o=="string"||on(o))return o;var u=o+"";return u=="0"&&1/o==-oe?"-0":u}function er(o){if(o!=null){try{return Ls.call(o)}catch{}try{return o+""}catch{}}return""}function nT(o,u){return fn(Y,function(d){var y="_."+d[0];u&d[1]&&!Ps(o,y)&&o.push(y)}),o.sort()}function hd(o){if(o instanceof ke)return o.clone();var u=new mn(o.__wrapped__,o.__chain__);return u.__actions__=Jt(o.__actions__),u.__index__=o.__index__,u.__values__=o.__values__,u}function iT(o,u,d){(d?Yt(o,u,d):u===t)?u=1:u=_t(Ie(u),0);var y=o==null?0:o.length;if(!y||u<1)return[];for(var w=0,C=0,v=j(Vs(y/u));w<y;)v[C++]=gn(o,w,w+=u);return v}function rT(o){for(var u=-1,d=o==null?0:o.length,y=0,w=[];++u<d;){var C=o[u];C&&(w[y++]=C)}return w}function sT(){var o=arguments.length;if(!o)return[];for(var u=j(o-1),d=arguments[0],y=o;y--;)u[y-1]=arguments[y];return Oi(Oe(d)?Jt(d):[d],Lt(u,1))}var aT=Be(function(o,u){return At(o)?Xr(o,Lt(u,1,At,!0)):[]}),oT=Be(function(o,u){var d=En(u);return At(d)&&(d=t),At(o)?Xr(o,Lt(u,1,At,!0),be(d,2)):[]}),cT=Be(function(o,u){var d=En(u);return At(d)&&(d=t),At(o)?Xr(o,Lt(u,1,At,!0),t,d):[]});function uT(o,u,d){var y=o==null?0:o.length;return y?(u=d||u===t?1:Ie(u),gn(o,u<0?0:u,y)):[]}function lT(o,u,d){var y=o==null?0:o.length;return y?(u=d||u===t?1:Ie(u),u=y-u,gn(o,0,u<0?0:u)):[]}function hT(o,u){return o&&o.length?Zs(o,be(u,3),!0,!0):[]}function dT(o,u){return o&&o.length?Zs(o,be(u,3),!0):[]}function fT(o,u,d,y){var w=o==null?0:o.length;return w?(d&&typeof d!="number"&&Yt(o,u,d)&&(d=0,y=w),sE(o,u,d,y)):[]}function dd(o,u,d){var y=o==null?0:o.length;if(!y)return-1;var w=d==null?0:Ie(d);return w<0&&(w=_t(y+w,0)),Os(o,be(u,3),w)}function fd(o,u,d){var y=o==null?0:o.length;if(!y)return-1;var w=y-1;return d!==t&&(w=Ie(d),w=d<0?_t(y+w,0):Ft(w,y-1)),Os(o,be(u,3),w,!0)}function pd(o){var u=o==null?0:o.length;return u?Lt(o,1):[]}function pT(o){var u=o==null?0:o.length;return u?Lt(o,oe):[]}function mT(o,u){var d=o==null?0:o.length;return d?(u=u===t?1:Ie(u),Lt(o,u)):[]}function yT(o){for(var u=-1,d=o==null?0:o.length,y={};++u<d;){var w=o[u];y[w[0]]=w[1]}return y}function md(o){return o&&o.length?o[0]:t}function gT(o,u,d){var y=o==null?0:o.length;if(!y)return-1;var w=d==null?0:Ie(d);return w<0&&(w=_t(y+w,0)),fr(o,u,w)}function ET(o){var u=o==null?0:o.length;return u?gn(o,0,-1):[]}var TT=Be(function(o){var u=ft(o,uc);return u.length&&u[0]===o[0]?Zo(u):[]}),wT=Be(function(o){var u=En(o),d=ft(o,uc);return u===En(d)?u=t:d.pop(),d.length&&d[0]===o[0]?Zo(d,be(u,2)):[]}),bT=Be(function(o){var u=En(o),d=ft(o,uc);return u=typeof u=="function"?u:t,u&&d.pop(),d.length&&d[0]===o[0]?Zo(d,t,u):[]});function NT(o,u){return o==null?"":Eg.call(o,u)}function En(o){var u=o==null?0:o.length;return u?o[u-1]:t}function AT(o,u,d){var y=o==null?0:o.length;if(!y)return-1;var w=y;return d!==t&&(w=Ie(d),w=w<0?_t(y+w,0):Ft(w,y-1)),u===u?ng(o,u,w):Os(o,zl,w,!0)}function CT(o,u){return o&&o.length?Rh(o,Ie(u)):t}var ST=Be(yd);function yd(o,u){return o&&o.length&&u&&u.length?ic(o,u):o}function RT(o,u,d){return o&&o.length&&u&&u.length?ic(o,u,be(d,2)):o}function xT(o,u,d){return o&&o.length&&u&&u.length?ic(o,u,t,d):o}var _T=di(function(o,u){var d=o==null?0:o.length,y=zo(o,u);return vh(o,ft(u,function(w){return fi(w,d)?+w:w}).sort(Fh)),y});function vT(o,u){var d=[];if(!(o&&o.length))return d;var y=-1,w=[],C=o.length;for(u=be(u,3);++y<C;){var v=o[y];u(v,y,o)&&(d.push(v),w.push(y))}return vh(o,w),d}function Ac(o){return o==null?o:Ng.call(o)}function MT(o,u,d){var y=o==null?0:o.length;return y?(d&&typeof d!="number"&&Yt(o,u,d)?(u=0,d=y):(u=u==null?0:Ie(u),d=d===t?y:Ie(d)),gn(o,u,d)):[]}function PT(o,u){return Xs(o,u)}function OT(o,u,d){return ac(o,u,be(d,2))}function DT(o,u){var d=o==null?0:o.length;if(d){var y=Xs(o,u);if(y<d&&On(o[y],u))return y}return-1}function IT(o,u){return Xs(o,u,!0)}function $T(o,u,d){return ac(o,u,be(d,2),!0)}function LT(o,u){var d=o==null?0:o.length;if(d){var y=Xs(o,u,!0)-1;if(On(o[y],u))return y}return-1}function qT(o){return o&&o.length?Ph(o):[]}function BT(o,u){return o&&o.length?Ph(o,be(u,2)):[]}function FT(o){var u=o==null?0:o.length;return u?gn(o,1,u):[]}function UT(o,u,d){return o&&o.length?(u=d||u===t?1:Ie(u),gn(o,0,u<0?0:u)):[]}function kT(o,u,d){var y=o==null?0:o.length;return y?(u=d||u===t?1:Ie(u),u=y-u,gn(o,u<0?0:u,y)):[]}function jT(o,u){return o&&o.length?Zs(o,be(u,3),!1,!0):[]}function VT(o,u){return o&&o.length?Zs(o,be(u,3)):[]}var QT=Be(function(o){return Li(Lt(o,1,At,!0))}),WT=Be(function(o){var u=En(o);return At(u)&&(u=t),Li(Lt(o,1,At,!0),be(u,2))}),HT=Be(function(o){var u=En(o);return u=typeof u=="function"?u:t,Li(Lt(o,1,At,!0),t,u)});function YT(o){return o&&o.length?Li(o):[]}function GT(o,u){return o&&o.length?Li(o,be(u,2)):[]}function zT(o,u){return u=typeof u=="function"?u:t,o&&o.length?Li(o,t,u):[]}function Cc(o){if(!(o&&o.length))return[];var u=0;return o=Pi(o,function(d){if(At(d))return u=_t(d.length,u),!0}),ko(u,function(d){return ft(o,Bo(d))})}function gd(o,u){if(!(o&&o.length))return[];var d=Cc(o);return u==null?d:ft(d,function(y){return rn(u,t,y)})}var KT=Be(function(o,u){return At(o)?Xr(o,u):[]}),JT=Be(function(o){return cc(Pi(o,At))}),XT=Be(function(o){var u=En(o);return At(u)&&(u=t),cc(Pi(o,At),be(u,2))}),ZT=Be(function(o){var u=En(o);return u=typeof u=="function"?u:t,cc(Pi(o,At),t,u)}),ew=Be(Cc);function tw(o,u){return $h(o||[],u||[],Jr)}function nw(o,u){return $h(o||[],u||[],ts)}var iw=Be(function(o){var u=o.length,d=u>1?o[u-1]:t;return d=typeof d=="function"?(o.pop(),d):t,gd(o,d)});function Ed(o){var u=N(o);return u.__chain__=!0,u}function rw(o,u){return u(o),o}function ca(o,u){return u(o)}var sw=di(function(o){var u=o.length,d=u?o[0]:0,y=this.__wrapped__,w=function(C){return zo(C,o)};return u>1||this.__actions__.length||!(y instanceof ke)||!fi(d)?this.thru(w):(y=y.slice(d,+d+(u?1:0)),y.__actions__.push({func:ca,args:[w],thisArg:t}),new mn(y,this.__chain__).thru(function(C){return u&&!C.length&&C.push(t),C}))});function aw(){return Ed(this)}function ow(){return new mn(this.value(),this.__chain__)}function cw(){this.__values__===t&&(this.__values__=Od(this.value()));var o=this.__index__>=this.__values__.length,u=o?t:this.__values__[this.__index__++];return{done:o,value:u}}function uw(){return this}function lw(o){for(var u,d=this;d instanceof Ys;){var y=hd(d);y.__index__=0,y.__values__=t,u?w.__wrapped__=y:u=y;var w=y;d=d.__wrapped__}return w.__wrapped__=o,u}function hw(){var o=this.__wrapped__;if(o instanceof ke){var u=o;return this.__actions__.length&&(u=new ke(this)),u=u.reverse(),u.__actions__.push({func:ca,args:[Ac],thisArg:t}),new mn(u,this.__chain__)}return this.thru(Ac)}function dw(){return Ih(this.__wrapped__,this.__actions__)}var fw=ea(function(o,u,d){it.call(o,d)?++o[d]:li(o,d,1)});function pw(o,u,d){var y=Oe(o)?Yl:rE;return d&&Yt(o,u,d)&&(u=t),y(o,be(u,3))}function mw(o,u){var d=Oe(o)?Pi:gh;return d(o,be(u,3))}var yw=Wh(dd),gw=Wh(fd);function Ew(o,u){return Lt(ua(o,u),1)}function Tw(o,u){return Lt(ua(o,u),oe)}function ww(o,u,d){return d=d===t?1:Ie(d),Lt(ua(o,u),d)}function Td(o,u){var d=Oe(o)?fn:$i;return d(o,be(u,3))}function wd(o,u){var d=Oe(o)?Fy:yh;return d(o,be(u,3))}var bw=ea(function(o,u,d){it.call(o,d)?o[d].push(u):li(o,d,[u])});function Nw(o,u,d,y){o=Xt(o)?o:Sr(o),d=d&&!y?Ie(d):0;var w=o.length;return d<0&&(d=_t(w+d,0)),pa(o)?d<=w&&o.indexOf(u,d)>-1:!!w&&fr(o,u,d)>-1}var Aw=Be(function(o,u,d){var y=-1,w=typeof u=="function",C=Xt(o)?j(o.length):[];return $i(o,function(v){C[++y]=w?rn(u,v,d):Zr(v,u,d)}),C}),Cw=ea(function(o,u,d){li(o,d,u)});function ua(o,u){var d=Oe(o)?ft:Ah;return d(o,be(u,3))}function Sw(o,u,d,y){return o==null?[]:(Oe(u)||(u=u==null?[]:[u]),d=y?t:d,Oe(d)||(d=d==null?[]:[d]),xh(o,u,d))}var Rw=ea(function(o,u,d){o[d?0:1].push(u)},function(){return[[],[]]});function xw(o,u,d){var y=Oe(o)?Lo:Jl,w=arguments.length<3;return y(o,be(u,4),d,w,$i)}function _w(o,u,d){var y=Oe(o)?Uy:Jl,w=arguments.length<3;return y(o,be(u,4),d,w,yh)}function vw(o,u){var d=Oe(o)?Pi:gh;return d(o,da(be(u,3)))}function Mw(o){var u=Oe(o)?dh:NE;return u(o)}function Pw(o,u,d){(d?Yt(o,u,d):u===t)?u=1:u=Ie(u);var y=Oe(o)?Zg:AE;return y(o,u)}function Ow(o){var u=Oe(o)?eE:SE;return u(o)}function Dw(o){if(o==null)return 0;if(Xt(o))return pa(o)?mr(o):o.length;var u=Ut(o);return u==Et||u==It?o.size:tc(o).length}function Iw(o,u,d){var y=Oe(o)?qo:RE;return d&&Yt(o,u,d)&&(u=t),y(o,be(u,3))}var $w=Be(function(o,u){if(o==null)return[];var d=u.length;return d>1&&Yt(o,u[0],u[1])?u=[]:d>2&&Yt(u[0],u[1],u[2])&&(u=[u[0]]),xh(o,Lt(u,1),[])}),la=mg||function(){return $t.Date.now()};function Lw(o,u){if(typeof u!="function")throw new pn(a);return o=Ie(o),function(){if(--o<1)return u.apply(this,arguments)}}function bd(o,u,d){return u=d?t:u,u=o&&u==null?o.length:u,hi(o,Se,t,t,t,t,u)}function Nd(o,u){var d;if(typeof u!="function")throw new pn(a);return o=Ie(o),function(){return--o>0&&(d=u.apply(this,arguments)),o<=1&&(u=t),d}}var Sc=Be(function(o,u,d){var y=P;if(d.length){var w=Di(d,Ar(Sc));y|=re}return hi(o,y,u,d,w)}),Ad=Be(function(o,u,d){var y=P|F;if(d.length){var w=Di(d,Ar(Ad));y|=re}return hi(u,y,o,d,w)});function Cd(o,u,d){u=d?t:u;var y=hi(o,q,t,t,t,t,t,u);return y.placeholder=Cd.placeholder,y}function Sd(o,u,d){u=d?t:u;var y=hi(o,Z,t,t,t,t,t,u);return y.placeholder=Sd.placeholder,y}function Rd(o,u,d){var y,w,C,v,M,L,G=0,z=!1,J=!1,ae=!0;if(typeof o!="function")throw new pn(a);u=Tn(u)||0,gt(d)&&(z=!!d.leading,J="maxWait"in d,C=J?_t(Tn(d.maxWait)||0,u):C,ae="trailing"in d?!!d.trailing:ae);function fe(Ct){var Dn=y,yi=w;return y=w=t,G=Ct,v=o.apply(yi,Dn),v}function Ne(Ct){return G=Ct,M=rs(Ue,u),z?fe(Ct):v}function Le(Ct){var Dn=Ct-L,yi=Ct-G,Wd=u-Dn;return J?Ft(Wd,C-yi):Wd}function Ae(Ct){var Dn=Ct-L,yi=Ct-G;return L===t||Dn>=u||Dn<0||J&&yi>=C}function Ue(){var Ct=la();if(Ae(Ct))return Ve(Ct);M=rs(Ue,Le(Ct))}function Ve(Ct){return M=t,ae&&y?fe(Ct):(y=w=t,v)}function cn(){M!==t&&Lh(M),G=0,y=L=w=M=t}function Gt(){return M===t?v:Ve(la())}function un(){var Ct=la(),Dn=Ae(Ct);if(y=arguments,w=this,L=Ct,Dn){if(M===t)return Ne(L);if(J)return Lh(M),M=rs(Ue,u),fe(L)}return M===t&&(M=rs(Ue,u)),v}return un.cancel=cn,un.flush=Gt,un}var qw=Be(function(o,u){return mh(o,1,u)}),Bw=Be(function(o,u,d){return mh(o,Tn(u)||0,d)});function Fw(o){return hi(o,W)}function ha(o,u){if(typeof o!="function"||u!=null&&typeof u!="function")throw new pn(a);var d=function(){var y=arguments,w=u?u.apply(this,y):y[0],C=d.cache;if(C.has(w))return C.get(w);var v=o.apply(this,y);return d.cache=C.set(w,v)||C,v};return d.cache=new(ha.Cache||ui),d}ha.Cache=ui;function da(o){if(typeof o!="function")throw new pn(a);return function(){var u=arguments;switch(u.length){case 0:return!o.call(this);case 1:return!o.call(this,u[0]);case 2:return!o.call(this,u[0],u[1]);case 3:return!o.call(this,u[0],u[1],u[2])}return!o.apply(this,u)}}function Uw(o){return Nd(2,o)}var kw=xE(function(o,u){u=u.length==1&&Oe(u[0])?ft(u[0],sn(be())):ft(Lt(u,1),sn(be()));var d=u.length;return Be(function(y){for(var w=-1,C=Ft(y.length,d);++w<C;)y[w]=u[w].call(this,y[w]);return rn(o,this,y)})}),Rc=Be(function(o,u){var d=Di(u,Ar(Rc));return hi(o,re,t,u,d)}),xd=Be(function(o,u){var d=Di(u,Ar(xd));return hi(o,Ee,t,u,d)}),jw=di(function(o,u){return hi(o,me,t,t,t,u)});function Vw(o,u){if(typeof o!="function")throw new pn(a);return u=u===t?u:Ie(u),Be(o,u)}function Qw(o,u){if(typeof o!="function")throw new pn(a);return u=u==null?0:_t(Ie(u),0),Be(function(d){var y=d[u],w=Bi(d,0,u);return y&&Oi(w,y),rn(o,this,w)})}function Ww(o,u,d){var y=!0,w=!0;if(typeof o!="function")throw new pn(a);return gt(d)&&(y="leading"in d?!!d.leading:y,w="trailing"in d?!!d.trailing:w),Rd(o,u,{leading:y,maxWait:u,trailing:w})}function Hw(o){return bd(o,1)}function Yw(o,u){return Rc(lc(u),o)}function Gw(){if(!arguments.length)return[];var o=arguments[0];return Oe(o)?o:[o]}function zw(o){return yn(o,T)}function Kw(o,u){return u=typeof u=="function"?u:t,yn(o,T,u)}function Jw(o){return yn(o,p|T)}function Xw(o,u){return u=typeof u=="function"?u:t,yn(o,p|T,u)}function Zw(o,u){return u==null||ph(o,u,Pt(u))}function On(o,u){return o===u||o!==o&&u!==u}var eb=ra(Xo),tb=ra(function(o,u){return o>=u}),tr=wh(function(){return arguments}())?wh:function(o){return Tt(o)&&it.call(o,"callee")&&!ah.call(o,"callee")},Oe=j.isArray,nb=kl?sn(kl):lE;function Xt(o){return o!=null&&fa(o.length)&&!pi(o)}function At(o){return Tt(o)&&Xt(o)}function ib(o){return o===!0||o===!1||Tt(o)&&Ht(o)==_e}var Fi=gg||qc,rb=jl?sn(jl):hE;function sb(o){return Tt(o)&&o.nodeType===1&&!ss(o)}function ab(o){if(o==null)return!0;if(Xt(o)&&(Oe(o)||typeof o=="string"||typeof o.splice=="function"||Fi(o)||Cr(o)||tr(o)))return!o.length;var u=Ut(o);if(u==Et||u==It)return!o.size;if(is(o))return!tc(o).length;for(var d in o)if(it.call(o,d))return!1;return!0}function ob(o,u){return es(o,u)}function cb(o,u,d){d=typeof d=="function"?d:t;var y=d?d(o,u):t;return y===t?es(o,u,t,d):!!y}function xc(o){if(!Tt(o))return!1;var u=Ht(o);return u==We||u==Fe||typeof o.message=="string"&&typeof o.name=="string"&&!ss(o)}function ub(o){return typeof o=="number"&&ch(o)}function pi(o){if(!gt(o))return!1;var u=Ht(o);return u==yt||u==Dt||u==Me||u==K}function _d(o){return typeof o=="number"&&o==Ie(o)}function fa(o){return typeof o=="number"&&o>-1&&o%1==0&&o<=Te}function gt(o){var u=typeof o;return o!=null&&(u=="object"||u=="function")}function Tt(o){return o!=null&&typeof o=="object"}var vd=Vl?sn(Vl):fE;function lb(o,u){return o===u||ec(o,u,gc(u))}function hb(o,u,d){return d=typeof d=="function"?d:t,ec(o,u,gc(u),d)}function db(o){return Md(o)&&o!=+o}function fb(o){if(KE(o))throw new Pe(r);return bh(o)}function pb(o){return o===null}function mb(o){return o==null}function Md(o){return typeof o=="number"||Tt(o)&&Ht(o)==zt}function ss(o){if(!Tt(o)||Ht(o)!=Wt)return!1;var u=Us(o);if(u===null)return!0;var d=it.call(u,"constructor")&&u.constructor;return typeof d=="function"&&d instanceof d&&Ls.call(d)==hg}var _c=Ql?sn(Ql):pE;function yb(o){return _d(o)&&o>=-Te&&o<=Te}var Pd=Wl?sn(Wl):mE;function pa(o){return typeof o=="string"||!Oe(o)&&Tt(o)&&Ht(o)==Bt}function on(o){return typeof o=="symbol"||Tt(o)&&Ht(o)==Mi}var Cr=Hl?sn(Hl):yE;function gb(o){return o===t}function Eb(o){return Tt(o)&&Ut(o)==Kt}function Tb(o){return Tt(o)&&Ht(o)==So}var wb=ra(nc),bb=ra(function(o,u){return o<=u});function Od(o){if(!o)return[];if(Xt(o))return pa(o)?Mn(o):Jt(o);if(Hr&&o[Hr])return Zy(o[Hr]());var u=Ut(o),d=u==Et?Vo:u==It?Ds:Sr;return d(o)}function mi(o){if(!o)return o===0?o:0;if(o=Tn(o),o===oe||o===-oe){var u=o<0?-1:1;return u*Xe}return o===o?o:0}function Ie(o){var u=mi(o),d=u%1;return u===u?d?u-d:u:0}function Dd(o){return o?Ji(Ie(o),0,qe):0}function Tn(o){if(typeof o=="number")return o;if(on(o))return Ge;if(gt(o)){var u=typeof o.valueOf=="function"?o.valueOf():o;o=gt(u)?u+"":u}if(typeof o!="string")return o===0?o:+o;o=Xl(o);var d=ny.test(o);return d||ry.test(o)?Ly(o.slice(2),d?2:8):ty.test(o)?Ge:+o}function Id(o){return zn(o,Zt(o))}function Nb(o){return o?Ji(Ie(o),-Te,Te):o===0?o:0}function et(o){return o==null?"":an(o)}var Ab=br(function(o,u){if(is(u)||Xt(u)){zn(u,Pt(u),o);return}for(var d in u)it.call(u,d)&&Jr(o,d,u[d])}),$d=br(function(o,u){zn(u,Zt(u),o)}),ma=br(function(o,u,d,y){zn(u,Zt(u),o,y)}),Cb=br(function(o,u,d,y){zn(u,Pt(u),o,y)}),Sb=di(zo);function Rb(o,u){var d=wr(o);return u==null?d:fh(d,u)}var xb=Be(function(o,u){o=at(o);var d=-1,y=u.length,w=y>2?u[2]:t;for(w&&Yt(u[0],u[1],w)&&(y=1);++d<y;)for(var C=u[d],v=Zt(C),M=-1,L=v.length;++M<L;){var G=v[M],z=o[G];(z===t||On(z,gr[G])&&!it.call(o,G))&&(o[G]=C[G])}return o}),_b=Be(function(o){return o.push(t,Xh),rn(Ld,t,o)});function vb(o,u){return Gl(o,be(u,3),Gn)}function Mb(o,u){return Gl(o,be(u,3),Jo)}function Pb(o,u){return o==null?o:Ko(o,be(u,3),Zt)}function Ob(o,u){return o==null?o:Eh(o,be(u,3),Zt)}function Db(o,u){return o&&Gn(o,be(u,3))}function Ib(o,u){return o&&Jo(o,be(u,3))}function $b(o){return o==null?[]:Ks(o,Pt(o))}function Lb(o){return o==null?[]:Ks(o,Zt(o))}function vc(o,u,d){var y=o==null?t:Xi(o,u);return y===t?d:y}function qb(o,u){return o!=null&&td(o,u,aE)}function Mc(o,u){return o!=null&&td(o,u,oE)}var Bb=Yh(function(o,u,d){u!=null&&typeof u.toString!="function"&&(u=qs.call(u)),o[u]=d},Oc(en)),Fb=Yh(function(o,u,d){u!=null&&typeof u.toString!="function"&&(u=qs.call(u)),it.call(o,u)?o[u].push(d):o[u]=[d]},be),Ub=Be(Zr);function Pt(o){return Xt(o)?hh(o):tc(o)}function Zt(o){return Xt(o)?hh(o,!0):gE(o)}function kb(o,u){var d={};return u=be(u,3),Gn(o,function(y,w,C){li(d,u(y,w,C),y)}),d}function jb(o,u){var d={};return u=be(u,3),Gn(o,function(y,w,C){li(d,w,u(y,w,C))}),d}var Vb=br(function(o,u,d){Js(o,u,d)}),Ld=br(function(o,u,d,y){Js(o,u,d,y)}),Qb=di(function(o,u){var d={};if(o==null)return d;var y=!1;u=ft(u,function(C){return C=qi(C,o),y||(y=C.length>1),C}),zn(o,mc(o),d),y&&(d=yn(d,p|m|T,BE));for(var w=u.length;w--;)oc(d,u[w]);return d});function Wb(o,u){return qd(o,da(be(u)))}var Hb=di(function(o,u){return o==null?{}:TE(o,u)});function qd(o,u){if(o==null)return{};var d=ft(mc(o),function(y){return[y]});return u=be(u),_h(o,d,function(y,w){return u(y,w[0])})}function Yb(o,u,d){u=qi(u,o);var y=-1,w=u.length;for(w||(w=1,o=t);++y<w;){var C=o==null?t:o[Kn(u[y])];C===t&&(y=w,C=d),o=pi(C)?C.call(o):C}return o}function Gb(o,u,d){return o==null?o:ts(o,u,d)}function zb(o,u,d,y){return y=typeof y=="function"?y:t,o==null?o:ts(o,u,d,y)}var Bd=Kh(Pt),Fd=Kh(Zt);function Kb(o,u,d){var y=Oe(o),w=y||Fi(o)||Cr(o);if(u=be(u,4),d==null){var C=o&&o.constructor;w?d=y?new C:[]:gt(o)?d=pi(C)?wr(Us(o)):{}:d={}}return(w?fn:Gn)(o,function(v,M,L){return u(d,v,M,L)}),d}function Jb(o,u){return o==null?!0:oc(o,u)}function Xb(o,u,d){return o==null?o:Dh(o,u,lc(d))}function Zb(o,u,d,y){return y=typeof y=="function"?y:t,o==null?o:Dh(o,u,lc(d),y)}function Sr(o){return o==null?[]:jo(o,Pt(o))}function eN(o){return o==null?[]:jo(o,Zt(o))}function tN(o,u,d){return d===t&&(d=u,u=t),d!==t&&(d=Tn(d),d=d===d?d:0),u!==t&&(u=Tn(u),u=u===u?u:0),Ji(Tn(o),u,d)}function nN(o,u,d){return u=mi(u),d===t?(d=u,u=0):d=mi(d),o=Tn(o),cE(o,u,d)}function iN(o,u,d){if(d&&typeof d!="boolean"&&Yt(o,u,d)&&(u=d=t),d===t&&(typeof u=="boolean"?(d=u,u=t):typeof o=="boolean"&&(d=o,o=t)),o===t&&u===t?(o=0,u=1):(o=mi(o),u===t?(u=o,o=0):u=mi(u)),o>u){var y=o;o=u,u=y}if(d||o%1||u%1){var w=uh();return Ft(o+w*(u-o+$y("1e-"+((w+"").length-1))),u)}return rc(o,u)}var rN=Nr(function(o,u,d){return u=u.toLowerCase(),o+(d?Ud(u):u)});function Ud(o){return Pc(et(o).toLowerCase())}function kd(o){return o=et(o),o&&o.replace(ay,Gy).replace(Sy,"")}function sN(o,u,d){o=et(o),u=an(u);var y=o.length;d=d===t?y:Ji(Ie(d),0,y);var w=d;return d-=u.length,d>=0&&o.slice(d,w)==u}function aN(o){return o=et(o),o&&Um.test(o)?o.replace(El,zy):o}function oN(o){return o=et(o),o&&Hm.test(o)?o.replace(Ro,"\\$&"):o}var cN=Nr(function(o,u,d){return o+(d?"-":"")+u.toLowerCase()}),uN=Nr(function(o,u,d){return o+(d?" ":"")+u.toLowerCase()}),lN=Qh("toLowerCase");function hN(o,u,d){o=et(o),u=Ie(u);var y=u?mr(o):0;if(!u||y>=u)return o;var w=(u-y)/2;return ia(Qs(w),d)+o+ia(Vs(w),d)}function dN(o,u,d){o=et(o),u=Ie(u);var y=u?mr(o):0;return u&&y<u?o+ia(u-y,d):o}function fN(o,u,d){o=et(o),u=Ie(u);var y=u?mr(o):0;return u&&y<u?ia(u-y,d)+o:o}function pN(o,u,d){return d||u==null?u=0:u&&(u=+u),bg(et(o).replace(xo,""),u||0)}function mN(o,u,d){return(d?Yt(o,u,d):u===t)?u=1:u=Ie(u),sc(et(o),u)}function yN(){var o=arguments,u=et(o[0]);return o.length<3?u:u.replace(o[1],o[2])}var gN=Nr(function(o,u,d){return o+(d?"_":"")+u.toLowerCase()});function EN(o,u,d){return d&&typeof d!="number"&&Yt(o,u,d)&&(u=d=t),d=d===t?qe:d>>>0,d?(o=et(o),o&&(typeof u=="string"||u!=null&&!_c(u))&&(u=an(u),!u&&pr(o))?Bi(Mn(o),0,d):o.split(u,d)):[]}var TN=Nr(function(o,u,d){return o+(d?" ":"")+Pc(u)});function wN(o,u,d){return o=et(o),d=d==null?0:Ji(Ie(d),0,o.length),u=an(u),o.slice(d,d+u.length)==u}function bN(o,u,d){var y=N.templateSettings;d&&Yt(o,u,d)&&(u=t),o=et(o),u=ma({},u,y,Jh);var w=ma({},u.imports,y.imports,Jh),C=Pt(w),v=jo(w,C),M,L,G=0,z=u.interpolate||_s,J="__p += '",ae=Qo((u.escape||_s).source+"|"+z.source+"|"+(z===Tl?ey:_s).source+"|"+(u.evaluate||_s).source+"|$","g"),fe="//# sourceURL="+(it.call(u,"sourceURL")?(u.sourceURL+"").replace(/\s/g," "):"lodash.templateSources["+ ++My+"]")+`
`;o.replace(ae,function(Ae,Ue,Ve,cn,Gt,un){return Ve||(Ve=cn),J+=o.slice(G,un).replace(oy,Ky),Ue&&(M=!0,J+=`' +
__e(`+Ue+`) +
'`),Gt&&(L=!0,J+=`';
`+Gt+`;
__p += '`),Ve&&(J+=`' +
((__t = (`+Ve+`)) == null ? '' : __t) +
'`),G=un+Ae.length,Ae}),J+=`';
`;var Ne=it.call(u,"variable")&&u.variable;if(!Ne)J=`with (obj) {
`+J+`
}
`;else if(Xm.test(Ne))throw new Pe(c);J=(L?J.replace(nt,""):J).replace(qm,"$1").replace(Bm,"$1;"),J="function("+(Ne||"obj")+`) {
`+(Ne?"":`obj || (obj = {});
`)+"var __t, __p = ''"+(M?", __e = _.escape":"")+(L?`, __j = Array.prototype.join;
function print() { __p += __j.call(arguments, '') }
`:`;
`)+J+`return __p
}`;var Le=Vd(function(){return Ze(C,fe+"return "+J).apply(t,v)});if(Le.source=J,xc(Le))throw Le;return Le}function NN(o){return et(o).toLowerCase()}function AN(o){return et(o).toUpperCase()}function CN(o,u,d){if(o=et(o),o&&(d||u===t))return Xl(o);if(!o||!(u=an(u)))return o;var y=Mn(o),w=Mn(u),C=Zl(y,w),v=eh(y,w)+1;return Bi(y,C,v).join("")}function SN(o,u,d){if(o=et(o),o&&(d||u===t))return o.slice(0,nh(o)+1);if(!o||!(u=an(u)))return o;var y=Mn(o),w=eh(y,Mn(u))+1;return Bi(y,0,w).join("")}function RN(o,u,d){if(o=et(o),o&&(d||u===t))return o.replace(xo,"");if(!o||!(u=an(u)))return o;var y=Mn(o),w=Zl(y,Mn(u));return Bi(y,w).join("")}function xN(o,u){var d=Re,y=D;if(gt(u)){var w="separator"in u?u.separator:w;d="length"in u?Ie(u.length):d,y="omission"in u?an(u.omission):y}o=et(o);var C=o.length;if(pr(o)){var v=Mn(o);C=v.length}if(d>=C)return o;var M=d-mr(y);if(M<1)return y;var L=v?Bi(v,0,M).join(""):o.slice(0,M);if(w===t)return L+y;if(v&&(M+=L.length-M),_c(w)){if(o.slice(M).search(w)){var G,z=L;for(w.global||(w=Qo(w.source,et(wl.exec(w))+"g")),w.lastIndex=0;G=w.exec(z);)var J=G.index;L=L.slice(0,J===t?M:J)}}else if(o.indexOf(an(w),M)!=M){var ae=L.lastIndexOf(w);ae>-1&&(L=L.slice(0,ae))}return L+y}function _N(o){return o=et(o),o&&Fm.test(o)?o.replace(gl,ig):o}var vN=Nr(function(o,u,d){return o+(d?" ":"")+u.toUpperCase()}),Pc=Qh("toUpperCase");function jd(o,u,d){return o=et(o),u=d?t:u,u===t?Xy(o)?ag(o):Vy(o):o.match(u)||[]}var Vd=Be(function(o,u){try{return rn(o,t,u)}catch(d){return xc(d)?d:new Pe(d)}}),MN=di(function(o,u){return fn(u,function(d){d=Kn(d),li(o,d,Sc(o[d],o))}),o});function PN(o){var u=o==null?0:o.length,d=be();return o=u?ft(o,function(y){if(typeof y[1]!="function")throw new pn(a);return[d(y[0]),y[1]]}):[],Be(function(y){for(var w=-1;++w<u;){var C=o[w];if(rn(C[0],this,y))return rn(C[1],this,y)}})}function ON(o){return iE(yn(o,p))}function Oc(o){return function(){return o}}function DN(o,u){return o==null||o!==o?u:o}var IN=Hh(),$N=Hh(!0);function en(o){return o}function Dc(o){return Nh(typeof o=="function"?o:yn(o,p))}function LN(o){return Ch(yn(o,p))}function qN(o,u){return Sh(o,yn(u,p))}var BN=Be(function(o,u){return function(d){return Zr(d,o,u)}}),FN=Be(function(o,u){return function(d){return Zr(o,d,u)}});function Ic(o,u,d){var y=Pt(u),w=Ks(u,y);d==null&&!(gt(u)&&(w.length||!y.length))&&(d=u,u=o,o=this,w=Ks(u,Pt(u)));var C=!(gt(d)&&"chain"in d)||!!d.chain,v=pi(o);return fn(w,function(M){var L=u[M];o[M]=L,v&&(o.prototype[M]=function(){var G=this.__chain__;if(C||G){var z=o(this.__wrapped__),J=z.__actions__=Jt(this.__actions__);return J.push({func:L,args:arguments,thisArg:o}),z.__chain__=G,z}return L.apply(o,Oi([this.value()],arguments))})}),o}function UN(){return $t._===this&&($t._=dg),this}function $c(){}function kN(o){return o=Ie(o),Be(function(u){return Rh(u,o)})}var jN=dc(ft),VN=dc(Yl),QN=dc(qo);function Qd(o){return Tc(o)?Bo(Kn(o)):wE(o)}function WN(o){return function(u){return o==null?t:Xi(o,u)}}var HN=Gh(),YN=Gh(!0);function Lc(){return[]}function qc(){return!1}function GN(){return{}}function zN(){return""}function KN(){return!0}function JN(o,u){if(o=Ie(o),o<1||o>Te)return[];var d=qe,y=Ft(o,qe);u=be(u),o-=qe;for(var w=ko(y,u);++d<o;)u(d);return w}function XN(o){return Oe(o)?ft(o,Kn):on(o)?[o]:Jt(ld(et(o)))}function ZN(o){var u=++lg;return et(o)+u}var eA=na(function(o,u){return o+u},0),tA=fc("ceil"),nA=na(function(o,u){return o/u},1),iA=fc("floor");function rA(o){return o&&o.length?zs(o,en,Xo):t}function sA(o,u){return o&&o.length?zs(o,be(u,2),Xo):t}function aA(o){return Kl(o,en)}function oA(o,u){return Kl(o,be(u,2))}function cA(o){return o&&o.length?zs(o,en,nc):t}function uA(o,u){return o&&o.length?zs(o,be(u,2),nc):t}var lA=na(function(o,u){return o*u},1),hA=fc("round"),dA=na(function(o,u){return o-u},0);function fA(o){return o&&o.length?Uo(o,en):0}function pA(o,u){return o&&o.length?Uo(o,be(u,2)):0}return N.after=Lw,N.ary=bd,N.assign=Ab,N.assignIn=$d,N.assignInWith=ma,N.assignWith=Cb,N.at=Sb,N.before=Nd,N.bind=Sc,N.bindAll=MN,N.bindKey=Ad,N.castArray=Gw,N.chain=Ed,N.chunk=iT,N.compact=rT,N.concat=sT,N.cond=PN,N.conforms=ON,N.constant=Oc,N.countBy=fw,N.create=Rb,N.curry=Cd,N.curryRight=Sd,N.debounce=Rd,N.defaults=xb,N.defaultsDeep=_b,N.defer=qw,N.delay=Bw,N.difference=aT,N.differenceBy=oT,N.differenceWith=cT,N.drop=uT,N.dropRight=lT,N.dropRightWhile=hT,N.dropWhile=dT,N.fill=fT,N.filter=mw,N.flatMap=Ew,N.flatMapDeep=Tw,N.flatMapDepth=ww,N.flatten=pd,N.flattenDeep=pT,N.flattenDepth=mT,N.flip=Fw,N.flow=IN,N.flowRight=$N,N.fromPairs=yT,N.functions=$b,N.functionsIn=Lb,N.groupBy=bw,N.initial=ET,N.intersection=TT,N.intersectionBy=wT,N.intersectionWith=bT,N.invert=Bb,N.invertBy=Fb,N.invokeMap=Aw,N.iteratee=Dc,N.keyBy=Cw,N.keys=Pt,N.keysIn=Zt,N.map=ua,N.mapKeys=kb,N.mapValues=jb,N.matches=LN,N.matchesProperty=qN,N.memoize=ha,N.merge=Vb,N.mergeWith=Ld,N.method=BN,N.methodOf=FN,N.mixin=Ic,N.negate=da,N.nthArg=kN,N.omit=Qb,N.omitBy=Wb,N.once=Uw,N.orderBy=Sw,N.over=jN,N.overArgs=kw,N.overEvery=VN,N.overSome=QN,N.partial=Rc,N.partialRight=xd,N.partition=Rw,N.pick=Hb,N.pickBy=qd,N.property=Qd,N.propertyOf=WN,N.pull=ST,N.pullAll=yd,N.pullAllBy=RT,N.pullAllWith=xT,N.pullAt=_T,N.range=HN,N.rangeRight=YN,N.rearg=jw,N.reject=vw,N.remove=vT,N.rest=Vw,N.reverse=Ac,N.sampleSize=Pw,N.set=Gb,N.setWith=zb,N.shuffle=Ow,N.slice=MT,N.sortBy=$w,N.sortedUniq=qT,N.sortedUniqBy=BT,N.split=EN,N.spread=Qw,N.tail=FT,N.take=UT,N.takeRight=kT,N.takeRightWhile=jT,N.takeWhile=VT,N.tap=rw,N.throttle=Ww,N.thru=ca,N.toArray=Od,N.toPairs=Bd,N.toPairsIn=Fd,N.toPath=XN,N.toPlainObject=Id,N.transform=Kb,N.unary=Hw,N.union=QT,N.unionBy=WT,N.unionWith=HT,N.uniq=YT,N.uniqBy=GT,N.uniqWith=zT,N.unset=Jb,N.unzip=Cc,N.unzipWith=gd,N.update=Xb,N.updateWith=Zb,N.values=Sr,N.valuesIn=eN,N.without=KT,N.words=jd,N.wrap=Yw,N.xor=JT,N.xorBy=XT,N.xorWith=ZT,N.zip=ew,N.zipObject=tw,N.zipObjectDeep=nw,N.zipWith=iw,N.entries=Bd,N.entriesIn=Fd,N.extend=$d,N.extendWith=ma,Ic(N,N),N.add=eA,N.attempt=Vd,N.camelCase=rN,N.capitalize=Ud,N.ceil=tA,N.clamp=tN,N.clone=zw,N.cloneDeep=Jw,N.cloneDeepWith=Xw,N.cloneWith=Kw,N.conformsTo=Zw,N.deburr=kd,N.defaultTo=DN,N.divide=nA,N.endsWith=sN,N.eq=On,N.escape=aN,N.escapeRegExp=oN,N.every=pw,N.find=yw,N.findIndex=dd,N.findKey=vb,N.findLast=gw,N.findLastIndex=fd,N.findLastKey=Mb,N.floor=iA,N.forEach=Td,N.forEachRight=wd,N.forIn=Pb,N.forInRight=Ob,N.forOwn=Db,N.forOwnRight=Ib,N.get=vc,N.gt=eb,N.gte=tb,N.has=qb,N.hasIn=Mc,N.head=md,N.identity=en,N.includes=Nw,N.indexOf=gT,N.inRange=nN,N.invoke=Ub,N.isArguments=tr,N.isArray=Oe,N.isArrayBuffer=nb,N.isArrayLike=Xt,N.isArrayLikeObject=At,N.isBoolean=ib,N.isBuffer=Fi,N.isDate=rb,N.isElement=sb,N.isEmpty=ab,N.isEqual=ob,N.isEqualWith=cb,N.isError=xc,N.isFinite=ub,N.isFunction=pi,N.isInteger=_d,N.isLength=fa,N.isMap=vd,N.isMatch=lb,N.isMatchWith=hb,N.isNaN=db,N.isNative=fb,N.isNil=mb,N.isNull=pb,N.isNumber=Md,N.isObject=gt,N.isObjectLike=Tt,N.isPlainObject=ss,N.isRegExp=_c,N.isSafeInteger=yb,N.isSet=Pd,N.isString=pa,N.isSymbol=on,N.isTypedArray=Cr,N.isUndefined=gb,N.isWeakMap=Eb,N.isWeakSet=Tb,N.join=NT,N.kebabCase=cN,N.last=En,N.lastIndexOf=AT,N.lowerCase=uN,N.lowerFirst=lN,N.lt=wb,N.lte=bb,N.max=rA,N.maxBy=sA,N.mean=aA,N.meanBy=oA,N.min=cA,N.minBy=uA,N.stubArray=Lc,N.stubFalse=qc,N.stubObject=GN,N.stubString=zN,N.stubTrue=KN,N.multiply=lA,N.nth=CT,N.noConflict=UN,N.noop=$c,N.now=la,N.pad=hN,N.padEnd=dN,N.padStart=fN,N.parseInt=pN,N.random=iN,N.reduce=xw,N.reduceRight=_w,N.repeat=mN,N.replace=yN,N.result=Yb,N.round=hA,N.runInContext=I,N.sample=Mw,N.size=Dw,N.snakeCase=gN,N.some=Iw,N.sortedIndex=PT,N.sortedIndexBy=OT,N.sortedIndexOf=DT,N.sortedLastIndex=IT,N.sortedLastIndexBy=$T,N.sortedLastIndexOf=LT,N.startCase=TN,N.startsWith=wN,N.subtract=dA,N.sum=fA,N.sumBy=pA,N.template=bN,N.times=JN,N.toFinite=mi,N.toInteger=Ie,N.toLength=Dd,N.toLower=NN,N.toNumber=Tn,N.toSafeInteger=Nb,N.toString=et,N.toUpper=AN,N.trim=CN,N.trimEnd=SN,N.trimStart=RN,N.truncate=xN,N.unescape=_N,N.uniqueId=ZN,N.upperCase=vN,N.upperFirst=Pc,N.each=Td,N.eachRight=wd,N.first=md,Ic(N,function(){var o={};return Gn(N,function(u,d){it.call(N.prototype,d)||(o[d]=u)}),o}(),{chain:!1}),N.VERSION=n,fn(["bind","bindKey","curry","curryRight","partial","partialRight"],function(o){N[o].placeholder=N}),fn(["drop","take"],function(o,u){ke.prototype[o]=function(d){d=d===t?1:_t(Ie(d),0);var y=this.__filtered__&&!u?new ke(this):this.clone();return y.__filtered__?y.__takeCount__=Ft(d,y.__takeCount__):y.__views__.push({size:Ft(d,qe),type:o+(y.__dir__<0?"Right":"")}),y},ke.prototype[o+"Right"]=function(d){return this.reverse()[o](d).reverse()}}),fn(["filter","map","takeWhile"],function(o,u){var d=u+1,y=d==ne||d==ye;ke.prototype[o]=function(w){var C=this.clone();return C.__iteratees__.push({iteratee:be(w,3),type:d}),C.__filtered__=C.__filtered__||y,C}}),fn(["head","last"],function(o,u){var d="take"+(u?"Right":"");ke.prototype[o]=function(){return this[d](1).value()[0]}}),fn(["initial","tail"],function(o,u){var d="drop"+(u?"":"Right");ke.prototype[o]=function(){return this.__filtered__?new ke(this):this[d](1)}}),ke.prototype.compact=function(){return this.filter(en)},ke.prototype.find=function(o){return this.filter(o).head()},ke.prototype.findLast=function(o){return this.reverse().find(o)},ke.prototype.invokeMap=Be(function(o,u){return typeof o=="function"?new ke(this):this.map(function(d){return Zr(d,o,u)})}),ke.prototype.reject=function(o){return this.filter(da(be(o)))},ke.prototype.slice=function(o,u){o=Ie(o);var d=this;return d.__filtered__&&(o>0||u<0)?new ke(d):(o<0?d=d.takeRight(-o):o&&(d=d.drop(o)),u!==t&&(u=Ie(u),d=u<0?d.dropRight(-u):d.take(u-o)),d)},ke.prototype.takeRightWhile=function(o){return this.reverse().takeWhile(o).reverse()},ke.prototype.toArray=function(){return this.take(qe)},Gn(ke.prototype,function(o,u){var d=/^(?:filter|find|map|reject)|While$/.test(u),y=/^(?:head|last)$/.test(u),w=N[y?"take"+(u=="last"?"Right":""):u],C=y||/^find/.test(u);w&&(N.prototype[u]=function(){var v=this.__wrapped__,M=y?[1]:arguments,L=v instanceof ke,G=M[0],z=L||Oe(v),J=function(Ue){var Ve=w.apply(N,Oi([Ue],M));return y&&ae?Ve[0]:Ve};z&&d&&typeof G=="function"&&G.length!=1&&(L=z=!1);var ae=this.__chain__,fe=!!this.__actions__.length,Ne=C&&!ae,Le=L&&!fe;if(!C&&z){v=Le?v:new ke(this);var Ae=o.apply(v,M);return Ae.__actions__.push({func:ca,args:[J],thisArg:t}),new mn(Ae,ae)}return Ne&&Le?o.apply(this,M):(Ae=this.thru(J),Ne?y?Ae.value()[0]:Ae.value():Ae)})}),fn(["pop","push","shift","sort","splice","unshift"],function(o){var u=Is[o],d=/^(?:push|sort|unshift)$/.test(o)?"tap":"thru",y=/^(?:pop|shift)$/.test(o);N.prototype[o]=function(){var w=arguments;if(y&&!this.__chain__){var C=this.value();return u.apply(Oe(C)?C:[],w)}return this[d](function(v){return u.apply(Oe(v)?v:[],w)})}}),Gn(ke.prototype,function(o,u){var d=N[u];if(d){var y=d.name+"";it.call(Tr,y)||(Tr[y]=[]),Tr[y].push({name:u,func:d})}}),Tr[ta(t,F).name]=[{name:"wrapper",func:t}],ke.prototype.clone=_g,ke.prototype.reverse=vg,ke.prototype.value=Mg,N.prototype.at=sw,N.prototype.chain=aw,N.prototype.commit=ow,N.prototype.next=cw,N.prototype.plant=lw,N.prototype.reverse=hw,N.prototype.toJSON=N.prototype.valueOf=N.prototype.value=dw,N.prototype.first=N.prototype.head,Hr&&(N.prototype[Hr]=uw),N},yr=og();Yi?((Yi.exports=yr)._=yr,Do._=yr):$t._=yr}).call(ir)})(Ba,Ba.exports);Ba.exports;class _a{static getInheritanceTree(e){const t=[e],n=i=>{const r=Object.getPrototypeOf(i);r&&r.name&&(t.push(r),n(r))};return n(e),t}static isInherited(e,t){return e.prototype instanceof t}static filterByTarget(e,t){return t?e.filter(n=>n.target&&t.indexOf(n.target)!==-1):e}}class hp{constructor(){this.tables=[],this.trees=[],this.entityRepositories=[],this.transactionEntityManagers=[],this.transactionRepositories=[],this.namingStrategies=[],this.entitySubscribers=[],this.indices=[],this.foreignKeys=[],this.uniques=[],this.checks=[],this.exclusions=[],this.columns=[],this.generations=[],this.relations=[],this.joinColumns=[],this.joinTables=[],this.entityListeners=[],this.relationCounts=[],this.relationIds=[],this.embeddeds=[],this.inheritances=[],this.discriminatorValues=[]}filterTables(e){return this.filterByTarget(this.tables,e)}filterColumns(e){return this.filterByTargetAndWithoutDuplicateProperties(this.columns,e)}findGenerated(e,t){return this.generations.find(n=>(Array.isArray(e)?e.indexOf(n.target)!==-1:n.target===e)&&n.propertyName===t)}findTree(e){return this.trees.find(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterRelations(e){return this.filterByTargetAndWithoutDuplicateRelationProperties(this.relations,e)}filterRelationIds(e){return this.filterByTargetAndWithoutDuplicateProperties(this.relationIds,e)}filterRelationCounts(e){return this.filterByTargetAndWithoutDuplicateProperties(this.relationCounts,e)}filterIndices(e){return this.indices.filter(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterForeignKeys(e){return this.foreignKeys.filter(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterUniques(e){return this.uniques.filter(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterChecks(e){return this.checks.filter(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterExclusions(e){return this.exclusions.filter(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterListeners(e){return this.filterByTarget(this.entityListeners,e)}filterEmbeddeds(e){return this.filterByTargetAndWithoutDuplicateEmbeddedProperties(this.embeddeds,e)}findJoinTable(e,t){return this.joinTables.find(n=>n.target===e&&n.propertyName===t)}filterJoinColumns(e,t){return this.joinColumns.filter(n=>n.target===e&&n.propertyName===t)}filterSubscribers(e){return this.filterByTarget(this.entitySubscribers,e)}filterNamingStrategies(e){return this.filterByTarget(this.namingStrategies,e)}filterTransactionEntityManagers(e,t){return this.transactionEntityManagers.filter(n=>(Array.isArray(e)?e.indexOf(n.target)!==-1:n.target===e)&&n.methodName===t)}filterTransactionRepository(e,t){return this.transactionRepositories.filter(n=>(Array.isArray(e)?e.indexOf(n.target)!==-1:n.target===e)&&n.methodName===t)}filterSingleTableChildren(e){return this.tables.filter(t=>typeof t.target=="function"&&typeof e=="function"&&_a.isInherited(t.target,e)&&t.type==="entity-child")}findInheritanceType(e){return this.inheritances.find(t=>t.target===e)}findDiscriminatorValue(e){return this.discriminatorValues.find(t=>t.target===e)}filterByTarget(e,t){return e.filter(n=>Array.isArray(t)?t.indexOf(n.target)!==-1:n.target===t)}filterByTargetAndWithoutDuplicateProperties(e,t){const n=[];return e.forEach(i=>{(Array.isArray(t)?t.indexOf(i.target)!==-1:i.target===t)&&(n.find(a=>a.propertyName===i.propertyName)||n.push(i))}),n}filterByTargetAndWithoutDuplicateRelationProperties(e,t){const n=[];return e.forEach(i=>{if(Array.isArray(t)?t.indexOf(i.target)!==-1:i.target===t){const a=n.findIndex(c=>c.propertyName===i.propertyName);if(Array.isArray(t)&&a!==-1&&t.indexOf(i.target)<t.indexOf(n[a].target)){const c=Object.create(n[a]);c.type=i.type,n[a]=c}else a===-1&&n.push(i)}}),n}filterByTargetAndWithoutDuplicateEmbeddedProperties(e,t){const n=[];return e.forEach(i=>{(Array.isArray(t)?t.indexOf(i.target)!==-1:i.target===t)&&(n.find(c=>c.prefix===i.prefix&&c.propertyName===i.propertyName)||n.push(i))}),n}}var eo={},to={};to.byteLength=bC;to.toByteArray=AC;to.fromByteArray=RC;var Jn=[],wn=[],TC=typeof Uint8Array<"u"?Uint8Array:Array,jc="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var Rr=0,wC=jc.length;Rr<wC;++Rr)Jn[Rr]=jc[Rr],wn[jc.charCodeAt(Rr)]=Rr;wn[45]=62;wn[95]=63;function dp(s){var e=s.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=s.indexOf("=");t===-1&&(t=e);var n=t===e?0:4-t%4;return[t,n]}function bC(s){var e=dp(s),t=e[0],n=e[1];return(t+n)*3/4-n}function NC(s,e,t){return(e+t)*3/4-t}function AC(s){var e,t=dp(s),n=t[0],i=t[1],r=new TC(NC(s,n,i)),a=0,c=i>0?n-4:n,l;for(l=0;l<c;l+=4)e=wn[s.charCodeAt(l)]<<18|wn[s.charCodeAt(l+1)]<<12|wn[s.charCodeAt(l+2)]<<6|wn[s.charCodeAt(l+3)],r[a++]=e>>16&255,r[a++]=e>>8&255,r[a++]=e&255;return i===2&&(e=wn[s.charCodeAt(l)]<<2|wn[s.charCodeAt(l+1)]>>4,r[a++]=e&255),i===1&&(e=wn[s.charCodeAt(l)]<<10|wn[s.charCodeAt(l+1)]<<4|wn[s.charCodeAt(l+2)]>>2,r[a++]=e>>8&255,r[a++]=e&255),r}function CC(s){return Jn[s>>18&63]+Jn[s>>12&63]+Jn[s>>6&63]+Jn[s&63]}function SC(s,e,t){for(var n,i=[],r=e;r<t;r+=3)n=(s[r]<<16&16711680)+(s[r+1]<<8&65280)+(s[r+2]&255),i.push(CC(n));return i.join("")}function RC(s){for(var e,t=s.length,n=t%3,i=[],r=16383,a=0,c=t-n;a<c;a+=r)i.push(SC(s,a,a+r>c?c:a+r));return n===1?(e=s[t-1],i.push(Jn[e>>2]+Jn[e<<4&63]+"==")):n===2&&(e=(s[t-2]<<8)+s[t-1],i.push(Jn[e>>10]+Jn[e>>4&63]+Jn[e<<2&63]+"=")),i.join("")}var Uu={};/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */Uu.read=function(s,e,t,n,i){var r,a,c=i*8-n-1,l=(1<<c)-1,h=l>>1,f=-7,p=t?i-1:0,m=t?-1:1,T=s[e+p];for(p+=m,r=T&(1<<-f)-1,T>>=-f,f+=c;f>0;r=r*256+s[e+p],p+=m,f-=8);for(a=r&(1<<-f)-1,r>>=-f,f+=n;f>0;a=a*256+s[e+p],p+=m,f-=8);if(r===0)r=1-h;else{if(r===l)return a?NaN:(T?-1:1)*(1/0);a=a+Math.pow(2,n),r=r-h}return(T?-1:1)*a*Math.pow(2,r-n)};Uu.write=function(s,e,t,n,i,r){var a,c,l,h=r*8-i-1,f=(1<<h)-1,p=f>>1,m=i===23?Math.pow(2,-24)-Math.pow(2,-77):0,T=n?0:r-1,A=n?1:-1,S=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(c=isNaN(e)?1:0,a=f):(a=Math.floor(Math.log(e)/Math.LN2),e*(l=Math.pow(2,-a))<1&&(a--,l*=2),a+p>=1?e+=m/l:e+=m*Math.pow(2,1-p),e*l>=2&&(a++,l/=2),a+p>=f?(c=0,a=f):a+p>=1?(c=(e*l-1)*Math.pow(2,i),a=a+p):(c=e*Math.pow(2,p-1)*Math.pow(2,i),a=0));i>=8;s[t+T]=c&255,T+=A,c/=256,i-=8);for(a=a<<i|c,h+=i;h>0;s[t+T]=a&255,T+=A,a/=256,h-=8);s[t+T-A]|=S*128};/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */(function(s){const e=to,t=Uu,n=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;s.Buffer=c,s.SlowBuffer=B,s.INSPECT_MAX_BYTES=50;const i=2147483647;s.kMaxLength=i,c.TYPED_ARRAY_SUPPORT=r(),!c.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function r(){try{const b=new Uint8Array(1),g={foo:function(){return 42}};return Object.setPrototypeOf(g,Uint8Array.prototype),Object.setPrototypeOf(b,g),b.foo()===42}catch{return!1}}Object.defineProperty(c.prototype,"parent",{enumerable:!0,get:function(){if(c.isBuffer(this))return this.buffer}}),Object.defineProperty(c.prototype,"offset",{enumerable:!0,get:function(){if(c.isBuffer(this))return this.byteOffset}});function a(b){if(b>i)throw new RangeError('The value "'+b+'" is invalid for option "size"');const g=new Uint8Array(b);return Object.setPrototypeOf(g,c.prototype),g}function c(b,g,E){if(typeof b=="number"){if(typeof g=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return p(b)}return l(b,g,E)}c.poolSize=8192;function l(b,g,E){if(typeof b=="string")return m(b,g);if(ArrayBuffer.isView(b))return A(b);if(b==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof b);if(Bt(b,ArrayBuffer)||b&&Bt(b.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(Bt(b,SharedArrayBuffer)||b&&Bt(b.buffer,SharedArrayBuffer)))return S(b,g,E);if(typeof b=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const R=b.valueOf&&b.valueOf();if(R!=null&&R!==b)return c.from(R,g,E);const O=P(b);if(O)return O;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof b[Symbol.toPrimitive]=="function")return c.from(b[Symbol.toPrimitive]("string"),g,E);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof b)}c.from=function(b,g,E){return l(b,g,E)},Object.setPrototypeOf(c.prototype,Uint8Array.prototype),Object.setPrototypeOf(c,Uint8Array);function h(b){if(typeof b!="number")throw new TypeError('"size" argument must be of type number');if(b<0)throw new RangeError('The value "'+b+'" is invalid for option "size"')}function f(b,g,E){return h(b),b<=0?a(b):g!==void 0?typeof E=="string"?a(b).fill(g,E):a(b).fill(g):a(b)}c.alloc=function(b,g,E){return f(b,g,E)};function p(b){return h(b),a(b<0?0:F(b)|0)}c.allocUnsafe=function(b){return p(b)},c.allocUnsafeSlow=function(b){return p(b)};function m(b,g){if((typeof g!="string"||g==="")&&(g="utf8"),!c.isEncoding(g))throw new TypeError("Unknown encoding: "+g);const E=q(b,g)|0;let R=a(E);const O=R.write(b,g);return O!==E&&(R=R.slice(0,O)),R}function T(b){const g=b.length<0?0:F(b.length)|0,E=a(g);for(let R=0;R<g;R+=1)E[R]=b[R]&255;return E}function A(b){if(Bt(b,Uint8Array)){const g=new Uint8Array(b);return S(g.buffer,g.byteOffset,g.byteLength)}return T(b)}function S(b,g,E){if(g<0||b.byteLength<g)throw new RangeError('"offset" is outside of buffer bounds');if(b.byteLength<g+(E||0))throw new RangeError('"length" is outside of buffer bounds');let R;return g===void 0&&E===void 0?R=new Uint8Array(b):E===void 0?R=new Uint8Array(b,g):R=new Uint8Array(b,g,E),Object.setPrototypeOf(R,c.prototype),R}function P(b){if(c.isBuffer(b)){const g=F(b.length)|0,E=a(g);return E.length===0||b.copy(E,0,0,g),E}if(b.length!==void 0)return typeof b.length!="number"||Mi(b.length)?a(0):T(b);if(b.type==="Buffer"&&Array.isArray(b.data))return T(b.data)}function F(b){if(b>=i)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+i.toString(16)+" bytes");return b|0}function B(b){return+b!=b&&(b=0),c.alloc(+b)}c.isBuffer=function(g){return g!=null&&g._isBuffer===!0&&g!==c.prototype},c.compare=function(g,E){if(Bt(g,Uint8Array)&&(g=c.from(g,g.offset,g.byteLength)),Bt(E,Uint8Array)&&(E=c.from(E,E.offset,E.byteLength)),!c.isBuffer(g)||!c.isBuffer(E))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(g===E)return 0;let R=g.length,O=E.length;for(let U=0,H=Math.min(R,O);U<H;++U)if(g[U]!==E[U]){R=g[U],O=E[U];break}return R<O?-1:O<R?1:0},c.isEncoding=function(g){switch(String(g).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},c.concat=function(g,E){if(!Array.isArray(g))throw new TypeError('"list" argument must be an Array of Buffers');if(g.length===0)return c.alloc(0);let R;if(E===void 0)for(E=0,R=0;R<g.length;++R)E+=g[R].length;const O=c.allocUnsafe(E);let U=0;for(R=0;R<g.length;++R){let H=g[R];if(Bt(H,Uint8Array))U+H.length>O.length?(c.isBuffer(H)||(H=c.from(H)),H.copy(O,U)):Uint8Array.prototype.set.call(O,H,U);else if(c.isBuffer(H))H.copy(O,U);else throw new TypeError('"list" argument must be an Array of Buffers');U+=H.length}return O};function q(b,g){if(c.isBuffer(b))return b.length;if(ArrayBuffer.isView(b)||Bt(b,ArrayBuffer))return b.byteLength;if(typeof b!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof b);const E=b.length,R=arguments.length>2&&arguments[2]===!0;if(!R&&E===0)return 0;let O=!1;for(;;)switch(g){case"ascii":case"latin1":case"binary":return E;case"utf8":case"utf-8":return Wt(b).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return E*2;case"hex":return E>>>1;case"base64":return Yn(b).length;default:if(O)return R?-1:Wt(b).length;g=(""+g).toLowerCase(),O=!0}}c.byteLength=q;function Z(b,g,E){let R=!1;if((g===void 0||g<0)&&(g=0),g>this.length||((E===void 0||E>this.length)&&(E=this.length),E<=0)||(E>>>=0,g>>>=0,E<=g))return"";for(b||(b="utf8");;)switch(b){case"hex":return Xe(this,g,E);case"utf8":case"utf-8":return ne(this,g,E);case"ascii":return oe(this,g,E);case"latin1":case"binary":return Te(this,g,E);case"base64":return V(this,g,E);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return Ge(this,g,E);default:if(R)throw new TypeError("Unknown encoding: "+b);b=(b+"").toLowerCase(),R=!0}}c.prototype._isBuffer=!0;function re(b,g,E){const R=b[g];b[g]=b[E],b[E]=R}c.prototype.swap16=function(){const g=this.length;if(g%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let E=0;E<g;E+=2)re(this,E,E+1);return this},c.prototype.swap32=function(){const g=this.length;if(g%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let E=0;E<g;E+=4)re(this,E,E+3),re(this,E+1,E+2);return this},c.prototype.swap64=function(){const g=this.length;if(g%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let E=0;E<g;E+=8)re(this,E,E+7),re(this,E+1,E+6),re(this,E+2,E+5),re(this,E+3,E+4);return this},c.prototype.toString=function(){const g=this.length;return g===0?"":arguments.length===0?ne(this,0,g):Z.apply(this,arguments)},c.prototype.toLocaleString=c.prototype.toString,c.prototype.equals=function(g){if(!c.isBuffer(g))throw new TypeError("Argument must be a Buffer");return this===g?!0:c.compare(this,g)===0},c.prototype.inspect=function(){let g="";const E=s.INSPECT_MAX_BYTES;return g=this.toString("hex",0,E).replace(/(.{2})/g,"$1 ").trim(),this.length>E&&(g+=" ... "),"<Buffer "+g+">"},n&&(c.prototype[n]=c.prototype.inspect),c.prototype.compare=function(g,E,R,O,U){if(Bt(g,Uint8Array)&&(g=c.from(g,g.offset,g.byteLength)),!c.isBuffer(g))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof g);if(E===void 0&&(E=0),R===void 0&&(R=g?g.length:0),O===void 0&&(O=0),U===void 0&&(U=this.length),E<0||R>g.length||O<0||U>this.length)throw new RangeError("out of range index");if(O>=U&&E>=R)return 0;if(O>=U)return-1;if(E>=R)return 1;if(E>>>=0,R>>>=0,O>>>=0,U>>>=0,this===g)return 0;let H=U-O,De=R-E;const ot=Math.min(H,De),rt=this.slice(O,U),ct=g.slice(E,R);for(let nt=0;nt<ot;++nt)if(rt[nt]!==ct[nt]){H=rt[nt],De=ct[nt];break}return H<De?-1:De<H?1:0};function Ee(b,g,E,R,O){if(b.length===0)return-1;if(typeof E=="string"?(R=E,E=0):E>2147483647?E=2147483647:E<-2147483648&&(E=-2147483648),E=+E,Mi(E)&&(E=O?0:b.length-1),E<0&&(E=b.length+E),E>=b.length){if(O)return-1;E=b.length-1}else if(E<0)if(O)E=0;else return-1;if(typeof g=="string"&&(g=c.from(g,R)),c.isBuffer(g))return g.length===0?-1:Se(b,g,E,R,O);if(typeof g=="number")return g=g&255,typeof Uint8Array.prototype.indexOf=="function"?O?Uint8Array.prototype.indexOf.call(b,g,E):Uint8Array.prototype.lastIndexOf.call(b,g,E):Se(b,[g],E,R,O);throw new TypeError("val must be string, number or Buffer")}function Se(b,g,E,R,O){let U=1,H=b.length,De=g.length;if(R!==void 0&&(R=String(R).toLowerCase(),R==="ucs2"||R==="ucs-2"||R==="utf16le"||R==="utf-16le")){if(b.length<2||g.length<2)return-1;U=2,H/=2,De/=2,E/=2}function ot(ct,nt){return U===1?ct[nt]:ct.readUInt16BE(nt*U)}let rt;if(O){let ct=-1;for(rt=E;rt<H;rt++)if(ot(b,rt)===ot(g,ct===-1?0:rt-ct)){if(ct===-1&&(ct=rt),rt-ct+1===De)return ct*U}else ct!==-1&&(rt-=rt-ct),ct=-1}else for(E+De>H&&(E=H-De),rt=E;rt>=0;rt--){let ct=!0;for(let nt=0;nt<De;nt++)if(ot(b,rt+nt)!==ot(g,nt)){ct=!1;break}if(ct)return rt}return-1}c.prototype.includes=function(g,E,R){return this.indexOf(g,E,R)!==-1},c.prototype.indexOf=function(g,E,R){return Ee(this,g,E,R,!0)},c.prototype.lastIndexOf=function(g,E,R){return Ee(this,g,E,R,!1)};function me(b,g,E,R){E=Number(E)||0;const O=b.length-E;R?(R=Number(R),R>O&&(R=O)):R=O;const U=g.length;R>U/2&&(R=U/2);let H;for(H=0;H<R;++H){const De=parseInt(g.substr(H*2,2),16);if(Mi(De))return H;b[E+H]=De}return H}function W(b,g,E,R){return It(Wt(g,b.length-E),b,E,R)}function Re(b,g,E,R){return It(hr(g),b,E,R)}function D(b,g,E,R){return It(Yn(g),b,E,R)}function se(b,g,E,R){return It(K(g,b.length-E),b,E,R)}c.prototype.write=function(g,E,R,O){if(E===void 0)O="utf8",R=this.length,E=0;else if(R===void 0&&typeof E=="string")O=E,R=this.length,E=0;else if(isFinite(E))E=E>>>0,isFinite(R)?(R=R>>>0,O===void 0&&(O="utf8")):(O=R,R=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const U=this.length-E;if((R===void 0||R>U)&&(R=U),g.length>0&&(R<0||E<0)||E>this.length)throw new RangeError("Attempt to write outside buffer bounds");O||(O="utf8");let H=!1;for(;;)switch(O){case"hex":return me(this,g,E,R);case"utf8":case"utf-8":return W(this,g,E,R);case"ascii":case"latin1":case"binary":return Re(this,g,E,R);case"base64":return D(this,g,E,R);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return se(this,g,E,R);default:if(H)throw new TypeError("Unknown encoding: "+O);O=(""+O).toLowerCase(),H=!0}},c.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function V(b,g,E){return g===0&&E===b.length?e.fromByteArray(b):e.fromByteArray(b.slice(g,E))}function ne(b,g,E){E=Math.min(b.length,E);const R=[];let O=g;for(;O<E;){const U=b[O];let H=null,De=U>239?4:U>223?3:U>191?2:1;if(O+De<=E){let ot,rt,ct,nt;switch(De){case 1:U<128&&(H=U);break;case 2:ot=b[O+1],(ot&192)===128&&(nt=(U&31)<<6|ot&63,nt>127&&(H=nt));break;case 3:ot=b[O+1],rt=b[O+2],(ot&192)===128&&(rt&192)===128&&(nt=(U&15)<<12|(ot&63)<<6|rt&63,nt>2047&&(nt<55296||nt>57343)&&(H=nt));break;case 4:ot=b[O+1],rt=b[O+2],ct=b[O+3],(ot&192)===128&&(rt&192)===128&&(ct&192)===128&&(nt=(U&15)<<18|(ot&63)<<12|(rt&63)<<6|ct&63,nt>65535&&nt<1114112&&(H=nt))}}H===null?(H=65533,De=1):H>65535&&(H-=65536,R.push(H>>>10&1023|55296),H=56320|H&1023),R.push(H),O+=De}return ye(R)}const ce=4096;function ye(b){const g=b.length;if(g<=ce)return String.fromCharCode.apply(String,b);let E="",R=0;for(;R<g;)E+=String.fromCharCode.apply(String,b.slice(R,R+=ce));return E}function oe(b,g,E){let R="";E=Math.min(b.length,E);for(let O=g;O<E;++O)R+=String.fromCharCode(b[O]&127);return R}function Te(b,g,E){let R="";E=Math.min(b.length,E);for(let O=g;O<E;++O)R+=String.fromCharCode(b[O]);return R}function Xe(b,g,E){const R=b.length;(!g||g<0)&&(g=0),(!E||E<0||E>R)&&(E=R);let O="";for(let U=g;U<E;++U)O+=Co[b[U]];return O}function Ge(b,g,E){const R=b.slice(g,E);let O="";for(let U=0;U<R.length-1;U+=2)O+=String.fromCharCode(R[U]+R[U+1]*256);return O}c.prototype.slice=function(g,E){const R=this.length;g=~~g,E=E===void 0?R:~~E,g<0?(g+=R,g<0&&(g=0)):g>R&&(g=R),E<0?(E+=R,E<0&&(E=0)):E>R&&(E=R),E<g&&(E=g);const O=this.subarray(g,E);return Object.setPrototypeOf(O,c.prototype),O};function qe(b,g,E){if(b%1!==0||b<0)throw new RangeError("offset is not uint");if(b+g>E)throw new RangeError("Trying to access beyond buffer length")}c.prototype.readUintLE=c.prototype.readUIntLE=function(g,E,R){g=g>>>0,E=E>>>0,R||qe(g,E,this.length);let O=this[g],U=1,H=0;for(;++H<E&&(U*=256);)O+=this[g+H]*U;return O},c.prototype.readUintBE=c.prototype.readUIntBE=function(g,E,R){g=g>>>0,E=E>>>0,R||qe(g,E,this.length);let O=this[g+--E],U=1;for(;E>0&&(U*=256);)O+=this[g+--E]*U;return O},c.prototype.readUint8=c.prototype.readUInt8=function(g,E){return g=g>>>0,E||qe(g,1,this.length),this[g]},c.prototype.readUint16LE=c.prototype.readUInt16LE=function(g,E){return g=g>>>0,E||qe(g,2,this.length),this[g]|this[g+1]<<8},c.prototype.readUint16BE=c.prototype.readUInt16BE=function(g,E){return g=g>>>0,E||qe(g,2,this.length),this[g]<<8|this[g+1]},c.prototype.readUint32LE=c.prototype.readUInt32LE=function(g,E){return g=g>>>0,E||qe(g,4,this.length),(this[g]|this[g+1]<<8|this[g+2]<<16)+this[g+3]*16777216},c.prototype.readUint32BE=c.prototype.readUInt32BE=function(g,E){return g=g>>>0,E||qe(g,4,this.length),this[g]*16777216+(this[g+1]<<16|this[g+2]<<8|this[g+3])},c.prototype.readBigUInt64LE=Kt(function(g){g=g>>>0,Dt(g,"offset");const E=this[g],R=this[g+7];(E===void 0||R===void 0)&&Et(g,this.length-8);const O=E+this[++g]*2**8+this[++g]*2**16+this[++g]*2**24,U=this[++g]+this[++g]*2**8+this[++g]*2**16+R*2**24;return BigInt(O)+(BigInt(U)<<BigInt(32))}),c.prototype.readBigUInt64BE=Kt(function(g){g=g>>>0,Dt(g,"offset");const E=this[g],R=this[g+7];(E===void 0||R===void 0)&&Et(g,this.length-8);const O=E*2**24+this[++g]*2**16+this[++g]*2**8+this[++g],U=this[++g]*2**24+this[++g]*2**16+this[++g]*2**8+R;return(BigInt(O)<<BigInt(32))+BigInt(U)}),c.prototype.readIntLE=function(g,E,R){g=g>>>0,E=E>>>0,R||qe(g,E,this.length);let O=this[g],U=1,H=0;for(;++H<E&&(U*=256);)O+=this[g+H]*U;return U*=128,O>=U&&(O-=Math.pow(2,8*E)),O},c.prototype.readIntBE=function(g,E,R){g=g>>>0,E=E>>>0,R||qe(g,E,this.length);let O=E,U=1,H=this[g+--O];for(;O>0&&(U*=256);)H+=this[g+--O]*U;return U*=128,H>=U&&(H-=Math.pow(2,8*E)),H},c.prototype.readInt8=function(g,E){return g=g>>>0,E||qe(g,1,this.length),this[g]&128?(255-this[g]+1)*-1:this[g]},c.prototype.readInt16LE=function(g,E){g=g>>>0,E||qe(g,2,this.length);const R=this[g]|this[g+1]<<8;return R&32768?R|4294901760:R},c.prototype.readInt16BE=function(g,E){g=g>>>0,E||qe(g,2,this.length);const R=this[g+1]|this[g]<<8;return R&32768?R|4294901760:R},c.prototype.readInt32LE=function(g,E){return g=g>>>0,E||qe(g,4,this.length),this[g]|this[g+1]<<8|this[g+2]<<16|this[g+3]<<24},c.prototype.readInt32BE=function(g,E){return g=g>>>0,E||qe(g,4,this.length),this[g]<<24|this[g+1]<<16|this[g+2]<<8|this[g+3]},c.prototype.readBigInt64LE=Kt(function(g){g=g>>>0,Dt(g,"offset");const E=this[g],R=this[g+7];(E===void 0||R===void 0)&&Et(g,this.length-8);const O=this[g+4]+this[g+5]*2**8+this[g+6]*2**16+(R<<24);return(BigInt(O)<<BigInt(32))+BigInt(E+this[++g]*2**8+this[++g]*2**16+this[++g]*2**24)}),c.prototype.readBigInt64BE=Kt(function(g){g=g>>>0,Dt(g,"offset");const E=this[g],R=this[g+7];(E===void 0||R===void 0)&&Et(g,this.length-8);const O=(E<<24)+this[++g]*2**16+this[++g]*2**8+this[++g];return(BigInt(O)<<BigInt(32))+BigInt(this[++g]*2**24+this[++g]*2**16+this[++g]*2**8+R)}),c.prototype.readFloatLE=function(g,E){return g=g>>>0,E||qe(g,4,this.length),t.read(this,g,!0,23,4)},c.prototype.readFloatBE=function(g,E){return g=g>>>0,E||qe(g,4,this.length),t.read(this,g,!1,23,4)},c.prototype.readDoubleLE=function(g,E){return g=g>>>0,E||qe(g,8,this.length),t.read(this,g,!0,52,8)},c.prototype.readDoubleBE=function(g,E){return g=g>>>0,E||qe(g,8,this.length),t.read(this,g,!1,52,8)};function tt(b,g,E,R,O,U){if(!c.isBuffer(b))throw new TypeError('"buffer" argument must be a Buffer instance');if(g>O||g<U)throw new RangeError('"value" argument is out of bounds');if(E+R>b.length)throw new RangeError("Index out of range")}c.prototype.writeUintLE=c.prototype.writeUIntLE=function(g,E,R,O){if(g=+g,E=E>>>0,R=R>>>0,!O){const De=Math.pow(2,8*R)-1;tt(this,g,E,R,De,0)}let U=1,H=0;for(this[E]=g&255;++H<R&&(U*=256);)this[E+H]=g/U&255;return E+R},c.prototype.writeUintBE=c.prototype.writeUIntBE=function(g,E,R,O){if(g=+g,E=E>>>0,R=R>>>0,!O){const De=Math.pow(2,8*R)-1;tt(this,g,E,R,De,0)}let U=R-1,H=1;for(this[E+U]=g&255;--U>=0&&(H*=256);)this[E+U]=g/H&255;return E+R},c.prototype.writeUint8=c.prototype.writeUInt8=function(g,E,R){return g=+g,E=E>>>0,R||tt(this,g,E,1,255,0),this[E]=g&255,E+1},c.prototype.writeUint16LE=c.prototype.writeUInt16LE=function(g,E,R){return g=+g,E=E>>>0,R||tt(this,g,E,2,65535,0),this[E]=g&255,this[E+1]=g>>>8,E+2},c.prototype.writeUint16BE=c.prototype.writeUInt16BE=function(g,E,R){return g=+g,E=E>>>0,R||tt(this,g,E,2,65535,0),this[E]=g>>>8,this[E+1]=g&255,E+2},c.prototype.writeUint32LE=c.prototype.writeUInt32LE=function(g,E,R){return g=+g,E=E>>>0,R||tt(this,g,E,4,4294967295,0),this[E+3]=g>>>24,this[E+2]=g>>>16,this[E+1]=g>>>8,this[E]=g&255,E+4},c.prototype.writeUint32BE=c.prototype.writeUInt32BE=function(g,E,R){return g=+g,E=E>>>0,R||tt(this,g,E,4,4294967295,0),this[E]=g>>>24,this[E+1]=g>>>16,this[E+2]=g>>>8,this[E+3]=g&255,E+4};function k(b,g,E,R,O){yt(g,R,O,b,E,7);let U=Number(g&BigInt(4294967295));b[E++]=U,U=U>>8,b[E++]=U,U=U>>8,b[E++]=U,U=U>>8,b[E++]=U;let H=Number(g>>BigInt(32)&BigInt(4294967295));return b[E++]=H,H=H>>8,b[E++]=H,H=H>>8,b[E++]=H,H=H>>8,b[E++]=H,E}function Y(b,g,E,R,O){yt(g,R,O,b,E,7);let U=Number(g&BigInt(4294967295));b[E+7]=U,U=U>>8,b[E+6]=U,U=U>>8,b[E+5]=U,U=U>>8,b[E+4]=U;let H=Number(g>>BigInt(32)&BigInt(4294967295));return b[E+3]=H,H=H>>8,b[E+2]=H,H=H>>8,b[E+1]=H,H=H>>8,b[E]=H,E+8}c.prototype.writeBigUInt64LE=Kt(function(g,E=0){return k(this,g,E,BigInt(0),BigInt("0xffffffffffffffff"))}),c.prototype.writeBigUInt64BE=Kt(function(g,E=0){return Y(this,g,E,BigInt(0),BigInt("0xffffffffffffffff"))}),c.prototype.writeIntLE=function(g,E,R,O){if(g=+g,E=E>>>0,!O){const ot=Math.pow(2,8*R-1);tt(this,g,E,R,ot-1,-ot)}let U=0,H=1,De=0;for(this[E]=g&255;++U<R&&(H*=256);)g<0&&De===0&&this[E+U-1]!==0&&(De=1),this[E+U]=(g/H>>0)-De&255;return E+R},c.prototype.writeIntBE=function(g,E,R,O){if(g=+g,E=E>>>0,!O){const ot=Math.pow(2,8*R-1);tt(this,g,E,R,ot-1,-ot)}let U=R-1,H=1,De=0;for(this[E+U]=g&255;--U>=0&&(H*=256);)g<0&&De===0&&this[E+U+1]!==0&&(De=1),this[E+U]=(g/H>>0)-De&255;return E+R},c.prototype.writeInt8=function(g,E,R){return g=+g,E=E>>>0,R||tt(this,g,E,1,127,-128),g<0&&(g=255+g+1),this[E]=g&255,E+1},c.prototype.writeInt16LE=function(g,E,R){return g=+g,E=E>>>0,R||tt(this,g,E,2,32767,-32768),this[E]=g&255,this[E+1]=g>>>8,E+2},c.prototype.writeInt16BE=function(g,E,R){return g=+g,E=E>>>0,R||tt(this,g,E,2,32767,-32768),this[E]=g>>>8,this[E+1]=g&255,E+2},c.prototype.writeInt32LE=function(g,E,R){return g=+g,E=E>>>0,R||tt(this,g,E,4,2147483647,-2147483648),this[E]=g&255,this[E+1]=g>>>8,this[E+2]=g>>>16,this[E+3]=g>>>24,E+4},c.prototype.writeInt32BE=function(g,E,R){return g=+g,E=E>>>0,R||tt(this,g,E,4,2147483647,-2147483648),g<0&&(g=4294967295+g+1),this[E]=g>>>24,this[E+1]=g>>>16,this[E+2]=g>>>8,this[E+3]=g&255,E+4},c.prototype.writeBigInt64LE=Kt(function(g,E=0){return k(this,g,E,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),c.prototype.writeBigInt64BE=Kt(function(g,E=0){return Y(this,g,E,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function X(b,g,E,R,O,U){if(E+R>b.length)throw new RangeError("Index out of range");if(E<0)throw new RangeError("Index out of range")}function de(b,g,E,R,O){return g=+g,E=E>>>0,O||X(b,g,E,4),t.write(b,g,E,R,23,4),E+4}c.prototype.writeFloatLE=function(g,E,R){return de(this,g,E,!0,R)},c.prototype.writeFloatBE=function(g,E,R){return de(this,g,E,!1,R)};function Me(b,g,E,R,O){return g=+g,E=E>>>0,O||X(b,g,E,8),t.write(b,g,E,R,52,8),E+8}c.prototype.writeDoubleLE=function(g,E,R){return Me(this,g,E,!0,R)},c.prototype.writeDoubleBE=function(g,E,R){return Me(this,g,E,!1,R)},c.prototype.copy=function(g,E,R,O){if(!c.isBuffer(g))throw new TypeError("argument should be a Buffer");if(R||(R=0),!O&&O!==0&&(O=this.length),E>=g.length&&(E=g.length),E||(E=0),O>0&&O<R&&(O=R),O===R||g.length===0||this.length===0)return 0;if(E<0)throw new RangeError("targetStart out of bounds");if(R<0||R>=this.length)throw new RangeError("Index out of range");if(O<0)throw new RangeError("sourceEnd out of bounds");O>this.length&&(O=this.length),g.length-E<O-R&&(O=g.length-E+R);const U=O-R;return this===g&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(E,R,O):Uint8Array.prototype.set.call(g,this.subarray(R,O),E),U},c.prototype.fill=function(g,E,R,O){if(typeof g=="string"){if(typeof E=="string"?(O=E,E=0,R=this.length):typeof R=="string"&&(O=R,R=this.length),O!==void 0&&typeof O!="string")throw new TypeError("encoding must be a string");if(typeof O=="string"&&!c.isEncoding(O))throw new TypeError("Unknown encoding: "+O);if(g.length===1){const H=g.charCodeAt(0);(O==="utf8"&&H<128||O==="latin1")&&(g=H)}}else typeof g=="number"?g=g&255:typeof g=="boolean"&&(g=Number(g));if(E<0||this.length<E||this.length<R)throw new RangeError("Out of range index");if(R<=E)return this;E=E>>>0,R=R===void 0?this.length:R>>>0,g||(g=0);let U;if(typeof g=="number")for(U=E;U<R;++U)this[U]=g;else{const H=c.isBuffer(g)?g:c.from(g,O),De=H.length;if(De===0)throw new TypeError('The value "'+g+'" is invalid for argument "value"');for(U=0;U<R-E;++U)this[U+E]=H[U%De]}return this};const _e={};function xe(b,g,E){_e[b]=class extends E{constructor(){super(),Object.defineProperty(this,"message",{value:g.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${b}]`,this.stack,delete this.name}get code(){return b}set code(O){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:O,writable:!0})}toString(){return`${this.name} [${b}]: ${this.message}`}}}xe("ERR_BUFFER_OUT_OF_BOUNDS",function(b){return b?`${b} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),xe("ERR_INVALID_ARG_TYPE",function(b,g){return`The "${b}" argument must be of type number. Received type ${typeof g}`},TypeError),xe("ERR_OUT_OF_RANGE",function(b,g,E){let R=`The value of "${b}" is out of range.`,O=E;return Number.isInteger(E)&&Math.abs(E)>2**32?O=Fe(String(E)):typeof E=="bigint"&&(O=String(E),(E>BigInt(2)**BigInt(32)||E<-(BigInt(2)**BigInt(32)))&&(O=Fe(O)),O+="n"),R+=` It must be ${g}. Received ${O}`,R},RangeError);function Fe(b){let g="",E=b.length;const R=b[0]==="-"?1:0;for(;E>=R+4;E-=3)g=`_${b.slice(E-3,E)}${g}`;return`${b.slice(0,E)}${g}`}function We(b,g,E){Dt(g,"offset"),(b[g]===void 0||b[g+E]===void 0)&&Et(g,b.length-(E+1))}function yt(b,g,E,R,O,U){if(b>E||b<g){const H=typeof g=="bigint"?"n":"";let De;throw g===0||g===BigInt(0)?De=`>= 0${H} and < 2${H} ** ${(U+1)*8}${H}`:De=`>= -(2${H} ** ${(U+1)*8-1}${H}) and < 2 ** ${(U+1)*8-1}${H}`,new _e.ERR_OUT_OF_RANGE("value",De,b)}We(R,O,U)}function Dt(b,g){if(typeof b!="number")throw new _e.ERR_INVALID_ARG_TYPE(g,"number",b)}function Et(b,g,E){throw Math.floor(b)!==b?(Dt(b,E),new _e.ERR_OUT_OF_RANGE("offset","an integer",b)):g<0?new _e.ERR_BUFFER_OUT_OF_BOUNDS:new _e.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${g}`,b)}const zt=/[^+/0-9A-Za-z-_]/g;function vi(b){if(b=b.split("=")[0],b=b.trim().replace(zt,""),b.length<2)return"";for(;b.length%4!==0;)b=b+"=";return b}function Wt(b,g){g=g||1/0;let E;const R=b.length;let O=null;const U=[];for(let H=0;H<R;++H){if(E=b.charCodeAt(H),E>55295&&E<57344){if(!O){if(E>56319){(g-=3)>-1&&U.push(239,191,189);continue}else if(H+1===R){(g-=3)>-1&&U.push(239,191,189);continue}O=E;continue}if(E<56320){(g-=3)>-1&&U.push(239,191,189),O=E;continue}E=(O-55296<<10|E-56320)+65536}else O&&(g-=3)>-1&&U.push(239,191,189);if(O=null,E<128){if((g-=1)<0)break;U.push(E)}else if(E<2048){if((g-=2)<0)break;U.push(E>>6|192,E&63|128)}else if(E<65536){if((g-=3)<0)break;U.push(E>>12|224,E>>6&63|128,E&63|128)}else if(E<1114112){if((g-=4)<0)break;U.push(E>>18|240,E>>12&63|128,E>>6&63|128,E&63|128)}else throw new Error("Invalid code point")}return U}function hr(b){const g=[];for(let E=0;E<b.length;++E)g.push(b.charCodeAt(E)&255);return g}function K(b,g){let E,R,O;const U=[];for(let H=0;H<b.length&&!((g-=2)<0);++H)E=b.charCodeAt(H),R=E>>8,O=E%256,U.push(O),U.push(R);return U}function Yn(b){return e.toByteArray(vi(b))}function It(b,g,E,R){let O;for(O=0;O<R&&!(O+E>=g.length||O>=b.length);++O)g[O+E]=b[O];return O}function Bt(b,g){return b instanceof g||b!=null&&b.constructor!=null&&b.constructor.name!=null&&b.constructor.name===g.name}function Mi(b){return b!==b}const Co=function(){const b="0123456789abcdef",g=new Array(256);for(let E=0;E<16;++E){const R=E*16;for(let O=0;O<16;++O)g[R+O]=b[E]+b[O]}return g}();function Kt(b){return typeof BigInt>"u"?So:b}function So(){throw new Error("BigInt not supported")}})(eo);class Ye{static getGlobalVariable(){return typeof window<"u"?window:typeof globalThis<"u"?globalThis:global}static load(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: require("${e}").`);return""}static pathNormalize(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: path.normalize("${e}").`);return""}static pathExtname(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: path.extname("${e}").`);return""}static pathResolve(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: path.resolve("${e}").`);return""}static fileExist(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: fs.existsSync("${e}").`);return!1}static dotenv(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: dotenv.config({ path: "${e}" }).`)}static getEnvVariable(e){}static readFileSync(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: fs.readFileSync("${e}").`);return null}static appendFileSync(e,t){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: fs.appendFileSync("${e}").`)}static writeFile(e,t){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: fs.writeFile("${e}").`);return Promise.reject(null)}static highlightSql(e){return e}static logInfo(e,t){console.info(e+" ",t)}static logError(e,t){console.error(e+" ",t)}static logWarn(e,t){console.warn(e+" ",t)}static log(e){console.log(e)}static warn(e){return e}}Ye.type="browser";typeof window<"u"&&(window.Buffer=eo.Buffer);typeof globalThis<"u"&&(globalThis.Buffer=eo.Buffer);typeof global<"u"&&typeof require<"u"&&(global.Buffer=require("buffer/").Buffer);class fp{async all(){throw new Error("Cannot read connection options in a browser context.")}async get(){throw new Error("Cannot read connection options in a browser context.")}async has(){throw new Error("Cannot read connection options in a browser context.")}}class Ce{static isObject(e){return e!==null&&typeof e=="object"}static isObjectWithName(e){return e!==null&&typeof e=="object"&&e.name!==void 0}static assign(e,...t){for(const n of t)for(const i of Object.getOwnPropertyNames(n))e[i]=n[i]}static mixedListToArray(e){return e!==null&&typeof e=="object"?Object.keys(e).map(t=>e[t]):e}}class _ extends Error{get name(){return this.constructor.name}constructor(e){super(e),Object.setPrototypeOf?Object.setPrototypeOf(this,new.target.prototype):this.__proto__=new.target.prototype}}class xC extends _{constructor(e){super(`Cannot create a new connection named "${e}", because connection with such name already exist and it now has an active connection session.`)}}class Ea extends _{constructor(e){super(`Internal error. Subject ${e.metadata.targetName} must have an identifier to perform operation.`)}}class _C extends _{constructor(e){super(`Cannot create a "${e}" connection because connection to the database already established.`)}}class xr extends _{constructor(){super("Locking not supported on given driver.")}}class vC extends _{constructor(e,t){super();const n=e.primaryColumns.reduce((i,r,a)=>(r.setEntityValue(i,a+1),i),{});this.message=`Cannot use given entity id "${t}" because "${e.targetName}" contains multiple primary columns, you must provide object in following form: ${JSON.stringify(n)} as an id.`}}class MC extends _{constructor(e){super(`Cannot ${e}, given value must be instance of entity class, instead object literal is given. Or you must specify an entity target to method call.`)}}class fu extends _{constructor(){super('Cannot perform update query because update values are not defined. Call "qb.set(...)" method to specify updated values.')}}class PC extends _{constructor(e){super(`Tree repositories are not supported in ${e.options.type} driver.`)}}class pp extends _{constructor(e){super(`Custom repository ${typeof e=="function"?e.name:e.constructor.name} was not found. Did you forgot to put @EntityRepository decorator on it?`)}}class Sn extends _{constructor(){super("Transaction is not started yet, start transaction before committing or rolling it back.")}}class OC extends _{constructor(){super("Transaction already started for the given connection, commit current transaction before starting a new one.")}}class ${static isMssqlParameter(e){return this.check(e,"MssqlParameter")}static isEntityMetadata(e){return this.check(e,"EntityMetadata")}static isColumnMetadata(e){return this.check(e,"ColumnMetadata")}static isSelectQueryBuilder(e){return this.check(e,"SelectQueryBuilder")}static isInsertQueryBuilder(e){return this.check(e,"InsertQueryBuilder")}static isDeleteQueryBuilder(e){return this.check(e,"DeleteQueryBuilder")}static isUpdateQueryBuilder(e){return this.check(e,"UpdateQueryBuilder")}static isSoftDeleteQueryBuilder(e){return this.check(e,"SoftDeleteQueryBuilder")}static isRelationQueryBuilder(e){return this.check(e,"RelationQueryBuilder")}static isBrackets(e){return this.check(e,"Brackets")||this.check(e,"NotBrackets")}static isNotBrackets(e){return this.check(e,"NotBrackets")}static isSubject(e){return this.check(e,"Subject")}static isRdbmsSchemaBuilder(e){return this.check(e,"RdbmsSchemaBuilder")}static isMongoEntityManager(e){return this.check(e,"MongoEntityManager")}static isSqljsEntityManager(e){return this.check(e,"SqljsEntityManager")}static isEntitySchema(e){return this.check(e,"EntitySchema")}static isBaseEntityConstructor(e){return typeof e=="function"&&typeof e.hasId=="function"&&typeof e.save=="function"&&typeof e.useDataSource=="function"}static isFindOperator(e){return this.check(e,"FindOperator")||this.check(e,"EqualOperator")}static isEqualOperator(e){return this.check(e,"EqualOperator")}static isQuery(e){return this.check(e,"Query")}static isTable(e){return this.check(e,"Table")}static isTableCheck(e){return this.check(e,"TableCheck")}static isTableColumn(e){return this.check(e,"TableColumn")}static isTableExclusion(e){return this.check(e,"TableExclusion")}static isTableForeignKey(e){return this.check(e,"TableForeignKey")}static isTableIndex(e){return this.check(e,"TableIndex")}static isTableUnique(e){return this.check(e,"TableUnique")}static isView(e){return this.check(e,"View")}static isDataSource(e){return this.check(e,"DataSource")}static check(e,t){return typeof e=="object"&&e!==null&&e["@instanceof"]===Symbol.for(t)}}class pu extends _{constructor(e,t){super(),this.entityClass=e,this.criteria=t,this.message=`Could not find any entity of type "${this.stringifyTarget(e)}" matching: ${this.stringifyCriteria(t)}`}stringifyTarget(e){return $.isEntitySchema(e)?e.options.name:typeof e=="function"||Ce.isObject(e)&&"name"in e?e.name:e}stringifyCriteria(e){try{return JSON.stringify(e,null,4)}catch{}return""+e}}class DC extends _{constructor(e){super(),this.message=`No metadata for "${this.stringifyTarget(e)}" was found.`}stringifyTarget(e){return $.isEntitySchema(e)?e.options.name:typeof e=="function"||Ce.isObject(e)&&"name"in e?e.name:e}}class IC extends _{constructor(e,t){super(`Cannot ${e}, given value must be an entity, instead "${t}" is given.`)}}class Xd extends _{constructor(e,t,n){super(`The optimistic lock on entity ${e} failed, version ${t} was expected, but is actually ${n}.`)}}class mp extends _{constructor(){super("Your database does not support LIMIT on UPDATE statements.")}}class $C extends _{constructor(e){super(`Custom entity repository ${typeof e=="function"?e.name:e.constructor.name}  cannot inherit Repository class without entity being set in the @EntityRepository decorator.`)}}class yp extends _{constructor(){super("Database connection provided by a query runner was already released, cannot continue to use its querying methods anymore.")}}class Zd extends _{constructor(e){super(`Cannot attach entity "${e}" to its parent. Please make sure parent is saved in the database before saving children nodes.`)}}class Vc extends _{constructor(e){super(`Custom repository ${typeof e=="function"?e.name:e.constructor.name} does not have managed entity. Did you forget to specify entity for it @EntityRepository(MyEntity)? `)}}class LC extends _{constructor(e){super(`Entity "${e.name}" does not have delete date columns.`)}}class qC extends _{constructor(e){super(`Circular relations detected: ${e}. To resolve this issue you need to set nullable: true somewhere in this dependency structure.`)}}class no extends _{constructor(){super("OUTPUT or RETURNING clause only supported by PostgreSQL, MariaDB, Microsoft SqlServer or Google Spanner.")}}class BC extends _{constructor(e){super(`Entity "${e.name}" does not have a primary column. Primary column is required to have in all your entities. Use @PrimaryColumn decorator to add a primary column to your entity.`)}}class Bn extends _{constructor(e,t){super(e),Object.setPrototypeOf(this,Bn.prototype),this.message=`Property "${e}" was not found in "${t.targetName}". Make sure your query is correct.`}}class FC extends _{constructor(e,t=[]){super(`Wrong driver: "${e}" given. Supported drivers are: ${t.map(n=>`"${n}"`).join(", ")}.`)}}class Fr extends _{constructor(e,t){super(`${e} package has not been found installed. Please run "npm install ${t}".`)}}class UC extends _{constructor(e){super(`Connection "${e}" was not found.`)}}class kC extends _{constructor(e){super(`Entity ${e} does not have version or update date columns.`)}}class jC extends _{constructor(){super('Cannot perform insert query because values are not defined. Call "qb.values(...)" method to specify inserted values.')}}class os extends _{constructor(){super("The optimistic lock can be used only with getOne() method.")}}class VC extends _{constructor(e){super(`Driver option (${e}) is not set. Please set it to perform connection to the database.`)}}class QC extends _{constructor(e){super(),e.length===1?this.message=`Relation "${e[0]}" was not found; please check if it is correct and really exists in your entity.`:this.message=`Relations ${e.map(t=>`"${t}"`).join(", ")} were not found; please check if relations are correct and they exist in your entities.`}}class WC extends _{constructor(){super("An open transaction is required for pessimistic lock.")}}class HC extends _{constructor(e,t,n){super();const i=typeof t=="string"?t:t.name;this.message=`Data type "${i}" in "${e.entityMetadata.targetName}.${e.propertyName}" is not supported by "${n}" database.`}}class YC extends _{constructor(e){super(`Array initializations are not allowed in entity relations. Please remove array initialization (= []) from "${e.entityMetadata.targetName}#${e.propertyPath}". This is ORM requirement to make relations to work properly. Refer docs for more information.`)}}class Un extends _{constructor(e,t,n){if(super(n.toString().replace(/^error: /,"").replace(/^Error: /,"").replace(/^Request/,"")),this.query=e,this.parameters=t,this.driverError=n,n){const{name:i,...r}=n;Ce.assign(this,{...r})}}}class GC extends _{constructor(){super("Entity manager is not using single database connection and cannot be released. Only entity managers created by connection#createEntityManagerWithSingleDatabaseConnection methods have a single database connection and they should be released.")}}class zC extends _{constructor(e){super(`Removed entity "${e.metadata.name}" is also scheduled for update operation. Make sure you are not updating and removing same object (note that update or remove may be executed by cascade operations).`)}}class Vt extends _{constructor(){super("Query runner already released. Cannot run queries anymore.")}}class KC extends _{constructor(){super("RDBMS does not support OFFSET without LIMIT in SELECT statements. You must use limit in conjunction with offset function (or take in conjunction with skip function if you are using pagination).")}}class cs extends _{constructor(e){super(`Cannot execute operation on "${e}" connection because connection is not yet established.`)}}class JC extends _{constructor(e){super(`Option "${e}" is not set in your connection options, please define "${e}" option in your connection options or ormconfig.json`)}}class XC extends _{constructor(e){const t=e.map(n=>`"${n.name}"`);super(`Migrations ${t.join(", ")} override the transaction mode, but the global transaction mode is "all"`)}}class ef{constructor(e){Ce.assign(this,e||{})}get target(){return this.metadata.target}get hasMetadata(){return!!this._metadata}set metadata(e){this._metadata=e}get metadata(){if(!this._metadata)throw new _(`Cannot get entity metadata for the given alias "${this.name}"`);return this._metadata}}class Zn{static isAliasProperty(e){if(typeof e!="string"||e.indexOf(".")===-1)return!1;const[t,n]=e.split(".");return!(!t||!n||e.indexOf("(")!==-1||e.indexOf(")")!==-1)}}var gp={exports:{}},mu={exports:{}};typeof Object.create=="function"?mu.exports=function(e,t){t&&(e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}))}:mu.exports=function(e,t){if(t){e.super_=t;var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e}};var cr=mu.exports,yu={exports:{}};/*! safe-buffer. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */(function(s,e){var t=eo,n=t.Buffer;function i(a,c){for(var l in a)c[l]=a[l]}n.from&&n.alloc&&n.allocUnsafe&&n.allocUnsafeSlow?s.exports=t:(i(t,e),e.Buffer=r);function r(a,c,l){return n(a,c,l)}r.prototype=Object.create(n.prototype),i(n,r),r.from=function(a,c,l){if(typeof a=="number")throw new TypeError("Argument must not be a number");return n(a,c,l)},r.alloc=function(a,c,l){if(typeof a!="number")throw new TypeError("Argument must be a number");var h=n(a);return c!==void 0?typeof l=="string"?h.fill(c,l):h.fill(c):h.fill(0),h},r.allocUnsafe=function(a){if(typeof a!="number")throw new TypeError("Argument must be a number");return n(a)},r.allocUnsafeSlow=function(a){if(typeof a!="number")throw new TypeError("Argument must be a number");return t.SlowBuffer(a)}})(yu,yu.exports);var Hi=yu.exports,ZC={}.toString,eS=Array.isArray||function(s){return ZC.call(s)=="[object Array]"},Ep=Function.prototype.toString,Pr=typeof Reflect=="object"&&Reflect!==null&&Reflect.apply,gu,va;if(typeof Pr=="function"&&typeof Object.defineProperty=="function")try{gu=Object.defineProperty({},"length",{get:function(){throw va}}),va={},Pr(function(){throw 42},null,gu)}catch(s){s!==va&&(Pr=null)}else Pr=null;var tS=/^\s*class\b/,Eu=function(e){try{var t=Ep.call(e);return tS.test(t)}catch{return!1}},Qc=function(e){try{return Eu(e)?!1:(Ep.call(e),!0)}catch{return!1}},Ma=Object.prototype.toString,nS="[object Object]",iS="[object Function]",rS="[object GeneratorFunction]",sS="[object HTMLAllCollection]",aS="[object HTML document.all class]",oS="[object HTMLCollection]",cS=typeof Symbol=="function"&&!!Symbol.toStringTag,uS=!(0 in[,]),Tu=function(){return!1};if(typeof document=="object"){var lS=document.all;Ma.call(lS)===Ma.call(document.all)&&(Tu=function(e){if((uS||!e)&&(typeof e>"u"||typeof e=="object"))try{var t=Ma.call(e);return(t===sS||t===aS||t===oS||t===nS)&&e("")==null}catch{}return!1})}var hS=Pr?function(e){if(Tu(e))return!0;if(!e||typeof e!="function"&&typeof e!="object")return!1;try{Pr(e,null,gu)}catch(t){if(t!==va)return!1}return!Eu(e)&&Qc(e)}:function(e){if(Tu(e))return!0;if(!e||typeof e!="function"&&typeof e!="object")return!1;if(cS)return Qc(e);if(Eu(e))return!1;var t=Ma.call(e);return t!==iS&&t!==rS&&!/^\[object HTML/.test(t)?!1:Qc(e)},dS=hS,fS=Object.prototype.toString,Tp=Object.prototype.hasOwnProperty,pS=function(e,t,n){for(var i=0,r=e.length;i<r;i++)Tp.call(e,i)&&(n==null?t(e[i],i,e):t.call(n,e[i],i,e))},mS=function(e,t,n){for(var i=0,r=e.length;i<r;i++)n==null?t(e.charAt(i),i,e):t.call(n,e.charAt(i),i,e)},yS=function(e,t,n){for(var i in e)Tp.call(e,i)&&(n==null?t(e[i],i,e):t.call(n,e[i],i,e))};function gS(s){return fS.call(s)==="[object Array]"}var ES=function(e,t,n){if(!dS(t))throw new TypeError("iterator must be a function");var i;arguments.length>=3&&(i=n),gS(e)?pS(e,t,i):typeof e=="string"?mS(e,t,i):yS(e,t,i)},TS=["Float16Array","Float32Array","Float64Array","Int8Array","Int16Array","Int32Array","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","BigInt64Array","BigUint64Array"],Wc=TS,wS=typeof globalThis>"u"?ir:globalThis,bS=function(){for(var e=[],t=0;t<Wc.length;t++)typeof wS[Wc[t]]=="function"&&(e[e.length]=Wc[t]);return e},wp={exports:{}},tf=Iu,NS=mA,_r=Ka,nf=Ja,AS=function(e,t,n){if(!e||typeof e!="object"&&typeof e!="function")throw new _r("`obj` must be an object or a function`");if(typeof t!="string"&&typeof t!="symbol")throw new _r("`property` must be a string or a symbol`");if(arguments.length>3&&typeof arguments[3]!="boolean"&&arguments[3]!==null)throw new _r("`nonEnumerable`, if provided, must be a boolean or null");if(arguments.length>4&&typeof arguments[4]!="boolean"&&arguments[4]!==null)throw new _r("`nonWritable`, if provided, must be a boolean or null");if(arguments.length>5&&typeof arguments[5]!="boolean"&&arguments[5]!==null)throw new _r("`nonConfigurable`, if provided, must be a boolean or null");if(arguments.length>6&&typeof arguments[6]!="boolean")throw new _r("`loose`, if provided, must be a boolean");var i=arguments.length>3?arguments[3]:null,r=arguments.length>4?arguments[4]:null,a=arguments.length>5?arguments[5]:null,c=arguments.length>6?arguments[6]:!1,l=!!nf&&nf(e,t);if(tf)tf(e,t,{configurable:a===null&&l?l.configurable:!a,enumerable:i===null&&l?l.enumerable:!i,value:n,writable:r===null&&l?l.writable:!r});else if(c||!i&&!r&&!a)e[t]=n;else throw new NS("This environment does not support defining a property as non-configurable, non-writable, or non-enumerable.")},wu=Iu,bp=function(){return!!wu};bp.hasArrayLengthDefineBug=function(){if(!wu)return null;try{return wu([],"length",{value:1}).length!==1}catch{return!0}};var CS=bp,SS=yA,rf=AS,RS=CS(),sf=Ja,af=Ka,xS=SS("%Math.floor%"),_S=function(e,t){if(typeof e!="function")throw new af("`fn` is not a function");if(typeof t!="number"||t<0||t>4294967295||xS(t)!==t)throw new af("`length` must be a positive 32-bit integer");var n=arguments.length>2&&!!arguments[2],i=!0,r=!0;if("length"in e&&sf){var a=sf(e,"length");a&&!a.configurable&&(i=!1),a&&!a.writable&&(r=!1)}return(i||r||!n)&&(RS?rf(e,"length",t,!0,!0):rf(e,"length",t)),e},vS=gA(),MS=EA(),PS=TA,OS=function(){return PS(vS,MS,arguments)};(function(s){var e=_S,t=Iu,n=wA,i=OS;s.exports=function(a){var c=n(arguments),l=a.length-(arguments.length-1);return e(c,1+(l>0?l:0),!0)},t?t(s.exports,"apply",{value:i}):s.exports.apply=i})(wp);var DS=wp.exports,IS=bA(),io=function(){return IS()&&!!Symbol.toStringTag},Fa=ES,$S=bS,of=DS,ku=qr,Pa=Ja,Ta=Jf(),LS=ku("Object.prototype.toString"),Np=io(),cf=typeof globalThis>"u"?ir:globalThis,bu=$S(),ju=ku("String.prototype.slice"),qS=ku("Array.prototype.indexOf",!0)||function(e,t){for(var n=0;n<e.length;n+=1)if(e[n]===t)return n;return-1},Ua={__proto__:null};Np&&Pa&&Ta?Fa(bu,function(s){var e=new cf[s];if(Symbol.toStringTag in e&&Ta){var t=Ta(e),n=Pa(t,Symbol.toStringTag);if(!n&&t){var i=Ta(t);n=Pa(i,Symbol.toStringTag)}Ua["$"+s]=of(n.get)}}):Fa(bu,function(s){var e=new cf[s],t=e.slice||e.set;t&&(Ua["$"+s]=of(t))});var BS=function(e){var t=!1;return Fa(Ua,function(n,i){if(!t)try{"$"+n(e)===i&&(t=ju(i,1))}catch{}}),t},FS=function(e){var t=!1;return Fa(Ua,function(n,i){if(!t)try{n(e),t=ju(i,1)}catch{}}),t},Ap=function(e){if(!e||typeof e!="object")return!1;if(!Np){var t=ju(LS(e),8,-1);return qS(bu,t)>-1?t:t!=="Object"?!1:FS(e)}return Pa?BS(e):null},US=Ap,Cp=function(e){return!!US(e)},kS=Ka,jS=qr,VS=jS("TypedArray.prototype.buffer",!0),QS=Cp,WS=VS||function(e){if(!QS(e))throw new kS("Not a Typed Array");return e.buffer},In=Hi.Buffer,HS=eS,YS=WS,GS=ArrayBuffer.isView||function(e){try{return YS(e),!0}catch{return!1}},zS=typeof Uint8Array<"u",Sp=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u",KS=Sp&&(In.prototype instanceof Uint8Array||In.TYPED_ARRAY_SUPPORT),JS=function(e,t){if(In.isBuffer(e))return e.constructor&&!("isBuffer"in e)?In.from(e):e;if(typeof e=="string")return In.from(e,t);if(Sp&&GS(e)){if(e.byteLength===0)return In.alloc(0);if(KS){var n=In.from(e.buffer,e.byteOffset,e.byteLength);if(n.byteLength===e.byteLength)return n}var i=e instanceof Uint8Array?e:new Uint8Array(e.buffer,e.byteOffset,e.byteLength),r=In.from(i);if(r.length===e.byteLength)return r}if(zS&&e instanceof Uint8Array)return In.from(e);var a=HS(e);if(a)for(var c=0;c<e.length;c+=1){var l=e[c];if(typeof l!="number"||l<0||l>255||~~l!==l)throw new RangeError("Array items must be numbers in the range 0-255.")}if(a||In.isBuffer(e)&&e.constructor&&typeof e.constructor.isBuffer=="function"&&e.constructor.isBuffer(e))return In.from(e);throw new TypeError('The "data" argument must be a string, an Array, a Buffer, a Uint8Array, or a DataView.')},XS=Hi.Buffer,ZS=JS;function ro(s,e){this._block=XS.alloc(s),this._finalSize=e,this._blockSize=s,this._len=0}ro.prototype.update=function(s,e){s=ZS(s,e||"utf8");for(var t=this._block,n=this._blockSize,i=s.length,r=this._len,a=0;a<i;){for(var c=r%n,l=Math.min(i-a,n-c),h=0;h<l;h++)t[c+h]=s[a+h];r+=l,a+=l,r%n===0&&this._update(t)}return this._len+=i,this};ro.prototype.digest=function(s){var e=this._len%this._blockSize;this._block[e]=128,this._block.fill(0,e+1),e>=this._finalSize&&(this._update(this._block),this._block.fill(0));var t=this._len*8;if(t<=4294967295)this._block.writeUInt32BE(t,this._blockSize-4);else{var n=(t&4294967295)>>>0,i=(t-n)/4294967296;this._block.writeUInt32BE(i,this._blockSize-8),this._block.writeUInt32BE(n,this._blockSize-4)}this._update(this._block);var r=this._hash();return s?r.toString(s):r};ro.prototype._update=function(){throw new Error("_update must be implemented by subclass")};var Ur=ro,eR=cr,Rp=Ur,tR=Hi.Buffer,nR=[1518500249,1859775393,-1894007588,-899497514],iR=new Array(80);function Ts(){this.init(),this._w=iR,Rp.call(this,64,56)}eR(Ts,Rp);Ts.prototype.init=function(){return this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878,this._e=3285377520,this};function rR(s){return s<<5|s>>>27}function sR(s){return s<<30|s>>>2}function aR(s,e,t,n){return s===0?e&t|~e&n:s===2?e&t|e&n|t&n:e^t^n}Ts.prototype._update=function(s){for(var e=this._w,t=this._a|0,n=this._b|0,i=this._c|0,r=this._d|0,a=this._e|0,c=0;c<16;++c)e[c]=s.readInt32BE(c*4);for(;c<80;++c)e[c]=e[c-3]^e[c-8]^e[c-14]^e[c-16];for(var l=0;l<80;++l){var h=~~(l/20),f=rR(t)+aR(h,n,i,r)+a+e[l]+nR[h]|0;a=r,r=i,i=sR(n),n=t,t=f}this._a=t+this._a|0,this._b=n+this._b|0,this._c=i+this._c|0,this._d=r+this._d|0,this._e=a+this._e|0};Ts.prototype._hash=function(){var s=tR.allocUnsafe(20);return s.writeInt32BE(this._a|0,0),s.writeInt32BE(this._b|0,4),s.writeInt32BE(this._c|0,8),s.writeInt32BE(this._d|0,12),s.writeInt32BE(this._e|0,16),s};var oR=Ts,cR=cr,xp=Ur,uR=Hi.Buffer,lR=[1518500249,1859775393,-1894007588,-899497514],hR=new Array(80);function ws(){this.init(),this._w=hR,xp.call(this,64,56)}cR(ws,xp);ws.prototype.init=function(){return this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878,this._e=3285377520,this};function dR(s){return s<<1|s>>>31}function fR(s){return s<<5|s>>>27}function pR(s){return s<<30|s>>>2}function mR(s,e,t,n){return s===0?e&t|~e&n:s===2?e&t|e&n|t&n:e^t^n}ws.prototype._update=function(s){for(var e=this._w,t=this._a|0,n=this._b|0,i=this._c|0,r=this._d|0,a=this._e|0,c=0;c<16;++c)e[c]=s.readInt32BE(c*4);for(;c<80;++c)e[c]=dR(e[c-3]^e[c-8]^e[c-14]^e[c-16]);for(var l=0;l<80;++l){var h=~~(l/20),f=fR(t)+mR(h,n,i,r)+a+e[l]+lR[h]|0;a=r,r=i,i=pR(n),n=t,t=f}this._a=t+this._a|0,this._b=n+this._b|0,this._c=i+this._c|0,this._d=r+this._d|0,this._e=a+this._e|0};ws.prototype._hash=function(){var s=uR.allocUnsafe(20);return s.writeInt32BE(this._a|0,0),s.writeInt32BE(this._b|0,4),s.writeInt32BE(this._c|0,8),s.writeInt32BE(this._d|0,12),s.writeInt32BE(this._e|0,16),s};var yR=ws,gR=cr,_p=Ur,ER=Hi.Buffer,TR=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],wR=new Array(64);function bs(){this.init(),this._w=wR,_p.call(this,64,56)}gR(bs,_p);bs.prototype.init=function(){return this._a=1779033703,this._b=3144134277,this._c=1013904242,this._d=2773480762,this._e=1359893119,this._f=2600822924,this._g=528734635,this._h=1541459225,this};function bR(s,e,t){return t^s&(e^t)}function NR(s,e,t){return s&e|t&(s|e)}function AR(s){return(s>>>2|s<<30)^(s>>>13|s<<19)^(s>>>22|s<<10)}function CR(s){return(s>>>6|s<<26)^(s>>>11|s<<21)^(s>>>25|s<<7)}function SR(s){return(s>>>7|s<<25)^(s>>>18|s<<14)^s>>>3}function RR(s){return(s>>>17|s<<15)^(s>>>19|s<<13)^s>>>10}bs.prototype._update=function(s){for(var e=this._w,t=this._a|0,n=this._b|0,i=this._c|0,r=this._d|0,a=this._e|0,c=this._f|0,l=this._g|0,h=this._h|0,f=0;f<16;++f)e[f]=s.readInt32BE(f*4);for(;f<64;++f)e[f]=RR(e[f-2])+e[f-7]+SR(e[f-15])+e[f-16]|0;for(var p=0;p<64;++p){var m=h+CR(a)+bR(a,c,l)+TR[p]+e[p]|0,T=AR(t)+NR(t,n,i)|0;h=l,l=c,c=a,a=r+m|0,r=i,i=n,n=t,t=m+T|0}this._a=t+this._a|0,this._b=n+this._b|0,this._c=i+this._c|0,this._d=r+this._d|0,this._e=a+this._e|0,this._f=c+this._f|0,this._g=l+this._g|0,this._h=h+this._h|0};bs.prototype._hash=function(){var s=ER.allocUnsafe(32);return s.writeInt32BE(this._a,0),s.writeInt32BE(this._b,4),s.writeInt32BE(this._c,8),s.writeInt32BE(this._d,12),s.writeInt32BE(this._e,16),s.writeInt32BE(this._f,20),s.writeInt32BE(this._g,24),s.writeInt32BE(this._h,28),s};var vp=bs,xR=cr,_R=vp,vR=Ur,MR=Hi.Buffer,PR=new Array(64);function so(){this.init(),this._w=PR,vR.call(this,64,56)}xR(so,_R);so.prototype.init=function(){return this._a=3238371032,this._b=914150663,this._c=812702999,this._d=4144912697,this._e=4290775857,this._f=1750603025,this._g=1694076839,this._h=3204075428,this};so.prototype._hash=function(){var s=MR.allocUnsafe(28);return s.writeInt32BE(this._a,0),s.writeInt32BE(this._b,4),s.writeInt32BE(this._c,8),s.writeInt32BE(this._d,12),s.writeInt32BE(this._e,16),s.writeInt32BE(this._f,20),s.writeInt32BE(this._g,24),s};var OR=so,DR=cr,Mp=Ur,IR=Hi.Buffer,uf=[1116352408,3609767458,1899447441,602891725,3049323471,3964484399,3921009573,2173295548,961987163,4081628472,1508970993,3053834265,2453635748,2937671579,2870763221,3664609560,3624381080,2734883394,310598401,1164996542,607225278,1323610764,1426881987,3590304994,1925078388,4068182383,2162078206,991336113,2614888103,633803317,3248222580,3479774868,3835390401,2666613458,4022224774,944711139,264347078,2341262773,604807628,2007800933,770255983,1495990901,1249150122,1856431235,1555081692,3175218132,1996064986,2198950837,2554220882,3999719339,2821834349,766784016,2952996808,2566594879,3210313671,3203337956,3336571891,1034457026,3584528711,2466948901,113926993,3758326383,338241895,168717936,666307205,1188179964,773529912,1546045734,1294757372,1522805485,1396182291,2643833823,1695183700,2343527390,1986661051,1014477480,2177026350,1206759142,2456956037,344077627,2730485921,1290863460,2820302411,3158454273,3259730800,3505952657,3345764771,106217008,3516065817,3606008344,3600352804,1432725776,4094571909,1467031594,275423344,851169720,430227734,3100823752,506948616,1363258195,659060556,3750685593,883997877,3785050280,958139571,3318307427,1322822218,3812723403,1537002063,2003034995,1747873779,3602036899,1955562222,1575990012,2024104815,1125592928,2227730452,2716904306,2361852424,442776044,2428436474,593698344,2756734187,3733110249,3204031479,2999351573,3329325298,3815920427,3391569614,3928383900,3515267271,566280711,3940187606,3454069534,4118630271,4000239992,116418474,1914138554,174292421,2731055270,289380356,3203993006,460393269,320620315,685471733,587496836,852142971,1086792851,1017036298,365543100,1126000580,2618297676,1288033470,3409855158,1501505948,4234509866,1607167915,987167468,1816402316,1246189591],$R=new Array(160);function Ns(){this.init(),this._w=$R,Mp.call(this,128,112)}DR(Ns,Mp);Ns.prototype.init=function(){return this._ah=1779033703,this._bh=3144134277,this._ch=1013904242,this._dh=2773480762,this._eh=1359893119,this._fh=2600822924,this._gh=528734635,this._hh=1541459225,this._al=4089235720,this._bl=2227873595,this._cl=4271175723,this._dl=1595750129,this._el=2917565137,this._fl=725511199,this._gl=4215389547,this._hl=327033209,this};function lf(s,e,t){return t^s&(e^t)}function hf(s,e,t){return s&e|t&(s|e)}function df(s,e){return(s>>>28|e<<4)^(e>>>2|s<<30)^(e>>>7|s<<25)}function ff(s,e){return(s>>>14|e<<18)^(s>>>18|e<<14)^(e>>>9|s<<23)}function LR(s,e){return(s>>>1|e<<31)^(s>>>8|e<<24)^s>>>7}function qR(s,e){return(s>>>1|e<<31)^(s>>>8|e<<24)^(s>>>7|e<<25)}function BR(s,e){return(s>>>19|e<<13)^(e>>>29|s<<3)^s>>>6}function FR(s,e){return(s>>>19|e<<13)^(e>>>29|s<<3)^(s>>>6|e<<26)}function Ot(s,e){return s>>>0<e>>>0?1:0}Ns.prototype._update=function(s){for(var e=this._w,t=this._ah|0,n=this._bh|0,i=this._ch|0,r=this._dh|0,a=this._eh|0,c=this._fh|0,l=this._gh|0,h=this._hh|0,f=this._al|0,p=this._bl|0,m=this._cl|0,T=this._dl|0,A=this._el|0,S=this._fl|0,P=this._gl|0,F=this._hl|0,B=0;B<32;B+=2)e[B]=s.readInt32BE(B*4),e[B+1]=s.readInt32BE(B*4+4);for(;B<160;B+=2){var q=e[B-30],Z=e[B-15*2+1],re=LR(q,Z),Ee=qR(Z,q);q=e[B-2*2],Z=e[B-2*2+1];var Se=BR(q,Z),me=FR(Z,q),W=e[B-7*2],Re=e[B-7*2+1],D=e[B-16*2],se=e[B-16*2+1],V=Ee+Re|0,ne=re+W+Ot(V,Ee)|0;V=V+me|0,ne=ne+Se+Ot(V,me)|0,V=V+se|0,ne=ne+D+Ot(V,se)|0,e[B]=ne,e[B+1]=V}for(var ce=0;ce<160;ce+=2){ne=e[ce],V=e[ce+1];var ye=hf(t,n,i),oe=hf(f,p,m),Te=df(t,f),Xe=df(f,t),Ge=ff(a,A),qe=ff(A,a),tt=uf[ce],k=uf[ce+1],Y=lf(a,c,l),X=lf(A,S,P),de=F+qe|0,Me=h+Ge+Ot(de,F)|0;de=de+X|0,Me=Me+Y+Ot(de,X)|0,de=de+k|0,Me=Me+tt+Ot(de,k)|0,de=de+V|0,Me=Me+ne+Ot(de,V)|0;var _e=Xe+oe|0,xe=Te+ye+Ot(_e,Xe)|0;h=l,F=P,l=c,P=S,c=a,S=A,A=T+de|0,a=r+Me+Ot(A,T)|0,r=i,T=m,i=n,m=p,n=t,p=f,f=de+_e|0,t=Me+xe+Ot(f,de)|0}this._al=this._al+f|0,this._bl=this._bl+p|0,this._cl=this._cl+m|0,this._dl=this._dl+T|0,this._el=this._el+A|0,this._fl=this._fl+S|0,this._gl=this._gl+P|0,this._hl=this._hl+F|0,this._ah=this._ah+t+Ot(this._al,f)|0,this._bh=this._bh+n+Ot(this._bl,p)|0,this._ch=this._ch+i+Ot(this._cl,m)|0,this._dh=this._dh+r+Ot(this._dl,T)|0,this._eh=this._eh+a+Ot(this._el,A)|0,this._fh=this._fh+c+Ot(this._fl,S)|0,this._gh=this._gh+l+Ot(this._gl,P)|0,this._hh=this._hh+h+Ot(this._hl,F)|0};Ns.prototype._hash=function(){var s=IR.allocUnsafe(64);function e(t,n,i){s.writeInt32BE(t,i),s.writeInt32BE(n,i+4)}return e(this._ah,this._al,0),e(this._bh,this._bl,8),e(this._ch,this._cl,16),e(this._dh,this._dl,24),e(this._eh,this._el,32),e(this._fh,this._fl,40),e(this._gh,this._gl,48),e(this._hh,this._hl,56),s};var Pp=Ns,UR=cr,kR=Pp,jR=Ur,VR=Hi.Buffer,QR=new Array(160);function ao(){this.init(),this._w=QR,jR.call(this,128,112)}UR(ao,kR);ao.prototype.init=function(){return this._ah=3418070365,this._bh=1654270250,this._ch=2438529370,this._dh=355462360,this._eh=1731405415,this._fh=2394180231,this._gh=3675008525,this._hh=1203062813,this._al=3238371032,this._bl=914150663,this._cl=812702999,this._dl=4144912697,this._el=4290775857,this._fl=1750603025,this._gl=1694076839,this._hl=3204075428,this};ao.prototype._hash=function(){var s=VR.allocUnsafe(48);function e(t,n,i){s.writeInt32BE(t,i),s.writeInt32BE(n,i+4)}return e(this._ah,this._al,0),e(this._bh,this._bl,8),e(this._ch,this._cl,16),e(this._dh,this._dl,24),e(this._eh,this._el,32),e(this._fh,this._fl,40),s};var WR=ao;(function(s){s.exports=function(t){var n=t.toLowerCase(),i=s.exports[n];if(!i)throw new Error(n+" is not supported (we accept pull requests)");return new i},s.exports.sha=oR,s.exports.sha1=yR,s.exports.sha224=OR,s.exports.sha256=vp,s.exports.sha384=WR,s.exports.sha512=Pp})(gp);var HR=gp.exports;const YR=Kf(HR);function Hc(s,e=!1){return e&&(s=" "+s),s.replace(/^([A-Z])|[\s-_](\w)/g,function(t,n,i){return i?i.toUpperCase():n.toLowerCase()})}function pf(s){return s.replace(/([A-Z])([A-Z])([a-z])/g,"$1_$2$3").replace(/([a-z0-9])([A-Z])/g,"$1_$2").toLowerCase()}function GR(s){return s.replace(/\w\S*/g,e=>e.charAt(0).toUpperCase()+e.substr(1).toLowerCase())}function Op(s,e={}){const{segmentLength:t=4,separator:n="__",termLength:i=2}=e;return s.split(n).reduce((c,l)=>{const h=l.replace(/([a-z\xE0-\xFF])([A-Z\xC0-\xDF])/g,"$1 $2").split(" "),f=h.length>1?i:t,p=h.map(m=>m.substr(0,f)).join("");return c.push(p),c},[]).join(n)}function zR(s,e={}){const t=YR("sha1");t.update(s,"utf8");const n=t.digest("hex");return e.length&&e.length>0?n.slice(0,e.length):n}class KR{static isGreaterOrEqual(e,t){if(!e)return!1;const n=mf(e),i=mf(t);for(let r=0;r<n.length&&r<i.length;r++){if(n[r]>i[r])return!0;if(n[r]<i[r])return!1}return!0}}function mf(s){return s.split(".").map(e=>parseInt(e,10))}class te{static isSQLiteFamily(e){return["sqlite","cordova","react-native","nativescript","sqljs","expo","better-sqlite3","capacitor"].includes(e.options.type)}static isMySQLFamily(e){return["mysql","mariadb"].includes(e.options.type)}static isReleaseVersionOrGreater(e,t){return KR.isGreaterOrEqual(e.version,t)}static isPostgresFamily(e){return["postgres","aurora-postgres","cockroachdb"].includes(e.options.type)}static buildDriverOptions(e,t){if(e.url){const n=this.parseConnectionUrl(e.url);t&&t.useSid&&n.database&&(n.sid=n.database);for(const i of Object.keys(n))typeof n[i]>"u"&&delete n[i];return Object.assign({},e,n)}return Object.assign({},e)}static buildMongoDBDriverOptions(e,t){if(e.url){const n=this.parseMongoDBConnectionUrl(e.url);t&&t.useSid&&n.database&&(n.sid=n.database);for(const i of Object.keys(n))typeof n[i]>"u"&&delete n[i];return Object.assign({},e,n)}return Object.assign({},e)}static buildAlias({maxAliasLength:e},t,...n){const i=t&&t.joiner?t.joiner:"_",r=n.length===1?n[0]:n.join(i);if(e&&e>0&&r.length>e){if(t&&t.shorten===!0){const a=Op(r);if(a.length<e)return a}return zR(r,{length:e})}return r}static buildColumnAlias({maxAliasLength:e},t,...n){return typeof t=="string"?(n.unshift(t),t={shorten:!1,joiner:"_"}):t=Object.assign({shorten:!1,joiner:"_"},t),this.buildAlias({maxAliasLength:e},t,...n)}static parseConnectionUrl(e){const t=e.split(":")[0],n=e.indexOf("//"),i=e.substr(n+2),r=i.indexOf("/"),a=r!==-1?i.substr(0,r):i;let c=r!==-1?i.substr(r+1):void 0;c&&c.indexOf("?")!==-1&&(c=c.substr(0,c.indexOf("?")));const l=a.lastIndexOf("@"),h=a.substr(0,l),f=a.substr(l+1);let p=h,m="";const T=h.indexOf(":");T!==-1&&(p=h.substr(0,T),m=h.substr(T+1));const[A,S]=f.split(":");return{type:t,host:A,username:decodeURIComponent(p),password:decodeURIComponent(m),port:S?parseInt(S):void 0,database:c||void 0}}static parseMongoDBConnectionUrl(e){const t=e.split(":")[0],n=e.indexOf("//"),i=e.substr(n+2),r=i.indexOf("/"),a=r!==-1?i.substr(0,r):i;let c=r!==-1?i.substr(r+1):void 0,l="",h,f,p,m;const T={};if(c&&c.indexOf("?")!==-1){l=c.substr(c.indexOf("?")+1,c.length);const re=l.split("&");let Ee,Se;re.forEach(me=>{Ee=me.split("=")[0],Se=me.split("=")[1],T[Ee]=Se}),m=T.replicaSet,c=c.substr(0,c.indexOf("?"))}const A=a.lastIndexOf("@"),S=a.substr(0,A),P=a.substr(A+1);let F=S,B="";const q=S.indexOf(":");q!==-1&&(F=S.substr(0,q),B=S.substr(q+1)),m?p=P:[h,f]=P.split(":");const Z={type:t,host:h,hostReplicaSet:p,username:decodeURIComponent(F),password:decodeURIComponent(B),port:f?parseInt(f):void 0,database:c||void 0};for(const[re,Ee]of Object.entries(T))Z[re]=Ee;return Z}}class Dp{constructor(e,t,n){this.connection=e,this.queryExpressionMap=t,this.isSelectedEvaluated=!1,this.relationEvaluated=!1,n&&Ce.assign(this,n)}get isMany(){return this.isMappingMany!==void 0?this.isMappingMany:this.relation?this.relation.isManyToMany||this.relation.isOneToMany:!1}get isSelected(){if(!this.isSelectedEvaluated){const e=()=>{for(const t of this.queryExpressionMap.selects)if(t.selection===this.alias.name||this.metadata&&this.metadata.columns.find(n=>t.selection===this.alias.name+"."+n.propertyPath))return!0;return!1};this.isSelectedCache=e(),this.isSelectedEvaluated=!0}return this.isSelectedCache}get tablePath(){return this.metadata?this.metadata.tablePath:this.entityOrProperty}get parentAlias(){if(Zn.isAliasProperty(this.entityOrProperty))return this.entityOrProperty.substr(0,this.entityOrProperty.indexOf("."))}get relationPropertyPath(){if(Zn.isAliasProperty(this.entityOrProperty))return this.entityOrProperty.substr(this.entityOrProperty.indexOf(".")+1)}get relation(){if(!this.relationEvaluated){const e=()=>{if(!Zn.isAliasProperty(this.entityOrProperty))return;const t=this.queryExpressionMap.findAliasByName(this.parentAlias);let n=t.metadata.findRelationWithPropertyPath(this.relationPropertyPath);if(n||t.metadata.parentEntityMetadata&&(n=t.metadata.parentEntityMetadata.findRelationWithPropertyPath(this.relationPropertyPath),n))return n;throw new _(`Relation with property path ${this.relationPropertyPath} in entity was not found.`)};this.relationCache=e.bind(this)(),this.relationEvaluated=!0}return this.relationCache}get metadata(){if(this.relation)return this.relation.inverseEntityMetadata;if(this.connection.hasMetadata(this.entityOrProperty))return this.connection.getMetadata(this.entityOrProperty);if(this.mapAsEntity&&this.connection.hasMetadata(this.mapAsEntity))return this.connection.getMetadata(this.mapAsEntity)}get junctionAlias(){if(!this.relation)throw new _("Cannot get junction table for join without relation.");if(typeof this.entityOrProperty!="string")throw new _("Junction property is not defined.");const e=this.entityOrProperty.substr(0,this.entityOrProperty.indexOf("."));return this.relation.isOwning?te.buildAlias(this.connection.driver,void 0,e,this.alias.name):te.buildAlias(this.connection.driver,void 0,this.alias.name,e)}get mapToPropertyParentAlias(){if(this.mapToProperty)return this.mapToProperty.split(".")[0]}get mapToPropertyPropertyName(){if(this.mapToProperty)return this.mapToProperty.split(".")[1]}}class Vu{constructor(e,t){this.queryExpressionMap=e,this.disableMixedMap=!1,Ce.assign(this,t||{})}get joinInverseSideMetadata(){return this.relation.inverseEntityMetadata}get parentAlias(){if(!Zn.isAliasProperty(this.relationName))throw new _("Given value must be a string representation of alias property");return this.relationName.substr(0,this.relationName.indexOf("."))}get relationPropertyPath(){if(!Zn.isAliasProperty(this.relationName))throw new _("Given value must be a string representation of alias property");return this.relationName.substr(this.relationName.indexOf(".")+1)}get relation(){if(!Zn.isAliasProperty(this.relationName))throw new _("Given value must be a string representation of alias property");const t=this.queryExpressionMap.findAliasByName(this.parentAlias).metadata.findRelationWithPropertyPath(this.relationPropertyPath);if(!t)throw new _(`Relation with property path ${this.relationPropertyPath} in entity was not found.`);return t}get junctionAlias(){const[e,t]=this.relationName.split(".");return e+"_"+t+"_rid"}get junctionMetadata(){return this.relation.junctionEntityMetadata}get mapToPropertyParentAlias(){return this.mapToProperty.substr(0,this.mapToProperty.indexOf("."))}get mapToPropertyPropertyPath(){return this.mapToProperty.substr(this.mapToProperty.indexOf(".")+1)}}class Qu{constructor(e,t){this.expressionMap=e,Ce.assign(this,t||{})}get joinInverseSideMetadata(){return this.relation.inverseEntityMetadata}get parentAlias(){if(!Zn.isAliasProperty(this.relationName))throw new _("Given value must be a string representation of alias property");return this.relationName.split(".")[0]}get relationProperty(){if(!Zn.isAliasProperty(this.relationName))throw new _("Given value is a string representation of alias property");return this.relationName.split(".")[1]}get junctionAlias(){const[e,t]=this.relationName.split(".");return e+"_"+t+"_rc"}get relation(){if(!Zn.isAliasProperty(this.relationName))throw new _("Given value is a string representation of alias property");const[e,t]=this.relationName.split("."),i=this.expressionMap.findAliasByName(e).metadata.findRelationWithPropertyPath(t);if(!i)throw new _(`Relation with property path ${t} in entity was not found.`);return i}get metadata(){if(!Zn.isAliasProperty(this.relationName))throw new _("Given value is a string representation of alias property");const e=this.relationName.split(".")[0];return this.expressionMap.findAliasByName(e).metadata}get mapToPropertyPropertyName(){return this.mapToProperty.split(".")[1]}}class Wu{constructor(e){var t;this.connection=e,this.relationLoadStrategy="join",this.queryEntity=!1,this.aliases=[],this.queryType="select",this.selects=[],this.maxExecutionTime=0,this.selectDistinct=!1,this.selectDistinctOn=[],this.extraReturningColumns=[],this.onConflict="",this.onIgnore=!1,this.joinAttributes=[],this.relationIdAttributes=[],this.relationCountAttributes=[],this.wheres=[],this.havings=[],this.orderBys={},this.groupBys=[],this.withDeleted=!1,this.parameters={},this.disableEscaping=!0,this.enableRelationIdValues=!1,this.extraAppendedAndWhereCondition="",this.subQuery=!1,this.aliasNamePrefixingEnabled=!0,this.options=[],this.insertColumns=[],this.whereEntities=[],this.updateEntity=!0,this.callListeners=!0,this.useTransaction=!1,this.nativeParameters={},this.locallyGenerated={},this.commonTableExpressions=[],e.options.relationLoadStrategy&&(this.relationLoadStrategy=e.options.relationLoadStrategy),this.timeTravel=((t=e.options)==null?void 0:t.timeTravelQueries)||!1}get allOrderBys(){if(!Object.keys(this.orderBys).length&&this.mainAlias.hasMetadata&&this.options.indexOf("disable-global-order")===-1){const e=this.mainAlias.metadata.orderBy||{};return Object.keys(e).reduce((t,n)=>(t[this.mainAlias.name+"."+n]=e[n],t),{})}return this.orderBys}setMainAlias(e){return this.mainAlias=e,e}createAlias(e){let t=e.name;!t&&e.tablePath&&(t=e.tablePath),!t&&typeof e.target=="function"&&(t=e.target.name),!t&&typeof e.target=="string"&&(t=e.target);const n=new ef;return n.type=e.type,t&&(n.name=t),e.metadata&&(n.metadata=e.metadata),e.target&&!n.hasMetadata&&(n.metadata=this.connection.getMetadata(e.target)),e.tablePath&&(n.tablePath=e.tablePath),e.subQuery&&(n.subQuery=e.subQuery),this.aliases.push(n),n}findAliasByName(e){const t=this.aliases.find(n=>n.name===e);if(!t)throw new _(`"${e}" alias was not found. Maybe you forgot to join it?`);return t}findColumnByAliasExpression(e){const[t,n]=e.split(".");return this.findAliasByName(t).metadata.findColumnWithPropertyName(n)}get relationMetadata(){if(!this.mainAlias)throw new _("Entity to work with is not specified!");const e=this.mainAlias.metadata.findRelationWithPropertyPath(this.relationPropertyPath);if(!e)throw new _(`Relation ${this.relationPropertyPath} was not found in entity ${this.mainAlias.name}`);return e}clone(){const e=new Wu(this.connection);return e.queryType=this.queryType,e.selects=this.selects.map(t=>t),e.maxExecutionTime=this.maxExecutionTime,e.selectDistinct=this.selectDistinct,e.selectDistinctOn=this.selectDistinctOn,this.aliases.forEach(t=>e.aliases.push(new ef(t))),e.relationLoadStrategy=this.relationLoadStrategy,e.mainAlias=this.mainAlias,e.valuesSet=this.valuesSet,e.returning=this.returning,e.onConflict=this.onConflict,e.onIgnore=this.onIgnore,e.onUpdate=this.onUpdate,e.joinAttributes=this.joinAttributes.map(t=>new Dp(this.connection,this,t)),e.relationIdAttributes=this.relationIdAttributes.map(t=>new Vu(this,t)),e.relationCountAttributes=this.relationCountAttributes.map(t=>new Qu(this,t)),e.wheres=this.wheres.map(t=>({...t})),e.havings=this.havings.map(t=>({...t})),e.orderBys=Object.assign({},this.orderBys),e.groupBys=this.groupBys.map(t=>t),e.limit=this.limit,e.offset=this.offset,e.skip=this.skip,e.take=this.take,e.useIndex=this.useIndex,e.lockMode=this.lockMode,e.onLocked=this.onLocked,e.lockVersion=this.lockVersion,e.lockTables=this.lockTables,e.withDeleted=this.withDeleted,e.parameters=Object.assign({},this.parameters),e.disableEscaping=this.disableEscaping,e.enableRelationIdValues=this.enableRelationIdValues,e.extraAppendedAndWhereCondition=this.extraAppendedAndWhereCondition,e.subQuery=this.subQuery,e.aliasNamePrefixingEnabled=this.aliasNamePrefixingEnabled,e.cache=this.cache,e.cacheId=this.cacheId,e.cacheDuration=this.cacheDuration,e.relationPropertyPath=this.relationPropertyPath,e.of=this.of,e.insertColumns=this.insertColumns,e.whereEntities=this.whereEntities,e.updateEntity=this.updateEntity,e.callListeners=this.callListeners,e.useTransaction=this.useTransaction,e.timeTravel=this.timeTravel,e.nativeParameters=Object.assign({},this.nativeParameters),e.comment=this.comment,e.commonTableExpressions=this.commonTableExpressions.map(t=>({alias:t.alias,queryBuilder:typeof t.queryBuilder=="string"?t.queryBuilder:t.queryBuilder.clone(),options:t.options})),e}}class ka{constructor(e){this["@instanceof"]=Symbol.for("Brackets"),this.whereFactory=e}}class Mt{static transformFrom(e,t){return Array.isArray(e)?e.slice().reverse().reduce((i,r)=>r.from(i),t):e.from(t)}static transformTo(e,t){return Array.isArray(e)?e.reduce((n,i)=>i.to(n),t):e.to(t)}}class As{constructor(e,t,n=!0,i=!1,r,a){this["@instanceof"]=Symbol.for("FindOperator"),this._type=e,this._value=t,this._useParameter=n,this._multipleParameters=i,this._getSql=r,this._objectLiteralParameters=a}get useParameter(){return $.isFindOperator(this._value)?this._value.useParameter:this._useParameter}get multipleParameters(){return $.isFindOperator(this._value)?this._value.multipleParameters:this._multipleParameters}get type(){return this._type}get value(){return $.isFindOperator(this._value)?this._value.value:this._value}get objectLiteralParameters(){return $.isFindOperator(this._value)?this._value.objectLiteralParameters:this._objectLiteralParameters}get child(){if($.isFindOperator(this._value))return this._value}get getSql(){return $.isFindOperator(this._value)?this._value.getSql:this._getSql}transformValue(e){this._value instanceof As?this._value.transformValue(e):this._value=Array.isArray(this._value)&&this._multipleParameters?this._value.map(t=>e&&Mt.transformTo(e,t)):Mt.transformTo(e,this._value)}}function JR(s){return new As("in",s,!0,!0)}const XR=/[.*+\-?^${}()|[\]\\]/g,ZR=s=>s.replace(XR,"\\$&");class bt{constructor(e,t){this["@instanceof"]=Symbol.for("QueryBuilder"),this.parameterIndex=0,$.isDataSource(e)?(this.connection=e,this.queryRunner=t,this.expressionMap=new Wu(this.connection)):(this.connection=e.connection,this.queryRunner=e.queryRunner,this.expressionMap=e.expressionMap.clone())}static registerQueryBuilderClass(e,t){bt.queryBuilderRegistry[e]=t}get alias(){if(!this.expressionMap.mainAlias)throw new _("Main alias is not set");return this.expressionMap.mainAlias.name}select(e,t){return this.expressionMap.queryType="select",Array.isArray(e)?this.expressionMap.selects=e.map(n=>({selection:n})):e&&(this.expressionMap.selects=[{selection:e,aliasName:t}]),$.isSelectQueryBuilder(this)?this:bt.queryBuilderRegistry.SelectQueryBuilder(this)}insert(){return this.expressionMap.queryType="insert",$.isInsertQueryBuilder(this)?this:bt.queryBuilderRegistry.InsertQueryBuilder(this)}update(e,t){const n=t||e;if(e=$.isEntitySchema(e)?e.options.name:e,typeof e=="function"||typeof e=="string"){const i=this.createFromAlias(e);this.expressionMap.setMainAlias(i)}return this.expressionMap.queryType="update",this.expressionMap.valuesSet=n,$.isUpdateQueryBuilder(this)?this:bt.queryBuilderRegistry.UpdateQueryBuilder(this)}delete(){return this.expressionMap.queryType="delete",$.isDeleteQueryBuilder(this)?this:bt.queryBuilderRegistry.DeleteQueryBuilder(this)}softDelete(){return this.expressionMap.queryType="soft-delete",$.isSoftDeleteQueryBuilder(this)?this:bt.queryBuilderRegistry.SoftDeleteQueryBuilder(this)}restore(){return this.expressionMap.queryType="restore",$.isSoftDeleteQueryBuilder(this)?this:bt.queryBuilderRegistry.SoftDeleteQueryBuilder(this)}relation(e,t){const n=arguments.length===2?e:void 0,i=arguments.length===2?t:e;if(this.expressionMap.queryType="relation",this.expressionMap.relationPropertyPath=i,n){const r=this.createFromAlias(n);this.expressionMap.setMainAlias(r)}return $.isRelationQueryBuilder(this)?this:bt.queryBuilderRegistry.RelationQueryBuilder(this)}hasRelation(e,t){const n=this.connection.getMetadata(e);return(Array.isArray(t)?t:[t]).every(r=>!!n.findRelationWithPropertyPath(r))}hasParameter(e){var t;return((t=this.parentQueryBuilder)==null?void 0:t.hasParameter(e))||e in this.expressionMap.parameters}setParameter(e,t){if(typeof t=="function")throw new _(`Function parameter isn't supported in the parameters. Please check "${e}" parameter.`);if(!e.match(/^([A-Za-z0-9_.]+)$/))throw new _("QueryBuilder parameter keys may only contain numbers, letters, underscores, or periods.");return this.parentQueryBuilder&&this.parentQueryBuilder.setParameter(e,t),this.expressionMap.parameters[e]=t,this}setParameters(e){for(const[t,n]of Object.entries(e))this.setParameter(t,n);return this}createParameter(e){let t;do t=`orm_param_${this.parameterIndex++}`;while(this.hasParameter(t));return this.setParameter(t,e),`:${t}`}setNativeParameters(e){return this.parentQueryBuilder&&this.parentQueryBuilder.setNativeParameters(e),Object.keys(e).forEach(t=>{this.expressionMap.nativeParameters[t]=e[t]}),this}getParameters(){const e=Object.assign({},this.expressionMap.parameters);if(this.expressionMap.mainAlias&&this.expressionMap.mainAlias.hasMetadata){const t=this.expressionMap.mainAlias.metadata;if(t.discriminatorColumn&&t.parentEntityMetadata){const n=t.childEntityMetadatas.filter(i=>i.discriminatorColumn).map(i=>i.discriminatorValue);n.push(t.discriminatorValue),e.discriminatorColumnValues=n}}return e}printSql(){const[e,t]=this.getQueryAndParameters();return this.connection.logger.logQuery(e,t),this}getSql(){return this.getQueryAndParameters()[0]}getQueryAndParameters(){const e=this.getQuery(),t=this.getParameters();return this.connection.driver.escapeQueryWithParameters(e,t,this.expressionMap.nativeParameters)}async execute(){const[e,t]=this.getQueryAndParameters(),n=this.obtainQueryRunner();try{return await n.query(e,t)}finally{n!==this.queryRunner&&await n.release()}}createQueryBuilder(e){return new this.constructor(this.connection,e??this.queryRunner)}clone(){return new this.constructor(this)}comment(e){return this.expressionMap.comment=e,this}disableEscaping(){return this.expressionMap.disableEscaping=!1,this}escape(e){return this.expressionMap.disableEscaping?this.connection.driver.escape(e):e}setQueryRunner(e){return this.queryRunner=e,this}callListeners(e){return this.expressionMap.callListeners=e,this}useTransaction(e){return this.expressionMap.useTransaction=e,this}addCommonTableExpression(e,t,n){return this.expressionMap.commonTableExpressions.push({queryBuilder:e,alias:t,options:n||{}}),this}getTableName(e){return e.split(".").map(t=>t===""?t:this.escape(t)).join(".")}getMainTableName(){if(!this.expressionMap.mainAlias)throw new _('Entity where values should be inserted is not specified. Call "qb.into(entity)" method to specify it.');return this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata.tablePath:this.expressionMap.mainAlias.tablePath}createFromAlias(e,t){if(this.connection.hasMetadata(e)){const n=this.connection.getMetadata(e);return this.expressionMap.createAlias({type:"from",name:t,metadata:this.connection.getMetadata(e),tablePath:n.tablePath})}else{if(typeof e=="string"){const r=e.substr(0,1)==="("&&e.substr(-1)===")";return this.expressionMap.createAlias({type:"from",name:t,tablePath:r?void 0:e,subQuery:r?e:void 0})}const n=e(this.subQuery());this.setParameters(n.getParameters());const i=n.getQuery();return this.expressionMap.createAlias({type:"from",name:t,subQuery:i})}}replacePropertyNames(e){return e}replacePropertyNamesForTheWholeQuery(e){const t={};for(const r of this.expressionMap.aliases){if(!r.hasMetadata)continue;const a=this.expressionMap.aliasNamePrefixingEnabled&&r.name?`${r.name}.`:"";t[a]||(t[a]={});for(const c of r.metadata.relations)c.joinColumns.length>0&&(t[a][c.propertyPath]=c.joinColumns[0].databaseName);for(const c of r.metadata.relations){const l=[...c.joinColumns,...c.inverseJoinColumns];for(const h of l){const f=`${c.propertyPath}.${h.referencedColumn.propertyPath}`;t[a][f]=h.databaseName}}for(const c of r.metadata.columns)t[a][c.databaseName]=c.databaseName;for(const c of r.metadata.columns)t[a][c.propertyName]=c.databaseName;for(const c of r.metadata.columns)t[a][c.propertyPath]=c.databaseName}const n=Object.keys(t),i=n.map(r=>ZR(r)).join("|");return n.length>0&&(e=e.replace(new RegExp(`([ =(]|^.{0})${i?"("+i+")":""}([^ =(),]+)(?=[ =),]|.{0}$)`,"gm"),(...r)=>{let a,c,l;if(i){if(a=r[0],c=r[1],l=r[3],t[r[2]][l])return`${c}${this.escape(r[2].substring(0,r[2].length-1))}.${this.escape(t[r[2]][l])}`}else if(a=r[0],c=r[1],l=r[2],t[""][l])return`${c}${this.escape(t[""][l])}`;return a})),e}createComment(){return this.expressionMap.comment?`/* ${this.expressionMap.comment.replace(/\*\//g,"")} */ `:""}createTimeTravelQuery(){return this.expressionMap.queryType==="select"&&this.expressionMap.timeTravel?` AS OF SYSTEM TIME ${this.expressionMap.timeTravel}`:""}createWhereExpression(){const e=[],t=this.createWhereClausesExpression(this.expressionMap.wheres);if(t.length>0&&t!=="1=1"&&e.push(this.replacePropertyNames(t)),this.expressionMap.mainAlias.hasMetadata){const i=this.expressionMap.mainAlias.metadata;if(this.expressionMap.queryType==="select"&&!this.expressionMap.withDeleted&&i.deleteDateColumn){const r=this.expressionMap.aliasNamePrefixingEnabled?this.expressionMap.mainAlias.name+"."+i.deleteDateColumn.propertyName:i.deleteDateColumn.propertyName,a=`${this.replacePropertyNames(r)} IS NULL`;e.push(a)}if(i.discriminatorColumn&&i.parentEntityMetadata){const r=this.expressionMap.aliasNamePrefixingEnabled?this.expressionMap.mainAlias.name+"."+i.discriminatorColumn.databaseName:i.discriminatorColumn.databaseName,a=`${this.replacePropertyNames(r)} IN (:...discriminatorColumnValues)`;e.push(a)}}if(this.expressionMap.extraAppendedAndWhereCondition){const i=this.replacePropertyNames(this.expressionMap.extraAppendedAndWhereCondition);e.push(i)}let n="";return n+=this.createTimeTravelQuery(),e.length?e.length===1?n+=` WHERE ${e[0]}`:n+=` WHERE ( ${e.join(" ) AND ( ")} )`:n+="",n}createReturningExpression(e){const t=this.getReturningColumns(),n=this.connection.driver;if(typeof this.expressionMap.returning!="string"&&this.expressionMap.extraReturningColumns.length>0&&n.isReturningSqlSupported(e)&&t.push(...this.expressionMap.extraReturningColumns.filter(i=>t.indexOf(i)===-1)),t.length){let i=t.map(r=>{const a=this.escape(r.databaseName);return n.options.type==="mssql"?this.expressionMap.queryType==="insert"||this.expressionMap.queryType==="update"||this.expressionMap.queryType==="soft-delete"||this.expressionMap.queryType==="restore"?"INSERTED."+a:this.escape(this.getMainTableName())+"."+a:a}).join(", ");return n.options.type==="oracle"&&(i+=" INTO "+t.map(r=>this.createParameter({type:n.columnTypeToNativeParameter(r.type),dir:n.oracle.BIND_OUT})).join(", ")),n.options.type==="mssql"&&(this.expressionMap.queryType==="insert"||this.expressionMap.queryType==="update")&&(i+=" INTO @OutputTable"),i}else if(typeof this.expressionMap.returning=="string")return this.expressionMap.returning;return""}getReturningColumns(){const e=[];return Array.isArray(this.expressionMap.returning)&&this.expressionMap.returning.forEach(t=>{this.expressionMap.mainAlias.hasMetadata&&e.push(...this.expressionMap.mainAlias.metadata.findColumnsWithPropertyPath(t))}),e}createWhereClausesExpression(e){return e.map((t,n)=>{const i=this.createWhereConditionExpression(t.condition);switch(t.type){case"and":return(n>0?"AND ":"")+`${this.connection.options.isolateWhereStatements?"(":""}${i}${this.connection.options.isolateWhereStatements?")":""}`;case"or":return(n>0?"OR ":"")+`${this.connection.options.isolateWhereStatements?"(":""}${i}${this.connection.options.isolateWhereStatements?")":""}`}return i}).join(" ").trim()}createWhereConditionExpression(e,t=!1){if(typeof e=="string")return e;if(Array.isArray(e))return e.length===0?"1=1":e.length===1&&!t?this.createWhereClausesExpression(e):"("+this.createWhereClausesExpression(e)+")";const{driver:n}=this.connection;switch(e.operator){case"lessThan":return`${e.parameters[0]} < ${e.parameters[1]}`;case"lessThanOrEqual":return`${e.parameters[0]} <= ${e.parameters[1]}`;case"arrayContains":return`${e.parameters[0]} @> ${e.parameters[1]}`;case"jsonContains":return`${e.parameters[0]} ::jsonb @> ${e.parameters[1]}`;case"arrayContainedBy":return`${e.parameters[0]} <@ ${e.parameters[1]}`;case"arrayOverlap":return`${e.parameters[0]} && ${e.parameters[1]}`;case"moreThan":return`${e.parameters[0]} > ${e.parameters[1]}`;case"moreThanOrEqual":return`${e.parameters[0]} >= ${e.parameters[1]}`;case"notEqual":return`${e.parameters[0]} != ${e.parameters[1]}`;case"equal":return`${e.parameters[0]} = ${e.parameters[1]}`;case"ilike":return n.options.type==="postgres"||n.options.type==="cockroachdb"?`${e.parameters[0]} ILIKE ${e.parameters[1]}`:`UPPER(${e.parameters[0]}) LIKE UPPER(${e.parameters[1]})`;case"like":return`${e.parameters[0]} LIKE ${e.parameters[1]}`;case"between":return`${e.parameters[0]} BETWEEN ${e.parameters[1]} AND ${e.parameters[2]}`;case"in":return e.parameters.length<=1?"0=1":`${e.parameters[0]} IN (${e.parameters.slice(1).join(", ")})`;case"any":return n.options.type==="cockroachdb"?`${e.parameters[0]}::STRING = ANY(${e.parameters[1]}::STRING[])`:`${e.parameters[0]} = ANY(${e.parameters[1]})`;case"isNull":return`${e.parameters[0]} IS NULL`;case"not":return`NOT(${this.createWhereConditionExpression(e.condition)})`;case"brackets":return`${this.createWhereConditionExpression(e.condition,!0)}`;case"and":return"("+e.parameters.join(" AND ")+")";case"or":return"("+e.parameters.join(" OR ")+")"}throw new TypeError(`Unsupported FindOperator ${As.constructor.name}`)}createCteExpression(){if(!this.hasCommonTableExpressions())return"";const e=this.connection.driver.cteCapabilities.requiresRecursiveHint;return"WITH "+this.expressionMap.commonTableExpressions.map(n=>{let i=typeof n.queryBuilder=="string"?n.queryBuilder:"";if(typeof n.queryBuilder!="string"){if(n.queryBuilder.hasCommonTableExpressions())throw new _(`Nested CTEs aren't supported (CTE: ${n.alias})`);if(i=n.queryBuilder.getQuery(),!this.connection.driver.cteCapabilities.writable&&!$.isSelectQueryBuilder(n.queryBuilder))throw new _(`Only select queries are supported in CTEs in ${this.connection.options.type} (CTE: ${n.alias})`);this.setParameters(n.queryBuilder.getParameters())}let r=this.escape(n.alias);if(n.options.columnNames){const l=n.options.columnNames.map(h=>this.escape(h));if($.isSelectQueryBuilder(n.queryBuilder)&&n.queryBuilder.expressionMap.selects.length&&n.options.columnNames.length!==n.queryBuilder.expressionMap.selects.length)throw new _(`cte.options.columnNames length (${n.options.columnNames.length}) doesn't match subquery select list length ${n.queryBuilder.expressionMap.selects.length} (CTE: ${n.alias})`);r+=`(${l.join(", ")})`}const a=n.options.recursive&&e?"RECURSIVE":"";let c="";return this.connection.driver.cteCapabilities.materializedHint&&n.options.materialized!==void 0&&(c=n.options.materialized?"MATERIALIZED":"NOT MATERIALIZED"),[a,r,"AS",c,`(${i})`].filter(Boolean).join(" ")}).join(", ")+" "}getWhereInIdsCondition(e){const t=this.expressionMap.mainAlias.metadata,n=(Array.isArray(e)?e:[e]).map(i=>t.ensureEntityIdMap(i));if(!t.hasMultiplePrimaryKeys){const i=t.primaryColumns[0];if(!i.transformer&&!i.relationMetadata&&!i.embeddedMetadata)return{[i.propertyName]:JR(n.map(r=>i.getEntityValue(r,!1)))}}return new ka(i=>{for(const r of n)i.orWhere(new ka(a=>a.where(r)))})}getExistsCondition(e){const t=e.clone().orderBy().groupBy().offset(void 0).limit(void 0).skip(void 0).take(void 0).select("1").setOption("disable-global-order");return[`EXISTS (${t.getQuery()})`,t.getParameters()]}findColumnsForPropertyPath(e){let t=this.expressionMap.mainAlias;const n=[],i=e.split(".");for(;i.length>1;){const c=i[0];if(!(t!=null&&t.hasMetadata))break;if(t.metadata.hasEmbeddedWithPropertyPath(c)){i.unshift(`${i.shift()}.${i.shift()}`);continue}if(t.metadata.hasRelationWithPropertyPath(c)){const l=this.expressionMap.joinAttributes.find(h=>h.relationPropertyPath===c);if(!(l!=null&&l.alias)){const h=n.length>0?`${n.join(".")}.${c}`:c;throw new Error(`Cannot find alias for relation at ${h}`)}t=l.alias,n.push(...c.split(".")),i.shift();continue}break}if(!t)throw new Error(`Cannot find alias for property ${e}`);const r=i.join("."),a=t.metadata.findColumnsWithPropertyPath(r);if(!a.length)throw new Bn(e,t.metadata);return[t,n,a]}createPropertyPath(e,t,n=""){const i=[];for(const r of Object.keys(t)){const a=n?`${n}.${r}`:r;if(t[r]===null||typeof t[r]!="object"||$.isFindOperator(t[r])){i.push(a);continue}if(e.hasEmbeddedWithPropertyPath(a)){const c=this.createPropertyPath(e,t[r],a);i.push(...c);continue}if(e.hasRelationWithPropertyPath(a)){const c=e.findRelationWithPropertyPath(a);if(c.relationType==="one-to-one"||c.relationType==="many-to-one"){const p=c.joinColumns.map(T=>T.referencedColumn).filter(T=>!!T);if(p.length>0&&p.every(T=>T.getEntityValue(t[r],!1))){i.push(a);continue}}if(c.relationType==="one-to-many"||c.relationType==="many-to-many")throw new Error(`Cannot query across ${c.relationType} for property ${a}`);const l=c.inverseEntityMetadata.primaryColumns;if(l.length>0&&l.every(p=>p.getEntityValue(t[r],!1))){const p=l.map(m=>`${a}.${m.propertyPath}`);i.push(...p);continue}const f=this.createPropertyPath(c.inverseEntityMetadata,t[r]).map(p=>`${a}.${p}`);i.push(...f);continue}i.push(a)}return i}*getPredicates(e){if(this.expressionMap.mainAlias.hasMetadata){const t=this.createPropertyPath(this.expressionMap.mainAlias.metadata,e);for(const n of t){const[i,r,a]=this.findColumnsForPropertyPath(n);for(const c of a){let l=e;for(const p of r){if(!l||!(p in l)){l={};break}l=l[p]}const h=this.expressionMap.aliasNamePrefixingEnabled?`${i.name}.${c.propertyPath}`:c.propertyPath,f=c.getEntityValue(l,!0);yield[h,f]}}}else for(const t of Object.keys(e)){const n=e[t];yield[this.expressionMap.aliasNamePrefixingEnabled?`${this.alias}.${t}`:t,n]}}getWherePredicateCondition(e,t){var n,i;if($.isFindOperator(t)){const r=[];if(t.useParameter)if(t.objectLiteralParameters)this.setParameters(t.objectLiteralParameters);else if(t.multipleParameters)for(const a of t.value)r.push(this.createParameter(a));else r.push(this.createParameter(t.value));if(t.type==="raw")return t.getSql?t.getSql(e):{operator:"equal",parameters:[e,t.value]};if(t.type==="not")return t.child?{operator:t.type,condition:this.getWherePredicateCondition(e,t.child)}:{operator:"notEqual",parameters:[e,...r]};if(t.type==="and"){const a=t.value;return{operator:t.type,parameters:a.map(c=>this.createWhereConditionExpression(this.getWherePredicateCondition(e,c)))}}else if(t.type==="or"){const a=t.value;return{operator:t.type,parameters:a.map(c=>this.createWhereConditionExpression(this.getWherePredicateCondition(e,c)))}}else return{operator:t.type,parameters:[e,...r]}}else if(t===null){const r=((n=this.connection.options.invalidWhereValuesBehavior)==null?void 0:n.null)||"ignore";if(r==="sql-null")return{operator:"isNull",parameters:[e]};if(r==="throw")throw new _(`Null value encountered in property '${e}' of a where condition. To match with SQL NULL, the IsNull() operator must be used. Set 'invalidWhereValuesBehavior.null' to 'ignore' or 'sql-null' in connection options to skip or handle null values.`)}else if(t===void 0&&(((i=this.connection.options.invalidWhereValuesBehavior)==null?void 0:i.undefined)||"ignore")==="throw")throw new _(`Undefined value encountered in property '${e}' of a where condition. Set 'invalidWhereValuesBehavior.undefined' to 'ignore' in connection options to skip properties with undefined values.`);return{operator:"equal",parameters:[e,this.createParameter(t)]}}getWhereCondition(e){if(typeof e=="string")return e;if($.isBrackets(e)){const i=this.createQueryBuilder();return i.parentQueryBuilder=this,i.expressionMap.mainAlias=this.expressionMap.mainAlias,i.expressionMap.aliasNamePrefixingEnabled=this.expressionMap.aliasNamePrefixingEnabled,i.expressionMap.parameters=this.expressionMap.parameters,i.expressionMap.nativeParameters=this.expressionMap.nativeParameters,i.expressionMap.wheres=[],e.whereFactory(i),{operator:$.isNotBrackets(e)?"not":"brackets",condition:i.expressionMap.wheres}}if(typeof e=="function")return e(this);const t=Array.isArray(e)?e:[e],n=[];for(const i of t){const r=[];for(const[a,c]of this.getPredicates(i))r.push({type:"and",condition:this.getWherePredicateCondition(a,c)});n.push({type:"or",condition:r})}return n.length===1?n[0].condition:n}obtainQueryRunner(){return this.queryRunner||this.connection.createQueryRunner()}hasCommonTableExpressions(){return this.expressionMap.commonTableExpressions.length>0}}bt.queryBuilderRegistry={};class e0{static from(e){const t=new this;return t.raw=e.records,t.affected=e.affected,t}}class t0 extends bt{constructor(e,t){super(e,t),this["@instanceof"]=Symbol.for("DeleteQueryBuilder"),this.expressionMap.aliasNamePrefixingEnabled=!1}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createDeleteExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){const[e,t]=this.getQueryAndParameters(),n=this.obtainQueryRunner();let i=!1;try{this.expressionMap.useTransaction===!0&&n.isTransactionActive===!1&&(await n.startTransaction(),i=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await n.broadcaster.broadcast("BeforeRemove",this.expressionMap.mainAlias.metadata);const r=await n.query(e,t,!0),a=e0.from(r);return this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await n.broadcaster.broadcast("AfterRemove",this.expressionMap.mainAlias.metadata),i&&await n.commitTransaction(),a}catch(r){if(i)try{await n.rollbackTransaction()}catch{}throw r}finally{n!==this.queryRunner&&await n.release()}}from(e,t){e=$.isEntitySchema(e)?e.options.name:e;const n=this.createFromAlias(e,t);return this.expressionMap.setMainAlias(n),this}where(e,t){this.expressionMap.wheres=[];const n=this.getWhereCondition(e);return n&&(this.expressionMap.wheres=[{type:"simple",condition:n}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("delete"))throw new no;return this.expressionMap.returning=e,this}createDeleteExpression(){const e=this.getTableName(this.getMainTableName()),t=this.createWhereExpression(),n=this.createReturningExpression("delete");return n===""?`DELETE FROM ${e}${t}`:this.connection.driver.options.type==="mssql"?`DELETE FROM ${e} OUTPUT ${n}${t}`:this.connection.driver.options.type==="spanner"?`DELETE FROM ${e}${t} THEN RETURN ${n}`:`DELETE FROM ${e}${t} RETURNING ${n}`}}const qt=[];for(let s=0;s<256;++s)qt.push((s+256).toString(16).slice(1));function n0(s,e=0){return(qt[s[e+0]]+qt[s[e+1]]+qt[s[e+2]]+qt[s[e+3]]+"-"+qt[s[e+4]]+qt[s[e+5]]+"-"+qt[s[e+6]]+qt[s[e+7]]+"-"+qt[s[e+8]]+qt[s[e+9]]+"-"+qt[s[e+10]]+qt[s[e+11]]+qt[s[e+12]]+qt[s[e+13]]+qt[s[e+14]]+qt[s[e+15]]).toLowerCase()}let Yc;const i0=new Uint8Array(16);function r0(){if(!Yc){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");Yc=crypto.getRandomValues.bind(crypto)}return Yc(i0)}const s0=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),yf={randomUUID:s0};function Ip(s,e,t){var i;if(yf.randomUUID&&!s)return yf.randomUUID();s=s||{};const n=s.random??((i=s.rng)==null?void 0:i.call(s))??r0();if(n.length<16)throw new Error("Random bytes length must be >= 16");return n[6]=n[6]&15|64,n[8]=n[8]&63|128,n0(n)}class Rn{constructor(){this.count=0,this.promises=[]}async wait(){return this.promises.length>0&&await Promise.all(this.promises),this}}class gf{constructor(){this.identifiers=[],this.generatedMaps=[]}static from(e){const t=new this;return t.raw=e.raw,t}}class Hu{constructor(e,t){this.queryRunner=e,this.expressionMap=t}async update(e,t){const n=this.expressionMap.mainAlias.metadata;await Promise.all(t.map(async(i,r)=>{if(this.queryRunner.connection.driver.isReturningSqlSupported("update")){this.queryRunner.connection.driver.options.type==="oracle"&&Array.isArray(e.raw)&&this.expressionMap.extraReturningColumns.length>0&&(e.raw=e.raw.reduce((l,h,f)=>(l[this.expressionMap.extraReturningColumns[f].databaseName]=h[0],l),{}));const a=Array.isArray(e.raw)?e.raw[r]:e.raw,c=this.queryRunner.connection.driver.createGeneratedMap(n,a);c&&(this.queryRunner.manager.merge(n.target,i,c),e.generatedMaps.push(c))}else{const a=this.expressionMap.extraReturningColumns;if(a.length>0){const c=this.expressionMap.mainAlias.metadata.getEntityIdMap(i);if(!c)throw new _("Cannot update entity because entity id is not set in the entity.");const l=await this.queryRunner.manager.createQueryBuilder().select(n.primaryColumns.map(h=>n.targetName+"."+h.propertyPath)).addSelect(a.map(h=>n.targetName+"."+h.propertyPath)).from(n.target,n.targetName).where(c).withDeleted().setOption("create-pojo").getOne();l&&(this.queryRunner.manager.merge(n.target,i,l),e.generatedMaps.push(l))}}}))}async insert(e,t){const n=this.expressionMap.mainAlias.metadata;let i=n.getInsertionReturningColumns();const r=this.queryRunner.connection.driver.isReturningSqlSupported("insert");i=i.filter(c=>c.isGenerated?r===!0:!0);const a=t.map((c,l)=>{Array.isArray(e.raw)&&this.expressionMap.extraReturningColumns.length>0&&(this.queryRunner.connection.driver.options.type==="oracle"?e.raw=e.raw.reduce((p,m,T)=>(p[this.expressionMap.extraReturningColumns[T].databaseName]=m[0],p),{}):this.queryRunner.connection.driver.options.type==="spanner"&&(e.raw=e.raw[0]));const h=Array.isArray(e.raw)?e.raw[l]:e.raw,f=this.queryRunner.connection.driver.createGeneratedMap(n,h,l,t.length)||{};return l in this.expressionMap.locallyGenerated&&this.queryRunner.manager.merge(n.target,f,this.expressionMap.locallyGenerated[l]),this.queryRunner.manager.merge(n.target,c,f),f});if(i.length>0&&!this.queryRunner.connection.driver.isReturningSqlSupported("insert")){const c=t.map(h=>{const f=n.getEntityIdMap(h);if(!f)throw new _("Cannot update entity because entity id is not set in the entity.");return f}),l=await this.queryRunner.manager.createQueryBuilder().select(n.primaryColumns.map(h=>n.targetName+"."+h.propertyPath)).addSelect(i.map(h=>n.targetName+"."+h.propertyPath)).from(n.target,n.targetName).where(c).setOption("create-pojo").getMany();t.forEach((h,f)=>{this.queryRunner.manager.merge(n.target,a[f],l[f]),this.queryRunner.manager.merge(n.target,h,l[f])})}t.forEach((c,l)=>{const h=n.getEntityIdMap(c);e.identifiers.push(h),e.generatedMaps.push(a[l])})}getUpdationReturningColumns(){return this.expressionMap.mainAlias.metadata.columns.filter(e=>e.asExpression!==void 0||e.isUpdateDate||e.isVersion)}getSoftDeletionReturningColumns(){return this.expressionMap.mainAlias.metadata.columns.filter(e=>e.asExpression!==void 0||e.isUpdateDate||e.isVersion||e.isDeleteDate)}}class a0 extends bt{constructor(){super(...arguments),this["@instanceof"]=Symbol.for("InsertQueryBuilder")}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createInsertExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){const e=this.getValueSets();if(e.length===0)return new gf;const t=this.obtainQueryRunner();let n=!1;try{if(this.expressionMap.useTransaction===!0&&t.isTransactionActive===!1&&(await t.startTransaction(),n=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata){const A=new Rn;e.forEach(S=>{t.broadcaster.broadcastBeforeInsertEvent(A,this.expressionMap.mainAlias.metadata,S)}),await A.wait()}let i=null,r=null;const a=new Hu(t,this.expressionMap),c=[];if(Array.isArray(this.expressionMap.returning)&&this.expressionMap.mainAlias.hasMetadata)for(const A of this.expressionMap.returning)c.push(...this.expressionMap.mainAlias.metadata.findColumnsWithPropertyPath(A));this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&(e.length>1&&this.connection.driver.options.type==="oracle"||(this.expressionMap.extraReturningColumns=this.expressionMap.mainAlias.metadata.getInsertionReturningColumns()),c.push(...this.expressionMap.extraReturningColumns.filter(A=>!c.includes(A)))),c.length>0&&this.connection.driver.options.type==="mssql"&&(i=this.connection.driver.buildTableVariableDeclaration("@OutputTable",c),r="SELECT * FROM @OutputTable");const[l,h]=this.getQueryAndParameters(),p=[i,l,r].filter(A=>A!=null).join(`;

`),m=await t.query(p,h,!0),T=gf.from(m);if(this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&await a.insert(T,e),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata){const A=new Rn;e.forEach(S=>{t.broadcaster.broadcastAfterInsertEvent(A,this.expressionMap.mainAlias.metadata,S)}),await A.wait()}return n&&await t.commitTransaction(),T}catch(i){if(n)try{await t.rollbackTransaction()}catch{}throw i}finally{t!==this.queryRunner&&await t.release()}}into(e,t){e=$.isEntitySchema(e)?e.options.name:e;const n=this.createFromAlias(e);return this.expressionMap.setMainAlias(n),this.expressionMap.insertColumns=t||[],this}values(e){return this.expressionMap.valuesSet=e,this}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("insert"))throw new no;return this.expressionMap.returning=e,this}updateEntity(e){return this.expressionMap.updateEntity=e,this}onConflict(e){return this.expressionMap.onConflict=e,this}orIgnore(e=!0){return this.expressionMap.onIgnore=!!e,this}orUpdate(e,t,n){const{where:i,parameters:r}=(n==null?void 0:n.overwriteCondition)??{};let a;if(i){const c=this.getWhereCondition(i);(Array.isArray(c)?c.length!==0:c)&&(a=[{type:"simple",condition:c}])}return r&&this.setParameters(r),Array.isArray(e)?(this.expressionMap.onUpdate={overwrite:e,conflict:t,skipUpdateIfNoValuesChanged:n==null?void 0:n.skipUpdateIfNoValuesChanged,indexPredicate:n==null?void 0:n.indexPredicate,upsertType:n==null?void 0:n.upsertType,overwriteCondition:a},this):(this.expressionMap.onUpdate={conflict:e==null?void 0:e.conflict_target,columns:e==null?void 0:e.columns,overwrite:e==null?void 0:e.overwrite,skipUpdateIfNoValuesChanged:n==null?void 0:n.skipUpdateIfNoValuesChanged,upsertType:n==null?void 0:n.upsertType,overwriteCondition:a},this)}createInsertExpression(){var c,l,h,f;if((this.expressionMap.onUpdate||this.expressionMap.onIgnore)&&(((c=this.expressionMap.onUpdate)==null?void 0:c.upsertType)??"merge-into")==="merge-into"&&this.connection.driver.supportedUpsertTypes.includes("merge-into"))return this.createMergeExpression();const e=this.getTableName(this.getMainTableName()),t=this.alias!==this.getMainTableName()?this.escape(this.alias):e,n=this.createValuesExpression(),i=this.connection.driver.options.type==="oracle"&&this.getValueSets().length>1?null:this.createReturningExpression("insert"),r=this.createColumnNamesExpression();let a="INSERT ";if(((l=this.expressionMap.onUpdate)==null?void 0:l.upsertType)==="primary-key"&&(a="UPSERT "),(te.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&(a+=`${this.expressionMap.onIgnore?" IGNORE ":""}`),a+=`INTO ${e}`,this.alias!==this.getMainTableName()&&te.isPostgresFamily(this.connection.driver)&&(a+=` AS "${this.alias}"`),r?a+=`(${r})`:!n&&(te.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&(a+="()"),i&&this.connection.driver.options.type==="mssql"&&(a+=` OUTPUT ${i}`),n?(this.connection.driver.options.type==="oracle"||this.connection.driver.options.type==="sap")&&this.getValueSets().length>1?a+=` ${n}`:a+=` VALUES ${n}`:te.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"?a+=" VALUES ()":a+=" DEFAULT VALUES",((h=this.expressionMap.onUpdate)==null?void 0:h.upsertType)!=="primary-key"){if(this.connection.driver.supportedUpsertTypes.includes("on-conflict-do-update")){if(this.expressionMap.onIgnore)a+=" ON CONFLICT DO NOTHING ";else if(this.expressionMap.onConflict)a+=` ON CONFLICT ${this.expressionMap.onConflict} `;else if(this.expressionMap.onUpdate){const{overwrite:p,columns:m,conflict:T,skipUpdateIfNoValuesChanged:A,indexPredicate:S}=this.expressionMap.onUpdate;let P="ON CONFLICT";if(Array.isArray(T)){if(P+=` ( ${T.map(B=>this.escape(B)).join(", ")} )`,S&&!te.isPostgresFamily(this.connection.driver))throw new _("indexPredicate option is not supported by the current database driver");S&&te.isPostgresFamily(this.connection.driver)&&(P+=` WHERE ( ${S} )`)}else T&&(P+=` ON CONSTRAINT ${this.escape(T)}`);const F=[];if(Array.isArray(p)?F.push(...p.map(B=>`${this.escape(B)} = EXCLUDED.${this.escape(B)}`)):m&&F.push(...m.map(B=>`${this.escape(B)} = :${B}`)),F.length>0&&(a+=` ${P} DO UPDATE SET `,F.push(...this.expressionMap.mainAlias.metadata.columns.filter(B=>B.isUpdateDate&&!(p!=null&&p.includes(B.databaseName))&&!(this.connection.driver.options.type==="oracle"&&this.getValueSets().length>1||te.isSQLiteFamily(this.connection.driver)||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner")).map(B=>`${this.escape(B.databaseName)} = DEFAULT`)),a+=F.join(", ")),Array.isArray(p)&&A){(f=this.expressionMap.onUpdate).overwriteCondition??(f.overwriteCondition=[]);const B=p.map(q=>({type:"or",condition:`${t}.${this.escape(q)} IS DISTINCT FROM EXCLUDED.${this.escape(q)}`}));this.expressionMap.onUpdate.overwriteCondition.push({type:"and",condition:B})}te.isPostgresFamily(this.connection.driver)&&this.expressionMap.onUpdate.overwriteCondition&&this.expressionMap.onUpdate.overwriteCondition.length>0&&(a+=` WHERE ${this.createUpsertConditionExpression()}`)}}else if(this.connection.driver.supportedUpsertTypes.includes("on-duplicate-key-update")){if(this.expressionMap.onUpdate){const{overwrite:p,columns:m}=this.expressionMap.onUpdate;Array.isArray(p)?(a+=" ON DUPLICATE KEY UPDATE ",a+=p.map(T=>`${this.escape(T)} = VALUES(${this.escape(T)})`).join(", "),a+=" "):Array.isArray(m)&&(a+=" ON DUPLICATE KEY UPDATE ",a+=m.map(T=>`${this.escape(T)} = :${T}`).join(", "),a+=" ")}}else if(this.expressionMap.onUpdate)throw new _("onUpdate is not supported by the current database driver")}return i&&(te.isPostgresFamily(this.connection.driver)||this.connection.driver.options.type==="oracle"||this.connection.driver.options.type==="cockroachdb"||te.isMySQLFamily(this.connection.driver))&&(a+=` RETURNING ${i}`),i&&this.connection.driver.options.type==="spanner"&&(a+=` THEN RETURN ${i}`),this.connection.driver.options.type==="mssql"&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.mainAlias.metadata.columns.filter(p=>this.expressionMap.insertColumns.length>0?this.expressionMap.insertColumns.indexOf(p.propertyPath)!==-1:p.isInsert).some(p=>this.isOverridingAutoIncrementBehavior(p))&&(a=`SET IDENTITY_INSERT ${e} ON; ${a}; SET IDENTITY_INSERT ${e} OFF`),a}getInsertedColumns(){return this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata.columns.filter(e=>this.expressionMap.insertColumns.length?this.expressionMap.insertColumns.indexOf(e.propertyPath)!==-1:!(!e.isInsert||e.isGenerated&&e.generationStrategy==="increment"&&this.connection.driver.options.type!=="spanner"&&this.connection.driver.options.type!=="oracle"&&!te.isSQLiteFamily(this.connection.driver)&&!te.isMySQLFamily(this.connection.driver)&&this.connection.driver.options.type!=="aurora-mysql"&&!(this.connection.driver.options.type==="mssql"&&this.isOverridingAutoIncrementBehavior(e)))):[]}createColumnNamesExpression(){const e=this.getInsertedColumns();if(e.length>0)return e.map(t=>this.escape(t.databaseName)).join(", ");if(!this.expressionMap.mainAlias.hasMetadata&&!this.expressionMap.insertColumns.length){const t=this.getValueSets();if(t.length===1)return Object.keys(t[0]).map(n=>this.escape(n)).join(", ")}return this.expressionMap.insertColumns.map(t=>this.escape(t)).join(", ")}createValuesExpression(){const e=this.getValueSets(),t=this.getInsertedColumns();if(t.length>0){let n="";return e.forEach((i,r)=>{t.forEach((a,c)=>{c===0&&(this.connection.driver.options.type==="oracle"&&e.length>1||this.connection.driver.options.type==="sap"&&e.length>1?n+=" SELECT ":n+="("),n+=this.createColumnValueExpression(e,r,a),c===t.length-1?r===e.length-1?["oracle","sap"].includes(this.connection.driver.options.type)&&e.length>1?n+=" FROM "+this.connection.driver.dummyTableName:n+=")":["oracle","sap"].includes(this.connection.driver.options.type)&&e.length>1?n+=" FROM "+this.connection.driver.dummyTableName+" UNION ALL ":n+="), ":n+=", "})}),n==="()"?"":n}else{let n="";return e.forEach((i,r)=>{Object.keys(i).forEach((c,l)=>{l===0&&(n+="(");const h=i[c];typeof h=="function"?n+=h():h===void 0?this.connection.driver.options.type==="oracle"&&e.length>1||te.isSQLiteFamily(this.connection.driver)||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"?n+="NULL":n+="DEFAULT":h===null&&this.connection.driver.options.type==="spanner"||(n+=this.createParameter(h)),l===Object.keys(i).length-1?r===e.length-1?n+=")":n+="), ":n+=", "})}),n==="()"?"":n}}getValueSets(){if(Array.isArray(this.expressionMap.valuesSet))return this.expressionMap.valuesSet;if(Ce.isObject(this.expressionMap.valuesSet))return[this.expressionMap.valuesSet];throw new jC}isOverridingAutoIncrementBehavior(e){return e.isPrimary&&e.isGenerated&&e.generationStrategy==="increment"&&this.getValueSets().some(t=>e.getEntityValue(t)!==void 0&&e.getEntityValue(t)!==null)}createMergeExpression(){var f,p,m;if(!this.connection.driver.supportedUpsertTypes.includes("merge-into"))throw new _('Upsert type "merge-into" is not supported by current database driver');if((f=this.expressionMap.onUpdate)!=null&&f.upsertType&&this.expressionMap.onUpdate.upsertType!=="merge-into")throw new _(`Upsert type "${this.expressionMap.onUpdate.upsertType}" is not supported by current database driver`);const e=this.getTableName(this.getMainTableName()),t=this.escape(this.alias),n=this.getInsertedColumns(),i=this.createColumnNamesExpression();let r=`MERGE INTO ${e} ${this.escape(this.alias)}`;const a=this.escape("mergeIntoSource"),c=this.createMergeIntoSourceExpression(a);if(r+=` ${c}`,this.expressionMap.onIgnore){const T=n.find(A=>A.isPrimary);T?r+=` ON (${t}.${this.escape(T.databaseName)} = ${a}.${this.escape(T.databaseName)})`:r+=`ON (${this.expressionMap.mainAlias.metadata.uniques.map(A=>`(${A.columns.map(S=>`${t}.${this.escape(S.databaseName)} = ${a}.${this.escape(S.databaseName)}`).join(" AND ")})`).join(" OR ")})`}else if(this.expressionMap.onUpdate){const{conflict:T,indexPredicate:A}=this.expressionMap.onUpdate;if(A)throw new _('indexPredicate option is not supported by upsert type "merge-into"');Array.isArray(T)?r+=` ON (${T.map(S=>`${t}.${this.escape(S)} = ${a}.${this.escape(S)}`).join(" AND ")})`:T?r+=` ON (${t}.${this.escape(T)} = ${a}.${this.escape(T)})`:r+=`ON (${this.expressionMap.mainAlias.metadata.uniques.map(S=>`(${S.columns.map(P=>`${t}.${this.escape(P.databaseName)} = ${a}.${this.escape(P.databaseName)}`).join(" AND ")})`).join(" OR ")})`}if(this.expressionMap.onUpdate){const{overwrite:T,columns:A,conflict:S,skipUpdateIfNoValuesChanged:P}=this.expressionMap.onUpdate;let F="";if(Array.isArray(T)&&(F+=(p=T||A)==null?void 0:p.filter(q=>!(S!=null&&S.includes(q))).map(q=>`${t}.${this.escape(q)} = ${a}.${this.escape(q)}`).join(", ")),Array.isArray(T)&&P){(m=this.expressionMap.onUpdate).overwriteCondition??(m.overwriteCondition=[]);const q=T.map(Z=>({type:"or",condition:{operator:"notEqual",parameters:[`${t}.${this.escape(Z)}`,`${a}.${this.escape(Z)}`]}}));this.expressionMap.onUpdate.overwriteCondition.push({type:"and",condition:q})}const B=this.createUpsertConditionExpression();F.trim()&&((this.connection.driver.options.type==="mssql"||this.connection.driver.options.type==="sap")&&B!=""?r+=` WHEN MATCHED AND ${B} THEN UPDATE SET ${F}`:(r+=` WHEN MATCHED THEN UPDATE SET ${F}`,B!=""&&(r+=` WHERE ${B}`)))}const l=this.createMergeIntoInsertValuesExpression(a),h=this.connection.driver.options.type==="mssql"?this.createReturningExpression("insert"):null;return r+=" WHEN NOT MATCHED THEN INSERT",i&&(r+=`(${i})`),l&&(r+=` VALUES ${l}`),h&&this.connection.driver.options.type==="mssql"&&(r+=` OUTPUT ${h}`),this.connection.driver.options.type==="mssql"&&(r+=";"),r}createMergeIntoSourceExpression(e){const t=this.getValueSets(),n=this.getInsertedColumns();let i="USING (";if(n.length>0)this.connection.driver.options.type==="mssql"&&(i+="VALUES "),t.forEach((r,a)=>{n.forEach((c,l)=>{l===0&&(this.connection.driver.options.type==="mssql"?i+="(":i+="SELECT ");const h=c.getEntityValue(r);h===void 0&&!(c.isGenerated&&c.generationStrategy==="uuid"&&!this.connection.driver.isUUIDGenerationSupported())?c.default!==void 0&&c.default!==null?i+=this.connection.driver.normalizeDefault(c):i+="NULL":h===null?i+="NULL":i+=this.createColumnValueExpression(t,a,c),this.connection.driver.options.type!=="mssql"&&(i+=` AS ${this.escape(c.databaseName)}`),l===n.length-1?a===t.length-1?["oracle","sap"].includes(this.connection.driver.options.type)?i+=" FROM "+this.connection.driver.dummyTableName:this.connection.driver.options.type==="mssql"&&(i+=")"):["oracle","sap"].includes(this.connection.driver.options.type)&&t.length>1?i+=" FROM "+this.connection.driver.dummyTableName+" UNION ALL ":this.connection.driver.options.type==="mssql"?i+="), ":i+=" UNION ALL ":i+=", "})});else throw new _('Upsert type "merge-into" is not supported without metadata tables');return i+=`) ${e}`,this.connection.driver.options.type==="mssql"&&(i+=` (${n.map(r=>this.escape(r.databaseName)).join(", ")})`),i}createMergeIntoInsertValuesExpression(e){const t=this.getInsertedColumns();let n="";if(t.length>0)t.forEach((i,r)=>{r===0&&(n+="("),i.isGenerated&&i.generationStrategy==="uuid"&&this.connection.driver.isUUIDGenerationSupported()||i.isGenerated&&i.generationStrategy!=="uuid"?n+="DEFAULT":n+=`${e}.${this.escape(i.databaseName)}`,r===t.length-1?n+=")":n+=", "});else throw new _('Upsert type "merge-into" is not supported without metadata tables');return n==="()"?"":n}createUpsertConditionExpression(){if(!this.expressionMap.onUpdate.overwriteCondition)return"";const e=[],t=this.createWhereClausesExpression(this.expressionMap.onUpdate.overwriteCondition);if(t.length>0&&t!=="1=1"&&e.push(t),this.expressionMap.mainAlias.hasMetadata){const i=this.expressionMap.mainAlias.metadata;if(this.expressionMap.queryType==="select"&&!this.expressionMap.withDeleted&&i.deleteDateColumn){const a=`${this.expressionMap.aliasNamePrefixingEnabled?this.expressionMap.mainAlias.name+"."+i.deleteDateColumn.propertyName:i.deleteDateColumn.propertyName} IS NULL`;e.push(a)}if(i.discriminatorColumn&&i.parentEntityMetadata){const a=`${this.expressionMap.aliasNamePrefixingEnabled?this.expressionMap.mainAlias.name+"."+i.discriminatorColumn.databaseName:i.discriminatorColumn.databaseName} IN (:...discriminatorColumnValues)`;e.push(a)}}if(this.expressionMap.extraAppendedAndWhereCondition){const i=this.expressionMap.extraAppendedAndWhereCondition;e.push(i)}let n="";return e.length?e.length===1?n+=`${e[0]}`:n+=`( ${e.join(" ) AND ( ")} )`:n+="",n}createColumnValueExpression(e,t,n){const i=e[t];let r="",a=n.getEntityValue(i);if(typeof a!="function"&&(a=this.connection.driver.preparePersistentValue(a,n)),n.isVersion&&a===void 0)r+="1";else if(n.isDiscriminator)r+=this.createParameter(this.expressionMap.mainAlias.metadata.discriminatorValue);else if(n.isGenerated&&n.generationStrategy==="uuid"&&!this.connection.driver.isUUIDGenerationSupported()&&a===void 0)a=Ip(),r+=this.createParameter(a),t in this.expressionMap.locallyGenerated||(this.expressionMap.locallyGenerated[t]={}),n.setEntityValue(this.expressionMap.locallyGenerated[t],a);else if(a===void 0)this.connection.driver.options.type==="oracle"&&e.length>1||te.isSQLiteFamily(this.connection.driver)||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"?n.default!==void 0&&n.default!==null?r+=this.connection.driver.normalizeDefault(n):this.connection.driver.options.type==="spanner"&&n.isGenerated&&n.generationStrategy==="uuid"?r+="GENERATE_UUID()":r+="NULL":r+="DEFAULT";else if(a===null&&(this.connection.driver.options.type==="spanner"||this.connection.driver.options.type==="oracle"))r+="NULL";else if(typeof a=="function")r+=a();else{this.connection.driver.options.type==="mssql"&&(a=this.connection.driver.parametrizeValue(n,a));const c=this.createParameter(a);if((te.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&this.connection.driver.spatialTypes.includes(n.type)){const h=this.connection.driver.options.legacySpatialSupport?"GeomFromText":"ST_GeomFromText";n.srid!=null?r+=`${h}(${c}, ${n.srid})`:r+=`${h}(${c})`}else te.isPostgresFamily(this.connection.driver)&&this.connection.driver.spatialTypes.includes(n.type)?n.srid!=null?r+=`ST_SetSRID(ST_GeomFromGeoJSON(${c}), ${n.srid})::${n.type}`:r+=`ST_GeomFromGeoJSON(${c})::${n.type}`:this.connection.driver.options.type==="mssql"&&this.connection.driver.spatialTypes.includes(n.type)?r+=n.type+"::STGeomFromText("+c+", "+(n.srid||"0")+")":r+=c}return r}}class Ef{constructor(e,t){this.queryBuilder=e,this.expressionMap=t}async update(e){const t=this.expressionMap.relationMetadata;if(t.isManyToOne||t.isOneToOneOwner){const n=t.joinColumns.reduce((i,r)=>{const a=Ce.isObject(e)?r.referencedColumn.getEntityValue(e):e;return r.setEntityValue(i,a),i},{});if(!this.expressionMap.of||Array.isArray(this.expressionMap.of)&&!this.expressionMap.of.length)return;await this.queryBuilder.createQueryBuilder().update(t.entityMetadata.target).set(n).whereInIds(this.expressionMap.of).execute()}else if((t.isOneToOneNotOwner||t.isOneToMany)&&e===null){const n={};t.inverseRelation.joinColumns.forEach(l=>{n[l.propertyName]=null});const i=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],r={},a=[];i.forEach((l,h)=>{t.inverseRelation.joinColumns.map((f,p)=>{const m="joinColumn_"+h+"_"+p;r[m]=Ce.isObject(l)?f.referencedColumn.getEntityValue(l):l,a.push(`${f.propertyPath} = :${m}`)})});const c=a.map(l=>"("+l+")").join(" OR ");if(!c)return;await this.queryBuilder.createQueryBuilder().update(t.inverseEntityMetadata.target).set(n).where(c).setParameters(r).execute()}else if(t.isOneToOneNotOwner||t.isOneToMany){if(Array.isArray(this.expressionMap.of))throw new _("You cannot update relations of multiple entities with the same related object. Provide a single entity into .of method.");const n=this.expressionMap.of,i=t.inverseRelation.joinColumns.reduce((r,a)=>{const c=Ce.isObject(n)?a.referencedColumn.getEntityValue(n):n;return a.setEntityValue(r,c),r},{});if(!e||Array.isArray(e)&&!e.length)return;await this.queryBuilder.createQueryBuilder().update(t.inverseEntityMetadata.target).set(i).whereInIds(e).execute()}else{const n=t.junctionEntityMetadata,i=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],r=Array.isArray(e)?e:[e],a=t.isManyToManyOwner?i:r,c=t.isManyToManyOwner?r:i,l=[];if(a.forEach(h=>{c.forEach(f=>{const p={};n.ownerColumns.forEach(m=>{p[m.databaseName]=Ce.isObject(h)?m.referencedColumn.getEntityValue(h):h}),n.inverseColumns.forEach(m=>{p[m.databaseName]=Ce.isObject(f)?m.referencedColumn.getEntityValue(f):f}),l.push(p)})}),!l.length)return;this.queryBuilder.connection.driver.options.type==="oracle"||this.queryBuilder.connection.driver.options.type==="sap"?await Promise.all(l.map(h=>this.queryBuilder.createQueryBuilder().insert().into(n.tableName).values(h).execute())):await this.queryBuilder.createQueryBuilder().insert().into(n.tableName).values(l).execute()}}}class o0{constructor(e,t){this.queryBuilder=e,this.expressionMap=t}async remove(e){const t=this.expressionMap.relationMetadata;if(t.isOneToMany){const n=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],i=Array.isArray(e)?e:[e],r={};t.inverseRelation.joinColumns.forEach(h=>{r[h.propertyName]=null});const a={},c=[];n.forEach((h,f)=>{c.push(...i.map((p,m)=>[...t.inverseRelation.joinColumns.map((T,A)=>{const S="joinColumn_"+f+"_"+m+"_"+A;return a[S]=Ce.isObject(h)?T.referencedColumn.getEntityValue(h):h,`${T.propertyPath} = :${S}`}),...t.inverseRelation.entityMetadata.primaryColumns.map((T,A)=>{const S="primaryColumn_"+m+"_"+m+"_"+A;return a[S]=Ce.isObject(p)?T.getEntityValue(p):p,`${T.propertyPath} = :${S}`})].join(" AND ")))});const l=c.map(h=>"("+h+")").join(" OR ");if(!l)return;await this.queryBuilder.createQueryBuilder().update(t.inverseEntityMetadata.target).set(r).where(l).setParameters(a).execute()}else{const n=t.junctionEntityMetadata,i=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],r=Array.isArray(e)?e:[e],a=t.isManyToManyOwner?i:r,c=t.isManyToManyOwner?r:i,l={},h=[];a.forEach((p,m)=>{h.push(...c.map((T,A)=>[...n.ownerColumns.map((S,P)=>{const F="firstValue_"+m+"_"+A+"_"+P;return l[F]=Ce.isObject(p)?S.referencedColumn.getEntityValue(p):p,`${S.databaseName} = :${F}`}),...n.inverseColumns.map((S,P)=>{const F="secondValue_"+m+"_"+A+"_"+P;return l[F]=Ce.isObject(T)?S.referencedColumn.getEntityValue(T):T,`${S.databaseName} = :${F}`})].join(" AND ")))});const f=h.map(p=>"("+p+")").join(" OR ");await this.queryBuilder.createQueryBuilder().delete().from(n.tableName).where(f).setParameters(l).execute()}}}class c0 extends bt{constructor(){super(...arguments),this["@instanceof"]=Symbol.for("RelationQueryBuilder")}getQuery(){return""}of(e){return this.expressionMap.of=e,this}async set(e){const t=this.expressionMap.relationMetadata;if(!this.expressionMap.of)throw new _("Entity whose relation needs to be set is not set. Use .of method to define whose relation you want to set.");if(t.isManyToMany||t.isOneToMany)throw new _(`Set operation is only supported for many-to-one and one-to-one relations. However given "${t.propertyPath}" has ${t.relationType} relation. Use .add() method instead.`);if(t.joinColumns&&t.joinColumns.length>1&&(!Ce.isObject(e)||Object.keys(e).length<t.joinColumns.length))throw new _('Value to be set into the relation must be a map of relation ids, for example: .set({ firstName: "...", lastName: "..." })');return new Ef(this,this.expressionMap).update(e)}async add(e){if(Array.isArray(e)&&e.length===0)return;const t=this.expressionMap.relationMetadata;if(!this.expressionMap.of)throw new _("Entity whose relation needs to be set is not set. Use .of method to define whose relation you want to set.");if(t.isManyToOne||t.isOneToOne)throw new _(`Add operation is only supported for many-to-many and one-to-many relations. However given "${t.propertyPath}" has ${t.relationType} relation. Use .set() method instead.`);if(t.joinColumns&&t.joinColumns.length>1&&(!Ce.isObject(e)||Object.keys(e).length<t.joinColumns.length))throw new _('Value to be set into the relation must be a map of relation ids, for example: .set({ firstName: "...", lastName: "..." })');return new Ef(this,this.expressionMap).update(e)}async remove(e){if(Array.isArray(e)&&e.length===0)return;const t=this.expressionMap.relationMetadata;if(!this.expressionMap.of)throw new _("Entity whose relation needs to be set is not set. Use .of method to define whose relation you want to set.");if(t.isManyToOne||t.isOneToOne)throw new _(`Add operation is only supported for many-to-many and one-to-many relations. However given "${t.propertyPath}" has ${t.relationType} relation. Use .set(null) method instead.`);return new o0(this,this.expressionMap).remove(e)}async addAndRemove(e,t){await this.remove(t),await this.add(e)}async loadOne(){return this.loadMany().then(e=>e[0])}async loadMany(){let e=this.expressionMap.of;if(!Ce.isObject(e)){const t=this.expressionMap.mainAlias.metadata;if(t.hasMultiplePrimaryKeys)throw new _("Cannot load entity because only one primary key was specified, however entity contains multiple primary keys");e=t.primaryColumns[0].createValueMap(e)}return this.connection.relationLoader.load(this.expressionMap.relationMetadata,e,this.queryRunner)}}class ee{static chunk(e,t){return Array.from(Array(Math.ceil(e.length/t)),(n,i)=>e.slice(i*t,i*t+t))}static splitClassesAndStrings(e){return[e.filter(t=>typeof t!="string"),e.filter(t=>typeof t=="string")]}static groupBy(e,t){return e.reduce((n,i)=>{const r=t(i);let a=n.find(c=>c.id===r);return a||(a={id:r,items:[]},n.push(a)),a.items.push(i),n},[])}static uniq(e,t){return e.reduce((n,i)=>{let r=!1;if(typeof t=="function"){const a=t(i);r=!!n.find(c=>t(c)===a)}else typeof t=="string"?r=!!n.find(a=>a[t]===i[t]):r=n.indexOf(i)!==-1;return r||n.push(i),n},[])}static mergeDeep(e,...t){if(!t.length)return e;for(const n of t)ee.merge(e,n);return e}static cloneObject(e){return e==null?e:Object.assign(Object.create(Object.getPrototypeOf(e)),e)}static deepCompare(...e){let t,n,i,r;if(e.length<1)return!0;for(t=1,n=e.length;t<n;t++)if(i=[],r=[],!ee.compare2Objects(i,r,e[0],e[t]))return!1;return!0}static deepValue(e,t){const n=t.split(".");for(let i=0,r=n.length;i<r;i++)e=e[n[i]];return e}static replaceEmptyObjectsWithBooleans(e){for(const t in e)e[t]&&typeof e[t]=="object"&&(Object.keys(e[t]).length===0?e[t]=!0:ee.replaceEmptyObjectsWithBooleans(e[t]))}static propertyPathsToTruthyObject(e){const t={};for(const n of e){const i=n.split(".");if(!i.length)continue;(!t[i[0]]||t[i[0]]===!0)&&(t[i[0]]={});let r=t[i[0]];for(const[a,c]of i.entries())a!==0&&(r[c]?r=r[c]:a===i.length-1?(r[c]={},r=null):(r[c]={},r=r[c]))}return ee.replaceEmptyObjectsWithBooleans(t),t}static compareIds(e,t){return e==null||t===void 0||t===null?!1:(typeof e.id=="string"&&typeof t.id=="string"||typeof e.id=="number"&&typeof t.id=="number")&&Object.keys(e).length===1&&Object.keys(t).length===1?e.id===t.id:ee.deepCompare(e,t)}static toBoolean(e){return typeof e=="boolean"?e:typeof e=="string"?e==="true"||e==="1":typeof e=="number"?e>0:!1}static isArraysEqual(e,t){return e.length!==t.length?!1:e.every(n=>t.includes(n))}static areMutuallyExclusive(...e){return!e.some(n=>{const i=e.filter(r=>r!==n);return n.some(r=>i.some(a=>a.includes(r)))})}static parseSqlCheckExpression(e,t){const n=e.match(new RegExp(`"${t}" varchar CHECK\\s*\\(\\s*"${t}"\\s+IN\\s*`));if(n&&n.index){const r=e.substring(n.index+n[0].length);let a="",c="";const l=[];for(let h=0;h<r.length;h++){const f=r[h];switch(f){case",":a==""?(l.push(c),c=""):c+=f;break;case"'":a==f?r[h+1]===f?(c+=f,h+=1):a="":a=f;break;case")":if(a=="")return l.push(c),l;c+=f;break;default:a!=""&&(c+=f)}}}}static isCriteriaNullOrEmpty(e){return e==null||e===""||Array.isArray(e)&&e.length===0||ee.isPlainObject(e)&&Object.keys(e).length===0}static isSinglePrimitiveCriteria(e){return typeof e=="string"||typeof e=="number"||e instanceof Date}static isPrimitiveCriteria(e){return Array.isArray(e)?e.every(t=>ee.isSinglePrimitiveCriteria(t)):ee.isSinglePrimitiveCriteria(e)}static compare2Objects(e,t,n,i){let r;if(Number.isNaN(n)&&Number.isNaN(i)||n===i)return!0;if(n===null||i===null||n===void 0||i===void 0)return!1;if((typeof n.equals=="function"||typeof n.equals=="function")&&n.equals(i))return!0;if(typeof n=="function"&&typeof i=="function"||n instanceof Date&&i instanceof Date||n instanceof RegExp&&i instanceof RegExp||typeof n=="string"&&typeof i=="string"||typeof n=="number"&&typeof i=="number")return n.toString()===i.toString();if(!(typeof n=="object"&&typeof i=="object")||Object.prototype.isPrototypeOf.call(n,i)||Object.prototype.isPrototypeOf.call(i,n)||n.constructor!==i.constructor||n.prototype!==i.prototype||e.indexOf(n)>-1||t.indexOf(i)>-1)return!1;for(r in i){if(i.hasOwnProperty(r)!==n.hasOwnProperty(r))return!1;if(typeof i[r]!=typeof n[r])return!1}for(r in n){if(i.hasOwnProperty(r)!==n.hasOwnProperty(r))return!1;if(typeof i[r]!=typeof n[r])return!1;switch(typeof n[r]){case"object":case"function":if(e.push(n),t.push(i),!ee.compare2Objects(e,t,n[r],i[r]))return!1;e.pop(),t.pop();break;default:if(n[r]!==i[r])return!1;break}}return!0}static isPlainObject(e){return e==null?!1:!e.constructor||e.constructor===Object}static mergeArrayKey(e,t,n,i){if(i.has(n)){e[t]=i.get(n);return}if(!(n instanceof Promise)){if(!ee.isPlainObject(n)&&!Array.isArray(n)){e[t]=n;return}e[t]||(e[t]=Array.isArray(n)?[]:{}),i.set(n,e[t]),ee.merge(e[t],n,i),i.delete(n)}}static mergeObjectKey(e,t,n,i){if(i.has(n)){Object.assign(e,{[t]:i.get(n)});return}if(!(n instanceof Promise)){if(!ee.isPlainObject(n)&&!Array.isArray(n)){Object.assign(e,{[t]:n});return}e[t]||Object.assign(e,{[t]:Array.isArray(n)?[]:{}}),i.set(n,e[t]),ee.merge(e[t],n,i),i.delete(n)}}static merge(e,t,n=new Map){if(ee.isPlainObject(e)&&ee.isPlainObject(t))for(const[i,r]of Object.entries(t))i!=="__proto__"&&ee.mergeObjectKey(e,i,r,n);if(Array.isArray(e)&&Array.isArray(t))for(let i=0;i<t.length;i++)ee.mergeArrayKey(e,i,t[i],n)}}class u0{constructor(e,t,n,i,r){this.expressionMap=e,this.driver=t,this.rawRelationIdResults=n,this.rawRelationCountResults=i,this.queryRunner=r,this.pojo=this.expressionMap.options.includes("create-pojo"),this.selections=new Set(this.expressionMap.selects.map(a=>a.selection)),this.aliasCache=new Map,this.columnsCache=new Map}transform(e,t){const n=this.group(e,t),i=[];for(const r of n.values()){const a=this.transformRawResultsGroup(r,t);a!==void 0&&i.push(a)}return i}buildAlias(e,t){let n=this.aliasCache.get(e);n||(n=new Map,this.aliasCache.set(e,n));let i=n.get(t);return i||(i=te.buildAlias(this.driver,void 0,e,t),n.set(t,i)),i}group(e,t){const n=new Map,i=[];t.metadata.tableType==="view"?i.push(...t.metadata.columns.map(r=>this.buildAlias(t.name,r.databaseName))):i.push(...t.metadata.primaryColumns.map(r=>this.buildAlias(t.name,r.databaseName)));for(const r of e){const a=i.map(l=>{const h=r[l];return Buffer.isBuffer(h)?h.toString("hex"):Ce.isObject(h)?JSON.stringify(h):h}).join("_"),c=n.get(a);c?c.push(r):n.set(a,[r])}return n}transformRawResultsGroup(e,t){let n=t.metadata;if(n.discriminatorColumn){const f=e.map(m=>m[this.buildAlias(t.name,t.metadata.discriminatorColumn.databaseName)]),p=n.childEntityMetadatas.find(m=>typeof f.find(T=>T===m.discriminatorValue)<"u");p&&(n=p)}const i=n.create(this.queryRunner,{fromDeserializer:!0,pojo:this.pojo}),r=this.transformColumns(e,t,i,n),a=this.transformJoins(e,i,t,n),c=this.transformRelationIds(e,t,i,n),l=this.transformRelationCounts(e,t,i);if(r||n.primaryColumns.every(f=>f.isVirtual===!0)&&(a||c||l))return i}transformColumns(e,t,n,i){let r=!1;const a=e[0];for(const[c,l]of this.getColumnsToProcess(t.name,i)){const h=a[c];h!==void 0&&(h!==null&&!l.isVirtualProperty&&(r=!0),l.setEntityValue(n,this.driver.prepareHydratedValue(h,l)))}return r}transformJoins(e,t,n,i){let r=!1;for(const a of this.expressionMap.joinAttributes){if(!a.metadata||!a.isSelected||a.relation&&!i.relations.find(l=>l===a.relation))continue;if(a.mapToProperty){if(a.mapToPropertyParentAlias!==n.name)continue}else if(!a.relation||a.parentAlias!==n.name||a.relationPropertyPath!==a.relation.propertyPath)continue;let c=this.transform(e,a.alias);c=a.isMany?c:c[0],c=!a.isMany&&c===void 0?null:c,c!==void 0&&(a.mapToPropertyPropertyName?t[a.mapToPropertyPropertyName]=c:a.relation.setEntityValue(t,c),r=!0)}return r}transformRelationIds(e,t,n,i){let r=!1;for(const[a,c]of this.rawRelationIdResults.entries()){if(c.relationIdAttribute.parentAlias!==t.name)continue;const l=c.relationIdAttribute.relation,h=this.createValueMapFromJoinColumns(l,c.relationIdAttribute.parentAlias,e);if(h==null)continue;this.prepareDataForTransformRelationIds();const f=this.hashEntityIds(l,h),p=this.relationIdMaps[a][f]||[],m=c.relationIdAttribute.mapToPropertyPropertyPath.split("."),T=(A,S,P)=>{const F=A.shift();if(F&&A.length===0)return S[F]=P,S;if(F&&A.length>0)T(A,S[F],P);else return S};l.isOneToOne||l.isManyToOne?p[0]!==void 0&&(T(m,n,p[0]),r=!0):(T(m,n,p),r=r||p.length>0)}return r}transformRelationCounts(e,t,n){let i=!1;for(const r of this.rawRelationCountResults){if(r.relationCountAttribute.parentAlias!==t.name)continue;const a=r.relationCountAttribute.relation;let c;a.isOneToMany?c=a.inverseRelation.joinColumns[0].referencedColumn.databaseName:c=a.isOwning?a.joinColumns[0].referencedColumn.databaseName:a.inverseRelation.joinColumns[0].referencedColumn.databaseName;const l=e[0][this.buildAlias(t.name,c)];if(l!=null){n[r.relationCountAttribute.mapToPropertyPropertyName]=0;for(const h of r.results)h.parentId===l&&(n[r.relationCountAttribute.mapToPropertyPropertyName]=parseInt(h.cnt),i=!0)}}return i}getColumnsToProcess(e,t){let n=this.columnsCache.get(e);n||(n=new Map,this.columnsCache.set(e,n));let i=n.get(t);return i||(i=t.columns.filter(r=>!r.isVirtual&&(this.selections.has(e)||this.selections.has(`${e}.${r.propertyPath}`))&&!t.childEntityMetadatas.some(a=>a.target===r.target)).map(r=>[this.buildAlias(e,r.databaseName),r]),n.set(t,i)),i}createValueMapFromJoinColumns(e,t,n){let i;return e.isManyToOne||e.isOneToOneOwner?i=e.entityMetadata.primaryColumns.map(r=>r):e.isOneToMany||e.isOneToOneNotOwner?i=e.inverseRelation.joinColumns.map(r=>r):e.isOwning?i=e.joinColumns.map(r=>r):i=e.inverseRelation.inverseJoinColumns.map(r=>r),i.reduce((r,a)=>{for(const c of n)e.isManyToOne||e.isOneToOneOwner?r[a.databaseName]=this.driver.prepareHydratedValue(c[this.buildAlias(t,a.databaseName)],a):r[a.databaseName]=this.driver.prepareHydratedValue(c[this.buildAlias(t,a.referencedColumn.databaseName)],a.referencedColumn);return r},{})}extractEntityPrimaryIds(e,t){let n;return e.isManyToOne||e.isOneToOneOwner?n=e.entityMetadata.primaryColumns.map(i=>i):e.isOneToMany||e.isOneToOneNotOwner?n=e.inverseRelation.joinColumns.map(i=>i):e.isOwning?n=e.joinColumns.map(i=>i):n=e.inverseRelation.inverseJoinColumns.map(i=>i),n.reduce((i,r)=>(i[r.databaseName]=t[r.databaseName],i),{})}prepareDataForTransformRelationIds(){this.relationIdMaps||(this.relationIdMaps=this.rawRelationIdResults.map(e=>{const t=e.relationIdAttribute.relation;let n;return t.isManyToOne||t.isOneToOneOwner?n=t.joinColumns:t.isOneToMany||t.isOneToOneNotOwner?n=t.inverseEntityMetadata.primaryColumns:t.isOwning?n=t.inverseJoinColumns:n=t.inverseRelation.joinColumns,e.results.reduce((i,r)=>{let a=n.reduce((c,l)=>{let h=r[l.databaseName];return t.isOneToMany||t.isOneToOneNotOwner?(l.isVirtual&&l.referencedColumn&&l.referencedColumn.propertyName!==l.propertyName&&(h=l.referencedColumn.createValueMap(h)),ee.mergeDeep(c,l.createValueMap(h))):(!l.isPrimary&&l.referencedColumn.referencedColumn&&(h=l.referencedColumn.referencedColumn.createValueMap(h)),ee.mergeDeep(c,l.referencedColumn.createValueMap(h)))},{});if(n.length===1&&!e.relationIdAttribute.disableMixedMap&&(t.isOneToMany||t.isOneToOneNotOwner?a=n[0].getEntityValue(a):a=n[0].referencedColumn.getEntityValue(a)),a!==void 0){const c=this.hashEntityIds(t,r);i[c]?i[c].push(a):i[c]=[a]}return i},{})}))}hashEntityIds(e,t){const n=this.extractEntityPrimaryIds(e,t);return JSON.stringify(n)}}let l0=class{constructor(e,t,n){this.connection=e,this.queryRunner=t,this.relationIdAttributes=n}async load(e){const t=this.relationIdAttributes.map(async n=>{if(n.relation.isManyToOne||n.relation.isOneToOneOwner){if(n.queryBuilderFactory)throw new _("Additional condition can not be used with ManyToOne or OneToOne owner relations.");const i={},r=e.map(a=>{const c={},l=[];n.relation.joinColumns.forEach(f=>{c[f.databaseName]=this.connection.driver.prepareHydratedValue(a[te.buildAlias(this.connection.driver,void 0,n.parentAlias,f.databaseName)],f.referencedColumn);const p=`${f.databaseName}:${c[f.databaseName]}`;l.indexOf(p)===-1&&l.push(p)}),n.relation.entityMetadata.primaryColumns.forEach(f=>{c[f.databaseName]=this.connection.driver.prepareHydratedValue(a[te.buildAlias(this.connection.driver,void 0,n.parentAlias,f.databaseName)],f);const p=`${f.databaseName}:${c[f.databaseName]}`;l.indexOf(p)===-1&&l.push(p)}),l.sort();const h=l.join("::");return i[h]?null:(i[h]=!0,c)}).filter(a=>a);return{relationIdAttribute:n,results:r}}else if(n.relation.isOneToMany||n.relation.isOneToOneNotOwner){const i=n.relation,r=i.isOwning?i.joinColumns:i.inverseRelation.joinColumns,a=i.inverseEntityMetadata.target,c=i.inverseEntityMetadata.tableName,l=n.alias||c,h={},f={},p=e.map((S,P)=>{const F=[],B={},q=r.map(re=>{const Ee=re.databaseName+P,Se=S[te.buildAlias(this.connection.driver,void 0,n.parentAlias,re.referencedColumn.databaseName)],me=`${l}:${re.propertyPath}:${Se}`;return F.indexOf(me)!==-1?"":(F.push(me),B[Ee]=Se,l+"."+re.propertyPath+" = :"+Ee)}).filter(re=>re).join(" AND ");F.sort();const Z=F.join("::");return h[Z]?"":(h[Z]=!0,Object.assign(f,B),q)}).filter(S=>S).map(S=>"("+S+")").join(" OR ");if(!p)return{relationIdAttribute:n,results:[]};const m=this.connection.createQueryBuilder(this.queryRunner);ee.uniq([...r,...i.inverseRelation.entityMetadata.primaryColumns],S=>S.propertyPath).forEach(S=>{m.addSelect(l+"."+S.propertyPath,S.databaseName)}),m.from(a,l).where("("+p+")").setParameters(f),n.queryBuilderFactory&&n.queryBuilderFactory(m);const A=await m.getRawMany();return A.forEach(S=>{r.forEach(P=>{S[P.databaseName]=this.connection.driver.prepareHydratedValue(S[P.databaseName],P.referencedColumn)}),i.inverseRelation.entityMetadata.primaryColumns.forEach(P=>{S[P.databaseName]=this.connection.driver.prepareHydratedValue(S[P.databaseName],P)})}),{relationIdAttribute:n,results:A}}else{const i=n.relation,r=i.isOwning?i.joinColumns:i.inverseRelation.inverseJoinColumns,a=i.isOwning?i.inverseJoinColumns:i.inverseRelation.joinColumns,c=n.junctionAlias,l=n.joinInverseSideMetadata.tableName,h=n.alias||l,f=i.isOwning?i.junctionEntityMetadata.tableName:i.inverseRelation.junctionEntityMetadata.tableName,p=e.map(q=>r.reduce((Z,re)=>(Z[re.propertyPath]=q[te.buildAlias(this.connection.driver,void 0,n.parentAlias,re.referencedColumn.databaseName)],Z),{}));if(p.length===0)return{relationIdAttribute:n,results:[]};const m={},T={},A=p.map((q,Z)=>{const re=[],Ee={},Se=Object.keys(q).map(W=>{const Re=W+Z,D=q[W],se=`${c}:${W}:${D}`;return re.indexOf(se)!==-1?"":(re.push(se),Ee[Re]=D,c+"."+W+" = :"+Re)}).filter(W=>W).join(" AND ");re.sort();const me=re.join("::");return T[me]?"":(T[me]=!0,Object.assign(m,Ee),Se)}).filter(q=>q),S=a.map(q=>c+"."+q.propertyPath+" = "+h+"."+q.referencedColumn.propertyPath).join(" AND "),P=A.map(q=>"("+q+" AND "+S+")").join(" OR "),F=this.connection.createQueryBuilder(this.queryRunner);a.forEach(q=>{F.addSelect(c+"."+q.propertyPath,q.databaseName).addOrderBy(c+"."+q.propertyPath)}),r.forEach(q=>{F.addSelect(c+"."+q.propertyPath,q.databaseName).addOrderBy(c+"."+q.propertyPath)}),F.from(l,h).innerJoin(f,c,P).setParameters(m),n.queryBuilderFactory&&n.queryBuilderFactory(F);const B=await F.getRawMany();return B.forEach(q=>{[...r,...a].forEach(Z=>{q[Z.databaseName]=this.connection.driver.prepareHydratedValue(q[Z.databaseName],Z.referencedColumn)})}),{relationIdAttribute:n,results:B}}});return Promise.all(t)}};class $p{constructor(e,t){this.connection=e,this.queryRunner=t}load(e,t,n){const i=Array.isArray(t)?t:[t],r=Array.isArray(n)?n:n?[n]:void 0;return e.isManyToMany?this.loadForManyToMany(e,i,r):e.isManyToOne||e.isOneToOneOwner?this.loadForManyToOneAndOneToOneOwner(e,i,r):this.loadForOneToManyAndOneToOneNotOwner(e,i,r)}async loadManyToManyRelationIdsAndGroup(e,t,n,i){const r=e.isManyToMany||e.isOneToMany,a=Array.isArray(t)?t:[t];if(!n&&(n=await this.connection.relationLoader.load(e,t,this.queryRunner,i),!n.length))return a.map(p=>({entity:p,related:r?[]:void 0}));const c=await this.load(e,t,n),l=Array.isArray(n)?n:[n];let h=[],f=[];return e.isManyToManyOwner?(h=e.junctionEntityMetadata.inverseColumns.map(p=>p.referencedColumn),f=e.junctionEntityMetadata.ownerColumns.map(p=>p.referencedColumn)):e.isManyToManyNotOwner?(h=e.junctionEntityMetadata.ownerColumns.map(p=>p.referencedColumn),f=e.junctionEntityMetadata.inverseColumns.map(p=>p.referencedColumn)):e.isManyToOne||e.isOneToOneOwner?(h=e.joinColumns.map(p=>p.referencedColumn),f=e.entityMetadata.primaryColumns):(e.isOneToMany||e.isOneToOneNotOwner)&&(h=e.inverseRelation.entityMetadata.primaryColumns,f=e.inverseRelation.joinColumns.map(p=>p.referencedColumn)),a.map(p=>{const m={entity:p,related:r?[]:void 0},T=c.filter(A=>f.every(S=>S.compareEntityValue(p,A[S.entityMetadata.name+"_"+S.propertyAliasName])));return T.length&&l.forEach(A=>{T.forEach(S=>{h.every(F=>F.compareEntityValue(A,S[te.buildAlias(this.connection.driver,void 0,F.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+F.propertyPath.replace(".","_"))]))&&(r?m.related.push(A):m.related=A)})}),m})}loadForManyToMany(e,t,n){const i=e.junctionEntityMetadata,r=i.name,a=e.isOwning?i.ownerColumns:i.inverseColumns,c=e.isOwning?i.inverseColumns:i.ownerColumns,l=this.connection.createQueryBuilder(this.queryRunner);a.forEach(m=>{const T=te.buildAlias(this.connection.driver,void 0,m.referencedColumn.entityMetadata.name+"_"+m.referencedColumn.propertyPath.replace(".","_"));l.addSelect(r+"."+m.propertyPath,T)}),c.forEach(m=>{const T=te.buildAlias(this.connection.driver,void 0,m.referencedColumn.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+m.referencedColumn.propertyPath.replace(".","_"));l.addSelect(r+"."+m.propertyPath,T)});let h="";if(a.length===1){const m=t.map(A=>a[0].referencedColumn.getEntityValue(A));m.every(A=>typeof A=="number")?h=`${r}.${a[0].propertyPath} IN (${m.join(", ")})`:(l.setParameter("values1",m),h=r+"."+a[0].propertyPath+" IN (:...values1)")}else h="("+t.map((m,T)=>a.map(A=>{const S="entity1_"+T+"_"+A.propertyName;return l.setParameter(S,A.referencedColumn.getEntityValue(m)),r+"."+A.propertyPath+" = :"+S}).join(" AND ")).map(m=>"("+m+")").join(" OR ")+")";let f="";if(n)if(c.length===1){const m=n.map(A=>c[0].referencedColumn.getEntityValue(A));m.every(A=>typeof A=="number")?f=`${r}.${c[0].propertyPath} IN (${m.join(", ")})`:(l.setParameter("values2",m),f=r+"."+c[0].propertyPath+" IN (:...values2)")}else f="("+n.map((m,T)=>c.map(A=>{const S="entity2_"+T+"_"+A.propertyName;return l.setParameter(S,A.referencedColumn.getEntityValue(m)),r+"."+A.propertyPath+" = :"+S}).join(" AND ")).map(m=>"("+m+")").join(" OR ")+")";const p=[h,f].filter(m=>m.length>0).join(" AND ");return l.from(i.target,r).where(p).getRawMany()}loadForManyToOneAndOneToOneOwner(e,t,n){const i=e.entityMetadata.targetName,r=e.joinColumns.every(l=>!!e.entityMetadata.nonVirtualColumns.find(h=>h===l));if(n&&r){const l=[];if(t.forEach(h=>{const f={};e.entityMetadata.primaryColumns.forEach(p=>{const m=p.entityMetadata.name+"_"+p.propertyPath.replace(".","_");f[m]=p.getEntityValue(h)}),n.forEach(p=>{e.joinColumns.forEach(m=>{const T=m.getEntityValue(h),A=m.referencedColumn.getEntityValue(p);if(!(T===void 0||A===void 0)&&T===A){const S=m.referencedColumn.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+m.referencedColumn.propertyPath.replace(".","_");f[S]=A}})}),Object.keys(f).length===e.entityMetadata.primaryColumns.length+e.joinColumns.length&&l.push(f)}),l.length===t.length)return Promise.resolve(l)}const a=this.connection.createQueryBuilder(this.queryRunner);e.entityMetadata.primaryColumns.forEach(l=>{const h=te.buildAlias(this.connection.driver,void 0,l.entityMetadata.name+"_"+l.propertyPath.replace(".","_"));a.addSelect(i+"."+l.propertyPath,h)}),e.joinColumns.forEach(l=>{const h=te.buildAlias(this.connection.driver,void 0,l.referencedColumn.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+l.referencedColumn.propertyPath.replace(".","_"));a.addSelect(i+"."+l.propertyPath,h)});let c="";if(e.entityMetadata.primaryColumns.length===1){const l=t.map(f=>e.entityMetadata.primaryColumns[0].getEntityValue(f));l.every(f=>typeof f=="number")?c=`${i}.${e.entityMetadata.primaryColumns[0].propertyPath} IN (${l.join(", ")})`:(a.setParameter("values",l),c=i+"."+e.entityMetadata.primaryColumns[0].propertyPath+" IN (:...values)")}else c=t.map((l,h)=>e.entityMetadata.primaryColumns.map((f,p)=>{const m="entity"+h+"_"+p;return a.setParameter(m,f.getEntityValue(l)),i+"."+f.propertyPath+" = :"+m}).join(" AND ")).map(l=>"("+l+")").join(" OR ");return a.from(e.entityMetadata.target,i).where(c).getRawMany()}loadForOneToManyAndOneToOneNotOwner(e,t,n){const i=e;if(e=e.inverseRelation,e.entityMetadata.primaryColumns.length===e.joinColumns.length&&e.entityMetadata.primaryColumns.every(h=>e.joinColumns.indexOf(h)!==-1))return Promise.resolve(t.map(h=>{const f={};return e.joinColumns.forEach(function(p){const m=p.referencedColumn.getEntityValue(h),T=p.referencedColumn.entityMetadata.name+"_"+p.referencedColumn.propertyPath.replace(".","_"),A=p.entityMetadata.name+"_"+i.propertyPath.replace(".","_")+"_"+p.propertyPath.replace(".","_");f[T]=m,f[A]=m}),f}));const r=e.entityMetadata.targetName,a=this.connection.createQueryBuilder(this.queryRunner);e.entityMetadata.primaryColumns.forEach(l=>{const h=te.buildAlias(this.connection.driver,void 0,l.entityMetadata.name+"_"+i.propertyPath.replace(".","_")+"_"+l.propertyPath.replace(".","_"));a.addSelect(r+"."+l.propertyPath,h)}),e.joinColumns.forEach(l=>{const h=te.buildAlias(this.connection.driver,void 0,l.referencedColumn.entityMetadata.name+"_"+l.referencedColumn.propertyPath.replace(".","_"));a.addSelect(r+"."+l.propertyPath,h)});let c="";if(e.joinColumns.length===1){const l=t.map(f=>e.joinColumns[0].referencedColumn.getEntityValue(f));l.every(f=>typeof f=="number")?c=`${r}.${e.joinColumns[0].propertyPath} IN (${l.join(", ")})`:(a.setParameter("values",l),c=r+"."+e.joinColumns[0].propertyPath+" IN (:...values)")}else c=t.map((l,h)=>e.joinColumns.map((f,p)=>{const m="entity"+h+"_"+p;return a.setParameter(m,f.referencedColumn.getEntityValue(l)),r+"."+f.propertyPath+" = :"+m}).join(" AND ")).map(l=>"("+l+")").join(" OR ");return a.from(e.entityMetadata.target,r).where(c).getRawMany()}}class h0{constructor(e){this.expressionMap=e}transform(){this.expressionMap.mainAlias&&this.expressionMap.mainAlias.metadata.relationIds.forEach(e=>{const t=this.metadataToAttribute(this.expressionMap.mainAlias.name,e);this.expressionMap.relationIdAttributes.push(t)}),this.expressionMap.joinAttributes.forEach(e=>{!e.metadata||e.metadata.isJunction||e.metadata.relationIds.forEach(t=>{const n=this.metadataToAttribute(e.alias.name,t);this.expressionMap.relationIdAttributes.push(n)})})}metadataToAttribute(e,t){return new Vu(this.expressionMap,{relationName:e+"."+t.relation.propertyName,mapToProperty:e+"."+t.propertyName,alias:t.alias,queryBuilderFactory:t.queryBuilderFactory})}}class d0{constructor(e,t,n){this.connection=e,this.queryRunner=t,this.relationCountAttributes=n}async load(e){const t=(i,r,a)=>a.indexOf(i)===r,n=this.relationCountAttributes.map(async i=>{if(i.relation.isOneToMany){const r=i.relation,a=r.inverseRelation,c=a.joinColumns[0].referencedColumn.propertyName,l=r.inverseEntityMetadata.target,h=r.inverseEntityMetadata.tableName,f=i.alias||h,p=a.propertyName;let m=e.map(A=>A[i.parentAlias+"_"+c]).filter(A=>!!A);if(m=m.filter(t),m.length===0)return{relationCountAttribute:i,results:[]};const T=this.connection.createQueryBuilder(this.queryRunner);return T.select(f+"."+p,"parentId").addSelect("COUNT(*)","cnt").from(l,f).where(f+"."+p+" IN (:...ids)").addGroupBy(f+"."+p).setParameter("ids",m),i.queryBuilderFactory&&i.queryBuilderFactory(T),{relationCountAttribute:i,results:await T.getRawMany()}}else{let r,a,c,l;i.relation.isOwning?(r=i.relation.joinColumns[0].referencedColumn.databaseName,a=i.relation.inverseJoinColumns[0].referencedColumn.databaseName,c=i.relation.junctionEntityMetadata.columns[0],l=i.relation.junctionEntityMetadata.columns[1]):(r=i.relation.inverseRelation.inverseJoinColumns[0].referencedColumn.databaseName,a=i.relation.inverseRelation.joinColumns[0].referencedColumn.databaseName,c=i.relation.junctionEntityMetadata.columns[1],l=i.relation.junctionEntityMetadata.columns[0]);let h=e.map(P=>P[i.parentAlias+"_"+r]).filter(P=>!!P);if(h=h.filter(t),h.length===0)return{relationCountAttribute:i,results:[]};const f=i.junctionAlias,p=i.joinInverseSideMetadata.tableName,m=i.alias||p,T=i.relation.junctionEntityMetadata.tableName,A=f+"."+c.propertyName+" IN ("+h.map(P=>isNaN(P)?"'"+P+"'":P)+") AND "+f+"."+l.propertyName+" = "+m+"."+a,S=this.connection.createQueryBuilder(this.queryRunner);return S.select(f+"."+c.propertyName,"parentId").addSelect("COUNT("+S.escape(m)+"."+S.escape(a)+")","cnt").from(p,m).innerJoin(T,f,A).addGroupBy(f+"."+c.propertyName),i.queryBuilderFactory&&i.queryBuilderFactory(S),{relationCountAttribute:i,results:await S.getRawMany()}}});return Promise.all(n)}}class f0{constructor(e){this.expressionMap=e}transform(){this.expressionMap.mainAlias&&this.expressionMap.mainAlias.metadata.relationCounts.forEach(e=>{const t=this.metadataToAttribute(this.expressionMap.mainAlias.name,e);this.expressionMap.relationCountAttributes.push(t)}),this.expressionMap.joinAttributes.forEach(e=>{!e.metadata||e.metadata.isJunction||e.metadata.relationCounts.forEach(t=>{const n=this.metadataToAttribute(e.alias.name,t);this.expressionMap.relationCountAttributes.push(n)})})}metadataToAttribute(e,t){return new Qu(this.expressionMap,{relationName:e+"."+t.relation.propertyName,mapToProperty:e+"."+t.propertyName,alias:t.alias,queryBuilderFactory:t.queryBuilderFactory})}}class kt{static isFindOneOptions(e){const t=e;return t&&(Array.isArray(t.select)||Array.isArray(t.relations)||typeof t.select=="object"||typeof t.relations=="object"||typeof t.where=="object"||typeof t.join=="object"||typeof t.order=="object"||typeof t.cache=="object"||typeof t.cache=="boolean"||typeof t.cache=="number"||typeof t.comment=="string"||typeof t.lock=="object"||typeof t.loadRelationIds=="object"||typeof t.loadRelationIds=="boolean"||typeof t.loadEagerRelations=="boolean"||typeof t.withDeleted=="boolean"||typeof t.relationLoadStrategy=="string"||typeof t.transaction=="boolean")}static isFindManyOptions(e){const t=e;return t&&(this.isFindOneOptions(t)||typeof t.skip=="number"||typeof t.take=="number"||typeof t.skip=="string"||typeof t.take=="string")}static extractFindManyOptionsAlias(e){if(this.isFindManyOptions(e)&&e.join)return e.join.alias}static applyOptionsToTreeQueryBuilder(e,t){if(t!=null&&t.relations){const n=[...t.relations];if(kt.applyRelationsRecursively(e,n,e.expressionMap.mainAlias.name,e.expressionMap.mainAlias.metadata,""),n.length>0)throw new QC(n)}return e}static applyRelationsRecursively(e,t,n,i,r){let a=[];if(r){const c=new RegExp("^"+r.replace(".","\\.")+"\\.");a=t.filter(l=>l.match(c)).map(l=>i.findRelationWithPropertyPath(l.replace(c,""))).filter(l=>l)}else a=t.map(c=>i.findRelationWithPropertyPath(c)).filter(c=>c);a.forEach(c=>{const l=te.buildAlias(e.connection.driver,{joiner:"__"},n,c.propertyPath),h=n+"."+c.propertyPath;e.expressionMap.relationLoadStrategy==="query"?e.concatRelationMetadata(c):e.leftJoinAndSelect(h,l),t.splice(t.indexOf(r?r+"."+c.propertyPath:c.propertyPath),1);let f,p;if(e.expressionMap.relationLoadStrategy==="query")f=c.inverseEntityMetadata,p=l;else{const m=e.expressionMap.joinAttributes.find(T=>T.entityOrProperty===h);f=m.metadata,p=m.alias.name}if(!p||!f)throw new Bn(c.propertyPath,i);if(this.applyRelationsRecursively(e,t,p,f,r?r+"."+c.propertyPath:c.propertyPath),e.expressionMap.relationLoadStrategy==="join"){const m=i.relations.find(T=>T.propertyName===c.propertyPath);m&&this.joinEagerRelations(e,l,m.inverseEntityMetadata)}})}static joinEagerRelations(e,t,n){n.eagerRelations.forEach(i=>{let r=te.buildAlias(e.connection.driver,{joiner:"__"},t,i.propertyName),a=!0;for(const h of e.expressionMap.joinAttributes)if(!(h.condition!==void 0||h.mapToProperty!==void 0||h.isMappingMany!==void 0||h.direction!=="LEFT"||h.entityOrProperty!==`${t}.${i.propertyPath}`)){a=!1,r=h.alias.name;break}const c=!!e.expressionMap.joinAttributes.find(h=>h.alias.name===r);a&&!c&&e.leftJoin(t+"."+i.propertyPath,r);let l=!0;for(const h of e.expressionMap.selects)if(!(h.aliasName!==void 0||h.virtual!==void 0||h.selection!==r)){l=!1;break}l&&e.addSelect(r),this.joinEagerRelations(e,r,i.inverseEntityMetadata)})}}class ps extends bt{constructor(){super(...arguments),this["@instanceof"]=Symbol.for("SelectQueryBuilder"),this.findOptions={},this.selects=[],this.joins=[],this.conditions="",this.orderBys=[],this.relationMetadatas=[]}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createSelectExpression(),e+=this.createJoinExpression(),e+=this.createWhereExpression(),e+=this.createGroupByExpression(),e+=this.createHavingExpression(),e+=this.createOrderByExpression(),e+=this.createLimitOffsetExpression(),e+=this.createLockExpression(),e=e.trim(),this.expressionMap.subQuery&&(e="("+e+")"),this.replacePropertyNamesForTheWholeQuery(e)}setFindOptions(e){return this.findOptions=e,this.applyFindOptions(),this}subQuery(){const e=this.createQueryBuilder();return e.expressionMap.subQuery=!0,e.parentQueryBuilder=this,e}select(e,t){if(this.expressionMap.queryType="select",Array.isArray(e))this.expressionMap.selects=e.map(n=>({selection:n}));else if(typeof e=="function"){const n=e(this.subQuery());this.setParameters(n.getParameters()),this.expressionMap.selects.push({selection:n.getQuery(),aliasName:t})}else e&&(this.expressionMap.selects=[{selection:e,aliasName:t}]);return this}addSelect(e,t){if(!e)return this;if(Array.isArray(e))this.expressionMap.selects=this.expressionMap.selects.concat(e.map(n=>({selection:n})));else if(typeof e=="function"){const n=e(this.subQuery());this.setParameters(n.getParameters()),this.expressionMap.selects.push({selection:n.getQuery(),aliasName:t})}else e&&this.expressionMap.selects.push({selection:e,aliasName:t});return this}maxExecutionTime(e){return this.expressionMap.maxExecutionTime=e,this}distinct(e=!0){return this.expressionMap.selectDistinct=e,this}distinctOn(e){return this.expressionMap.selectDistinctOn=e,this}fromDummy(){return this.from(this.connection.driver.dummyTableName??"(SELECT 1 AS dummy_column)","dummy_table")}from(e,t){const n=this.createFromAlias(e,t);return this.expressionMap.setMainAlias(n),this}addFrom(e,t){const n=this.createFromAlias(e,t);return this.expressionMap.mainAlias||this.expressionMap.setMainAlias(n),this}innerJoin(e,t,n,i){return this.join("INNER",e,t,n,i),this}leftJoin(e,t,n,i){return this.join("LEFT",e,t,n,i),this}innerJoinAndSelect(e,t,n,i){return this.addSelect(t),this.innerJoin(e,t,n,i),this}leftJoinAndSelect(e,t,n,i){return this.addSelect(t),this.leftJoin(e,t,n,i),this}innerJoinAndMapMany(e,t,n,i,r){return this.addSelect(n),this.join("INNER",t,n,i,r,e,!0),this}innerJoinAndMapOne(e,t,n,i,r,a){return this.addSelect(n),this.join("INNER",t,n,i,r,e,!1,a),this}leftJoinAndMapMany(e,t,n,i,r){return this.addSelect(n),this.join("LEFT",t,n,i,r,e,!0),this}leftJoinAndMapOne(e,t,n,i,r,a){return this.addSelect(n),this.join("LEFT",t,n,i,r,e,!1,a),this}loadRelationIdAndMap(e,t,n,i){const r=new Vu(this.expressionMap);return r.mapToProperty=e,r.relationName=t,typeof n=="string"&&(r.alias=n),typeof n=="object"&&n.disableMixedMap&&(r.disableMixedMap=!0),r.queryBuilderFactory=i,this.expressionMap.relationIdAttributes.push(r),r.relation.junctionEntityMetadata&&this.expressionMap.createAlias({type:"other",name:r.junctionAlias,metadata:r.relation.junctionEntityMetadata}),this}loadRelationCountAndMap(e,t,n,i){const r=new Qu(this.expressionMap);return r.mapToProperty=e,r.relationName=t,r.alias=n,r.queryBuilderFactory=i,this.expressionMap.relationCountAttributes.push(r),this.expressionMap.createAlias({type:"other",name:r.junctionAlias}),r.relation.junctionEntityMetadata&&this.expressionMap.createAlias({type:"other",name:r.junctionAlias,metadata:r.relation.junctionEntityMetadata}),this}loadAllRelationIds(e){return this.expressionMap.mainAlias.metadata.relations.forEach(t=>{e!==void 0&&e.relations!==void 0&&e.relations.indexOf(t.propertyPath)===-1||this.loadRelationIdAndMap(this.expressionMap.mainAlias.name+"."+t.propertyPath,this.expressionMap.mainAlias.name+"."+t.propertyPath,e)}),this}where(e,t){this.expressionMap.wheres=[];const n=this.getWhereCondition(e);return n&&(this.expressionMap.wheres=[{type:"simple",condition:n}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereExists(e){return this.where(...this.getExistsCondition(e))}andWhereExists(e){return this.andWhere(...this.getExistsCondition(e))}orWhereExists(e){return this.orWhere(...this.getExistsCondition(e))}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}having(e,t){return this.expressionMap.havings.push({type:"simple",condition:e}),t&&this.setParameters(t),this}andHaving(e,t){return this.expressionMap.havings.push({type:"and",condition:e}),t&&this.setParameters(t),this}orHaving(e,t){return this.expressionMap.havings.push({type:"or",condition:e}),t&&this.setParameters(t),this}groupBy(e){return e?this.expressionMap.groupBys=[e]:this.expressionMap.groupBys=[],this}addGroupBy(e){return this.expressionMap.groupBys.push(e),this}timeTravelQuery(e){return this.connection.driver.options.type==="cockroachdb"&&(e===void 0?this.expressionMap.timeTravel="follower_read_timestamp()":this.expressionMap.timeTravel=e),this}orderBy(e,t="ASC",n){if(t!==void 0&&t!=="ASC"&&t!=="DESC")throw new _('SelectQueryBuilder.addOrderBy "order" can accept only "ASC" and "DESC" values.');if(n!==void 0&&n!=="NULLS FIRST"&&n!=="NULLS LAST")throw new _('SelectQueryBuilder.addOrderBy "nulls" can accept only "NULLS FIRST" and "NULLS LAST" values.');return e?typeof e=="object"?this.expressionMap.orderBys=e:n?this.expressionMap.orderBys={[e]:{order:t,nulls:n}}:this.expressionMap.orderBys={[e]:t}:this.expressionMap.orderBys={},this}addOrderBy(e,t="ASC",n){if(t!==void 0&&t!=="ASC"&&t!=="DESC")throw new _('SelectQueryBuilder.addOrderBy "order" can accept only "ASC" and "DESC" values.');if(n!==void 0&&n!=="NULLS FIRST"&&n!=="NULLS LAST")throw new _('SelectQueryBuilder.addOrderBy "nulls" can accept only "NULLS FIRST" and "NULLS LAST" values.');return n?this.expressionMap.orderBys[e]={order:t,nulls:n}:this.expressionMap.orderBys[e]=t,this}limit(e){if(this.expressionMap.limit=this.normalizeNumber(e),this.expressionMap.limit!==void 0&&isNaN(this.expressionMap.limit))throw new _('Provided "limit" value is not a number. Please provide a numeric value.');return this}offset(e){if(this.expressionMap.offset=this.normalizeNumber(e),this.expressionMap.offset!==void 0&&isNaN(this.expressionMap.offset))throw new _('Provided "offset" value is not a number. Please provide a numeric value.');return this}take(e){if(this.expressionMap.take=this.normalizeNumber(e),this.expressionMap.take!==void 0&&isNaN(this.expressionMap.take))throw new _('Provided "take" value is not a number. Please provide a numeric value.');return this}skip(e){if(this.expressionMap.skip=this.normalizeNumber(e),this.expressionMap.skip!==void 0&&isNaN(this.expressionMap.skip))throw new _('Provided "skip" value is not a number. Please provide a numeric value.');return this}useIndex(e){return this.expressionMap.useIndex=e,this}setLock(e,t,n){return this.expressionMap.lockMode=e,this.expressionMap.lockVersion=t,this.expressionMap.lockTables=n,this}setOnLocked(e){return this.expressionMap.onLocked=e,this}withDeleted(){return this.expressionMap.withDeleted=!0,this}async getRawOne(){return(await this.getRawMany())[0]}async getRawMany(){if(this.expressionMap.lockMode==="optimistic")throw new os;this.expressionMap.queryEntity=!1;const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0);const n=await this.loadRawResults(e);return t&&await e.commitTransaction(),n}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}async getRawAndEntities(){const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!0;const n=await this.executeEntitiesAndRawResults(e);return t&&await e.commitTransaction(),n}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}async getOne(){const t=(await this.getRawAndEntities()).entities[0];if(t&&this.expressionMap.lockMode==="optimistic"&&this.expressionMap.lockVersion){const n=this.expressionMap.mainAlias.metadata;if(this.expressionMap.lockVersion instanceof Date){const i=n.updateDateColumn.getEntityValue(t);if(i.getTime()!==this.expressionMap.lockVersion.getTime())throw new Xd(n.name,this.expressionMap.lockVersion,i)}else{const i=n.versionColumn.getEntityValue(t);if(i!==this.expressionMap.lockVersion)throw new Xd(n.name,this.expressionMap.lockVersion,i)}}return t===void 0?null:t}async getOneOrFail(){const e=await this.getOne();if(!e)throw new pu(this.expressionMap.mainAlias.target,this.expressionMap.parameters);return e}async getMany(){if(this.expressionMap.lockMode==="optimistic")throw new os;return(await this.getRawAndEntities()).entities}async getCount(){if(this.expressionMap.lockMode==="optimistic")throw new os;const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!1;const n=await this.executeCountQuery(e);return t&&await e.commitTransaction(),n}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}async getExists(){if(this.expressionMap.lockMode==="optimistic")throw new os;const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!1;const n=await this.executeExistsQuery(e);return t&&await e.commitTransaction(),n}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}async getManyAndCount(){if(this.expressionMap.lockMode==="optimistic")throw new os;const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!0;const n=await this.executeEntitiesAndRawResults(e);this.expressionMap.queryEntity=!1;let i=this.lazyCount(n);if(i===void 0){const a=this.expressionMap.cacheId;a&&(this.expressionMap.cacheId=`${a}-count`),i=await this.executeCountQuery(e)}const r=[n.entities,i];return t&&await e.commitTransaction(),r}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}lazyCount(e){const t=this.expressionMap.limit!==void 0&&this.expressionMap.limit!==null;if(this.expressionMap.joinAttributes.length>0&&t)return;const n=this.expressionMap.take!==void 0&&this.expressionMap.take!==null,i=t?this.expressionMap.limit:n?this.expressionMap.take:void 0;if(i!==void 0&&e.entities.length===i)return;const r=this.expressionMap.skip!==void 0&&this.expressionMap.skip!==null&&this.expressionMap.skip>0,a=this.expressionMap.offset!==void 0&&this.expressionMap.offset!==null&&this.expressionMap.offset>0;if(e.entities.length===0&&(r||a))return;const c=a?this.expressionMap.offset:r?this.expressionMap.skip:0;return e.entities.length+c}async stream(){this.expressionMap.queryEntity=!1;const[e,t]=this.getQueryAndParameters(),n=this.obtainQueryRunner();let i=!1;try{this.expressionMap.useTransaction===!0&&n.isTransactionActive===!1&&(await n.startTransaction(),i=!0);const r=()=>{if(n!==this.queryRunner)return n.release()},a=n.stream(e,t,r,r);return i&&await n.commitTransaction(),a}catch(r){if(i)try{await n.rollbackTransaction()}catch{}throw r}}cache(e,t){return typeof e=="boolean"?this.expressionMap.cache=e:typeof e=="number"?(this.expressionMap.cache=!0,this.expressionMap.cacheDuration=e):(typeof e=="string"||typeof e=="number")&&(this.expressionMap.cache=!0,this.expressionMap.cacheId=e),t&&(this.expressionMap.cacheDuration=t),this}setOption(e){return this.expressionMap.options.push(e),this}join(e,t,n,i,r,a,c,l){r&&this.setParameters(r);const h=new Dp(this.connection,this.expressionMap);h.direction=e,h.mapAsEntity=l,h.mapToProperty=a,h.isMappingMany=c,h.entityOrProperty=t,h.condition=i,this.expressionMap.joinAttributes.push(h);const f=h.metadata;if(f){if(f.deleteDateColumn&&!this.expressionMap.withDeleted){const p=`${n}.${f.deleteDateColumn.propertyName} IS NULL`;h.condition=h.condition?` ${h.condition} AND ${p}`:`${p}`}h.alias=this.expressionMap.createAlias({type:"join",name:n,metadata:f}),h.relation&&h.relation.junctionEntityMetadata&&this.expressionMap.createAlias({type:"join",name:h.junctionAlias,metadata:h.relation.junctionEntityMetadata})}else{let p="";if(typeof t=="function"){const T=t(this.subQuery());this.setParameters(T.getParameters()),p=T.getQuery()}else p=t;const m=typeof t=="function"||t.substr(0,1)==="("&&t.substr(-1)===")";h.alias=this.expressionMap.createAlias({type:"join",name:n,tablePath:m===!1?t:void 0,subQuery:m===!0?p:void 0})}}createSelectExpression(){if(!this.expressionMap.mainAlias)throw new _("Cannot build query because main alias is not set (call qb#from method)");const e=[],t=[];if(this.expressionMap.mainAlias.hasMetadata){const c=this.expressionMap.mainAlias.metadata;e.push(...this.buildEscapedEntityColumnSelects(this.expressionMap.mainAlias.name,c)),t.push(...this.findEntityColumnSelects(this.expressionMap.mainAlias.name,c))}this.expressionMap.joinAttributes.forEach(c=>{if(c.metadata)e.push(...this.buildEscapedEntityColumnSelects(c.alias.name,c.metadata)),t.push(...this.findEntityColumnSelects(c.alias.name,c.metadata));else if(this.expressionMap.selects.some(h=>h.selection===c.alias.name)){e.push({selection:this.escape(c.alias.name)+".*"});const h=this.expressionMap.selects.find(f=>f.selection===c.alias.name);t.push(h)}}),this.expressionMap.selects.filter(c=>t.indexOf(c)===-1).forEach(c=>e.push({selection:this.replacePropertyNames(c.selection),aliasName:c.aliasName})),e.length===0&&e.push({selection:"*"});let n="";this.expressionMap.useIndex&&te.isMySQLFamily(this.connection.driver)&&(n=` USE INDEX (${this.expressionMap.useIndex})`);const i=this.expressionMap.aliases.filter(c=>c.type==="from"&&(c.tablePath||c.subQuery)).map(c=>c.subQuery?c.subQuery+" "+this.escape(c.name):this.getTableName(c.tablePath)+" "+this.escape(c.name)),r=this.createSelectDistinctExpression(),a=e.map(c=>c.selection+(c.aliasName?" AS "+this.escape(c.aliasName):"")).join(", ");return r+a+" FROM "+i.join(", ")+this.createTableLockExpression()+n}createSelectDistinctExpression(){const{selectDistinct:e,selectDistinctOn:t,maxExecutionTime:n}=this.expressionMap,{driver:i}=this.connection;let r="SELECT ";return n>0&&te.isMySQLFamily(i)&&(r+=`/*+ MAX_EXECUTION_TIME(${this.expressionMap.maxExecutionTime}) */ `),te.isPostgresFamily(i)&&t.length>0?r=`SELECT DISTINCT ON (${t.map(c=>this.replacePropertyNames(c)).join(", ")}) `:e&&(r="SELECT DISTINCT "),r}createJoinExpression(){return this.expressionMap.joinAttributes.map(t=>{const n=t.relation,i=t.tablePath,r=t.alias.name;let a=t.condition?" AND ("+t.condition+")":"";const c=t.parentAlias;if(!c||!n){const l=t.alias.subQuery?t.alias.subQuery:this.getTableName(i);return" "+t.direction+" JOIN "+l+" "+this.escape(r)+this.createTableLockExpression()+(t.condition?" ON "+this.replacePropertyNames(t.condition):"")}if(n.isManyToOne||n.isOneToOneOwner){const l=n.joinColumns.map(h=>r+"."+h.referencedColumn.propertyPath+"="+c+"."+n.propertyPath+"."+h.referencedColumn.propertyPath).join(" AND ");return" "+t.direction+" JOIN "+this.getTableName(i)+" "+this.escape(r)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(l+a)}else if(n.isOneToMany||n.isOneToOneNotOwner){const l=n.inverseRelation.joinColumns.map(h=>(n.inverseEntityMetadata.tableType==="entity-child"&&n.inverseEntityMetadata.discriminatorColumn&&(a+=" AND "+r+"."+n.inverseEntityMetadata.discriminatorColumn.databaseName+"='"+n.inverseEntityMetadata.discriminatorValue+"'"),r+"."+n.inverseRelation.propertyPath+"."+h.referencedColumn.propertyPath+"="+c+"."+h.referencedColumn.propertyPath)).join(" AND ");if(!l)throw new _(`Relation ${n.entityMetadata.name}.${n.propertyName} does not have join columns.`);return" "+t.direction+" JOIN "+this.getTableName(i)+" "+this.escape(r)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(l+a)}else{const l=n.junctionEntityMetadata.tablePath,h=t.junctionAlias;let f="",p="";return n.isOwning?(f=n.joinColumns.map(m=>h+"."+m.propertyPath+"="+c+"."+m.referencedColumn.propertyPath).join(" AND "),p=n.inverseJoinColumns.map(m=>r+"."+m.referencedColumn.propertyPath+"="+h+"."+m.propertyPath).join(" AND ")):(f=n.inverseRelation.inverseJoinColumns.map(m=>h+"."+m.propertyPath+"="+c+"."+m.referencedColumn.propertyPath).join(" AND "),p=n.inverseRelation.joinColumns.map(m=>r+"."+m.referencedColumn.propertyPath+"="+h+"."+m.propertyPath).join(" AND "))," "+t.direction+" JOIN "+this.getTableName(l)+" "+this.escape(h)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(f)+" "+t.direction+" JOIN "+this.getTableName(i)+" "+this.escape(r)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(p+a)}}).join(" ")}createGroupByExpression(){return!this.expressionMap.groupBys||!this.expressionMap.groupBys.length?"":" GROUP BY "+this.replacePropertyNames(this.expressionMap.groupBys.join(", "))}createOrderByExpression(){const e=this.expressionMap.allOrderBys;return Object.keys(e).length===0?"":" ORDER BY "+Object.keys(e).map(t=>{const n=typeof e[t]=="string"?e[t]:e[t].order+" "+e[t].nulls,i=this.expressionMap.selects.find(r=>r.selection===t);if(i&&!i.aliasName&&t.indexOf(".")!==-1){const r=t.split("."),a=r[0],c=r.slice(1).join("."),l=this.expressionMap.aliases.find(h=>h.name===a);if(l){const h=l.metadata.findColumnWithPropertyPath(c);if(h){const f=te.buildAlias(this.connection.driver,void 0,a,h.databaseName);return this.escape(f)+" "+n}}}return this.replacePropertyNames(t)+" "+n}).join(", ")}createLimitOffsetExpression(){let e=this.expressionMap.offset,t=this.expressionMap.limit;e===void 0&&t===void 0&&this.expressionMap.joinAttributes.length===0&&(e=this.expressionMap.skip,t=this.expressionMap.take);const n=t!=null,i=e!=null;if(this.connection.driver.options.type==="mssql"){let r="";if((n||i)&&Object.keys(this.expressionMap.allOrderBys).length<=0&&(r=" ORDER BY (SELECT NULL)"),n&&i)return r+" OFFSET "+e+" ROWS FETCH NEXT "+t+" ROWS ONLY";if(n)return r+" OFFSET 0 ROWS FETCH NEXT "+t+" ROWS ONLY";if(i)return r+" OFFSET "+e+" ROWS"}else if(te.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"){if(n&&i)return" LIMIT "+t+" OFFSET "+e;if(n)return" LIMIT "+t;if(i)throw new KC}else if(te.isSQLiteFamily(this.connection.driver)){if(n&&i)return" LIMIT "+t+" OFFSET "+e;if(n)return" LIMIT "+t;if(i)return" LIMIT -1 OFFSET "+e}else if(this.connection.driver.options.type==="oracle"){if(n&&i)return" OFFSET "+e+" ROWS FETCH NEXT "+t+" ROWS ONLY";if(n)return" FETCH NEXT "+t+" ROWS ONLY";if(i)return" OFFSET "+e+" ROWS"}else{if(n&&i)return" LIMIT "+t+" OFFSET "+e;if(n)return" LIMIT "+t;if(i)return" OFFSET "+e}return""}createTableLockExpression(){if(this.connection.driver.options.type==="mssql")switch(this.expressionMap.lockMode){case"pessimistic_read":return" WITH (HOLDLOCK, ROWLOCK)";case"pessimistic_write":return" WITH (UPDLOCK, ROWLOCK)";case"dirty_read":return" WITH (NOLOCK)"}return""}createLockExpression(){const e=this.connection.driver;let t="";if(this.expressionMap.lockTables){if(!(te.isPostgresFamily(e)||e.options.type==="cockroachdb"))throw new _("Lock tables not supported in selected driver");if(this.expressionMap.lockTables.length<1)throw new _("lockTables cannot be an empty array");t=" OF "+this.expressionMap.lockTables.join(", ")}let n="";switch(this.expressionMap.onLocked==="nowait"?n=" NOWAIT":this.expressionMap.onLocked==="skip_locked"&&(n=" SKIP LOCKED"),this.expressionMap.lockMode){case"pessimistic_read":if(e.options.type==="mysql"||e.options.type==="aurora-mysql")return te.isReleaseVersionOrGreater(e,"8.0.0")?" FOR SHARE"+t+n:" LOCK IN SHARE MODE";if(e.options.type==="mariadb")return" LOCK IN SHARE MODE";if(te.isPostgresFamily(e))return" FOR SHARE"+t+n;if(e.options.type==="oracle")return" FOR UPDATE";if(e.options.type==="mssql")return"";throw new xr;case"pessimistic_write":if(te.isMySQLFamily(e)||e.options.type==="aurora-mysql"||e.options.type==="oracle")return" FOR UPDATE"+n;if(te.isPostgresFamily(e)||e.options.type==="cockroachdb")return" FOR UPDATE"+t+n;if(e.options.type==="mssql")return"";throw new xr;case"pessimistic_partial_write":if(te.isPostgresFamily(e))return" FOR UPDATE"+t+" SKIP LOCKED";if(te.isMySQLFamily(e))return" FOR UPDATE SKIP LOCKED";throw new xr;case"pessimistic_write_or_fail":if(te.isPostgresFamily(e)||e.options.type==="cockroachdb")return" FOR UPDATE"+t+" NOWAIT";if(te.isMySQLFamily(e))return" FOR UPDATE NOWAIT";throw new xr;case"for_no_key_update":if(te.isPostgresFamily(e)||e.options.type==="cockroachdb")return" FOR NO KEY UPDATE"+t+n;throw new xr;case"for_key_share":if(te.isPostgresFamily(e))return" FOR KEY SHARE"+t+n;throw new xr;default:return""}}createHavingExpression(){if(!this.expressionMap.havings||!this.expressionMap.havings.length)return"";const e=this.expressionMap.havings.map((t,n)=>{switch(t.type){case"and":return(n>0?"AND ":"")+this.replacePropertyNames(t.condition);case"or":return(n>0?"OR ":"")+this.replacePropertyNames(t.condition);default:return this.replacePropertyNames(t.condition)}}).join(" ");return e.length?" HAVING "+e:""}buildEscapedEntityColumnSelects(e,t){const n=this.expressionMap.selects.some(h=>h.selection===e),i=[];if(n&&i.push(...t.columns.filter(h=>h.isSelect===!0)),i.push(...t.columns.filter(h=>this.expressionMap.selects.some(f=>f.selection===e+"."+h.propertyPath))),i.length===0)return[];const r=this.expressionMap.queryEntity?t.primaryColumns.filter(h=>i.indexOf(h)===-1):[],a=[...i,...r],c=[],l=this.escape(e);return a.forEach(h=>{let f=l+"."+this.escape(h.databaseName);h.isVirtualProperty&&h.query&&(f=`(${h.query(l)})`),this.connection.driver.spatialTypes.indexOf(h.type)!==-1&&((te.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&(f=`${this.connection.driver.options.legacySpatialSupport?"AsText":"ST_AsText"}(${f})`),te.isPostgresFamily(this.connection.driver)&&(h.precision?f=`ST_AsGeoJSON(${f}, ${h.precision})::json`:f=`ST_AsGeoJSON(${f})::json`),this.connection.driver.options.type==="mssql"&&(f=`${f}.ToString()`));const p=this.expressionMap.selects.filter(m=>m.selection===e+"."+h.propertyPath);p.length?p.forEach(m=>{c.push({selection:f,aliasName:m.aliasName?m.aliasName:te.buildAlias(this.connection.driver,void 0,e,h.databaseName),virtual:m.virtual})}):c.push({selection:f,aliasName:te.buildAlias(this.connection.driver,void 0,e,h.databaseName),virtual:n})}),c}findEntityColumnSelects(e,t){return this.expressionMap.selects.filter(n=>n.selection===e||t.columns.some(i=>n.selection===e+"."+i.propertyPath))}computeCountExpression(){const e=this.expressionMap.mainAlias.name,n=this.expressionMap.mainAlias.metadata.primaryColumns,i=this.escape(e);if(this.expressionMap.joinAttributes.length===0&&this.expressionMap.relationIdAttributes.length===0&&this.expressionMap.relationCountAttributes.length===0)return"COUNT(1)";if(this.connection.driver.options.type==="cockroachdb"||te.isPostgresFamily(this.connection.driver))return"COUNT(DISTINCT("+n.map(r=>`${i}.${this.escape(r.databaseName)}`).join(", ")+"))";if(te.isMySQLFamily(this.connection.driver))return"COUNT(DISTINCT "+n.map(r=>`${i}.${this.escape(r.databaseName)}`).join(", ")+")";if(this.connection.driver.options.type==="mssql"){const r=n.map(a=>`${i}.${this.escape(a.databaseName)}`).join(", '|;|', ");return n.length===1?`COUNT(DISTINCT(${r}))`:`COUNT(DISTINCT(CONCAT(${r})))`}return this.connection.driver.options.type==="spanner"?n.length===1?`COUNT(DISTINCT(${i}.${this.escape(n[0].databaseName)}))`:`COUNT(DISTINCT(CONCAT(${n.map(a=>`CAST(${i}.${this.escape(a.databaseName)} AS STRING)`).join(", '|;|', ")})))`:"COUNT(DISTINCT("+n.map(r=>`${i}.${this.escape(r.databaseName)}`).join(" || '|;|' || ")+"))"}async executeCountQuery(e){const t=this.computeCountExpression(),n=await this.clone().orderBy().groupBy().offset(void 0).limit(void 0).skip(void 0).take(void 0).select(t,"cnt").setOption("disable-global-order").loadRawResults(e);return!n||!n[0]||!n[0].cnt?0:parseInt(n[0].cnt)}async executeExistsQuery(e){return(await this.connection.createQueryBuilder().fromDummy().select("1","row_exists").whereExists(this).limit(1).loadRawResults(e)).length>0}applyFindOptions(){if(this.expressionMap.mainAlias.metadata){if(this.findOptions.relationLoadStrategy&&(this.expressionMap.relationLoadStrategy=this.findOptions.relationLoadStrategy),this.findOptions.comment&&this.comment(this.findOptions.comment),this.findOptions.withDeleted&&this.withDeleted(),this.findOptions.select){const e=Array.isArray(this.findOptions.select)?ee.propertyPathsToTruthyObject(this.findOptions.select):this.findOptions.select;this.buildSelect(e,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name)}if(this.selects.length&&this.select(this.selects),this.selects=[],this.findOptions.relations){const e=Array.isArray(this.findOptions.relations)?ee.propertyPathsToTruthyObject(this.findOptions.relations):this.findOptions.relations;this.buildRelations(e,typeof this.findOptions.select=="object"?this.findOptions.select:void 0,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name),this.findOptions.loadEagerRelations!==!1&&this.expressionMap.relationLoadStrategy==="join"&&this.buildEagerRelations(e,typeof this.findOptions.select=="object"?this.findOptions.select:void 0,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name)}if(this.selects.length&&this.addSelect(this.selects),this.findOptions.where&&(this.conditions=this.buildWhere(this.findOptions.where,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name),this.conditions.length&&this.andWhere(this.conditions.substr(0,1)!=="("?"("+this.conditions+")":this.conditions)),this.findOptions.order&&this.buildOrder(this.findOptions.order,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name),this.joins.length&&this.joins.forEach(e=>{e.select&&!e.selection?e.type==="inner"?this.innerJoinAndSelect(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias):this.leftJoinAndSelect(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias):e.type==="inner"?this.innerJoin(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias):this.leftJoin(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias)}),this.findOptions.skip!==void 0&&this.skip(this.findOptions.skip),this.findOptions.take!==void 0&&this.take(this.findOptions.take),typeof this.findOptions.cache=="number"?this.cache(this.findOptions.cache):typeof this.findOptions.cache=="boolean"?this.cache(this.findOptions.cache):typeof this.findOptions.cache=="object"&&this.cache(this.findOptions.cache.id,this.findOptions.cache.milliseconds),this.findOptions.join&&(this.findOptions.join.leftJoin&&Object.keys(this.findOptions.join.leftJoin).forEach(e=>{this.leftJoin(this.findOptions.join.leftJoin[e],e)}),this.findOptions.join.innerJoin&&Object.keys(this.findOptions.join.innerJoin).forEach(e=>{this.innerJoin(this.findOptions.join.innerJoin[e],e)}),this.findOptions.join.leftJoinAndSelect&&Object.keys(this.findOptions.join.leftJoinAndSelect).forEach(e=>{this.leftJoinAndSelect(this.findOptions.join.leftJoinAndSelect[e],e)}),this.findOptions.join.innerJoinAndSelect&&Object.keys(this.findOptions.join.innerJoinAndSelect).forEach(e=>{this.innerJoinAndSelect(this.findOptions.join.innerJoinAndSelect[e],e)})),this.findOptions.lock){if(this.findOptions.lock.mode==="optimistic")this.setLock(this.findOptions.lock.mode,this.findOptions.lock.version);else if(this.findOptions.lock.mode==="pessimistic_read"||this.findOptions.lock.mode==="pessimistic_write"||this.findOptions.lock.mode==="dirty_read"||this.findOptions.lock.mode==="pessimistic_partial_write"||this.findOptions.lock.mode==="pessimistic_write_or_fail"||this.findOptions.lock.mode==="for_no_key_update"||this.findOptions.lock.mode==="for_key_share"){const e=this.findOptions.lock.tables?this.findOptions.lock.tables.map(t=>{const n=this.expressionMap.aliases.find(i=>i.metadata.tableNameWithoutPrefix===t);if(!n)throw new _(`"${t}" is not part of this query`);return this.escape(n.name)}):void 0;this.setLock(this.findOptions.lock.mode,void 0,e),this.findOptions.lock.onLocked&&this.setOnLocked(this.findOptions.lock.onLocked)}}this.findOptions.loadRelationIds===!0?this.loadAllRelationIds():typeof this.findOptions.loadRelationIds=="object"&&this.loadAllRelationIds(this.findOptions.loadRelationIds),this.findOptions.loadEagerRelations!==!1&&kt.joinEagerRelations(this,this.expressionMap.mainAlias.name,this.expressionMap.mainAlias.metadata),this.findOptions.transaction===!0&&(this.expressionMap.useTransaction=!0)}}concatRelationMetadata(e){this.relationMetadatas.push(e)}async executeEntitiesAndRawResults(e){if(!this.expressionMap.mainAlias)throw new _('Alias is not set. Use "from" method to set an alias.');if((this.expressionMap.lockMode==="pessimistic_read"||this.expressionMap.lockMode==="pessimistic_write"||this.expressionMap.lockMode==="pessimistic_partial_write"||this.expressionMap.lockMode==="pessimistic_write_or_fail"||this.expressionMap.lockMode==="for_no_key_update"||this.expressionMap.lockMode==="for_key_share")&&!e.isTransactionActive)throw new WC;if(this.expressionMap.lockMode==="optimistic"){const l=this.expressionMap.mainAlias.metadata;if(!l.versionColumn&&!l.updateDateColumn)throw new kC(l.name)}const t=new l0(this.connection,e,this.expressionMap.relationIdAttributes),n=new d0(this.connection,e,this.expressionMap.relationCountAttributes);new h0(this.expressionMap).transform(),new f0(this.expressionMap).transform();let a=[],c=[];if((this.expressionMap.skip||this.expressionMap.take)&&this.expressionMap.joinAttributes.length>0){const[l,h]=this.createOrderByCombinedWithSelectExpression("distinctAlias"),f=this.expressionMap.mainAlias.metadata,p=this.expressionMap.mainAlias.name,m=f.primaryColumns.map(S=>{const P=this.escape("distinctAlias"),F=this.escape(te.buildAlias(this.connection.driver,void 0,p,S.databaseName));h[F]||(h[F]="ASC");const B=te.buildAlias(this.connection.driver,void 0,"ids_"+p,S.databaseName);return`${P}.${F} AS ${this.escape(B)}`}),T=this.clone(),A=T.expressionMap.timeTravel;if(a=await new ps(this.connection,e).select(`DISTINCT ${m.join(", ")}`).addSelect(l).from(`(${T.orderBy().timeTravelQuery(!1).getQuery()})`,"distinctAlias").timeTravelQuery(A).offset(this.expressionMap.skip).limit(this.expressionMap.take).orderBy(h).cache(this.expressionMap.cache&&this.expressionMap.cacheId?`${this.expressionMap.cacheId}-pagination`:this.expressionMap.cache,this.expressionMap.cacheDuration).setParameters(this.getParameters()).setNativeParameters(this.expressionMap.nativeParameters).getRawMany(),a.length>0){let S="";const P={};if(f.hasMultiplePrimaryKeys)S=a.map((F,B)=>f.primaryColumns.map(q=>{const Z=`orm_distinct_ids_${B}_${q.databaseName}`,re=te.buildAlias(this.connection.driver,void 0,"ids_"+p,q.databaseName);return P[Z]=F[re],`${p}.${q.propertyPath}=:${Z}`}).join(" AND ")).join(" OR ");else{const F=te.buildAlias(this.connection.driver,void 0,"ids_"+p,f.primaryColumns[0].databaseName),B=a.map(Z=>Z[F]);B.every(Z=>typeof Z=="number")?S=`${p}.${f.primaryColumns[0].propertyPath} IN (${B.join(", ")})`:(P.orm_distinct_ids=B,S=p+"."+f.primaryColumns[0].propertyPath+" IN (:...orm_distinct_ids)")}a=await this.clone().mergeExpressionMap({extraAppendedAndWhereCondition:S}).setParameters(P).loadRawResults(e)}}else a=await this.loadRawResults(e);if(a.length>0){const l=await t.load(a),h=await n.load(a);c=new u0(this.expressionMap,this.connection.driver,l,h,this.queryRunner).transform(a,this.expressionMap.mainAlias),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await e.broadcaster.broadcast("Load",this.expressionMap.mainAlias.metadata,c)}if(this.expressionMap.relationLoadStrategy==="query"){const l=new $p(this.connection,e);await Promise.all(this.relationMetadatas.map(async h=>{const f=h.inverseEntityMetadata.target,p=h.inverseEntityMetadata.targetName,m=Array.isArray(this.findOptions.select)?ee.propertyPathsToTruthyObject(this.findOptions.select):this.findOptions.select,T=Array.isArray(this.findOptions.relations)?ee.propertyPathsToTruthyObject(this.findOptions.relations):this.findOptions.relations,A=this.createQueryBuilder(e).select(p).from(f,p).setFindOptions({select:m?ee.deepValue(m,h.propertyPath):void 0,order:this.findOptions.order?ee.deepValue(this.findOptions.order,h.propertyPath):void 0,relations:T?ee.deepValue(T,h.propertyPath):void 0,withDeleted:this.findOptions.withDeleted,relationLoadStrategy:this.findOptions.relationLoadStrategy});if(c.length>0){const S=await l.loadManyToManyRelationIdsAndGroup(h,c,void 0,A);c.forEach(P=>{const F=S.find(B=>B.entity===P);if(F){const B=F.related===void 0?null:F.related;h.setEntityValue(P,B)}})}}))}return{raw:a,entities:c}}createOrderByCombinedWithSelectExpression(e){const t=this.expressionMap.allOrderBys,n=Object.keys(t).map(r=>{if(r.indexOf(".")!==-1){const a=r.split("."),c=a[0],l=a.slice(1).join("."),f=this.expressionMap.findAliasByName(c).metadata.findColumnWithPropertyPath(l);return this.escape(e)+"."+this.escape(te.buildAlias(this.connection.driver,void 0,c,f.databaseName))}else return this.expressionMap.selects.find(a=>a.selection===r||a.aliasName===r)?this.escape(e)+"."+this.escape(r):""}).join(", "),i={};return Object.keys(t).forEach(r=>{if(r.indexOf(".")!==-1){const a=r.split("."),c=a[0],l=a.slice(1).join("."),f=this.expressionMap.findAliasByName(c).metadata.findColumnWithPropertyPath(l);i[this.escape(e)+"."+this.escape(te.buildAlias(this.connection.driver,void 0,c,f.databaseName))]=t[r]}else this.expressionMap.selects.find(a=>a.selection===r||a.aliasName===r)?i[this.escape(e)+"."+this.escape(r)]=t[r]:i[r]=t[r]}),[n,i]}async loadRawResults(e){const[t,n]=this.getQueryAndParameters(),i=t+" -- PARAMETERS: "+JSON.stringify(n,(f,p)=>typeof p=="bigint"?p.toString():p),r=typeof this.connection.options.cache=="object"?this.connection.options.cache:{};let a;const c=r.alwaysEnabled&&this.expressionMap.cache!==!1||this.expressionMap.cache===!0;let l=!1;if(this.connection.queryResultCache&&c)try{if(a=await this.connection.queryResultCache.getFromCache({identifier:this.expressionMap.cacheId,query:i,duration:this.expressionMap.cacheDuration||r.duration||1e3},e),a&&!this.connection.queryResultCache.isExpired(a))return JSON.parse(a.result)}catch(f){if(!r.ignoreErrors)throw f;l=!0}const h=await e.query(t,n,!0);if(!l&&this.connection.queryResultCache&&c)try{await this.connection.queryResultCache.storeInCache({identifier:this.expressionMap.cacheId,query:i,time:Date.now(),duration:this.expressionMap.cacheDuration||r.duration||1e3,result:JSON.stringify(h.records)},a,e)}catch(f){if(!r.ignoreErrors)throw f}return h.records}mergeExpressionMap(e){return Ce.assign(this.expressionMap,e),this}normalizeNumber(e){return typeof e=="number"||e===void 0||e===null?e:Number(e)}obtainQueryRunner(){return this.queryRunner||this.connection.createQueryRunner(this.connection.defaultReplicationModeForReads())}buildSelect(e,t,n,i){for(const r in e){if(e[r]===void 0||e[r]===!1)continue;const a=i?i+"."+r:r,c=t.findColumnWithPropertyPathStrict(a),l=t.findEmbeddedWithPropertyPath(a),h=t.findRelationWithPropertyPath(a);if(!l&&!c&&!h)throw new Bn(a,t);c?this.selects.push(n+"."+a):l&&this.buildSelect(e[r],t,n,a)}}buildRelations(e,t,n,i,r){e&&Object.keys(e).forEach(a=>{const c=e[a],l=r?r+"."+a:a,h=n.findEmbeddedWithPropertyPath(l),f=n.findRelationWithPropertyPath(l);if(!h&&!f)throw new Bn(l,n);if(h)this.buildRelations(c,typeof t=="object"?ee.deepValue(t,h.propertyPath):void 0,n,i,l);else if(f){let p=i+"_"+l.replace(".","_");p=te.buildAlias(this.connection.driver,{joiner:"__"},i,p),(c===!0||typeof c=="object")&&(this.expressionMap.relationLoadStrategy==="query"?this.concatRelationMetadata(f):(this.joins.push({type:"left",select:!0,selection:t&&typeof t[a]=="object"?t[a]:void 0,alias:p,parentAlias:i,relationMetadata:f}),t&&typeof t[a]=="object"&&this.buildSelect(t[a],f.inverseEntityMetadata,p))),typeof c=="object"&&this.expressionMap.relationLoadStrategy==="join"&&this.buildRelations(c,typeof t=="object"?ee.deepValue(t,f.propertyPath):void 0,f.inverseEntityMetadata,p,void 0)}})}buildEagerRelations(e,t,n,i,r){e&&Object.keys(e).forEach(a=>{const c=e[a],l=r?r+"."+a:a,h=n.findEmbeddedWithPropertyPath(l),f=n.findRelationWithPropertyPath(l);if(!h&&!f)throw new Bn(l,n);if(h)this.buildEagerRelations(c,typeof t=="object"?ee.deepValue(t,h.propertyPath):void 0,n,i,l);else if(f){let p=i+"_"+l.replace(".","_");p=te.buildAlias(this.connection.driver,{joiner:"__"},i,p),(c===!0||typeof c=="object")&&f.inverseEntityMetadata.eagerRelations.forEach(m=>{let T=p+"_"+m.propertyPath.replace(".","_");T=te.buildAlias(this.connection.driver,{joiner:"__"},p,T),this.joins.find(S=>S.alias===T)||this.joins.push({type:"left",select:!0,alias:T,parentAlias:p,selection:void 0,relationMetadata:m}),t&&typeof t[a]=="object"&&this.buildSelect(t[a],f.inverseEntityMetadata,p)}),typeof c=="object"&&this.buildEagerRelations(c,typeof t=="object"?ee.deepValue(t,f.propertyPath):void 0,f.inverseEntityMetadata,p,void 0)}})}buildOrder(e,t,n,i){for(const r in e){if(e[r]===void 0)continue;const a=i?i+"."+r:r,c=t.findColumnWithPropertyPathStrict(a),l=t.findEmbeddedWithPropertyPath(a),h=t.findRelationWithPropertyPath(a);if(!l&&!c&&!h)throw new Bn(a,t);if(c){let f=typeof e[r]=="object"?e[r].direction:e[r];f=f==="DESC"||f==="desc"||f===-1?"DESC":"ASC";let p=typeof e[r]=="object"?e[r].nulls:void 0;p=(p==null?void 0:p.toLowerCase())==="first"?"NULLS FIRST":(p==null?void 0:p.toLowerCase())==="last"?"NULLS LAST":void 0;const m=`${n}.${a}`;this.addOrderBy(m,f,p)}else if(l)this.buildOrder(e[r],t,n,a);else if(h){let f=n+"_"+a.replace(".","_");f=te.buildAlias(this.connection.driver,{joiner:"__"},n,f),this.joins.find(m=>m.alias===f)||this.joins.push({type:"left",select:!1,alias:f,parentAlias:n,selection:void 0,relationMetadata:h}),this.buildOrder(e[r],h.inverseEntityMetadata,f)}}}buildWhere(e,t,n,i){var a,c,l;let r="";if(Array.isArray(e))e.length&&(r=e.map(h=>this.buildWhere(h,t,n,i)).filter(h=>!!h).map(h=>"("+h+")").join(" OR "));else{const h=[];for(const f in e){let p=e[f];const m=i?i+"."+f:f,T=t.findColumnWithPropertyPathStrict(m),A=t.findEmbeddedWithPropertyPath(m),S=t.findRelationWithPropertyPath(m);if(!A&&!T&&!S)throw new Bn(m,t);if(p===void 0){if((((a=this.connection.options.invalidWhereValuesBehavior)==null?void 0:a.undefined)||"ignore")==="throw")throw new _(`Undefined value encountered in property '${n}.${f}' of a where condition. Set 'invalidWhereValuesBehavior.undefined' to 'ignore' in connection options to skip properties with undefined values.`);continue}if(p===null){const P=((c=this.connection.options.invalidWhereValuesBehavior)==null?void 0:c.null)||"ignore";if(P==="ignore")continue;if(P==="throw")throw new _(`Null value encountered in property '${n}.${f}' of a where condition. To match with SQL NULL, the IsNull() operator must be used. Set 'invalidWhereValuesBehavior.null' to 'ignore' or 'sql-null' in connection options to skip or handle null values.`)}if(T){let P=`${n}.${m}`;if(T.isVirtualProperty&&T.query&&(P=`(${T.query(this.escape(n))})`),p===null){h.push(`${P} IS NULL`);continue}$.isEqualOperator(e[f])&&(p=e[f].value),T.transformer&&(p instanceof As?p.transformValue(T.transformer):p=Mt.transformTo(T.transformer,p)),this.connection.driver.options.type==="mssql"&&(p=this.connection.driver.parametrizeValues(T,p)),h.push(this.createWhereConditionExpression(this.getWherePredicateCondition(P,p)))}else if(A){const P=this.buildWhere(e[f],t,n,m);P&&h.push(P)}else if(S){if(e[f]===null){const P=((l=this.connection.options.invalidWhereValuesBehavior)==null?void 0:l.null)||"ignore";if(P==="sql-null")h.push(`${n}.${m} IS NULL`);else if(P==="throw")throw new _(`Null value encountered in property '${n}.${f}' of a where condition. Set 'invalidWhereValuesBehavior.null' to 'ignore' or 'sql-null' in connection options to skip or handle null values.`);continue}if(typeof e[f]=="object"&&Object.keys(e[f]).every(F=>e[f][F]===void 0))continue;if($.isFindOperator(e[f]))if(e[f].type==="moreThan"||e[f].type==="lessThan"||e[f].type==="moreThanOrEqual"||e[f].type==="lessThanOrEqual"){let P="";e[f].type==="moreThan"?P=">":e[f].type==="lessThan"?P="<":e[f].type==="moreThanOrEqual"?P=">=":e[f].type==="lessThanOrEqual"&&(P="<=");const F=this.subQuery();if(S.isManyToManyOwner)F.select("COUNT(*)").from(S.joinTableName,S.joinTableName).where(S.joinColumns.map(B=>`${S.joinTableName}.${B.propertyName} = ${n}.${B.referencedColumn.propertyName}`).join(" AND "));else if(S.isManyToManyNotOwner)F.select("COUNT(*)").from(S.inverseRelation.joinTableName,S.inverseRelation.joinTableName).where(S.inverseRelation.inverseJoinColumns.map(B=>`${S.inverseRelation.joinTableName}.${B.propertyName} = ${n}.${B.referencedColumn.propertyName}`).join(" AND "));else if(S.isOneToMany)F.select("COUNT(*)").from(S.inverseEntityMetadata.target,S.inverseEntityMetadata.tableName).where(S.inverseRelation.joinColumns.map(B=>`${S.inverseEntityMetadata.tableName}.${B.propertyName} = ${n}.${B.referencedColumn.propertyName}`).join(" AND "));else throw new Error("This relation isn't supported by given find operator");this.andWhere(F.getSql()+" "+P+" "+parseInt(e[f].value))}else if(S.isManyToOne||S.isOneToOne&&S.isOneToOneOwner){const P=`${n}.${m}`;h.push(this.createWhereConditionExpression(this.getWherePredicateCondition(P,e[f])))}else throw new Error("This relation isn't supported by given find operator");else{let P=n+"_"+S.propertyPath.replace(".","_");P=te.buildAlias(this.connection.driver,{joiner:"__"},n,P),this.joins.find(q=>q.alias===P)||this.joins.push({type:"left",select:!1,selection:void 0,alias:P,parentAlias:n,relationMetadata:S});const B=this.buildWhere(e[f],S.inverseEntityMetadata,P);B&&h.push(B)}}}r=h.length?"("+h.join(") AND (")+")":h.join(" AND ")}return r.length?"("+r+")":r}}class Lp{constructor(){this.generatedMaps=[]}static from(e){const t=new this;return t.raw=e.records,t.affected=e.affected,t}}class p0 extends bt{constructor(e,t){super(e,t),this["@instanceof"]=Symbol.for("SoftDeleteQueryBuilder"),this.expressionMap.aliasNamePrefixingEnabled=!1}getQuery(){let e=this.createUpdateExpression();return e+=this.createCteExpression(),e+=this.createOrderByExpression(),e+=this.createLimitExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&(this.expressionMap.queryType==="soft-delete"?await e.broadcaster.broadcast("BeforeSoftRemove",this.expressionMap.mainAlias.metadata):this.expressionMap.queryType==="restore"&&await e.broadcaster.broadcast("BeforeRecover",this.expressionMap.mainAlias.metadata));const n=new Hu(e,this.expressionMap);this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&(this.expressionMap.extraReturningColumns=n.getSoftDeletionReturningColumns());const[i,r]=this.getQueryAndParameters(),a=await e.query(i,r,!0),c=Lp.from(a);return this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&await n.update(c,this.expressionMap.whereEntities),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&(this.expressionMap.queryType==="soft-delete"?await e.broadcaster.broadcast("AfterSoftRemove",this.expressionMap.mainAlias.metadata):this.expressionMap.queryType==="restore"&&await e.broadcaster.broadcast("AfterRecover",this.expressionMap.mainAlias.metadata)),t&&await e.commitTransaction(),c}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}from(e,t){e=$.isEntitySchema(e)?e.options.name:e;const n=this.createFromAlias(e,t);return this.expressionMap.setMainAlias(n),this}where(e,t){this.expressionMap.wheres=[];const n=this.getWhereCondition(e);return n&&(this.expressionMap.wheres=[{type:"simple",condition:n}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("update"))throw new no;return this.expressionMap.returning=e,this}orderBy(e,t="ASC",n){return e?typeof e=="object"?this.expressionMap.orderBys=e:n?this.expressionMap.orderBys={[e]:{order:t,nulls:n}}:this.expressionMap.orderBys={[e]:t}:this.expressionMap.orderBys={},this}addOrderBy(e,t="ASC",n){return n?this.expressionMap.orderBys[e]={order:t,nulls:n}:this.expressionMap.orderBys[e]=t,this}limit(e){return this.expressionMap.limit=e,this}whereEntity(e){if(!this.expressionMap.mainAlias.hasMetadata)throw new _(".whereEntity method can only be used on queries which update real entity table.");this.expressionMap.wheres=[];const t=Array.isArray(e)?e:[e];return t.forEach(n=>{const i=this.expressionMap.mainAlias.metadata.getEntityIdMap(n);if(!i)throw new _("Provided entity does not have ids set, cannot perform operation.");this.orWhereInIds(i)}),this.expressionMap.whereEntities=t,this}updateEntity(e){return this.expressionMap.updateEntity=e,this}createUpdateExpression(){const e=this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata:void 0;if(!e)throw new _(`Cannot get entity metadata for the given alias "${this.expressionMap.mainAlias}"`);if(!e.deleteDateColumn)throw new LC(e);const t=[];switch(this.expressionMap.queryType){case"soft-delete":t.push(this.escape(e.deleteDateColumn.databaseName)+" = CURRENT_TIMESTAMP");break;case"restore":t.push(this.escape(e.deleteDateColumn.databaseName)+" = NULL");break;default:throw new _('The queryType must be "soft-delete" or "restore"')}if(e.versionColumn&&t.push(this.escape(e.versionColumn.databaseName)+" = "+this.escape(e.versionColumn.databaseName)+" + 1"),e.updateDateColumn&&t.push(this.escape(e.updateDateColumn.databaseName)+" = CURRENT_TIMESTAMP"),t.length<=0)throw new fu;const n=this.createWhereExpression(),i=this.createReturningExpression("update");return i===""?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${t.join(", ")}${n}`:this.connection.driver.options.type==="mssql"?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${t.join(", ")} OUTPUT ${i}${n}`:`UPDATE ${this.getTableName(this.getMainTableName())} SET ${t.join(", ")}${n} RETURNING ${i}`}createOrderByExpression(){const e=this.expressionMap.orderBys;return Object.keys(e).length>0?" ORDER BY "+Object.keys(e).map(t=>typeof e[t]=="string"?this.replacePropertyNames(t)+" "+e[t]:this.replacePropertyNames(t)+" "+e[t].order+" "+e[t].nulls).join(", "):""}createLimitExpression(){const e=this.expressionMap.limit;if(e){if(te.isMySQLFamily(this.connection.driver))return" LIMIT "+e;throw new mp}return""}}class m0 extends bt{constructor(e,t){super(e,t),this["@instanceof"]=Symbol.for("UpdateQueryBuilder"),this.expressionMap.aliasNamePrefixingEnabled=!1}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createUpdateExpression(),e+=this.createOrderByExpression(),e+=this.createLimitExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){const e=this.obtainQueryRunner();let t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await e.broadcaster.broadcast("BeforeUpdate",this.expressionMap.mainAlias.metadata,this.expressionMap.valuesSet);let n=null,i=null;const r=new Hu(e,this.expressionMap),a=[];if(Array.isArray(this.expressionMap.returning)&&this.expressionMap.mainAlias.hasMetadata)for(const m of this.expressionMap.returning)a.push(...this.expressionMap.mainAlias.metadata.findColumnsWithPropertyPath(m));this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&(this.expressionMap.extraReturningColumns=r.getUpdationReturningColumns(),a.push(...this.expressionMap.extraReturningColumns.filter(m=>!a.includes(m)))),a.length>0&&this.connection.driver.options.type==="mssql"&&(n=this.connection.driver.buildTableVariableDeclaration("@OutputTable",a),i="SELECT * FROM @OutputTable");const[c,l]=this.getQueryAndParameters(),h=[n,c,i],f=await e.query(h.filter(m=>m!=null).join(`;

`),l,!0),p=Lp.from(f);return this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&await r.update(p,this.expressionMap.whereEntities),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await e.broadcaster.broadcast("AfterUpdate",this.expressionMap.mainAlias.metadata,this.expressionMap.valuesSet),t&&await e.commitTransaction(),p}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}set(e){return this.expressionMap.valuesSet=e,this}where(e,t){this.expressionMap.wheres=[];const n=this.getWhereCondition(e);return n&&(this.expressionMap.wheres=[{type:"simple",condition:n}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("update"))throw new no;return this.expressionMap.returning=e,this}orderBy(e,t="ASC",n){return e?typeof e=="object"?this.expressionMap.orderBys=e:n?this.expressionMap.orderBys={[e]:{order:t,nulls:n}}:this.expressionMap.orderBys={[e]:t}:this.expressionMap.orderBys={},this}addOrderBy(e,t="ASC",n){return n?this.expressionMap.orderBys[e]={order:t,nulls:n}:this.expressionMap.orderBys[e]=t,this}limit(e){return this.expressionMap.limit=e,this}whereEntity(e){if(!this.expressionMap.mainAlias.hasMetadata)throw new _(".whereEntity method can only be used on queries which update real entity table.");this.expressionMap.wheres=[];const t=Array.isArray(e)?e:[e];return t.forEach(n=>{const i=this.expressionMap.mainAlias.metadata.getEntityIdMap(n);if(!i)throw new _("Provided entity does not have ids set, cannot perform operation.");this.orWhereInIds(i)}),this.expressionMap.whereEntities=t,this}updateEntity(e){return this.expressionMap.updateEntity=e,this}createUpdateExpression(){const e=this.getValueSet(),t=this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata:void 0,n={};for(const l in e)e[l]!==void 0&&(n[l]=e[l]);const i=[],r=[];if(t?(this.createPropertyPath(t,n).forEach(l=>{const h=t.findColumnsWithPropertyPath(l);if(h.length<=0)throw new Bn(l,t);h.forEach(f=>{if(!f.isUpdate||r.includes(f))return;r.push(f);let p=f.getEntityValue(n);if(f.referencedColumn&&typeof p=="object"&&!(p instanceof Date)&&p!==null&&!Buffer.isBuffer(p)?p=f.referencedColumn.getEntityValue(p):typeof p!="function"&&(p=this.connection.driver.preparePersistentValue(p,f)),typeof p=="function")i.push(this.escape(f.databaseName)+" = "+p());else if((this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner")&&p===null)i.push(this.escape(f.databaseName)+" = NULL");else{this.connection.driver.options.type==="mssql"&&(p=this.connection.driver.parametrizeValue(f,p));const m=this.createParameter(p);let T=null;if((te.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&this.connection.driver.spatialTypes.indexOf(f.type)!==-1){const S=this.connection.driver.options.legacySpatialSupport?"GeomFromText":"ST_GeomFromText";f.srid!=null?T=`${S}(${m}, ${f.srid})`:T=`${S}(${m})`}else te.isPostgresFamily(this.connection.driver)&&this.connection.driver.spatialTypes.indexOf(f.type)!==-1?f.srid!=null?T=`ST_SetSRID(ST_GeomFromGeoJSON(${m}), ${f.srid})::${f.type}`:T=`ST_GeomFromGeoJSON(${m})::${f.type}`:this.connection.driver.options.type==="mssql"&&this.connection.driver.spatialTypes.indexOf(f.type)!==-1?T=f.type+"::STGeomFromText("+m+", "+(f.srid||"0")+")":T=m;i.push(this.escape(f.databaseName)+" = "+T)}})}),(i.length>0||Object.keys(n).length===0)&&(t.versionColumn&&r.indexOf(t.versionColumn)===-1&&i.push(this.escape(t.versionColumn.databaseName)+" = "+this.escape(t.versionColumn.databaseName)+" + 1"),t.updateDateColumn&&r.indexOf(t.updateDateColumn)===-1&&i.push(this.escape(t.updateDateColumn.databaseName)+" = CURRENT_TIMESTAMP"))):Object.keys(n).map(l=>{const h=n[l];if(typeof h=="function")i.push(this.escape(l)+" = "+h());else if((this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner")&&h===null)i.push(this.escape(l)+" = NULL");else{const f=this.createParameter(h);i.push(this.escape(l)+" = "+f)}}),i.length<=0)throw new fu;const a=this.createWhereExpression(),c=this.createReturningExpression("update");return c===""?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${i.join(", ")}${a}`:this.connection.driver.options.type==="mssql"?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${i.join(", ")} OUTPUT ${c}${a}`:this.connection.driver.options.type==="spanner"?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${i.join(", ")}${a} THEN RETURN ${c}`:`UPDATE ${this.getTableName(this.getMainTableName())} SET ${i.join(", ")}${a} RETURNING ${c}`}createOrderByExpression(){const e=this.expressionMap.orderBys;return Object.keys(e).length>0?" ORDER BY "+Object.keys(e).map(t=>typeof e[t]=="string"?this.replacePropertyNames(t)+" "+e[t]:this.replacePropertyNames(t)+" "+e[t].order+" "+e[t].nulls).join(", "):""}createLimitExpression(){const e=this.expressionMap.limit;if(e){if(te.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")return" LIMIT "+e;throw new mp}return""}getValueSet(){if(typeof this.expressionMap.valuesSet=="object")return this.expressionMap.valuesSet;throw new fu}}function qp(){bt.registerQueryBuilderClass("DeleteQueryBuilder",s=>new t0(s)),bt.registerQueryBuilderClass("InsertQueryBuilder",s=>new a0(s)),bt.registerQueryBuilderClass("RelationQueryBuilder",s=>new c0(s)),bt.registerQueryBuilderClass("SelectQueryBuilder",s=>new ps(s)),bt.registerQueryBuilderClass("SoftDeleteQueryBuilder",s=>new p0(s)),bt.registerQueryBuilderClass("UpdateQueryBuilder",s=>new m0(s))}class Ui{static sha1(e){const t=function(re,Ee){return re<<Ee|re>>>32-Ee},n=function(re){let Ee="",Se,me;for(Se=7;Se>=0;Se--)me=re>>>Se*4&15,Ee+=me.toString(16);return Ee};let i,r,a;const c=new Array(80);let l=1732584193,h=4023233417,f=2562383102,p=271733878,m=3285377520,T,A,S,P,F,B;e=encodeURIComponent(e);const q=e.length,Z=[];for(r=0;r<q-3;r+=4)a=e.charCodeAt(r)<<24|e.charCodeAt(r+1)<<16|e.charCodeAt(r+2)<<8|e.charCodeAt(r+3),Z.push(a);switch(q%4){case 0:r=2147483648;break;case 1:r=e.charCodeAt(q-1)<<24|8388608;break;case 2:r=e.charCodeAt(q-2)<<24|e.charCodeAt(q-1)<<16|32768;break;case 3:r=e.charCodeAt(q-3)<<24|e.charCodeAt(q-2)<<16|e.charCodeAt(q-1)<<8|128;break}for(Z.push(r);Z.length%16!==14;)Z.push(0);for(Z.push(q>>>29),Z.push(q<<3&4294967295),i=0;i<Z.length;i+=16){for(r=0;r<16;r++)c[r]=Z[i+r];for(r=16;r<=79;r++)c[r]=t(c[r-3]^c[r-8]^c[r-14]^c[r-16],1);for(T=l,A=h,S=f,P=p,F=m,r=0;r<=19;r++)B=t(T,5)+(A&S|~A&P)+F+c[r]+1518500249&4294967295,F=P,P=S,S=t(A,30),A=T,T=B;for(r=20;r<=39;r++)B=t(T,5)+(A^S^P)+F+c[r]+1859775393&4294967295,F=P,P=S,S=t(A,30),A=T,T=B;for(r=40;r<=59;r++)B=t(T,5)+(A&S|A&P|S&P)+F+c[r]+2400959708&4294967295,F=P,P=S,S=t(A,30),A=T,T=B;for(r=60;r<=79;r++)B=t(T,5)+(A^S^P)+F+c[r]+3395469782&4294967295,F=P,P=S,S=t(A,30),A=T,T=B;l=l+T&4294967295,h=h+A&4294967295,f=f+S&4294967295,p=p+P&4294967295,m=m+F&4294967295}return B=n(l)+n(h)+n(f)+n(p)+n(m),B.toLowerCase()}}class y0{constructor(){this.nestedSetColumnNames={left:"nsleft",right:"nsright"},this.materializedPathColumnName="mpath"}getTableName(e){return typeof e!="string"&&(e=e.name),e.split(".").pop()}tableName(e,t){return t||pf(e)}closureJunctionTableName(e){return e+"_closure"}columnName(e,t,n){const i=t||e;return n.length?Hc(n.join("_"))+GR(i):i}relationName(e){return e}primaryKeyName(e,t){const n=[...t];n.sort();const a=`${this.getTableName(e).replace(".","_")}_${n.join("_")}`;return"PK_"+Ui.sha1(a).substr(0,27)}uniqueConstraintName(e,t){const n=[...t];n.sort();const a=`${this.getTableName(e).replace(".","_")}_${n.join("_")}`;return"UQ_"+Ui.sha1(a).substr(0,27)}relationConstraintName(e,t,n){const i=[...t];i.sort();let c=`${this.getTableName(e).replace(".","_")}_${i.join("_")}`;return n&&(c+=`_${n}`),"REL_"+Ui.sha1(c).substr(0,26)}defaultConstraintName(e,t){const r=`${this.getTableName(e).replace(".","_")}_${t}`;return"DF_"+Ui.sha1(r).substr(0,27)}foreignKeyName(e,t,n,i){const r=[...t];r.sort();const l=`${this.getTableName(e).replace(".","_")}_${r.join("_")}`;return"FK_"+Ui.sha1(l).substr(0,27)}indexName(e,t,n){const i=[...t];i.sort();let c=`${this.getTableName(e).replace(".","_")}_${i.join("_")}`;return n&&(c+=`_${n}`),"IDX_"+Ui.sha1(c).substr(0,26)}checkConstraintName(e,t,n){const a=`${this.getTableName(e).replace(".","_")}_${t}`,c="CHK_"+Ui.sha1(a).substr(0,26);return n?`${c}_ENUM`:c}exclusionConstraintName(e,t){const r=`${this.getTableName(e).replace(".","_")}_${t}`;return"XCL_"+Ui.sha1(r).substr(0,26)}joinColumnName(e,t){return Hc(e+"_"+t)}joinTableName(e,t,n,i){return pf(e+"_"+n.replace(/\./gi,"_")+"_"+t)}joinTableColumnDuplicationPrefix(e,t){return e+"_"+t}joinTableColumnName(e,t,n){return Hc(e+"_"+(n||t))}joinTableInverseColumnName(e,t,n){return this.joinTableColumnName(e,t,n)}prefixTableName(e,t){return e+t}}class nn{constructor(e){this["@instanceof"]=Symbol.for("TableColumn"),this.isNullable=!1,this.isGenerated=!1,this.isPrimary=!1,this.isUnique=!1,this.isArray=!1,this.length="",this.zerofill=!1,this.unsigned=!1,e&&(this.name=e.name,this.type=e.type||"",this.length=e.length||"",this.width=e.width,this.charset=e.charset,this.collation=e.collation,this.precision=e.precision,this.scale=e.scale,this.zerofill=e.zerofill||!1,this.unsigned=this.zerofill?!0:e.unsigned||!1,this.default=e.default,this.onUpdate=e.onUpdate,this.isNullable=e.isNullable||!1,this.isGenerated=e.isGenerated||!1,this.generationStrategy=e.generationStrategy,this.generatedIdentity=e.generatedIdentity,this.isPrimary=e.isPrimary||!1,this.isUnique=e.isUnique||!1,this.isArray=e.isArray||!1,this.comment=e.comment,this.enum=e.enum,this.enumName=e.enumName,this.primaryKeyConstraintName=e.primaryKeyConstraintName,this.asExpression=e.asExpression,this.generatedType=e.generatedType,this.spatialFeatureType=e.spatialFeatureType,this.srid=e.srid)}clone(){return new nn({name:this.name,type:this.type,length:this.length,width:this.width,charset:this.charset,collation:this.collation,precision:this.precision,scale:this.scale,zerofill:this.zerofill,unsigned:this.unsigned,enum:this.enum,enumName:this.enumName,primaryKeyConstraintName:this.primaryKeyConstraintName,asExpression:this.asExpression,generatedType:this.generatedType,default:this.default,onUpdate:this.onUpdate,isNullable:this.isNullable,isGenerated:this.isGenerated,generationStrategy:this.generationStrategy,generatedIdentity:this.generatedIdentity,isPrimary:this.isPrimary,isUnique:this.isUnique,isArray:this.isArray,comment:this.comment,spatialFeatureType:this.spatialFeatureType,srid:this.srid})}}class Nt{constructor(e){this["@instanceof"]=Symbol.for("TableIndex"),this.columnNames=[],this.name=e.name,this.columnNames=e.columnNames,this.isUnique=!!e.isUnique,this.isSpatial=!!e.isSpatial,this.isConcurrent=!!e.isConcurrent,this.isFulltext=!!e.isFulltext,this.isNullFiltered=!!e.isNullFiltered,this.parser=e.parser,this.where=e.where?e.where:""}clone(){return new Nt({name:this.name,columnNames:[...this.columnNames],isUnique:this.isUnique,isSpatial:this.isSpatial,isConcurrent:this.isConcurrent,isFulltext:this.isFulltext,isNullFiltered:this.isNullFiltered,parser:this.parser,where:this.where})}static create(e){return new Nt({name:e.name,columnNames:e.columns.map(t=>t.databaseName),isUnique:e.isUnique,isSpatial:e.isSpatial,isConcurrent:e.isConcurrent,isFulltext:e.isFulltext,isNullFiltered:e.isNullFiltered,parser:e.parser,where:e.where})}}class Cn{constructor(e){this["@instanceof"]=Symbol.for("TableForeignKey"),this.columnNames=[],this.referencedColumnNames=[],this.name=e.name,this.columnNames=e.columnNames,this.referencedColumnNames=e.referencedColumnNames,this.referencedDatabase=e.referencedDatabase,this.referencedSchema=e.referencedSchema,this.referencedTableName=e.referencedTableName,this.onDelete=e.onDelete,this.onUpdate=e.onUpdate,this.deferrable=e.deferrable}clone(){return new Cn({name:this.name,columnNames:[...this.columnNames],referencedColumnNames:[...this.referencedColumnNames],referencedDatabase:this.referencedDatabase,referencedSchema:this.referencedSchema,referencedTableName:this.referencedTableName,onDelete:this.onDelete,onUpdate:this.onUpdate,deferrable:this.deferrable})}static create(e,t){return new Cn({name:e.name,columnNames:e.columnNames,referencedColumnNames:e.referencedColumnNames,referencedDatabase:e.referencedEntityMetadata.database,referencedSchema:e.referencedEntityMetadata.schema,referencedTableName:e.referencedTablePath,onDelete:e.onDelete,onUpdate:e.onUpdate,deferrable:e.deferrable})}}class Oa{static createTableColumnOptions(e,t){return{name:e.databaseName,length:t.getColumnLength(e),width:e.width,charset:e.charset,collation:e.collation,precision:e.precision,scale:e.scale,zerofill:e.zerofill,unsigned:e.unsigned,asExpression:e.asExpression,generatedType:e.generatedType,default:t.normalizeDefault(e),onUpdate:e.onUpdate,comment:e.comment,isGenerated:e.isGenerated,generationStrategy:e.generationStrategy,generatedIdentity:e.generatedIdentity,isNullable:e.isNullable,type:t.normalizeType(e),isPrimary:e.isPrimary,isUnique:t.normalizeIsUnique(e),isArray:e.isArray||!1,enum:e.enum?e.enum.map(n=>n+""):e.enum,enumName:e.enumName,primaryKeyConstraintName:e.primaryKeyConstraintName,spatialFeatureType:e.spatialFeatureType,srid:e.srid}}}class jt{constructor(e){this["@instanceof"]=Symbol.for("TableUnique"),this.columnNames=[],this.name=e.name,this.columnNames=e.columnNames,this.deferrable=e.deferrable}clone(){return new jt({name:this.name,columnNames:[...this.columnNames],deferrable:this.deferrable})}static create(e){return new jt({name:e.name,columnNames:e.columns.map(t=>t.databaseName),deferrable:e.deferrable})}}class kn{constructor(e){this["@instanceof"]=Symbol.for("TableCheck"),this.columnNames=[],this.name=e.name,this.columnNames=e.columnNames,this.expression=e.expression}clone(){return new kn({name:this.name,columnNames:this.columnNames?[...this.columnNames]:[],expression:this.expression})}static create(e){return new kn({name:e.name,expression:e.expression})}}class or{constructor(e){this["@instanceof"]=Symbol.for("TableExclusion"),this.name=e.name,this.expression=e.expression}clone(){return new or({name:this.name,expression:this.expression})}static create(e){return new or({name:e.name,expression:e.expression})}}class pt{constructor(e){this["@instanceof"]=Symbol.for("Table"),this.columns=[],this.indices=[],this.foreignKeys=[],this.uniques=[],this.checks=[],this.exclusions=[],this.justCreated=!1,this.withoutRowid=!1,e&&(this.database=e.database,this.schema=e.schema,this.name=e.name,e.columns&&(this.columns=e.columns.map(t=>new nn(t))),e.indices&&(this.indices=e.indices.map(t=>new Nt(t))),e.foreignKeys&&(this.foreignKeys=e.foreignKeys.map(t=>new Cn({...t,referencedDatabase:(t==null?void 0:t.referencedDatabase)||e.database,referencedSchema:(t==null?void 0:t.referencedSchema)||e.schema}))),e.uniques&&(this.uniques=e.uniques.map(t=>new jt(t))),e.checks&&(this.checks=e.checks.map(t=>new kn(t))),e.exclusions&&(this.exclusions=e.exclusions.map(t=>new or(t))),e.justCreated!==void 0&&(this.justCreated=e.justCreated),e.withoutRowid&&(this.withoutRowid=e.withoutRowid),this.engine=e.engine,this.comment=e.comment)}get primaryColumns(){return this.columns.filter(e=>e.isPrimary)}clone(){return new pt({schema:this.schema,database:this.database,name:this.name,columns:this.columns.map(e=>e.clone()),indices:this.indices.map(e=>e.clone()),foreignKeys:this.foreignKeys.map(e=>e.clone()),uniques:this.uniques.map(e=>e.clone()),checks:this.checks.map(e=>e.clone()),exclusions:this.exclusions.map(e=>e.clone()),justCreated:this.justCreated,withoutRowid:this.withoutRowid,engine:this.engine,comment:this.comment})}addColumn(e){this.columns.push(e)}removeColumn(e){const t=this.columns.find(n=>n.name===e.name);t&&this.columns.splice(this.columns.indexOf(t),1)}addUniqueConstraint(e){if(this.uniques.push(e),e.columnNames.length===1){const t=this.columns.find(n=>n.name===e.columnNames[0]);t&&(t.isUnique=!0)}}removeUniqueConstraint(e){const t=this.uniques.find(n=>n.name===e.name);if(t&&(this.uniques.splice(this.uniques.indexOf(t),1),t.columnNames.length===1)){const n=this.columns.find(i=>i.name===t.columnNames[0]);n&&(n.isUnique=!1)}}addCheckConstraint(e){this.checks.push(e)}removeCheckConstraint(e){const t=this.checks.find(n=>n.name===e.name);t&&this.checks.splice(this.checks.indexOf(t),1)}addExclusionConstraint(e){this.exclusions.push(e)}removeExclusionConstraint(e){const t=this.exclusions.find(n=>n.name===e.name);t&&this.exclusions.splice(this.exclusions.indexOf(t),1)}addForeignKey(e){this.foreignKeys.push(e)}removeForeignKey(e){const t=this.foreignKeys.find(n=>n.name===e.name);t&&this.foreignKeys.splice(this.foreignKeys.indexOf(t),1)}addIndex(e,t=!1){if(this.indices.push(e),e.columnNames.length===1&&e.isUnique&&t){const n=this.columns.find(i=>i.name===e.columnNames[0]);n&&(n.isUnique=!0)}}removeIndex(e,t=!1){const n=this.indices.find(i=>i.name===e.name);if(n&&(this.indices.splice(this.indices.indexOf(n),1),n.columnNames.length===1&&n.isUnique&&t)){const i=this.columns.find(r=>r.name===n.columnNames[0]);i&&(i.isUnique=this.indices.some(r=>r.columnNames.length===1&&r.columnNames[0]===i.name&&!!n.isUnique))}}findColumnByName(e){return this.columns.find(t=>t.name===e)}findColumnIndices(e){return this.indices.filter(t=>!!t.columnNames.find(n=>n===e.name))}findColumnForeignKeys(e){return this.foreignKeys.filter(t=>!!t.columnNames.find(n=>n===e.name))}findColumnUniques(e){return this.uniques.filter(t=>!!t.columnNames.find(n=>n===e.name))}findColumnChecks(e){return this.checks.filter(t=>!!t.columnNames.find(n=>n===e.name))}static create(e,t){const n=e.database===t.database?void 0:e.database,i=e.schema===t.options.schema?void 0:e.schema,r={database:e.database,schema:e.schema,name:t.buildTableName(e.tableName,i,n),withoutRowid:e.withoutRowid,engine:e.engine,columns:e.columns.filter(a=>a&&!a.isVirtualProperty).map(a=>Oa.createTableColumnOptions(a,t)),indices:e.indices.filter(a=>a.synchronize===!0).map(a=>Nt.create(a)),uniques:e.uniques.map(a=>jt.create(a)),checks:e.checks.map(a=>kn.create(a)),exclusions:e.exclusions.map(a=>or.create(a)),comment:e.comment};return new pt(r)}}class Tf{constructor(e,t,n,i,r){this.id=e,this.timestamp=t,this.name=n,this.instance=i,this.transaction=r}}class Ln{constructor(e,t,...n){this.value=e,this.type=t,this["@instanceof"]=Symbol.for("MssqlParameter"),this.params=[],this.params=n||[]}}class Gc{constructor(e,t){this.connection=e,this.queryRunner=t,this.transaction="all";const{schema:n}=this.connection.driver.options,i=this.connection.driver.database;this.migrationsDatabase=i,this.migrationsSchema=n,this.migrationsTableName=e.options.migrationsTableName||"migrations",this.migrationsTable=this.connection.driver.buildTableName(this.migrationsTableName,n,i)}async executeMigration(e){return this.withQueryRunner(async t=>{await this.createMigrationsTableIfNotExist(t);const n=this.connection.driver.createSchemaBuilder();return $.isRdbmsSchemaBuilder(n)&&await n.createMetadataTableIfNecessary(t),await t.beforeMigration(),await e.instance.up(t),await t.afterMigration(),await this.insertExecutedMigration(t,e),e})}async getAllMigrations(){return Promise.resolve(this.getMigrations())}async getExecutedMigrations(){return this.withQueryRunner(async e=>(await this.createMigrationsTableIfNotExist(e),await this.loadExecutedMigrations(e)))}async getPendingMigrations(){const e=await this.getAllMigrations(),t=await this.getExecutedMigrations();return e.filter(n=>!t.find(i=>i.name===n.name))}insertMigration(e){return this.withQueryRunner(t=>this.insertExecutedMigration(t,e))}deleteMigration(e){return this.withQueryRunner(t=>this.deleteExecutedMigration(t,e))}async showMigrations(){let e=!1;const t=this.queryRunner||this.connection.createQueryRunner();await this.createMigrationsTableIfNotExist(t);const n=await this.loadExecutedMigrations(t),i=this.getMigrations();for(const r of i){const a=n.find(c=>c.name===r.name);a?this.connection.logger.logSchemaBuild(`[X] ${a.id} ${r.name}`):(e=!0,this.connection.logger.logSchemaBuild(`[ ] ${r.name}`))}return this.queryRunner||await t.release(),e}async executePendingMigrations(){const e=this.queryRunner||this.connection.createQueryRunner();await this.createMigrationsTableIfNotExist(e);const t=this.connection.driver.createSchemaBuilder();$.isRdbmsSchemaBuilder(t)&&await t.createMetadataTableIfNecessary(e);const n=await this.loadExecutedMigrations(e),i=this.getLatestTimestampMigration(n),r=this.getMigrations(),a=[],c=r.filter(f=>!n.find(m=>m.name===f.name));if(!c.length)return this.connection.logger.logSchemaBuild("No migrations are pending"),this.queryRunner||await e.release(),[];if(this.connection.logger.logSchemaBuild(`${n.length} migrations are already loaded in the database.`),this.connection.logger.logSchemaBuild(`${r.length} migrations were found in the source code.`),i&&this.connection.logger.logSchemaBuild(`${i.name} is the last executed migration. It was executed on ${new Date(i.timestamp).toString()}.`),this.connection.logger.logSchemaBuild(`${c.length} migrations are new migrations must be executed.`),this.transaction==="all"){const f=c.filter(p=>{var m;return((m=p.instance)==null?void 0:m.transaction)!==void 0});if(f.length>0){const p=new XC(f);throw this.connection.logger.logMigration(`Migrations failed, error: ${p.message}`),p}}const l={each:!0,none:!1,all:!1}[this.transaction];for(const f of c)if(f.instance){const p=f.instance.transaction;p===void 0?f.transaction=l:f.transaction=p}let h=!1;this.transaction==="all"&&!e.isTransactionActive&&(await e.beforeMigration(),await e.startTransaction(),h=!0);try{for(const f of c){if(this.fake){await this.insertExecutedMigration(e,f);continue}f.transaction&&!e.isTransactionActive&&(await e.beforeMigration(),await e.startTransaction(),h=!0),await f.instance.up(e).catch(p=>{throw this.connection.logger.logMigration(`Migration "${f.name}" failed, error: ${p==null?void 0:p.message}`),p}).then(async()=>{await this.insertExecutedMigration(e,f),f.transaction&&h&&(await e.commitTransaction(),await e.afterMigration())}).then(()=>{a.push(f),this.connection.logger.logSchemaBuild(`Migration ${f.name} has been ${this.fake?"(fake) ":""}executed successfully.`)})}this.transaction==="all"&&h&&(await e.commitTransaction(),await e.afterMigration())}catch(f){if(h)try{await e.rollbackTransaction()}catch{}throw f}finally{this.queryRunner||await e.release()}return a}async undoLastMigration(){const e=this.queryRunner||this.connection.createQueryRunner();await this.createMigrationsTableIfNotExist(e);const t=this.connection.driver.createSchemaBuilder();$.isRdbmsSchemaBuilder(t)&&await t.createMetadataTableIfNecessary(e);const n=await this.loadExecutedMigrations(e),i=this.getLatestExecutedMigration(n);if(!i){this.connection.logger.logSchemaBuild("No migrations were found in the database. Nothing to revert!");return}const a=this.getMigrations().find(l=>l.name===i.name);if(!a)throw new _(`No migration ${i.name} was found in the source code. Make sure you have this migration in your codebase and its included in the connection options.`);this.connection.logger.logSchemaBuild(`${n.length} migrations are already loaded in the database.`),this.connection.logger.logSchemaBuild(`${i.name} is the last executed migration. It was executed on ${new Date(i.timestamp).toString()}.`),this.connection.logger.logSchemaBuild("Now reverting it...");let c=!1;this.transaction!=="none"&&!e.isTransactionActive&&(await e.startTransaction(),c=!0);try{this.fake||(await e.beforeMigration(),await a.instance.down(e),await e.afterMigration()),await this.deleteExecutedMigration(e,a),this.connection.logger.logSchemaBuild(`Migration ${a.name} has been ${this.fake?"(fake) ":""}reverted successfully.`),c&&await e.commitTransaction()}catch(l){if(c)try{await e.rollbackTransaction()}catch{}throw l}finally{this.queryRunner||await e.release()}}async createMigrationsTableIfNotExist(e){if(this.connection.driver.options.type==="mongodb")return;await e.hasTable(this.migrationsTable)||await e.createTable(new pt({database:this.migrationsDatabase,schema:this.migrationsSchema,name:this.migrationsTable,columns:[{name:"id",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.migrationId}),isGenerated:!0,generationStrategy:"increment",isPrimary:!0,isNullable:!1},{name:"timestamp",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.migrationTimestamp}),isPrimary:!1,isNullable:!1},{name:"name",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.migrationName}),isNullable:!1}]}))}async loadExecutedMigrations(e){return this.connection.driver.options.type==="mongodb"?e.cursor(this.migrationsTableName,{}).sort({_id:-1}).toArray():(await this.connection.manager.createQueryBuilder(e).select().orderBy(this.connection.driver.escape("id"),"DESC").from(this.migrationsTable,this.migrationsTableName).getRawMany()).map(n=>new Tf(parseInt(n.id),parseInt(n.timestamp),n.name))}getMigrations(){const e=this.connection.migrations.map(t=>{const n=t.name||t.constructor.name,i=parseInt(n.substr(-13),10);if(!i||isNaN(i))throw new _(`${n} migration name is wrong. Migration class name should have a JavaScript timestamp appended.`);return new Tf(void 0,i,n,t)});return this.checkForDuplicateMigrations(e),e.sort((t,n)=>t.timestamp-n.timestamp)}checkForDuplicateMigrations(e){const t=e.map(i=>i.name),n=Array.from(new Set(t.filter((i,r)=>t.indexOf(i)<r)));if(n.length>0)throw Error(`Duplicate migrations: ${n.join(", ")}`)}getLatestTimestampMigration(e){const t=e.map(n=>n).sort((n,i)=>(n.timestamp-i.timestamp)*-1);return t.length>0?t[0]:void 0}getLatestExecutedMigration(e){return e.length>0?e[0]:void 0}async insertExecutedMigration(e,t){const n={};this.connection.driver.options.type==="mssql"?(n.timestamp=new Ln(t.timestamp,this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.migrationTimestamp})),n.name=new Ln(t.name,this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.migrationName}))):(n.timestamp=t.timestamp,n.name=t.name),this.connection.driver.options.type==="mongodb"?await e.databaseConnection.db(this.connection.driver.database).collection(this.migrationsTableName).insertOne(n):await e.manager.createQueryBuilder().insert().into(this.migrationsTable).values(n).execute()}async deleteExecutedMigration(e,t){const n={};if(this.connection.driver.options.type==="mssql"?(n.timestamp=new Ln(t.timestamp,this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.migrationTimestamp})),n.name=new Ln(t.name,this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.migrationName}))):(n.timestamp=t.timestamp,n.name=t.name),this.connection.driver.options.type==="mongodb")await e.databaseConnection.db(this.connection.driver.database).collection(this.migrationsTableName).deleteOne(n);else{const i=e.manager.createQueryBuilder();await i.delete().from(this.migrationsTable).where(`${i.escape("timestamp")} = :timestamp`).andWhere(`${i.escape("name")} = :name`).setParameters(n).execute()}}async withQueryRunner(e){const t=this.queryRunner||this.connection.createQueryRunner();try{return await e(t)}finally{this.queryRunner||await t.release()}}}function wa(s,e,t){const n=[],i={};return function r(a){i[a]=!0,n.push(a),s[a].forEach(function(c){if(!i[c])r(c);else if(n.indexOf(c)>=0)throw n.push(c),new _(`Dependency Cycle Found: ${n.join(" -> ")}`)}),n.pop(),(!e||s[a].length===0)&&t.indexOf(a)===-1&&t.push(a)}}class g0{constructor(){this.nodes={},this.outgoingEdges={},this.incomingEdges={}}addNode(e,t){this.hasNode(e)||(arguments.length===2?this.nodes[e]=t:this.nodes[e]=e,this.outgoingEdges[e]=[],this.incomingEdges[e]=[])}removeNode(e){this.hasNode(e)&&(delete this.nodes[e],delete this.outgoingEdges[e],delete this.incomingEdges[e],[this.incomingEdges,this.outgoingEdges].forEach(function(t){Object.keys(t).forEach(function(n){const i=t[n].indexOf(e);i>=0&&t[n].splice(i,1)})}))}hasNode(e){return this.nodes.hasOwnProperty(e)}getNodeData(e){if(this.hasNode(e))return this.nodes[e];throw new _(`Node does not exist: ${e}`)}setNodeData(e,t){if(this.hasNode(e))this.nodes[e]=t;else throw new _(`Node does not exist: ${e}`)}addDependency(e,t){if(!this.hasNode(e))throw new _(`Node does not exist: ${e}`);if(!this.hasNode(t))throw new _(`Node does not exist: ${t}`);return this.outgoingEdges[e].indexOf(t)===-1&&this.outgoingEdges[e].push(t),this.incomingEdges[t].indexOf(e)===-1&&this.incomingEdges[t].push(e),!0}removeDependency(e,t){let n;this.hasNode(e)&&(n=this.outgoingEdges[e].indexOf(t),n>=0&&this.outgoingEdges[e].splice(n,1)),this.hasNode(t)&&(n=this.incomingEdges[t].indexOf(e),n>=0&&this.incomingEdges[t].splice(n,1))}dependenciesOf(e,t){if(this.hasNode(e)){const n=[];wa(this.outgoingEdges,t,n)(e);const r=n.indexOf(e);return r>=0&&n.splice(r,1),n}else throw new _(`Node does not exist: ${e}`)}dependantsOf(e,t){if(this.hasNode(e)){const n=[];wa(this.incomingEdges,t,n)(e);const r=n.indexOf(e);return r>=0&&n.splice(r,1),n}else throw new _(`Node does not exist: ${e}`)}overallOrder(e){const t=this,n=[],i=Object.keys(this.nodes);if(i.length===0)return n;{const r=wa(this.outgoingEdges,!1,[]);i.forEach(function(c){r(c)});const a=wa(this.outgoingEdges,e,n);return i.filter(function(c){return t.incomingEdges[c].length===0}).forEach(function(c){a(c)}),n}}}class E0{validateMany(e,t){e.forEach(n=>this.validate(n,e,t)),this.validateDependencies(e),this.validateEagerRelations(e)}validate(e,t,n){if(!e.primaryColumns.length&&!e.isJunction)throw new BC(e);if(e.primaryColumns.length>1&&!e.primaryColumns.every((a,c,l)=>a.primaryKeyConstraintName===l[0].primaryKeyConstraintName))throw new _(`Entity ${e.name} has multiple primary columns with different constraint names. Constraint names should be the equal.`);if(e.inheritancePattern==="STI"||e.tableType==="entity-child"){if(!e.discriminatorColumn)throw new _(`Entity ${e.name} using single-table inheritance, it should also have a discriminator column. Did you forget to put discriminator column options?`);if(typeof e.discriminatorValue>"u")throw new _(`Entity ${e.name} has an undefined discriminator value. Discriminator value should be defined.`);const r=t.find(a=>a!==e&&(a.inheritancePattern==="STI"||a.tableType==="entity-child")&&a.tableName===e.tableName&&a.discriminatorValue===e.discriminatorValue&&a.inheritanceTree.some(c=>e.inheritanceTree.indexOf(c)!==-1));if(r)throw new _(`Entities ${e.name} and ${r.name} have the same discriminator values. Make sure they are different while using the @ChildEntity decorator.`)}if(e.relationCounts.forEach(r=>{if(r.relation.isManyToOne||r.relation.isOneToOne)throw new _("Relation count can not be implemented on ManyToOne or OneToOne relations.")}),n.options.type!=="mongodb"&&e.columns.filter(r=>!r.isVirtualProperty).forEach(r=>{const a=n.normalizeType(r);if(!n.supportedDataTypes.includes(a))throw new HC(r,a,n.options.type);if(r.length&&!n.withLengthColumnTypes.includes(a))throw new _(`Column ${r.propertyName} of Entity ${e.name} does not support length property.`);if(r.type==="enum"&&!r.enum&&!r.enumName)throw new _(`Column "${r.propertyName}" of Entity "${e.name}" is defined as enum, but missing "enum" or "enumName" properties.`)}),(te.isMySQLFamily(n)||n.options.type==="aurora-mysql")&&e.columns.filter(a=>a.isGenerated&&a.generationStrategy!=="uuid").length>1)throw new _(`Error in ${e.name} entity. There can be only one auto-increment column in MySql table.`);if(te.isMySQLFamily(n)&&t.filter(a=>a.database).length===0&&!n.database)throw new JC("database");if(n.options.type==="mssql"&&e.columns.filter(a=>a.charset).length>1)throw new _("Character set specifying is not supported in Sql Server");if(n.options.type==="postgres"){const r=e.columns.find(a=>a.asExpression&&(!a.generatedType||a.generatedType==="VIRTUAL"));if(r)throw new _(`Column "${r.propertyName}" of Entity "${e.name}" is defined as VIRTUAL, but Postgres supports only STORED generated columns.`)}const i=e.create(void 0,{fromDeserializer:!0});e.relations.forEach(r=>{if(r.isManyToMany||r.isOneToMany){if(r.persistenceEnabled===!1)return;const a=r.getEntityValue(i);if(Array.isArray(a))throw new YC(r)}}),e.relations.forEach(r=>{if(n.supportedOnDeleteTypes&&r.onDelete&&!n.supportedOnDeleteTypes.includes(r.onDelete))throw new _(`OnDeleteType "${r.onDelete}" is not supported for ${n.options.type}!`);if(n.supportedOnUpdateTypes&&r.onUpdate&&!n.supportedOnUpdateTypes.includes(r.onUpdate))throw new _(`OnUpdateType "${r.onUpdate}" is not valid for ${n.options.type}!`)}),e.relations.forEach(r=>{if(r.isCascadeRemove&&r.inverseRelation&&r.inverseRelation.isCascadeRemove)throw new _(`Relation ${e.name}#${r.propertyName} and ${r.inverseRelation.entityMetadata.name}#${r.inverseRelation.propertyName} both has cascade remove set. This may lead to unexpected circular removals. Please set cascade remove only from one side of relationship.`)})}validateDependencies(e){const t=new g0;e.forEach(n=>{t.addNode(n.name)}),e.forEach(n=>{n.relationsWithJoinColumns.filter(i=>!i.isNullable).forEach(i=>{t.addDependency(n.name,i.inverseEntityMetadata.name)})});try{t.overallOrder()}catch(n){throw new qC(n.toString().replace("Error: Dependency Cycle Found: ",""))}}validateEagerRelations(e){e.forEach(t=>{t.eagerRelations.forEach(n=>{if(n.inverseRelation&&n.inverseRelation.isEager)throw new _(`Circular eager relations are disallowed. ${t.targetName}#${n.propertyPath} contains "eager: true", and its inverse side ${n.inverseEntityMetadata.targetName}#${n.inverseRelation.propertyPath} contains "eager: true" as well. Remove "eager: true" from one side of the relation.`)})})}}class T0{}class DO{}class w0{}class b0{}class Bp{}let IO=class{};class N0{}let LO=class{};class A0{}class C0{}class wf{}class S0{}class R0{}class x0{}class rr{static createRelationMaps(e,t,n,i){return i.map(r=>{const a=t.treeParentRelation.joinColumns[0],c=a.referencedColumn??t.primaryColumns[0],l=a.givenDatabaseName||a.databaseName,h=c.givenDatabaseName||c.databaseName,f=r[n+"_"+h],p=r[n+"_"+l];return{id:e.connection.driver.prepareHydratedValue(f,c),parentId:e.connection.driver.prepareHydratedValue(p,a)}})}static buildChildrenEntityTree(e,t,n,i,r){const a=e.treeChildrenRelation.propertyName;if(r.depth===0){t[a]=[];return}const l=e.treeParentRelation.joinColumns[0].referencedColumn??e.primaryColumns[0],h=l.getEntityValue(t),f=i.filter(m=>m.parentId===h),p=new Set(f.map(m=>m.id));t[a]=n.filter(m=>p.has(l.getEntityValue(m))),t[a].forEach(m=>{rr.buildChildrenEntityTree(e,m,n,i,{...r,depth:r.depth-1})})}static buildParentEntityTree(e,t,n,i){const r=e.treeParentRelation.propertyName,c=e.treeParentRelation.joinColumns[0].referencedColumn??e.primaryColumns[0],l=c.getEntityValue(t),h=i.find(p=>p.id===l),f=n.find(p=>h?c.getEntityValue(p)===h.parentId:!1);f&&(t[r]=f,rr.buildParentEntityTree(e,t[r],n,i))}}function bf(s,e){var t=Object.keys(s);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(s);e&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(s,i).enumerable})),t.push.apply(t,n)}return t}function Nf(s){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?bf(Object(t),!0).forEach(function(n){_0(s,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(t)):bf(Object(t)).forEach(function(n){Object.defineProperty(s,n,Object.getOwnPropertyDescriptor(t,n))})}return s}function _0(s,e,t){return e=v0(e),e in s?Object.defineProperty(s,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):s[e]=t,s}function v0(s){var e=M0(s,"string");return typeof e=="symbol"?e:String(e)}function M0(s,e){if(typeof s!="object"||s===null)return s;var t=s[Symbol.toPrimitive];if(t!==void 0){var n=t.call(s,e);if(typeof n!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(s)}const P0=Fp({});function Fp(s){return e.withOptions=t=>Fp(Nf(Nf({},s),t)),e;function e(t,...n){const i=typeof t=="string"?[t]:t.raw,{alignValues:r=!1,escapeSpecialCharacters:a=Array.isArray(t),trimWhitespace:c=!0}=s;let l="";for(let p=0;p<i.length;p++){let m=i[p];if(a&&(m=m.replace(/\\\n[ \t]*/g,"").replace(/\\`/g,"`").replace(/\\\$/g,"$").replace(/\\\{/g,"{")),l+=m,p<n.length){const T=r?O0(n[p],l):n[p];l+=T}}const h=l.split(`
`);let f=null;for(const p of h){const m=p.match(/^(\s+)\S+/);if(m){const T=m[1].length;f?f=Math.min(f,T):f=T}}if(f!==null){const p=f;l=h.map(m=>m[0]===" "||m[0]==="	"?m.slice(p):m).join(`
`)}return c&&(l=l.trim()),a&&(l=l.replace(/\\n/g,`
`)),l}}function O0(s,e){if(typeof s!="string"||!s.includes(`
`))return s;const n=e.slice(e.lastIndexOf(`
`)+1).match(/^(\s+)/);if(n){const i=n[1];return s.replace(/\n/g,`
${i}`)}return s}function oo({driver:s,strings:e,expressions:t}){let n="";const i=[];let r=0;for(const[a,c]of t.entries()){if(n+=e[a],c===null){n+="NULL";continue}if(typeof c=="function"){const l=c();if(typeof l=="string"){n+=l;continue}if(Array.isArray(l)){if(l.length===0)throw new Error(`Expression ${a} in this sql tagged template is a function which returned an empty array. Empty arrays cannot safely be expanded into parameter lists.`);const h=l.map(()=>s.createParameter(`param_${r+1}`,r++));n+=h.join(", "),i.push(...l);continue}throw new Error(`Expression ${a} in this sql tagged template is a function which returned a value of type "${l===null?"null":typeof l}". Only array and string types are supported as function return values in sql tagged template expressions.`)}n+=s.createParameter(`param_${r+1}`,r++),i.push(c)}return n+=e[e.length-1],n=P0(n),{query:n,parameters:i}}class Up{get metadata(){return this.manager.connection.getMetadata(this.target)}constructor(e,t,n){this.target=e,this.manager=t,this.queryRunner=n}createQueryBuilder(e,t){return this.manager.createQueryBuilder(this.metadata.target,e||this.metadata.targetName,t||this.queryRunner)}hasId(e){return this.manager.hasId(this.metadata.target,e)}getId(e){return this.manager.getId(this.metadata.target,e)}create(e){return this.manager.create(this.metadata.target,e)}merge(e,...t){return this.manager.merge(this.metadata.target,e,...t)}preload(e){return this.manager.preload(this.metadata.target,e)}save(e,t){return this.manager.save(this.metadata.target,e,t)}remove(e,t){return this.manager.remove(this.metadata.target,e,t)}softRemove(e,t){return this.manager.softRemove(this.metadata.target,e,t)}recover(e,t){return this.manager.recover(this.metadata.target,e,t)}insert(e){return this.manager.insert(this.metadata.target,e)}update(e,t){return this.manager.update(this.metadata.target,e,t)}updateAll(e){return this.manager.updateAll(this.metadata.target,e)}upsert(e,t){return this.manager.upsert(this.metadata.target,e,t)}delete(e){return this.manager.delete(this.metadata.target,e)}deleteAll(){return this.manager.deleteAll(this.metadata.target)}softDelete(e){return this.manager.softDelete(this.metadata.target,e)}restore(e){return this.manager.restore(this.metadata.target,e)}exist(e){return this.manager.exists(this.metadata.target,e)}exists(e){return this.manager.exists(this.metadata.target,e)}existsBy(e){return this.manager.existsBy(this.metadata.target,e)}count(e){return this.manager.count(this.metadata.target,e)}countBy(e){return this.manager.countBy(this.metadata.target,e)}sum(e,t){return this.manager.sum(this.metadata.target,e,t)}average(e,t){return this.manager.average(this.metadata.target,e,t)}minimum(e,t){return this.manager.minimum(this.metadata.target,e,t)}maximum(e,t){return this.manager.maximum(this.metadata.target,e,t)}async find(e){return this.manager.find(this.metadata.target,e)}async findBy(e){return this.manager.findBy(this.metadata.target,e)}findAndCount(e){return this.manager.findAndCount(this.metadata.target,e)}findAndCountBy(e){return this.manager.findAndCountBy(this.metadata.target,e)}async findByIds(e){return this.manager.findByIds(this.metadata.target,e)}async findOne(e){return this.manager.findOne(this.metadata.target,e)}async findOneBy(e){return this.manager.findOneBy(this.metadata.target,e)}async findOneById(e){return this.manager.findOneById(this.metadata.target,e)}async findOneOrFail(e){return this.manager.findOneOrFail(this.metadata.target,e)}async findOneByOrFail(e){return this.manager.findOneByOrFail(this.metadata.target,e)}query(e,t){return this.manager.query(e,t)}async sql(e,...t){const{query:n,parameters:i}=oo({driver:this.manager.connection.driver,strings:e,expressions:t});return await this.query(n,i)}clear(){return this.manager.clear(this.metadata.target)}increment(e,t,n){return this.manager.increment(this.metadata.target,e,t,n)}decrement(e,t,n){return this.manager.decrement(this.metadata.target,e,t,n)}extend(e){const t=this.constructor,{target:n,manager:i,queryRunner:r}=this,a=class extends t{constructor(c,l,h){super(c,l,h)}};for(const c in e)a.prototype[c]=e[c];return new a(n,i,r)}}class D0 extends Up{async findTrees(e){const t=await this.findRoots(e);return await Promise.all(t.map(n=>this.findDescendantsTree(n,e))),t}findRoots(e){const t=c=>this.manager.connection.driver.escape(c),n=c=>this.manager.connection.driver.escape(c),i=this.metadata.treeParentRelation.joinColumns[0],r=i.givenDatabaseName||i.databaseName,a=this.createQueryBuilder("treeEntity");return kt.applyOptionsToTreeQueryBuilder(a,e),a.where(`${t("treeEntity")}.${n(r)} IS NULL`).getMany()}findDescendants(e,t){const n=this.createDescendantsQueryBuilder("treeEntity","treeClosure",e);return kt.applyOptionsToTreeQueryBuilder(n,t),n.getMany()}async findDescendantsTree(e,t){const n=this.createDescendantsQueryBuilder("treeEntity","treeClosure",e);kt.applyOptionsToTreeQueryBuilder(n,t);const i=await n.getRawAndEntities(),r=rr.createRelationMaps(this.manager,this.metadata,"treeEntity",i.raw);return rr.buildChildrenEntityTree(this.metadata,e,i.entities,r,{depth:-1,...t}),e}countDescendants(e){return this.createDescendantsQueryBuilder("treeEntity","treeClosure",e).getCount()}createDescendantsQueryBuilder(e,t,n){const i=r=>this.manager.connection.driver.escape(r);if(this.metadata.treeType==="closure-table"){const r=this.metadata.closureJunctionTable.descendantColumns.map(l=>i(t)+"."+i(l.propertyPath)+" = "+i(e)+"."+i(l.referencedColumn.propertyPath)).join(" AND "),a={},c=this.metadata.closureJunctionTable.ancestorColumns.map(l=>(a[l.referencedColumn.propertyName]=l.referencedColumn.getEntityValue(n),i(t)+"."+i(l.propertyPath)+" = :"+l.referencedColumn.propertyName)).join(" AND ");return this.createQueryBuilder(e).innerJoin(this.metadata.closureJunctionTable.tableName,t,r).where(c).setParameters(a)}else if(this.metadata.treeType==="nested-set"){const r=e+"."+this.metadata.nestedSetLeftColumn.propertyPath+" BETWEEN joined."+this.metadata.nestedSetLeftColumn.propertyPath+" AND joined."+this.metadata.nestedSetRightColumn.propertyPath,a={},c=this.metadata.treeParentRelation.joinColumns.map(l=>{const h=l.referencedColumn.propertyPath.replace(".","_");return a[h]=l.referencedColumn.getEntityValue(n),"joined."+l.referencedColumn.propertyPath+" = :"+h}).join(" AND ");return this.createQueryBuilder(e).innerJoin(this.metadata.targetName,"joined",r).where(c,a)}else if(this.metadata.treeType==="materialized-path")return this.createQueryBuilder(e).where(r=>{const a=r.subQuery().select(`${this.metadata.targetName}.${this.metadata.materializedPathColumn.propertyPath}`,"path").from(this.metadata.target,this.metadata.targetName).whereInIds(this.metadata.getEntityIdMap(n));return te.isSQLiteFamily(this.manager.connection.driver)?`${e}.${this.metadata.materializedPathColumn.propertyPath} LIKE ${a.getQuery()} || '%'`:`${e}.${this.metadata.materializedPathColumn.propertyPath} LIKE NULLIF(CONCAT(${a.getQuery()}, '%'), '%')`});throw new _("Supported only in tree entities")}findAncestors(e,t){const n=this.createAncestorsQueryBuilder("treeEntity","treeClosure",e);return kt.applyOptionsToTreeQueryBuilder(n,t),n.getMany()}async findAncestorsTree(e,t){const n=this.createAncestorsQueryBuilder("treeEntity","treeClosure",e);kt.applyOptionsToTreeQueryBuilder(n,t);const i=await n.getRawAndEntities(),r=rr.createRelationMaps(this.manager,this.metadata,"treeEntity",i.raw);return rr.buildParentEntityTree(this.metadata,e,i.entities,r),e}countAncestors(e){return this.createAncestorsQueryBuilder("treeEntity","treeClosure",e).getCount()}createAncestorsQueryBuilder(e,t,n){if(this.metadata.treeType==="closure-table"){const i=this.metadata.closureJunctionTable.ancestorColumns.map(c=>t+"."+c.propertyPath+" = "+e+"."+c.referencedColumn.propertyPath).join(" AND "),r={},a=this.metadata.closureJunctionTable.descendantColumns.map(c=>(r[c.referencedColumn.propertyName]=c.referencedColumn.getEntityValue(n),t+"."+c.propertyPath+" = :"+c.referencedColumn.propertyName)).join(" AND ");return this.createQueryBuilder(e).innerJoin(this.metadata.closureJunctionTable.tableName,t,i).where(a).setParameters(r)}else if(this.metadata.treeType==="nested-set"){const i="joined."+this.metadata.nestedSetLeftColumn.propertyPath+" BETWEEN "+e+"."+this.metadata.nestedSetLeftColumn.propertyPath+" AND "+e+"."+this.metadata.nestedSetRightColumn.propertyPath,r={},a=this.metadata.treeParentRelation.joinColumns.map(c=>{const l=c.referencedColumn.propertyPath.replace(".","_");return r[l]=c.referencedColumn.getEntityValue(n),"joined."+c.referencedColumn.propertyPath+" = :"+l}).join(" AND ");return this.createQueryBuilder(e).innerJoin(this.metadata.targetName,"joined",i).where(a,r)}else if(this.metadata.treeType==="materialized-path")return this.createQueryBuilder(e).where(i=>{const r=i.subQuery().select(`${this.metadata.targetName}.${this.metadata.materializedPathColumn.propertyPath}`,"path").from(this.metadata.target,this.metadata.targetName).whereInIds(this.metadata.getEntityIdMap(n));return te.isSQLiteFamily(this.manager.connection.driver)?`${r.getQuery()} LIKE ${e}.${this.metadata.materializedPathColumn.propertyPath} || '%'`:`${r.getQuery()} LIKE CONCAT(${e}.${this.metadata.materializedPathColumn.propertyPath}, '%')`});throw new _("Supported only in tree entities")}}class I0{transform(e,t,n,i=!1){return this.groupAndTransform(e,t,n,i),e}groupAndTransform(e,t,n,i=!1){n.nonVirtualColumns.forEach(r=>{const a=r.getEntityValue(t);a!==void 0&&r.setEntityValue(e,a)}),n.relations.length&&n.relations.forEach(r=>{let a=r.getEntityValue(e);const c=r.getEntityValue(t,i);if(c!==void 0)if(r.isOneToMany||r.isManyToMany){if(!Array.isArray(c))return;a||(a=[],r.setEntityValue(e,a)),c.forEach(l=>{let h=a.find(p=>r.inverseEntityMetadata.compareEntities(l,p));const f=r.inverseEntityMetadata.findInheritanceMetadata(l);h||(h=f.create(void 0,{fromDeserializer:!0}),a.push(h)),this.groupAndTransform(h,l,f,i)})}else{if(!Ce.isObject(c)){Ce.isObject(a)||r.setEntityValue(e,c);return}const l=r.inverseEntityMetadata.findInheritanceMetadata(c);a||(a=l.create(void 0,{fromDeserializer:!0}),r.setEntityValue(e,a)),this.groupAndTransform(a,c,l,i)}})}}class $0{constructor(e,t,n,i){this.plainEntity=e,this.metadata=t,this.parentLoadMapItem=n,this.relation=i}get target(){return this.metadata.target}get id(){return this.metadata.getEntityIdMixedMap(this.plainEntity)}}class L0{constructor(){this.loadMapItems=[]}get mainLoadMapItem(){return this.loadMapItems.find(e=>!e.relation&&!e.parentLoadMapItem)}addLoadMap(e){this.loadMapItems.find(n=>n.target===e.target&&n.id===e.id)||this.loadMapItems.push(e)}fillEntities(e,t){t.forEach(n=>{const i=this.loadMapItems.find(r=>r.target===e&&r.metadata.compareEntities(n,r.plainEntity));i&&(i.entity=n)})}groupByTargetIds(){const e=[];return this.loadMapItems.forEach(t=>{let n=e.find(i=>i.target===t.target);n||(n={target:t.target,ids:[]},e.push(n)),n.ids.push(t.id)}),e}}class q0{constructor(e){this.manager=e}async transform(e,t){if(!t.hasAllPrimaryKeys(e))return Promise.reject("Given object does not have a primary column, cannot transform it to database entity.");const n=new L0,i=(r,a,c,l)=>{const h=new $0(r,a,c,l);n.addLoadMap(h),a.extractRelationValuesFromEntity(r,t.relations).filter(f=>f!=null).forEach(([f,p,m])=>i(p,m,h,f))};return i(e,t),await Promise.all(n.groupByTargetIds().map(r=>this.manager.findByIds(r.target,r.ids).then(a=>n.fillEntities(r.target,a)))),n.loadMapItems.forEach(r=>{!r.relation||!r.entity||!r.parentLoadMapItem||!r.parentLoadMapItem.entity||(r.relation.isManyToMany||r.relation.isOneToMany?(r.parentLoadMapItem.entity[r.relation.propertyName]||(r.parentLoadMapItem.entity[r.relation.propertyName]=[]),r.parentLoadMapItem.entity[r.relation.propertyName].push(r.entity)):r.parentLoadMapItem.entity[r.relation.propertyName]=r.entity)}),n.mainLoadMapItem?n.mainLoadMapItem.entity:void 0}}class B0{get repository(){const e=this.getCustomRepositoryTarget(this);if(!e)throw new Vc(this.constructor);return this.manager.getRepository(e)}get treeRepository(){const e=this.getCustomRepositoryTarget(this);if(!e)throw new Vc(this.constructor);return this.manager.getTreeRepository(e)}createQueryBuilder(e){const t=this.getCustomRepositoryTarget(this.constructor);if(!t)throw new Vc(this.constructor);return this.manager.getRepository(t).createQueryBuilder(e)}createQueryBuilderFor(e,t){return this.getRepositoryFor(e).createQueryBuilder(t)}getRepositoryFor(e){return this.manager.getRepository(e)}getTreeRepositoryFor(e){return this.manager.getTreeRepository(e)}getCustomRepositoryTarget(e){const t=Va().entityRepositories.find(n=>n.target===(typeof e=="function"?e:e.constructor));if(!t)throw new pp(e);return t.entity}}class Af{constructor(e){this.subjects=[...e],this.metadatas=this.getUniqueMetadatas(this.subjects)}sort(e){if(!this.metadatas.length)return this.subjects;const t=[];if(e==="delete"){const c=this.subjects.filter(l=>!l.entity&&!l.databaseEntity);t.push(...c),this.removeAlreadySorted(c)}const n=this.getNonNullableDependencies();let i=this.toposort(n);e==="insert"&&(i=i.reverse()),i.forEach(c=>{const l=this.subjects.filter(h=>h.metadata.targetName===c||h.metadata.inheritanceTree.some(f=>f.name===c));t.push(...l),this.removeAlreadySorted(l)});const r=this.getDependencies();let a=this.toposort(r);return e==="insert"&&(a=a.reverse()),a.forEach(c=>{const l=this.subjects.filter(h=>h.metadata.targetName===c);t.push(...l),this.removeAlreadySorted(l)}),t.push(...this.subjects),t}removeAlreadySorted(e){e.forEach(t=>{this.subjects.splice(this.subjects.indexOf(t),1)})}getUniqueMetadatas(e){const t=[];return e.forEach(n=>{t.indexOf(n.metadata)===-1&&t.push(n.metadata)}),t}getNonNullableDependencies(){return this.metadatas.reduce((e,t)=>(t.relationsWithJoinColumns.forEach(n=>{n.isNullable||e.push([t.targetName,n.inverseEntityMetadata.targetName])}),e),[])}getDependencies(){return this.metadatas.reduce((e,t)=>(t.relationsWithJoinColumns.forEach(n=>{n.inverseEntityMetadata!==t&&e.push([t.targetName,n.inverseEntityMetadata.targetName])}),e),[])}toposort(e){function t(h){const f=[];for(let p=0,m=h.length;p<m;p++){const T=h[p];f.indexOf(T[0])<0&&f.push(T[0]),f.indexOf(T[1])<0&&f.push(T[1])}return f}const n=t(e);let i=n.length,r=i;const a=new Array(i),c=new Set;for(;r--;)c.has(r)||l(n[r],r,[]);function l(h,f,p){if(p.indexOf(h)>=0)throw new _("Cyclic dependency: "+JSON.stringify(h));if(!~n.indexOf(h))throw new _("Found unknown node. Make sure to provided all involved nodes. Unknown node: "+JSON.stringify(h));if(c.has(f))return;c.add(f);const m=e.filter(function(T){return T[0]===h});if(f=m.length){const T=p.concat(h);do{const A=m[--f][1];l(A,n.indexOf(A),T)}while(f)}a[--i]=h}return a}}class pe{static normalizeHydratedDate(e){return e&&(typeof e=="string"?new Date(e):e)}static mixedDateToDateString(e){return e instanceof Date?this.formatZerolessValue(e.getFullYear(),4)+"-"+this.formatZerolessValue(e.getMonth()+1)+"-"+this.formatZerolessValue(e.getDate()):e}static mixedDateToDate(e,t=!1,n=!0){let i=typeof e=="string"?AA(e).toDate():e;return t&&(i=new Date(i.getUTCFullYear(),i.getUTCMonth(),i.getUTCDate(),i.getUTCHours(),i.getUTCMinutes(),i.getUTCSeconds(),i.getUTCMilliseconds())),n||i.setUTCMilliseconds(0),i}static mixedDateToTimeString(e,t=!1){return e instanceof Date?this.formatZerolessValue(e.getHours())+":"+this.formatZerolessValue(e.getMinutes())+(t?"":":"+this.formatZerolessValue(e.getSeconds())):e}static mixedTimeToDate(e){if(typeof e=="string"){const[t,n,i]=e.split(":"),r=new Date;return t&&r.setHours(parseInt(t)),n&&r.setMinutes(parseInt(n)),i&&r.setSeconds(parseInt(i)),r}return e}static mixedTimeToString(e,t=!1){return e=e instanceof Date?e.getHours()+":"+e.getMinutes()+(t?"":":"+e.getSeconds()):e,typeof e=="string"?e.split(":").map(n=>n.length===1?"0"+n:n).join(":"):e}static mixedDateToDatetimeString(e,t){if(typeof e=="string"&&(e=new Date(e)),e instanceof Date){let n=this.formatZerolessValue(e.getFullYear(),4)+"-"+this.formatZerolessValue(e.getMonth()+1)+"-"+this.formatZerolessValue(e.getDate())+" "+this.formatZerolessValue(e.getHours())+":"+this.formatZerolessValue(e.getMinutes())+":"+this.formatZerolessValue(e.getSeconds());t&&(n+=`.${this.formatMilliseconds(e.getMilliseconds())}`),e=n}return e}static mixedDateToUtcDatetimeString(e){return typeof e=="string"&&(e=new Date(e)),e instanceof Date?this.formatZerolessValue(e.getUTCFullYear(),4)+"-"+this.formatZerolessValue(e.getUTCMonth()+1)+"-"+this.formatZerolessValue(e.getUTCDate())+" "+this.formatZerolessValue(e.getUTCHours())+":"+this.formatZerolessValue(e.getUTCMinutes())+":"+this.formatZerolessValue(e.getUTCSeconds())+"."+this.formatMilliseconds(e.getUTCMilliseconds()):e}static simpleArrayToString(e){return Array.isArray(e)?e.map(t=>String(t)).join(","):e}static stringToSimpleArray(e){return typeof e=="string"?e.length>0?e.split(","):[]:e}static simpleJsonToString(e){return JSON.stringify(e)}static stringToSimpleJson(e){return typeof e=="string"?JSON.parse(e):e}static simpleEnumToString(e){return""+e}static stringToSimpleEnum(e,t){return t.enum&&!isNaN(e)&&t.enum.indexOf(parseInt(e))>=0&&(e=parseInt(e)),e}static formatZerolessValue(e,t=2){return`${"0".repeat(t)}${e}`.slice(-t)}static formatMilliseconds(e){return e<10?"00"+e:e<100?"0"+e:String(e)}}class F0{compute(e){e.forEach(t=>{this.computeDiffColumns(t),this.computeDiffRelationalColumns(e,t)})}computeDiffColumns(e){e.entity&&e.metadata.columns.forEach(t=>{if(t.isVirtual||t.isDiscriminator)return;const n=e.changeMaps.find(r=>r.column===t);n&&e.changeMaps.splice(e.changeMaps.indexOf(n),1);const i=t.getEntityValue(e.entity);if(i!==void 0){if(e.databaseEntity){const r=t.type!=="json"&&t.type!=="jsonb";let a=t.getEntityValue(e.databaseEntity,r);if(t.relationMetadata){const l=t.relationMetadata.getEntityValue(e.entity);if(l!=null)return}let c=i;if(i!==null&&a!==null){switch(t.type){case"date":c=t.isArray?i.map(l=>pe.mixedDateToDateString(l)):pe.mixedDateToDateString(i),a=t.isArray?a.map(l=>pe.mixedDateToDateString(l)):pe.mixedDateToDateString(a);break;case"time":case"time with time zone":case"time without time zone":case"timetz":c=t.isArray?i.map(l=>pe.mixedDateToTimeString(l)):pe.mixedDateToTimeString(i),a=t.isArray?a.map(l=>pe.mixedDateToTimeString(l)):pe.mixedDateToTimeString(a);break;case"datetime":case"datetime2":case Date:case"timestamp":case"timestamp without time zone":case"timestamp with time zone":case"timestamp with local time zone":case"timestamptz":c=t.isArray?i.map(l=>pe.mixedDateToUtcDatetimeString(l)):pe.mixedDateToUtcDatetimeString(i),a=t.isArray?a.map(l=>pe.mixedDateToUtcDatetimeString(l)):pe.mixedDateToUtcDatetimeString(a);break;case"json":case"jsonb":if(ee.deepCompare(i,a))return;break;case"simple-array":c=pe.simpleArrayToString(i),a=pe.simpleArrayToString(a);break;case"simple-enum":c=pe.simpleEnumToString(i),a=pe.simpleEnumToString(a);break;case"simple-json":c=pe.simpleJsonToString(i),a=pe.simpleJsonToString(a);break}t.transformer&&(c=Mt.transformTo(t.transformer,i))}if(t.isArray){if(ee.deepCompare(c,a))return}else if(Buffer.isBuffer(c)&&Buffer.isBuffer(a)){if(c.equals(a))return}else if(c===a)return}e.diffColumns.includes(t)||e.diffColumns.push(t),e.changeMaps.push({column:t,value:i})}})}computeDiffRelationalColumns(e,t){t.entity&&t.metadata.relationsWithJoinColumns.forEach(n=>{let i=n.getEntityValue(t.entity);if(i===void 0)return;if(t.databaseEntity){let c=i;c!==null&&Ce.isObject(c)&&(c=n.getRelationIdMap(c));const l=n.getEntityValue(t.databaseEntity);if(ee.compareIds(c,l))return;t.diffRelations.push(n)}const r=e.find(c=>c.mustBeInserted&&c.entity===i);r&&(i=r);const a=t.changeMaps.find(c=>c.relation===n);a?a.value=i:t.changeMaps.push({relation:n,value:i})})}}class Cf extends _{constructor(){super("Nested sets do not support multiple root entities.")}}class zc{constructor(e){this.queryRunner=e}async insert(e){const t=h=>this.queryRunner.connection.driver.escape(h),n=this.getTableName(e.metadata.tablePath),i=t(e.metadata.nestedSetLeftColumn.databaseName),r=t(e.metadata.nestedSetRightColumn.databaseName);let a=e.metadata.treeParentRelation.getEntityValue(e.entity);!a&&e.parentSubject&&e.parentSubject.entity&&(a=e.parentSubject.insertedValueSet?e.parentSubject.insertedValueSet:e.parentSubject.entity);const c=e.metadata.getEntityIdMap(a);let l;if(c&&(l=await this.queryRunner.manager.createQueryBuilder().select(e.metadata.targetName+"."+e.metadata.nestedSetRightColumn.propertyPath,"right").from(e.metadata.target,e.metadata.targetName).whereInIds(c).getRawOne().then(h=>{const f=h?h.right:void 0;return typeof f=="string"?parseInt(f):f})),l!==void 0)await this.queryRunner.query(`UPDATE ${n} SET ${i} = CASE WHEN ${i} > ${l} THEN ${i} + 2 ELSE ${i} END,${r} = ${r} + 2 WHERE ${r} >= ${l}`),ee.mergeDeep(e.insertedValueSet,e.metadata.nestedSetLeftColumn.createValueMap(l),e.metadata.nestedSetRightColumn.createValueMap(l+1));else{if(!await this.isUniqueRootEntity(e,a))throw new Cf;ee.mergeDeep(e.insertedValueSet,e.metadata.nestedSetLeftColumn.createValueMap(1),e.metadata.nestedSetRightColumn.createValueMap(2))}}async update(e){let t=e.metadata.treeParentRelation.getEntityValue(e.entity);!t&&e.parentSubject&&e.parentSubject.entity&&(t=e.parentSubject.entity);let n=e.databaseEntity;if(!n&&t&&(n=e.metadata.treeChildrenRelation.getEntityValue(t).find(c=>Object.entries(e.identifier).every(([l,h])=>c[l]===h))),n===void 0||t===void 0)return;const i=e.metadata.treeParentRelation.getEntityValue(n),r=e.metadata.getEntityIdMap(i),a=e.metadata.getEntityIdMap(t);if(!ee.compareIds(r,a)){if(t){const c=A=>this.queryRunner.connection.driver.escape(A),l=this.getTableName(e.metadata.tablePath),h=c(e.metadata.nestedSetLeftColumn.databaseName),f=c(e.metadata.nestedSetRightColumn.databaseName),p=e.metadata.getEntityIdMap(n);let m;p&&(m=(await this.getNestedSetIds(e.metadata,p))[0]);let T;if(a&&(T=(await this.getNestedSetIds(e.metadata,a))[0]),m!==void 0&&T!==void 0){const A=T.left>m.left,S=m.right-m.left+1;let P;A?P=T.left-m.right:P=T.right-m.left;const F=`WHEN ${h} >= ${m.left} AND ${h} < ${m.right} THEN ${h} + ${P} `,B=`WHEN ${f} > ${m.left} AND ${f} <= ${m.right} THEN ${f} + ${P} `;A?await this.queryRunner.query(`UPDATE ${l} SET ${h} = CASE WHEN ${h} > ${m.right} AND ${h} <= ${T.left} THEN ${h} - ${S} `+F+`ELSE ${h} END, ${f} = CASE WHEN ${f} > ${m.right} AND ${f} < ${T.left} THEN ${f} - ${S} `+B+`ELSE ${f} END`):await this.queryRunner.query(`UPDATE ${l} SET ${h} = CASE WHEN ${h} < ${m.left} AND ${h} > ${T.right} THEN ${h} + ${S} `+F+`ELSE ${h} END, ${f} = CASE WHEN ${f} < ${m.left} AND ${f} >= ${T.right} THEN ${f} + ${S} `+B+`ELSE ${f} END`)}}else if(!await this.isUniqueRootEntity(e,t))throw new Cf}}async remove(e){Array.isArray(e)||(e=[e]);const t=e[0].metadata,n=h=>this.queryRunner.connection.driver.escape(h),i=this.getTableName(t.tablePath),r=n(t.nestedSetLeftColumn.databaseName),a=n(t.nestedSetRightColumn.databaseName),c=[];for(const h of e){const f=t.getEntityIdMap(h.entity);f&&c.push(f)}const l=await this.getNestedSetIds(t,c);for(const h of l){const f=h.right-h.left+1;await this.queryRunner.query(`UPDATE ${i} SET ${r} = CASE WHEN ${r} > ${h.left} THEN ${r} - ${f} ELSE ${r} END, ${a} = CASE WHEN ${a} > ${h.right} THEN ${a} - ${f} ELSE ${a} END`)}}getNestedSetIds(e,t){const n={left:`${e.targetName}.${e.nestedSetLeftColumn.propertyPath}`,right:`${e.targetName}.${e.nestedSetRightColumn.propertyPath}`},i=this.queryRunner.manager.createQueryBuilder();return Object.entries(n).forEach(([r,a])=>{i.addSelect(a,r)}),i.from(e.target,e.targetName).whereInIds(t).orderBy(n.right,"DESC").getRawMany().then(r=>{const a=[];for(const c of r){const l={};for(const h of Object.keys(n)){const f=c?c[h]:void 0;l[h]=typeof f=="string"?parseInt(f):f}a.push(l)}return a})}async isUniqueRootEntity(e,t){const n=h=>this.queryRunner.connection.driver.escape(h),i=this.getTableName(e.metadata.tablePath),r=[],a=e.metadata.treeParentRelation.joinColumns.map(h=>{const f=n(h.databaseName),p=h.getEntityValue(t);if(p==null)return`${f} IS NULL`;r.push(p);const m=this.queryRunner.connection.driver.createParameter("entity_"+h.databaseName,r.length-1);return`${f} = ${m}`}).join(" AND "),c="count",l=await this.queryRunner.query(`SELECT COUNT(1) AS ${n(c)} FROM ${i} WHERE ${a}`,r,!0);return parseInt(l.records[0][c])===0}getTableName(e){return e.split(".").map(t=>t===""?t:this.queryRunner.connection.driver.escape(t)).join(".")}}class Kc{constructor(e){this.queryRunner=e}async insert(e){const t={};e.metadata.closureJunctionTable.ancestorColumns.forEach(i=>{t[i.databaseName]=e.identifier}),e.metadata.closureJunctionTable.descendantColumns.forEach(i=>{t[i.databaseName]=e.identifier}),await this.queryRunner.manager.createQueryBuilder().insert().into(e.metadata.closureJunctionTable.tablePath).values(t).updateEntity(!1).callListeners(!1).execute();let n=e.metadata.treeParentRelation.getEntityValue(e.entity);if(!n&&e.parentSubject&&e.parentSubject.entity&&(n=e.parentSubject.insertedValueSet?e.parentSubject.insertedValueSet:e.parentSubject.entity),n){const i=p=>this.queryRunner.connection.driver.escape(p),r=this.getTableName(e.metadata.closureJunctionTable.tablePath),a=[],c=e.metadata.closureJunctionTable.ancestorColumns.map(p=>i(p.databaseName)),l=e.metadata.closureJunctionTable.descendantColumns.map(p=>i(p.databaseName)),h=e.metadata.primaryColumns.map(p=>(a.push(p.getEntityValue(e.insertedValueSet?e.insertedValueSet:e.entity)),this.queryRunner.connection.driver.createParameter("child_entity_"+p.databaseName,a.length-1))),f=e.metadata.closureJunctionTable.descendantColumns.map(p=>{const m=i(p.databaseName),T=p.referencedColumn.getEntityValue(n);if(!T)throw new Zd(e.metadata.name);a.push(T);const A=this.queryRunner.connection.driver.createParameter("parent_entity_"+p.referencedColumn.databaseName,a.length-1);return`${m} = ${A}`});await this.queryRunner.query(`INSERT INTO ${r} (${[...c,...l].join(", ")}) SELECT ${c.join(", ")}, ${h.join(", ")} FROM ${r} WHERE ${f.join(" AND ")}`,a)}}async update(e){let t=e.metadata.treeParentRelation.getEntityValue(e.entity);!t&&e.parentSubject&&e.parentSubject.entity&&(t=e.parentSubject.entity);let n=e.databaseEntity;if(!n&&t&&(n=e.metadata.treeChildrenRelation.getEntityValue(t).find(T=>Object.entries(e.identifier).every(([A,S])=>T[A]===S))),n===void 0||t===void 0)return;const i=e.metadata.treeParentRelation.getEntityValue(n),r=e.metadata.getEntityIdMap(i),a=e.metadata.getEntityIdMap(t);if(ee.compareIds(r,a))return;const c=T=>this.queryRunner.connection.driver.escape(T),l=e.metadata.closureJunctionTable,h=l.ancestorColumns.map(T=>c(T.databaseName)),f=l.descendantColumns.map(T=>c(T.databaseName)),p=(T,A)=>{const S=`sub${A}`,P=T.createQueryBuilder().select(f.join(", ")).from(l.tablePath,S);for(const F of l.ancestorColumns)P.andWhere(`${c(S)}.${c(F.databaseName)} = :value_${F.referencedColumn.databaseName}`);return T.createQueryBuilder().select(f.join(", ")).from(`(${P.getQuery()})`,A).setParameters(P.getParameters()).getQuery()},m={};for(const T of e.metadata.primaryColumns)m[`value_${T.databaseName}`]=n[T.databaseName];if(await this.queryRunner.manager.createQueryBuilder().delete().from(l.tablePath).where(T=>`(${f.join(", ")}) IN (${p(T,"descendant")})`).andWhere(T=>`(${h.join(", ")}) NOT IN (${p(T,"ancestor")})`).setParameters(m).execute(),t){const T=[],A=this.getTableName(l.tablePath),S=c("supertree"),P=c("subtree"),F=[...h.map(Z=>`${S}.${Z}`),...f.map(Z=>`${P}.${Z}`)],B=e.metadata.closureJunctionTable.ancestorColumns.map(Z=>{const re=c(Z.databaseName),Ee=Z.referencedColumn.getEntityValue(n);T.push(Ee);const Se=this.queryRunner.connection.driver.createParameter("entity_"+Z.referencedColumn.databaseName,T.length-1);return`${P}.${re} = ${Se}`}),q=e.metadata.closureJunctionTable.descendantColumns.map(Z=>{const re=c(Z.databaseName),Ee=Z.referencedColumn.getEntityValue(t);if(!Ee)throw new Zd(e.metadata.name);T.push(Ee);const Se=this.queryRunner.connection.driver.createParameter("parent_entity_"+Z.referencedColumn.databaseName,T.length-1);return`${S}.${re} = ${Se}`});await this.queryRunner.query(`INSERT INTO ${A} (${[...h,...f].join(", ")}) SELECT ${F.join(", ")} FROM ${A} AS ${S}, ${A} AS ${P} WHERE ${[...B,...q].join(" AND ")}`,T)}}async remove(e){if(this.queryRunner.connection.driver.options.type!=="mssql")return;Array.isArray(e)||(e=[e]);const t=l=>this.queryRunner.connection.driver.escape(l),n=e.map(l=>l.identifier),i=e[0].metadata.closureJunctionTable,r=l=>l.map(h=>{const f=n.map(p=>p[h.referencedColumn.databaseName]);return`${t(h.databaseName)} IN (${f.join(", ")})`}).join(" AND "),a=r(i.ancestorColumns),c=r(i.descendantColumns);await this.queryRunner.manager.createQueryBuilder().delete().from(i.tablePath).where(a).orWhere(c).execute()}getTableName(e){return e.split(".").map(t=>t===""?t:this.queryRunner.connection.driver.escape(t)).join(".")}}class jn{constructor(e){this["@instanceof"]=Symbol.for("EntityMetadata"),this.childEntityMetadatas=[],this.inheritanceTree=[],this.tableType="regular",this.withoutRowid=!1,this.synchronize=!0,this.hasNonNullableRelations=!1,this.isJunction=!1,this.isAlwaysUsingConstructor=!0,this.isClosureJunction=!1,this.hasMultiplePrimaryKeys=!1,this.hasUUIDGeneratedColumns=!1,this.ownColumns=[],this.columns=[],this.ancestorColumns=[],this.descendantColumns=[],this.nonVirtualColumns=[],this.ownerColumns=[],this.inverseColumns=[],this.generatedColumns=[],this.primaryColumns=[],this.ownRelations=[],this.relations=[],this.eagerRelations=[],this.lazyRelations=[],this.oneToOneRelations=[],this.ownerOneToOneRelations=[],this.oneToManyRelations=[],this.manyToOneRelations=[],this.manyToManyRelations=[],this.ownerManyToManyRelations=[],this.relationsWithJoinColumns=[],this.relationIds=[],this.relationCounts=[],this.foreignKeys=[],this.embeddeds=[],this.allEmbeddeds=[],this.ownIndices=[],this.indices=[],this.uniques=[],this.ownUniques=[],this.checks=[],this.exclusions=[],this.ownListeners=[],this.listeners=[],this.afterLoadListeners=[],this.beforeInsertListeners=[],this.afterInsertListeners=[],this.beforeUpdateListeners=[],this.afterUpdateListeners=[],this.beforeRemoveListeners=[],this.beforeSoftRemoveListeners=[],this.beforeRecoverListeners=[],this.afterRemoveListeners=[],this.afterSoftRemoveListeners=[],this.afterRecoverListeners=[],this.connection=e.connection,this.inheritanceTree=e.inheritanceTree||[],this.inheritancePattern=e.inheritancePattern,this.treeType=e.tableTree?e.tableTree.type:void 0,this.treeOptions=e.tableTree?e.tableTree.options:void 0,this.parentClosureEntityMetadata=e.parentClosureEntityMetadata,this.tableMetadataArgs=e.args,this.target=this.tableMetadataArgs.target,this.tableType=this.tableMetadataArgs.type,this.expression=this.tableMetadataArgs.expression,this.withoutRowid=this.tableMetadataArgs.withoutRowid,this.dependsOn=this.tableMetadataArgs.dependsOn}create(e,t){const n=!!(t&&t.pojo===!0);let i;return typeof this.target=="function"&&!n?!(t!=null&&t.fromDeserializer)||this.isAlwaysUsingConstructor?i=new this.target:i=Object.create(this.target.prototype):i={},this.connection.options.typename&&(i[this.connection.options.typename]=this.targetName),this.lazyRelations.forEach(r=>this.connection.relationLoader.enableLazyLoad(r,i,e)),i}hasId(e){return e?this.primaryColumns.every(t=>{const n=t.getEntityValue(e);return n!=null&&n!==""}):!1}hasAllPrimaryKeys(e){return this.primaryColumns.every(t=>{const n=t.getEntityValue(e);return n!=null})}ensureEntityIdMap(e){if(Ce.isObject(e))return e;if(this.hasMultiplePrimaryKeys)throw new vC(this,e);return this.primaryColumns[0].createValueMap(e)}getEntityIdMap(e){if(e)return jn.getValueMap(e,this.primaryColumns,{skipNulls:!0})}getEntityIdMixedMap(e){if(!e)return e;const t=this.getEntityIdMap(e);return this.hasMultiplePrimaryKeys?t:t&&this.primaryColumns[0].getEntityValue(t)}compareEntities(e,t){const n=this.getEntityIdMap(e);if(!n)return!1;const i=this.getEntityIdMap(t);return i?ee.compareIds(n,i):!1}findColumnWithPropertyName(e){return this.columns.find(t=>t.propertyName===e)}findColumnWithDatabaseName(e){return this.columns.find(t=>t.databaseName===e)}hasColumnWithPropertyPath(e){return this.columns.some(n=>n.propertyPath===e)||this.hasRelationWithPropertyPath(e)}findColumnWithPropertyPath(e){const t=this.columns.find(i=>i.propertyPath===e);if(t)return t;const n=this.relations.find(i=>i.propertyPath===e);if(n&&n.joinColumns.length===1)return n.joinColumns[0]}findColumnWithPropertyPathStrict(e){return this.columns.find(t=>t.propertyPath===e)}findColumnsWithPropertyPath(e){const t=this.columns.find(i=>i.propertyPath===e);if(t)return[t];const n=this.findRelationWithPropertyPath(e);return n&&n.joinColumns?n.joinColumns:[]}hasRelationWithPropertyPath(e){return this.relations.some(t=>t.propertyPath===e)}findRelationWithPropertyPath(e){return this.relations.find(t=>t.propertyPath===e)}hasEmbeddedWithPropertyPath(e){return this.allEmbeddeds.some(t=>t.propertyPath===e)}findEmbeddedWithPropertyPath(e){return this.allEmbeddeds.find(t=>t.propertyPath===e)}mapPropertyPathsToColumns(e){return e.map(t=>{const n=this.findColumnWithPropertyPath(t);if(n==null)throw new Bn(t,this);return n})}extractRelationValuesFromEntity(e,t){const n=[];return t.forEach(i=>{const r=i.getEntityValue(e);Array.isArray(r)?r.forEach(a=>n.push([i,a,jn.getInverseEntityMetadata(a,i)])):r&&n.push([i,r,jn.getInverseEntityMetadata(r,i)])}),n}findInheritanceMetadata(e){if(this.inheritancePattern==="STI"&&this.childEntityMetadatas.length>0){let t;return this.discriminatorColumn&&(t=e[this.discriminatorColumn.propertyName]),this.childEntityMetadatas.find(n=>t===n.discriminatorValue||e.constructor===n.target)||this}return this}static getInverseEntityMetadata(e,t){return t.inverseEntityMetadata.findInheritanceMetadata(e)}static createPropertyPath(e,t,n=""){const i=[];return Object.keys(t).forEach(r=>{const a=n?n+"."+r:r;if(e.hasEmbeddedWithPropertyPath(a)){const c=this.createPropertyPath(e,t[r],a);i.push(...c)}else{const c=n?n+"."+r:r;i.push(c)}}),i}static difference(e,t){return e.filter(n=>!t.find(i=>ee.compareIds(n,i)))}static getValueMap(e,t,n){return t.reduce((i,r)=>{const a=r.getEntityValueMap(e,n);if(!(i===void 0||a===null||a===void 0))return ee.mergeDeep(i,a)},{})}build(){var i;const e=this.connection.namingStrategy,t=this.connection.options.entityPrefix,n=this.connection.options.entitySkipConstructor;this.engine=this.tableMetadataArgs.engine,this.database=this.tableMetadataArgs.type==="entity-child"&&this.parentEntityMetadata?this.parentEntityMetadata.database:this.tableMetadataArgs.database,this.tableMetadataArgs.schema?this.schema=this.tableMetadataArgs.schema:this.tableMetadataArgs.type==="entity-child"&&this.parentEntityMetadata?this.schema=this.parentEntityMetadata.schema:(i=this.connection.options)!=null&&i.hasOwnProperty("schema")&&(this.schema=this.connection.options.schema),this.givenTableName=this.tableMetadataArgs.type==="entity-child"&&this.parentEntityMetadata?this.parentEntityMetadata.givenTableName:this.tableMetadataArgs.name,this.synchronize=this.tableMetadataArgs.synchronize!==!1,this.targetName=typeof this.tableMetadataArgs.target=="function"?this.tableMetadataArgs.target.name:this.tableMetadataArgs.target,this.tableMetadataArgs.type==="closure-junction"?this.tableNameWithoutPrefix=e.closureJunctionTableName(this.givenTableName):this.tableMetadataArgs.type==="entity-child"&&this.parentEntityMetadata?this.tableNameWithoutPrefix=e.tableName(this.parentEntityMetadata.targetName,this.parentEntityMetadata.givenTableName):(this.tableNameWithoutPrefix=e.tableName(this.targetName,this.givenTableName),this.tableMetadataArgs.type==="junction"&&this.connection.driver.maxAliasLength&&this.connection.driver.maxAliasLength>0&&this.tableNameWithoutPrefix.length>this.connection.driver.maxAliasLength&&(this.tableNameWithoutPrefix=Op(this.tableNameWithoutPrefix,{separator:"_",segmentLength:3}))),this.tableName=t?e.prefixTableName(t,this.tableNameWithoutPrefix):this.tableNameWithoutPrefix,this.target=this.target?this.target:this.tableName,this.name=this.targetName?this.targetName:this.tableName,this.expression=this.tableMetadataArgs.expression,this.withoutRowid=this.tableMetadataArgs.withoutRowid===!0,this.tablePath=this.connection.driver.buildTableName(this.tableName,this.schema,this.database),this.orderBy=typeof this.tableMetadataArgs.orderBy=="function"?this.tableMetadataArgs.orderBy(this.propertiesMap):this.tableMetadataArgs.orderBy,n!==void 0&&(this.isAlwaysUsingConstructor=!n),this.isJunction=this.tableMetadataArgs.type==="closure-junction"||this.tableMetadataArgs.type==="junction",this.isClosureJunction=this.tableMetadataArgs.type==="closure-junction",this.comment=this.tableMetadataArgs.comment}registerColumn(e){this.ownColumns.indexOf(e)===-1&&(this.ownColumns.push(e),this.columns=this.embeddeds.reduce((t,n)=>t.concat(n.columnsFromTree),this.ownColumns),this.primaryColumns=this.columns.filter(t=>t.isPrimary),this.hasMultiplePrimaryKeys=this.primaryColumns.length>1,this.hasUUIDGeneratedColumns=this.columns.filter(t=>t.isGenerated||t.generationStrategy==="uuid").length>0,this.propertiesMap=this.createPropertiesMap(),this.childEntityMetadatas&&this.childEntityMetadatas.forEach(t=>t.registerColumn(e)))}createPropertiesMap(){const e={};return this.columns.forEach(t=>ee.mergeDeep(e,t.createValueMap(t.propertyPath))),this.relations.forEach(t=>ee.mergeDeep(e,t.createValueMap(t.propertyPath))),e}getInsertionReturningColumns(){return this.columns.filter(e=>e.default!==void 0||e.asExpression!==void 0||e.isGenerated||e.isCreateDate||e.isUpdateDate||e.isDeleteDate||e.isVersion)}}class Sf{constructor(e){this.queryRunner=e}async insert(e){let t=e.metadata.treeParentRelation.getEntityValue(e.entity);!t&&e.parentSubject&&e.parentSubject.entity&&(t=e.parentSubject.insertedValueSet?e.parentSubject.insertedValueSet:e.parentSubject.entity);const n=e.metadata.getEntityIdMap(t);let i="";n&&(i=await this.getEntityPath(e,n));const r=e.metadata.treeParentRelation.joinColumns.map(a=>a.referencedColumn.getEntityValue(e.insertedValueSet)).join("_");await this.queryRunner.manager.createQueryBuilder().update(e.metadata.target).set({[e.metadata.materializedPathColumn.propertyPath]:i+r+"."}).where(e.identifier).execute()}async update(e){let t=e.metadata.treeParentRelation.getEntityValue(e.entity);!t&&e.parentSubject&&e.parentSubject.entity&&(t=e.parentSubject.entity);let n=e.databaseEntity;!n&&t&&(n=e.metadata.treeChildrenRelation.getEntityValue(t).find(p=>Object.entries(e.identifier).every(([m,T])=>p[m]===T)));const i=e.metadata.treeParentRelation.getEntityValue(n),r=this.getEntityParentReferencedColumnMap(e,i),a=this.getEntityParentReferencedColumnMap(e,t);if(ee.compareIds(r,a))return;let c="";a&&(c=await this.getEntityPath(e,a));let l="";r&&(l=await this.getEntityPath(e,r)||"");const h=e.metadata.treeParentRelation.joinColumns.map(p=>p.referencedColumn.getEntityValue(n)).join("_"),f=e.metadata.materializedPathColumn.propertyPath;await this.queryRunner.manager.createQueryBuilder().update(e.metadata.target).set({[f]:()=>`REPLACE(${this.queryRunner.connection.driver.escape(f)}, '${l}${h}.', '${c}${h}.')`}).where(`${f} LIKE :path`,{path:`${l}${h}.%`}).execute()}getEntityParentReferencedColumnMap(e,t){if(t)return jn.getValueMap(t,e.metadata.treeParentRelation.joinColumns.map(n=>n.referencedColumn).filter(n=>n!=null),{skipNulls:!0})}getEntityPath(e,t){const n=e.metadata,i=(Array.isArray(t)?t:[t]).map(r=>n.ensureEntityIdMap(r));return this.queryRunner.manager.createQueryBuilder().select(e.metadata.targetName+"."+e.metadata.materializedPathColumn.propertyPath,"path").from(e.metadata.target,e.metadata.targetName).where(new ka(r=>{for(const a of i)r.orWhere(new ka(c=>c.where(a)))})).getRawOne().then(r=>r?r.path:"")}}class U0{constructor(e,t,n){this.hasExecutableOperations=!1,this.insertSubjects=[],this.updateSubjects=[],this.removeSubjects=[],this.softRemoveSubjects=[],this.recoverSubjects=[],this.queryRunner=e,this.allSubjects=t,this.options=n,this.validate(),this.recompute()}async execute(){let e;(!this.options||this.options.listeners!==!1)&&(e=this.broadcastBeforeEventsForAll(),e.promises.length>0&&await Promise.all(e.promises)),e&&e.count>0&&(this.insertSubjects.forEach(t=>t.recompute()),this.updateSubjects.forEach(t=>t.recompute()),this.removeSubjects.forEach(t=>t.recompute()),this.softRemoveSubjects.forEach(t=>t.recompute()),this.recoverSubjects.forEach(t=>t.recompute()),this.recompute()),this.insertSubjects=new Af(this.insertSubjects).sort("insert"),await this.executeInsertOperations(),this.updateSubjects=this.allSubjects.filter(t=>t.mustBeUpdated),await this.executeUpdateOperations(),this.removeSubjects=new Af(this.removeSubjects).sort("delete"),await this.executeRemoveOperations(),this.softRemoveSubjects=this.allSubjects.filter(t=>t.mustBeSoftRemoved),await this.executeSoftRemoveOperations(),this.recoverSubjects=this.allSubjects.filter(t=>t.mustBeRecovered),await this.executeRecoverOperations(),this.updateSpecialColumnsInPersistedEntities(),(!this.options||this.options.listeners!==!1)&&(e=this.broadcastAfterEventsForAll(),e.promises.length>0&&await Promise.all(e.promises))}validate(){this.allSubjects.forEach(e=>{if(e.mustBeUpdated&&e.mustBeRemoved)throw new zC(e)})}recompute(){new F0().compute(this.allSubjects),this.insertSubjects=this.allSubjects.filter(e=>e.mustBeInserted),this.updateSubjects=this.allSubjects.filter(e=>e.mustBeUpdated),this.removeSubjects=this.allSubjects.filter(e=>e.mustBeRemoved),this.softRemoveSubjects=this.allSubjects.filter(e=>e.mustBeSoftRemoved),this.recoverSubjects=this.allSubjects.filter(e=>e.mustBeRecovered),this.hasExecutableOperations=this.insertSubjects.length>0||this.updateSubjects.length>0||this.removeSubjects.length>0||this.softRemoveSubjects.length>0||this.recoverSubjects.length>0}broadcastBeforeEventsForAll(){const e=new Rn;return this.insertSubjects.length&&this.insertSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastBeforeInsertEvent(e,t.metadata,t.entity)),this.updateSubjects.length&&this.updateSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastBeforeUpdateEvent(e,t.metadata,t.entity,t.databaseEntity,t.diffColumns,t.diffRelations)),this.removeSubjects.length&&this.removeSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastBeforeRemoveEvent(e,t.metadata,t.entity,t.databaseEntity,t.identifier)),this.softRemoveSubjects.length&&this.softRemoveSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastBeforeSoftRemoveEvent(e,t.metadata,t.entity,t.databaseEntity,t.identifier)),this.recoverSubjects.length&&this.recoverSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastBeforeRecoverEvent(e,t.metadata,t.entity,t.databaseEntity,t.identifier)),e}broadcastAfterEventsForAll(){const e=new Rn;return this.insertSubjects.length&&this.insertSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastAfterInsertEvent(e,t.metadata,t.entity,t.identifier)),this.updateSubjects.length&&this.updateSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastAfterUpdateEvent(e,t.metadata,t.entity,t.databaseEntity,t.diffColumns,t.diffRelations)),this.removeSubjects.length&&this.removeSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastAfterRemoveEvent(e,t.metadata,t.entity,t.databaseEntity,t.identifier)),this.softRemoveSubjects.length&&this.softRemoveSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastAfterSoftRemoveEvent(e,t.metadata,t.entity,t.databaseEntity,t.identifier)),this.recoverSubjects.length&&this.recoverSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastAfterRecoverEvent(e,t.metadata,t.entity,t.databaseEntity,t.identifier)),e}async executeInsertOperations(){const[e,t]=this.groupBulkSubjects(this.insertSubjects,"insert");for(const n of t){const i=e[n],r=[],a=[],c=[];if(this.queryRunner.connection.driver.options.type==="mongodb"?i.forEach(l=>{l.metadata.createDateColumn&&l.entity&&(l.entity[l.metadata.createDateColumn.databaseName]=new Date),l.metadata.updateDateColumn&&l.entity&&(l.entity[l.metadata.updateDateColumn.databaseName]=new Date),l.createValueSetAndPopChangeMap(),a.push(l),r.push(l.entity)}):this.queryRunner.connection.driver.options.type==="oracle"?i.forEach(l=>{c.push(l)}):i.forEach(l=>{l.changeMaps.length===0||l.metadata.treeType||this.queryRunner.connection.driver.options.type==="oracle"||this.queryRunner.connection.driver.options.type==="sap"?c.push(l):(a.push(l),r.push(l.createValueSetAndPopChangeMap()))}),$.isMongoEntityManager(this.queryRunner.manager)){const l=await this.queryRunner.manager.insert(i[0].metadata.target,r);i.forEach((h,f)=>{h.identifier=l.identifiers[f],h.generatedMap=l.generatedMaps[f],h.insertedValueSet=r[f]})}else{if(r.length>0){const l=await this.queryRunner.manager.createQueryBuilder().insert().into(i[0].metadata.target).values(r).updateEntity(!(this.options&&this.options.reload===!1)).callListeners(!1).execute();a.forEach((h,f)=>{h.identifier=l.identifiers[f],h.generatedMap=l.generatedMaps[f],h.insertedValueSet=r[f]})}if(c.length>0)for(const l of c)l.insertedValueSet=l.createValueSetAndPopChangeMap(),l.metadata.treeType==="nested-set"&&await new zc(this.queryRunner).insert(l),await this.queryRunner.manager.createQueryBuilder().insert().into(l.metadata.target).values(l.insertedValueSet).updateEntity(!(this.options&&this.options.reload===!1)).callListeners(!1).execute().then(h=>{l.identifier=h.identifiers[0],l.generatedMap=h.generatedMaps[0]}),l.metadata.treeType==="closure-table"?await new Kc(this.queryRunner).insert(l):l.metadata.treeType==="materialized-path"&&await new Sf(this.queryRunner).insert(l)}i.forEach(l=>{l.generatedMap&&l.metadata.columns.forEach(h=>{const f=h.getEntityValue(l.generatedMap);if(f!=null){const p=this.queryRunner.connection.driver.prepareHydratedValue(f,h);h.setEntityValue(l.generatedMap,p)}})})}}async executeUpdateOperations(){const e=async r=>{if(!r.identifier)throw new Ea(r);if($.isMongoEntityManager(this.queryRunner.manager)){const a=this.cloneMongoSubjectEntity(r);r.metadata.objectIdColumn&&r.metadata.objectIdColumn.propertyName&&delete a[r.metadata.objectIdColumn.propertyName],r.metadata.createDateColumn&&r.metadata.createDateColumn.propertyName&&delete a[r.metadata.createDateColumn.propertyName],r.metadata.updateDateColumn&&r.metadata.updateDateColumn.propertyName&&(a[r.metadata.updateDateColumn.propertyName]=new Date),await this.queryRunner.manager.update(r.metadata.target,r.identifier,a)}else{const a=r.createValueSetAndPopChangeMap();switch(r.metadata.treeType){case"nested-set":await new zc(this.queryRunner).update(r);break;case"closure-table":await new Kc(this.queryRunner).update(r);break;case"materialized-path":await new Sf(this.queryRunner).update(r);break}const c=this.queryRunner.manager.createQueryBuilder().update(r.metadata.target).set(a).updateEntity(!(this.options&&this.options.reload===!1)).callListeners(!1);r.entity?c.whereEntity(r.identifier):c.where(r.identifier);const h=(await c.execute()).generatedMaps[0];h&&(r.metadata.columns.forEach(f=>{const p=f.getEntityValue(h);if(p!=null){const m=this.queryRunner.connection.driver.prepareHydratedValue(p,f);f.setEntityValue(h,m)}}),r.generatedMap||(r.generatedMap={}),Object.assign(r.generatedMap,h))}},t=[],n=[];for(const r of this.updateSubjects)r.metadata.treeType==="nested-set"?t.push(r):n.push(r);const i=async()=>{for(const r of t)await e(r)};await Promise.all([...n.map(e),i()])}async executeRemoveOperations(){const[e,t]=this.groupBulkSubjects(this.removeSubjects,"delete");for(const n of t){const i=e[n],r=i.map(a=>{if(!a.identifier)throw new Ea(a);return a.identifier});if($.isMongoEntityManager(this.queryRunner.manager))await this.queryRunner.manager.delete(i[0].metadata.target,r);else{switch(i[0].metadata.treeType){case"nested-set":await new zc(this.queryRunner).remove(i);break;case"closure-table":await new Kc(this.queryRunner).remove(i);break}await this.queryRunner.manager.createQueryBuilder().delete().from(i[0].metadata.target).where(r).callListeners(!1).execute()}}}cloneMongoSubjectEntity(e){const t={};if(e.entity)for(const n of e.metadata.columns)ee.mergeDeep(t,n.getEntityValueMap(e.entity));return t}async executeSoftRemoveOperations(){await Promise.all(this.softRemoveSubjects.map(async e=>{if(!e.identifier)throw new Ea(e);let t;if($.isMongoEntityManager(this.queryRunner.manager)){const n=this.cloneMongoSubjectEntity(e);e.metadata.objectIdColumn&&e.metadata.objectIdColumn.propertyName&&delete n[e.metadata.objectIdColumn.propertyName],e.metadata.createDateColumn&&e.metadata.createDateColumn.propertyName&&delete n[e.metadata.createDateColumn.propertyName],e.metadata.updateDateColumn&&e.metadata.updateDateColumn.propertyName&&(n[e.metadata.updateDateColumn.propertyName]=new Date),e.metadata.deleteDateColumn&&e.metadata.deleteDateColumn.propertyName&&(n[e.metadata.deleteDateColumn.propertyName]=new Date),t=await this.queryRunner.manager.update(e.metadata.target,e.identifier,n)}else{const n=this.queryRunner.manager.createQueryBuilder().softDelete().from(e.metadata.target).updateEntity(!(this.options&&this.options.reload===!1)).callListeners(!1);e.entity?n.whereEntity(e.identifier):n.where(e.identifier),t=await n.execute()}e.generatedMap=t.generatedMaps[0],e.generatedMap&&e.metadata.columns.forEach(n=>{const i=n.getEntityValue(e.generatedMap);if(i!=null){const r=this.queryRunner.connection.driver.prepareHydratedValue(i,n);n.setEntityValue(e.generatedMap,r)}})}))}async executeRecoverOperations(){await Promise.all(this.recoverSubjects.map(async e=>{if(!e.identifier)throw new Ea(e);let t;if($.isMongoEntityManager(this.queryRunner.manager)){const n=this.cloneMongoSubjectEntity(e);e.metadata.objectIdColumn&&e.metadata.objectIdColumn.propertyName&&delete n[e.metadata.objectIdColumn.propertyName],e.metadata.createDateColumn&&e.metadata.createDateColumn.propertyName&&delete n[e.metadata.createDateColumn.propertyName],e.metadata.updateDateColumn&&e.metadata.updateDateColumn.propertyName&&(n[e.metadata.updateDateColumn.propertyName]=new Date),e.metadata.deleteDateColumn&&e.metadata.deleteDateColumn.propertyName&&(n[e.metadata.deleteDateColumn.propertyName]=null),t=await this.queryRunner.manager.update(e.metadata.target,e.identifier,n)}else{const n=this.queryRunner.manager.createQueryBuilder().restore().from(e.metadata.target).updateEntity(!(this.options&&this.options.reload===!1)).callListeners(!1);e.entity?n.whereEntity(e.identifier):n.where(e.identifier),t=await n.execute()}e.generatedMap=t.generatedMaps[0],e.generatedMap&&e.metadata.columns.forEach(n=>{const i=n.getEntityValue(e.generatedMap);if(i!=null){const r=this.queryRunner.connection.driver.prepareHydratedValue(i,n);n.setEntityValue(e.generatedMap,r)}})}))}updateSpecialColumnsInPersistedEntities(){this.insertSubjects.length&&this.updateSpecialColumnsInInsertedAndUpdatedEntities(this.insertSubjects),this.updateSubjects.length&&this.updateSpecialColumnsInInsertedAndUpdatedEntities(this.updateSubjects),this.softRemoveSubjects.length&&this.updateSpecialColumnsInInsertedAndUpdatedEntities(this.softRemoveSubjects),this.recoverSubjects.length&&this.updateSpecialColumnsInInsertedAndUpdatedEntities(this.recoverSubjects),this.removeSubjects.length&&this.removeSubjects.forEach(e=>{e.entity&&e.metadata.primaryColumns.forEach(t=>{t.setEntityValue(e.entity,void 0)})}),this.allSubjects.forEach(e=>{e.entity&&(e.metadata.relationIds.forEach(t=>{t.setValue(e.entity)}),$.isMongoEntityManager(this.queryRunner.manager)&&e.metadata.objectIdColumn&&e.metadata.objectIdColumn.databaseName&&e.metadata.objectIdColumn.databaseName!==e.metadata.objectIdColumn.propertyName&&delete e.entity[e.metadata.objectIdColumn.databaseName])})}updateSpecialColumnsInInsertedAndUpdatedEntities(e){e.forEach(t=>{t.entity&&(t.metadata.columns.forEach(n=>{t.metadata.childEntityMetadatas.length>0&&t.metadata.childEntityMetadatas.map(i=>i.target).indexOf(n.target)!==-1||n.isVirtual||n.isDeleteDate||(n.isNullable&&n.getEntityValue(t.entity)===void 0&&n.setEntityValue(t.entity,null),t.updatedRelationMaps.length>0&&t.updatedRelationMaps.forEach(i=>{i.relation.joinColumns.forEach(r=>{r.isVirtual!==!0&&r.setEntityValue(t.entity,Ce.isObject(i.value)?r.referencedColumn.getEntityValue(i.value):i.value)})}))}),t.generatedMap&&this.queryRunner.manager.merge(t.metadata.target,t.entity,t.generatedMap))})}groupBulkSubjects(e,t){const n={},i=[],r=e.some(c=>c.metadata.getInsertionReturningColumns().length>0),a=t==="delete"||this.queryRunner.connection.driver.isReturningSqlSupported("insert")||r===!1;return e.forEach((c,l)=>{const h=a||c.metadata.isJunction?c.metadata.name:c.metadata.name+"_"+l;n[h]?n[h].push(c):(n[h]=[c],i.push(h))}),[n,i]}}class Ni{constructor(e){this["@instanceof"]=Symbol.for("Subject"),this.identifier=void 0,this.entityWithFulfilledIds=void 0,this.databaseEntityLoaded=!1,this.changeMaps=[],this.canBeInserted=!1,this.canBeUpdated=!1,this.mustBeRemoved=!1,this.canBeSoftRemoved=!1,this.canBeRecovered=!1,this.updatedRelationMaps=[],this.diffColumns=[],this.diffRelations=[],this.metadata=e.metadata,this.entity=e.entity,this.parentSubject=e.parentSubject,e.canBeInserted!==void 0&&(this.canBeInserted=e.canBeInserted),e.canBeUpdated!==void 0&&(this.canBeUpdated=e.canBeUpdated),e.mustBeRemoved!==void 0&&(this.mustBeRemoved=e.mustBeRemoved),e.canBeSoftRemoved!==void 0&&(this.canBeSoftRemoved=e.canBeSoftRemoved),e.canBeRecovered!==void 0&&(this.canBeRecovered=e.canBeRecovered),e.identifier!==void 0&&(this.identifier=e.identifier),e.changeMaps!==void 0&&this.changeMaps.push(...e.changeMaps),this.recompute()}get mustBeInserted(){return this.canBeInserted&&!this.databaseEntity}get mustBeUpdated(){return this.canBeUpdated&&this.identifier&&(this.databaseEntityLoaded===!1||this.databaseEntityLoaded&&this.databaseEntity)&&this.changeMaps.some(e=>!e.column||e.column.isUpdate)}get mustBeSoftRemoved(){return this.canBeSoftRemoved&&this.identifier&&(this.databaseEntityLoaded===!1||this.databaseEntityLoaded&&this.databaseEntity)}get mustBeRecovered(){return this.canBeRecovered&&this.identifier&&(this.databaseEntityLoaded===!1||this.databaseEntityLoaded&&this.databaseEntity)}createValueSetAndPopChangeMap(){const e=[],t=this.changeMaps.reduce((n,i)=>{let r=i.value;$.isSubject(r)&&(r=r.insertedValueSet?r.insertedValueSet:r.entity);let a;if(this.metadata.isJunction&&i.column)a=i.column.createValueMap(i.column.referencedColumn.getEntityValue(r));else if(i.column)a=i.column.createValueMap(r);else if(i.relation)if(Ce.isObject(r)&&!Buffer.isBuffer(r)){const c=i.relation.getRelationIdMap(r);if(c===void 0)return e.push(i),this.canBeUpdated=!0,n;a=i.relation.createValueMap(c),this.updatedRelationMaps.push({relation:i.relation,value:c})}else a=i.relation.createValueMap(r),this.updatedRelationMaps.push({relation:i.relation,value:r});return ee.mergeDeep(n,a),n},{});return this.changeMaps=e,t}recompute(){this.entity?(this.entityWithFulfilledIds=Object.assign({},this.entity),this.parentSubject&&this.metadata.primaryColumns.forEach(e=>{if(e.relationMetadata&&e.relationMetadata.inverseEntityMetadata===this.parentSubject.metadata){const t=e.referencedColumn.getEntityValue(this.parentSubject.entity);e.setEntityValue(this.entityWithFulfilledIds,t)}}),this.identifier=this.metadata.getEntityIdMap(this.entityWithFulfilledIds)):this.databaseEntity&&(this.identifier=this.metadata.getEntityIdMap(this.databaseEntity))}}class k0{constructor(e){this.subjects=e}build(){this.subjects.forEach(e=>{e.metadata.oneToManyRelations.forEach(t=>{t.persistenceEnabled!==!1&&this.buildForSubjectRelation(e,t)})})}buildForSubjectRelation(e,t){var a;let n=[];if(e.databaseEntity){const c=t.getEntityValue(e.databaseEntity);c&&(n=c.map(l=>t.inverseEntityMetadata.getEntityIdMap(l)))}let i=t.getEntityValue(e.entity);if(i===null&&(i=[]),i===void 0)return;const r=[];i.forEach(c=>{let l=t.inverseEntityMetadata.getEntityIdMap(c),h=this.subjects.find(p=>p.entity===c);if(h&&(l=h.identifier),!l){if(!h)return;h.changeMaps.push({relation:t.inverseRelation,value:e});return}n.find(p=>ee.compareIds(l,p))||(h||(h=new Ni({metadata:t.inverseEntityMetadata,parentSubject:e,canBeUpdated:!0,identifier:l}),this.subjects.push(h)),h.changeMaps.push({relation:t.inverseRelation,value:e})),r.push(l)}),((a=t.inverseRelation)==null?void 0:a.orphanedRowAction)!=="disable"&&jn.difference(n,r).forEach(c=>{const l=new Ni({metadata:t.inverseEntityMetadata,parentSubject:e,identifier:c});!t.inverseRelation||t.inverseRelation.orphanedRowAction==="nullify"?(l.canBeUpdated=!0,l.changeMaps=[{relation:t.inverseRelation,value:null}]):t.inverseRelation.orphanedRowAction==="delete"?l.mustBeRemoved=!0:t.inverseRelation.orphanedRowAction==="soft-delete"&&(l.canBeSoftRemoved=!0),this.subjects.push(l)})}}class j0{constructor(e){this.subjects=e}build(){this.subjects.forEach(e=>{e.metadata.oneToOneRelations.forEach(t=>{t.isOwning||t.persistenceEnabled===!1||this.buildForSubjectRelation(e,t)})})}buildForSubjectRelation(e,t){let n;e.databaseEntity&&(n=t.getEntityValue(e.databaseEntity));const i=t.getEntityValue(e.entity);if(i===void 0)return;if(i===null){if(n){const l=new Ni({metadata:t.inverseEntityMetadata,parentSubject:e,canBeUpdated:!0,identifier:n,changeMaps:[{relation:t.inverseRelation,value:null}]});this.subjects.push(l)}return}let r=t.inverseEntityMetadata.getEntityIdMap(i),a=this.subjects.find(l=>!!l.entity&&l.entity===i);if(a&&(r=a.identifier),!r){if(!a)return;a.changeMaps.push({relation:t.inverseRelation,value:e})}n&&ee.compareIds(r,n)||(a||(a=new Ni({metadata:t.inverseEntityMetadata,canBeUpdated:!0,identifier:r}),this.subjects.push(a)),a.changeMaps.push({relation:t.inverseRelation,value:e}))}}class Rf{constructor(e){this.subjects=e}build(){this.subjects.forEach(e=>{e.entity&&e.metadata.manyToManyRelations.forEach(t=>{t.persistenceEnabled!==!1&&this.buildForSubjectRelation(e,t)})})}buildForAllRemoval(e){e.databaseEntity&&e.metadata.manyToManyRelations.forEach(t=>{if(t.persistenceEnabled===!1)return;t.getEntityValue(e.databaseEntity).forEach(i=>{const r=new Ni({metadata:t.junctionEntityMetadata,parentSubject:e,mustBeRemoved:!0,identifier:this.buildJunctionIdentifier(e,t,i)});this.subjects.push(r)})})}buildForSubjectRelation(e,t){let n=[];if(e.databaseEntity){const c=t.getEntityValue(e.databaseEntity);c&&(n=c.map(l=>t.inverseEntityMetadata.getEntityIdMap(l)))}let i=t.getEntityValue(e.entity);if(i===null&&(i=[]),!Array.isArray(i))return;i.forEach(c=>{let l=t.inverseEntityMetadata.getEntityIdMap(c);const h=this.subjects.find(A=>A.entity===c);if(h&&(l=h.identifier),!l&&!h||n.find(A=>ee.compareIds(A,l)))return;const p=t.isOwning?e:h||c,m=t.isOwning?h||c:e,T=new Ni({metadata:t.junctionEntityMetadata,parentSubject:e,canBeInserted:!0});this.subjects.push(T),t.junctionEntityMetadata.ownerColumns.forEach(A=>{T.changeMaps.push({column:A,value:p})}),t.junctionEntityMetadata.inverseColumns.forEach(A=>{T.changeMaps.push({column:A,value:m})})});const r=[];i.forEach(c=>{let l=t.inverseEntityMetadata.getEntityIdMap(c);const h=this.subjects.find(f=>f.entity===c);h&&(l=h.identifier),l!=null&&r.push(l)}),n.filter(c=>!r.find(l=>ee.compareIds(l,c))).forEach(c=>{const l=new Ni({metadata:t.junctionEntityMetadata,parentSubject:e,mustBeRemoved:!0,identifier:this.buildJunctionIdentifier(e,t,c)});this.subjects.push(l)})}buildJunctionIdentifier(e,t,n){const i=t.isOwning?e.entity:n,r=t.isOwning?n:e.entity,a={};return t.junctionEntityMetadata.ownerColumns.forEach(c=>{ee.mergeDeep(a,c.createValueMap(c.referencedColumn.getEntityValue(i)))}),t.junctionEntityMetadata.inverseColumns.forEach(c=>{ee.mergeDeep(a,c.createValueMap(c.referencedColumn.getEntityValue(r)))}),a}}class V0{constructor(e,t){this.queryRunner=e,this.subjects=t}async load(e){const t=this.groupByEntityTargets().map(async n=>{const i=[],r=[];if(n.subjects.forEach(h=>{h.databaseEntity||!h.identifier||(i.push(h.identifier),r.push(h))}),!i.length)return;const a=[];e==="save"||e==="soft-remove"||e==="recover"?n.subjects.forEach(h=>{h.metadata.relations.forEach(f=>{f.getEntityValue(h.entityWithFulfilledIds)!==void 0&&a.indexOf(f.propertyPath)===-1&&a.push(f.propertyPath)})}):a.push(...n.subjects[0].metadata.manyToManyRelations.map(h=>h.propertyPath));const c={loadEagerRelations:!1,loadRelationIds:{relations:a,disableMixedMap:!0},withDeleted:!0};let l=[];this.queryRunner.connection.driver.options.type==="mongodb"?l=await this.queryRunner.manager.getRepository(n.target).findByIds(i,c):l=await this.queryRunner.manager.getRepository(n.target).createQueryBuilder().setFindOptions(c).whereInIds(i).getMany(),l.forEach(h=>{const f=r[0].metadata.getEntityIdMap(h);r.forEach(p=>{p.databaseEntity||ee.compareIds(p.identifier,f)&&(p.databaseEntity=h)})});for(const h of r)h.databaseEntityLoaded=!0});await Promise.all(t)}groupByEntityTargets(){return this.subjects.reduce((e,t)=>{let n=e.find(i=>i.target===t.metadata.target);return n||(n={target:t.metadata.target,subjects:[]},e.push(n)),n.subjects.push(t),e},[])}}class Q0{constructor(e){this.allSubjects=e}build(e,t){e.metadata.extractRelationValuesFromEntity(e.entity,e.metadata.relations).forEach(([n,i,r])=>{if(i==null||!n.isCascadeInsert&&!n.isCascadeUpdate&&!n.isCascadeSoftRemove&&!n.isCascadeRecover||!Ce.isObject(i))return;const a=this.findByPersistEntityLike(r.target,i);if(a){a.canBeInserted===!1&&(a.canBeInserted=n.isCascadeInsert===!0&&t==="save"),a.canBeUpdated===!1&&(a.canBeUpdated=n.isCascadeUpdate===!0&&t==="save"),a.canBeSoftRemoved===!1&&(a.canBeSoftRemoved=n.isCascadeSoftRemove===!0&&t==="soft-remove"),a.canBeRecovered===!1&&(a.canBeRecovered=n.isCascadeRecover===!0&&t==="recover");return}const c=new Ni({metadata:r,parentSubject:e,entity:i,canBeInserted:n.isCascadeInsert===!0&&t==="save",canBeUpdated:n.isCascadeUpdate===!0&&t==="save",canBeSoftRemoved:n.isCascadeSoftRemove===!0&&t==="soft-remove",canBeRecovered:n.isCascadeRecover===!0&&t==="recover"});this.allSubjects.push(c),this.build(c,t)})}findByPersistEntityLike(e,t){return this.allSubjects.find(n=>n.entity?n.entity===t?!0:n.metadata.target===e&&n.metadata.compareEntities(n.entityWithFulfilledIds,t):!1)}}class ba{constructor(e,t,n,i,r,a){this.connection=e,this.queryRunner=t,this.mode=n,this.target=i,this.entity=r,this.options=a}async execute(){if(!this.entity||typeof this.entity!="object")return Promise.reject(new IC(this.mode,this.entity));await Promise.resolve();const e=this.queryRunner||this.connection.createQueryRunner(),t=e.data;this.options&&this.options.data&&(e.data=this.options.data);try{const n=Array.isArray(this.entity)?this.entity:[this.entity],i=this.options&&this.options.chunk&&this.options.chunk>0?ee.chunk(n,this.options.chunk):[n],a=(await Promise.all(i.map(async l=>{const h=[];l.forEach(p=>{const m=this.target?this.target:p.constructor;if(m===Object)throw new MC(this.mode);const T=this.connection.getMetadata(m).findInheritanceMetadata(p);h.push(new Ni({metadata:T,entity:p,canBeInserted:this.mode==="save",canBeUpdated:this.mode==="save",mustBeRemoved:this.mode==="remove",canBeSoftRemoved:this.mode==="soft-remove",canBeRecovered:this.mode==="recover"}))});const f=new Q0(h);return h.forEach(p=>{f.build(p,this.mode)}),await new V0(e,h).load(this.mode),this.mode==="save"||this.mode==="soft-remove"||this.mode==="recover"?(new k0(h).build(),new j0(h).build(),new Rf(h).build()):h.forEach(p=>{p.mustBeRemoved&&new Rf(h).buildForAllRemoval(p)}),new U0(e,h,this.options)}))).filter(l=>l.hasExecutableOperations);if(a.length===0)return;let c=!1;try{e.isTransactionActive||this.connection.driver.transactionSupport!=="none"&&(!this.options||this.options.transaction!==!1)&&(c=!0,await e.startTransaction());for(const l of a)await l.execute();c===!0&&await e.commitTransaction()}catch(l){if(c)try{await e.rollbackTransaction()}catch{}throw l}}finally{e.data=t,this.queryRunner||await e.release()}}}class kp{constructor(e,t){this["@instanceof"]=Symbol.for("EntityManager"),this.repositories=new Map,this.treeRepositories=[],this.plainObjectToEntityTransformer=new I0,this.connection=e,t&&(this.queryRunner=t,Ce.assign(this.queryRunner,{manager:this}))}async transaction(e,t){const n=typeof e=="string"?e:void 0,i=typeof e=="function"?e:t;if(!i)throw new _("Transaction method requires callback in second parameter if isolation level is supplied.");if(this.queryRunner&&this.queryRunner.isReleased)throw new yp;const r=this.queryRunner||this.connection.createQueryRunner();try{await r.startTransaction(n);const a=await i(r.manager);return await r.commitTransaction(),a}catch(a){try{await r.rollbackTransaction()}catch{}throw a}finally{this.queryRunner||await r.release()}}async query(e,t){return this.connection.query(e,t,this.queryRunner)}async sql(e,...t){const{query:n,parameters:i}=oo({driver:this.connection.driver,strings:e,expressions:t});return await this.query(n,i)}createQueryBuilder(e,t,n){return t?this.connection.createQueryBuilder(e,t,n||this.queryRunner):this.connection.createQueryBuilder(e||n||this.queryRunner)}hasId(e,t){const n=arguments.length===2?e:e.constructor,i=arguments.length===2?t:e;return this.connection.getMetadata(n).hasId(i)}getId(e,t){const n=arguments.length===2?e:e.constructor,i=arguments.length===2?t:e;return this.connection.getMetadata(n).getEntityIdMixedMap(i)}create(e,t){const n=this.connection.getMetadata(e);if(!t)return n.create(this.queryRunner);if(Array.isArray(t))return t.map(r=>this.create(e,r));const i=n.create(this.queryRunner);return this.plainObjectToEntityTransformer.transform(i,t,n,!0),i}merge(e,t,...n){const i=this.connection.getMetadata(e);return n.forEach(r=>this.plainObjectToEntityTransformer.transform(t,r,i)),t}async preload(e,t){const n=this.connection.getMetadata(e),r=await new q0(this.connection.manager).transform(t,n);if(r)return this.merge(e,r,t)}save(e,t,n){let i=arguments.length>1&&(typeof e=="function"||$.isEntitySchema(e)||typeof e=="string")?e:void 0;const r=i?t:e,a=i?n:t;return $.isEntitySchema(i)&&(i=i.options.name),Array.isArray(r)&&r.length===0?Promise.resolve(r):new ba(this.connection,this.queryRunner,"save",i,r,a).execute().then(()=>r)}remove(e,t,n){const i=arguments.length>1&&(typeof e=="function"||$.isEntitySchema(e)||typeof e=="string")?e:void 0,r=i?t:e,a=i?n:t;return Array.isArray(r)&&r.length===0?Promise.resolve(r):new ba(this.connection,this.queryRunner,"remove",i,r,a).execute().then(()=>r)}softRemove(e,t,n){let i=arguments.length>1&&(typeof e=="function"||$.isEntitySchema(e)||typeof e=="string")?e:void 0;const r=i?t:e,a=i?n:t;return $.isEntitySchema(i)&&(i=i.options.name),Array.isArray(r)&&r.length===0?Promise.resolve(r):new ba(this.connection,this.queryRunner,"soft-remove",i,r,a).execute().then(()=>r)}recover(e,t,n){let i=arguments.length>1&&(typeof e=="function"||$.isEntitySchema(e)||typeof e=="string")?e:void 0;const r=i?t:e,a=i?n:t;return $.isEntitySchema(i)&&(i=i.options.name),Array.isArray(r)&&r.length===0?Promise.resolve(r):new ba(this.connection,this.queryRunner,"recover",i,r,a).execute().then(()=>r)}async insert(e,t){return this.createQueryBuilder().insert().into(e).values(t).execute()}async upsert(e,t,n){const i=this.connection.getMetadata(e);let r;Array.isArray(n)?r={conflictPaths:n}:r=n;let a;Array.isArray(t)?a=t:a=[t];const c=i.mapPropertyPathsToColumns(Array.isArray(r.conflictPaths)?r.conflictPaths:Object.keys(r.conflictPaths)),l=i.columns.filter(h=>!c.includes(h)&&a.some(f=>typeof h.getEntityValue(f)<"u"));return this.createQueryBuilder().insert().into(e).values(a).orUpdate([...c,...l].map(h=>h.databaseName),c.map(h=>h.databaseName),{skipUpdateIfNoValuesChanged:r.skipUpdateIfNoValuesChanged,indexPredicate:r.indexPredicate,upsertType:r.upsertType||this.connection.driver.supportedUpsertTypes[0]}).execute()}update(e,t,n){return ee.isCriteriaNullOrEmpty(t)?Promise.reject(new _("Empty criteria(s) are not allowed for the update method.")):ee.isPrimitiveCriteria(t)?this.createQueryBuilder().update(e).set(n).whereInIds(t).execute():this.createQueryBuilder().update(e).set(n).where(t).execute()}updateAll(e,t){return this.createQueryBuilder().update(e).set(t).execute()}delete(e,t){return ee.isCriteriaNullOrEmpty(t)?Promise.reject(new _("Empty criteria(s) are not allowed for the delete method.")):ee.isPrimitiveCriteria(t)?this.createQueryBuilder().delete().from(e).whereInIds(t).execute():this.createQueryBuilder().delete().from(e).where(t).execute()}deleteAll(e){return this.createQueryBuilder().delete().from(e).execute()}softDelete(e,t){return ee.isCriteriaNullOrEmpty(t)?Promise.reject(new _("Empty criteria(s) are not allowed for the softDelete method.")):ee.isPrimitiveCriteria(t)?this.createQueryBuilder().softDelete().from(e).whereInIds(t).execute():this.createQueryBuilder().softDelete().from(e).where(t).execute()}restore(e,t){return ee.isCriteriaNullOrEmpty(t)?Promise.reject(new _("Empty criteria(s) are not allowed for the restore method.")):ee.isPrimitiveCriteria(t)?this.createQueryBuilder().restore().from(e).whereInIds(t).execute():this.createQueryBuilder().restore().from(e).where(t).execute()}exists(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,kt.extractFindManyOptionsAlias(t)||n.name).setFindOptions(t||{}).getExists()}async existsBy(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,n.name).setFindOptions({where:t}).getExists()}count(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,kt.extractFindManyOptionsAlias(t)||n.name).setFindOptions(t||{}).getCount()}countBy(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,n.name).setFindOptions({where:t}).getCount()}sum(e,t,n){return this.callAggregateFun(e,"SUM",t,n)}average(e,t,n){return this.callAggregateFun(e,"AVG",t,n)}minimum(e,t,n){return this.callAggregateFun(e,"MIN",t,n)}maximum(e,t,n){return this.callAggregateFun(e,"MAX",t,n)}async callAggregateFun(e,t,n,i={}){const r=this.connection.getMetadata(e),a=r.columns.find(l=>l.propertyPath===n);if(!a)throw new _(`Column "${n}" was not found in table "${r.name}"`);const c=await this.createQueryBuilder(e,r.name).setFindOptions({where:i}).select(`${t}(${this.connection.driver.escape(a.databaseName)})`,t).getRawOne();return c[t]===null?null:parseFloat(c[t])}async find(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,kt.extractFindManyOptionsAlias(t)||n.name).setFindOptions(t||{}).getMany()}async findBy(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,n.name).setFindOptions({where:t}).getMany()}findAndCount(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,kt.extractFindManyOptionsAlias(t)||n.name).setFindOptions(t||{}).getManyAndCount()}findAndCountBy(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,n.name).setFindOptions({where:t}).getManyAndCount()}async findByIds(e,t){if(!t.length)return Promise.resolve([]);const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,n.name).andWhereInIds(t).getMany()}async findOne(e,t){let i=this.connection.getMetadata(e).name;if(t&&t.join&&(i=t.join.alias),!t.where)throw new Error("You must provide selection conditions in order to find a single row.");return this.createQueryBuilder(e,i).setFindOptions({...t,take:1}).getOne()}async findOneBy(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,n.name).setFindOptions({where:t,take:1}).getOne()}async findOneById(e,t){const n=this.connection.getMetadata(e);return this.createQueryBuilder(e,n.name).setFindOptions({take:1}).whereInIds(n.ensureEntityIdMap(t)).getOne()}async findOneOrFail(e,t){return this.findOne(e,t).then(n=>n===null?Promise.reject(new pu(e,t)):Promise.resolve(n))}async findOneByOrFail(e,t){return this.findOneBy(e,t).then(n=>n===null?Promise.reject(new pu(e,t)):Promise.resolve(n))}async clear(e){const t=this.connection.getMetadata(e),n=this.queryRunner||this.connection.createQueryRunner();try{return await n.clearTable(t.tablePath)}finally{this.queryRunner||await n.release()}}async increment(e,t,n,i){const r=this.connection.getMetadata(e),a=r.findColumnWithPropertyPath(n);if(!a)throw new _(`Column ${n} was not found in ${r.targetName} entity.`);if(isNaN(Number(i)))throw new _(`Value "${i}" is not a number.`);const c=n.split(".").reduceRight((l,h)=>({[h]:l}),()=>this.connection.driver.escape(a.databaseName)+" + "+i);return this.createQueryBuilder(e,"entity").update(e).set(c).where(t).execute()}async decrement(e,t,n,i){const r=this.connection.getMetadata(e),a=r.findColumnWithPropertyPath(n);if(!a)throw new _(`Column ${n} was not found in ${r.targetName} entity.`);if(isNaN(Number(i)))throw new _(`Value "${i}" is not a number.`);const c=n.split(".").reduceRight((l,h)=>({[h]:l}),()=>this.connection.driver.escape(a.databaseName)+" - "+i);return this.createQueryBuilder(e,"entity").update(e).set(c).where(t).execute()}getRepository(e){const t=this.repositories.get(e);if(t)return t;if(this.connection.driver.options.type==="mongodb"){const n=new b0(e,this,this.queryRunner);return this.repositories.set(e,n),n}else{const n=new Up(e,this,this.queryRunner);return this.repositories.set(e,n),n}}getTreeRepository(e){if(this.connection.driver.treeSupport===!1)throw new PC(this.connection.driver);const t=this.treeRepositories.find(i=>i.target===e);if(t)return t;const n=new D0(e,this,this.queryRunner);return this.treeRepositories.push(n),n}getMongoRepository(e){return this.connection.getMongoRepository(e)}withRepository(e){const t=e.constructor,{target:n,manager:i,queryRunner:r,...a}=e;return Object.assign(new t(e.target,this),{...a})}getCustomRepository(e){const t=Va().entityRepositories.find(r=>r.target===(typeof e=="function"?e:e.constructor));if(!t)throw new pp(e);const n=t.entity?this.connection.getMetadata(t.entity):void 0,i=new t.target(this,n);if(i instanceof B0)i.manager||(i.manager=this);else{if(!n)throw new $C(e);i.manager=this,i.metadata=n}return i}async release(){if(!this.queryRunner)throw new GC;return this.queryRunner.release()}}class W0 extends kp{constructor(e,t){super(e,t),this["@instanceof"]=Symbol.for("SqljsEntityManager"),this.driver=e.driver}async loadDatabase(e){await this.driver.load(e)}async saveDatabase(e){await this.driver.save(e)}exportDatabase(){return this.driver.export()}}class H0{create(e,t){return e.driver.options.type==="mongodb"?new w0(e):e.driver.options.type==="sqljs"?new W0(e,t):new kp(e,t)}}class Si{constructor(e){this["@instanceof"]=Symbol.for("View"),this.indices=[],e&&(this.database=e.database,this.schema=e.schema,this.name=e.name,this.expression=e.expression,this.materialized=!!e.materialized)}clone(){return new Si({database:this.database,schema:this.schema,name:this.name,expression:this.expression,materialized:this.materialized})}addIndex(e){this.indices.push(e)}removeIndex(e){const t=this.indices.find(n=>n.name===e.name);t&&this.indices.splice(this.indices.indexOf(t),1)}static create(e,t){const n={database:e.database,schema:e.schema,name:t.buildTableName(e.tableName,e.schema,e.database),expression:e.expression,materialized:e.tableMetadataArgs.materialized};return new Si(n)}}class xf{static viewMetadataCmp(e,t){return!e||!t?0:e.dependsOn&&(e.dependsOn.has(t.target)||e.dependsOn.has(t.name))?1:t.dependsOn&&(t.dependsOn.has(e.target)||t.dependsOn.has(e.name))?-1:0}}class co{constructor(e){this.connection=e,this["@instanceof"]=Symbol.for("RdbmsSchemaBuilder")}async build(){this.queryRunner=this.connection.createQueryRunner(),this.currentDatabase=this.connection.driver.database,this.currentSchema=this.connection.driver.schema;const e=this.connection.driver.options.type!=="cockroachdb"&&this.connection.driver.options.type!=="spanner"&&this.connection.options.migrationsTransactionMode!=="none";await this.queryRunner.beforeMigration(),e&&await this.queryRunner.startTransaction();try{await this.createMetadataTableIfNecessary(this.queryRunner);const t=this.entityToSyncMetadatas.map(i=>this.getTablePath(i)),n=this.viewEntityToSyncMetadatas.map(i=>this.getTablePath(i));await this.queryRunner.getTables(t),await this.queryRunner.getViews(n),await this.executeSchemaSyncOperationsInProperOrder(),this.connection.queryResultCache&&await this.connection.queryResultCache.synchronize(this.queryRunner),e&&await this.queryRunner.commitTransaction()}catch(t){try{e&&await this.queryRunner.rollbackTransaction()}catch{}throw t}finally{await this.queryRunner.afterMigration(),await this.queryRunner.release()}}async createMetadataTableIfNecessary(e){(this.viewEntityToSyncMetadatas.length>0||this.hasGeneratedColumns())&&await this.createTypeormMetadataTable(e)}async log(){this.queryRunner=this.connection.createQueryRunner();try{const e=this.entityToSyncMetadatas.map(n=>this.getTablePath(n)),t=this.viewEntityToSyncMetadatas.map(n=>this.getTablePath(n));return await this.queryRunner.getTables(e),await this.queryRunner.getViews(t),this.queryRunner.enableSqlMemory(),await this.executeSchemaSyncOperationsInProperOrder(),this.connection.queryResultCache&&await this.connection.queryResultCache.synchronize(this.queryRunner),this.queryRunner.getMemorySql()}finally{this.queryRunner.disableSqlMemory(),await this.queryRunner.release()}}get entityToSyncMetadatas(){return this.connection.entityMetadatas.filter(e=>e.synchronize&&e.tableType!=="entity-child"&&e.tableType!=="view")}get viewEntityToSyncMetadatas(){return this.connection.entityMetadatas.filter(e=>e.tableType==="view"&&e.synchronize).sort(xf.viewMetadataCmp)}hasGeneratedColumns(){return this.connection.entityMetadatas.some(e=>e.columns.some(t=>t.generatedType))}async executeSchemaSyncOperationsInProperOrder(){await this.dropOldViews(),await this.dropOldForeignKeys(),await this.dropOldIndices(),await this.dropOldChecks(),await this.dropOldExclusions(),await this.dropCompositeUniqueConstraints(),await this.renameColumns(),await this.changeTableComment(),await this.createNewTables(),await this.dropRemovedColumns(),await this.addNewColumns(),await this.updatePrimaryKeys(),await this.updateExistColumns(),await this.createNewIndices(),await this.createNewChecks(),await this.createNewExclusions(),await this.createCompositeUniqueConstraints(),await this.createForeignKeys(),await this.createViews(),await this.createNewViewIndices()}getTablePath(e){const t=this.connection.driver.parseTableName(e);return this.connection.driver.buildTableName(t.tableName,t.schema||this.currentSchema,t.database||this.currentDatabase)}async dropOldForeignKeys(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===this.getTablePath(e));if(!t)continue;const n=t.foreignKeys.filter(i=>{const r=e.foreignKeys.find(a=>i.name===a.name&&this.getTablePath(i)===this.getTablePath(a.referencedEntityMetadata));return!r||r.onDelete&&r.onDelete!==i.onDelete||r.onUpdate&&r.onUpdate!==i.onUpdate});n.length!==0&&(this.connection.logger.logSchemaBuild(`dropping old foreign keys of ${t.name}: ${n.map(i=>i.name).join(", ")}`),await this.queryRunner.dropForeignKeys(t,n))}}async renameTables(){}async renameColumns(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(a=>this.getTablePath(a)===this.getTablePath(e));if(!t||e.columns.length!==t.columns.length)continue;const n=e.columns.filter(a=>!a.isVirtualProperty).filter(a=>!t.columns.find(c=>c.name===a.databaseName&&c.type===this.connection.driver.normalizeType(a)&&c.isNullable===a.isNullable&&c.isUnique===this.connection.driver.normalizeIsUnique(a)));if(n.length===0||n.length>1)continue;const i=t.columns.filter(a=>!e.columns.find(c=>!c.isVirtualProperty&&c.databaseName===a.name&&this.connection.driver.normalizeType(c)===a.type&&c.isNullable===a.isNullable&&this.connection.driver.normalizeIsUnique(c)===a.isUnique));if(i.length===0||i.length>1)continue;const r=i[0].clone();r.name=n[0].databaseName,this.connection.logger.logSchemaBuild(`renaming column "${i[0].name}" in "${t.name}" to "${r.name}"`),await this.queryRunner.renameColumn(t,i[0],r)}}async dropOldIndices(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===this.getTablePath(e));if(!t)continue;const n=t.indices.filter(i=>{const r=e.indices.find(a=>a.name===i.name);return r?r.synchronize===!1?!1:r.isUnique!==i.isUnique||r.isSpatial!==i.isSpatial||this.connection.driver.isFullTextColumnTypeSupported()&&r.isFulltext!==i.isFulltext||r.columns.length!==i.columnNames.length?!0:!r.columns.every(a=>i.columnNames.indexOf(a.databaseName)!==-1):!0}).map(async i=>{this.connection.logger.logSchemaBuild(`dropping an index: "${i.name}" from table ${t.name}`),await this.queryRunner.dropIndex(t,i)});await Promise.all(n)}if(this.connection.options.type==="postgres"){const e=this.queryRunner;for(const t of this.viewEntityToSyncMetadatas){const n=this.queryRunner.loadedViews.find(r=>this.getTablePath(r)===this.getTablePath(t));if(!n)continue;const i=n.indices.filter(r=>{const a=t.indices.find(c=>c.name===r.name);return a?a.synchronize===!1?!1:a.isUnique!==r.isUnique||a.isSpatial!==r.isSpatial||this.connection.driver.isFullTextColumnTypeSupported()&&a.isFulltext!==r.isFulltext||a.columns.length!==r.columnNames.length?!0:!a.columns.every(c=>r.columnNames.indexOf(c.databaseName)!==-1):!0}).map(async r=>{this.connection.logger.logSchemaBuild(`dropping an index: "${r.name}" from view ${n.name}`),await e.dropViewIndex(n,r)});await Promise.all(i)}}}async dropOldChecks(){if(!(te.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"))for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===this.getTablePath(e));if(!t)continue;const n=t.checks.filter(i=>!e.checks.find(r=>r.name===i.name));n.length!==0&&(this.connection.logger.logSchemaBuild(`dropping old check constraint: ${n.map(i=>`"${i.name}"`).join(", ")} from table "${t.name}"`),await this.queryRunner.dropCheckConstraints(t,n))}}async dropCompositeUniqueConstraints(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===this.getTablePath(e));if(!t)continue;const n=t.uniques.filter(i=>i.columnNames.length>1&&!e.uniques.find(r=>r.name===i.name));n.length!==0&&(this.connection.logger.logSchemaBuild(`dropping old unique constraint: ${n.map(i=>`"${i.name}"`).join(", ")} from table "${t.name}"`),await this.queryRunner.dropUniqueConstraints(t,n))}}async dropOldExclusions(){if(this.connection.driver.options.type==="postgres")for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===this.getTablePath(e));if(!t)continue;const n=t.exclusions.filter(i=>!e.exclusions.find(r=>r.name===i.name));n.length!==0&&(this.connection.logger.logSchemaBuild(`dropping old exclusion constraint: ${n.map(i=>`"${i.name}"`).join(", ")} from table "${t.name}"`),await this.queryRunner.dropExclusionConstraints(t,n))}}async changeTableComment(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(n=>this.getTablePath(n)===this.getTablePath(e));if(t&&(te.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="postgres")){const n=e.comment;await this.queryRunner.changeTableComment(t,n)}}}async createNewTables(){for(const e of this.entityToSyncMetadatas){if(this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===this.getTablePath(e)))continue;this.connection.logger.logSchemaBuild(`creating a new table: ${this.getTablePath(e)}`);const n=pt.create(e,this.connection.driver);await this.queryRunner.createTable(n,!1,!1),this.queryRunner.loadedTables.push(n)}}async createViews(){for(const e of this.viewEntityToSyncMetadatas){if(this.queryRunner.loadedViews.find(i=>{const r=typeof i.expression=="string"?i.expression.trim():i.expression(this.connection).getQuery(),a=typeof e.expression=="string"?e.expression.trim():e.expression(this.connection).getQuery();return this.getTablePath(i)===this.getTablePath(e)&&r===a}))continue;this.connection.logger.logSchemaBuild(`creating a new view: ${this.getTablePath(e)}`);const n=Si.create(e,this.connection.driver);await this.queryRunner.createView(n,!0),this.queryRunner.loadedViews.push(n)}}async dropOldViews(){const e=[],t=this.viewEntityToSyncMetadatas,n=new Map;for(const a of this.queryRunner.loadedViews){const c=t.find(l=>this.getTablePath(a)===this.getTablePath(l));c&&n.set(a,c)}for(const a of this.queryRunner.loadedViews){const c=n.get(a);if(!c)continue;const l=typeof a.expression=="string"?a.expression.trim():a.expression(this.connection).getQuery(),h=typeof c.expression=="string"?c.expression.trim():c.expression(this.connection).getQuery();l!==h&&(this.connection.logger.logSchemaBuild(`dropping an old view: ${a.name}`),e.push(a))}const i=a=>{const c=n.get(a);let l=[a];if(!c)return l;for(const[h,f]of n.entries())h!==a&&f.dependsOn&&(f.dependsOn.has(c.target)||f.dependsOn.has(c.name))&&(l=l.concat(i(h)));return l},r=new Set(e.map(a=>i(a)).reduce((a,c)=>a.concat(c),[]).sort((a,c)=>xf.viewMetadataCmp(n.get(a),n.get(c))).reverse());for(const a of r)await this.queryRunner.dropView(a);this.queryRunner.loadedViews=this.queryRunner.loadedViews.filter(a=>!r.has(a))}async dropRemovedColumns(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===this.getTablePath(e));if(!t)continue;const n=t.columns.filter(i=>!e.columns.find(r=>r.isVirtualProperty||r.databaseName===i.name));n.length!==0&&(this.connection.logger.logSchemaBuild(`columns dropped in ${t.name}: `+n.map(i=>i.name).join(", ")),await this.queryRunner.dropColumns(t,n))}}async addNewColumns(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(a=>this.getTablePath(a)===this.getTablePath(e));if(!t)continue;const n=e.columns.filter(a=>!a.isVirtualProperty&&!t.columns.find(c=>c.name===a.databaseName));if(n.length===0)continue;const r=this.metadataColumnsToTableColumnOptions(n).map(a=>new nn(a));r.length!==0&&(this.connection.logger.logSchemaBuild("new columns added: "+n.map(a=>a.databaseName).join(", ")),await this.queryRunner.addColumns(t,r))}}async updatePrimaryKeys(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(r=>this.getTablePath(r)===this.getTablePath(e));if(!t)continue;const n=e.columns.filter(r=>r.isPrimary);if(t.columns.filter(r=>r.isPrimary).length!==n.length&&n.length>1){const r=n.map(a=>new nn(Oa.createTableColumnOptions(a,this.connection.driver)));await this.queryRunner.updatePrimaryKeys(t,r)}}}async updateExistColumns(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(r=>this.getTablePath(r)===this.getTablePath(e));if(!t)continue;const n=this.connection.driver.findChangedColumns(t.columns,e.columns);if(n.length===0)continue;for(const r of n)await this.dropColumnReferencedForeignKeys(this.getTablePath(e),r.databaseName);for(const r of n)await this.dropColumnCompositeIndices(this.getTablePath(e),r.databaseName);if(!(te.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"||this.connection.driver.options.type==="spanner"))for(const r of n)await this.dropColumnCompositeUniques(this.getTablePath(e),r.databaseName);const i=n.map(r=>{const a=t.columns.find(h=>h.name===r.databaseName),c=Oa.createTableColumnOptions(r,this.connection.driver),l=new nn(c);return{oldColumn:a,newColumn:l}});i.length!==0&&(this.connection.logger.logSchemaBuild(`columns changed in "${t.name}". updating: `+n.map(r=>r.databaseName).join(", ")),await this.queryRunner.changeColumns(t,i))}}async createNewIndices(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===this.getTablePath(e));if(!t)continue;const n=e.indices.filter(i=>!t.indices.find(r=>r.name===i.name)&&i.synchronize===!0).map(i=>Nt.create(i));n.length!==0&&(this.connection.logger.logSchemaBuild(`adding new indices ${n.map(i=>`"${i.name}"`).join(", ")} in table "${t.name}"`),await this.queryRunner.createIndices(t,n))}}async createNewViewIndices(){if(this.connection.options.type!=="postgres"||!te.isPostgresFamily(this.connection.driver))return;const e=this.queryRunner;for(const t of this.viewEntityToSyncMetadatas){const n=this.queryRunner.loadedViews.find(r=>{const a=typeof r.expression=="string"?r.expression.trim():r.expression(this.connection).getQuery(),c=typeof t.expression=="string"?t.expression.trim():t.expression(this.connection).getQuery();return this.getTablePath(r)===this.getTablePath(t)&&a===c});if(!n||!n.materialized)continue;const i=t.indices.filter(r=>!n.indices.find(a=>a.name===r.name)&&r.synchronize===!0).map(r=>Nt.create(r));i.length!==0&&(this.connection.logger.logSchemaBuild(`adding new indices ${i.map(r=>`"${r.name}"`).join(", ")} in view "${n.name}"`),await e.createViewIndices(n,i))}}async createNewChecks(){if(!(te.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"))for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===this.getTablePath(e));if(!t)continue;const n=e.checks.filter(i=>!t.checks.find(r=>r.name===i.name)).map(i=>kn.create(i));n.length!==0&&(this.connection.logger.logSchemaBuild(`adding new check constraints: ${n.map(i=>`"${i.name}"`).join(", ")} in table "${t.name}"`),await this.queryRunner.createCheckConstraints(t,n))}}async createCompositeUniqueConstraints(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===this.getTablePath(e));if(!t)continue;const n=e.uniques.filter(i=>i.columns.length>1&&!t.uniques.find(r=>r.name===i.name)).map(i=>jt.create(i));n.length!==0&&(this.connection.logger.logSchemaBuild(`adding new unique constraints: ${n.map(i=>`"${i.name}"`).join(", ")} in table "${t.name}"`),await this.queryRunner.createUniqueConstraints(t,n))}}async createNewExclusions(){if(this.connection.driver.options.type==="postgres")for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===this.getTablePath(e));if(!t)continue;const n=e.exclusions.filter(i=>!t.exclusions.find(r=>r.name===i.name)).map(i=>or.create(i));n.length!==0&&(this.connection.logger.logSchemaBuild(`adding new exclusion constraints: ${n.map(i=>`"${i.name}"`).join(", ")} in table "${t.name}"`),await this.queryRunner.createExclusionConstraints(t,n))}}async createForeignKeys(){for(const e of this.entityToSyncMetadatas){const t=this.queryRunner.loadedTables.find(r=>this.getTablePath(r)===this.getTablePath(e));if(!t)continue;const n=e.foreignKeys.filter(r=>!t.foreignKeys.find(a=>a.name===r.name&&this.getTablePath(a)===this.getTablePath(r.referencedEntityMetadata)));if(n.length===0)continue;const i=n.map(r=>Cn.create(r,this.connection.driver));this.connection.logger.logSchemaBuild(`creating a foreign keys: ${n.map(r=>r.name).join(", ")} on table "${t.name}"`),await this.queryRunner.createForeignKeys(t,i)}}async dropColumnReferencedForeignKeys(e,t){const n=this.queryRunner.loadedTables.find(a=>this.getTablePath(a)===e);if(!n)return;const i=[],r=n.foreignKeys.find(a=>a.columnNames.indexOf(t)!==-1);if(r){const a=n.clone();a.foreignKeys=[r],i.push(a),n.removeForeignKey(r)}for(const a of this.queryRunner.loadedTables){const c=a.foreignKeys.filter(l=>this.getTablePath(l)===e&&l.referencedColumnNames.indexOf(t)!==-1);if(c.length>0){const l=a.clone();l.foreignKeys=c,i.push(l),c.forEach(h=>a.removeForeignKey(h))}}if(i.length>0)for(const a of i)this.connection.logger.logSchemaBuild(`dropping related foreign keys of ${a.name}: ${a.foreignKeys.map(c=>c.name).join(", ")}`),await this.queryRunner.dropForeignKeys(a,a.foreignKeys)}async dropColumnCompositeIndices(e,t){const n=this.queryRunner.loadedTables.find(r=>this.getTablePath(r)===e);if(!n)return;const i=n.indices.filter(r=>r.columnNames.length>1&&r.columnNames.indexOf(t)!==-1);i.length!==0&&(this.connection.logger.logSchemaBuild(`dropping related indices of "${e}"."${t}": ${i.map(r=>r.name).join(", ")}`),await this.queryRunner.dropIndices(n,i))}async dropColumnCompositeUniques(e,t){const n=this.queryRunner.loadedTables.find(r=>this.getTablePath(r)===e);if(!n)return;const i=n.uniques.filter(r=>r.columnNames.length>1&&r.columnNames.indexOf(t)!==-1);i.length!==0&&(this.connection.logger.logSchemaBuild(`dropping related unique constraints of "${e}"."${t}": ${i.map(r=>r.name).join(", ")}`),await this.queryRunner.dropUniqueConstraints(n,i))}metadataColumnsToTableColumnOptions(e){return e.map(t=>Oa.createTableColumnOptions(t,this.connection.driver))}async createTypeormMetadataTable(e){const t=this.currentSchema,n=this.currentDatabase,i=this.connection.driver.buildTableName(this.connection.metadataTableName,t,n),r=this.connection.driver.options.type==="spanner";await e.createTable(new pt({database:n,schema:t,name:i,columns:[{name:"type",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.metadataType}),isNullable:!1,isPrimary:r},{name:"database",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.metadataDatabase}),isNullable:!0,isPrimary:r},{name:"schema",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.metadataSchema}),isNullable:!0,isPrimary:r},{name:"table",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.metadataTable}),isNullable:!0,isPrimary:r},{name:"name",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.metadataName}),isNullable:!0,isPrimary:r},{name:"value",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.metadataValue}),isNullable:!0,isPrimary:r}]}),!0)}}class kr{constructor(e){this.isReplicated=!1,this.treeSupport=!0,this.transactionSupport="nested",this.supportedDataTypes=["int","integer","tinyint","smallint","mediumint","bigint","unsigned big int","int2","int8","integer","character","varchar","varying character","nchar","native character","nvarchar","text","clob","text","blob","real","double","double precision","float","real","numeric","decimal","boolean","date","time","datetime","json"],this.supportedUpsertTypes=["on-conflict-do-update"],this.withLengthColumnTypes=["character","varchar","varying character","nchar","native character","nvarchar","text","blob","clob"],this.spatialTypes=[],this.withPrecisionColumnTypes=["real","double","double precision","float","real","numeric","decimal","date","time","datetime"],this.withScaleColumnTypes=["real","double","double precision","float","real","numeric","decimal"],this.mappedDataTypes={createDate:"datetime",createDateDefault:"datetime('now')",updateDate:"datetime",updateDateDefault:"datetime('now')",deleteDate:"datetime",deleteDateNullable:!0,version:"integer",treeLevel:"integer",migrationId:"integer",migrationName:"varchar",migrationTimestamp:"bigint",cacheId:"int",cacheIdentifier:"varchar",cacheTime:"bigint",cacheDuration:"int",cacheQuery:"text",cacheResult:"text",metadataType:"varchar",metadataDatabase:"varchar",metadataSchema:"varchar",metadataTable:"varchar",metadataName:"varchar",metadataValue:"text"},this.cteCapabilities={enabled:!0,requiresRecursiveHint:!0},this.attachedDatabases={},this.connection=e,this.options=e.options,this.database=te.buildDriverOptions(this.options).database}async connect(){this.databaseConnection=await this.createDatabaseConnection()}afterConnect(){return Promise.resolve()}async disconnect(){return new Promise((e,t)=>{this.queryRunner=void 0,this.databaseConnection.close(n=>n?t(n):e())})}hasAttachedDatabases(){return!!Object.keys(this.attachedDatabases).length}getAttachedDatabaseHandleByRelativePath(e){var t,n;return(n=(t=this.attachedDatabases)==null?void 0:t[e])==null?void 0:n.attachHandle}getAttachedDatabasePathRelativeByHandle(e){var t;return(t=Object.values(this.attachedDatabases).find(({attachHandle:n})=>e===n))==null?void 0:t.attachFilepathRelative}createSchemaBuilder(){return new co(this.connection)}preparePersistentValue(e,t){return t.transformer&&(e=Mt.transformTo(t.transformer,e)),e==null?e:t.type===Boolean||t.type==="boolean"?e===!0?1:0:t.type==="date"?pe.mixedDateToDateString(e):t.type==="time"?pe.mixedDateToTimeString(e):t.type==="datetime"||t.type===Date?pe.mixedDateToUtcDatetimeString(e):t.type==="json"||t.type==="simple-json"?pe.simpleJsonToString(e):t.type==="simple-array"?pe.simpleArrayToString(e):t.type==="simple-enum"?pe.simpleEnumToString(e):e}prepareHydratedValue(e,t){return e==null?t.transformer?Mt.transformFrom(t.transformer,e):e:(t.type===Boolean||t.type==="boolean"?e=!!e:t.type==="datetime"||t.type===Date?(e&&typeof e=="string"&&(/^\d\d\d\d-\d\d-\d\d \d\d:\d\d/.test(e)&&(e=e.replace(" ","T")),/^\d\d\d\d-\d\d-\d\dT\d\d:\d\d(:\d\d(\.\d\d\d)?)?$/.test(e)&&(e+="Z")),e=pe.normalizeHydratedDate(e)):t.type==="date"?e=pe.mixedDateToDateString(e):t.type==="time"?e=pe.mixedTimeToString(e):t.type==="json"||t.type==="simple-json"?e=pe.stringToSimpleJson(e):t.type==="simple-array"?e=pe.stringToSimpleArray(e):t.type==="simple-enum"?e=pe.stringToSimpleEnum(e,t):t.type===Number&&(e=isNaN(+e)?e:parseInt(e)),t.transformer&&(e=Mt.transformFrom(t.transformer,e)),e)}escapeQueryWithParameters(e,t,n){const i=Object.keys(n).map(r=>typeof n[r]=="boolean"?n[r]===!0?1:0:n[r]instanceof Date?pe.mixedDateToUtcDatetimeString(n[r]):n[r]);return!t||!Object.keys(t).length?[e,i]:(e=e.replace(/:(\.\.\.)?([A-Za-z0-9_.]+)/g,(r,a,c)=>{if(!t.hasOwnProperty(c))return r;const l=t[c];return a?l.map(h=>(i.push(h),this.createParameter(c,i.length-1))).join(", "):typeof l=="function"?l():typeof l=="number"?String(l):typeof l=="boolean"?(i.push(+l),this.createParameter(c,i.length-1)):l instanceof Date?(i.push(pe.mixedDateToUtcDatetimeString(l)),this.createParameter(c,i.length-1)):(i.push(l),this.createParameter(c,i.length-1))}),[e,i])}escape(e){return'"'+e+'"'}buildTableName(e,t,n){return e}parseTableName(e){const t=this.database,n=void 0;if($.isTable(e)||$.isView(e)){const r=this.parseTableName(e.schema?`"${e.schema}"."${e.name}"`:e.name);return{database:e.database||r.database||t,schema:e.schema||r.schema||n,tableName:r.tableName}}if($.isTableForeignKey(e)){const r=this.parseTableName(e.referencedTableName);return{database:e.referencedDatabase||r.database||t,schema:e.referencedSchema||r.schema||n,tableName:r.tableName}}if($.isEntityMetadata(e))return{database:e.database||t,schema:e.schema||n,tableName:e.tableName};const i=e.split(".");return i.length===3?{database:i[0]||t,schema:i[1]||n,tableName:i[2]}:i.length===2?{database:this.getAttachedDatabasePathRelativeByHandle(i[0])??t,schema:i[0],tableName:i[1]}:{database:t,schema:n,tableName:e}}normalizeType(e){return e.type===Number||e.type==="int"?"integer":e.type===String?"varchar":e.type===Date?"datetime":e.type===Boolean?"boolean":e.type==="uuid"?"varchar":e.type==="simple-array"||e.type==="simple-json"?"text":e.type==="simple-enum"?"varchar":e.type||""}normalizeDefault(e){const t=e.default;if(typeof t=="number")return""+t;if(typeof t=="boolean")return t?"1":"0";if(typeof t=="function")return t();if(typeof t=="string")return`'${t}'`;if(t!=null)return`${t}`}normalizeIsUnique(e){return e.entityMetadata.uniques.some(t=>t.columns.length===1&&t.columns[0]===e)}getColumnLength(e){return e.length?e.length.toString():""}createFullType(e){let t=e.type;return e.enum?"varchar":(e.length?t+="("+e.length+")":e.precision!==null&&e.precision!==void 0&&e.scale!==null&&e.scale!==void 0?t+="("+e.precision+","+e.scale+")":e.precision!==null&&e.precision!==void 0&&(t+="("+e.precision+")"),e.isArray&&(t+=" array"),t)}obtainMasterConnection(){return Promise.resolve()}obtainSlaveConnection(){return Promise.resolve()}createGeneratedMap(e,t,n,i){const r=e.generatedColumns.reduce((a,c)=>{let l;return c.generationStrategy==="increment"&&t&&(l=t-i+n+1),l?ee.mergeDeep(a,c.createValueMap(l)):a},{});return Object.keys(r).length>0?r:void 0}findChangedColumns(e,t){return t.filter(n=>{const i=e.find(a=>a.name===n.databaseName);return i?i.name!==n.databaseName||i.type!==this.normalizeType(n)||i.length!==n.length||i.precision!==n.precision||i.scale!==n.scale||this.normalizeDefault(n)!==i.default||i.isPrimary!==n.isPrimary||i.isNullable!==n.isNullable||i.generatedType!==n.generatedType||i.asExpression!==n.asExpression||i.isUnique!==this.normalizeIsUnique(n)||i.enum&&n.enum&&!ee.isArraysEqual(i.enum,n.enum.map(a=>a+""))||n.generationStrategy!=="uuid"&&i.isGenerated!==n.isGenerated:!1})}isReturningSqlSupported(){return!1}isUUIDGenerationSupported(){return!1}isFullTextColumnTypeSupported(){return!1}createParameter(e,t){return"?"}async createDatabaseConnection(){throw new _("Do not use AbstractSqlite directly, it has to be used with one of the sqlite drivers")}loadDependencies(){}}class Wn{constructor(){this.records=[]}}class ii{constructor(e){this.queryRunner=e}async broadcast(e,...t){const n=new Rn,i=this[`broadcast${e}Event`];typeof i=="function"&&i.call(this,n,...t),await n.wait()}broadcastBeforeInsertEvent(e,t,n){n&&t.beforeInsertListeners.length&&t.beforeInsertListeners.forEach(i=>{if(i.isAllowed(n)){const r=i.execute(n);r instanceof Promise&&e.promises.push(r),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(i=>{if(this.isAllowedSubscriber(i,t.target)&&i.beforeInsert){const r=i.beforeInsert({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t});r instanceof Promise&&e.promises.push(r),e.count++}})}broadcastBeforeUpdateEvent(e,t,n,i,r,a){n&&t.beforeUpdateListeners.length&&t.beforeUpdateListeners.forEach(c=>{if(c.isAllowed(n)){const l=c.execute(n);l instanceof Promise&&e.promises.push(l),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(c=>{if(this.isAllowedSubscriber(c,t.target)&&c.beforeUpdate){const l=c.beforeUpdate({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:i,updatedColumns:r||[],updatedRelations:a||[]});l instanceof Promise&&e.promises.push(l),e.count++}})}broadcastBeforeRemoveEvent(e,t,n,i,r){n&&t.beforeRemoveListeners.length&&t.beforeRemoveListeners.forEach(a=>{if(a.isAllowed(n)){const c=a.execute(n);c instanceof Promise&&e.promises.push(c),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(a=>{if(this.isAllowedSubscriber(a,t.target)&&a.beforeRemove){const c=a.beforeRemove({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:i,entityId:t.getEntityIdMixedMap(i??r)});c instanceof Promise&&e.promises.push(c),e.count++}})}broadcastBeforeSoftRemoveEvent(e,t,n,i,r){n&&t.beforeSoftRemoveListeners.length&&t.beforeSoftRemoveListeners.forEach(a=>{if(a.isAllowed(n)){const c=a.execute(n);c instanceof Promise&&e.promises.push(c),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(a=>{if(this.isAllowedSubscriber(a,t.target)&&a.beforeSoftRemove){const c=a.beforeSoftRemove({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:i,entityId:t.getEntityIdMixedMap(i??r)});c instanceof Promise&&e.promises.push(c),e.count++}})}broadcastBeforeRecoverEvent(e,t,n,i,r){n&&t.beforeRecoverListeners.length&&t.beforeRecoverListeners.forEach(a=>{if(a.isAllowed(n)){const c=a.execute(n);c instanceof Promise&&e.promises.push(c),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(a=>{if(this.isAllowedSubscriber(a,t.target)&&a.beforeRecover){const c=a.beforeRecover({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:i,entityId:t.getEntityIdMixedMap(i??r)});c instanceof Promise&&e.promises.push(c),e.count++}})}broadcastAfterInsertEvent(e,t,n,i){n&&t.afterInsertListeners.length&&t.afterInsertListeners.forEach(r=>{if(r.isAllowed(n)){const a=r.execute(n);a instanceof Promise&&e.promises.push(a),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(r=>{if(this.isAllowedSubscriber(r,t.target)&&r.afterInsert){const a=r.afterInsert({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,entityId:t.getEntityIdMixedMap(i)});a instanceof Promise&&e.promises.push(a),e.count++}})}broadcastBeforeQueryEvent(e,t,n){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(i=>{if(i.beforeQuery){const r=i.beforeQuery({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,query:t,parameters:n});r instanceof Promise&&e.promises.push(r),e.count++}})}broadcastAfterQueryEvent(e,t,n,i,r,a,c){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(l=>{if(l.afterQuery){const h=l.afterQuery({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,query:t,parameters:n,success:i,executionTime:r,rawResults:a,error:c});h instanceof Promise&&e.promises.push(h),e.count++}})}broadcastBeforeTransactionStartEvent(e){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(t=>{if(t.beforeTransactionStart){const n=t.beforeTransactionStart({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});n instanceof Promise&&e.promises.push(n),e.count++}})}broadcastAfterTransactionStartEvent(e){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(t=>{if(t.afterTransactionStart){const n=t.afterTransactionStart({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});n instanceof Promise&&e.promises.push(n),e.count++}})}broadcastBeforeTransactionCommitEvent(e){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(t=>{if(t.beforeTransactionCommit){const n=t.beforeTransactionCommit({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});n instanceof Promise&&e.promises.push(n),e.count++}})}broadcastAfterTransactionCommitEvent(e){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(t=>{if(t.afterTransactionCommit){const n=t.afterTransactionCommit({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});n instanceof Promise&&e.promises.push(n),e.count++}})}broadcastBeforeTransactionRollbackEvent(e){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(t=>{if(t.beforeTransactionRollback){const n=t.beforeTransactionRollback({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});n instanceof Promise&&e.promises.push(n),e.count++}})}broadcastAfterTransactionRollbackEvent(e){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(t=>{if(t.afterTransactionRollback){const n=t.afterTransactionRollback({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});n instanceof Promise&&e.promises.push(n),e.count++}})}broadcastAfterUpdateEvent(e,t,n,i,r,a){n&&t.afterUpdateListeners.length&&t.afterUpdateListeners.forEach(c=>{if(c.isAllowed(n)){const l=c.execute(n);l instanceof Promise&&e.promises.push(l),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(c=>{if(this.isAllowedSubscriber(c,t.target)&&c.afterUpdate){const l=c.afterUpdate({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:i,updatedColumns:r||[],updatedRelations:a||[]});l instanceof Promise&&e.promises.push(l),e.count++}})}broadcastAfterRemoveEvent(e,t,n,i,r){n&&t.afterRemoveListeners.length&&t.afterRemoveListeners.forEach(a=>{if(a.isAllowed(n)){const c=a.execute(n);c instanceof Promise&&e.promises.push(c),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(a=>{if(this.isAllowedSubscriber(a,t.target)&&a.afterRemove){const c=a.afterRemove({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:i,entityId:t.getEntityIdMixedMap(i??r)});c instanceof Promise&&e.promises.push(c),e.count++}})}broadcastAfterSoftRemoveEvent(e,t,n,i,r){n&&t.afterSoftRemoveListeners.length&&t.afterSoftRemoveListeners.forEach(a=>{if(a.isAllowed(n)){const c=a.execute(n);c instanceof Promise&&e.promises.push(c),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(a=>{if(this.isAllowedSubscriber(a,t.target)&&a.afterSoftRemove){const c=a.afterSoftRemove({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:i,entityId:t.getEntityIdMixedMap(i??r)});c instanceof Promise&&e.promises.push(c),e.count++}})}broadcastAfterRecoverEvent(e,t,n,i,r){n&&t.afterRecoverListeners.length&&t.afterRecoverListeners.forEach(a=>{if(a.isAllowed(n)){const c=a.execute(n);c instanceof Promise&&e.promises.push(c),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(a=>{if(this.isAllowedSubscriber(a,t.target)&&a.afterRecover){const c=a.afterRecover({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:i,entityId:t.getEntityIdMixedMap(i??r)});c instanceof Promise&&e.promises.push(c),e.count++}})}broadcastLoadEventsForAll(e,t,n){return this.broadcastLoadEvent(e,t,n)}broadcastLoadEvent(e,t,n){const i=this.queryRunner.connection.subscribers.filter(r=>this.isAllowedSubscriber(r,t.target)&&r.afterLoad);if(t.relations.length||t.afterLoadListeners.length||i.length){const r=n.filter(a=>!(a instanceof Promise));t.relations.length&&t.relations.forEach(a=>{r.forEach(c=>{if(a.isLazy&&!c.hasOwnProperty(a.propertyName))return;const l=a.getEntityValue(c);Ce.isObject(l)&&this.broadcastLoadEvent(e,a.inverseEntityMetadata,Array.isArray(l)?l:[l])})}),t.afterLoadListeners.length&&t.afterLoadListeners.forEach(a=>{r.forEach(c=>{if(a.isAllowed(c)){const l=a.execute(c);l instanceof Promise&&e.promises.push(l),e.count++}})}),i.forEach(a=>{r.forEach(c=>{const l=a.afterLoad(c,{entity:c,metadata:t,connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});l instanceof Promise&&e.promises.push(l),e.count++})})}}isAllowedSubscriber(e,t){return!e.listenTo||!e.listenTo()||e.listenTo()===Object||e.listenTo()===t||e.listenTo().isPrototypeOf(t)}}class x{constructor(e,t){this.query=e,this.parameters=t,this["@instanceof"]=Symbol.for("Query")}}class Na{constructor(){this.upQueries=[],this.downQueries=[]}}class uo{constructor(){this.isReleased=!1,this.isTransactionActive=!1,this.data={},this.loadedTables=[],this.loadedViews=[],this.sqlMemoryMode=!1,this.sqlInMemory=new Na,this.transactionDepth=0,this.cachedTablePaths={}}async sql(e,...t){const{query:n,parameters:i}=oo({driver:this.connection.driver,strings:e,expressions:t});return await this.query(n,i)}async beforeMigration(){}async afterMigration(){}async getTable(e){return this.loadedTables=await this.loadTables([e]),this.loadedTables.length>0?this.loadedTables[0]:void 0}async getTables(e){return e?(this.loadedTables=await this.loadTables(e),this.loadedTables):await this.loadTables(e)}async getView(e){return this.loadedViews=await this.loadViews([e]),this.loadedViews.length>0?this.loadedViews[0]:void 0}async getViews(e){return this.loadedViews=await this.loadViews(e),this.loadedViews}enableSqlMemory(){this.sqlInMemory=new Na,this.sqlMemoryMode=!0}disableSqlMemory(){this.sqlInMemory=new Na,this.sqlMemoryMode=!1}clearSqlMemory(){this.sqlInMemory=new Na}getMemorySql(){return this.sqlInMemory}async executeMemoryUpSql(){for(const{query:e,parameters:t}of this.sqlInMemory.upQueries)await this.query(e,t)}async executeMemoryDownSql(){for(const{query:e,parameters:t}of this.sqlInMemory.downQueries.reverse())await this.query(e,t)}getReplicationMode(){return this.mode}async getCachedView(e){const t=this.loadedViews.find(i=>i.name===e);if(t)return t;const n=await this.loadViews([e]);if(n.length>0)return this.loadedViews.push(n[0]),n[0];throw new _(`View "${e}" does not exist.`)}async getCachedTable(e){if(e in this.cachedTablePaths){const n=this.cachedTablePaths[e],i=this.loadedTables.find(r=>this.getTablePath(r)===n);if(i)return i}const t=await this.loadTables([e]);if(t.length>0){const n=this.getTablePath(t[0]),i=this.loadedTables.find(r=>this.getTablePath(r)===n);return i||(this.cachedTablePaths[e]=this.getTablePath(t[0]),this.loadedTables.push(t[0]),t[0])}else throw new _(`Table "${e}" does not exist.`)}replaceCachedTable(e,t){const n=this.getTablePath(e),i=this.loadedTables.find(r=>this.getTablePath(r)===n);for(const[r,a]of Object.entries(this.cachedTablePaths))a===n&&(this.cachedTablePaths[r]=this.getTablePath(t));i&&(i.database=t.database,i.schema=t.schema,i.name=t.name,i.columns=t.columns,i.indices=t.indices,i.foreignKeys=t.foreignKeys,i.uniques=t.uniques,i.checks=t.checks,i.justCreated=t.justCreated,i.engine=t.engine,i.comment=t.comment)}getTablePath(e){const t=this.connection.driver.parseTableName(e);return this.connection.driver.buildTableName(t.tableName,t.schema,t.database)}getTypeormMetadataTableName(){const e=this.connection.driver.options;return this.connection.driver.buildTableName(this.connection.metadataTableName,e.schema,e.database)}selectTypeormMetadataSql({database:e,schema:t,table:n,type:i,name:r}){const a=this.connection.createQueryBuilder(),c=a.select().from(this.getTypeormMetadataTableName(),"t").where(`${a.escape("type")} = :type`,{type:i}).andWhere(`${a.escape("name")} = :name`,{name:r});e&&c.andWhere(`${a.escape("database")} = :database`,{database:e}),t&&c.andWhere(`${a.escape("schema")} = :schema`,{schema:t}),n&&c.andWhere(`${a.escape("table")} = :table`,{table:n});const[l,h]=c.getQueryAndParameters();return new x(l,h)}insertTypeormMetadataSql({database:e,schema:t,table:n,type:i,name:r,value:a}){const[c,l]=this.connection.createQueryBuilder().insert().into(this.getTypeormMetadataTableName()).values({database:e,schema:t,table:n,type:i,name:r,value:a}).getQueryAndParameters();return new x(c,l)}deleteTypeormMetadataSql({database:e,schema:t,table:n,type:i,name:r}){const a=this.connection.createQueryBuilder(),c=a.delete().from(this.getTypeormMetadataTableName()).where(`${a.escape("type")} = :type`,{type:i}).andWhere(`${a.escape("name")} = :name`,{name:r});e&&c.andWhere(`${a.escape("database")} = :database`,{database:e}),t&&c.andWhere(`${a.escape("schema")} = :schema`,{schema:t}),n&&c.andWhere(`${a.escape("table")} = :table`,{table:n});const[l,h]=c.getQueryAndParameters();return new x(l,h)}isColumnChanged(e,t,n,i,r=!0){return e.charset!==t.charset||e.collation!==t.collation||e.precision!==t.precision||e.scale!==t.scale||e.width!==t.width||e.zerofill!==t.zerofill||e.unsigned!==t.unsigned||e.asExpression!==t.asExpression||n&&e.default!==t.default||e.onUpdate!==t.onUpdate||e.isNullable!==t.isNullable||i&&e.comment!==t.comment||r&&this.isEnumChanged(e,t)}isEnumChanged(e,t){return!ee.isArraysEqual(e.enum||[],t.enum||[])}isDefaultColumnLength(e,t,n){if(this.connection.hasMetadata(e.name)){const r=this.connection.getMetadata(e.name).findColumnWithDatabaseName(t.name);if(r&&this.connection.driver.getColumnLength(r))return!1}return this.connection.driver.dataTypeDefaults&&this.connection.driver.dataTypeDefaults[t.type]&&this.connection.driver.dataTypeDefaults[t.type].length?this.connection.driver.dataTypeDefaults[t.type].length.toString()===n.toString():!1}isDefaultColumnPrecision(e,t,n){if(this.connection.hasMetadata(e.name)){const r=this.connection.getMetadata(e.name).findColumnWithDatabaseName(t.name);if(r&&r.precision!==null&&r.precision!==void 0)return!1}return this.connection.driver.dataTypeDefaults&&this.connection.driver.dataTypeDefaults[t.type]&&this.connection.driver.dataTypeDefaults[t.type].precision!==null&&this.connection.driver.dataTypeDefaults[t.type].precision!==void 0?this.connection.driver.dataTypeDefaults[t.type].precision===n:!1}isDefaultColumnScale(e,t,n){if(this.connection.hasMetadata(e.name)){const r=this.connection.getMetadata(e.name).findColumnWithDatabaseName(t.name);if(r&&r.scale!==null&&r.scale!==void 0)return!1}return this.connection.driver.dataTypeDefaults&&this.connection.driver.dataTypeDefaults[t.type]&&this.connection.driver.dataTypeDefaults[t.type].scale!==null&&this.connection.driver.dataTypeDefaults[t.type].scale!==void 0?this.connection.driver.dataTypeDefaults[t.type].scale===n:!1}async executeQueries(e,t){if($.isQuery(e)&&(e=[e]),$.isQuery(t)&&(t=[t]),this.sqlInMemory.upQueries.push(...e),this.sqlInMemory.downQueries.push(...t),this.sqlMemoryMode===!0)return Promise.resolve();for(const{query:n,parameters:i}of e)await this.query(n,i)}generateIndexName(e,t){return this.connection.namingStrategy.indexName(e,t.columnNames,t.where)}}var we;(function(s){s.VIEW="VIEW",s.MATERIALIZED_VIEW="MATERIALIZED_VIEW",s.GENERATED_COLUMN="GENERATED_COLUMN"})(we||(we={}));class ur extends uo{constructor(){super(),this.transactionPromise=null}connect(){return Promise.resolve(this.driver.databaseConnection)}release(){return this.loadedTables=[],this.clearSqlMemory(),Promise.resolve()}async startTransaction(e){if(this.driver.transactionSupport==="none")throw new _(`Transactions aren't supported by ${this.connection.driver.options.type}.`);if(this.isTransactionActive&&this.driver.transactionSupport==="simple")throw new OC;if(e&&e!=="READ UNCOMMITTED"&&e!=="SERIALIZABLE")throw new _("SQLite only supports SERIALIZABLE and READ UNCOMMITTED isolation");this.isTransactionActive=!0;try{await this.broadcaster.broadcast("BeforeTransactionStart")}catch(t){throw this.isTransactionActive=!1,t}this.transactionDepth===0?(e&&(e==="READ UNCOMMITTED"?await this.query("PRAGMA read_uncommitted = true"):await this.query("PRAGMA read_uncommitted = false")),await this.query("BEGIN TRANSACTION")):await this.query(`SAVEPOINT typeorm_${this.transactionDepth}`),this.transactionDepth+=1,await this.broadcaster.broadcast("AfterTransactionStart")}async commitTransaction(){if(!this.isTransactionActive)throw new Sn;await this.broadcaster.broadcast("BeforeTransactionCommit"),this.transactionDepth>1?await this.query(`RELEASE SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.query("COMMIT"),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionCommit")}async rollbackTransaction(){if(!this.isTransactionActive)throw new Sn;await this.broadcaster.broadcast("BeforeTransactionRollback"),this.transactionDepth>1?await this.query(`ROLLBACK TO SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.query("ROLLBACK"),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionRollback")}stream(e,t,n,i){throw new _("Stream is not supported by sqlite driver.")}async getDatabases(){return Promise.resolve([])}async getSchemas(e){return Promise.resolve([])}async hasDatabase(e){return Promise.resolve(!1)}async getCurrentDatabase(){return Promise.resolve(void 0)}async hasSchema(e){throw new _("This driver does not support table schemas")}async getCurrentSchema(){return Promise.resolve(void 0)}async hasTable(e){const n=`SELECT * FROM "sqlite_master" WHERE "type" = 'table' AND "name" = '${$.isTable(e)?e.name:e}'`;return!!(await this.query(n)).length}async hasColumn(e,t){const n=$.isTable(e)?e.name:e,i=`PRAGMA table_xinfo(${this.escapePath(n)})`;return!!(await this.query(i)).find(a=>a.name===t)}async createDatabase(e,t){return Promise.resolve()}async dropDatabase(e,t){return Promise.resolve()}async createSchema(e,t){return Promise.resolve()}async dropSchema(e,t){return Promise.resolve()}async createTable(e,t=!1,n=!0,i=!0){const r=[],a=[];if(t&&await this.hasTable(e))return Promise.resolve();r.push(this.createTableSql(e,n)),a.push(this.dropTableSql(e)),i&&e.indices.forEach(l=>{l.name||(l.name=this.connection.namingStrategy.indexName(e,l.columnNames,l.where)),r.push(this.createIndexSql(e,l)),a.push(this.dropIndexSql(l))});const c=e.columns.filter(l=>l.generatedType&&l.asExpression);for(const l of c){const h=this.insertTypeormMetadataSql({table:e.name,type:we.GENERATED_COLUMN,name:l.name,value:l.asExpression}),f=this.deleteTypeormMetadataSql({table:e.name,type:we.GENERATED_COLUMN,name:l.name});r.push(h),a.push(f)}await this.executeQueries(r,a)}async dropTable(e,t,n=!0,i=!0){if(t&&!await this.hasTable(e))return Promise.resolve();const r=n,a=$.isTable(e)?e:await this.getCachedTable(e),c=[],l=[];i&&a.indices.forEach(f=>{c.push(this.dropIndexSql(f)),l.push(this.createIndexSql(a,f))}),c.push(this.dropTableSql(a,t)),l.push(this.createTableSql(a,r));const h=a.columns.filter(f=>f.generatedType&&f.asExpression);for(const f of h){const p=this.deleteTypeormMetadataSql({table:a.name,type:we.GENERATED_COLUMN,name:f.name}),m=this.insertTypeormMetadataSql({table:a.name,type:we.GENERATED_COLUMN,name:f.name,value:f.asExpression});c.push(p),l.push(m)}await this.executeQueries(c,l)}async createView(e,t=!1){const n=[],i=[];n.push(this.createViewSql(e)),t&&n.push(this.insertViewDefinitionSql(e)),i.push(this.dropViewSql(e)),t&&i.push(this.deleteViewDefinitionSql(e)),await this.executeQueries(n,i)}async dropView(e){const t=$.isView(e)?e.name:e,n=await this.getCachedView(t),i=[],r=[];i.push(this.deleteViewDefinitionSql(n)),i.push(this.dropViewSql(n)),r.push(this.insertViewDefinitionSql(n)),r.push(this.createViewSql(n)),await this.executeQueries(i,r)}async renameTable(e,t){const n=$.isTable(e)?e:await this.getCachedTable(e),i=n.clone();i.name=t;const r=new x(`ALTER TABLE ${this.escapePath(n.name)} RENAME TO ${this.escapePath(t)}`),a=new x(`ALTER TABLE ${this.escapePath(t)} RENAME TO ${this.escapePath(n.name)}`);await this.executeQueries(r,a),i.uniques.forEach(c=>{const l=this.connection.namingStrategy.uniqueConstraintName(n,c.columnNames);c.name===l&&(c.name=this.connection.namingStrategy.uniqueConstraintName(i,c.columnNames))}),i.foreignKeys.forEach(c=>{const l=this.connection.namingStrategy.foreignKeyName(n,c.columnNames,this.getTablePath(c),c.referencedColumnNames);c.name===l&&(c.name=this.connection.namingStrategy.foreignKeyName(i,c.columnNames,this.getTablePath(c),c.referencedColumnNames))}),i.indices.forEach(c=>{const l=this.connection.namingStrategy.indexName(n,c.columnNames,c.where);c.name===l&&(c.name=this.connection.namingStrategy.indexName(i,c.columnNames,c.where))}),n.name=i.name,await this.recreateTable(i,n)}async addColumn(e,t){const n=$.isTable(e)?e:await this.getCachedTable(e);return this.addColumns(n,[t])}async addColumns(e,t){const n=$.isTable(e)?e:await this.getCachedTable(e),i=n.clone();t.forEach(r=>i.addColumn(r)),await this.recreateTable(i,n)}async renameColumn(e,t,n){const i=$.isTable(e)?e:await this.getCachedTable(e),r=$.isTableColumn(t)?t:i.columns.find(c=>c.name===t);if(!r)throw new _(`Column "${t}" was not found in the "${i.name}" table.`);let a;return $.isTableColumn(n)?a=n:(a=r.clone(),a.name=n),this.changeColumn(i,r,a)}async changeColumn(e,t,n){const i=$.isTable(e)?e:await this.getCachedTable(e),r=$.isTableColumn(t)?t:i.columns.find(a=>a.name===t);if(!r)throw new _(`Column "${t}" was not found in the "${i.name}" table.`);await this.changeColumns(i,[{oldColumn:r,newColumn:n}])}async changeColumns(e,t){const n=$.isTable(e)?e:await this.getCachedTable(e),i=n.clone();t.forEach(r=>{r.newColumn.name!==r.oldColumn.name&&(i.findColumnUniques(r.oldColumn).forEach(c=>{const l=this.connection.namingStrategy.uniqueConstraintName(n,c.columnNames);c.columnNames.splice(c.columnNames.indexOf(r.oldColumn.name),1),c.columnNames.push(r.newColumn.name),c.name===l&&(c.name=this.connection.namingStrategy.uniqueConstraintName(i,c.columnNames))}),i.findColumnForeignKeys(r.oldColumn).forEach(c=>{const l=this.connection.namingStrategy.foreignKeyName(n,c.columnNames,this.getTablePath(c),c.referencedColumnNames);c.columnNames.splice(c.columnNames.indexOf(r.oldColumn.name),1),c.columnNames.push(r.newColumn.name),c.name===l&&(c.name=this.connection.namingStrategy.foreignKeyName(i,c.columnNames,this.getTablePath(c),c.referencedColumnNames))}),i.findColumnIndices(r.oldColumn).forEach(c=>{const l=this.connection.namingStrategy.indexName(n,c.columnNames,c.where);c.columnNames.splice(c.columnNames.indexOf(r.oldColumn.name),1),c.columnNames.push(r.newColumn.name),c.name===l&&(c.name=this.connection.namingStrategy.indexName(i,c.columnNames,c.where))}));const a=i.columns.find(c=>c.name===r.oldColumn.name);a&&(i.columns[i.columns.indexOf(a)]=r.newColumn)}),await this.recreateTable(i,n)}async dropColumn(e,t){const n=$.isTable(e)?e:await this.getCachedTable(e),i=$.isTableColumn(t)?t:n.findColumnByName(t);if(!i)throw new _(`Column "${t}" was not found in table "${n.name}"`);await this.dropColumns(n,[i])}async dropColumns(e,t){const n=$.isTable(e)?e:await this.getCachedTable(e),i=n.clone();t.forEach(r=>{const a=$.isTableColumn(r)?r:n.findColumnByName(r);if(!a)throw new Error(`Column "${r}" was not found in table "${n.name}"`);i.removeColumn(a),i.findColumnUniques(a).forEach(c=>i.removeUniqueConstraint(c)),i.findColumnIndices(a).forEach(c=>i.removeIndex(c)),i.findColumnForeignKeys(a).forEach(c=>i.removeForeignKey(c))}),await this.recreateTable(i,n)}async createPrimaryKey(e,t){const n=$.isTable(e)?e:await this.getCachedTable(e),i=n.clone();i.columns.forEach(r=>{t.find(a=>a===r.name)&&(r.isPrimary=!0)}),await this.recreateTable(i,n),n.columns.forEach(r=>{t.find(a=>a===r.name)&&(r.isPrimary=!0)})}async updatePrimaryKeys(e,t){await Promise.resolve()}async dropPrimaryKey(e){const t=$.isTable(e)?e:await this.getCachedTable(e),n=t.clone();n.primaryColumns.forEach(i=>{i.isPrimary=!1}),await this.recreateTable(n,t),t.primaryColumns.forEach(i=>{i.isPrimary=!1})}async createUniqueConstraint(e,t){await this.createUniqueConstraints(e,[t])}async createUniqueConstraints(e,t){const n=$.isTable(e)?e:await this.getCachedTable(e),i=n.clone();t.forEach(r=>i.addUniqueConstraint(r)),await this.recreateTable(i,n)}async dropUniqueConstraint(e,t){const n=$.isTable(e)?e:await this.getCachedTable(e),i=$.isTableUnique(t)?t:n.uniques.find(r=>r.name===t);if(!i)throw new _(`Supplied unique constraint was not found in table ${n.name}`);await this.dropUniqueConstraints(n,[i])}async dropUniqueConstraints(e,t){const n=$.isTable(e)?e:await this.getCachedTable(e),i=n.clone();t.forEach(r=>i.removeUniqueConstraint(r)),await this.recreateTable(i,n)}async createCheckConstraint(e,t){await this.createCheckConstraints(e,[t])}async createCheckConstraints(e,t){const n=$.isTable(e)?e:await this.getCachedTable(e),i=n.clone();t.forEach(r=>i.addCheckConstraint(r)),await this.recreateTable(i,n)}async dropCheckConstraint(e,t){const n=$.isTable(e)?e:await this.getCachedTable(e),i=$.isTableCheck(t)?t:n.checks.find(r=>r.name===t);if(!i)throw new _(`Supplied check constraint was not found in table ${n.name}`);await this.dropCheckConstraints(n,[i])}async dropCheckConstraints(e,t){const n=$.isTable(e)?e:await this.getCachedTable(e),i=n.clone();t.forEach(r=>i.removeCheckConstraint(r)),await this.recreateTable(i,n)}async createExclusionConstraint(e,t){throw new _("Sqlite does not support exclusion constraints.")}async createExclusionConstraints(e,t){throw new _("Sqlite does not support exclusion constraints.")}async dropExclusionConstraint(e,t){throw new _("Sqlite does not support exclusion constraints.")}async dropExclusionConstraints(e,t){throw new _("Sqlite does not support exclusion constraints.")}async createForeignKey(e,t){await this.createForeignKeys(e,[t])}async createForeignKeys(e,t){const n=$.isTable(e)?e:await this.getCachedTable(e),i=n.clone();t.forEach(r=>i.addForeignKey(r)),await this.recreateTable(i,n)}async dropForeignKey(e,t){const n=$.isTable(e)?e:await this.getCachedTable(e),i=$.isTableForeignKey(t)?t:n.foreignKeys.find(r=>r.name===t);if(!i)throw new _(`Supplied foreign key was not found in table ${n.name}`);await this.dropForeignKeys(e,[i])}async dropForeignKeys(e,t){const n=$.isTable(e)?e:await this.getCachedTable(e),i=n.clone();t.forEach(r=>i.removeForeignKey(r)),await this.recreateTable(i,n)}async createIndex(e,t){const n=$.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.generateIndexName(n,t));const i=this.createIndexSql(n,t),r=this.dropIndexSql(t);await this.executeQueries(i,r),n.addIndex(t)}async createIndices(e,t){const n=t.map(i=>this.createIndex(e,i));await Promise.all(n)}async dropIndex(e,t){const n=$.isTable(e)?e:await this.getCachedTable(e),i=$.isTableIndex(t)?t:n.indices.find(c=>c.name===t);if(!i)throw new _(`Supplied index ${t} was not found in table ${n.name}`);i.name||(i.name=this.generateIndexName(n,i));const r=this.dropIndexSql(i),a=this.createIndexSql(n,i);await this.executeQueries(r,a),n.removeIndex(i)}async dropIndices(e,t){const n=t.map(i=>this.dropIndex(e,i));await Promise.all(n)}async clearTable(e){await this.query(`DELETE FROM ${this.escapePath(e)}`)}async clearDatabase(e){let t;e&&this.driver.getAttachedDatabaseHandleByRelativePath(e)&&(t=this.driver.getAttachedDatabaseHandleByRelativePath(e)),await this.query("PRAGMA foreign_keys = OFF");const n=this.isTransactionActive;n||await this.startTransaction();try{const i=t?`SELECT 'DROP VIEW "${t}"."' || name || '";' as query FROM "${t}"."sqlite_master" WHERE "type" = 'view'`:`SELECT 'DROP VIEW "' || name || '";' as query FROM "sqlite_master" WHERE "type" = 'view'`,r=await this.query(i);await Promise.all(r.map(l=>this.query(l.query)));const a=t?`SELECT 'DROP TABLE "${t}"."' || name || '";' as query FROM "${t}"."sqlite_master" WHERE "type" = 'table' AND "name" != 'sqlite_sequence'`:`SELECT 'DROP TABLE "' || name || '";' as query FROM "sqlite_master" WHERE "type" = 'table' AND "name" != 'sqlite_sequence'`,c=await this.query(a);await Promise.all(c.map(l=>this.query(l.query))),n||await this.commitTransaction()}catch(i){try{n||await this.rollbackTransaction()}catch{}throw i}finally{await this.query("PRAGMA foreign_keys = ON")}}async loadViews(e){if(!await this.hasTable(this.getTypeormMetadataTableName()))return[];e||(e=[]);const n=e.map(a=>"'"+a+"'").join(", ");let i=`SELECT "t".* FROM "${this.getTypeormMetadataTableName()}" "t" INNER JOIN "sqlite_master" s ON "s"."name" = "t"."name" AND "s"."type" = 'view' WHERE "t"."type" = '${we.VIEW}'`;return n.length>0&&(i+=` AND "t"."name" IN (${n})`),(await this.query(i)).map(a=>{const c=new Si;return c.name=a.name,c.expression=a.value,c})}async loadTableRecords(e,t){let n;const[i,r]=this.splitTablePath(e);return i&&this.driver.getAttachedDatabasePathRelativeByHandle(i)&&(n=this.driver.getAttachedDatabasePathRelativeByHandle(i)),this.query(`SELECT ${n?`'${n}'`:null} as database, ${i?`'${i}'`:null} as schema, * FROM ${i?`"${i}".`:""}${this.escapePath("sqlite_master")} WHERE "type" = '${t}' AND "${t==="table"?"name":"tbl_name"}" IN ('${r}')`)}async loadPragmaRecords(e,t){const[,n]=this.splitTablePath(e);return this.query(`PRAGMA ${t}("${n}")`)}async loadTables(e){if(e&&e.length===0)return[];let t=[],n;if(e){const i=e.filter(c=>c.split(".").length===1).map(c=>`'${c}'`),r=e.filter(c=>c.split(".").length>1),a=c=>{const l=[...r.map(h=>this.loadTableRecords(h,c))];return i.length&&l.push(this.query(`SELECT * FROM "sqlite_master" WHERE "type" = '${c}' AND "${c==="table"?"name":"tbl_name"}" IN (${i})`)),l};t=(await Promise.all(a("table"))).reduce((c,l)=>[...c,...l],[]).filter(Boolean),n=(await Promise.all(a("index"))).reduce((c,l)=>[...c,...l],[]).filter(Boolean)}else{t.push(...await this.query(`SELECT * FROM "sqlite_master" WHERE "type" = 'table'`));const r=t.map(({name:a})=>`'${a}'`).join(", ");n=await this.query(`SELECT * FROM "sqlite_master" WHERE "type" = 'index' AND "tbl_name" IN (${r})`)}return t.length===0?[]:Promise.all(t.map(async i=>{const r=i.database&&this.driver.getAttachedDatabaseHandleByRelativePath(i.database)?`${this.driver.getAttachedDatabaseHandleByRelativePath(i.database)}.${i.name}`:i.name,a=i.sql,c=a.includes("WITHOUT ROWID"),l=new pt({name:r,withoutRowid:c}),[h,f,p]=await Promise.all([this.loadPragmaRecords(r,"table_xinfo"),this.loadPragmaRecords(r,"index_list"),this.loadPragmaRecords(r,"foreign_key_list")]);let m;const T=i.sql,A=T.toUpperCase().indexOf("AUTOINCREMENT");if(A!==-1){m=T.substr(0,A);const D=m.lastIndexOf(","),se=m.lastIndexOf("(");D!==-1?(m=m.substr(D),m=m.substr(0,m.lastIndexOf('"')),m=m.substr(m.indexOf('"')+1)):se!==-1&&(m=m.substr(se),m=m.substr(0,m.lastIndexOf('"')),m=m.substr(m.indexOf('"')+1))}l.columns=await Promise.all(h.map(async D=>{const se=new nn;if(se.name=D.name,se.type=D.type.toLowerCase(),se.default=D.dflt_value!==null&&D.dflt_value!==void 0?D.dflt_value:void 0,se.isNullable=D.notnull===0,se.isPrimary=D.pk>0,se.comment="",se.isGenerated=m===D.name,se.isGenerated&&(se.generationStrategy="increment"),D.hidden===2||D.hidden===3){se.generatedType=D.hidden===2?"VIRTUAL":"STORED";const ne=this.selectTypeormMetadataSql({table:l.name,type:we.GENERATED_COLUMN,name:se.name}),ce=await this.query(ne.query,ne.parameters);ce[0]&&ce[0].value?se.asExpression=ce[0].value:se.asExpression=""}se.type==="varchar"&&(se.enum=ee.parseSqlCheckExpression(a,se.name));const V=se.type.indexOf("(");if(V!==-1){const ne=se.type,ce=ne.substr(0,V);if(this.driver.withLengthColumnTypes.find(ye=>ye===ce)){const ye=parseInt(ne.substring(V+1,ne.length-1));ye&&(se.length=ye.toString(),se.type=ce)}if(this.driver.withPrecisionColumnTypes.find(ye=>ye===ce)){const ye=new RegExp(`^${ce}\\((\\d+),?\\s?(\\d+)?\\)`),oe=ne.match(ye);oe&&oe[1]&&(se.precision=+oe[1]),this.driver.withScaleColumnTypes.find(Te=>Te===ce)&&oe&&oe[2]&&(se.scale=+oe[2]),se.type=ce}}return se}));let S;const P=[],F=/CONSTRAINT "([^"]*)" FOREIGN KEY ?\((.*?)\) REFERENCES "([^"]*)"/g;for(;(S=F.exec(a))!==null;)P.push({name:S[1],columns:S[2].substr(1,S[2].length-2).split('", "'),referencedTableName:S[3]});const B=ee.uniq(p,D=>D.id);l.foreignKeys=B.map(D=>{const se=p.filter(ye=>ye.id===D.id&&ye.table===D.table),V=se.map(ye=>ye.from),ne=se.map(ye=>ye.to),ce=P.find(ye=>ye.referencedTableName===D.table&&ye.columns.every(oe=>V.indexOf(oe)!==-1));return new Cn({name:ce==null?void 0:ce.name,columnNames:V,referencedTableName:D.table,referencedColumnNames:ne,onDelete:D.on_delete,onUpdate:D.on_update})});let q;const Z=[],re=/CONSTRAINT "([^"]*)" UNIQUE ?\((.*?)\)/g;for(;(q=re.exec(a))!==null;)Z.push({name:q[1],columns:q[2].substr(1,q[2].length-2).split('", "')});const Ee=f.filter(D=>D.origin==="u").map(D=>D.name).filter((D,se,V)=>V.indexOf(D)===se).map(async D=>{const se=f.find(ye=>ye.name===D),ne=(await this.query(`PRAGMA index_info("${se.name}")`)).sort((ye,oe)=>parseInt(ye.seqno)-parseInt(oe.seqno)).map(ye=>ye.name);if(ne.length===1){const ye=l.columns.find(oe=>!!ne.find(Te=>Te===oe.name));ye&&(ye.isUnique=!0)}const ce=Z.find(ye=>ye.columns.every(oe=>ne.indexOf(oe)!==-1));return new jt({name:ce?ce.name:this.connection.namingStrategy.uniqueConstraintName(l,ne),columnNames:ne})});l.uniques=await Promise.all(Ee);let Se;const me=/CONSTRAINT "([^"]*)" CHECK ?(\(.*?\))([,]|[)]$)/g;for(;(Se=me.exec(a))!==null;)l.checks.push(new kn({name:Se[1],expression:Se[2]}));const W=f.filter(D=>D.origin==="c").map(D=>D.name).filter((D,se,V)=>V.indexOf(D)===se).map(async D=>{const se=n.find(Xe=>Xe.name===D),V=/WHERE (.*)/.exec(se.sql),ne=f.find(Xe=>Xe.name===D),ye=(await this.query(`PRAGMA index_info("${ne.name}")`)).sort((Xe,Ge)=>parseInt(Xe.seqno)-parseInt(Ge.seqno)).map(Xe=>Xe.name),oe=`${i.database?`${i.database}.`:""}${ne.name}`,Te=ne.unique==="1"||ne.unique===1;return new Nt({table:l,name:oe,columnNames:ye,isUnique:Te,where:V?V[1]:void 0})}),Re=await Promise.all(W);return l.indices=Re.filter(D=>!!D),l}))}createTableSql(e,t,n){const i=e.columns.filter(T=>T.isPrimary),r=i.find(T=>T.isGenerated&&T.generationStrategy==="increment"),a=i.length>1;if(a&&r)throw new _("Sqlite does not support AUTOINCREMENT on composite primary key");const c=e.columns.map(T=>this.buildCreateColumnSql(T,a)).join(", "),[l]=this.splitTablePath(e.name);let h=`CREATE TABLE ${this.escapePath(e.name)} (${c}`;const[f,p]=this.splitTablePath(e.name),m=n?`${f?`${f}.`:""}${p.replace(/^temporary_/,"")}`:e.name;if(e.columns.filter(T=>T.isUnique).forEach(T=>{e.uniques.some(S=>S.columnNames.length===1&&S.columnNames[0]===T.name)||e.uniques.push(new jt({name:this.connection.namingStrategy.uniqueConstraintName(e,[T.name]),columnNames:[T.name]}))}),e.uniques.length>0){const T=e.uniques.map(A=>{const S=A.name?A.name:this.connection.namingStrategy.uniqueConstraintName(m,A.columnNames),P=A.columnNames.map(F=>`"${F}"`).join(", ");return`CONSTRAINT "${S}" UNIQUE (${P})`}).join(", ");h+=`, ${T}`}if(e.checks.length>0){const T=e.checks.map(A=>`CONSTRAINT "${A.name?A.name:this.connection.namingStrategy.checkConstraintName(m,A.expression)}" CHECK (${A.expression})`).join(", ");h+=`, ${T}`}if(e.foreignKeys.length>0&&t){const T=e.foreignKeys.filter(A=>{const[S]=this.splitTablePath(A.referencedTableName);return S===l}).map(A=>{const[,S]=this.splitTablePath(A.referencedTableName),P=A.columnNames.map(q=>`"${q}"`).join(", ");A.name||(A.name=this.connection.namingStrategy.foreignKeyName(m,A.columnNames,this.getTablePath(A),A.referencedColumnNames));const F=A.referencedColumnNames.map(q=>`"${q}"`).join(", ");let B=`CONSTRAINT "${A.name}" FOREIGN KEY (${P}) REFERENCES "${S}" (${F})`;return A.onDelete&&(B+=` ON DELETE ${A.onDelete}`),A.onUpdate&&(B+=` ON UPDATE ${A.onUpdate}`),A.deferrable&&(B+=` DEFERRABLE ${A.deferrable}`),B}).join(", ");h+=`, ${T}`}if(i.length>1){const T=i.map(A=>`"${A.name}"`).join(", ");h+=`, PRIMARY KEY (${T})`}return h+=")",e.withoutRowid&&(h+=" WITHOUT ROWID"),new x(h)}dropTableSql(e,t){const n=$.isTable(e)?e.name:e,i=t?`DROP TABLE IF EXISTS ${this.escapePath(n)}`:`DROP TABLE ${this.escapePath(n)}`;return new x(i)}createViewSql(e){return typeof e.expression=="string"?new x(`CREATE VIEW "${e.name}" AS ${e.expression}`):new x(`CREATE VIEW "${e.name}" AS ${e.expression(this.connection).getQuery()}`)}insertViewDefinitionSql(e){const t=typeof e.expression=="string"?e.expression.trim():e.expression(this.connection).getQuery();return this.insertTypeormMetadataSql({type:we.VIEW,name:e.name,value:t})}dropViewSql(e){const t=$.isView(e)?e.name:e;return new x(`DROP VIEW "${t}"`)}deleteViewDefinitionSql(e){const t=$.isView(e)?e.name:e;return this.deleteTypeormMetadataSql({type:we.VIEW,name:t})}createIndexSql(e,t){const n=t.columnNames.map(a=>`"${a}"`).join(", "),[i,r]=this.splitTablePath(e.name);return new x(`CREATE ${t.isUnique?"UNIQUE ":""}INDEX ${i?`"${i}".`:""}${this.escapePath(t.name)} ON "${r}" (${n}) ${t.where?"WHERE "+t.where:""}`)}dropIndexSql(e){const t=$.isTableIndex(e)?e.name:e;return new x(`DROP INDEX ${this.escapePath(t)}`)}buildCreateColumnSql(e,t){let n='"'+e.name+'"';return $.isColumnMetadata(e)?n+=" "+this.driver.normalizeType(e):n+=" "+this.connection.driver.createFullType(e),e.enum&&(n+=' CHECK( "'+e.name+'" IN ('+e.enum.map(i=>"'"+i+"'").join(",")+") )"),e.isPrimary&&!t&&(n+=" PRIMARY KEY"),e.isGenerated===!0&&e.generationStrategy==="increment"&&(n+=" AUTOINCREMENT"),e.collation&&(n+=" COLLATE "+e.collation),e.isNullable!==!0&&(n+=" NOT NULL"),e.asExpression?n+=` AS (${e.asExpression}) ${e.generatedType?e.generatedType:"VIRTUAL"}`:e.default!==void 0&&e.default!==null&&(n+=" DEFAULT ("+e.default+")"),n}async recreateTable(e,t,n=!0){const i=[],r=[];t.indices.forEach(h=>{i.push(this.dropIndexSql(h)),r.push(this.createIndexSql(t,h))});let[a,c]=this.splitTablePath(e.name);const[,l]=this.splitTablePath(t.name);if(e.name=c=`${a?`${a}.`:""}temporary_${c}`,i.push(this.createTableSql(e,!0,!0)),r.push(this.dropTableSql(e)),n){let h=e.columns.filter(p=>!p.generatedType).map(p=>`"${p.name}"`),f=t.columns.filter(p=>!p.generatedType).map(p=>`"${p.name}"`);f.length<h.length?h=e.columns.filter(p=>{const m=t.columns.find(T=>T.name===p.name);return m&&m.generatedType?!1:!p.generatedType&&m}).map(p=>`"${p.name}"`):f.length>h.length&&(f=t.columns.filter(p=>!p.generatedType&&e.columns.find(m=>m.name===p.name)).map(p=>`"${p.name}"`)),i.push(new x(`INSERT INTO ${this.escapePath(e.name)}(${h.join(", ")}) SELECT ${f.join(", ")} FROM ${this.escapePath(t.name)}`)),r.push(new x(`INSERT INTO ${this.escapePath(t.name)}(${f.join(", ")}) SELECT ${h.join(", ")} FROM ${this.escapePath(e.name)}`))}i.push(this.dropTableSql(t)),r.push(this.createTableSql(t,!0)),i.push(new x(`ALTER TABLE ${this.escapePath(e.name)} RENAME TO ${this.escapePath(l)}`)),r.push(new x(`ALTER TABLE ${this.escapePath(t.name)} RENAME TO ${this.escapePath(c)}`)),e.name=t.name,e.indices.forEach(h=>{h.name||(h.name=this.connection.namingStrategy.indexName(e,h.columnNames,h.where)),i.push(this.createIndexSql(e,h)),r.push(this.dropIndexSql(h))}),t.columns.filter(h=>{const f=e.columns.find(p=>p.name===h.name);return h.generatedType&&h.asExpression&&(!f||!f.generatedType&&!f.asExpression)}).forEach(h=>{const f=this.deleteTypeormMetadataSql({table:t.name,type:we.GENERATED_COLUMN,name:h.name}),p=this.insertTypeormMetadataSql({table:t.name,type:we.GENERATED_COLUMN,name:h.name,value:h.asExpression});i.push(f),r.push(p)}),e.columns.filter(h=>h.generatedType&&h.asExpression&&!t.columns.some(f=>f.name===h.name)).forEach(h=>{const f=this.insertTypeormMetadataSql({table:e.name,type:we.GENERATED_COLUMN,name:h.name,value:h.asExpression}),p=this.deleteTypeormMetadataSql({table:e.name,type:we.GENERATED_COLUMN,name:h.name});i.push(f),r.push(p)}),e.columns.filter(h=>h.generatedType&&h.asExpression).forEach(h=>{const f=t.columns.find(S=>S.name===h.name&&S.generatedType&&h.generatedType&&S.asExpression!==h.asExpression);if(!f)return;const p=this.deleteTypeormMetadataSql({table:t.name,type:we.GENERATED_COLUMN,name:f.name}),m=this.insertTypeormMetadataSql({table:e.name,type:we.GENERATED_COLUMN,name:h.name,value:h.asExpression});i.push(p),i.push(m);const T=this.insertTypeormMetadataSql({table:e.name,type:we.GENERATED_COLUMN,name:f.name,value:f.asExpression}),A=this.deleteTypeormMetadataSql({table:t.name,type:we.GENERATED_COLUMN,name:h.name});r.push(T),r.push(A)}),await this.executeQueries(i,r),this.replaceCachedTable(t,e)}splitTablePath(e){return e.indexOf(".")!==-1?e.split("."):[void 0,e]}escapePath(e,t){return($.isTable(e)||$.isView(e)?e.name:e).replace(/^\.+|\.+$/g,"").split(".").map(i=>t?i:`"${i}"`).join(".")}changeTableComment(e,t){throw new _("sqlit driver does not support change comment.")}}class Y0 extends ur{constructor(e){super(),this.driver=e,this.connection=e.connection,this.broadcaster=new ii(this)}async beforeMigration(){await this.query("PRAGMA foreign_keys = OFF")}async afterMigration(){await this.query("PRAGMA foreign_keys = ON")}async query(e,t,n=!1){if(this.isReleased)throw new Vt;const i=await this.connect();this.driver.connection.logger.logQuery(e,t,this),await this.broadcaster.broadcast("BeforeQuery",e,t);const r=new Rn,a=Date.now();try{const c=await new Promise((m,T)=>{i.executeSql(e,t,A=>m(A),A=>T(A))}),l=this.driver.options.maxQueryExecutionTime,f=Date.now()-a;this.broadcaster.broadcastAfterQueryEvent(r,e,t,!0,f,c,void 0),l&&f>l&&this.driver.connection.logger.logQuerySlow(f,e,t,this);const p=new Wn;if(e.substr(0,11)==="INSERT INTO")p.raw=c.insertId;else{const m=[];for(let T=0;T<c.rows.length;T++)m.push(c.rows.item(T));p.records=m,p.raw=m}return n?p:p.raw}catch(c){throw this.driver.connection.logger.logQueryError(c,e,t,this),this.broadcaster.broadcastAfterQueryEvent(r,e,t,!1,void 0,void 0,c),new Un(e,t,c)}finally{await r.wait()}}async startTransaction(){throw new _("Transactions are not supported by the Cordova driver")}async commitTransaction(){throw new _("Transactions are not supported by the Cordova driver")}async rollbackTransaction(){throw new _("Transactions are not supported by the Cordova driver")}async clearDatabase(){await this.query("PRAGMA foreign_keys = OFF");try{const t=await this.query(`SELECT 'DROP VIEW "' || name || '";' as query FROM "sqlite_master" WHERE "type" = 'view'`),i=await this.query(`SELECT 'DROP TABLE "' || name || '";' as query FROM "sqlite_master" WHERE "type" = 'table' AND "name" != 'sqlite_sequence'`);await Promise.all(t.map(r=>this.query(r.query))),await Promise.all(i.map(r=>this.query(r.query)))}finally{await this.query("PRAGMA foreign_keys = ON")}}parametrize(e,t=0){return Object.keys(e).map((n,i)=>`"${n}"=?`)}}class G0 extends kr{constructor(e){super(e),this.transactionSupport="none",this.database=this.options.database,this.loadDependencies()}async disconnect(){return this.queryRunner=void 0,new Promise((e,t)=>{this.databaseConnection.close(e,t)})}createQueryRunner(e){return this.queryRunner||(this.queryRunner=new Y0(this)),this.queryRunner}async createDatabaseConnection(){const e=Object.assign({},{name:this.options.database,location:this.options.location},this.options.extra||{}),t=await new Promise((n,i)=>{this.sqlite.openDatabase(e,r=>n(r),r=>i(r))});return await new Promise((n,i)=>{t.executeSql("PRAGMA foreign_keys = ON",[],()=>n(),r=>i(r))}),t}loadDependencies(){try{const e=this.options.driver||window.sqlitePlugin;this.sqlite=e}catch{throw new Fr("Cordova-SQLite","cordova-sqlite-storage")}}}class z0 extends ur{constructor(e){super(),this.driver=e,this.connection=e.connection,this.broadcaster=new ii(this)}async beforeMigration(){await this.query("PRAGMA foreign_keys = OFF")}async afterMigration(){await this.query("PRAGMA foreign_keys = ON")}async query(e,t,n=!1){if(this.isReleased)throw new Vt;const i=await this.connect();this.driver.connection.logger.logQuery(e,t,this),await this.broadcaster.broadcast("BeforeQuery",e,t);const r=new Rn,a=Date.now();return new Promise(async(c,l)=>{try{i.executeSql(e,t,async h=>{const f=this.driver.options.maxQueryExecutionTime,m=Date.now()-a;this.broadcaster.broadcastAfterQueryEvent(r,e,t,!0,m,h,void 0),f&&m>f&&this.driver.connection.logger.logQuerySlow(m,e,t,this),r.promises.length>0&&await Promise.all(r.promises);const T=new Wn;if(h!=null&&h.hasOwnProperty("rowsAffected")&&(T.affected=h.rowsAffected),h!=null&&h.hasOwnProperty("rows")){const A=[];for(let S=0;S<h.rows.length;S++)A.push(h.rows.item(S));T.raw=A,T.records=A}e.substr(0,11)==="INSERT INTO"&&(T.raw=h.insertId),c(n?T:T.raw)},h=>{this.driver.connection.logger.logQueryError(h,e,t,this),this.broadcaster.broadcastAfterQueryEvent(r,e,t,!1,void 0,void 0,h),l(new Un(e,t,h))})}catch(h){l(h)}finally{await r.wait()}})}parametrize(e,t=0){return Object.keys(e).map((n,i)=>`"${n}"=?`)}}class K0{constructor(e){this.isReplicated=!1,this.treeSupport=!0,this.transactionSupport="nested",this.supportedDataTypes=["int","integer","tinyint","smallint","mediumint","bigint","unsigned big int","int2","int8","integer","character","varchar","varying character","nchar","native character","nvarchar","text","clob","text","blob","real","double","double precision","float","real","numeric","decimal","boolean","date","time","datetime"],this.supportedUpsertTypes=["on-conflict-do-update"],this.withLengthColumnTypes=["character","varchar","varying character","nchar","native character","nvarchar","text","blob","clob"],this.spatialTypes=[],this.withPrecisionColumnTypes=["real","double","double precision","float","real","numeric","decimal","date","time","datetime"],this.withScaleColumnTypes=["real","double","double precision","float","real","numeric","decimal"],this.mappedDataTypes={createDate:"datetime",createDateDefault:"datetime('now')",updateDate:"datetime",updateDateDefault:"datetime('now')",deleteDate:"datetime",deleteDateNullable:!0,version:"integer",treeLevel:"integer",migrationId:"integer",migrationName:"varchar",migrationTimestamp:"bigint",cacheId:"int",cacheIdentifier:"varchar",cacheTime:"bigint",cacheDuration:"int",cacheQuery:"text",cacheResult:"text",metadataType:"varchar",metadataDatabase:"varchar",metadataSchema:"varchar",metadataTable:"varchar",metadataName:"varchar",metadataValue:"text"},this.cteCapabilities={enabled:!0,requiresRecursiveHint:!0},this.attachedDatabases={},this.connection=e,this.options=e.options,this.database=this.options.database,this.loadDependencies()}createQueryRunner(e){return this.queryRunner||(this.queryRunner=new z0(this)),this.queryRunner}async connect(){this.databaseConnection=await this.createDatabaseConnection()}afterConnect(){return Promise.resolve()}async disconnect(){return new Promise((e,t)=>{this.queryRunner=void 0,this.databaseConnection.close(e,t)})}hasAttachedDatabases(){return!!Object.keys(this.attachedDatabases).length}getAttachedDatabaseHandleByRelativePath(e){var t,n;return(n=(t=this.attachedDatabases)==null?void 0:t[e])==null?void 0:n.attachHandle}getAttachedDatabasePathRelativeByHandle(e){var t;return(t=Object.values(this.attachedDatabases).find(({attachHandle:n})=>e===n))==null?void 0:t.attachFilepathRelative}createSchemaBuilder(){return new co(this.connection)}preparePersistentValue(e,t){return t.transformer&&(e=Mt.transformTo(t.transformer,e)),e==null?e:t.type===Boolean||t.type==="boolean"?e===!0?1:0:t.type==="date"?pe.mixedDateToDateString(e):t.type==="time"?pe.mixedDateToTimeString(e):t.type==="datetime"||t.type===Date?pe.mixedDateToUtcDatetimeString(e):t.type==="simple-array"?pe.simpleArrayToString(e):t.type==="simple-json"?pe.simpleJsonToString(e):t.type==="simple-enum"?pe.simpleEnumToString(e):e}prepareHydratedValue(e,t){return e==null?t.transformer?Mt.transformFrom(t.transformer,e):e:(t.type===Boolean||t.type==="boolean"?e=!!e:t.type==="datetime"||t.type===Date?(e&&typeof e=="string"&&(/^\d\d\d\d-\d\d-\d\d \d\d:\d\d/.test(e)&&(e=e.replace(" ","T")),/^\d\d\d\d-\d\d-\d\dT\d\d:\d\d(:\d\d(\.\d\d\d)?)?$/.test(e)&&(e+="Z")),e=pe.normalizeHydratedDate(e)):t.type==="date"?e=pe.mixedDateToDateString(e):t.type==="time"?e=pe.mixedTimeToString(e):t.type==="simple-array"?e=pe.stringToSimpleArray(e):t.type==="simple-json"?e=pe.stringToSimpleJson(e):t.type==="simple-enum"?e=pe.stringToSimpleEnum(e,t):t.type===Number&&(e=isNaN(+e)?e:parseInt(e)),t.transformer&&(e=Mt.transformFrom(t.transformer,e)),e)}escapeQueryWithParameters(e,t,n){const i=Object.keys(n).map(r=>typeof n[r]=="boolean"?n[r]===!0?1:0:n[r]instanceof Date?pe.mixedDateToUtcDatetimeString(n[r]):n[r]);return!t||!Object.keys(t).length?[e,i]:(e=e.replace(/:(\.\.\.)?([A-Za-z0-9_.]+)/g,(r,a,c)=>{if(!t.hasOwnProperty(c))return r;const l=t[c];return a?l.map(h=>(i.push(h),this.createParameter(c,i.length-1))).join(", "):typeof l=="function"?l():typeof l=="number"?String(l):typeof l=="boolean"?(i.push(+l),this.createParameter(c,i.length-1)):l instanceof Date?(i.push(pe.mixedDateToUtcDatetimeString(l)),this.createParameter(c,i.length-1)):(i.push(l),this.createParameter(c,i.length-1))}),[e,i])}escape(e){return'"'+e+'"'}buildTableName(e,t,n){return e}parseTableName(e){const t=this.database,n=void 0;if($.isTable(e)||$.isView(e)){const r=this.parseTableName(e.schema?`"${e.schema}"."${e.name}"`:e.name);return{database:e.database||r.database||t,schema:e.schema||r.schema||n,tableName:r.tableName}}if($.isTableForeignKey(e)){const r=this.parseTableName(e.referencedTableName);return{database:e.referencedDatabase||r.database||t,schema:e.referencedSchema||r.schema||n,tableName:r.tableName}}if($.isEntityMetadata(e))return{database:e.database||t,schema:e.schema||n,tableName:e.tableName};const i=e.split(".");return i.length===3?{database:i[0]||t,schema:i[1]||n,tableName:i[2]}:i.length===2?{database:this.getAttachedDatabasePathRelativeByHandle(i[0])??t,schema:i[0],tableName:i[1]}:{database:t,schema:n,tableName:e}}normalizeType(e){return e.type===Number||e.type==="int"?"integer":e.type===String?"varchar":e.type===Date?"datetime":e.type===Boolean?"boolean":e.type==="uuid"?"varchar":e.type==="simple-array"||e.type==="simple-json"?"text":e.type==="simple-enum"?"varchar":e.type||""}normalizeDefault(e){const t=e.default;if(typeof t=="number")return""+t;if(typeof t=="boolean")return t?"1":"0";if(typeof t=="function")return t();if(typeof t=="string")return`'${t}'`;if(t!=null)return`${t}`}normalizeIsUnique(e){return e.entityMetadata.uniques.some(t=>t.columns.length===1&&t.columns[0]===e)}getColumnLength(e){return e.length?e.length.toString():""}createFullType(e){let t=e.type;return e.enum?"varchar":(e.length?t+="("+e.length+")":e.precision!==null&&e.precision!==void 0&&e.scale!==null&&e.scale!==void 0?t+="("+e.precision+","+e.scale+")":e.precision!==null&&e.precision!==void 0&&(t+="("+e.precision+")"),e.isArray&&(t+=" array"),t)}obtainMasterConnection(){return Promise.resolve()}obtainSlaveConnection(){return Promise.resolve()}createGeneratedMap(e,t,n,i){const r=e.generatedColumns.reduce((a,c)=>{let l;return c.generationStrategy==="increment"&&t&&(l=t-i+n+1),l?ee.mergeDeep(a,c.createValueMap(l)):a},{});return Object.keys(r).length>0?r:void 0}findChangedColumns(e,t){return t.filter(n=>{const i=e.find(a=>a.name===n.databaseName);return i?i.name!==n.databaseName||i.type!==this.normalizeType(n)||i.length!==n.length||i.precision!==n.precision||i.scale!==n.scale||this.normalizeDefault(n)!==i.default||i.isPrimary!==n.isPrimary||i.isNullable!==n.isNullable||i.generatedType!==n.generatedType||i.asExpression!==n.asExpression||i.isUnique!==this.normalizeIsUnique(n)||i.enum&&n.enum&&!ee.isArraysEqual(i.enum,n.enum.map(a=>a+""))||n.generationStrategy!=="uuid"&&i.isGenerated!==n.isGenerated:!1})}isReturningSqlSupported(){return!1}isUUIDGenerationSupported(){return!1}isFullTextColumnTypeSupported(){return!1}createParameter(e,t){return"?"}createDatabaseConnection(){return new Promise((e,t)=>{const n=Object.assign({},{name:this.options.database,location:this.options.location},this.options.extra||{});this.sqlite.openDatabase(n,i=>{const r=i;r.executeSql("PRAGMA foreign_keys = ON",[],a=>{e(r)},a=>{t(a)})},i=>{t(i)})})}loadDependencies(){try{const e=this.options.driver||require("react-native-sqlite-storage");this.sqlite=e}catch{throw new Fr("React-Native","react-native-sqlite-storage")}}}class J0 extends ur{constructor(e){super(),this.driver=e,this.connection=e.connection,this.broadcaster=new ii(this)}async beforeMigration(){await this.query("PRAGMA foreign_keys = OFF")}async afterMigration(){await this.query("PRAGMA foreign_keys = ON")}async query(e,t,n=!1){if(this.isReleased)throw new Vt;const i=this.driver.connection,r=await this.connect();return new Promise((a,c)=>{const l=e.substr(0,11)==="INSERT INTO";i.logger.logQuery(e,t,this);const h=(p,m)=>{const T=this.driver.options.maxQueryExecutionTime,S=Date.now()-f;T&&S>T&&i.logger.logQuerySlow(S,e,t,this),p&&(i.logger.logQueryError(p,e,t,this),c(new Un(e,t,p)));const P=new Wn;P.raw=m,!l&&Array.isArray(m)&&(P.records=m),a(n?P:P.raw)},f=Date.now();l?r.execSQL(e,t,h):r.all(e,t,h)})}parametrize(e,t=0){return Object.keys(e).map((n,i)=>`"${n}"=?`)}}class X0 extends kr{constructor(e){super(e),this.connection=e,this.options=e.options,this.database=this.options.database,this.driver=this.options.driver,this.loadDependencies()}async disconnect(){return new Promise((e,t)=>{this.queryRunner=void 0,this.databaseConnection.close().then(e).catch(t)})}createQueryRunner(e){return this.queryRunner||(this.queryRunner=new J0(this)),this.queryRunner}normalizeType(e){return e.type===Buffer?"blob":super.normalizeType(e)}createDatabaseConnection(){return new Promise((e,t)=>{const n=Object.assign({},{readOnly:this.options.readOnly,key:this.options.key,multithreading:this.options.multithreading,migrate:this.options.migrate,iosFlags:this.options.iosFlags,androidFlags:this.options.androidFlags},this.options.extra||{});new this.sqlite(this.options.database,n,(i,r)=>{if(i)return t(i);r.resultType(this.sqlite.RESULTSASOBJECT),r.execSQL("PRAGMA foreign_keys = ON",[],(a,c)=>{if(a)return t(a);e(r)})})})}loadDependencies(){if(this.sqlite=this.driver,!this.driver)throw new Fr("Nativescript","nativescript-sqlite")}}class Z0 extends ur{constructor(e){super(),this.isDirty=!1,this.driver=e,this.connection=e.connection,this.broadcaster=new ii(this)}async beforeMigration(){await this.query("PRAGMA foreign_keys = OFF")}async afterMigration(){await this.query("PRAGMA foreign_keys = ON")}async flush(){this.isDirty&&(await this.driver.autoSave(),this.isDirty=!1)}async release(){return await this.flush(),super.release()}async commitTransaction(){await super.commitTransaction(),this.isTransactionActive||await this.flush()}async query(e,t=[],n=!1){if(this.isReleased)throw new Vt;const i=e.trim().split(" ",1)[0],r=this.driver.databaseConnection;this.driver.connection.logger.logQuery(e,t,this),await this.broadcaster.broadcast("BeforeQuery",e,t);const a=new Rn,c=Date.now();let l;try{l=r.prepare(e),t&&(t=t.map(A=>typeof A<"u"?A:null),l.bind(t));const h=this.driver.options.maxQueryExecutionTime,p=Date.now()-c;h&&p>h&&this.driver.connection.logger.logQuerySlow(p,e,t,this);const m=[];for(;l.step();)m.push(l.getAsObject());this.broadcaster.broadcastAfterQueryEvent(a,e,t,!0,p,m,void 0);const T=new Wn;return T.affected=r.getRowsModified(),T.records=m,T.raw=m,l.free(),i!=="SELECT"&&(this.isDirty=!0),n?T:T.raw}catch(h){throw l&&l.free(),this.driver.connection.logger.logQueryError(h,e,t,this),this.broadcaster.broadcastAfterQueryEvent(a,e,t,!1,void 0,void 0,h),new Un(e,t,h)}finally{await a.wait()}}}class ex extends kr{constructor(e){if(super(e),this.options.autoSave&&!this.options.location&&!this.options.autoSaveCallback)throw new VC("location or autoSaveCallback");this.loadDependencies()}async connect(){this.databaseConnection=await this.createDatabaseConnection()}async disconnect(){this.queryRunner=void 0,this.databaseConnection.close()}createQueryRunner(e){return this.queryRunner||(this.queryRunner=new Z0(this)),this.queryRunner}async load(e,t=!0){if(typeof e=="string")if(Ye.type==="node")if(Ye.fileExist(e)){const n=Ye.readFileSync(e);return this.createDatabaseConnectionWithImport(n)}else{if(t)throw new _(`File ${e} does not exist`);return this.createDatabaseConnectionWithImport()}else{let n=null;if(this.options.useLocalForage)if(window.localforage)n=await window.localforage.getItem(e);else throw new _("localforage is not defined - please import localforage.js into your site");else n=Ye.getGlobalVariable().localStorage.getItem(e);if(n!=null)return this.createDatabaseConnectionWithImport(JSON.parse(n));if(t)throw new _(`File ${e} does not exist`);return this.createDatabaseConnectionWithImport()}else return this.createDatabaseConnectionWithImport(e)}async save(e){if(!e&&!this.options.location)throw new _("No location is set, specify a location parameter or add the location option to your configuration");let t="";if(e?t=e:this.options.location&&(t=this.options.location),Ye.type==="node")try{const n=Buffer.from(this.databaseConnection.export());await Ye.writeFile(t,n)}catch(n){throw new _(`Could not save database, error: ${n}`)}else{const n=this.databaseConnection.export(),i=[].slice.call(n);if(this.options.useLocalForage)if(window.localforage)await window.localforage.setItem(t,JSON.stringify(i));else throw new _("localforage is not defined - please import localforage.js into your site");else Ye.getGlobalVariable().localStorage.setItem(t,JSON.stringify(i))}}async autoSave(){var e;this.options.autoSave&&!((e=this.queryRunner)!=null&&e.isTransactionActive)&&(this.options.autoSaveCallback?await this.options.autoSaveCallback(this.export()):await this.save())}export(){return this.databaseConnection.export()}createGeneratedMap(e,t){const n=e.generatedColumns.reduce((i,r)=>{if(r.isPrimary&&r.generationStrategy==="increment"){const a="SELECT last_insert_rowid()";try{const c=this.databaseConnection.exec(a);return this.connection.logger.logQuery(a),ee.mergeDeep(i,r.createValueMap(c[0].values[0][0]))}catch(c){this.connection.logger.logQueryError(c,a,[])}}return i},{});return Object.keys(n).length>0?n:void 0}createDatabaseConnection(){return this.options.location?this.load(this.options.location,!1):this.createDatabaseConnectionWithImport(this.options.database)}async createDatabaseConnectionWithImport(e){const n=typeof this.sqlite.Database=="function"?this.sqlite:await this.sqlite(this.options.sqlJsConfig);return e&&e.length>0?this.databaseConnection=new n.Database(e):this.databaseConnection=new n.Database,this.databaseConnection.exec("PRAGMA foreign_keys = ON"),this.databaseConnection}loadDependencies(){if(Ye.type==="browser"){const e=this.options.driver||window.SQL;this.sqlite=e}else try{const e=this.options.driver||Ye.load("sql.js");this.sqlite=e}catch{throw new Fr("sql.js","sql.js")}}}class tx extends ur{constructor(e){super(),this.driver=e,this.connection=e.connection,this.broadcaster=new ii(this)}async beforeMigration(){await this.query("PRAGMA foreign_keys = OFF")}async afterMigration(){await this.query("PRAGMA foreign_keys = ON")}async query(e,t,n=!1){if(this.isReleased)throw new Vt;const i=await this.connect(),r=new Rn;this.driver.connection.logger.logQuery(e,t,this),await this.broadcaster.broadcast("BeforeQuery",e,t);const a=Date.now(),c=await i.prepareAsync(e);try{const l=await c.executeAsync(t),h=this.driver.options.maxQueryExecutionTime,p=Date.now()-a;this.broadcaster.broadcastAfterQueryEvent(r,e,t,!0,p,l,void 0),await r.wait(),h&&p>h&&this.driver.connection.logger.logQuerySlow(p,e,t,this);const m=new Wn;return m.affected=l.changes,m.records=await l.getAllAsync(),m.raw=e.startsWith("INSERT INTO")?l.lastInsertRowId:m.records,n?m:m.raw}catch(l){throw this.driver.connection.logger.logQueryError(l,e,t,this),this.broadcaster.broadcastAfterQueryEvent(r,e,t,!1,0,void 0,l),await r.wait(),new Un(e,t,l)}finally{await r.wait(),await c.finalizeAsync()}}}class nx extends kr{constructor(e){super(e),this.sqlite=this.options.driver}async disconnect(){this.queryRunner=void 0,await this.databaseConnection.closeAsync(),this.databaseConnection=void 0}createQueryRunner(){return this.queryRunner||(this.queryRunner=new tx(this)),this.queryRunner}async createDatabaseConnection(){return this.databaseConnection=await this.sqlite.openDatabaseAsync(this.options.database),await this.databaseConnection.runAsync("PRAGMA foreign_keys = ON"),this.databaseConnection}}class ix extends ur{constructor(e){super(),this.driver=e,this.connection=e.connection,this.broadcaster=new ii(this)}async startTransaction(){this.isTransactionActive=!0;try{await this.broadcaster.broadcast("BeforeTransactionStart")}catch(e){throw this.isTransactionActive=!1,e}this.transactionDepth+=1,await this.broadcaster.broadcast("AfterTransactionStart")}async commitTransaction(){if(!this.isTransactionActive&&typeof this.transaction>"u")throw new Sn;await this.broadcaster.broadcast("BeforeTransactionCommit"),this.transaction=void 0,this.isTransactionActive=!1,this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionCommit")}async rollbackTransaction(){if(!this.isTransactionActive&&typeof this.transaction>"u")throw new Sn;await this.broadcaster.broadcast("BeforeTransactionRollback"),this.transaction=void 0,this.isTransactionActive=!1,this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionRollback")}async beforeMigration(){const e=await this.connect();return new Promise((t,n)=>{e.exec([{sql:"PRAGMA foreign_keys = OFF",args:[]}],!1,i=>i?n(i):t())})}async afterMigration(){const e=await this.connect();return new Promise((t,n)=>{e.exec([{sql:"PRAGMA foreign_keys = ON",args:[]}],!1,i=>i?n(i):t())})}async query(e,t,n=!1){if(this.isReleased)throw new Vt;return new Promise(async(i,r)=>{const a=await this.connect(),c=new Rn;this.driver.connection.logger.logQuery(e,t,this),this.broadcaster.broadcastBeforeQueryEvent(c,e,t);const l=Date.now();a.transaction(async h=>{typeof this.transaction>"u"&&(await this.startTransaction(),this.transaction=h),this.transaction.executeSql(e,t,async(f,p)=>{const m=this.driver.options.maxQueryExecutionTime,A=Date.now()-l;this.broadcaster.broadcastAfterQueryEvent(c,e,t,!0,A,p,void 0),await c.wait(),m&&A>m&&this.driver.connection.logger.logQuerySlow(A,e,t,this);const S=new Wn;if(p!=null&&p.hasOwnProperty("rowsAffected")&&(S.affected=p.rowsAffected),p!=null&&p.hasOwnProperty("rows")){const P=[];for(let F=0;F<p.rows.length;F++)P.push(p.rows.item(F));S.raw=P,S.records=P}e.startsWith("INSERT INTO")&&(S.raw=p.insertId),i(n?S:S.raw)},async(f,p)=>{this.driver.connection.logger.logQueryError(p,e,t,this),this.broadcaster.broadcastAfterQueryEvent(c,e,t,!1,void 0,void 0,p),await c.wait(),r(new Un(e,t,p))})},async h=>{await this.rollbackTransaction(),r(h)},()=>{this.isTransactionActive=!1,this.transaction=void 0})})}}class rx extends kr{constructor(e){super(e),this.database=this.options.database,this.sqlite=this.options.driver}async disconnect(){return new Promise((e,t)=>{try{this.queryRunner=void 0,this.databaseConnection._db.close(),this.databaseConnection=void 0,e()}catch(n){t(n)}})}createQueryRunner(e){return this.queryRunner||(this.queryRunner=new ix(this)),this.queryRunner}createDatabaseConnection(){return new Promise((e,t)=>{try{const n=this.sqlite.openDatabase(this.options.database);n.transaction(i=>{i.executeSql("PRAGMA foreign_keys = ON",[],(r,a)=>{e(n)},(r,a)=>{t({transaction:r,error:a})})},i=>{t(i)})}catch(n){t(n)}})}}class sx{constructor(e){this.connection=e}create(){return this.isLegacyDriver?new rx(this.connection):new nx(this.connection)}get isLegacyDriver(){return!("openDatabaseAsync"in this.connection.options.driver)}}class ax extends uo{constructor(e,t){super(),this.driver=e,this.connection=e.connection,this.client=t,this.broadcaster=new ii(this)}async connect(){return{}}release(){return this.isReleased=!0,this.databaseConnection&&this.databaseConnection.release(),Promise.resolve()}async startTransaction(e){this.isTransactionActive=!0;try{await this.broadcaster.broadcast("BeforeTransactionStart")}catch(t){throw this.isTransactionActive=!1,t}this.transactionDepth===0?await this.client.startTransaction():await this.query(`SAVEPOINT typeorm_${this.transactionDepth}`),this.transactionDepth+=1,await this.broadcaster.broadcast("AfterTransactionStart")}async commitTransaction(){if(!this.isTransactionActive)throw new Sn;await this.broadcaster.broadcast("BeforeTransactionCommit"),this.transactionDepth>1?await this.query(`RELEASE SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.client.commitTransaction(),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionCommit")}async rollbackTransaction(){if(!this.isTransactionActive)throw new Sn;await this.broadcaster.broadcast("BeforeTransactionRollback"),this.transactionDepth>1?await this.query(`ROLLBACK TO SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.client.rollbackTransaction(),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionRollback")}async query(e,t,n=!1){if(this.isReleased)throw new Vt;const i=await this.client.query(e,t),r=new Wn;return r.raw=i,i!=null&&i.hasOwnProperty("records")&&Array.isArray(i.records)&&(r.records=i.records),i!=null&&i.hasOwnProperty("numberOfRecordsUpdated")&&(r.affected=i.numberOfRecordsUpdated),n?r:r.raw}stream(e,t,n,i){if(this.isReleased)throw new Vt;return new Promise(async(r,a)=>{try{const l=(await this.connect()).query(e,t);n&&l.on("end",n),i&&l.on("error",i),r(l)}catch(c){a(c)}})}async getDatabases(){return Promise.resolve([])}async getSchemas(e){throw new _("MySql driver does not support table schemas")}async hasDatabase(e){return!!(await this.query(`SELECT * FROM \`INFORMATION_SCHEMA\`.\`SCHEMATA\` WHERE \`SCHEMA_NAME\` = '${e}'`)).length}async getCurrentDatabase(){return(await this.query("SELECT DATABASE() AS `db_name`"))[0].db_name}async hasSchema(e){throw new _("MySql driver does not support table schemas")}async getCurrentSchema(){return(await this.query("SELECT SCHEMA() AS `schema_name`"))[0].schema_name}async hasTable(e){const t=this.driver.parseTableName(e),n=`SELECT * FROM \`INFORMATION_SCHEMA\`.\`COLUMNS\` WHERE \`TABLE_SCHEMA\` = '${t.database}' AND \`TABLE_NAME\` = '${t.tableName}'`;return!!(await this.query(n)).length}async hasColumn(e,t){const n=this.driver.parseTableName(e),i=$.isTableColumn(t)?t.name:t,r=`SELECT * FROM \`INFORMATION_SCHEMA\`.\`COLUMNS\` WHERE \`TABLE_SCHEMA\` = '${n.database}' AND \`TABLE_NAME\` = '${n.tableName}' AND \`COLUMN_NAME\` = '${i}'`;return!!(await this.query(r)).length}async createDatabase(e,t){const n=t?`CREATE DATABASE IF NOT EXISTS \`${e}\``:`CREATE DATABASE \`${e}\``,i=`DROP DATABASE \`${e}\``;await this.executeQueries(new x(n),new x(i))}async dropDatabase(e,t){const n=t?`DROP DATABASE IF EXISTS \`${e}\``:`DROP DATABASE \`${e}\``,i=`CREATE DATABASE \`${e}\``;await this.executeQueries(new x(n),new x(i))}async createSchema(e,t){throw new _("Schema create queries are not supported by MySql driver.")}async dropSchema(e,t){throw new _("Schema drop queries are not supported by MySql driver.")}async createTable(e,t=!1,n=!0){if(t&&await this.hasTable(e))return Promise.resolve();const i=[],r=[];return i.push(this.createTableSql(e,n)),r.push(this.dropTableSql(e)),e.indices.forEach(a=>r.push(this.dropIndexSql(e,a))),n&&e.foreignKeys.forEach(a=>r.push(this.dropForeignKeySql(e,a))),this.executeQueries(i,r)}async dropTable(e,t,n=!0){if(t&&!await this.hasTable(e))return Promise.resolve();const i=n,r=this.getTablePath(e),a=await this.getCachedTable(r),c=[],l=[];n&&a.foreignKeys.forEach(h=>c.push(this.dropForeignKeySql(a,h))),a.indices.forEach(h=>c.push(this.dropIndexSql(a,h))),c.push(this.dropTableSql(a)),l.push(this.createTableSql(a,i)),await this.executeQueries(c,l)}async createView(e,t=!1){const n=[],i=[];n.push(this.createViewSql(e)),t&&n.push(await this.insertViewDefinitionSql(e)),i.push(this.dropViewSql(e)),t&&i.push(await this.deleteViewDefinitionSql(e)),await this.executeQueries(n,i)}async dropView(e){const t=$.isView(e)?e.name:e,n=await this.getCachedView(t),i=[],r=[];i.push(await this.deleteViewDefinitionSql(n)),i.push(this.dropViewSql(n)),r.push(await this.insertViewDefinitionSql(n)),r.push(this.createViewSql(n)),await this.executeQueries(i,r)}async renameTable(e,t){const n=[],i=[],r=$.isTable(e)?e:await this.getCachedTable(e),a=r.clone(),{database:c}=this.driver.parseTableName(r);a.name=c?`${c}.${t}`:t,n.push(new x(`RENAME TABLE ${this.escapePath(r)} TO ${this.escapePath(a)}`)),i.push(new x(`RENAME TABLE ${this.escapePath(a)} TO ${this.escapePath(r)}`)),a.indices.forEach(l=>{const h=l.columnNames.map(m=>`\`${m}\``).join(", "),f=this.connection.namingStrategy.indexName(a,l.columnNames,l.where);let p="";l.isUnique&&(p+="UNIQUE "),l.isSpatial&&(p+="SPATIAL "),l.isFulltext&&(p+="FULLTEXT "),n.push(new x(`ALTER TABLE ${this.escapePath(a)} DROP INDEX \`${l.name}\`, ADD ${p}INDEX \`${f}\` (${h})`)),i.push(new x(`ALTER TABLE ${this.escapePath(a)} DROP INDEX \`${f}\`, ADD ${p}INDEX \`${l.name}\` (${h})`)),l.name=f}),a.foreignKeys.forEach(l=>{const h=l.columnNames.map(A=>`\`${A}\``).join(", "),f=l.referencedColumnNames.map(A=>`\`${A}\``).join(","),p=this.connection.namingStrategy.foreignKeyName(a,l.columnNames);let m=`ALTER TABLE ${this.escapePath(a)} DROP FOREIGN KEY \`${l.name}\`, ADD CONSTRAINT \`${p}\` FOREIGN KEY (${h}) REFERENCES ${this.escapePath(this.getTablePath(l))}(${f})`;l.onDelete&&(m+=` ON DELETE ${l.onDelete}`),l.onUpdate&&(m+=` ON UPDATE ${l.onUpdate}`);let T=`ALTER TABLE ${this.escapePath(a)} DROP FOREIGN KEY \`${p}\`, ADD CONSTRAINT \`${l.name}\` FOREIGN KEY (${h}) REFERENCES ${this.escapePath(this.getTablePath(l))}(${f})`;l.onDelete&&(T+=` ON DELETE ${l.onDelete}`),l.onUpdate&&(T+=` ON UPDATE ${l.onUpdate}`),n.push(new x(m)),i.push(new x(T)),l.name=p}),await this.executeQueries(n,i),r.name=a.name,this.replaceCachedTable(r,a)}async addColumn(e,t){const n=$.isTable(e)?e:await this.getCachedTable(e),i=n.clone(),r=[],a=[],c=i.primaryColumns.length>0;if(r.push(new x(`ALTER TABLE ${this.escapePath(n)} ADD ${this.buildCreateColumnSql(t,c,!1)}`)),a.push(new x(`ALTER TABLE ${this.escapePath(n)} DROP COLUMN \`${t.name}\``)),t.isPrimary&&c){const h=i.columns.find(m=>m.isGenerated&&m.generationStrategy==="increment");if(h){const m=h.clone();m.isGenerated=!1,m.generationStrategy=void 0,r.push(new x(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${t.name}\` ${this.buildCreateColumnSql(m,!0)}`)),a.push(new x(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${m.name}\` ${this.buildCreateColumnSql(t,!0)}`))}const f=i.primaryColumns;let p=f.map(m=>`\`${m.name}\``).join(", ");if(r.push(new x(`ALTER TABLE ${this.escapePath(n)} DROP PRIMARY KEY`)),a.push(new x(`ALTER TABLE ${this.escapePath(n)} ADD PRIMARY KEY (${p})`)),f.push(t),p=f.map(m=>`\`${m.name}\``).join(", "),r.push(new x(`ALTER TABLE ${this.escapePath(n)} ADD PRIMARY KEY (${p})`)),a.push(new x(`ALTER TABLE ${this.escapePath(n)} DROP PRIMARY KEY`)),h){const m=h.clone();m.isGenerated=!1,m.generationStrategy=void 0,r.push(new x(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${m.name}\` ${this.buildCreateColumnSql(t,!0)}`)),a.push(new x(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${t.name}\` ${this.buildCreateColumnSql(m,!0)}`))}}const l=i.indices.find(h=>h.columnNames.length===1&&h.columnNames[0]===t.name);if(l)r.push(this.createIndexSql(n,l)),a.push(this.dropIndexSql(n,l));else if(t.isUnique){const h=new Nt({name:this.connection.namingStrategy.indexName(n,[t.name]),columnNames:[t.name],isUnique:!0});i.indices.push(h),i.uniques.push(new jt({name:h.name,columnNames:h.columnNames})),r.push(new x(`ALTER TABLE ${this.escapePath(n)} ADD UNIQUE INDEX \`${h.name}\` (\`${t.name}\`)`)),a.push(new x(`ALTER TABLE ${this.escapePath(n)} DROP INDEX \`${h.name}\``))}await this.executeQueries(r,a),i.addColumn(t),this.replaceCachedTable(n,i)}async addColumns(e,t){for(const n of t)await this.addColumn(e,n)}async renameColumn(e,t,n){const i=$.isTable(e)?e:await this.getCachedTable(e),r=$.isTableColumn(t)?t:i.columns.find(c=>c.name===t);if(!r)throw new _(`Column "${t}" was not found in the "${i.name}" table.`);let a;$.isTableColumn(n)?a=n:(a=r.clone(),a.name=n),await this.changeColumn(i,r,a)}async changeColumn(e,t,n){const i=$.isTable(e)?e:await this.getCachedTable(e);let r=i.clone();const a=[],c=[],l=$.isTableColumn(t)?t:i.columns.find(h=>h.name===t);if(!l)throw new _(`Column "${t}" was not found in the "${i.name}" table.`);if(n.isGenerated!==l.isGenerated&&n.generationStrategy!=="uuid"||l.type!==n.type||l.length!==n.length||l.generatedType!==n.generatedType)await this.dropColumn(i,l),await this.addColumn(i,n),r=i.clone();else{if(n.name!==l.name){a.push(new x(`ALTER TABLE ${this.escapePath(i)} CHANGE \`${l.name}\` \`${n.name}\` ${this.buildCreateColumnSql(l,!0,!0)}`)),c.push(new x(`ALTER TABLE ${this.escapePath(i)} CHANGE \`${n.name}\` \`${l.name}\` ${this.buildCreateColumnSql(l,!0,!0)}`)),r.findColumnIndices(l).forEach(f=>{f.columnNames.splice(f.columnNames.indexOf(l.name),1),f.columnNames.push(n.name);const p=f.columnNames.map(A=>`\`${A}\``).join(", "),m=this.connection.namingStrategy.indexName(r,f.columnNames,f.where);let T="";f.isUnique&&(T+="UNIQUE "),f.isSpatial&&(T+="SPATIAL "),f.isFulltext&&(T+="FULLTEXT "),a.push(new x(`ALTER TABLE ${this.escapePath(i)} DROP INDEX \`${f.name}\`, ADD ${T}INDEX \`${m}\` (${p})`)),c.push(new x(`ALTER TABLE ${this.escapePath(i)} DROP INDEX \`${m}\`, ADD ${T}INDEX \`${f.name}\` (${p})`)),f.name=m}),r.findColumnForeignKeys(l).forEach(f=>{f.columnNames.splice(f.columnNames.indexOf(l.name),1),f.columnNames.push(n.name);const p=f.columnNames.map(P=>`\`${P}\``).join(", "),m=f.referencedColumnNames.map(P=>`\`${P}\``).join(","),T=this.connection.namingStrategy.foreignKeyName(r,f.columnNames);let A=`ALTER TABLE ${this.escapePath(i)} DROP FOREIGN KEY \`${f.name}\`, ADD CONSTRAINT \`${T}\` FOREIGN KEY (${p}) REFERENCES ${this.escapePath(this.getTablePath(f))}(${m})`;f.onDelete&&(A+=` ON DELETE ${f.onDelete}`),f.onUpdate&&(A+=` ON UPDATE ${f.onUpdate}`);let S=`ALTER TABLE ${this.escapePath(i)} DROP FOREIGN KEY \`${T}\`, ADD CONSTRAINT \`${f.name}\` FOREIGN KEY (${p}) REFERENCES ${this.escapePath(this.getTablePath(f))}(${m})`;f.onDelete&&(S+=` ON DELETE ${f.onDelete}`),f.onUpdate&&(S+=` ON UPDATE ${f.onUpdate}`),a.push(new x(A)),c.push(new x(S)),f.name=T});const h=r.columns.find(f=>f.name===l.name);r.columns[r.columns.indexOf(h)].name=n.name,l.name=n.name}if(this.isColumnChanged(l,n,!0)&&(a.push(new x(`ALTER TABLE ${this.escapePath(i)} CHANGE \`${l.name}\` ${this.buildCreateColumnSql(n,!0)}`)),c.push(new x(`ALTER TABLE ${this.escapePath(i)} CHANGE \`${n.name}\` ${this.buildCreateColumnSql(l,!0)}`))),n.isPrimary!==l.isPrimary){const h=r.columns.find(p=>p.isGenerated&&p.generationStrategy==="increment");if(h){const p=h.clone();p.isGenerated=!1,p.generationStrategy=void 0,a.push(new x(`ALTER TABLE ${this.escapePath(i)} CHANGE \`${h.name}\` ${this.buildCreateColumnSql(p,!0)}`)),c.push(new x(`ALTER TABLE ${this.escapePath(i)} CHANGE \`${p.name}\` ${this.buildCreateColumnSql(h,!0)}`))}const f=r.primaryColumns;if(f.length>0){const p=f.map(m=>`\`${m.name}\``).join(", ");a.push(new x(`ALTER TABLE ${this.escapePath(i)} DROP PRIMARY KEY`)),c.push(new x(`ALTER TABLE ${this.escapePath(i)} ADD PRIMARY KEY (${p})`))}if(n.isPrimary===!0){f.push(n);const p=r.columns.find(T=>T.name===n.name);p.isPrimary=!0;const m=f.map(T=>`\`${T.name}\``).join(", ");a.push(new x(`ALTER TABLE ${this.escapePath(i)} ADD PRIMARY KEY (${m})`)),c.push(new x(`ALTER TABLE ${this.escapePath(i)} DROP PRIMARY KEY`))}else{const p=f.find(T=>T.name===n.name);f.splice(f.indexOf(p),1);const m=r.columns.find(T=>T.name===n.name);if(m.isPrimary=!1,f.length>0){const T=f.map(A=>`\`${A.name}\``).join(", ");a.push(new x(`ALTER TABLE ${this.escapePath(i)} ADD PRIMARY KEY (${T})`)),c.push(new x(`ALTER TABLE ${this.escapePath(i)} DROP PRIMARY KEY`))}}if(h){const p=h.clone();p.isGenerated=!1,p.generationStrategy=void 0,a.push(new x(`ALTER TABLE ${this.escapePath(i)} CHANGE \`${p.name}\` ${this.buildCreateColumnSql(h,!0)}`)),c.push(new x(`ALTER TABLE ${this.escapePath(i)} CHANGE \`${h.name}\` ${this.buildCreateColumnSql(p,!0)}`))}}if(n.isUnique!==l.isUnique)if(n.isUnique===!0){const h=new Nt({name:this.connection.namingStrategy.indexName(i,[n.name]),columnNames:[n.name],isUnique:!0});r.indices.push(h),r.uniques.push(new jt({name:h.name,columnNames:h.columnNames})),a.push(new x(`ALTER TABLE ${this.escapePath(i)} ADD UNIQUE INDEX \`${h.name}\` (\`${n.name}\`)`)),c.push(new x(`ALTER TABLE ${this.escapePath(i)} DROP INDEX \`${h.name}\``))}else{const h=r.indices.find(p=>p.columnNames.length===1&&p.isUnique===!0&&!!p.columnNames.find(m=>m===n.name));r.indices.splice(r.indices.indexOf(h),1);const f=r.uniques.find(p=>p.name===h.name);r.uniques.splice(r.uniques.indexOf(f),1),a.push(new x(`ALTER TABLE ${this.escapePath(i)} DROP INDEX \`${h.name}\``)),c.push(new x(`ALTER TABLE ${this.escapePath(i)} ADD UNIQUE INDEX \`${h.name}\` (\`${n.name}\`)`))}}await this.executeQueries(a,c),this.replaceCachedTable(i,r)}async changeColumns(e,t){for(const{oldColumn:n,newColumn:i}of t)await this.changeColumn(e,n,i)}async dropColumn(e,t){const n=$.isTable(e)?e:await this.getCachedTable(e),i=$.isTableColumn(t)?t:n.findColumnByName(t);if(!i)throw new _(`Column "${t}" was not found in table "${n.name}"`);const r=n.clone(),a=[],c=[];if(i.isPrimary){const h=r.columns.find(m=>m.isGenerated&&m.generationStrategy==="increment");if(h){const m=h.clone();m.isGenerated=!1,m.generationStrategy=void 0,a.push(new x(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${h.name}\` ${this.buildCreateColumnSql(m,!0)}`)),c.push(new x(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${m.name}\` ${this.buildCreateColumnSql(h,!0)}`))}const f=r.primaryColumns.map(m=>`\`${m.name}\``).join(", ");a.push(new x(`ALTER TABLE ${this.escapePath(r)} DROP PRIMARY KEY`)),c.push(new x(`ALTER TABLE ${this.escapePath(r)} ADD PRIMARY KEY (${f})`));const p=r.findColumnByName(i.name);if(p.isPrimary=!1,r.primaryColumns.length>0){const m=r.primaryColumns.map(T=>`\`${T.name}\``).join(", ");a.push(new x(`ALTER TABLE ${this.escapePath(r)} ADD PRIMARY KEY (${m})`)),c.push(new x(`ALTER TABLE ${this.escapePath(r)} DROP PRIMARY KEY`))}if(h&&h.name!==i.name){const m=h.clone();m.isGenerated=!1,m.generationStrategy=void 0,a.push(new x(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${m.name}\` ${this.buildCreateColumnSql(h,!0)}`)),c.push(new x(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${h.name}\` ${this.buildCreateColumnSql(m,!0)}`))}}const l=r.indices.find(h=>h.columnNames.length===1&&h.columnNames[0]===i.name);if(l)r.indices.splice(r.indices.indexOf(l),1),a.push(this.dropIndexSql(n,l)),c.push(this.createIndexSql(n,l));else if(i.isUnique){const h=this.connection.namingStrategy.uniqueConstraintName(n,[i.name]),f=r.uniques.find(T=>T.name===h);f&&r.uniques.splice(r.uniques.indexOf(f),1);const p=this.connection.namingStrategy.indexName(n,[i.name]),m=r.indices.find(T=>T.name===p);m&&r.indices.splice(r.indices.indexOf(m),1),a.push(new x(`ALTER TABLE ${this.escapePath(n)} DROP INDEX \`${p}\``)),c.push(new x(`ALTER TABLE ${this.escapePath(n)} ADD UNIQUE INDEX \`${p}\` (\`${i.name}\`)`))}a.push(new x(`ALTER TABLE ${this.escapePath(n)} DROP COLUMN \`${i.name}\``)),c.push(new x(`ALTER TABLE ${this.escapePath(n)} ADD ${this.buildCreateColumnSql(i,!0)}`)),await this.executeQueries(a,c),r.removeColumn(i),this.replaceCachedTable(n,r)}async dropColumns(e,t){for(const n of[...t])await this.dropColumn(e,n)}async createPrimaryKey(e,t){const n=$.isTable(e)?e:await this.getCachedTable(e),i=n.clone(),r=this.createPrimaryKeySql(n,t),a=this.dropPrimaryKeySql(n);await this.executeQueries(r,a),i.columns.forEach(c=>{t.find(l=>l===c.name)&&(c.isPrimary=!0)}),this.replaceCachedTable(n,i)}async updatePrimaryKeys(e,t){const n=$.isTable(e)?e:await this.getCachedTable(e),i=n.clone(),r=t.map(m=>m.name),a=[],c=[],l=i.columns.find(m=>m.isGenerated&&m.generationStrategy==="increment");if(l){const m=l.clone();m.isGenerated=!1,m.generationStrategy=void 0,a.push(new x(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${l.name}\` ${this.buildCreateColumnSql(m,!0)}`)),c.push(new x(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${m.name}\` ${this.buildCreateColumnSql(l,!0)}`))}const h=i.primaryColumns;if(h.length>0){const m=h.map(T=>`\`${T.name}\``).join(", ");a.push(new x(`ALTER TABLE ${this.escapePath(n)} DROP PRIMARY KEY`)),c.push(new x(`ALTER TABLE ${this.escapePath(n)} ADD PRIMARY KEY (${m})`))}i.columns.filter(m=>r.indexOf(m.name)!==-1).forEach(m=>m.isPrimary=!0);const f=r.map(m=>`\`${m}\``).join(", ");a.push(new x(`ALTER TABLE ${this.escapePath(n)} ADD PRIMARY KEY (${f})`)),c.push(new x(`ALTER TABLE ${this.escapePath(n)} DROP PRIMARY KEY`));const p=l||t.find(m=>m.isGenerated&&m.generationStrategy==="increment");if(p){const m=p.clone();m.isGenerated=!1,m.generationStrategy=void 0,a.push(new x(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${m.name}\` ${this.buildCreateColumnSql(p,!0)}`)),c.push(new x(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${p.name}\` ${this.buildCreateColumnSql(m,!0)}`));const T=i.columns.find(A=>A.name===p.name);T.isGenerated=!0,T.generationStrategy="increment"}await this.executeQueries(a,c),this.replaceCachedTable(n,i)}async dropPrimaryKey(e){const t=$.isTable(e)?e:await this.getCachedTable(e),n=this.dropPrimaryKeySql(t),i=this.createPrimaryKeySql(t,t.primaryColumns.map(r=>r.name));await this.executeQueries(n,i),t.primaryColumns.forEach(r=>{r.isPrimary=!1})}async createUniqueConstraint(e,t){throw new _("MySql does not support unique constraints. Use unique index instead.")}async createUniqueConstraints(e,t){throw new _("MySql does not support unique constraints. Use unique index instead.")}async dropUniqueConstraint(e,t){throw new _("MySql does not support unique constraints. Use unique index instead.")}async dropUniqueConstraints(e,t){throw new _("MySql does not support unique constraints. Use unique index instead.")}async createCheckConstraint(e,t){throw new _("MySql does not support check constraints.")}async createCheckConstraints(e,t){throw new _("MySql does not support check constraints.")}async dropCheckConstraint(e,t){throw new _("MySql does not support check constraints.")}async dropCheckConstraints(e,t){throw new _("MySql does not support check constraints.")}async createExclusionConstraint(e,t){throw new _("MySql does not support exclusion constraints.")}async createExclusionConstraints(e,t){throw new _("MySql does not support exclusion constraints.")}async dropExclusionConstraint(e,t){throw new _("MySql does not support exclusion constraints.")}async dropExclusionConstraints(e,t){throw new _("MySql does not support exclusion constraints.")}async createForeignKey(e,t){const n=$.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.connection.namingStrategy.foreignKeyName(n,t.columnNames));const i=this.createForeignKeySql(n,t),r=this.dropForeignKeySql(n,t);await this.executeQueries(i,r),n.addForeignKey(t)}async createForeignKeys(e,t){const n=t.map(i=>this.createForeignKey(e,i));await Promise.all(n)}async dropForeignKey(e,t){const n=$.isTable(e)?e:await this.getCachedTable(e),i=$.isTableForeignKey(t)?t:n.foreignKeys.find(c=>c.name===t);if(!i)throw new _(`Supplied foreign key was not found in table ${n.name}`);const r=this.dropForeignKeySql(n,i),a=this.createForeignKeySql(n,i);await this.executeQueries(r,a),n.removeForeignKey(i)}async dropForeignKeys(e,t){const n=t.map(i=>this.dropForeignKey(e,i));await Promise.all(n)}async createIndex(e,t){const n=$.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.generateIndexName(n,t));const i=this.createIndexSql(n,t),r=this.dropIndexSql(n,t);await this.executeQueries(i,r),n.addIndex(t,!0)}async createIndices(e,t){const n=t.map(i=>this.createIndex(e,i));await Promise.all(n)}async dropIndex(e,t){const n=$.isTable(e)?e:await this.getCachedTable(e),i=$.isTableIndex(t)?t:n.indices.find(c=>c.name===t);if(!i)throw new _(`Supplied index ${t} was not found in table ${n.name}`);i.name||(i.name=this.generateIndexName(n,i));const r=this.dropIndexSql(n,i),a=this.createIndexSql(n,i);await this.executeQueries(r,a),n.removeIndex(i,!0)}async dropIndices(e,t){const n=t.map(i=>this.dropIndex(e,i));await Promise.all(n)}async clearTable(e){await this.query(`TRUNCATE TABLE ${this.escapePath(e)}`)}async clearDatabase(e){const t=e||this.driver.database;if(t){if(!await this.hasDatabase(t))return Promise.resolve()}else throw new _("Can not clear database. No database is specified");const n=this.isTransactionActive;n||await this.startTransaction();try{const i=`SELECT concat('DROP VIEW IF EXISTS \`', table_schema, '\`.\`', table_name, '\`') AS \`query\` FROM \`INFORMATION_SCHEMA\`.\`VIEWS\` WHERE \`TABLE_SCHEMA\` = '${t}'`,r=await this.query(i);await Promise.all(r.map(f=>this.query(f.query)));const a="SET FOREIGN_KEY_CHECKS = 0;",c=`SELECT concat('DROP TABLE IF EXISTS \`', table_schema, '\`.\`', table_name, '\`') AS \`query\` FROM \`INFORMATION_SCHEMA\`.\`TABLES\` WHERE \`TABLE_SCHEMA\` = '${t}'`,l="SET FOREIGN_KEY_CHECKS = 1;";await this.query(a);const h=await this.query(c);await Promise.all(h.map(f=>this.query(f.query))),await this.query(l),n||await this.commitTransaction()}catch(i){try{n||await this.rollbackTransaction()}catch{}throw i}}async loadViews(e){if(!await this.hasTable(this.getTypeormMetadataTableName()))return[];e||(e=[]);const n=await this.getCurrentDatabase(),i=e.map(c=>{let{database:l,tableName:h}=this.driver.parseTableName(c);return l||(l=n),`(\`t\`.\`schema\` = '${l}' AND \`t\`.\`name\` = '${h}')`}).join(" OR "),r=`SELECT \`t\`.*, \`v\`.\`check_option\` FROM ${this.escapePath(this.getTypeormMetadataTableName())} \`t\` INNER JOIN \`information_schema\`.\`views\` \`v\` ON \`v\`.\`table_schema\` = \`t\`.\`schema\` AND \`v\`.\`table_name\` = \`t\`.\`name\` WHERE \`t\`.\`type\` = '${we.VIEW}' ${i?`AND (${i})`:""}`;return(await this.query(r)).map(c=>{const l=new Si,h=c.schema===n?void 0:c.schema;return l.database=c.schema,l.name=this.driver.buildTableName(c.name,void 0,h),l.expression=c.value,l})}async loadTables(e){if(e&&e.length===0)return[];const t=[],n=await this.getCurrentDatabase();if(!e)t.push(...await this.query("SELECT TABLE_NAME, TABLE_SCHEMA FROM `INFORMATION_SCHEMA`.`TABLES`"));else{const B="SELECT TABLE_NAME, TABLE_SCHEMA FROM `INFORMATION_SCHEMA`.`TABLES` WHERE "+e.map(q=>{let[Z,re]=q.split(".");return re||(re=Z,Z=this.driver.database||n),`(\`TABLE_SCHEMA\` = '${Z}' AND \`TABLE_NAME\` = '${re}')`}).join(" OR ");t.push(...await this.query(B))}if(t.length===0)return[];const i=t.map(({TABLE_NAME:F,TABLE_SCHEMA:B})=>`(\`TABLE_SCHEMA\` = '${B}' AND \`TABLE_NAME\` = '${F}')`).join(" OR "),r="SELECT * FROM `INFORMATION_SCHEMA`.`COLUMNS` WHERE "+i,a=`SELECT * FROM \`INFORMATION_SCHEMA\`.\`KEY_COLUMN_USAGE\` WHERE \`CONSTRAINT_NAME\` = 'PRIMARY' AND (${i})`,c="SELECT `SCHEMA_NAME`, `DEFAULT_CHARACTER_SET_NAME` as `CHARSET`, `DEFAULT_COLLATION_NAME` AS `COLLATION` FROM `INFORMATION_SCHEMA`.`SCHEMATA`",h=`SELECT \`s\`.* FROM \`INFORMATION_SCHEMA\`.\`STATISTICS\` \`s\` LEFT JOIN \`INFORMATION_SCHEMA\`.\`REFERENTIAL_CONSTRAINTS\` \`rc\` ON \`s\`.\`INDEX_NAME\` = \`rc\`.\`CONSTRAINT_NAME\` WHERE (${t.map(({TABLE_NAME:F,TABLE_SCHEMA:B})=>`(\`s\`.\`TABLE_SCHEMA\` = '${B}' AND \`s\`.\`TABLE_NAME\` = '${F}')`).join(" OR ")}) AND \`s\`.\`INDEX_NAME\` != 'PRIMARY' AND \`rc\`.\`CONSTRAINT_NAME\` IS NULL`,p="SELECT `kcu`.`TABLE_SCHEMA`, `kcu`.`TABLE_NAME`, `kcu`.`CONSTRAINT_NAME`, `kcu`.`COLUMN_NAME`, `kcu`.`REFERENCED_TABLE_SCHEMA`, `kcu`.`REFERENCED_TABLE_NAME`, `kcu`.`REFERENCED_COLUMN_NAME`, `rc`.`DELETE_RULE` `ON_DELETE`, `rc`.`UPDATE_RULE` `ON_UPDATE` FROM `INFORMATION_SCHEMA`.`KEY_COLUMN_USAGE` `kcu` INNER JOIN `INFORMATION_SCHEMA`.`REFERENTIAL_CONSTRAINTS` `rc` ON `rc`.`constraint_name` = `kcu`.`constraint_name` WHERE "+t.map(({TABLE_NAME:F,TABLE_SCHEMA:B})=>`(\`kcu\`.\`TABLE_SCHEMA\` = '${B}' AND \`kcu\`.\`TABLE_NAME\` = '${F}')`).join(" OR "),[m,T,A,S,P]=await Promise.all([this.query(r),this.query(a),this.query(c),this.query(h),this.query(p)]);return t.map(F=>{const B=new pt,q=A.find(W=>W.SCHEMA_NAME===F.TABLE_SCHEMA),Z=q.COLLATION,re=q.CHARSET,Ee=F.TABLE_SCHEMA===n?void 0:F.TABLE_SCHEMA;B.database=F.TABLE_SCHEMA,B.name=this.driver.buildTableName(F.TABLE_NAME,void 0,Ee),B.columns=m.filter(W=>W.TABLE_NAME===F.TABLE_NAME&&W.TABLE_SCHEMA===F.TABLE_SCHEMA).map(W=>{const Re=S.filter(ce=>ce.TABLE_NAME===F.TABLE_NAME&&ce.TABLE_SCHEMA===F.TABLE_SCHEMA&&ce.COLUMN_NAME===W.COLUMN_NAME&&parseInt(ce.NON_UNIQUE,10)===0),D=this.connection.entityMetadatas.find(ce=>this.getTablePath(B)===this.getTablePath(ce)),se=Re.length>0&&D&&D.indices.some(ce=>Re.some(ye=>ce.name===ye.INDEX_NAME&&ce.synchronize===!1)),V=Re.every(ce=>S.some(ye=>ye.INDEX_NAME===ce.INDEX_NAME&&ye.COLUMN_NAME!==W.COLUMN_NAME)),ne=new nn;if(ne.name=W.COLUMN_NAME,ne.type=W.DATA_TYPE.toLowerCase(),ne.zerofill=W.COLUMN_TYPE.includes("zerofill"),ne.unsigned=ne.zerofill||W.COLUMN_TYPE.includes("unsigned"),this.driver.unsignedColumnTypes.includes(ne.type)){const ce=W.COLUMN_TYPE.substring(W.COLUMN_TYPE.indexOf("(")+1,W.COLUMN_TYPE.indexOf(")"));ne.width=ce&&!this.isDefaultColumnWidth(B,ne,parseInt(ce))?parseInt(ce):void 0}if(W.COLUMN_DEFAULT===null||W.COLUMN_DEFAULT===void 0?ne.default=void 0:ne.default=W.COLUMN_DEFAULT==="CURRENT_TIMESTAMP"?W.COLUMN_DEFAULT:`'${W.COLUMN_DEFAULT}'`,W.EXTRA.indexOf("on update")!==-1&&(ne.onUpdate=W.EXTRA.substring(W.EXTRA.indexOf("on update")+10)),W.GENERATION_EXPRESSION&&(ne.asExpression=W.GENERATION_EXPRESSION,ne.generatedType=W.EXTRA.indexOf("VIRTUAL")!==-1?"VIRTUAL":"STORED"),ne.isUnique=Re.length>0&&!se&&!V,ne.isNullable=W.IS_NULLABLE==="YES",ne.isPrimary=T.some(ce=>ce.TABLE_NAME===W.TABLE_NAME&&ce.TABLE_SCHEMA===W.TABLE_SCHEMA&&ce.COLUMN_NAME===W.COLUMN_NAME),ne.zerofill=W.COLUMN_TYPE.indexOf("zerofill")!==-1,ne.isGenerated=W.EXTRA.indexOf("auto_increment")!==-1,ne.isGenerated&&(ne.generationStrategy="increment"),ne.comment=typeof W.COLUMN_COMMENT=="string"&&W.COLUMN_COMMENT.length===0?void 0:W.COLUMN_COMMENT,W.CHARACTER_SET_NAME&&(ne.charset=W.CHARACTER_SET_NAME===re?void 0:W.CHARACTER_SET_NAME),W.COLLATION_NAME&&(ne.collation=W.COLLATION_NAME===Z?void 0:W.COLLATION_NAME),this.driver.withLengthColumnTypes.indexOf(ne.type)!==-1&&W.CHARACTER_MAXIMUM_LENGTH){const ce=W.CHARACTER_MAXIMUM_LENGTH.toString();ne.length=this.isDefaultColumnLength(B,ne,ce)?"":ce}if((ne.type==="decimal"||ne.type==="double"||ne.type==="float")&&(W.NUMERIC_PRECISION!==null&&!this.isDefaultColumnPrecision(B,ne,W.NUMERIC_PRECISION)&&(ne.precision=parseInt(W.NUMERIC_PRECISION)),W.NUMERIC_SCALE!==null&&!this.isDefaultColumnScale(B,ne,W.NUMERIC_SCALE)&&(ne.scale=parseInt(W.NUMERIC_SCALE))),ne.type==="enum"||ne.type==="simple-enum"||ne.type==="set"){const ce=W.COLUMN_TYPE,ye=ce.substring(ce.indexOf("(")+1,ce.lastIndexOf(")")).split(",");ne.enum=ye.map(oe=>oe.substring(1,oe.length-1)),ne.length=""}return(ne.type==="datetime"||ne.type==="time"||ne.type==="timestamp")&&W.DATETIME_PRECISION!==null&&W.DATETIME_PRECISION!==void 0&&!this.isDefaultColumnPrecision(B,ne,parseInt(W.DATETIME_PRECISION))&&(ne.precision=parseInt(W.DATETIME_PRECISION)),ne});const Se=ee.uniq(P.filter(W=>W.TABLE_NAME===F.TABLE_NAME&&W.TABLE_SCHEMA===F.TABLE_SCHEMA),W=>W.CONSTRAINT_NAME);B.foreignKeys=Se.map(W=>{const Re=P.filter(V=>V.CONSTRAINT_NAME===W.CONSTRAINT_NAME),D=W.REFERENCED_TABLE_SCHEMA===n?void 0:W.REFERENCED_TABLE_SCHEMA,se=this.driver.buildTableName(W.REFERENCED_TABLE_NAME,void 0,D);return new Cn({name:W.CONSTRAINT_NAME,columnNames:Re.map(V=>V.COLUMN_NAME),referencedDatabase:W.REFERENCED_TABLE_SCHEMA,referencedTableName:se,referencedColumnNames:Re.map(V=>V.REFERENCED_COLUMN_NAME),onDelete:W.ON_DELETE,onUpdate:W.ON_UPDATE})});const me=ee.uniq(S.filter(W=>W.TABLE_NAME===F.TABLE_NAME&&W.TABLE_SCHEMA===F.TABLE_SCHEMA),W=>W.INDEX_NAME);return B.indices=me.map(W=>{const Re=S.filter(se=>se.TABLE_SCHEMA===W.TABLE_SCHEMA&&se.TABLE_NAME===W.TABLE_NAME&&se.INDEX_NAME===W.INDEX_NAME),D=parseInt(W.NON_UNIQUE,10);return new Nt({table:B,name:W.INDEX_NAME,columnNames:Re.map(se=>se.COLUMN_NAME),isUnique:D===0,isSpatial:W.INDEX_TYPE==="SPATIAL",isFulltext:W.INDEX_TYPE==="FULLTEXT"})}),B})}createTableSql(e,t){const n=e.columns.map(r=>this.buildCreateColumnSql(r,!0)).join(", ");let i=`CREATE TABLE ${this.escapePath(e)} (${n}`;if(e.columns.filter(r=>r.isUnique).forEach(r=>{const a=e.indices.some(l=>l.columnNames.length===1&&!!l.isUnique&&l.columnNames.indexOf(r.name)!==-1),c=e.uniques.some(l=>l.columnNames.length===1&&l.columnNames.indexOf(r.name)!==-1);!a&&!c&&e.indices.push(new Nt({name:this.connection.namingStrategy.uniqueConstraintName(e,[r.name]),columnNames:[r.name],isUnique:!0}))}),e.uniques.length>0&&e.uniques.forEach(r=>{e.indices.some(c=>c.name===r.name)||e.indices.push(new Nt({name:r.name,columnNames:r.columnNames,isUnique:!0}))}),e.indices.length>0){const r=e.indices.map(a=>{const c=a.columnNames.map(h=>`\`${h}\``).join(", ");a.name||(a.name=this.connection.namingStrategy.indexName(e,a.columnNames,a.where));let l="";return a.isUnique&&(l+="UNIQUE "),a.isSpatial&&(l+="SPATIAL "),a.isFulltext&&(l+="FULLTEXT "),`${l}INDEX \`${a.name}\` (${c})`}).join(", ");i+=`, ${r}`}if(e.foreignKeys.length>0&&t){const r=e.foreignKeys.map(a=>{const c=a.columnNames.map(f=>`\`${f}\``).join(", ");a.name||(a.name=this.connection.namingStrategy.foreignKeyName(e,a.columnNames));const l=a.referencedColumnNames.map(f=>`\`${f}\``).join(", ");let h=`CONSTRAINT \`${a.name}\` FOREIGN KEY (${c}) REFERENCES ${this.escapePath(this.getTablePath(a))} (${l})`;return a.onDelete&&(h+=` ON DELETE ${a.onDelete}`),a.onUpdate&&(h+=` ON UPDATE ${a.onUpdate}`),h}).join(", ");i+=`, ${r}`}if(e.primaryColumns.length>0){const r=e.primaryColumns.map(a=>`\`${a.name}\``).join(", ");i+=`, PRIMARY KEY (${r})`}return i+=`) ENGINE=${e.engine||"InnoDB"}`,new x(i)}dropTableSql(e){return new x(`DROP TABLE ${this.escapePath(e)}`)}createViewSql(e){return typeof e.expression=="string"?new x(`CREATE VIEW ${this.escapePath(e)} AS ${e.expression}`):new x(`CREATE VIEW ${this.escapePath(e)} AS ${e.expression(this.connection).getQuery()}`)}async insertViewDefinitionSql(e){const t=await this.getCurrentDatabase(),n=typeof e.expression=="string"?e.expression.trim():e.expression(this.connection).getQuery();return this.insertTypeormMetadataSql({type:we.VIEW,schema:t,name:e.name,value:n})}dropViewSql(e){return new x(`DROP VIEW ${this.escapePath(e)}`)}async deleteViewDefinitionSql(e){const t=await this.getCurrentDatabase(),n=$.isView(e)?e.name:e;return this.deleteTypeormMetadataSql({type:we.VIEW,schema:t,name:n})}createIndexSql(e,t){const n=t.columnNames.map(r=>`\`${r}\``).join(", ");let i="";return t.isUnique&&(i+="UNIQUE "),t.isSpatial&&(i+="SPATIAL "),t.isFulltext&&(i+="FULLTEXT "),new x(`CREATE ${i}INDEX \`${t.name}\` ON ${this.escapePath(e)} (${n})`)}dropIndexSql(e,t){const n=$.isTableIndex(t)?t.name:t;return new x(`DROP INDEX \`${n}\` ON ${this.escapePath(e)}`)}createPrimaryKeySql(e,t){const n=t.map(i=>`\`${i}\``).join(", ");return new x(`ALTER TABLE ${this.escapePath(e)} ADD PRIMARY KEY (${n})`)}dropPrimaryKeySql(e){return new x(`ALTER TABLE ${this.escapePath(e)} DROP PRIMARY KEY`)}createForeignKeySql(e,t){const n=t.columnNames.map(a=>`\`${a}\``).join(", "),i=t.referencedColumnNames.map(a=>`\`${a}\``).join(",");let r=`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT \`${t.name}\` FOREIGN KEY (${n}) REFERENCES ${this.escapePath(this.getTablePath(t))}(${i})`;return t.onDelete&&(r+=` ON DELETE ${t.onDelete}`),t.onUpdate&&(r+=` ON UPDATE ${t.onUpdate}`),new x(r)}dropForeignKeySql(e,t){const n=$.isTableForeignKey(t)?t.name:t;return new x(`ALTER TABLE ${this.escapePath(e)} DROP FOREIGN KEY \`${n}\``)}escapeComment(e){return!e||e.length===0?"''":(e=e.replace(/\\/g,"\\\\").replace(/'/g,"''").replace(/\u0000/g,""),`'${e}'`)}escapePath(e){const{database:t,tableName:n}=this.driver.parseTableName(e);return t&&t!==this.driver.database?`\`${t}\`.\`${n}\``:`\`${n}\``}buildCreateColumnSql(e,t,n=!1){let i="";return n?i=this.connection.driver.createFullType(e):i=`\`${e.name}\` ${this.connection.driver.createFullType(e)}`,e.asExpression&&(i+=` AS (${e.asExpression}) ${e.generatedType?e.generatedType:"VIRTUAL"}`),e.zerofill?i+=" ZEROFILL":e.unsigned&&(i+=" UNSIGNED"),e.enum&&(i+=` (${e.enum.map(r=>"'"+r+"'").join(", ")})`),e.charset&&(i+=` CHARACTER SET "${e.charset}"`),e.collation&&(i+=` COLLATE "${e.collation}"`),e.isNullable||(i+=" NOT NULL"),e.isNullable&&(i+=" NULL"),e.isPrimary&&!t&&(i+=" PRIMARY KEY"),e.isGenerated&&e.generationStrategy==="increment"&&(i+=" AUTO_INCREMENT"),e.comment&&(i+=` COMMENT ${this.escapeComment(e.comment)}`),e.default!==void 0&&e.default!==null&&(i+=` DEFAULT ${e.default}`),e.onUpdate&&(i+=` ON UPDATE ${e.onUpdate}`),i}isDefaultColumnWidth(e,t,n){if(this.connection.hasMetadata(e.name)){const a=this.connection.getMetadata(e.name).findColumnWithDatabaseName(t.name);if(a&&a.width)return!1}const i=this.connection.driver.dataTypeDefaults&&this.connection.driver.dataTypeDefaults[t.type]&&this.connection.driver.dataTypeDefaults[t.type].width;if(i){const a=["int","tinyint","smallint","mediumint"].indexOf(t.type)!==-1;return t.unsigned&&a?i-1===n:i===n}return!1}changeTableComment(e,t){throw new _("aurora-mysql driver does not support change table comment.")}}class ox{constructor(e){this.isReplicated=!1,this.treeSupport=!0,this.transactionSupport="nested",this.supportedDataTypes=["bit","int","integer","tinyint","smallint","mediumint","bigint","float","double","double precision","real","decimal","dec","numeric","fixed","bool","boolean","date","datetime","timestamp","time","year","char","nchar","national char","varchar","nvarchar","national varchar","blob","text","tinyblob","tinytext","mediumblob","mediumtext","longblob","longtext","enum","set","binary","varbinary","json","geometry","point","linestring","polygon","multipoint","multilinestring","multipolygon","geometrycollection"],this.supportedUpsertTypes=["on-duplicate-key-update"],this.spatialTypes=["geometry","point","linestring","polygon","multipoint","multilinestring","multipolygon","geometrycollection"],this.withLengthColumnTypes=["char","varchar","nvarchar","binary","varbinary"],this.unsignedColumnTypes=["tinyint","smallint","mediumint","int","integer","bigint"],this.withPrecisionColumnTypes=["decimal","dec","numeric","fixed","float","double","double precision","real","time","datetime","timestamp"],this.withScaleColumnTypes=["decimal","dec","numeric","fixed","float","double","double precision","real"],this.mappedDataTypes={createDate:"datetime",createDatePrecision:6,createDateDefault:"CURRENT_TIMESTAMP(6)",updateDate:"datetime",updateDatePrecision:6,updateDateDefault:"CURRENT_TIMESTAMP(6)",deleteDate:"datetime",deleteDatePrecision:6,deleteDateNullable:!0,version:"int",treeLevel:"int",migrationId:"int",migrationName:"varchar",migrationTimestamp:"bigint",cacheId:"int",cacheIdentifier:"varchar",cacheTime:"bigint",cacheDuration:"int",cacheQuery:"text",cacheResult:"text",metadataType:"varchar",metadataDatabase:"varchar",metadataSchema:"varchar",metadataTable:"varchar",metadataName:"varchar",metadataValue:"text"},this.dataTypeDefaults={varchar:{length:255},nvarchar:{length:255},"national varchar":{length:255},char:{length:1},binary:{length:1},varbinary:{length:255},decimal:{precision:10,scale:0},dec:{precision:10,scale:0},numeric:{precision:10,scale:0},fixed:{precision:10,scale:0},float:{precision:12},double:{precision:22},time:{precision:0},datetime:{precision:0},timestamp:{precision:0},bit:{width:1},int:{width:11},integer:{width:11},tinyint:{width:4},smallint:{width:6},mediumint:{width:9},bigint:{width:20}},this.maxAliasLength=63,this.cteCapabilities={enabled:!1},this.connection=e,this.options=e.options,this.loadDependencies(),this.client=new this.DataApiDriver(this.options.region,this.options.secretArn,this.options.resourceArn,this.options.database,(t,n)=>this.connection.logger.logQuery(t,n),this.options.serviceConfigOptions,this.options.formatOptions),this.database=te.buildDriverOptions(this.options).database}async connect(){if(!this.database){const e=this.createQueryRunner("master");this.database=await e.getCurrentDatabase(),await e.release()}}afterConnect(){return Promise.resolve()}async disconnect(){}createSchemaBuilder(){return new co(this.connection)}createQueryRunner(e){return new ax(this,new this.DataApiDriver(this.options.region,this.options.secretArn,this.options.resourceArn,this.options.database,(t,n)=>this.connection.logger.logQuery(t,n),this.options.serviceConfigOptions,this.options.formatOptions))}escapeQueryWithParameters(e,t,n){const i=Object.keys(n).map(r=>n[r]);return!t||!Object.keys(t).length?[e,i]:(e=e.replace(/:(\.\.\.)?([A-Za-z0-9_.]+)/g,(r,a,c)=>{if(!t.hasOwnProperty(c))return r;const l=t[c];return a?l.map(h=>(i.push(h),this.createParameter(c,i.length-1))).join(", "):typeof l=="function"?l():(i.push(l),this.createParameter(c,i.length-1))}),[e,i])}escape(e){return"`"+e+"`"}buildTableName(e,t,n){const i=[e];return n&&i.unshift(n),i.join(".")}parseTableName(e){const t=this.database,n=void 0;if($.isTable(e)||$.isView(e)){const r=this.parseTableName(e.name);return{database:e.database||r.database||t,schema:e.schema||r.schema||n,tableName:r.tableName}}if($.isTableForeignKey(e)){const r=this.parseTableName(e.referencedTableName);return{database:e.referencedDatabase||r.database||t,schema:e.referencedSchema||r.schema||n,tableName:r.tableName}}if($.isEntityMetadata(e))return{database:e.database||t,schema:e.schema||n,tableName:e.tableName};const i=e.split(".");return{database:(i.length>1?i[0]:void 0)||t,schema:n,tableName:i.length>1?i[1]:i[0]}}preparePersistentValue(e,t){return t.transformer&&(e=Mt.transformTo(t.transformer,e)),!this.options.formatOptions||this.options.formatOptions.castParameters!==!1?this.client.preparePersistentValue(e,t):e==null?e:t.type===Boolean?e===!0?1:0:t.type==="date"?pe.mixedDateToDateString(e):t.type==="time"?pe.mixedDateToTimeString(e):t.type==="json"?JSON.stringify(e):t.type==="timestamp"||t.type==="datetime"||t.type===Date?pe.mixedDateToDate(e):t.type==="simple-array"||t.type==="set"?pe.simpleArrayToString(e):t.type==="simple-json"?pe.simpleJsonToString(e):t.type==="enum"||t.type==="simple-enum"?""+e:e}prepareHydratedValue(e,t){return e==null?t.transformer?Mt.transformFrom(t.transformer,e):e:!this.options.formatOptions||this.options.formatOptions.castParameters!==!1?this.client.prepareHydratedValue(e,t):(t.type===Boolean||t.type==="bool"||t.type==="boolean"?e=!!e:t.type==="datetime"||t.type===Date?e=pe.normalizeHydratedDate(e):t.type==="date"?e=pe.mixedDateToDateString(e):t.type==="json"?e=typeof e=="string"?JSON.parse(e):e:t.type==="time"?e=pe.mixedTimeToString(e):t.type==="simple-array"||t.type==="set"?e=pe.stringToSimpleArray(e):t.type==="simple-json"?e=pe.stringToSimpleJson(e):(t.type==="enum"||t.type==="simple-enum")&&t.enum&&!isNaN(e)&&t.enum.indexOf(parseInt(e))>=0?e=parseInt(e):t.type===Number&&(e=isNaN(+e)?e:parseInt(e)),t.transformer&&(e=Mt.transformFrom(t.transformer,e)),e)}normalizeType(e){return e.type===Number||e.type==="integer"?"int":e.type===String?"varchar":e.type===Date?"datetime":e.type===Buffer?"blob":e.type===Boolean?"tinyint":e.type==="uuid"?"varchar":e.type==="simple-array"||e.type==="simple-json"?"text":e.type==="simple-enum"?"enum":e.type==="double precision"||e.type==="real"?"double":e.type==="dec"||e.type==="numeric"||e.type==="fixed"?"decimal":e.type==="bool"||e.type==="boolean"?"tinyint":e.type==="nvarchar"||e.type==="national varchar"?"varchar":e.type==="nchar"||e.type==="national char"?"char":e.type||""}normalizeDefault(e){const t=e.default;if(t!==null){if((e.type==="enum"||e.type==="simple-enum")&&t!==void 0)return`'${t}'`;if(e.type==="set"&&t!==void 0)return`'${pe.simpleArrayToString(t)}'`;if(typeof t=="number")return`${t}`;if(typeof t=="boolean")return t?"1":"0";if(typeof t=="function")return t();if(typeof t=="string")return`'${t}'`;if(t!==void 0)return`${t}`}}normalizeIsUnique(e){return e.entityMetadata.indices.some(t=>t.isUnique&&t.columns.length===1&&t.columns[0]===e)}getColumnLength(e){if(e.length)return e.length.toString();if(e.generationStrategy==="uuid")return"36";switch(e.type){case String:case"varchar":case"nvarchar":case"national varchar":return"255";case"varbinary":return"255";default:return""}}createFullType(e){let t=e.type;return this.getColumnLength(e)?t+=`(${this.getColumnLength(e)})`:e.width?t+=`(${e.width})`:e.precision!==null&&e.precision!==void 0&&e.scale!==null&&e.scale!==void 0?t+=`(${e.precision},${e.scale})`:e.precision!==null&&e.precision!==void 0&&(t+=`(${e.precision})`),e.isArray&&(t+=" array"),t}obtainMasterConnection(){return new Promise((e,t)=>{this.poolCluster?this.poolCluster.getConnection("MASTER",(n,i)=>{n?t(n):e(this.prepareDbConnection(i))}):this.pool?this.pool.getConnection((n,i)=>{n?t(n):e(this.prepareDbConnection(i))}):t(new _("Connection is not established with mysql database"))})}obtainSlaveConnection(){return this.poolCluster?new Promise((e,t)=>{this.poolCluster.getConnection("SLAVE*",(n,i)=>{n?t(n):e(this.prepareDbConnection(i))})}):this.obtainMasterConnection()}createGeneratedMap(e,t,n){const i=e.generatedColumns.reduce((r,a)=>{let c;return a.generationStrategy==="increment"&&t.insertId&&(c=t.insertId+n),ee.mergeDeep(r,a.createValueMap(c))},{});return Object.keys(i).length>0?i:void 0}findChangedColumns(e,t){return t.filter(n=>{const i=e.find(a=>a.name===n.databaseName);if(!i)return!1;let r=n.length;return!r&&n.generationStrategy==="uuid"&&(r=this.getColumnLength(n)),i.name!==n.databaseName||i.type!==this.normalizeType(n)||i.length!==r||i.width!==n.width||i.precision!==n.precision||i.scale!==n.scale||i.zerofill!==n.zerofill||i.unsigned!==n.unsigned||i.asExpression!==n.asExpression||i.generatedType!==n.generatedType||i.comment!==this.escapeComment(n.comment)||!this.compareDefaultValues(this.normalizeDefault(n),i.default)||i.enum&&n.enum&&!ee.isArraysEqual(i.enum,n.enum.map(a=>a+""))||i.onUpdate!==n.onUpdate||i.isPrimary!==n.isPrimary||i.isNullable!==n.isNullable||i.isUnique!==this.normalizeIsUnique(n)||n.generationStrategy!=="uuid"&&i.isGenerated!==n.isGenerated})}isReturningSqlSupported(){return!1}isUUIDGenerationSupported(){return!1}isFullTextColumnTypeSupported(){return!0}createParameter(e,t){return"?"}loadDependencies(){const e=this.options.driver||Ye.load("typeorm-aurora-data-api-driver");this.DataApiDriver=e,this.DataApiDriver=this.DataApiDriver.default||this.DataApiDriver}createConnectionOptions(e,t){return t=Object.assign({},t,te.buildDriverOptions(t)),Object.assign({},{resourceArn:e.resourceArn,secretArn:e.secretArn,database:e.database,region:e.region,type:e.type},{host:t.host,user:t.username,password:t.password,database:t.database,port:t.port,ssl:e.ssl},e.extra||{})}async createPool(e){return{}}prepareDbConnection(e){const{logger:t}=this.connection;return e.listeners("error").length===0&&e.on("error",n=>t.log("warn",`MySQL connection raised an error. ${n}`)),e}compareDefaultValues(e,t){return typeof e=="string"&&typeof t=="string"&&(e=e.replace(/^'+|'+$/g,""),t=t.replace(/^'+|'+$/g,"")),e===t}escapeComment(e){return e&&(e=e.replace(/\u0000/g,""),e)}}class cx extends uo{constructor(e,t){super(),this.driver=e,this.connection=e.connection,this.mode=t,this.broadcaster=new ii(this)}connect(){return this.databaseConnection?Promise.resolve(this.databaseConnection):this.databaseConnectionPromise?this.databaseConnectionPromise:(this.mode==="slave"&&this.driver.isReplicated?this.databaseConnectionPromise=this.driver.obtainSlaveConnection().then(([e,t])=>{this.driver.connectedQueryRunners.push(this),this.databaseConnection=e;const n=i=>this.releasePostgresConnection(i);return this.releaseCallback=i=>{this.databaseConnection.removeListener("error",n),t(i)},this.databaseConnection.on("error",n),this.databaseConnection}):this.databaseConnectionPromise=this.driver.obtainMasterConnection().then(([e,t])=>{this.driver.connectedQueryRunners.push(this),this.databaseConnection=e;const n=i=>this.releasePostgresConnection(i);return this.releaseCallback=i=>{this.databaseConnection.removeListener("error",n),t(i)},this.databaseConnection.on("error",n),this.databaseConnection}),this.databaseConnectionPromise)}async releasePostgresConnection(e){if(this.isReleased)return;this.isReleased=!0,this.releaseCallback&&(this.releaseCallback(e),this.releaseCallback=void 0);const t=this.driver.connectedQueryRunners.indexOf(this);t!==-1&&this.driver.connectedQueryRunners.splice(t,1)}release(){return this.releasePostgresConnection()}async startTransaction(e){this.isTransactionActive=!0;try{await this.broadcaster.broadcast("BeforeTransactionStart")}catch(t){throw this.isTransactionActive=!1,t}this.transactionDepth===0?(await this.query("START TRANSACTION"),e&&await this.query("SET TRANSACTION ISOLATION LEVEL "+e)):await this.query(`SAVEPOINT typeorm_${this.transactionDepth}`),this.transactionDepth+=1,await this.broadcaster.broadcast("AfterTransactionStart")}async commitTransaction(){if(!this.isTransactionActive)throw new Sn;await this.broadcaster.broadcast("BeforeTransactionCommit"),this.transactionDepth>1?await this.query(`RELEASE SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.query("COMMIT"),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionCommit")}async rollbackTransaction(){if(!this.isTransactionActive)throw new Sn;await this.broadcaster.broadcast("BeforeTransactionRollback"),this.transactionDepth>1?await this.query(`ROLLBACK TO SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.query("ROLLBACK"),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionRollback")}async query(e,t,n=!1){if(this.isReleased)throw new Vt;const i=await this.connect();this.driver.connection.logger.logQuery(e,t,this),await this.broadcaster.broadcast("BeforeQuery",e,t);const r=new Rn;try{const a=Date.now(),c=await i.query(e,t),l=this.driver.options.maxQueryExecutionTime,f=Date.now()-a;this.broadcaster.broadcastAfterQueryEvent(r,e,t,!0,f,c,void 0),l&&f>l&&this.driver.connection.logger.logQuerySlow(f,e,t,this);const p=new Wn;if(c){switch(c.hasOwnProperty("rows")&&(p.records=c.rows),c.hasOwnProperty("rowCount")&&(p.affected=c.rowCount),c.command){case"DELETE":case"UPDATE":p.raw=[c.rows,c.rowCount];break;default:p.raw=c.rows}if(!n)return p.raw}return p}catch(a){throw this.driver.connection.logger.logQueryError(a,e,t,this),this.broadcaster.broadcastAfterQueryEvent(r,e,t,!1,void 0,void 0,a),new Un(e,t,a)}finally{await r.wait()}}async stream(e,t,n,i){const r=this.driver.loadStreamDependency();if(this.isReleased)throw new Vt;const a=await this.connect();this.driver.connection.logger.logQuery(e,t,this);const c=a.query(new r(e,t));return n&&c.on("end",n),i&&c.on("error",i),c}async getDatabases(){return Promise.resolve([])}async getSchemas(e){return Promise.resolve([])}async hasDatabase(e){return!!(await this.query(`SELECT * FROM pg_database WHERE datname='${e}';`)).length}async getCurrentDatabase(){return(await this.query("SELECT * FROM current_database()"))[0].current_database}async hasSchema(e){return!!(await this.query(`SELECT * FROM "information_schema"."schemata" WHERE "schema_name" = '${e}'`)).length}async getCurrentSchema(){return(await this.query("SELECT * FROM current_schema()"))[0].current_schema}async hasTable(e){const t=this.driver.parseTableName(e);t.schema||(t.schema=await this.getCurrentSchema());const n=`SELECT * FROM "information_schema"."tables" WHERE "table_schema" = '${t.schema}' AND "table_name" = '${t.tableName}'`;return!!(await this.query(n)).length}async hasColumn(e,t){const n=this.driver.parseTableName(e);n.schema||(n.schema=await this.getCurrentSchema());const i=`SELECT * FROM "information_schema"."columns" WHERE "table_schema" = '${n.schema}' AND "table_name" = '${n.tableName}' AND "column_name" = '${t}'`;return!!(await this.query(i)).length}async createDatabase(e,t){if(t&&await this.hasDatabase(e))return Promise.resolve();const n=`CREATE DATABASE "${e}"`,i=`DROP DATABASE "${e}"`;await this.executeQueries(new x(n),new x(i))}async dropDatabase(e,t){const n=t?`DROP DATABASE IF EXISTS "${e}"`:`DROP DATABASE "${e}"`,i=`CREATE DATABASE "${e}"`;await this.executeQueries(new x(n),new x(i))}async createSchema(e,t){const n=e.indexOf(".")===-1?e:e.split(".")[1],i=t?`CREATE SCHEMA IF NOT EXISTS "${n}"`:`CREATE SCHEMA "${n}"`,r=`DROP SCHEMA "${n}" CASCADE`;await this.executeQueries(new x(i),new x(r))}async dropSchema(e,t,n){const i=e.indexOf(".")===-1?e:e.split(".")[1],r=t?`DROP SCHEMA IF EXISTS "${i}" ${n?"CASCADE":""}`:`DROP SCHEMA "${i}" ${n?"CASCADE":""}`,a=`CREATE SCHEMA "${i}"`;await this.executeQueries(new x(r),new x(a))}async createTable(e,t=!1,n=!0,i=!0){if(t&&await this.hasTable(e))return Promise.resolve();const r=[],a=[],c=e.columns.filter(f=>f.type==="enum"||f.type==="simple-enum"),l=[];for(const f of c){const p=await this.hasEnumType(e,f),m=this.buildEnumName(e,f);!p&&l.indexOf(m)===-1&&(l.push(m),r.push(this.createEnumTypeSql(e,f,m)),a.push(this.dropEnumTypeSql(e,f,m)))}const h=e.columns.filter(f=>f.generatedType==="STORED"&&f.asExpression);for(const f of h){const p=(await this.getTableNameWithSchema(e.name)).split("."),m=p[1],T=p[0],A=this.insertTypeormMetadataSql({database:this.driver.database,schema:T,table:m,type:we.GENERATED_COLUMN,name:f.name,value:f.asExpression}),S=this.deleteTypeormMetadataSql({database:this.driver.database,schema:T,table:m,type:we.GENERATED_COLUMN,name:f.name});r.push(A),a.push(S)}r.push(this.createTableSql(e,n)),a.push(this.dropTableSql(e)),n&&e.foreignKeys.forEach(f=>a.push(this.dropForeignKeySql(e,f))),i&&e.indices.forEach(f=>{f.name||(f.name=this.connection.namingStrategy.indexName(e,f.columnNames,f.where)),r.push(this.createIndexSql(e,f)),a.push(this.dropIndexSql(e,f))}),e.comment&&(r.push(new x("COMMENT ON TABLE "+this.escapePath(e)+" IS '"+e.comment+"'")),a.push(new x("COMMENT ON TABLE "+this.escapePath(e)+" IS NULL"))),await this.executeQueries(r,a)}async dropTable(e,t,n=!0,i=!0){if(t&&!await this.hasTable(e))return Promise.resolve();const r=n,a=this.getTablePath(e),c=await this.getCachedTable(a),l=[],h=[];i&&c.indices.forEach(p=>{l.push(this.dropIndexSql(c,p)),h.push(this.createIndexSql(c,p))}),n&&c.foreignKeys.forEach(p=>l.push(this.dropForeignKeySql(c,p))),l.push(this.dropTableSql(c)),h.push(this.createTableSql(c,r));const f=c.columns.filter(p=>p.generatedType&&p.asExpression);for(const p of f){const m=(await this.getTableNameWithSchema(c.name)).split("."),T=m[1],A=m[0],S=this.deleteTypeormMetadataSql({database:this.driver.database,schema:A,table:T,type:we.GENERATED_COLUMN,name:p.name}),P=this.insertTypeormMetadataSql({database:this.driver.database,schema:A,table:T,type:we.GENERATED_COLUMN,name:p.name,value:p.asExpression});l.push(S),h.push(P)}await this.executeQueries(l,h)}async createView(e,t=!1){const n=[],i=[];n.push(this.createViewSql(e)),t&&n.push(await this.insertViewDefinitionSql(e)),i.push(this.dropViewSql(e)),t&&i.push(await this.deleteViewDefinitionSql(e)),await this.executeQueries(n,i)}async dropView(e){const t=$.isView(e)?e.name:e,n=await this.getCachedView(t),i=[],r=[];i.push(await this.deleteViewDefinitionSql(n)),i.push(this.dropViewSql(n)),r.push(await this.insertViewDefinitionSql(n)),r.push(this.createViewSql(n)),await this.executeQueries(i,r)}async renameTable(e,t){const n=[],i=[],r=$.isTable(e)?e:await this.getCachedTable(e),a=r.clone(),{schema:c,tableName:l}=this.driver.parseTableName(r);if(a.name=c?`${c}.${t}`:t,n.push(new x(`ALTER TABLE ${this.escapePath(r)} RENAME TO "${t}"`)),i.push(new x(`ALTER TABLE ${this.escapePath(a)} RENAME TO "${l}"`)),a.primaryColumns.length>0&&!a.primaryColumns[0].primaryKeyConstraintName){const f=a.primaryColumns.map(T=>T.name),p=this.connection.namingStrategy.primaryKeyName(r,f),m=this.connection.namingStrategy.primaryKeyName(a,f);n.push(new x(`ALTER TABLE ${this.escapePath(a)} RENAME CONSTRAINT "${p}" TO "${m}"`)),i.push(new x(`ALTER TABLE ${this.escapePath(a)} RENAME CONSTRAINT "${m}" TO "${p}"`))}a.columns.map(f=>{if(f.isGenerated&&f.generationStrategy==="increment"){const p=this.buildSequencePath(r,f.name),m=this.buildSequenceName(r,f.name),T=this.buildSequencePath(a,f.name),A=this.buildSequenceName(a,f.name),S=`ALTER SEQUENCE ${this.escapePath(p)} RENAME TO "${A}"`,P=`ALTER SEQUENCE ${this.escapePath(T)} RENAME TO "${m}"`;n.push(new x(S)),i.push(new x(P))}}),a.uniques.forEach(f=>{const p=this.connection.namingStrategy.uniqueConstraintName(r,f.columnNames);if(f.name!==p)return;const m=this.connection.namingStrategy.uniqueConstraintName(a,f.columnNames);n.push(new x(`ALTER TABLE ${this.escapePath(a)} RENAME CONSTRAINT "${f.name}" TO "${m}"`)),i.push(new x(`ALTER TABLE ${this.escapePath(a)} RENAME CONSTRAINT "${m}" TO "${f.name}"`)),f.name=m}),a.indices.forEach(f=>{const p=this.connection.namingStrategy.indexName(r,f.columnNames,f.where);if(f.name!==p)return;const{schema:m}=this.driver.parseTableName(a),T=this.connection.namingStrategy.indexName(a,f.columnNames,f.where),A=m?`ALTER INDEX "${m}"."${f.name}" RENAME TO "${T}"`:`ALTER INDEX "${f.name}" RENAME TO "${T}"`,S=m?`ALTER INDEX "${m}"."${T}" RENAME TO "${f.name}"`:`ALTER INDEX "${T}" RENAME TO "${f.name}"`;n.push(new x(A)),i.push(new x(S)),f.name=T}),a.foreignKeys.forEach(f=>{const p=this.connection.namingStrategy.foreignKeyName(r,f.columnNames,this.getTablePath(f),f.referencedColumnNames);if(f.name!==p)return;const m=this.connection.namingStrategy.foreignKeyName(a,f.columnNames,this.getTablePath(f),f.referencedColumnNames);n.push(new x(`ALTER TABLE ${this.escapePath(a)} RENAME CONSTRAINT "${f.name}" TO "${m}"`)),i.push(new x(`ALTER TABLE ${this.escapePath(a)} RENAME CONSTRAINT "${m}" TO "${f.name}"`)),f.name=m});const h=a.columns.filter(f=>f.type==="enum"||f.type==="simple-enum");for(const f of h){if(f.enumName)continue;const p=await this.getUserDefinedTypeName(r,f);n.push(new x(`ALTER TYPE "${p.schema}"."${p.name}" RENAME TO ${this.buildEnumName(a,f,!1)}`)),i.push(new x(`ALTER TYPE ${this.buildEnumName(a,f)} RENAME TO "${p.name}"`))}await this.executeQueries(n,i)}async addColumn(e,t){const n=$.isTable(e)?e:await this.getCachedTable(e),i=n.clone(),r=[],a=[];if((t.type==="enum"||t.type==="simple-enum")&&(await this.hasEnumType(n,t)||(r.push(this.createEnumTypeSql(n,t)),a.push(this.dropEnumTypeSql(n,t)))),r.push(new x(`ALTER TABLE ${this.escapePath(n)} ADD ${this.buildCreateColumnSql(n,t)}`)),a.push(new x(`ALTER TABLE ${this.escapePath(n)} DROP COLUMN "${t.name}"`)),t.isPrimary){const l=i.primaryColumns;if(l.length>0){const p=l[0].primaryKeyConstraintName?l[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(i,l.map(T=>T.name)),m=l.map(T=>`"${T.name}"`).join(", ");r.push(new x(`ALTER TABLE ${this.escapePath(n)} DROP CONSTRAINT "${p}"`)),a.push(new x(`ALTER TABLE ${this.escapePath(n)} ADD CONSTRAINT "${p}" PRIMARY KEY (${m})`))}l.push(t);const h=l[0].primaryKeyConstraintName?l[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(i,l.map(p=>p.name)),f=l.map(p=>`"${p.name}"`).join(", ");r.push(new x(`ALTER TABLE ${this.escapePath(n)} ADD CONSTRAINT "${h}" PRIMARY KEY (${f})`)),a.push(new x(`ALTER TABLE ${this.escapePath(n)} DROP CONSTRAINT "${h}"`))}const c=i.indices.find(l=>l.columnNames.length===1&&l.columnNames[0]===t.name);if(c&&(r.push(this.createIndexSql(n,c)),a.push(this.dropIndexSql(n,c))),t.isUnique){const l=new jt({name:this.connection.namingStrategy.uniqueConstraintName(n,[t.name]),columnNames:[t.name]});i.uniques.push(l),r.push(new x(`ALTER TABLE ${this.escapePath(n)} ADD CONSTRAINT "${l.name}" UNIQUE ("${t.name}")`)),a.push(new x(`ALTER TABLE ${this.escapePath(n)} DROP CONSTRAINT "${l.name}"`))}if(t.generatedType==="STORED"&&t.asExpression){const l=(await this.getTableNameWithSchema(n.name)).split("."),h=l[1],f=l[0],p=this.insertTypeormMetadataSql({database:this.driver.database,schema:f,table:h,type:we.GENERATED_COLUMN,name:t.name,value:t.asExpression}),m=this.deleteTypeormMetadataSql({database:this.driver.database,schema:f,table:h,type:we.GENERATED_COLUMN,name:t.name});r.push(p),a.push(m)}t.comment&&(r.push(new x(`COMMENT ON COLUMN ${this.escapePath(n)}."${t.name}" IS ${this.escapeComment(t.comment)}`)),a.push(new x(`COMMENT ON COLUMN ${this.escapePath(n)}."${t.name}" IS ${this.escapeComment(t.comment)}`))),await this.executeQueries(r,a),i.addColumn(t),this.replaceCachedTable(n,i)}async addColumns(e,t){for(const n of t)await this.addColumn(e,n)}async renameColumn(e,t,n){const i=$.isTable(e)?e:await this.getCachedTable(e),r=$.isTableColumn(t)?t:i.columns.find(c=>c.name===t);if(!r)throw new _(`Column "${t}" was not found in the "${i.name}" table.`);let a;return $.isTableColumn(n)?a=n:(a=r.clone(),a.name=n),this.changeColumn(i,r,a)}async changeColumn(e,t,n){const i=$.isTable(e)?e:await this.getCachedTable(e);let r=i.clone();const a=[],c=[];let l=!1;const h=$.isTableColumn(t)?t:i.columns.find(f=>f.name===t);if(!h)throw new _(`Column "${t}" was not found in the "${i.name}" table.`);if(h.type!==n.type||h.length!==n.length||n.isArray!==h.isArray||!h.generatedType&&n.generatedType==="STORED"||h.asExpression!==n.asExpression&&n.generatedType==="STORED")await this.dropColumn(i,h),await this.addColumn(i,n),r=i.clone();else{if(h.name!==n.name){if(a.push(new x(`ALTER TABLE ${this.escapePath(i)} RENAME COLUMN "${h.name}" TO "${n.name}"`)),c.push(new x(`ALTER TABLE ${this.escapePath(i)} RENAME COLUMN "${n.name}" TO "${h.name}"`)),h.type==="enum"||h.type==="simple-enum"){const p=await this.getUserDefinedTypeName(i,h);a.push(new x(`ALTER TYPE "${p.schema}"."${p.name}" RENAME TO ${this.buildEnumName(i,n,!1)}`)),c.push(new x(`ALTER TYPE ${this.buildEnumName(i,n)} RENAME TO "${p.name}"`))}if(h.isPrimary===!0&&!h.primaryKeyConstraintName){const m=r.primaryColumns.map(S=>S.name),T=this.connection.namingStrategy.primaryKeyName(r,m);m.splice(m.indexOf(h.name),1),m.push(n.name);const A=this.connection.namingStrategy.primaryKeyName(r,m);a.push(new x(`ALTER TABLE ${this.escapePath(i)} RENAME CONSTRAINT "${T}" TO "${A}"`)),c.push(new x(`ALTER TABLE ${this.escapePath(i)} RENAME CONSTRAINT "${A}" TO "${T}"`))}if(h.isGenerated===!0&&n.generationStrategy==="increment"){const p=this.buildSequencePath(i,h.name),m=this.buildSequenceName(i,h.name),T=this.buildSequencePath(i,n.name),A=this.buildSequenceName(i,n.name),S=`ALTER SEQUENCE ${this.escapePath(p)} RENAME TO "${A}"`,P=`ALTER SEQUENCE ${this.escapePath(T)} RENAME TO "${m}"`;a.push(new x(S)),c.push(new x(P))}r.findColumnUniques(h).forEach(p=>{const m=this.connection.namingStrategy.uniqueConstraintName(r,p.columnNames);if(p.name!==m)return;p.columnNames.splice(p.columnNames.indexOf(h.name),1),p.columnNames.push(n.name);const T=this.connection.namingStrategy.uniqueConstraintName(r,p.columnNames);a.push(new x(`ALTER TABLE ${this.escapePath(i)} RENAME CONSTRAINT "${p.name}" TO "${T}"`)),c.push(new x(`ALTER TABLE ${this.escapePath(i)} RENAME CONSTRAINT "${T}" TO "${p.name}"`)),p.name=T}),r.findColumnIndices(h).forEach(p=>{const m=this.connection.namingStrategy.indexName(r,p.columnNames,p.where);if(p.name!==m)return;p.columnNames.splice(p.columnNames.indexOf(h.name),1),p.columnNames.push(n.name);const{schema:T}=this.driver.parseTableName(i),A=this.connection.namingStrategy.indexName(r,p.columnNames,p.where),S=T?`ALTER INDEX "${T}"."${p.name}" RENAME TO "${A}"`:`ALTER INDEX "${p.name}" RENAME TO "${A}"`,P=T?`ALTER INDEX "${T}"."${A}" RENAME TO "${p.name}"`:`ALTER INDEX "${A}" RENAME TO "${p.name}"`;a.push(new x(S)),c.push(new x(P)),p.name=A}),r.findColumnForeignKeys(h).forEach(p=>{const m=this.connection.namingStrategy.foreignKeyName(r,p.columnNames,this.getTablePath(p),p.referencedColumnNames);if(p.name!==m)return;p.columnNames.splice(p.columnNames.indexOf(h.name),1),p.columnNames.push(n.name);const T=this.connection.namingStrategy.foreignKeyName(r,p.columnNames,this.getTablePath(p),p.referencedColumnNames);a.push(new x(`ALTER TABLE ${this.escapePath(i)} RENAME CONSTRAINT "${p.name}" TO "${T}"`)),c.push(new x(`ALTER TABLE ${this.escapePath(i)} RENAME CONSTRAINT "${T}" TO "${p.name}"`)),p.name=T});const f=r.columns.find(p=>p.name===h.name);r.columns[r.columns.indexOf(f)].name=n.name,h.name=n.name}if((n.precision!==h.precision||n.scale!==h.scale)&&(a.push(new x(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" TYPE ${this.driver.createFullType(n)}`)),c.push(new x(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" TYPE ${this.driver.createFullType(h)}`))),(n.type==="enum"||n.type==="simple-enum")&&(h.type==="enum"||h.type==="simple-enum")&&(!ee.isArraysEqual(n.enum,h.enum)||n.enumName!==h.enumName)){const f=n.isArray?"[]":"",p=this.buildEnumName(i,n),m=this.buildEnumName(i,h),T=this.buildEnumName(i,h,!1),A=this.buildEnumName(i,h,!0,!1,!0),S=this.buildEnumName(i,h,!1,!1,!0);a.push(new x(`ALTER TYPE ${m} RENAME TO ${S}`)),c.push(new x(`ALTER TYPE ${A} RENAME TO ${T}`)),a.push(this.createEnumTypeSql(i,n,p)),c.push(this.dropEnumTypeSql(i,n,p)),h.default!==null&&h.default!==void 0&&(l=!0,a.push(new x(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${h.name}" DROP DEFAULT`)),c.push(new x(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${h.name}" SET DEFAULT ${h.default}`)));const P=`${p}${f} USING "${n.name}"::"text"::${p}${f}`,F=`${A}${f} USING "${n.name}"::"text"::${A}${f}`;a.push(new x(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" TYPE ${P}`)),c.push(new x(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" TYPE ${F}`)),n.default!==null&&n.default!==void 0&&(a.push(new x(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" SET DEFAULT ${n.default}`)),c.push(new x(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" DROP DEFAULT`))),a.push(this.dropEnumTypeSql(i,h,A)),c.push(this.createEnumTypeSql(i,h,A))}if(h.isNullable!==n.isNullable&&(n.isNullable?(a.push(new x(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${h.name}" DROP NOT NULL`)),c.push(new x(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${h.name}" SET NOT NULL`))):(a.push(new x(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${h.name}" SET NOT NULL`)),c.push(new x(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${h.name}" DROP NOT NULL`)))),h.comment!==n.comment&&(a.push(new x(`COMMENT ON COLUMN ${this.escapePath(i)}."${h.name}" IS ${this.escapeComment(n.comment)}`)),c.push(new x(`COMMENT ON COLUMN ${this.escapePath(i)}."${n.name}" IS ${this.escapeComment(h.comment)}`))),n.isPrimary!==h.isPrimary){const f=r.primaryColumns;if(f.length>0){const p=f[0].primaryKeyConstraintName?f[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(r,f.map(T=>T.name)),m=f.map(T=>`"${T.name}"`).join(", ");a.push(new x(`ALTER TABLE ${this.escapePath(i)} DROP CONSTRAINT "${p}"`)),c.push(new x(`ALTER TABLE ${this.escapePath(i)} ADD CONSTRAINT "${p}" PRIMARY KEY (${m})`))}if(n.isPrimary===!0){f.push(n);const p=r.columns.find(A=>A.name===n.name);p.isPrimary=!0;const m=f[0].primaryKeyConstraintName?f[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(r,f.map(A=>A.name)),T=f.map(A=>`"${A.name}"`).join(", ");a.push(new x(`ALTER TABLE ${this.escapePath(i)} ADD CONSTRAINT "${m}" PRIMARY KEY (${T})`)),c.push(new x(`ALTER TABLE ${this.escapePath(i)} DROP CONSTRAINT "${m}"`))}else{const p=f.find(T=>T.name===n.name);f.splice(f.indexOf(p),1);const m=r.columns.find(T=>T.name===n.name);if(m.isPrimary=!1,f.length>0){const T=f[0].primaryKeyConstraintName?f[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(r,f.map(S=>S.name)),A=f.map(S=>`"${S.name}"`).join(", ");a.push(new x(`ALTER TABLE ${this.escapePath(i)} ADD CONSTRAINT "${T}" PRIMARY KEY (${A})`)),c.push(new x(`ALTER TABLE ${this.escapePath(i)} DROP CONSTRAINT "${T}"`))}}}if(n.isUnique!==h.isUnique)if(n.isUnique===!0){const f=new jt({name:this.connection.namingStrategy.uniqueConstraintName(i,[n.name]),columnNames:[n.name]});r.uniques.push(f),a.push(new x(`ALTER TABLE ${this.escapePath(i)} ADD CONSTRAINT "${f.name}" UNIQUE ("${n.name}")`)),c.push(new x(`ALTER TABLE ${this.escapePath(i)} DROP CONSTRAINT "${f.name}"`))}else{const f=r.uniques.find(p=>p.columnNames.length===1&&!!p.columnNames.find(m=>m===n.name));r.uniques.splice(r.uniques.indexOf(f),1),a.push(new x(`ALTER TABLE ${this.escapePath(i)} DROP CONSTRAINT "${f.name}"`)),c.push(new x(`ALTER TABLE ${this.escapePath(i)} ADD CONSTRAINT "${f.name}" UNIQUE ("${n.name}")`))}if(h.isGenerated!==n.isGenerated&&(h.isGenerated&&(h.generationStrategy==="uuid"?(a.push(new x(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${h.name}" DROP DEFAULT`)),c.push(new x(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${h.name}" SET DEFAULT ${this.driver.uuidGenerator}`))):h.generationStrategy==="increment"&&(a.push(new x(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" DROP DEFAULT`)),c.push(new x(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" SET DEFAULT nextval('${this.escapePath(this.buildSequencePath(i,n))}')`)),a.push(new x(`DROP SEQUENCE ${this.escapePath(this.buildSequencePath(i,n))}`)),c.push(new x(`CREATE SEQUENCE IF NOT EXISTS ${this.escapePath(this.buildSequencePath(i,n))} OWNED BY ${this.escapePath(i)}."${n.name}"`)))),n.generationStrategy==="uuid"?n.isGenerated===!0?(a.push(new x(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" SET DEFAULT ${this.driver.uuidGenerator}`)),c.push(new x(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" DROP DEFAULT`))):(a.push(new x(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" DROP DEFAULT`)),c.push(new x(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" SET DEFAULT ${this.driver.uuidGenerator}`))):n.generationStrategy==="increment"&&(n.isGenerated===!0?(a.push(new x(`CREATE SEQUENCE IF NOT EXISTS ${this.escapePath(this.buildSequencePath(i,n))} OWNED BY ${this.escapePath(i)}."${n.name}"`)),c.push(new x(`DROP SEQUENCE ${this.escapePath(this.buildSequencePath(i,n))}`)),a.push(new x(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" SET DEFAULT nextval('${this.escapePath(this.buildSequencePath(i,n))}')`)),c.push(new x(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" DROP DEFAULT`))):(a.push(new x(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" DROP DEFAULT`)),c.push(new x(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" SET DEFAULT nextval('${this.escapePath(this.buildSequencePath(i,n))}')`)),a.push(new x(`DROP SEQUENCE ${this.escapePath(this.buildSequencePath(i,n))}`)),c.push(new x(`CREATE SEQUENCE IF NOT EXISTS ${this.escapePath(this.buildSequencePath(i,n))} OWNED BY ${this.escapePath(i)}."${n.name}"`))))),n.default!==h.default&&!l&&(n.default!==null&&n.default!==void 0?(a.push(new x(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" SET DEFAULT ${n.default}`)),h.default!==null&&h.default!==void 0?c.push(new x(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" SET DEFAULT ${h.default}`)):c.push(new x(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" DROP DEFAULT`))):h.default!==null&&h.default!==void 0&&(a.push(new x(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" DROP DEFAULT`)),c.push(new x(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" SET DEFAULT ${h.default}`)))),((n.spatialFeatureType||"").toLowerCase()!==(h.spatialFeatureType||"").toLowerCase()||n.srid!==h.srid)&&(a.push(new x(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" TYPE ${this.driver.createFullType(n)}`)),c.push(new x(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" TYPE ${this.driver.createFullType(h)}`))),n.collation!==h.collation){a.push(new x(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" TYPE ${n.type} COLLATE "${n.collation}"`));const f=h.collation?`"${h.collation}"`:'pg_catalog."default"';c.push(new x(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" TYPE ${n.type} COLLATE ${f}`))}if(n.generatedType!==h.generatedType&&(!n.generatedType||n.generatedType==="VIRTUAL")){const f=(await this.getTableNameWithSchema(i.name)).split("."),p=f[1],m=f[0];a.push(new x(`ALTER TABLE ${this.escapePath(i)} RENAME COLUMN "${h.name}" TO "TEMP_OLD_${h.name}"`)),a.push(new x(`ALTER TABLE ${this.escapePath(i)} ADD ${this.buildCreateColumnSql(i,n)}`)),a.push(new x(`UPDATE ${this.escapePath(i)} SET "${n.name}" = "TEMP_OLD_${h.name}"`)),a.push(new x(`ALTER TABLE ${this.escapePath(i)} DROP COLUMN "TEMP_OLD_${h.name}"`)),a.push(this.deleteTypeormMetadataSql({database:this.driver.database,schema:m,table:p,type:we.GENERATED_COLUMN,name:h.name})),c.push(this.insertTypeormMetadataSql({database:this.driver.database,schema:m,table:p,type:we.GENERATED_COLUMN,name:h.name,value:h.asExpression})),c.push(new x(`ALTER TABLE ${this.escapePath(i)} ADD ${this.buildCreateColumnSql(i,h)}`)),c.push(new x(`ALTER TABLE ${this.escapePath(i)} DROP COLUMN "${n.name}"`))}}await this.executeQueries(a,c),this.replaceCachedTable(i,r)}async changeColumns(e,t){for(const{oldColumn:n,newColumn:i}of t)await this.changeColumn(e,n,i)}async dropColumn(e,t){const n=$.isTable(e)?e:await this.getCachedTable(e),i=$.isTableColumn(t)?t:n.findColumnByName(t);if(!i)throw new _(`Column "${t}" was not found in table "${n.name}"`);const r=n.clone(),a=[],c=[];if(i.isPrimary){const p=i.primaryKeyConstraintName?i.primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(r,r.primaryColumns.map(A=>A.name)),m=r.primaryColumns.map(A=>`"${A.name}"`).join(", ");a.push(new x(`ALTER TABLE ${this.escapePath(r)} DROP CONSTRAINT "${p}"`)),c.push(new x(`ALTER TABLE ${this.escapePath(r)} ADD CONSTRAINT "${p}" PRIMARY KEY (${m})`));const T=r.findColumnByName(i.name);if(T.isPrimary=!1,r.primaryColumns.length>0){const A=r.primaryColumns[0].primaryKeyConstraintName?r.primaryColumns[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(r,r.primaryColumns.map(P=>P.name)),S=r.primaryColumns.map(P=>`"${P.name}"`).join(", ");a.push(new x(`ALTER TABLE ${this.escapePath(r)} ADD CONSTRAINT "${A}" PRIMARY KEY (${S})`)),c.push(new x(`ALTER TABLE ${this.escapePath(r)} DROP CONSTRAINT "${A}"`))}}const l=r.indices.find(p=>p.columnNames.length===1&&p.columnNames[0]===i.name);l&&(r.indices.splice(r.indices.indexOf(l),1),a.push(this.dropIndexSql(n,l)),c.push(this.createIndexSql(n,l)));const h=r.checks.find(p=>!!p.columnNames&&p.columnNames.length===1&&p.columnNames[0]===i.name);h&&(r.checks.splice(r.checks.indexOf(h),1),a.push(this.dropCheckConstraintSql(n,h)),c.push(this.createCheckConstraintSql(n,h)));const f=r.uniques.find(p=>p.columnNames.length===1&&p.columnNames[0]===i.name);if(f&&(r.uniques.splice(r.uniques.indexOf(f),1),a.push(this.dropUniqueConstraintSql(n,f)),c.push(this.createUniqueConstraintSql(n,f))),a.push(new x(`ALTER TABLE ${this.escapePath(n)} DROP COLUMN "${i.name}"`)),c.push(new x(`ALTER TABLE ${this.escapePath(n)} ADD ${this.buildCreateColumnSql(n,i)}`)),(i.type==="enum"||i.type==="simple-enum")&&await this.hasEnumType(n,i)){const m=await this.getUserDefinedTypeName(n,i),T=`"${m.schema}"."${m.name}"`;a.push(this.dropEnumTypeSql(n,i,T)),c.push(this.createEnumTypeSql(n,i,T))}if(i.generatedType==="STORED"){const p=(await this.getTableNameWithSchema(n.name)).split("."),m=p[1],T=p[0],A=this.deleteTypeormMetadataSql({database:this.driver.database,schema:T,table:m,type:we.GENERATED_COLUMN,name:i.name}),S=this.insertTypeormMetadataSql({database:this.driver.database,schema:T,table:m,type:we.GENERATED_COLUMN,name:i.name,value:i.asExpression});a.push(A),c.push(S)}await this.executeQueries(a,c),r.removeColumn(i),this.replaceCachedTable(n,r)}async dropColumns(e,t){for(const n of[...t])await this.dropColumn(e,n)}async createPrimaryKey(e,t,n){const i=$.isTable(e)?e:await this.getCachedTable(e),r=i.clone(),a=this.createPrimaryKeySql(i,t,n);r.columns.forEach(l=>{t.find(h=>h===l.name)&&(l.isPrimary=!0)});const c=this.dropPrimaryKeySql(r);await this.executeQueries(a,c),this.replaceCachedTable(i,r)}async updatePrimaryKeys(e,t){var p;const n=$.isTable(e)?e:await this.getCachedTable(e),i=n.clone(),r=t.map(m=>m.name),a=[],c=[],l=i.primaryColumns;if(l.length>0){const m=l[0].primaryKeyConstraintName?l[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(i,l.map(A=>A.name)),T=l.map(A=>`"${A.name}"`).join(", ");a.push(new x(`ALTER TABLE ${this.escapePath(n)} DROP CONSTRAINT "${m}"`)),c.push(new x(`ALTER TABLE ${this.escapePath(n)} ADD CONSTRAINT "${m}" PRIMARY KEY (${T})`))}i.columns.filter(m=>r.indexOf(m.name)!==-1).forEach(m=>m.isPrimary=!0);const h=(p=l[0])!=null&&p.primaryKeyConstraintName?l[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(i,r),f=r.map(m=>`"${m}"`).join(", ");a.push(new x(`ALTER TABLE ${this.escapePath(n)} ADD CONSTRAINT "${h}" PRIMARY KEY (${f})`)),c.push(new x(`ALTER TABLE ${this.escapePath(n)} DROP CONSTRAINT "${h}"`)),await this.executeQueries(a,c),this.replaceCachedTable(n,i)}async dropPrimaryKey(e,t){const n=$.isTable(e)?e:await this.getCachedTable(e),i=this.dropPrimaryKeySql(n),r=this.createPrimaryKeySql(n,n.primaryColumns.map(a=>a.name),t);await this.executeQueries(i,r),n.primaryColumns.forEach(a=>{a.isPrimary=!1})}async createUniqueConstraint(e,t){const n=$.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.connection.namingStrategy.uniqueConstraintName(n,t.columnNames));const i=this.createUniqueConstraintSql(n,t),r=this.dropUniqueConstraintSql(n,t);await this.executeQueries(i,r),n.addUniqueConstraint(t)}async createUniqueConstraints(e,t){for(const n of t)await this.createUniqueConstraint(e,n)}async dropUniqueConstraint(e,t){const n=$.isTable(e)?e:await this.getCachedTable(e),i=$.isTableUnique(t)?t:n.uniques.find(c=>c.name===t);if(!i)throw new _(`Supplied unique constraint was not found in table ${n.name}`);const r=this.dropUniqueConstraintSql(n,i),a=this.createUniqueConstraintSql(n,i);await this.executeQueries(r,a),n.removeUniqueConstraint(i)}async dropUniqueConstraints(e,t){for(const n of[...t])await this.dropUniqueConstraint(e,n)}async createCheckConstraint(e,t){const n=$.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.connection.namingStrategy.checkConstraintName(n,t.expression));const i=this.createCheckConstraintSql(n,t),r=this.dropCheckConstraintSql(n,t);await this.executeQueries(i,r),n.addCheckConstraint(t)}async createCheckConstraints(e,t){const n=t.map(i=>this.createCheckConstraint(e,i));await Promise.all(n)}async dropCheckConstraint(e,t){const n=$.isTable(e)?e:await this.getCachedTable(e),i=$.isTableCheck(t)?t:n.checks.find(c=>c.name===t);if(!i)throw new _(`Supplied check constraint was not found in table ${n.name}`);const r=this.dropCheckConstraintSql(n,i),a=this.createCheckConstraintSql(n,i);await this.executeQueries(r,a),n.removeCheckConstraint(i)}async dropCheckConstraints(e,t){const n=t.map(i=>this.dropCheckConstraint(e,i));await Promise.all(n)}async createExclusionConstraint(e,t){const n=$.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.connection.namingStrategy.exclusionConstraintName(n,t.expression));const i=this.createExclusionConstraintSql(n,t),r=this.dropExclusionConstraintSql(n,t);await this.executeQueries(i,r),n.addExclusionConstraint(t)}async createExclusionConstraints(e,t){const n=t.map(i=>this.createExclusionConstraint(e,i));await Promise.all(n)}async dropExclusionConstraint(e,t){const n=$.isTable(e)?e:await this.getCachedTable(e),i=$.isTableExclusion(t)?t:n.exclusions.find(c=>c.name===t);if(!i)throw new _(`Supplied exclusion constraint was not found in table ${n.name}`);const r=this.dropExclusionConstraintSql(n,i),a=this.createExclusionConstraintSql(n,i);await this.executeQueries(r,a),n.removeExclusionConstraint(i)}async dropExclusionConstraints(e,t){const n=t.map(i=>this.dropExclusionConstraint(e,i));await Promise.all(n)}async createForeignKey(e,t){const n=$.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.connection.namingStrategy.foreignKeyName(n,t.columnNames,this.getTablePath(t),t.referencedColumnNames));const i=this.createForeignKeySql(n,t),r=this.dropForeignKeySql(n,t);await this.executeQueries(i,r),n.addForeignKey(t)}async createForeignKeys(e,t){for(const n of t)await this.createForeignKey(e,n)}async dropForeignKey(e,t){const n=$.isTable(e)?e:await this.getCachedTable(e),i=$.isTableForeignKey(t)?t:n.foreignKeys.find(c=>c.name===t);if(!i)throw new _(`Supplied foreign key was not found in table ${n.name}`);i.name||(i.name=this.connection.namingStrategy.foreignKeyName(n,i.columnNames,this.getTablePath(i),i.referencedColumnNames));const r=this.dropForeignKeySql(n,i),a=this.createForeignKeySql(n,i);await this.executeQueries(r,a),n.removeForeignKey(i)}async dropForeignKeys(e,t){for(const n of[...t])await this.dropForeignKey(e,n)}async createIndex(e,t){const n=$.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.generateIndexName(n,t));const i=this.createIndexSql(n,t),r=this.dropIndexSql(n,t);await this.executeQueries(i,r),n.addIndex(t)}async createViewIndex(e,t){const n=$.isView(e)?e:await this.getCachedView(e);t.name||(t.name=this.generateIndexName(n,t));const i=this.createViewIndexSql(n,t),r=this.dropIndexSql(n,t);await this.executeQueries(i,r),n.addIndex(t)}async createIndices(e,t){for(const n of t)await this.createIndex(e,n)}async createViewIndices(e,t){for(const n of t)await this.createViewIndex(e,n)}async dropIndex(e,t){const n=$.isTable(e)?e:await this.getCachedTable(e),i=$.isTableIndex(t)?t:n.indices.find(c=>c.name===t);if(!i)throw new _(`Supplied index ${t} was not found in table ${n.name}`);i.name||(i.name=this.generateIndexName(n,i));const r=this.dropIndexSql(n,i),a=this.createIndexSql(n,i);await this.executeQueries(r,a),n.removeIndex(i)}async dropViewIndex(e,t){const n=$.isView(e)?e:await this.getCachedView(e),i=$.isTableIndex(t)?t:n.indices.find(c=>c.name===t);if(!i)throw new _(`Supplied index ${t} was not found in view ${n.name}`);i.name||(i.name=this.generateIndexName(n,i));const r=this.dropIndexSql(n,i),a=this.createViewIndexSql(n,i);await this.executeQueries(r,a),n.removeIndex(i)}async dropIndices(e,t){for(const n of[...t])await this.dropIndex(e,n)}async clearTable(e){await this.query(`TRUNCATE TABLE ${this.escapePath(e)}`)}async clearDatabase(){const e=[];this.connection.entityMetadatas.filter(i=>i.schema).forEach(i=>{!!e.find(a=>a===i.schema)||e.push(i.schema)}),e.push(this.driver.options.schema||"current_schema()");const t=e.map(i=>i==="current_schema()"?i:"'"+i+"'").join(", "),n=this.isTransactionActive;n||await this.startTransaction();try{const i=`SELECT 'DROP VIEW IF EXISTS "' || schemaname || '"."' || viewname || '" CASCADE;' as "query" FROM "pg_views" WHERE "schemaname" IN (${t}) AND "viewname" NOT IN ('geography_columns', 'geometry_columns', 'raster_columns', 'raster_overviews')`,r=await this.query(i);if(await Promise.all(r.map(l=>this.query(l.query))),te.isReleaseVersionOrGreater(this.driver,"9.3")){const l=`SELECT 'DROP MATERIALIZED VIEW IF EXISTS "' || schemaname || '"."' || matviewname || '" CASCADE;' as "query" FROM "pg_matviews" WHERE "schemaname" IN (${t})`,h=await this.query(l);await Promise.all(h.map(f=>this.query(f.query)))}const a=`SELECT 'DROP TABLE IF EXISTS "' || schemaname || '"."' || tablename || '" CASCADE;' as "query" FROM "pg_tables" WHERE "schemaname" IN (${t}) AND "tablename" NOT IN ('spatial_ref_sys')`,c=await this.query(a);await Promise.all(c.map(l=>this.query(l.query))),await this.dropEnumTypes(t),n||await this.commitTransaction()}catch(i){try{n||await this.rollbackTransaction()}catch{}throw i}}async loadViews(e){if(!await this.hasTable(this.getTypeormMetadataTableName()))return[];e||(e=[]);const n=await this.getCurrentDatabase(),i=await this.getCurrentSchema(),r=e.length===0?"1=1":e.map(p=>this.driver.parseTableName(p)).map(({schema:p,tableName:m})=>(p||(p=this.driver.options.schema||i),`("t"."schema" = '${p}' AND "t"."name" = '${m}')`)).join(" OR "),c=`SELECT "ns"."nspname" AS "table_schema", "t"."relname" AS "table_name", "i"."relname" AS "constraint_name", "a"."attname" AS "column_name", CASE "ix"."indisunique" WHEN 't' THEN 'TRUE' ELSE'FALSE' END AS "is_unique", pg_get_expr("ix"."indpred", "ix"."indrelid") AS "condition", "types"."typname" AS "type_name" FROM "pg_class" "t" INNER JOIN "pg_index" "ix" ON "ix"."indrelid" = "t"."oid" INNER JOIN "pg_attribute" "a" ON "a"."attrelid" = "t"."oid"  AND "a"."attnum" = ANY ("ix"."indkey") INNER JOIN "pg_namespace" "ns" ON "ns"."oid" = "t"."relnamespace" INNER JOIN "pg_class" "i" ON "i"."oid" = "ix"."indexrelid" INNER JOIN "pg_type" "types" ON "types"."oid" = "a"."atttypid" LEFT JOIN "pg_constraint" "cnst" ON "cnst"."conname" = "i"."relname" WHERE "t"."relkind" IN ('m') AND "cnst"."contype" IS NULL AND (${e.length===0?"1=1":e.map(p=>this.driver.parseTableName(p)).map(({schema:p,tableName:m})=>(p||(p=this.driver.options.schema||i),`("ns"."nspname" = '${p}' AND "t"."relname" = '${m}')`)).join(" OR ")})`,l=`SELECT "t".* FROM ${this.escapePath(this.getTypeormMetadataTableName())} "t" INNER JOIN "pg_catalog"."pg_class" "c" ON "c"."relname" = "t"."name" INNER JOIN "pg_namespace" "n" ON "n"."oid" = "c"."relnamespace" AND "n"."nspname" = "t"."schema" WHERE "t"."type" IN ('${we.VIEW}', '${we.MATERIALIZED_VIEW}') ${r?`AND (${r})`:""}`,h=await this.query(l),f=await this.query(c);return h.map(p=>{const m=ee.uniq(f.filter(S=>S.table_name===p.name&&S.table_schema===p.schema),S=>S.constraint_name),T=new Si,A=p.schema===i&&!this.driver.options.schema?void 0:p.schema;return T.database=n,T.schema=p.schema,T.name=this.driver.buildTableName(p.name,A),T.expression=p.value,T.materialized=p.type===we.MATERIALIZED_VIEW,T.indices=m.map(S=>{const P=f.filter(F=>F.table_schema===S.table_schema&&F.table_name===S.table_name&&F.constraint_name===S.constraint_name);return new Nt({view:T,name:S.constraint_name,columnNames:P.map(F=>F.column_name),isUnique:S.is_unique==="TRUE",where:S.condition,isFulltext:!1})}),T})}async loadTables(e){if(e&&e.length===0)return[];const t=await this.getCurrentSchema(),n=await this.getCurrentDatabase(),i=[];if(!e)i.push(...await this.query(`SELECT "table_schema", "table_name", obj_description(('"' || "table_schema" || '"."' || "table_name" || '"')::regclass, 'pg_class') AS table_comment FROM "information_schema"."tables"`));else{const q=`SELECT "table_schema", "table_name", obj_description(('"' || "table_schema" || '"."' || "table_name" || '"')::regclass, 'pg_class') AS table_comment FROM "information_schema"."tables" WHERE `+e.map(Z=>this.driver.parseTableName(Z)).map(({schema:Z,tableName:re})=>`("table_schema" = '${Z||t}' AND "table_name" = '${re}')`).join(" OR ");i.push(...await this.query(q))}if(i.length===0)return[];const a=`SELECT columns.*, pg_catalog.col_description(('"' || table_catalog || '"."' || table_schema || '"."' || table_name || '"')::regclass::oid, ordinal_position) AS description, ('"' || "udt_schema" || '"."' || "udt_name" || '"')::"regtype"::text AS "regtype", pg_catalog.format_type("col_attr"."atttypid", "col_attr"."atttypmod") AS "format_type" FROM "information_schema"."columns" LEFT JOIN "pg_catalog"."pg_attribute" AS "col_attr" ON "col_attr"."attname" = "columns"."column_name" AND "col_attr"."attrelid" = ( SELECT "cls"."oid" FROM "pg_catalog"."pg_class" AS "cls" LEFT JOIN "pg_catalog"."pg_namespace" AS "ns" ON "ns"."oid" = "cls"."relnamespace" WHERE "cls"."relname" = "columns"."table_name" AND "ns"."nspname" = "columns"."table_schema" ) WHERE `+i.map(({table_schema:B,table_name:q})=>`("table_schema" = '${B}' AND "table_name" = '${q}')`).join(" OR "),c=i.map(({table_schema:B,table_name:q})=>`("ns"."nspname" = '${B}' AND "t"."relname" = '${q}')`).join(" OR "),l=`SELECT "ns"."nspname" AS "table_schema", "t"."relname" AS "table_name", "cnst"."conname" AS "constraint_name", pg_get_constraintdef("cnst"."oid") AS "expression", CASE "cnst"."contype" WHEN 'p' THEN 'PRIMARY' WHEN 'u' THEN 'UNIQUE' WHEN 'c' THEN 'CHECK' WHEN 'x' THEN 'EXCLUDE' END AS "constraint_type", "a"."attname" AS "column_name" FROM "pg_constraint" "cnst" INNER JOIN "pg_class" "t" ON "t"."oid" = "cnst"."conrelid" INNER JOIN "pg_namespace" "ns" ON "ns"."oid" = "cnst"."connamespace" LEFT JOIN "pg_attribute" "a" ON "a"."attrelid" = "cnst"."conrelid" AND "a"."attnum" = ANY ("cnst"."conkey") WHERE "t"."relkind" IN ('r', 'p') AND (${c})`,h=`SELECT "ns"."nspname" AS "table_schema", "t"."relname" AS "table_name", "i"."relname" AS "constraint_name", "a"."attname" AS "column_name", CASE "ix"."indisunique" WHEN 't' THEN 'TRUE' ELSE'FALSE' END AS "is_unique", pg_get_expr("ix"."indpred", "ix"."indrelid") AS "condition", "types"."typname" AS "type_name", "am"."amname" AS "index_type" FROM "pg_class" "t" INNER JOIN "pg_index" "ix" ON "ix"."indrelid" = "t"."oid" INNER JOIN "pg_attribute" "a" ON "a"."attrelid" = "t"."oid"  AND "a"."attnum" = ANY ("ix"."indkey") INNER JOIN "pg_namespace" "ns" ON "ns"."oid" = "t"."relnamespace" INNER JOIN "pg_class" "i" ON "i"."oid" = "ix"."indexrelid" INNER JOIN "pg_type" "types" ON "types"."oid" = "a"."atttypid" INNER JOIN "pg_am" "am" ON "i"."relam" = "am"."oid" LEFT JOIN "pg_constraint" "cnst" ON "cnst"."conname" = "i"."relname" WHERE "t"."relkind" IN ('r', 'p') AND "cnst"."contype" IS NULL AND (${c})`,f=i.map(({table_schema:B,table_name:q})=>`("ns"."nspname" = '${B}' AND "cl"."relname" = '${q}')`).join(" OR "),m=await this.hasSupportForPartitionedTables()?` AND "cl"."relispartition" = 'f'`:"",T=`SELECT "con"."conname" AS "constraint_name", "con"."nspname" AS "table_schema", "con"."relname" AS "table_name", "att2"."attname" AS "column_name", "ns"."nspname" AS "referenced_table_schema", "cl"."relname" AS "referenced_table_name", "att"."attname" AS "referenced_column_name", "con"."confdeltype" AS "on_delete", "con"."confupdtype" AS "on_update", "con"."condeferrable" AS "deferrable", "con"."condeferred" AS "deferred" FROM ( SELECT UNNEST ("con1"."conkey") AS "parent", UNNEST ("con1"."confkey") AS "child", "con1"."confrelid", "con1"."conrelid", "con1"."conname", "con1"."contype", "ns"."nspname", "cl"."relname", "con1"."condeferrable", CASE WHEN "con1"."condeferred" THEN 'INITIALLY DEFERRED' ELSE 'INITIALLY IMMEDIATE' END as condeferred, CASE "con1"."confdeltype" WHEN 'a' THEN 'NO ACTION' WHEN 'r' THEN 'RESTRICT' WHEN 'c' THEN 'CASCADE' WHEN 'n' THEN 'SET NULL' WHEN 'd' THEN 'SET DEFAULT' END as "confdeltype", CASE "con1"."confupdtype" WHEN 'a' THEN 'NO ACTION' WHEN 'r' THEN 'RESTRICT' WHEN 'c' THEN 'CASCADE' WHEN 'n' THEN 'SET NULL' WHEN 'd' THEN 'SET DEFAULT' END as "confupdtype" FROM "pg_class" "cl" INNER JOIN "pg_namespace" "ns" ON "cl"."relnamespace" = "ns"."oid" INNER JOIN "pg_constraint" "con1" ON "con1"."conrelid" = "cl"."oid" WHERE "con1"."contype" = 'f' AND (${f}) ) "con" INNER JOIN "pg_attribute" "att" ON "att"."attrelid" = "con"."confrelid" AND "att"."attnum" = "con"."child" INNER JOIN "pg_class" "cl" ON "cl"."oid" = "con"."confrelid" ${m}INNER JOIN "pg_namespace" "ns" ON "cl"."relnamespace" = "ns"."oid" INNER JOIN "pg_attribute" "att2" ON "att2"."attrelid" = "con"."conrelid" AND "att2"."attnum" = "con"."parent"`,[A,S,P,F]=await Promise.all([this.query(a),this.query(l),this.query(h),this.query(T)]);return Promise.all(i.map(async B=>{const q=new pt,Z=(D,se)=>D[se]===t&&(!this.driver.options.schema||this.driver.options.schema===t)?void 0:D[se],re=Z(B,"table_schema");q.database=n,q.schema=B.table_schema,q.comment=B.table_comment,q.name=this.driver.buildTableName(B.table_name,re),q.columns=await Promise.all(A.filter(D=>D.table_name===B.table_name&&D.table_schema===B.table_schema).map(async D=>{const se=S.filter(oe=>oe.table_name===D.table_name&&oe.table_schema===D.table_schema&&oe.column_name===D.column_name),V=new nn;if(V.name=D.column_name,V.type=D.regtype.toLowerCase(),V.type==="vector"||V.type==="halfvec"){const oe=D.format_type.match(/^(?:vector|halfvec)\((\d+)\)$/);oe&&oe[1]&&(V.length=oe[1])}if(V.type==="numeric"||V.type==="numeric[]"||V.type==="decimal"||V.type==="float"){let oe=D.numeric_precision,Te=D.numeric_scale;if(D.data_type==="ARRAY"){const Xe=D.format_type.match(/^numeric\(([0-9]+),([0-9]+)\)\[\]$/);Xe&&(oe=+Xe[1],Te=+Xe[2])}oe!==null&&!this.isDefaultColumnPrecision(q,V,oe)?V.precision=oe:Te!==null&&!this.isDefaultColumnScale(q,V,Te)&&(V.precision=void 0),Te!==null&&!this.isDefaultColumnScale(q,V,Te)?V.scale=Te:oe!==null&&!this.isDefaultColumnPrecision(q,V,oe)&&(V.scale=void 0)}if((V.type==="interval"||V.type==="time without time zone"||V.type==="time with time zone"||V.type==="timestamp without time zone"||V.type==="timestamp with time zone")&&(V.precision=this.isDefaultColumnPrecision(q,V,D.datetime_precision)?void 0:D.datetime_precision),D.data_type==="USER-DEFINED"||D.data_type==="ARRAY"){const{name:oe}=await this.getUserDefinedTypeName(q,V),Xe=this.buildEnumName(q,V,!1,!0)!==oe?oe:void 0,Ge=`SELECT "e"."enumlabel" AS "value" FROM "pg_enum" "e" INNER JOIN "pg_type" "t" ON "t"."oid" = "e"."enumtypid" INNER JOIN "pg_namespace" "n" ON "n"."oid" = "t"."typnamespace" WHERE "n"."nspname" = '${B.table_schema}' AND "t"."typname" = '${Xe||oe}'`,qe=await this.query(Ge);if(qe.length&&(V.type="enum",V.enum=qe.map(tt=>tt.value),V.enumName=Xe),D.data_type==="ARRAY"){V.isArray=!0;const tt=V.type.replace("[]","");V.type=this.connection.driver.normalizeType({type:tt})}}if(V.type==="geometry"||V.type==="geography"){const oe=`SELECT * FROM (SELECT "f_table_schema" "table_schema", "f_table_name" "table_name", "f_${V.type}_column" "column_name", "srid", "type" FROM "${V.type}_columns") AS _ WHERE "column_name" = '${D.column_name}' AND "table_schema" = '${D.table_schema}' AND "table_name" = '${D.table_name}'`,Te=await this.query(oe);Te.length>0&&(V.spatialFeatureType=Te[0].type,V.srid=Te[0].srid)}if(this.driver.withLengthColumnTypes.indexOf(V.type)!==-1){let oe;if(V.isArray){const Te=/\((\d+)\)/.exec(D.format_type);oe=Te?Te[1]:void 0}else D.character_maximum_length&&(oe=D.character_maximum_length.toString());oe&&(V.length=this.isDefaultColumnLength(q,V,oe)?"":oe)}V.isNullable=D.is_nullable==="YES";const ne=se.find(oe=>oe.constraint_type==="PRIMARY");if(ne){V.isPrimary=!0;const Te=S.filter(Ge=>Ge.table_name===D.table_name&&Ge.table_schema===D.table_schema&&Ge.column_name!==D.column_name&&Ge.constraint_type==="PRIMARY").map(Ge=>Ge.column_name);Te.push(D.column_name);const Xe=this.connection.namingStrategy.primaryKeyName(q,Te);ne.constraint_name!==Xe&&(V.primaryKeyConstraintName=ne.constraint_name)}const ce=se.filter(oe=>oe.constraint_type==="UNIQUE"),ye=ce.every(oe=>S.some(Te=>Te.constraint_type==="UNIQUE"&&Te.constraint_name===oe.constraint_name&&Te.column_name!==D.column_name));if(V.isUnique=ce.length>0&&!ye,D.is_identity==="YES")V.isGenerated=!0,V.generationStrategy="identity",V.generatedIdentity=D.identity_generation;else if(D.column_default!==null&&D.column_default!==void 0){const oe=`nextval('${this.buildSequenceName(q,D.column_name)}'::regclass)`,Te=`nextval('${this.buildSequencePath(q,D.column_name)}'::regclass)`,Xe=D.column_default.replace(/"/g,"");Xe===oe||Xe===Te?(V.isGenerated=!0,V.generationStrategy="increment"):D.column_default==="gen_random_uuid()"||/^uuid_generate_v\d\(\)/.test(D.column_default)?V.type==="uuid"?(V.isGenerated=!0,V.generationStrategy="uuid"):V.default=D.column_default:D.column_default==="now()"||D.column_default.indexOf("'now'::text")!==-1?V.default=D.column_default:(V.default=D.column_default.replace(/::[\w\s.[\]\-"]+/g,""),V.default=V.default.replace(/^(-?\d+)$/,"'$1'"))}if(D.is_generated==="ALWAYS"&&D.generation_expression){V.generatedType="STORED";const oe=this.selectTypeormMetadataSql({database:n,schema:B.table_schema,table:B.table_name,type:we.GENERATED_COLUMN,name:V.name}),Te=await this.query(oe.query,oe.parameters);Te[0]&&Te[0].value?V.asExpression=Te[0].value:V.asExpression=""}return V.comment=D.description?D.description:void 0,D.character_set_name&&(V.charset=D.character_set_name),D.collation_name&&(V.collation=D.collation_name),V}));const Ee=ee.uniq(S.filter(D=>D.table_name===B.table_name&&D.table_schema===B.table_schema&&D.constraint_type==="UNIQUE"),D=>D.constraint_name);q.uniques=Ee.map(D=>{const se=S.filter(V=>V.constraint_name===D.constraint_name);return new jt({name:D.constraint_name,columnNames:se.map(V=>V.column_name),deferrable:D.deferrable?D.deferred:void 0})});const Se=ee.uniq(S.filter(D=>D.table_name===B.table_name&&D.table_schema===B.table_schema&&D.constraint_type==="CHECK"),D=>D.constraint_name);q.checks=Se.map(D=>{const se=S.filter(V=>V.constraint_name===D.constraint_name);return new kn({name:D.constraint_name,columnNames:se.map(V=>V.column_name),expression:D.expression.replace(/^\s*CHECK\s*\((.*)\)\s*$/i,"$1")})});const me=ee.uniq(S.filter(D=>D.table_name===B.table_name&&D.table_schema===B.table_schema&&D.constraint_type==="EXCLUDE"),D=>D.constraint_name);q.exclusions=me.map(D=>new or({name:D.constraint_name,expression:D.expression.substring(8)}));const W=ee.uniq(F.filter(D=>D.table_name===B.table_name&&D.table_schema===B.table_schema),D=>D.constraint_name);q.foreignKeys=W.map(D=>{const se=F.filter(ce=>ce.constraint_name===D.constraint_name),V=Z(D,"referenced_table_schema"),ne=this.driver.buildTableName(D.referenced_table_name,V);return new Cn({name:D.constraint_name,columnNames:se.map(ce=>ce.column_name),referencedSchema:D.referenced_table_schema,referencedTableName:ne,referencedColumnNames:se.map(ce=>ce.referenced_column_name),onDelete:D.on_delete,onUpdate:D.on_update,deferrable:D.deferrable?D.deferred:void 0})});const Re=ee.uniq(P.filter(D=>D.table_name===B.table_name&&D.table_schema===B.table_schema),D=>D.constraint_name);return q.indices=Re.map(D=>{const se=P.filter(V=>V.table_schema===D.table_schema&&V.table_name===D.table_name&&V.constraint_name===D.constraint_name);return new Nt({table:q,name:D.constraint_name,columnNames:se.map(V=>V.column_name),isUnique:D.is_unique==="TRUE",where:D.condition,isSpatial:D.index_type==="gist",isFulltext:!1})}),q}))}createTableSql(e,t){const n=e.columns.map(a=>this.buildCreateColumnSql(e,a)).join(", ");let i=`CREATE TABLE ${this.escapePath(e)} (${n}`;if(e.columns.filter(a=>a.isUnique).forEach(a=>{e.uniques.some(l=>l.columnNames.length===1&&l.columnNames[0]===a.name)||e.uniques.push(new jt({name:this.connection.namingStrategy.uniqueConstraintName(e,[a.name]),columnNames:[a.name]}))}),e.uniques.length>0){const a=e.uniques.map(c=>{const l=c.name?c.name:this.connection.namingStrategy.uniqueConstraintName(e,c.columnNames),h=c.columnNames.map(p=>`"${p}"`).join(", ");let f=`CONSTRAINT "${l}" UNIQUE (${h})`;return c.deferrable&&(f+=` DEFERRABLE ${c.deferrable}`),f}).join(", ");i+=`, ${a}`}if(e.checks.length>0){const a=e.checks.map(c=>`CONSTRAINT "${c.name?c.name:this.connection.namingStrategy.checkConstraintName(e,c.expression)}" CHECK (${c.expression})`).join(", ");i+=`, ${a}`}if(e.exclusions.length>0){const a=e.exclusions.map(c=>`CONSTRAINT "${c.name?c.name:this.connection.namingStrategy.exclusionConstraintName(e,c.expression)}" EXCLUDE ${c.expression}`).join(", ");i+=`, ${a}`}if(e.foreignKeys.length>0&&t){const a=e.foreignKeys.map(c=>{const l=c.columnNames.map(p=>`"${p}"`).join(", ");c.name||(c.name=this.connection.namingStrategy.foreignKeyName(e,c.columnNames,this.getTablePath(c),c.referencedColumnNames));const h=c.referencedColumnNames.map(p=>`"${p}"`).join(", ");let f=`CONSTRAINT "${c.name}" FOREIGN KEY (${l}) REFERENCES ${this.escapePath(this.getTablePath(c))} (${h})`;return c.onDelete&&(f+=` ON DELETE ${c.onDelete}`),c.onUpdate&&(f+=` ON UPDATE ${c.onUpdate}`),c.deferrable&&(f+=` DEFERRABLE ${c.deferrable}`),f}).join(", ");i+=`, ${a}`}const r=e.columns.filter(a=>a.isPrimary);if(r.length>0){const a=r[0].primaryKeyConstraintName?r[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(e,r.map(l=>l.name)),c=r.map(l=>`"${l.name}"`).join(", ");i+=`, CONSTRAINT "${a}" PRIMARY KEY (${c})`}return i+=")",e.columns.filter(a=>a.comment).forEach(a=>i+=`; COMMENT ON COLUMN ${this.escapePath(e)}."${a.name}" IS ${this.escapeComment(a.comment)}`),new x(i)}async getVersion(){return(await this.query("SELECT version()"))[0].version.replace(/^PostgreSQL ([\d.]+).*$/,"$1")}dropTableSql(e){return new x(`DROP TABLE ${this.escapePath(e)}`)}createViewSql(e){const t=e.materialized?"MATERIALIZED ":"",n=this.escapePath(e);return typeof e.expression=="string"?new x(`CREATE ${t}VIEW ${n} AS ${e.expression}`):new x(`CREATE ${t}VIEW ${n} AS ${e.expression(this.connection).getQuery()}`)}async insertViewDefinitionSql(e){const t=await this.getCurrentSchema();let{schema:n,tableName:i}=this.driver.parseTableName(e);n||(n=t);const r=e.materialized?we.MATERIALIZED_VIEW:we.VIEW,a=typeof e.expression=="string"?e.expression.trim():e.expression(this.connection).getQuery();return this.insertTypeormMetadataSql({type:r,schema:n,name:i,value:a})}dropViewSql(e){const t=e.materialized?"MATERIALIZED ":"";return new x(`DROP ${t}VIEW ${this.escapePath(e)}`)}async deleteViewDefinitionSql(e){const t=await this.getCurrentSchema();let{schema:n,tableName:i}=this.driver.parseTableName(e);n||(n=t);const r=e.materialized?we.MATERIALIZED_VIEW:we.VIEW;return this.deleteTypeormMetadataSql({type:r,schema:n,name:i})}async dropEnumTypes(e){const t=`SELECT 'DROP TYPE IF EXISTS "' || n.nspname || '"."' || t.typname || '" CASCADE;' as "query" FROM "pg_type" "t" INNER JOIN "pg_enum" "e" ON "e"."enumtypid" = "t"."oid" INNER JOIN "pg_namespace" "n" ON "n"."oid" = "t"."typnamespace" WHERE "n"."nspname" IN (${e}) GROUP BY "n"."nspname", "t"."typname"`,n=await this.query(t);await Promise.all(n.map(i=>this.query(i.query)))}async hasEnumType(e,t){let{schema:n}=this.driver.parseTableName(e);n||(n=await this.getCurrentSchema());const i=this.buildEnumName(e,t,!1,!0),r=`SELECT "n"."nspname", "t"."typname" FROM "pg_type" "t" INNER JOIN "pg_namespace" "n" ON "n"."oid" = "t"."typnamespace" WHERE "n"."nspname" = '${n}' AND "t"."typname" = '${i}'`;return!!(await this.query(r)).length}createEnumTypeSql(e,t,n){n||(n=this.buildEnumName(e,t));const i=t.enum.map(r=>`'${r.replaceAll("'","''")}'`).join(", ");return new x(`CREATE TYPE ${n} AS ENUM(${i})`)}dropEnumTypeSql(e,t,n){return n||(n=this.buildEnumName(e,t)),new x(`DROP TYPE ${n}`)}createIndexSql(e,t){const n=t.columnNames.map(i=>`"${i}"`).join(", ");return new x(`CREATE ${t.isUnique?"UNIQUE ":""}INDEX${t.isConcurrent?" CONCURRENTLY":""} "${t.name}" ON ${this.escapePath(e)} ${t.isSpatial?"USING GiST ":""}(${n}) ${t.where?"WHERE "+t.where:""}`)}createViewIndexSql(e,t){const n=t.columnNames.map(i=>`"${i}"`).join(", ");return new x(`CREATE ${t.isUnique?"UNIQUE ":""}INDEX "${t.name}" ON ${this.escapePath(e)} (${n}) ${t.where?"WHERE "+t.where:""}`)}dropIndexSql(e,t){const n=$.isTableIndex(t)?t.name:t,i=$.isTableIndex(t)?t.isConcurrent:!1,{schema:r}=this.driver.parseTableName(e);return r?new x(`DROP INDEX ${i?"CONCURRENTLY ":""}"${r}"."${n}"`):new x(`DROP INDEX ${i?"CONCURRENTLY ":""}"${n}"`)}createPrimaryKeySql(e,t,n){const i=n||this.connection.namingStrategy.primaryKeyName(e,t),r=t.map(a=>`"${a}"`).join(", ");return new x(`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT "${i}" PRIMARY KEY (${r})`)}dropPrimaryKeySql(e){if(!e.primaryColumns.length)throw new _(`Table ${e} has no primary keys.`);const t=e.primaryColumns.map(r=>r.name),n=e.primaryColumns[0].primaryKeyConstraintName,i=n||this.connection.namingStrategy.primaryKeyName(e,t);return new x(`ALTER TABLE ${this.escapePath(e)} DROP CONSTRAINT "${i}"`)}createUniqueConstraintSql(e,t){const n=t.columnNames.map(r=>'"'+r+'"').join(", ");let i=`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT "${t.name}" UNIQUE (${n})`;return t.deferrable&&(i+=` DEFERRABLE ${t.deferrable}`),new x(i)}dropUniqueConstraintSql(e,t){const n=$.isTableUnique(t)?t.name:t;return new x(`ALTER TABLE ${this.escapePath(e)} DROP CONSTRAINT "${n}"`)}createCheckConstraintSql(e,t){return new x(`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT "${t.name}" CHECK (${t.expression})`)}dropCheckConstraintSql(e,t){const n=$.isTableCheck(t)?t.name:t;return new x(`ALTER TABLE ${this.escapePath(e)} DROP CONSTRAINT "${n}"`)}createExclusionConstraintSql(e,t){return new x(`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT "${t.name}" EXCLUDE ${t.expression}`)}dropExclusionConstraintSql(e,t){const n=$.isTableExclusion(t)?t.name:t;return new x(`ALTER TABLE ${this.escapePath(e)} DROP CONSTRAINT "${n}"`)}createForeignKeySql(e,t){const n=t.columnNames.map(a=>'"'+a+'"').join(", "),i=t.referencedColumnNames.map(a=>'"'+a+'"').join(",");let r=`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT "${t.name}" FOREIGN KEY (${n}) REFERENCES ${this.escapePath(this.getTablePath(t))}(${i})`;return t.onDelete&&(r+=` ON DELETE ${t.onDelete}`),t.onUpdate&&(r+=` ON UPDATE ${t.onUpdate}`),t.deferrable&&(r+=` DEFERRABLE ${t.deferrable}`),new x(r)}dropForeignKeySql(e,t){const n=$.isTableForeignKey(t)?t.name:t;return new x(`ALTER TABLE ${this.escapePath(e)} DROP CONSTRAINT "${n}"`)}buildSequenceName(e,t){const{tableName:n}=this.driver.parseTableName(e),i=$.isTableColumn(t)?t.name:t;let r=`${n}_${i}_seq`;return r.length>this.connection.driver.maxAliasLength&&(r=`${n.substring(0,29)}_${i.substring(0,Math.max(29,63-e.name.length-5))}_seq`),r}buildSequencePath(e,t){const{schema:n}=this.driver.parseTableName(e);return n?`${n}.${this.buildSequenceName(e,t)}`:this.buildSequenceName(e,t)}buildEnumName(e,t,n=!0,i,r){const{schema:a,tableName:c}=this.driver.parseTableName(e);let l=t.enumName?t.enumName:`${c}_${t.name.toLowerCase()}_enum`;return a&&n&&(l=`${a}.${l}`),r&&(l=l+"_old"),l.split(".").map(h=>i?h:`"${h}"`).join(".")}async getUserDefinedTypeName(e,t){let{schema:n,tableName:i}=this.driver.parseTableName(e);n||(n=await this.getCurrentSchema());const r=await this.query(`SELECT "udt_schema", "udt_name" FROM "information_schema"."columns" WHERE "table_schema" = '${n}' AND "table_name" = '${i}' AND "column_name"='${t.name}'`);let a=r[0].udt_name;return a.indexOf("_")===0&&(a=a.substr(1,a.length)),{schema:r[0].udt_schema,name:a}}escapeComment(e){return!e||e.length===0?"NULL":(e=e.replace(/'/g,"''").replace(/\u0000/g,""),`'${e}'`)}escapePath(e){const{schema:t,tableName:n}=this.driver.parseTableName(e);return t&&t!==this.driver.searchSchema?`"${t}"."${n}"`:`"${n}"`}async getTableNameWithSchema(e){const t=$.isTable(e)?e.name:e;return t.indexOf(".")===-1?`${(await this.query("SELECT current_schema()"))[0].current_schema}.${t}`:`${t.split(".")[0]}.${t.split(".")[1]}`}buildCreateColumnSql(e,t){let n='"'+t.name+'"';if(t.isGenerated===!0&&t.generationStrategy!=="uuid")if(t.generationStrategy==="identity"){const i=t.generatedIdentity||"BY DEFAULT";n+=` ${t.type} GENERATED ${i} AS IDENTITY`}else(t.type==="integer"||t.type==="int"||t.type==="int4")&&(n+=" SERIAL"),(t.type==="smallint"||t.type==="int2")&&(n+=" SMALLSERIAL"),(t.type==="bigint"||t.type==="int8")&&(n+=" BIGSERIAL");return t.type==="enum"||t.type==="simple-enum"?(n+=" "+this.buildEnumName(e,t),t.isArray&&(n+=" array")):(!t.isGenerated||t.type==="uuid")&&(n+=" "+this.connection.driver.createFullType(t)),t.generatedType==="STORED"&&t.asExpression&&(n+=` GENERATED ALWAYS AS (${t.asExpression}) STORED`),t.charset&&(n+=' CHARACTER SET "'+t.charset+'"'),t.collation&&(n+=' COLLATE "'+t.collation+'"'),t.isNullable!==!0&&(n+=" NOT NULL"),t.default!==void 0&&t.default!==null&&(n+=" DEFAULT "+t.default),t.isGenerated&&t.generationStrategy==="uuid"&&!t.default&&(n+=` DEFAULT ${this.driver.uuidGenerator}`),n}async hasSupportForPartitionedTables(){return!!(await this.query("SELECT TRUE FROM information_schema.columns WHERE table_name = 'pg_class' and column_name = 'relispartition'")).length}async changeTableComment(e,t){const n=[],i=[],r=$.isTable(e)?e:await this.getCachedTable(e);t=this.escapeComment(t);const a=this.escapeComment(r.comment);if(t===a)return;const c=r.clone();n.push(new x(`COMMENT ON TABLE ${this.escapePath(c)} IS ${t}`)),i.push(new x(`COMMENT ON TABLE ${this.escapePath(r)} IS ${a}`)),await this.executeQueries(n,i),r.comment=c.comment,this.replaceCachedTable(r,c)}}class ux extends cx{constructor(e,t){super(e,t)}}class lx extends ux{constructor(e,t,n){super(e,n),this.client=t}connect(){return this.databaseConnection?Promise.resolve(this.databaseConnection):this.databaseConnectionPromise?this.databaseConnectionPromise:(this.mode==="slave"&&this.driver.isReplicated?this.databaseConnectionPromise=this.driver.obtainSlaveConnection().then(([e,t])=>(this.driver.connectedQueryRunners.push(this),this.databaseConnection=e,this.releaseCallback=t,this.databaseConnection)):this.databaseConnectionPromise=this.driver.obtainMasterConnection().then(([e,t])=>(this.driver.connectedQueryRunners.push(this),this.databaseConnection=e,this.releaseCallback=t,this.databaseConnection)),this.databaseConnectionPromise)}async startTransaction(e){this.isTransactionActive=!0;try{await this.broadcaster.broadcast("BeforeTransactionStart")}catch(t){throw this.isTransactionActive=!1,t}this.transactionDepth===0?await this.client.startTransaction():await this.query(`SAVEPOINT typeorm_${this.transactionDepth}`),this.transactionDepth+=1,await this.broadcaster.broadcast("AfterTransactionStart")}async commitTransaction(){if(!this.isTransactionActive)throw new Sn;await this.broadcaster.broadcast("BeforeTransactionCommit"),this.transactionDepth>1?await this.query(`RELEASE SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.client.commitTransaction(),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionCommit")}async rollbackTransaction(){if(!this.isTransactionActive)throw new Sn;await this.broadcaster.broadcast("BeforeTransactionRollback"),this.transactionDepth>1?await this.query(`ROLLBACK TO SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.client.rollbackTransaction(),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionRollback")}async query(e,t,n=!1){if(this.isReleased)throw new Vt;const i=await this.client.query(e,t),r=new Wn;return r.raw=i,i!=null&&i.hasOwnProperty("records")&&Array.isArray(i.records)&&(r.records=i.records),i!=null&&i.hasOwnProperty("numberOfRecordsUpdated")&&(r.affected=i.numberOfRecordsUpdated),n?r:r.raw}changeTableComment(e,t){throw new _("aurora-postgres driver does not support change comment.")}}class hx extends Bp{}class dx extends hx{constructor(e){super(),this.transactionSupport="nested",this.connection=e,this.options=e.options,this.isReplicated=!1,this.loadDependencies(),this.client=new this.DataApiDriver(this.options.region,this.options.secretArn,this.options.resourceArn,this.options.database,(t,n)=>this.connection.logger.logQuery(t,n),this.options.serviceConfigOptions,this.options.formatOptions),this.database=te.buildDriverOptions(this.options).database}async connect(){}async disconnect(){}createQueryRunner(e){return new lx(this,new this.DataApiDriver(this.options.region,this.options.secretArn,this.options.resourceArn,this.options.database,(t,n)=>this.connection.logger.logQuery(t,n),this.options.serviceConfigOptions,this.options.formatOptions),e)}preparePersistentValue(e,t){return this.options.formatOptions&&this.options.formatOptions.castParameters===!1?super.preparePersistentValue(e,t):(t.transformer&&(e=Mt.transformTo(t.transformer,e)),this.client.preparePersistentValue(e,t))}prepareHydratedValue(e,t){return this.options.formatOptions&&this.options.formatOptions.castParameters===!1?super.prepareHydratedValue(e,t):(t.transformer&&(e=Mt.transformFrom(t.transformer,e)),this.client.prepareHydratedValue(e,t))}loadDependencies(){const e=this.options.driver||Ye.load("typeorm-aurora-data-api-driver"),{pg:t}=e;this.DataApiDriver=t}executeQuery(e,t){return this.connection.query(t)}async afterConnect(){const e=await this.checkMetadataForExtensions();return e.hasExtensions&&await this.enableExtensions(e,this.connection),Promise.resolve()}}class fx extends ur{constructor(e){super(),this.driver=e,this.connection=e.connection,this.broadcaster=new ii(this)}async beforeMigration(){await this.query("PRAGMA foreign_keys = OFF")}async afterMigration(){await this.query("PRAGMA foreign_keys = ON")}async executeSet(e){if(this.isReleased)throw new Vt;return(await this.connect()).executeSet(e,!1)}async query(e,t,n=!1){if(this.isReleased)throw new Vt;const i=await this.connect();this.driver.connection.logger.logQuery(e,t,this);const r=e.substring(0,e.indexOf(" ")!==-1?e.indexOf(" "):void 0);try{let a;["BEGIN","ROLLBACK","COMMIT","CREATE","ALTER","DROP"].indexOf(r)!==-1?a=await i.execute(e,!1):["INSERT","UPDATE","DELETE"].indexOf(r)!==-1?a=await i.run(e,t,!1):a=await i.query(e,t||[]);const c=new Wn;return a!=null&&a.hasOwnProperty("values")&&(c.raw=a.values,c.records=a.values),a!=null&&a.hasOwnProperty("changes")&&(c.affected=a.changes.changes,c.raw=a.changes.lastId||a.changes.changes),n?c:c.raw}catch(a){throw this.driver.connection.logger.logQueryError(a,e,t,this),new Un(e,t,a)}}parametrize(e){return Object.keys(e).map(t=>`"${t}"=?`)}}class px extends kr{constructor(e){super(e),this.database=this.options.database,this.driver=this.options.driver,this.sqlite=this.options.driver}async connect(){this.databaseConnection=this.createDatabaseConnection(),await this.databaseConnection}async disconnect(){return this.queryRunner=void 0,(await this.databaseConnection).close().then(()=>{this.databaseConnection=void 0})}createQueryRunner(e){return this.queryRunner||(this.queryRunner=new fx(this)),this.queryRunner}async createDatabaseConnection(){const e=this.options.mode||"no-encryption",t=e!=="no-encryption",n=typeof this.options.version>"u"?1:this.options.version,i=await this.sqlite.createConnection(this.options.database,t,e,n);return await i.open(),await i.execute("PRAGMA foreign_keys = ON"),this.options.journalMode&&["DELETE","TRUNCATE","PERSIST","MEMORY","WAL","OFF"].indexOf(this.options.journalMode)!==-1&&await i.execute(`PRAGMA journal_mode = ${this.options.journalMode}`),i}loadDependencies(){if(this.sqlite=this.driver,!this.driver)throw new Fr("Capacitor","@capacitor-community/sqlite")}}class mx extends uo{constructor(e,t){super(),this.driver=e,this.connection=e.connection,this.mode=t,this.broadcaster=new ii(this)}async connect(){if(this.session)return Promise.resolve(this.session);const[e]=await this.driver.instanceDatabase.createSession({});return this.session=e,this.sessionTransaction=await e.transaction(),this.session}async release(){return this.isReleased=!0,this.session&&await this.session.delete(),this.session=void 0,Promise.resolve()}async startTransaction(e){this.isTransactionActive=!0;try{await this.broadcaster.broadcast("BeforeTransactionStart")}catch(t){throw this.isTransactionActive=!1,t}await this.connect(),await this.sessionTransaction.begin(),this.connection.logger.logQuery("START TRANSACTION"),await this.broadcaster.broadcast("AfterTransactionStart")}async commitTransaction(){if(!this.isTransactionActive||!this.sessionTransaction)throw new Sn;await this.broadcaster.broadcast("BeforeTransactionCommit"),await this.sessionTransaction.commit(),this.connection.logger.logQuery("COMMIT"),this.isTransactionActive=!1,await this.broadcaster.broadcast("AfterTransactionCommit")}async rollbackTransaction(){if(!this.isTransactionActive||!this.sessionTransaction)throw new Sn;await this.broadcaster.broadcast("BeforeTransactionRollback"),await this.sessionTransaction.rollback(),this.connection.logger.logQuery("ROLLBACK"),this.isTransactionActive=!1,await this.broadcaster.broadcast("AfterTransactionRollback")}async query(e,t,n=!1){if(this.isReleased)throw new Vt;await this.connect(),this.driver.connection.logger.logQuery(e,t,this),await this.broadcaster.broadcast("BeforeQuery",e,t);const i=new Rn;try{const r=Date.now();let a;const c=e.startsWith("SELECT"),l=c&&!this.isTransactionActive?this.driver.instanceDatabase:this.sessionTransaction;!this.isTransactionActive&&!c&&await this.sessionTransaction.begin();try{a=await l.run({sql:e,params:t?t.reduce((T,A,S)=>(T["param"+S]=A,T),{}):void 0,json:!0}),!this.isTransactionActive&&!c&&await this.sessionTransaction.commit()}catch(T){try{!this.isTransactionActive&&!c&&await this.sessionTransaction.rollback()}catch{}throw T}const h=this.driver.options.maxQueryExecutionTime,p=Date.now()-r;this.broadcaster.broadcastAfterQueryEvent(i,e,t,!0,p,a,void 0),h&&p>h&&this.driver.connection.logger.logQuerySlow(p,e,t,this);const m=new Wn;return m.raw=a,m.records=a?a[0]:[],a&&a[1]&&a[1].rowCountExact&&(m.affected=parseInt(a[1].rowCountExact)),n?m:m.records}catch(r){throw this.driver.connection.logger.logQueryError(r,e,t,this),this.broadcaster.broadcastAfterQueryEvent(i,e,t,!1,void 0,void 0,r),new Un(e,t,r)}finally{await i.wait()}}async updateDDL(e,t){if(this.isReleased)throw new Vt;this.driver.connection.logger.logQuery(e,t,this);try{const n=Date.now(),[i]=await this.driver.instanceDatabase.updateSchema(e);await i.promise();const r=this.driver.options.maxQueryExecutionTime,c=Date.now()-n;r&&c>r&&this.driver.connection.logger.logQuerySlow(c,e,t,this)}catch(n){throw this.driver.connection.logger.logQueryError(n,e,t,this),new Un(e,t,n)}}async stream(e,t,n,i){if(this.isReleased)throw new Vt;try{this.driver.connection.logger.logQuery(e,t,this);const r={sql:e,params:t?t.reduce((c,l,h)=>(c["param"+h]=l,c),{}):void 0,json:!0},a=this.driver.instanceDatabase.runStream(r);return n&&a.on("end",n),i&&a.on("error",i),a}catch(r){throw this.driver.connection.logger.logQueryError(r,e,t,this),new Un(e,t,r)}}async getDatabases(){return Promise.resolve([])}async getSchemas(e){return Promise.resolve([])}async hasDatabase(e){throw new _("Check database queries are not supported by Spanner driver.")}async getCurrentDatabase(){throw new _("Check database queries are not supported by Spanner driver.")}async hasSchema(e){return!!(await this.query(`SELECT * FROM "information_schema"."schemata" WHERE "schema_name" = '${e}'`)).length}async getCurrentSchema(){throw new _("Check schema queries are not supported by Spanner driver.")}async hasTable(e){const n=`SELECT * FROM \`INFORMATION_SCHEMA\`.\`TABLES\` WHERE \`TABLE_CATALOG\` = '' AND \`TABLE_SCHEMA\` = '' AND \`TABLE_TYPE\` = 'BASE TABLE' AND \`TABLE_NAME\` = '${e instanceof pt?e.name:e}'`;return!!(await this.query(n)).length}async hasColumn(e,t){const i=`SELECT * FROM \`INFORMATION_SCHEMA\`.\`COLUMNS\` WHERE \`TABLE_CATALOG\` = '' AND \`TABLE_SCHEMA\` = '' AND \`TABLE_NAME\` = '${e instanceof pt?e.name:e}' AND \`COLUMN_NAME\` = '${t}'`;return!!(await this.query(i)).length}async createDatabase(e,t){if(t&&await this.hasDatabase(e))return Promise.resolve();const n=`CREATE DATABASE "${e}"`,i=`DROP DATABASE "${e}"`;await this.executeQueries(new x(n),new x(i))}async dropDatabase(e,t){const n=t?`DROP DATABASE IF EXISTS "${e}"`:`DROP DATABASE "${e}"`,i=`CREATE DATABASE "${e}"`;await this.executeQueries(new x(n),new x(i))}async createSchema(e,t){return Promise.resolve()}async dropSchema(e,t,n){return Promise.resolve()}async createTable(e,t=!1,n=!0,i=!0){if(t&&await this.hasTable(e))return Promise.resolve();const r=[],a=[];r.push(this.createTableSql(e,n)),a.push(this.dropTableSql(e)),n&&e.foreignKeys.forEach(l=>a.push(this.dropForeignKeySql(e,l))),i&&e.indices.forEach(l=>{l.name||(l.name=this.connection.namingStrategy.indexName(e,l.columnNames,l.where)),r.push(this.createIndexSql(e,l)),a.push(this.dropIndexSql(e,l))});const c=e.columns.filter(l=>l.generatedType&&l.asExpression);for(const l of c){const h=this.insertTypeormMetadataSql({table:e.name,type:we.GENERATED_COLUMN,name:l.name,value:l.asExpression}),f=this.deleteTypeormMetadataSql({table:e.name,type:we.GENERATED_COLUMN,name:l.name});r.push(h),a.push(f)}await this.executeQueries(r,a)}async dropTable(e,t,n=!0,i=!0){if(t&&!await this.hasTable(e))return Promise.resolve();const r=n,a=this.getTablePath(e),c=await this.getCachedTable(a),l=[],h=[];i&&c.indices.forEach(p=>{l.push(this.dropIndexSql(c,p)),h.push(this.createIndexSql(c,p))}),n&&c.foreignKeys.forEach(p=>l.push(this.dropForeignKeySql(c,p))),l.push(this.dropTableSql(c)),h.push(this.createTableSql(c,r));const f=c.columns.filter(p=>p.generatedType&&p.asExpression);for(const p of f){const m=this.deleteTypeormMetadataSql({table:c.name,type:we.GENERATED_COLUMN,name:p.name}),T=this.insertTypeormMetadataSql({table:c.name,type:we.GENERATED_COLUMN,name:p.name,value:p.asExpression});l.push(m),h.push(T)}await this.executeQueries(l,h)}async createView(e){const t=[],n=[];t.push(this.createViewSql(e)),t.push(await this.insertViewDefinitionSql(e)),n.push(this.dropViewSql(e)),n.push(await this.deleteViewDefinitionSql(e)),await this.executeQueries(t,n)}async dropView(e){const t=e instanceof Si?e.name:e,n=await this.getCachedView(t),i=[],r=[];i.push(await this.deleteViewDefinitionSql(n)),i.push(this.dropViewSql(n)),r.push(await this.insertViewDefinitionSql(n)),r.push(this.createViewSql(n)),await this.executeQueries(i,r)}async renameTable(e,t){throw new _("Rename table queries are not supported by Spanner driver.")}async addColumn(e,t){const n=e instanceof pt?e:await this.getCachedTable(e),i=n.clone(),r=[],a=[];r.push(new x(`ALTER TABLE ${this.escapePath(n)} ADD ${this.buildCreateColumnSql(t)}`)),a.push(new x(`ALTER TABLE ${this.escapePath(n)} DROP COLUMN ${this.driver.escape(t.name)}`));const c=i.indices.find(l=>l.columnNames.length===1&&l.columnNames[0]===t.name);if(c)r.push(this.createIndexSql(n,c)),a.push(this.dropIndexSql(n,c));else if(t.isUnique){const l=new Nt({name:this.connection.namingStrategy.indexName(n,[t.name]),columnNames:[t.name],isUnique:!0});i.indices.push(l),i.uniques.push(new jt({name:l.name,columnNames:l.columnNames})),r.push(this.createIndexSql(n,l)),a.push(this.dropIndexSql(n,l))}if(t.generatedType&&t.asExpression){const l=this.insertTypeormMetadataSql({table:n.name,type:we.GENERATED_COLUMN,name:t.name,value:t.asExpression}),h=this.deleteTypeormMetadataSql({table:n.name,type:we.GENERATED_COLUMN,name:t.name});r.push(l),a.push(h)}await this.executeQueries(r,a),i.addColumn(t),this.replaceCachedTable(n,i)}async addColumns(e,t){for(const n of t)await this.addColumn(e,n)}async renameColumn(e,t,n){const i=e instanceof pt?e:await this.getCachedTable(e),r=t instanceof nn?t:i.columns.find(c=>c.name===t);if(!r)throw new _(`Column "${t}" was not found in the "${i.name}" table.`);let a;return n instanceof nn?a=n:(a=r.clone(),a.name=n),this.changeColumn(i,r,a)}async changeColumn(e,t,n){const i=e instanceof pt?e:await this.getCachedTable(e);let r=i.clone();const a=[],c=[],l=t instanceof nn?t:i.columns.find(h=>h.name===t);if(!l)throw new _(`Column "${t}" was not found in the "${i.name}" table.`);if(l.name!==n.name||l.type!==n.type||l.length!==n.length||l.isArray!==n.isArray||l.generatedType!==n.generatedType||l.asExpression!==n.asExpression)await this.dropColumn(i,l),await this.addColumn(i,n),r=i.clone();else if((n.precision!==l.precision||n.scale!==l.scale)&&(a.push(new x(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" TYPE ${this.driver.createFullType(n)}`)),c.push(new x(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${n.name}" TYPE ${this.driver.createFullType(l)}`))),l.isNullable!==n.isNullable&&(n.isNullable?(a.push(new x(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${l.name}" DROP NOT NULL`)),c.push(new x(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${l.name}" SET NOT NULL`))):(a.push(new x(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${l.name}" SET NOT NULL`)),c.push(new x(`ALTER TABLE ${this.escapePath(i)} ALTER COLUMN "${l.name}" DROP NOT NULL`)))),n.isUnique!==l.isUnique)if(n.isUnique===!0){const h=new Nt({name:this.connection.namingStrategy.indexName(i,[n.name]),columnNames:[n.name],isUnique:!0});r.indices.push(h),r.uniques.push(new jt({name:h.name,columnNames:h.columnNames})),a.push(this.createIndexSql(i,h)),c.push(this.dropIndexSql(i,h))}else{const h=r.indices.find(p=>p.columnNames.length===1&&p.isUnique===!0&&!!p.columnNames.find(m=>m===n.name));r.indices.splice(r.indices.indexOf(h),1);const f=r.uniques.find(p=>p.name===h.name);r.uniques.splice(r.uniques.indexOf(f),1),a.push(this.dropIndexSql(i,h)),c.push(this.createIndexSql(i,h))}await this.executeQueries(a,c),this.replaceCachedTable(i,r)}async changeColumns(e,t){for(const{oldColumn:n,newColumn:i}of t)await this.changeColumn(e,n,i)}async dropColumn(e,t){const n=e instanceof pt?e:await this.getCachedTable(e),i=t instanceof nn?t:n.findColumnByName(t);if(!i)throw new _(`Column "${t}" was not found in table "${n.name}"`);const r=n.clone(),a=[],c=[],l=r.indices.find(f=>f.columnNames.length===1&&f.columnNames[0]===i.name);l&&(r.indices.splice(r.indices.indexOf(l),1),a.push(this.dropIndexSql(n,l)),c.push(this.createIndexSql(n,l)));const h=r.checks.find(f=>!!f.columnNames&&f.columnNames.length===1&&f.columnNames[0]===i.name);if(h&&(r.checks.splice(r.checks.indexOf(h),1),a.push(this.dropCheckConstraintSql(n,h)),c.push(this.createCheckConstraintSql(n,h))),a.push(new x(`ALTER TABLE ${this.escapePath(n)} DROP COLUMN ${this.driver.escape(i.name)}`)),c.push(new x(`ALTER TABLE ${this.escapePath(n)} ADD ${this.buildCreateColumnSql(i)}`)),i.generatedType&&i.asExpression){const f=this.deleteTypeormMetadataSql({table:n.name,type:we.GENERATED_COLUMN,name:i.name}),p=this.insertTypeormMetadataSql({table:n.name,type:we.GENERATED_COLUMN,name:i.name,value:i.asExpression});a.push(f),c.push(p)}await this.executeQueries(a,c),r.removeColumn(i),this.replaceCachedTable(n,r)}async dropColumns(e,t){for(const n of[...t])await this.dropColumn(e,n)}async createPrimaryKey(e,t){throw new Error("The keys of a table can't change; you can't add a key column to an existing table or remove a key column from an existing table.")}async updatePrimaryKeys(e,t){throw new Error("The keys of a table can't change; you can't add a key column to an existing table or remove a key column from an existing table.")}async dropPrimaryKey(e){throw new Error("The keys of a table can't change; you can't add a key column to an existing table or remove a key column from an existing table.")}async createUniqueConstraint(e,t){throw new _("Spanner does not support unique constraints. Use unique index instead.")}async createUniqueConstraints(e,t){throw new _("Spanner does not support unique constraints. Use unique index instead.")}async dropUniqueConstraint(e,t){throw new _("Spanner does not support unique constraints. Use unique index instead.")}async dropUniqueConstraints(e,t){throw new _("Spanner does not support unique constraints. Use unique index instead.")}async createCheckConstraint(e,t){const n=e instanceof pt?e:await this.getCachedTable(e);t.name||(t.name=this.connection.namingStrategy.checkConstraintName(n,t.expression));const i=this.createCheckConstraintSql(n,t),r=this.dropCheckConstraintSql(n,t);await this.executeQueries(i,r),n.addCheckConstraint(t)}async createCheckConstraints(e,t){const n=t.map(i=>this.createCheckConstraint(e,i));await Promise.all(n)}async dropCheckConstraint(e,t){const n=e instanceof pt?e:await this.getCachedTable(e),i=t instanceof kn?t:n.checks.find(c=>c.name===t);if(!i)throw new _(`Supplied check constraint was not found in table ${n.name}`);const r=this.dropCheckConstraintSql(n,i),a=this.createCheckConstraintSql(n,i);await this.executeQueries(r,a),n.removeCheckConstraint(i)}async dropCheckConstraints(e,t){const n=t.map(i=>this.dropCheckConstraint(e,i));await Promise.all(n)}async createExclusionConstraint(e,t){throw new _("Spanner does not support exclusion constraints.")}async createExclusionConstraints(e,t){throw new _("Spanner does not support exclusion constraints.")}async dropExclusionConstraint(e,t){throw new _("Spanner does not support exclusion constraints.")}async dropExclusionConstraints(e,t){throw new _("Spanner does not support exclusion constraints.")}async createForeignKey(e,t){const n=e instanceof pt?e:await this.getCachedTable(e);t.name||(t.name=this.connection.namingStrategy.foreignKeyName(n,t.columnNames,this.getTablePath(t),t.referencedColumnNames));const i=this.createForeignKeySql(n,t),r=this.dropForeignKeySql(n,t);await this.executeQueries(i,r),n.addForeignKey(t)}async createForeignKeys(e,t){for(const n of t)await this.createForeignKey(e,n)}async dropForeignKey(e,t){const n=e instanceof pt?e:await this.getCachedTable(e),i=t instanceof Cn?t:n.foreignKeys.find(c=>c.name===t);if(!i)throw new _(`Supplied foreign key was not found in table ${n.name}`);const r=this.dropForeignKeySql(n,i),a=this.createForeignKeySql(n,i);await this.executeQueries(r,a),n.removeForeignKey(i)}async dropForeignKeys(e,t){for(const n of[...t])await this.dropForeignKey(e,n)}async createIndex(e,t){const n=e instanceof pt?e:await this.getCachedTable(e);t.name||(t.name=this.generateIndexName(n,t));const i=this.createIndexSql(n,t),r=this.dropIndexSql(n,t);await this.executeQueries(i,r),n.addIndex(t)}async createIndices(e,t){for(const n of t)await this.createIndex(e,n)}async dropIndex(e,t){const n=e instanceof pt?e:await this.getCachedTable(e),i=t instanceof Nt?t:n.indices.find(c=>c.name===t);if(!i)throw new _(`Supplied index ${t} was not found in table ${n.name}`);i.name||(i.name=this.generateIndexName(n,i));const r=this.dropIndexSql(n,i),a=this.createIndexSql(n,i);await this.executeQueries(r,a),n.removeIndex(i)}async dropIndices(e,t){for(const n of[...t])await this.dropIndex(e,n)}async clearTable(e){await this.query(`DELETE FROM ${this.escapePath(e)} WHERE true`)}async clearDatabase(){const t=await this.query("SELECT concat('DROP INDEX `', INDEX_NAME, '`') AS `query` FROM `INFORMATION_SCHEMA`.`INDEXES` WHERE `TABLE_CATALOG` = '' AND `TABLE_SCHEMA` = '' AND `INDEX_TYPE` = 'INDEX' AND `SPANNER_IS_MANAGED` = false"),i=await this.query("SELECT concat('ALTER TABLE `', TABLE_NAME, '`', ' DROP CONSTRAINT `', CONSTRAINT_NAME, '`') AS `query` FROM `INFORMATION_SCHEMA`.`TABLE_CONSTRAINTS` WHERE `TABLE_CATALOG` = '' AND `TABLE_SCHEMA` = '' AND `CONSTRAINT_TYPE` = 'FOREIGN KEY'"),a=await this.query("SELECT concat('DROP TABLE `', TABLE_NAME, '`') AS `query` FROM `INFORMATION_SCHEMA`.`TABLES` WHERE `TABLE_CATALOG` = '' AND `TABLE_SCHEMA` = '' AND `TABLE_TYPE` = 'BASE TABLE'");if(!t.length&&!i.length&&!a.length)return;const c=this.isTransactionActive;c||await this.startTransaction();try{for(const l of t)await this.updateDDL(l.query);for(const l of i)await this.updateDDL(l.query);for(const l of a)await this.updateDDL(l.query);await this.commitTransaction()}catch(l){try{c||await this.rollbackTransaction()}catch{}throw l}}async executeMemoryUpSql(){for(const{query:e,parameters:t}of this.sqlInMemory.upQueries)this.isDMLQuery(e)?await this.query(e,t):await this.updateDDL(e,t)}async executeMemoryDownSql(){for(const{query:e,parameters:t}of this.sqlInMemory.downQueries.reverse())this.isDMLQuery(e)?await this.query(e,t):await this.updateDDL(e,t)}async loadViews(e){return Promise.resolve([])}async loadTables(e){if(e&&e.length===0)return[];const t=[];if(!e||!e.length)t.push(...await this.query("SELECT `TABLE_NAME` FROM `INFORMATION_SCHEMA`.`TABLES` WHERE `TABLE_CATALOG` = '' AND `TABLE_SCHEMA` = '' AND `TABLE_TYPE` = 'BASE TABLE'"));else{const A=`SELECT \`TABLE_NAME\` FROM \`INFORMATION_SCHEMA\`.\`TABLES\` WHERE \`TABLE_CATALOG\` = '' AND \`TABLE_SCHEMA\` = '' AND \`TABLE_TYPE\` = 'BASE TABLE' AND \`TABLE_NAME\` IN (${e.map(S=>`'${S}'`).join(", ")})`;t.push(...await this.query(A))}if(!t.length)return[];const n=t.map(A=>`'${A.TABLE_NAME}'`).join(", "),i=`SELECT * FROM \`INFORMATION_SCHEMA\`.\`COLUMNS\` WHERE \`TABLE_CATALOG\` = '' AND \`TABLE_SCHEMA\` = '' AND \`TABLE_NAME\` IN (${n})`,r=`SELECT \`KCU\`.\`TABLE_NAME\`, \`KCU\`.\`COLUMN_NAME\` FROM \`INFORMATION_SCHEMA\`.\`TABLE_CONSTRAINTS\` \`TC\` INNER JOIN \`INFORMATION_SCHEMA\`.\`KEY_COLUMN_USAGE\` \`KCU\` ON \`KCU\`.\`CONSTRAINT_NAME\` = \`TC\`.\`CONSTRAINT_NAME\` WHERE \`TC\`.\`TABLE_CATALOG\` = '' AND \`TC\`.\`TABLE_SCHEMA\` = '' AND \`TC\`.\`CONSTRAINT_TYPE\` = 'PRIMARY KEY' AND \`TC\`.\`TABLE_NAME\` IN (${n})`,a=`SELECT \`I\`.\`TABLE_NAME\`, \`I\`.\`INDEX_NAME\`, \`I\`.\`IS_UNIQUE\`, \`I\`.\`IS_NULL_FILTERED\`, \`IC\`.\`COLUMN_NAME\` FROM \`INFORMATION_SCHEMA\`.\`INDEXES\` \`I\` INNER JOIN \`INFORMATION_SCHEMA\`.\`INDEX_COLUMNS\` \`IC\` ON \`IC\`.\`INDEX_NAME\` = \`I\`.\`INDEX_NAME\` AND \`IC\`.\`TABLE_NAME\` = \`I\`.\`TABLE_NAME\` WHERE \`I\`.\`TABLE_CATALOG\` = '' AND \`I\`.\`TABLE_SCHEMA\` = '' AND \`I\`.\`TABLE_NAME\` IN (${n}) AND \`I\`.\`INDEX_TYPE\` = 'INDEX' AND \`I\`.\`SPANNER_IS_MANAGED\` = false`,c=`SELECT \`TC\`.\`TABLE_NAME\`, \`TC\`.\`CONSTRAINT_NAME\`, \`CC\`.\`CHECK_CLAUSE\`, \`CCU\`.\`COLUMN_NAME\`FROM \`INFORMATION_SCHEMA\`.\`TABLE_CONSTRAINTS\` \`TC\` INNER JOIN \`INFORMATION_SCHEMA\`.\`CONSTRAINT_COLUMN_USAGE\` \`CCU\` ON \`CCU\`.\`CONSTRAINT_NAME\` = \`TC\`.\`CONSTRAINT_NAME\` INNER JOIN \`INFORMATION_SCHEMA\`.\`CHECK_CONSTRAINTS\` \`CC\` ON \`CC\`.\`CONSTRAINT_NAME\` = \`TC\`.\`CONSTRAINT_NAME\` WHERE \`TC\`.\`TABLE_CATALOG\` = '' AND \`TC\`.\`TABLE_SCHEMA\` = '' AND \`TC\`.\`CONSTRAINT_TYPE\` = 'CHECK' AND \`TC\`.\`TABLE_NAME\` IN (${n}) AND \`TC\`.\`CONSTRAINT_NAME\` NOT LIKE 'CK_IS_NOT_NULL%'`,l=`SELECT \`TC\`.\`TABLE_NAME\`, \`TC\`.\`CONSTRAINT_NAME\`, \`KCU\`.\`COLUMN_NAME\`, \`CTU\`.\`TABLE_NAME\` AS \`REFERENCED_TABLE_NAME\`, \`CCU\`.\`COLUMN_NAME\` AS \`REFERENCED_COLUMN_NAME\`, \`RC\`.\`UPDATE_RULE\`, \`RC\`.\`DELETE_RULE\` FROM \`INFORMATION_SCHEMA\`.\`TABLE_CONSTRAINTS\` \`TC\` INNER JOIN \`INFORMATION_SCHEMA\`.\`KEY_COLUMN_USAGE\` \`KCU\` ON \`KCU\`.\`CONSTRAINT_NAME\` = \`TC\`.\`CONSTRAINT_NAME\` INNER JOIN \`INFORMATION_SCHEMA\`.\`CONSTRAINT_TABLE_USAGE\` \`CTU\` ON \`CTU\`.\`CONSTRAINT_NAME\` = \`TC\`.\`CONSTRAINT_NAME\` INNER JOIN \`INFORMATION_SCHEMA\`.\`REFERENTIAL_CONSTRAINTS\` \`RC\` ON \`RC\`.\`CONSTRAINT_NAME\` = \`TC\`.\`CONSTRAINT_NAME\` INNER JOIN \`INFORMATION_SCHEMA\`.\`CONSTRAINT_COLUMN_USAGE\` \`CCU\` ON \`CCU\`.\`CONSTRAINT_NAME\` = \`TC\`.\`CONSTRAINT_NAME\` WHERE \`TC\`.\`TABLE_CATALOG\` = '' AND \`TC\`.\`TABLE_SCHEMA\` = '' AND \`TC\`.\`CONSTRAINT_TYPE\` = 'FOREIGN KEY' AND \`TC\`.\`TABLE_NAME\` IN (${n})`,[h,f,p,m,T]=await Promise.all([this.query(i),this.query(r),this.query(a),this.query(c),this.query(l)]);return Promise.all(t.map(async A=>{const S=new pt;S.name=this.driver.buildTableName(A.TABLE_NAME),S.columns=await Promise.all(h.filter(q=>q.TABLE_NAME===A.TABLE_NAME).map(async q=>{const Z=p.filter(Re=>Re.TABLE_NAME===A.TABLE_NAME&&Re.COLUMN_NAME===q.COLUMN_NAME&&Re.IS_UNIQUE===!0),re=this.connection.entityMetadatas.find(Re=>this.getTablePath(S)===this.getTablePath(Re)),Ee=Z.length>0&&re&&re.indices.some(Re=>Z.some(D=>Re.name===D.INDEX_NAME&&Re.synchronize===!1)),Se=Z.every(Re=>p.some(D=>D.INDEX_NAME===Re.INDEX_NAME&&D.COLUMN_NAME!==q.COLUMN_NAME)),me=new nn;me.name=q.COLUMN_NAME;let W=q.SPANNER_TYPE.toLowerCase();if(W.indexOf("array")!==-1&&(me.isArray=!0,W=W.substring(W.indexOf("<")+1,W.indexOf(">"))),W.indexOf("(")!==-1?me.type=W.substring(0,W.indexOf("(")):me.type=W,this.driver.withLengthColumnTypes.indexOf(me.type)!==-1&&(me.length=W.substring(W.indexOf("(")+1,W.indexOf(")"))),q.IS_GENERATED==="ALWAYS"){me.asExpression=q.GENERATION_EXPRESSION,me.generatedType="STORED";const Re=this.selectTypeormMetadataSql({table:A.TABLE_NAME,type:we.GENERATED_COLUMN,name:me.name}),D=await this.query(Re.query,Re.parameters);D[0]&&D[0].value?me.asExpression=D[0].value:me.asExpression=""}return me.isUnique=Z.length>0&&!Ee&&!Se,me.isNullable=q.IS_NULLABLE==="YES",me.isPrimary=f.some(Re=>Re.TABLE_NAME===q.TABLE_NAME&&Re.COLUMN_NAME===q.COLUMN_NAME),me}));const P=T.filter(q=>q.TABLE_NAME===A.TABLE_NAME);S.foreignKeys=ee.uniq(P,q=>q.CONSTRAINT_NAME).map(q=>{const Z=P.filter(re=>re.CONSTRAINT_NAME===q.CONSTRAINT_NAME);return new Cn({name:q.CONSTRAINT_NAME,columnNames:ee.uniq(Z.map(re=>re.COLUMN_NAME)),referencedDatabase:q.REFERENCED_TABLE_SCHEMA,referencedTableName:q.REFERENCED_TABLE_NAME,referencedColumnNames:ee.uniq(Z.map(re=>re.REFERENCED_COLUMN_NAME)),onDelete:q.DELETE_RULE,onUpdate:q.UPDATE_RULE})});const F=p.filter(q=>q.TABLE_NAME===A.TABLE_NAME);S.indices=ee.uniq(F,q=>q.INDEX_NAME).map(q=>{const Z=F.filter(re=>re.INDEX_NAME===q.INDEX_NAME);return new Nt({table:S,name:q.INDEX_NAME,columnNames:Z.map(re=>re.COLUMN_NAME),isUnique:q.IS_UNIQUE,isNullFiltered:q.IS_NULL_FILTERED})});const B=m.filter(q=>q.TABLE_NAME===A.TABLE_NAME);return S.checks=ee.uniq(B,q=>q.CONSTRAINT_NAME).map(q=>{const Z=B.filter(re=>re.CONSTRAINT_NAME===q.CONSTRAINT_NAME);return new kn({name:q.CONSTRAINT_NAME,columnNames:Z.map(re=>re.COLUMN_NAME),expression:q.CHECK_CLAUSE})}),S}))}createTableSql(e,t){const n=e.columns.map(a=>this.buildCreateColumnSql(a)).join(", ");let i=`CREATE TABLE ${this.escapePath(e)} (${n}`;if(e.columns.filter(a=>a.isUnique).forEach(a=>{const c=e.indices.some(h=>h.columnNames.length===1&&!!h.isUnique&&h.columnNames.indexOf(a.name)!==-1),l=e.uniques.some(h=>h.columnNames.length===1&&h.columnNames.indexOf(a.name)!==-1);!c&&!l&&e.indices.push(new Nt({name:this.connection.namingStrategy.uniqueConstraintName(e,[a.name]),columnNames:[a.name],isUnique:!0}))}),e.uniques.length>0&&e.uniques.forEach(a=>{e.indices.some(l=>l.name===a.name)||e.indices.push(new Nt({name:a.name,columnNames:a.columnNames,isUnique:!0}))}),e.checks.length>0){const a=e.checks.map(c=>`CONSTRAINT \`${c.name?c.name:this.connection.namingStrategy.checkConstraintName(e,c.expression)}\` CHECK (${c.expression})`).join(", ");i+=`, ${a}`}if(e.foreignKeys.length>0&&t){const a=e.foreignKeys.map(c=>{const l=c.columnNames.map(f=>`\`${f}\``).join(", ");c.name||(c.name=this.connection.namingStrategy.foreignKeyName(e,c.columnNames,this.getTablePath(c),c.referencedColumnNames));const h=c.referencedColumnNames.map(f=>`\`${f}\``).join(", ");return`CONSTRAINT \`${c.name}\` FOREIGN KEY (${l}) REFERENCES ${this.escapePath(this.getTablePath(c))} (${h})`}).join(", ");i+=`, ${a}`}i+=")";const r=e.columns.filter(a=>a.isPrimary);if(r.length>0){const a=r.map(c=>this.driver.escape(c.name)).join(", ");i+=` PRIMARY KEY (${a})`}return new x(i)}dropTableSql(e){return new x(`DROP TABLE ${this.escapePath(e)}`)}createViewSql(e){const t=e.materialized?"MATERIALIZED ":"",n=this.escapePath(e),i=typeof e.expression=="string"?e.expression:e.expression(this.connection).getQuery();return new x(`CREATE ${t}VIEW ${n} SQL SECURITY INVOKER AS ${i}`)}async insertViewDefinitionSql(e){const{schema:t,tableName:n}=this.driver.parseTableName(e),i=e.materialized?we.MATERIALIZED_VIEW:we.VIEW,r=typeof e.expression=="string"?e.expression.trim():e.expression(this.connection).getQuery();return this.insertTypeormMetadataSql({type:i,schema:t,name:n,value:r})}dropViewSql(e){const t=e.materialized?"MATERIALIZED ":"";return new x(`DROP ${t}VIEW ${this.escapePath(e)}`)}async deleteViewDefinitionSql(e){const{schema:t,tableName:n}=this.driver.parseTableName(e),i=e.materialized?we.MATERIALIZED_VIEW:we.VIEW;return this.deleteTypeormMetadataSql({type:i,schema:t,name:n})}createIndexSql(e,t){const n=t.columnNames.map(r=>this.driver.escape(r)).join(", ");let i="";return t.isUnique&&(i+="UNIQUE "),t.isNullFiltered&&(i+="NULL_FILTERED "),new x(`CREATE ${i}INDEX \`${t.name}\` ON ${this.escapePath(e)} (${n})`)}dropIndexSql(e,t){const n=t instanceof Nt?t.name:t;return new x(`DROP INDEX \`${n}\``)}createCheckConstraintSql(e,t){return new x(`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT \`${t.name}\` CHECK (${t.expression})`)}dropCheckConstraintSql(e,t){const n=t instanceof kn?t.name:t;return new x(`ALTER TABLE ${this.escapePath(e)} DROP CONSTRAINT \`${n}\``)}createForeignKeySql(e,t){const n=t.columnNames.map(a=>this.driver.escape(a)).join(", "),i=t.referencedColumnNames.map(a=>this.driver.escape(a)).join(","),r=`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT \`${t.name}\` FOREIGN KEY (${n}) REFERENCES ${this.escapePath(this.getTablePath(t))} (${i})`;return new x(r)}dropForeignKeySql(e,t){const n=t instanceof Cn?t.name:t;return new x(`ALTER TABLE ${this.escapePath(e)} DROP CONSTRAINT \`${n}\``)}escapePath(e){const{tableName:t}=this.driver.parseTableName(e);return`\`${t}\``}buildCreateColumnSql(e){let t=`${this.driver.escape(e.name)} ${this.connection.driver.createFullType(e)}`;return e.generatedType==="STORED"&&e.asExpression?t+=` AS (${e.asExpression}) STORED`:e.isNullable||(t+=" NOT NULL"),t}async executeQueries(e,t){if(e instanceof x&&(e=[e]),t instanceof x&&(t=[t]),this.sqlInMemory.upQueries.push(...e),this.sqlInMemory.downQueries.push(...t),this.sqlMemoryMode===!0)return Promise.resolve();for(const{query:n,parameters:i}of e)this.isDMLQuery(n)?await this.query(n,i):await this.updateDDL(n,i)}isDMLQuery(e){return e.startsWith("INSERT")||e.startsWith("UPDATE")||e.startsWith("DELETE")}changeTableComment(e,t){throw new _("spanner driver does not support change table comment.")}}class yx{constructor(e){this.isReplicated=!1,this.treeSupport=!0,this.transactionSupport="none",this.supportedDataTypes=["bool","int64","float64","numeric","string","json","bytes","date","timestamp","array"],this.supportedUpsertTypes=[],this.spatialTypes=[],this.withLengthColumnTypes=["string","bytes"],this.withPrecisionColumnTypes=[],this.withScaleColumnTypes=[],this.mappedDataTypes={createDate:"timestamp",createDateDefault:"",updateDate:"timestamp",updateDateDefault:"",deleteDate:"timestamp",deleteDateNullable:!0,version:"int64",treeLevel:"int64",migrationId:"int64",migrationName:"string",migrationTimestamp:"int64",cacheId:"string",cacheIdentifier:"string",cacheTime:"int64",cacheDuration:"int64",cacheQuery:"string",cacheResult:"string",metadataType:"string",metadataDatabase:"string",metadataSchema:"string",metadataTable:"string",metadataName:"string",metadataValue:"string"},this.parametersPrefix="@param",this.dataTypeDefaults={},this.maxAliasLength=63,this.cteCapabilities={enabled:!0},this.connection=e,this.options=e.options,this.isReplicated=!!this.options.replication,this.loadDependencies()}async connect(){this.instance=this.spanner.instance(this.options.instanceId),this.instanceDatabase=this.instance.database(this.options.databaseId)}afterConnect(){return Promise.resolve()}async disconnect(){this.instanceDatabase.close()}createSchemaBuilder(){return new co(this.connection)}createQueryRunner(e){return new mx(this,e)}escapeQueryWithParameters(e,t,n){const i=Object.keys(n).map(a=>n[a]);if(!t||!Object.keys(t).length)return[e,i];const r=new Map;return e=e.replace(/:(\.\.\.)?([A-Za-z0-9_.]+)/g,(a,c,l)=>{if(!t.hasOwnProperty(l))return a;if(r.has(l))return this.parametersPrefix+r.get(l);const h=t[l];return h===null?a:c?h.map(f=>(i.push(f),this.createParameter(l,i.length-1))).join(", "):h instanceof Function?h():(i.push(h),r.set(l,i.length-1),this.createParameter(l,i.length-1))}),e=e.replace(/([ ]+)?=([ ]+)?:(\.\.\.)?([A-Za-z0-9_.]+)/g,(a,c,l,h,f)=>t.hasOwnProperty(f)&&t[f]===null?" IS NULL":a),[e,i]}escape(e){return`\`${e}\``}buildTableName(e,t,n){const i=[e];return n&&i.unshift(n),i.join(".")}parseTableName(e){const t=this.database,n=void 0;if(e instanceof pt||e instanceof Si){const r=this.parseTableName(e.name);return{database:e.database||r.database||t,schema:e.schema||r.schema||n,tableName:r.tableName}}if(e instanceof Cn){const r=this.parseTableName(e.referencedTableName);return{database:e.referencedDatabase||r.database||t,schema:e.referencedSchema||r.schema||n,tableName:r.tableName}}if(e instanceof jn)return{database:e.database||t,schema:e.schema||n,tableName:e.tableName};const i=e.split(".");return{database:(i.length>1?i[0]:void 0)||t,schema:n,tableName:i.length>1?i[1]:i[0]}}preparePersistentValue(e,t){return t.transformer&&(e=Mt.transformTo(t.transformer,e)),e==null?e:t.type==="numeric"?(this.options.driver||Ye.load("spanner")).Spanner.numeric(e.toString()):t.type==="date"?pe.mixedDateToDateString(e):t.type==="json"?e:t.type==="timestamp"||t.type===Date?pe.mixedDateToDate(e):e}prepareHydratedValue(e,t){return e==null?t.transformer?Mt.transformFrom(t.transformer,e):e:(t.type===Boolean||t.type==="bool"?e=!!e:t.type==="timestamp"||t.type===Date?e=new Date(e):t.type==="numeric"?e=e.value:t.type==="date"?e=pe.mixedDateToDateString(e):t.type==="json"?e=typeof e=="string"?JSON.parse(e):e:t.type===Number&&(e=isNaN(+e)?e:parseInt(e)),t.transformer&&(e=Mt.transformFrom(t.transformer,e)),e)}normalizeType(e){return e.type===Number?"int64":e.type===String||e.type==="uuid"?"string":e.type===Date?"timestamp":e.type===Buffer?"bytes":e.type===Boolean?"bool":e.type||""}normalizeDefault(e){return e.default===""?`"${e.default}"`:`${e.default}`}normalizeIsUnique(e){return e.entityMetadata.indices.some(t=>t.isUnique&&t.columns.length===1&&t.columns[0]===e)}getColumnLength(e){if(e.length)return e.length.toString();if(e.generationStrategy==="uuid")return"36";switch(e.type){case String:case"string":case"bytes":return"max";default:return""}}createFullType(e){let t=e.type;return this.getColumnLength(e)?t+=`(${this.getColumnLength(e)})`:e.width?t+=`(${e.width})`:e.precision!==null&&e.precision!==void 0&&e.scale!==null&&e.scale!==void 0?t+=`(${e.precision},${e.scale})`:e.precision!==null&&e.precision!==void 0&&(t+=`(${e.precision})`),e.isArray&&(t=`array<${t}>`),t}obtainMasterConnection(){return this.instanceDatabase}obtainSlaveConnection(){return this.instanceDatabase}createGeneratedMap(e,t,n){if(!t)return;if(t.insertId===void 0)return Object.keys(t).reduce((r,a)=>{const c=e.findColumnWithDatabaseName(a);return c&&ee.mergeDeep(r,c.createValueMap(t[a])),r},{});const i=e.generatedColumns.reduce((r,a)=>{let c;return a.generationStrategy==="increment"&&t.insertId&&(c=t.insertId+n),ee.mergeDeep(r,a.createValueMap(c))},{});return Object.keys(i).length>0?i:void 0}findChangedColumns(e,t){return t.filter(n=>{const i=e.find(a=>a.name===n.databaseName);return i?i.name!==n.databaseName||i.type!==this.normalizeType(n)||i.length!==this.getColumnLength(n)||i.asExpression!==n.asExpression||i.generatedType!==n.generatedType||i.isPrimary!==n.isPrimary||!this.compareNullableValues(n,i)||i.isUnique!==this.normalizeIsUnique(n):!1})}isReturningSqlSupported(){return!0}isUUIDGenerationSupported(){return!0}isFullTextColumnTypeSupported(){return!1}createParameter(e,t){return this.parametersPrefix+t}loadDependencies(){try{const e=this.options.driver||Ye.load("spanner");if(this.options.credentials){this.spanner=new e.Spanner({projectId:this.options.projectId,credentials:this.options.credentials});return}this.spanner=new e.Spanner({projectId:this.options.projectId})}catch(e){throw console.error(e),new Fr("Spanner","@google-cloud/spanner")}}compareNullableValues(e,t){return e.generatedType?!0:e.isNullable===t.isNullable}compareDefaultValues(e,t){return typeof e=="string"&&typeof t=="string"&&(e=e.replace(/^'+|'+$/g,""),t=t.replace(/^'+|'+$/g,"")),e===t}normalizeDatetimeFunction(e){if(!e)return e;if(e.toUpperCase().indexOf("CURRENT_TIMESTAMP")!==-1||e.toUpperCase().indexOf("NOW")!==-1){const n=e.match(/\(\d+\)/);return n?`CURRENT_TIMESTAMP${n[0]}`:"CURRENT_TIMESTAMP"}else return e}escapeComment(e){return e&&(e=e.replace(/\u0000/g,""),e)}}class gx{create(e){const{type:t}=e.options;switch(t){case"mysql":return new wf(e);case"postgres":return new Bp(e);case"cockroachdb":return new N0(e);case"sap":return new C0(e);case"mariadb":return new wf(e);case"sqlite":return new R0(e);case"better-sqlite3":return new x0(e);case"cordova":return new G0(e);case"nativescript":return new X0(e);case"react-native":return new K0(e);case"sqljs":return new ex(e);case"oracle":return new S0(e);case"mssql":return new A0(e);case"mongodb":return new T0(e);case"expo":return new sx(e).create();case"aurora-mysql":return new ox(e);case"aurora-postgres":return new dx(e);case"capacitor":return new px(e);case"spanner":return new yx(e);default:throw new FC(t,["aurora-mysql","aurora-postgres","better-sqlite3","capacitor","cockroachdb","cordova","expo","mariadb","mongodb","mssql","mysql","nativescript","oracle","postgres","react-native","sap","sqlite","sqljs","spanner"])}}}function Jc(s,e,t=[".js",".cjs",".ts"]){return[]}const Ex=new class{constructor(){this.instances=[]}get(s){let e=this.instances.find(t=>t.type===s);return e||(e={type:s,object:new s},this.instances.push(e)),e.object}};let Nu,ds;function BO(s,e){Nu=s,ds=e}function Au(s){if(Nu)try{const e=Nu.get(s);if(e||!ds||!ds.fallback)return e}catch(e){if(!ds||!ds.fallbackOnErrors)throw e}return Ex.get(s)}class Nn{constructor(e){this["@instanceof"]=Symbol.for("ColumnMetadata"),this.length="",this.isPrimary=!1,this.isGenerated=!1,this.isNullable=!1,this.isSelect=!0,this.isInsert=!0,this.isUpdate=!0,this.zerofill=!1,this.unsigned=!1,this.isArray=!1,this.isVirtual=!1,this.isVirtualProperty=!1,this.isDiscriminator=!1,this.isTreeLevel=!1,this.isCreateDate=!1,this.isUpdateDate=!1,this.isDeleteDate=!1,this.isVersion=!1,this.isObjectId=!1,this.isNestedSetLeft=!1,this.isNestedSetRight=!1,this.isMaterializedPath=!1,this.entityMetadata=e.entityMetadata,this.embeddedMetadata=e.embeddedMetadata,this.referencedColumn=e.referencedColumn,e.args.target&&(this.target=e.args.target),e.args.propertyName&&(this.propertyName=e.args.propertyName),e.args.options.name&&(this.givenDatabaseName=e.args.options.name),e.args.options.type&&(this.type=e.args.options.type),e.args.options.length&&(this.length=e.args.options.length?e.args.options.length.toString():""),e.args.options.width&&(this.width=e.args.options.width),e.args.options.charset&&(this.charset=e.args.options.charset),e.args.options.collation&&(this.collation=e.args.options.collation),e.args.options.primary&&(this.isPrimary=e.args.options.primary),e.args.options.default===null&&(this.isNullable=!0),e.args.options.nullable!==void 0&&(this.isNullable=e.args.options.nullable),e.args.options.select!==void 0&&(this.isSelect=e.args.options.select),e.args.options.insert!==void 0&&(this.isInsert=e.args.options.insert),e.args.options.update!==void 0&&(this.isUpdate=e.args.options.update),e.args.options.readonly!==void 0&&(this.isUpdate=!e.args.options.readonly),e.args.options.comment&&(this.comment=e.args.options.comment),e.args.options.default!==void 0&&(this.default=e.args.options.default),e.args.options.onUpdate&&(this.onUpdate=e.args.options.onUpdate),e.args.options.generatedIdentity&&(this.generatedIdentity=e.args.options.generatedIdentity),e.args.options.scale!==null&&e.args.options.scale!==void 0&&(this.scale=e.args.options.scale),e.args.options.zerofill&&(this.zerofill=e.args.options.zerofill,this.unsigned=!0),e.args.options.unsigned&&(this.unsigned=e.args.options.unsigned),e.args.options.precision!==null&&(this.precision=e.args.options.precision),e.args.options.enum&&(Ce.isObject(e.args.options.enum)&&!Array.isArray(e.args.options.enum)?this.enum=Object.keys(e.args.options.enum).filter(t=>isNaN(+t)&&typeof e.args.options.enum[t]!="function").map(t=>e.args.options.enum[t]):this.enum=e.args.options.enum),e.args.options.enumName&&(this.enumName=e.args.options.enumName),e.args.options.primaryKeyConstraintName&&(this.primaryKeyConstraintName=e.args.options.primaryKeyConstraintName),e.args.options.foreignKeyConstraintName&&(this.foreignKeyConstraintName=e.args.options.foreignKeyConstraintName),e.args.options.asExpression&&(this.asExpression=e.args.options.asExpression,this.generatedType=e.args.options.generatedType?e.args.options.generatedType:"VIRTUAL"),e.args.options.hstoreType&&(this.hstoreType=e.args.options.hstoreType),e.args.options.array&&(this.isArray=e.args.options.array),e.args.mode&&(this.isVirtualProperty=e.args.mode==="virtual-property",this.isVirtual=e.args.mode==="virtual",this.isTreeLevel=e.args.mode==="treeLevel",this.isCreateDate=e.args.mode==="createDate",this.isUpdateDate=e.args.mode==="updateDate",this.isDeleteDate=e.args.mode==="deleteDate",this.isVersion=e.args.mode==="version",this.isObjectId=e.args.mode==="objectId"),this.isVirtualProperty&&(this.isInsert=!1,this.isUpdate=!1),e.args.options.transformer&&(this.transformer=e.args.options.transformer),e.args.options.spatialFeatureType&&(this.spatialFeatureType=e.args.options.spatialFeatureType),e.args.options.srid!==void 0&&(this.srid=e.args.options.srid),e.args.options.query&&(this.query=e.args.options.query),this.isTreeLevel&&(this.type=e.connection.driver.mappedDataTypes.treeLevel),this.isCreateDate&&(this.type||(this.type=e.connection.driver.mappedDataTypes.createDate),this.default||(this.default=()=>e.connection.driver.mappedDataTypes.createDateDefault),this.precision===void 0&&e.args.options.precision===void 0&&e.connection.driver.mappedDataTypes.createDatePrecision&&(this.precision=e.connection.driver.mappedDataTypes.createDatePrecision)),this.isUpdateDate&&(this.type||(this.type=e.connection.driver.mappedDataTypes.updateDate),this.default||(this.default=()=>e.connection.driver.mappedDataTypes.updateDateDefault),this.onUpdate||(this.onUpdate=e.connection.driver.mappedDataTypes.updateDateDefault),this.precision===void 0&&e.args.options.precision===void 0&&e.connection.driver.mappedDataTypes.updateDatePrecision&&(this.precision=e.connection.driver.mappedDataTypes.updateDatePrecision)),this.isDeleteDate&&(this.type||(this.type=e.connection.driver.mappedDataTypes.deleteDate),this.isNullable||(this.isNullable=e.connection.driver.mappedDataTypes.deleteDateNullable),this.precision===void 0&&e.args.options.precision===void 0&&e.connection.driver.mappedDataTypes.deleteDatePrecision&&(this.precision=e.connection.driver.mappedDataTypes.deleteDatePrecision)),this.isVersion&&(this.type=e.connection.driver.mappedDataTypes.version),e.closureType&&(this.closureType=e.closureType),e.nestedSetLeft&&(this.isNestedSetLeft=e.nestedSetLeft),e.nestedSetRight&&(this.isNestedSetRight=e.nestedSetRight),e.materializedPath&&(this.isMaterializedPath=e.materializedPath)}createValueMap(e,t=!1){if(this.embeddedMetadata){const n=[...this.embeddedMetadata.parentPropertyNames],i=(r,a)=>{const c=r.shift();return c?(a[c]={},i(r,a[c]),a):((this.generationStrategy==="increment"||this.generationStrategy==="rowid")&&this.type==="bigint"&&e!==null&&(e=String(e)),a[t?this.databaseName:this.propertyName]=e,a)};return i(n,{})}else return(this.generationStrategy==="increment"||this.generationStrategy==="rowid")&&this.type==="bigint"&&e!==null&&(e=String(e)),{[t?this.databaseName:this.propertyName]:e}}getEntityValueMap(e,t){var i;if(this.embeddedMetadata){const r=[...this.embeddedMetadata.parentPropertyNames],a=this.embeddedMetadata.isArray,c=(h,f)=>{if(f===void 0)return{};const p=h.shift();if(p){const m=c(h,f[p]);return Object.keys(m).length>0?{[p]:m}:{}}return a&&Array.isArray(f)?f.map(m=>({[this.propertyName]:m[this.propertyName]})):f[this.propertyName]!==void 0?{[this.propertyName]:f[this.propertyName]}:{}},l=c(r,e);return Object.keys(l).length>0?l:void 0}else if(this.relationMetadata&&!((i=Object.getOwnPropertyDescriptor(e,this.relationMetadata.propertyName))!=null&&i.get)&&e[this.relationMetadata.propertyName]&&Ce.isObject(e[this.relationMetadata.propertyName])){if(this.relationMetadata.joinColumns.length>1){const r=this.relationMetadata.joinColumns.reduce((a,c)=>{const l=c.referencedColumn.getEntityValueMap(e[this.relationMetadata.propertyName]);return l===void 0?a:ee.mergeDeep(a,l)},{});if(Object.keys(r).length>0)return{[this.propertyName]:r}}else{const r=this.relationMetadata.joinColumns[0].referencedColumn.getEntityValue(e[this.relationMetadata.propertyName]);if(r)return{[this.propertyName]:r}}return}else return e[this.propertyName]!==void 0?{[this.propertyName]:e[this.propertyName]}:void 0}getEntityValue(e,t=!1){if(e==null)return;let n;if(this.embeddedMetadata){const i=[...this.embeddedMetadata.parentPropertyNames],r=this.embeddedMetadata.isArray,a=(l,h)=>{const f=l.shift();return f&&h?a(l,h[f]):h},c=a(i,e);if(c)if(this.relationMetadata&&this.referencedColumn){const l=this.relationMetadata.getEntityValue(c);l&&Ce.isObject(l)&&!$.isFindOperator(l)&&!Buffer.isBuffer(l)?n=this.referencedColumn.getEntityValue(l):c[this.propertyName]&&Ce.isObject(c[this.propertyName])&&!$.isFindOperator(c[this.propertyName])&&!Buffer.isBuffer(c[this.propertyName])&&!(c[this.propertyName]instanceof Date)?n=this.referencedColumn.getEntityValue(c[this.propertyName]):n=c[this.propertyName]}else this.referencedColumn?n=this.referencedColumn.getEntityValue(c[this.propertyName]):r&&Array.isArray(c)?n=c.map(l=>l[this.propertyName]):n=c[this.propertyName]}else if(this.relationMetadata&&this.referencedColumn){const i=this.relationMetadata.getEntityValue(e);i&&Ce.isObject(i)&&!$.isFindOperator(i)&&typeof i!="function"&&!Buffer.isBuffer(i)?n=this.referencedColumn.getEntityValue(i):e[this.propertyName]&&Ce.isObject(e[this.propertyName])&&!$.isFindOperator(e[this.propertyName])&&typeof e[this.propertyName]!="function"&&!Buffer.isBuffer(e[this.propertyName])&&!(e[this.propertyName]instanceof Date)?n=this.referencedColumn.getEntityValue(e[this.propertyName]):n=e[this.propertyName]}else this.referencedColumn?n=this.referencedColumn.getEntityValue(e[this.propertyName]):n=e[this.propertyName];return t&&this.transformer&&(n=Mt.transformTo(this.transformer,n)),n}setEntityValue(e,t){if(this.embeddedMetadata){const n=(i,r)=>{const a=i.shift();return a?(r[a.propertyName]||(r[a.propertyName]=a.create()),n(i,r[a.propertyName]),r):(r[this.propertyName]=t,r)};return n([...this.embeddedMetadata.embeddedMetadataTree],e)}else!this.entityMetadata.isJunction&&this.isVirtual&&this.referencedColumn&&this.referencedColumn.propertyName!==this.propertyName?(this.propertyName in e||(e[this.propertyName]={}),e[this.propertyName][this.referencedColumn.propertyName]=t):e[this.propertyName]=t}compareEntityValue(e,t){const n=this.getEntityValue(e);return typeof(n==null?void 0:n.equals)=="function"?n.equals(t):n===t}build(e){return this.propertyPath=this.buildPropertyPath(),this.propertyAliasName=this.propertyPath.replace(".","_"),this.databaseName=this.buildDatabaseName(e),this.databasePath=this.buildDatabasePath(),this.databaseNameWithoutPrefixes=e.namingStrategy.columnName(this.propertyName,this.givenDatabaseName,[]),this}buildPropertyPath(){let e="";return this.embeddedMetadata&&this.embeddedMetadata.parentPropertyNames.length&&(e=this.embeddedMetadata.parentPropertyNames.join(".")+"."),e+=this.propertyName,!this.entityMetadata.isJunction&&this.isVirtual&&this.referencedColumn&&this.referencedColumn.propertyName!==this.propertyName&&(e+="."+this.referencedColumn.propertyName),e}buildDatabasePath(){let e="";return this.embeddedMetadata&&this.embeddedMetadata.parentPropertyNames.length&&(e=this.embeddedMetadata.parentPropertyNames.join(".")+"."),e+=this.databaseName,!this.entityMetadata.isJunction&&this.isVirtual&&this.referencedColumn&&this.referencedColumn.databaseName!==this.databaseName&&(e+="."+this.referencedColumn.databaseName),e}buildDatabaseName(e){let t=this.embeddedMetadata?this.embeddedMetadata.parentPrefixes:[];return e.driver.options.type==="mongodb"&&(t=[]),e.namingStrategy.columnName(this.propertyName,this.givenDatabaseName,t)}}class qn{constructor(e){this.isUnique=!1,this.isSpatial=!1,this.isFulltext=!1,this.isNullFiltered=!1,this.synchronize=!0,this.columns=[],this.columnNamesWithOrderingMap={},this.entityMetadata=e.entityMetadata,this.embeddedMetadata=e.embeddedMetadata,e.columns&&(this.columns=e.columns),e.args&&(this.target=e.args.target,e.args.synchronize!==null&&e.args.synchronize!==void 0&&(this.synchronize=e.args.synchronize),this.isUnique=!!e.args.unique,this.isSpatial=!!e.args.spatial,this.isFulltext=!!e.args.fulltext,this.isNullFiltered=!!e.args.nullFiltered,this.parser=e.args.parser,this.where=e.args.where,this.isSparse=e.args.sparse,this.isBackground=e.args.background,this.isConcurrent=e.args.concurrent,this.expireAfterSeconds=e.args.expireAfterSeconds,this.givenName=e.args.name,this.givenColumnNames=e.args.columns)}build(e){if(this.synchronize===!1)return this.name=this.givenName,this;const t={};if(this.givenColumnNames){let n=[];if(Array.isArray(this.givenColumnNames))n=this.givenColumnNames.map(i=>this.embeddedMetadata?this.embeddedMetadata.propertyPath+"."+i:i.trim()),n.forEach(i=>t[i]=1);else{const i=this.givenColumnNames(this.entityMetadata.propertiesMap);Array.isArray(i)?(n=i.map(r=>String(r)),n.forEach(r=>t[r]=1)):(n=Object.keys(i).map(r=>String(r)),Object.keys(i).forEach(r=>t[r]=i[r]))}this.columns=n.map(i=>{const r=this.entityMetadata.columns.find(h=>h.propertyPath===i);if(r)return[r];const a=this.entityMetadata.relations.find(h=>h.isWithJoinColumn&&h.propertyName===i);if(a)return a.joinColumns;const c=this.givenName?'"'+this.givenName+'" ':"",l=this.entityMetadata.targetName;throw new _(`Index ${c}contains column that is missing in the entity (${l}): `+i)}).reduce((i,r)=>i.concat(r))}return this.columnNamesWithOrderingMap=Object.keys(t).reduce((n,i)=>{const r=this.entityMetadata.columns.find(a=>a.propertyPath===i);return r&&(n[r.databasePath]=t[i]),n},{}),this.name=this.givenName?this.givenName:e.indexName(this.entityMetadata.tableName,this.columns.map(n=>n.databaseName),this.where),this}}class _f{constructor(e){this.isTreeParent=!1,this.isTreeChildren=!1,this.isPrimary=!1,this.isLazy=!1,this.isEager=!1,this.persistenceEnabled=!0,this.isCascadeInsert=!1,this.isCascadeUpdate=!1,this.isCascadeRemove=!1,this.isCascadeSoftRemove=!1,this.isCascadeRecover=!1,this.isNullable=!0,this.createForeignKeyConstraints=!0,this.isOwning=!1,this.isOneToOne=!1,this.isOneToOneOwner=!1,this.isWithJoinColumn=!1,this.isOneToOneNotOwner=!1,this.isOneToMany=!1,this.isManyToOne=!1,this.isManyToMany=!1,this.isManyToManyOwner=!1,this.isManyToManyNotOwner=!1,this.foreignKeys=[],this.joinColumns=[],this.inverseJoinColumns=[],this.entityMetadata=e.entityMetadata,this.embeddedMetadata=e.embeddedMetadata;const t=e.args;this.target=t.target,this.propertyName=t.propertyName,this.relationType=t.relationType,t.inverseSideProperty&&(this.givenInverseSidePropertyFactory=t.inverseSideProperty),this.isLazy=t.isLazy||!1,this.isCascadeInsert=t.options.cascade===!0||Array.isArray(t.options.cascade)&&t.options.cascade.indexOf("insert")!==-1,this.isCascadeUpdate=t.options.cascade===!0||Array.isArray(t.options.cascade)&&t.options.cascade.indexOf("update")!==-1,this.isCascadeRemove=t.options.cascade===!0||Array.isArray(t.options.cascade)&&t.options.cascade.indexOf("remove")!==-1,this.isCascadeSoftRemove=t.options.cascade===!0||Array.isArray(t.options.cascade)&&t.options.cascade.indexOf("soft-remove")!==-1,this.isCascadeRecover=t.options.cascade===!0||Array.isArray(t.options.cascade)&&t.options.cascade.indexOf("recover")!==-1,this.isNullable=!(t.options.nullable===!1||this.isPrimary),this.onDelete=t.options.onDelete,this.onUpdate=t.options.onUpdate,this.deferrable=t.options.deferrable,this.createForeignKeyConstraints=t.options.createForeignKeyConstraints!==!1,this.isEager=t.options.eager||!1,this.persistenceEnabled=t.options.persistence!==!1,this.orphanedRowAction=t.options.orphanedRowAction||"nullify",this.isTreeParent=t.isTreeParent||!1,this.isTreeChildren=t.isTreeChildren||!1,typeof t.type=="function"?this.type=typeof t.type=="function"?t.type():t.type:$.isEntitySchema(t.type)?this.type=t.type.options.name:Ce.isObject(t.type)&&typeof t.type.name=="string"?this.type=t.type.name:this.type=t.type,this.isOneToOne=this.relationType==="one-to-one",this.isOneToMany=this.relationType==="one-to-many",this.isManyToOne=this.relationType==="many-to-one",this.isManyToMany=this.relationType==="many-to-many",this.isOneToOneNotOwner=!!this.isOneToOne,this.isManyToManyNotOwner=!!this.isManyToMany}getRelationIdMap(e){const n=(this.isOwning?this.joinColumns:this.inverseRelation.joinColumns).map(i=>i.referencedColumn);return jn.getValueMap(e,n)}ensureRelationIdMap(e){if(Ce.isObject(e))return e;const n=(this.isOwning?this.joinColumns:this.inverseRelation.joinColumns).map(i=>i.referencedColumn);if(n.length>1)throw new _("Cannot create relation id map for a single value because relation contains multiple referenced columns.");return n[0].createValueMap(e)}getEntityValue(e,t=!1){if(e!=null)if(this.embeddedMetadata){const n=[...this.embeddedMetadata.parentPropertyNames],i=(a,c)=>{const l=a.shift();return l?c[l]?i(a,c[l]):void 0:c},r=i(n,e);return this.isLazy?r["__"+this.propertyName+"__"]!==void 0?r["__"+this.propertyName+"__"]:t===!0?r[this.propertyName]:void 0:r?r[this.isLazy?"__"+this.propertyName+"__":this.propertyName]:void 0}else return this.isLazy?e["__"+this.propertyName+"__"]!==void 0?e["__"+this.propertyName+"__"]:t===!0?e[this.propertyName]:void 0:e[this.propertyName]}setEntityValue(e,t){const n=this.isLazy?"__"+this.propertyName+"__":this.propertyName;if(this.embeddedMetadata){const i=(r,a)=>{const c=r.shift();return c?(a[c.propertyName]||(a[c.propertyName]=c.create()),i(r,a[c.propertyName]),a):(a[n]=t,a)};return i([...this.embeddedMetadata.embeddedMetadataTree],e)}else e[n]=t}createValueMap(e){if(this.embeddedMetadata){const t=[...this.embeddedMetadata.parentPropertyNames],n=(i,r)=>{const a=i.shift();return a?(r[a]={},n(i,r[a]),r):(r[this.propertyName]=e,r)};return n(t,{})}else return{[this.propertyName]:e}}build(){this.propertyPath=this.buildPropertyPath()}registerForeignKeys(...e){this.foreignKeys.push(...e)}registerJoinColumns(e=[],t=[]){this.joinColumns=e,this.inverseJoinColumns=t,this.isOwning=this.isManyToOne||(this.isManyToMany||this.isOneToOne)&&this.joinColumns.length>0,this.isOneToOneOwner=this.isOneToOne&&this.isOwning,this.isOneToOneNotOwner=this.isOneToOne&&!this.isOwning,this.isManyToManyOwner=this.isManyToMany&&this.isOwning,this.isManyToManyNotOwner=this.isManyToMany&&!this.isOwning,this.isWithJoinColumn=this.isManyToOne||this.isOneToOneOwner}registerJunctionEntityMetadata(e){this.junctionEntityMetadata=e,this.joinTableName=e.tableName,this.inverseRelation&&(this.inverseRelation.junctionEntityMetadata=e,this.joinTableName=e.tableName)}buildInverseSidePropertyPath(){if(this.givenInverseSidePropertyFactory){const e=this.inverseEntityMetadata.propertiesMap;if(typeof this.givenInverseSidePropertyFactory=="function")return this.givenInverseSidePropertyFactory(e);if(typeof this.givenInverseSidePropertyFactory=="string")return this.givenInverseSidePropertyFactory}else{if(this.isTreeParent&&this.entityMetadata.treeChildrenRelation)return this.entityMetadata.treeChildrenRelation.propertyName;if(this.isTreeChildren&&this.entityMetadata.treeParentRelation)return this.entityMetadata.treeParentRelation.propertyName}return""}buildPropertyPath(){return!this.embeddedMetadata||!this.embeddedMetadata.parentPropertyNames.length?this.propertyName:this.embeddedMetadata.parentPropertyNames.join(".")+"."+this.propertyName}}class Tx{constructor(e){this.columns=[],this.relations=[],this.listeners=[],this.indices=[],this.uniques=[],this.relationIds=[],this.relationCounts=[],this.embeddeds=[],this.isAlwaysUsingConstructor=!0,this.isArray=!1,this.parentPropertyNames=[],this.parentPrefixes=[],this.embeddedMetadataTree=[],this.columnsFromTree=[],this.relationsFromTree=[],this.listenersFromTree=[],this.indicesFromTree=[],this.uniquesFromTree=[],this.relationIdsFromTree=[],this.relationCountsFromTree=[],this.entityMetadata=e.entityMetadata,this.type=e.args.type(),this.propertyName=e.args.propertyName,this.customPrefix=e.args.prefix,this.isArray=e.args.isArray}create(e){return typeof this.type!="function"?{}:e!=null&&e.fromDeserializer||!this.isAlwaysUsingConstructor?Object.create(this.type.prototype):new this.type}build(e){return this.embeddeds.forEach(t=>t.build(e)),this.prefix=this.buildPrefix(e),this.parentPropertyNames=this.buildParentPropertyNames(),this.parentPrefixes=this.buildParentPrefixes(),this.propertyPath=this.parentPropertyNames.join("."),this.embeddedMetadataTree=this.buildEmbeddedMetadataTree(),this.columnsFromTree=this.buildColumnsFromTree(),this.relationsFromTree=this.buildRelationsFromTree(),this.listenersFromTree=this.buildListenersFromTree(),this.indicesFromTree=this.buildIndicesFromTree(),this.uniquesFromTree=this.buildUniquesFromTree(),this.relationIdsFromTree=this.buildRelationIdsFromTree(),this.relationCountsFromTree=this.buildRelationCountsFromTree(),e.options.entitySkipConstructor&&(this.isAlwaysUsingConstructor=!e.options.entitySkipConstructor),this}buildPartialPrefix(){if(this.customPrefix===void 0||this.customPrefix===!0)return[this.propertyName];if(this.customPrefix===""||this.customPrefix===!1)return[];if(typeof this.customPrefix=="string")return[this.customPrefix];throw new _(`Invalid prefix option given for ${this.entityMetadata.targetName}#${this.propertyName}`)}buildPrefix(e){if(e.driver.options.type==="mongodb")return this.propertyName;const t=[];return this.parentEmbeddedMetadata&&t.push(this.parentEmbeddedMetadata.buildPrefix(e)),t.push(...this.buildPartialPrefix()),t.join("_")}buildParentPropertyNames(){return this.parentEmbeddedMetadata?this.parentEmbeddedMetadata.buildParentPropertyNames().concat(this.propertyName):[this.propertyName]}buildParentPrefixes(){return this.parentEmbeddedMetadata?this.parentEmbeddedMetadata.buildParentPrefixes().concat(this.buildPartialPrefix()):this.buildPartialPrefix()}buildEmbeddedMetadataTree(){return this.parentEmbeddedMetadata?this.parentEmbeddedMetadata.buildEmbeddedMetadataTree().concat(this):[this]}buildColumnsFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildColumnsFromTree()),this.columns)}buildRelationsFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildRelationsFromTree()),this.relations)}buildListenersFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildListenersFromTree()),this.listeners)}buildIndicesFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildIndicesFromTree()),this.indices)}buildUniquesFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildUniquesFromTree()),this.uniques)}buildRelationIdsFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildRelationIdsFromTree()),this.relationIds)}buildRelationCountsFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildRelationCountsFromTree()),this.relationCounts)}}class vf{constructor(e){this.entityMetadata=e.entityMetadata,this.target=e.args.target,this.propertyName=e.args.propertyName,this.relationNameOrFactory=e.args.relation,this.alias=e.args.alias,this.queryBuilderFactory=e.args.queryBuilderFactory}setValue(e){const t=this.relation.getEntityValue(e);if(Array.isArray(t))e[this.propertyName]=t.map(n=>this.relation.inverseEntityMetadata.getEntityIdMixedMap(n)).filter(n=>n!=null);else{const n=this.relation.inverseEntityMetadata.getEntityIdMixedMap(t);n!==void 0&&(e[this.propertyName]=n)}}build(){const e=typeof this.relationNameOrFactory=="function"?this.relationNameOrFactory(this.entityMetadata.propertiesMap):this.relationNameOrFactory,t=this.entityMetadata.findRelationWithPropertyPath(e);if(!t)throw new _(`Cannot find relation ${e}. Wrong relation specified for @RelationId decorator.`);this.relation=t}}class Mf{constructor(e){this.entityMetadata=e.entityMetadata,this.target=e.args.target,this.propertyName=e.args.propertyName,this.relationNameOrFactory=e.args.relation,this.alias=e.args.alias,this.queryBuilderFactory=e.args.queryBuilderFactory}build(){const e=typeof this.relationNameOrFactory=="function"?this.relationNameOrFactory(this.entityMetadata.propertiesMap):this.relationNameOrFactory,t=this.entityMetadata.findRelationWithPropertyPath(e);if(!t)throw new _(`Cannot find relation ${e}. Wrong relation specified for @RelationCount decorator.`);this.relation=t}}class wt{}wt.AFTER_LOAD="after-load";wt.BEFORE_INSERT="before-insert";wt.AFTER_INSERT="after-insert";wt.BEFORE_UPDATE="before-update";wt.AFTER_UPDATE="after-update";wt.BEFORE_REMOVE="before-remove";wt.AFTER_REMOVE="after-remove";wt.BEFORE_SOFT_REMOVE="before-soft-remove";wt.AFTER_SOFT_REMOVE="after-soft-remove";wt.BEFORE_RECOVER="before-recover";wt.AFTER_RECOVER="after-recover";class Lr{constructor(e){this.columns=[],this.referencedColumns=[],this.columnNames=[],this.referencedColumnNames=[],this.entityMetadata=e.entityMetadata,this.referencedEntityMetadata=e.referencedEntityMetadata,this.columns=e.columns,this.referencedColumns=e.referencedColumns,this.onDelete=e.onDelete||"NO ACTION",this.onUpdate=e.onUpdate||"NO ACTION",this.deferrable=e.deferrable,this.givenName=e.name,e.namingStrategy&&this.build(e.namingStrategy)}build(e){this.columnNames=this.columns.map(t=>t.databaseName),this.referencedColumnNames=this.referencedColumns.map(t=>t.databaseName),this.referencedTablePath=this.referencedEntityMetadata.tablePath,this.name=this.givenName?this.givenName:e.foreignKeyName(this.entityMetadata.tableName,this.columnNames,this.referencedEntityMetadata.tableName,this.referencedColumnNames)}}class wx{constructor(e){this.connection=e}build(e,t){var h,f;const n=this.collectReferencedColumns(e,t),i=this.collectInverseReferencedColumns(e,t),r=t.name||this.connection.namingStrategy.joinTableName(e.entityMetadata.tableNameWithoutPrefix,e.inverseEntityMetadata.tableNameWithoutPrefix,e.propertyPath,e.inverseRelation?e.inverseRelation.propertyName:""),a=new jn({connection:this.connection,args:{target:"",name:r,type:"junction",database:t.database||e.entityMetadata.database,schema:t.schema||e.entityMetadata.schema,synchronize:t.synchronize}});a.build();const c=n.map(p=>{const m=t.joinColumns?t.joinColumns.find(A=>(!A.referencedColumnName||A.referencedColumnName===p.propertyName)&&!!A.name):void 0,T=m&&m.name?m.name:this.connection.namingStrategy.joinTableColumnName(e.entityMetadata.tableNameWithoutPrefix,p.propertyName,p.databaseName);return new Nn({connection:this.connection,entityMetadata:a,referencedColumn:p,args:{target:"",mode:"virtual",propertyName:T,options:{name:T,length:!p.length&&(te.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&this.connection.driver.normalizeType(p)!=="uuid"&&(p.generationStrategy==="uuid"||p.type==="uuid")?"36":p.length,width:p.width,type:p.type,precision:p.precision,scale:p.scale,charset:p.charset,collation:p.collation,zerofill:p.zerofill,unsigned:p.zerofill?!0:p.unsigned,enum:p.enum,enumName:p.enumName,foreignKeyConstraintName:m==null?void 0:m.foreignKeyConstraintName,nullable:!1,primary:!0}}})}),l=i.map(p=>{const m=t.inverseJoinColumns?t.inverseJoinColumns.find(A=>(!A.referencedColumnName||A.referencedColumnName===p.propertyName)&&!!A.name):void 0,T=m&&m.name?m.name:this.connection.namingStrategy.joinTableInverseColumnName(e.inverseEntityMetadata.tableNameWithoutPrefix,p.propertyName,p.databaseName);return new Nn({connection:this.connection,entityMetadata:a,referencedColumn:p,args:{target:"",mode:"virtual",propertyName:T,options:{length:!p.length&&(te.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&this.connection.driver.normalizeType(p)!=="uuid"&&(p.generationStrategy==="uuid"||p.type==="uuid")?"36":p.length,width:p.width,type:p.type,precision:p.precision,scale:p.scale,charset:p.charset,collation:p.collation,zerofill:p.zerofill,unsigned:p.zerofill?!0:p.unsigned,enum:p.enum,enumName:p.enumName,foreignKeyConstraintName:m==null?void 0:m.foreignKeyConstraintName,name:T,nullable:!1,primary:!0}}})});return this.changeDuplicatedColumnNames(c,l),a.ownerColumns=c,a.inverseColumns=l,a.ownColumns=[...c,...l],a.ownColumns.forEach(p=>p.relationMetadata=e),a.foreignKeys=e.createForeignKeyConstraints?[new Lr({entityMetadata:a,referencedEntityMetadata:e.entityMetadata,columns:c,referencedColumns:n,name:(h=c[0])==null?void 0:h.foreignKeyConstraintName,onDelete:this.connection.driver.options.type==="spanner"?"NO ACTION":e.onDelete||"CASCADE",onUpdate:this.connection.driver.options.type==="oracle"||this.connection.driver.options.type==="spanner"?"NO ACTION":e.onUpdate||"CASCADE"}),new Lr({entityMetadata:a,referencedEntityMetadata:e.inverseEntityMetadata,columns:l,referencedColumns:i,name:(f=l[0])==null?void 0:f.foreignKeyConstraintName,onDelete:this.connection.driver.options.type==="spanner"?"NO ACTION":e.inverseRelation?e.inverseRelation.onDelete:"CASCADE",onUpdate:this.connection.driver.options.type==="oracle"||this.connection.driver.options.type==="spanner"?"NO ACTION":e.inverseRelation?e.inverseRelation.onUpdate:"CASCADE"})]:[],a.ownIndices=[new qn({entityMetadata:a,columns:c,args:{target:a.target,synchronize:!0}}),new qn({entityMetadata:a,columns:l,args:{target:a.target,synchronize:!0}})],a}collectReferencedColumns(e,t){const n=t.joinColumns?t.joinColumns.find(i=>!!i.referencedColumnName):!1;return!t.joinColumns||t.joinColumns&&!n?e.entityMetadata.columns.filter(i=>i.isPrimary):t.joinColumns.map(i=>{const r=e.entityMetadata.columns.find(a=>a.propertyName===i.referencedColumnName);if(!r)throw new _(`Referenced column ${i.referencedColumnName} was not found in entity ${e.entityMetadata.name}`);return r})}collectInverseReferencedColumns(e,t){const n=!!t.inverseJoinColumns,i=n?t.inverseJoinColumns.find(r=>!!r.referencedColumnName):!1;return!n||n&&!i?e.inverseEntityMetadata.primaryColumns:t.inverseJoinColumns.map(r=>{const a=e.inverseEntityMetadata.ownColumns.find(c=>c.propertyName===r.referencedColumnName);if(!a)throw new _(`Referenced column ${r.referencedColumnName} was not found in entity ${e.inverseEntityMetadata.name}`);return a})}changeDuplicatedColumnNames(e,t){e.forEach(n=>{t.forEach(i=>{if(n.givenDatabaseName===i.givenDatabaseName){const r=this.connection.namingStrategy.joinTableColumnDuplicationPrefix(n.propertyName,1);n.propertyName=r,n.givenDatabaseName=r;const a=this.connection.namingStrategy.joinTableColumnDuplicationPrefix(i.propertyName,2);i.propertyName=a,i.givenDatabaseName=a}})})}}class bx{constructor(e){this.connection=e}build(e){const t=new jn({parentClosureEntityMetadata:e,connection:this.connection,args:{target:"",name:e.treeOptions&&e.treeOptions.closureTableName?e.treeOptions.closureTableName:e.tableNameWithoutPrefix,type:"closure-junction"}});return t.build(),e.primaryColumns.forEach(n=>{t.ownColumns.push(new Nn({connection:this.connection,entityMetadata:t,closureType:"ancestor",referencedColumn:n,args:{target:"",mode:"virtual",propertyName:e.treeOptions&&e.treeOptions.ancestorColumnName?e.treeOptions.ancestorColumnName(n):n.propertyName+"_ancestor",options:{primary:!0,length:n.length,type:n.type,unsigned:n.unsigned,width:n.width,precision:n.precision,scale:n.scale,zerofill:n.zerofill,charset:n.charset,collation:n.collation}}})),t.ownColumns.push(new Nn({connection:this.connection,entityMetadata:t,closureType:"descendant",referencedColumn:n,args:{target:"",mode:"virtual",propertyName:e.treeOptions&&e.treeOptions.descendantColumnName?e.treeOptions.descendantColumnName(n):n.propertyName+"_descendant",options:{primary:!0,length:n.length,type:n.type,unsigned:n.unsigned,width:n.width,precision:n.precision,scale:n.scale,zerofill:n.zerofill,charset:n.charset,collation:n.collation}}}))}),t.ownIndices=[new qn({entityMetadata:t,columns:[t.ownColumns[0]],args:{target:t.target,synchronize:!0}}),new qn({entityMetadata:t,columns:[t.ownColumns[1]],args:{target:t.target,synchronize:!0}})],e.treeLevelColumn&&t.ownColumns.push(new Nn({connection:this.connection,entityMetadata:t,args:{target:"",mode:"virtual",propertyName:"level",options:{type:this.connection.driver.mappedDataTypes.treeLevel}}})),t.foreignKeys=[new Lr({entityMetadata:t,referencedEntityMetadata:e,columns:[t.ownColumns[0]],referencedColumns:e.primaryColumns,onDelete:this.connection.driver.options.type==="mssql"?"NO ACTION":"CASCADE"}),new Lr({entityMetadata:t,referencedEntityMetadata:e,columns:[t.ownColumns[1]],referencedColumns:e.primaryColumns,onDelete:this.connection.driver.options.type==="mssql"?"NO ACTION":"CASCADE"})],t}}class Da{constructor(e){this.columns=[],this.columnNamesWithOrderingMap={},this.entityMetadata=e.entityMetadata,this.embeddedMetadata=e.embeddedMetadata,e.columns&&(this.columns=e.columns),e.args&&(this.target=e.args.target,this.givenName=e.args.name,this.givenColumnNames=e.args.columns,this.deferrable=e.args.deferrable)}build(e){const t={};if(this.givenColumnNames){let n=[];if(Array.isArray(this.givenColumnNames))n=this.givenColumnNames.map(i=>this.embeddedMetadata?this.embeddedMetadata.propertyPath+"."+i:i.trim()),n.forEach(i=>t[i]=1);else{const i=this.givenColumnNames(this.entityMetadata.propertiesMap);Array.isArray(i)?(n=i.map(r=>String(r)),n.forEach(r=>t[r]=1)):(n=Object.keys(i).map(r=>String(r)),Object.keys(i).forEach(r=>t[r]=i[r]))}this.columns=n.map(i=>{const r=this.entityMetadata.columns.find(h=>h.propertyPath===i);if(r)return[r];const a=this.entityMetadata.relations.find(h=>h.isWithJoinColumn&&h.propertyName===i);if(a)return a.joinColumns;const c=this.givenName?'"'+this.givenName+'" ':"",l=this.entityMetadata.targetName;throw new _(`Unique constraint ${c}contains column that is missing in the entity (${l}): `+i)}).reduce((i,r)=>i.concat(r))}return this.columnNamesWithOrderingMap=Object.keys(t).reduce((n,i)=>{const r=this.entityMetadata.columns.find(a=>a.propertyPath===i);return r&&(n[r.databasePath]=t[i]),n},{}),this.name=this.givenName?this.givenName:e.uniqueConstraintName(this.entityMetadata.tableName,this.columns.map(n=>n.databaseName)),this}}class Nx{constructor(e){this.connection=e}build(e,t){var c;const n=this.collectReferencedColumns(e,t),i=this.collectColumns(e,t,n);if(!n.length||!t.createForeignKeyConstraints)return{foreignKey:void 0,columns:i,uniqueConstraint:void 0};const r=new Lr({name:(c=e[0])==null?void 0:c.foreignKeyConstraintName,entityMetadata:t.entityMetadata,referencedEntityMetadata:t.inverseEntityMetadata,namingStrategy:this.connection.namingStrategy,columns:i,referencedColumns:n,onDelete:t.onDelete,onUpdate:t.onUpdate,deferrable:t.deferrable});if(i.every(l=>l.isPrimary)||!t.isOneToOne)return{foreignKey:r,columns:i,uniqueConstraint:void 0};const a=new Da({entityMetadata:t.entityMetadata,columns:r.columns,args:{name:this.connection.namingStrategy.relationConstraintName(t.entityMetadata.tableName,r.columns.map(l=>l.databaseName)),target:t.entityMetadata.target}});return a.build(this.connection.namingStrategy),{foreignKey:r,columns:i,uniqueConstraint:a}}collectReferencedColumns(e,t){const n=e.find(a=>!!a.referencedColumnName),i=e.length===0&&t.isManyToOne,r=e.length>0&&!n;return i||r?t.inverseEntityMetadata.primaryColumns:e.map(a=>{const c=t.inverseEntityMetadata.ownColumns.find(l=>l.propertyName===a.referencedColumnName);if(!c)throw new _(`Referenced column ${a.referencedColumnName} was not found in entity ${t.inverseEntityMetadata.name}`);return c})}collectColumns(e,t,n){return n.map(i=>{const r=e.find(h=>(!h.referencedColumnName||h.referencedColumnName===i.propertyName)&&!!h.name),a=r?r.name:this.connection.namingStrategy.joinColumnName(t.propertyName,i.propertyName);let l=(t.embeddedMetadata?t.embeddedMetadata.columns:t.entityMetadata.ownColumns).find(h=>h.databaseNameWithoutPrefixes===a);return l?l.referencedColumn&&(l=ee.cloneObject(l)):(l=new Nn({connection:this.connection,entityMetadata:t.entityMetadata,embeddedMetadata:t.embeddedMetadata,args:{target:"",mode:"virtual",propertyName:t.propertyName,options:{name:a,type:i.type,length:!i.length&&(te.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&this.connection.driver.normalizeType(i)!=="uuid"&&(i.generationStrategy==="uuid"||i.type==="uuid")?"36":i.length,width:i.width,charset:i.charset,collation:i.collation,precision:i.precision,scale:i.scale,zerofill:i.zerofill,unsigned:i.unsigned,comment:i.comment,enum:i.enum,enumName:i.enumName,primary:t.isPrimary,nullable:t.isNullable}}}),t.entityMetadata.registerColumn(l)),l.referencedColumn=i,l.type=i.type,l.relationMetadata=t,l.build(this.connection),l})}}class Pf{constructor(e){this.entityMetadata=e.entityMetadata,this.embeddedMetadata=e.embeddedMetadata,this.target=e.args.target,this.propertyName=e.args.propertyName,this.type=e.args.type}isAllowed(e){return this.entityMetadata.target===e.constructor||typeof this.entityMetadata.target=="function"&&e.constructor.prototype instanceof this.entityMetadata.target}execute(e){if(!this.embeddedMetadata){const t=e[this.propertyName];if(!t)throw new Error(`Entity listener method "${this.propertyName}" does not exist in entity "${e.constructor.name}".`);if(typeof t!="function")throw new Error(`Entity listener method "${this.propertyName}" in entity "${e.constructor.name}" must be a function but got "${typeof t}".`);return t.call(e)}this.callEntityEmbeddedMethod(e,this.embeddedMetadata.propertyPath.split("."))}callEntityEmbeddedMethod(e,t){const n=t.shift();!n||!e[n]||(t.length===0?Array.isArray(e[n])?e[n].map(i=>i[this.propertyName]()):e[n][this.propertyName]():e[n]&&this.callEntityEmbeddedMethod(e[n],t))}}class Ax{constructor(e){this.entityMetadata=e.entityMetadata,e.args&&(this.target=e.args.target,this.expression=e.args.expression,this.givenName=e.args.name)}build(e){return this.name=this.givenName?this.givenName:e.checkConstraintName(this.entityMetadata.tableName,this.expression),this}}class Cx{constructor(e){this.entityMetadata=e.entityMetadata,e.args&&(this.target=e.args.target,this.expression=e.args.expression,this.givenName=e.args.name)}build(e){return this.name=this.givenName?this.givenName:e.exclusionConstraintName(this.entityMetadata.tableName,this.expression),this}}class Of{constructor(e,t){this.connection=e,this.metadataArgsStorage=t,this.junctionEntityMetadataBuilder=new wx(e),this.closureJunctionEntityMetadataBuilder=new bx(e),this.relationJoinColumnBuilder=new Nx(e)}build(e){const i=(e?this.metadataArgsStorage.filterTables(e):this.metadataArgsStorage.tables).filter(r=>r.type==="regular"||r.type==="closure"||r.type==="entity-child"||r.type==="view").map(r=>this.createEntityMetadata(r));return i.forEach(r=>this.computeParentEntityMetadata(i,r)),i.forEach(r=>{r.childEntityMetadatas=i.filter(a=>typeof r.target=="function"&&typeof a.target=="function"&&_a.isInherited(a.target,r.target))}),i.filter(r=>r.tableType!=="entity-child").forEach(r=>r.build()),i.filter(r=>r.tableType==="entity-child").forEach(r=>r.build()),i.filter(r=>r.tableType!=="entity-child").forEach(r=>this.computeEntityMetadataStep1(i,r)),i.filter(r=>r.tableType==="entity-child").forEach(r=>this.computeEntityMetadataStep1(i,r)),i.forEach(r=>this.computeEntityMetadataStep2(r)),i.forEach(r=>this.computeInverseProperties(r,i)),i.filter(r=>r.tableType!=="entity-child").forEach(r=>{r.relations.filter(a=>a.isOneToOne||a.isManyToOne).forEach(a=>{const c=this.metadataArgsStorage.filterJoinColumns(a.target,a.propertyName),{foreignKey:l,columns:h,uniqueConstraint:f}=this.relationJoinColumnBuilder.build(c,a);if(l&&(a.registerForeignKeys(l),r.foreignKeys.push(l)),h&&a.registerJoinColumns(h),f)if(te.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"||this.connection.driver.options.type==="mssql"||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"){const p=new qn({entityMetadata:f.entityMetadata,columns:f.columns,args:{target:f.target,name:f.name,unique:!0,synchronize:!0}});this.connection.driver.options.type==="mssql"&&(p.where=p.columns.map(m=>`${this.connection.driver.escape(m.databaseName)} IS NOT NULL`).join(" AND ")),this.connection.driver.options.type==="spanner"&&(p.isNullFiltered=!0),a.embeddedMetadata?a.embeddedMetadata.indices.push(p):a.entityMetadata.ownIndices.push(p),this.computeEntityMetadataStep2(r)}else a.embeddedMetadata?a.embeddedMetadata.uniques.push(f):a.entityMetadata.ownUniques.push(f),this.computeEntityMetadataStep2(r);if(l&&this.connection.driver.options.type==="cockroachdb"){const p=new qn({entityMetadata:a.entityMetadata,columns:l.columns,args:{target:a.entityMetadata.target,synchronize:!0}});a.embeddedMetadata?a.embeddedMetadata.indices.push(p):a.entityMetadata.ownIndices.push(p),this.computeEntityMetadataStep2(r)}}),r.relations.filter(a=>a.isManyToMany).forEach(a=>{const c=this.metadataArgsStorage.findJoinTable(a.target,a.propertyName);if(!c)return;const l=this.junctionEntityMetadataBuilder.build(a,c);a.registerForeignKeys(...l.foreignKeys),a.registerJoinColumns(l.ownIndices[0].columns,l.ownIndices[1].columns),a.registerJunctionEntityMetadata(l),this.computeEntityMetadataStep2(l),this.computeInverseProperties(l,i),i.push(l)})}),i.forEach(r=>{r.relationsWithJoinColumns=r.relations.filter(a=>a.isWithJoinColumn),r.hasNonNullableRelations=r.relationsWithJoinColumns.some(a=>!a.isNullable||a.isPrimary)}),i.filter(r=>r.treeType==="closure-table").forEach(r=>{const a=this.closureJunctionEntityMetadataBuilder.build(r);r.closureJunctionTable=a,this.computeEntityMetadataStep2(a),this.computeInverseProperties(a,i),i.push(a)}),i.filter(r=>r.inheritancePattern==="STI"&&r.discriminatorColumn).forEach(r=>this.createKeysForTableInheritance(r)),i.forEach(r=>{r.indices.forEach(a=>a.build(this.connection.namingStrategy))}),i.forEach(r=>{r.uniques.forEach(a=>a.build(this.connection.namingStrategy))}),i.forEach(r=>{r.checks.forEach(a=>a.build(this.connection.namingStrategy))}),i.forEach(r=>{r.exclusions.forEach(a=>a.build(this.connection.namingStrategy))}),i.forEach(r=>this.createForeignKeys(r,i)),i.filter(r=>typeof r.target=="function").forEach(r=>{r.relations.filter(a=>a.isLazy).forEach(a=>{this.connection.relationLoader.enableLazyLoad(a,r.target.prototype)})}),i.forEach(r=>{r.columns.forEach(a=>{const c=this.metadataArgsStorage.findGenerated(a.target,a.propertyName);c&&(a.isGenerated=!0,a.generationStrategy=c.strategy,c.strategy==="uuid"?a.type="uuid":c.strategy==="rowid"?a.type="int":a.type=a.type||Number,a.build(this.connection),this.computeEntityMetadataStep2(r))})}),i}createEntityMetadata(e){const t=typeof e.target=="function"?_a.getInheritanceTree(e.target):[e.target],n=this.metadataArgsStorage.findInheritanceType(e.target),i=this.metadataArgsStorage.findTree(e.target);let r;return(n&&n.pattern==="STI"||e.type==="entity-child")&&(r=this.metadataArgsStorage.filterSingleTableChildren(e.target).map(a=>a.target).filter(a=>typeof a=="function"),t.push(...r)),new jn({connection:this.connection,args:e,inheritanceTree:t,tableTree:i,inheritancePattern:n?n.pattern:void 0})}computeParentEntityMetadata(e,t){t.tableType==="entity-child"&&(t.parentEntityMetadata=e.find(n=>n.inheritanceTree.indexOf(t.target)!==-1&&n.inheritancePattern==="STI"))}computeEntityMetadataStep1(e,t){const n=this.metadataArgsStorage.findInheritanceType(t.target),i=this.metadataArgsStorage.findDiscriminatorValue(t.target);if(typeof i<"u"?t.discriminatorValue=i.value:t.discriminatorValue=t.target.name,t.embeddeds=this.createEmbeddedsRecursively(t,this.metadataArgsStorage.filterEmbeddeds(t.inheritanceTree)).map(a=>(t.inheritancePattern==="STI"&&(a.columns=a.columns.map(c=>(c.isNullable=!0,c))),a)),t.ownColumns=this.metadataArgsStorage.filterColumns(t.inheritanceTree).map(a=>{if(t.tableType==="entity-child")return t.parentEntityMetadata.ownColumns.find(h=>h.propertyName===a.propertyName);if(t.tableType==="regular"&&a.target!==t.target){const h=this.metadataArgsStorage.columns.find(f=>f.propertyName===a.propertyName&&f.target===t.target);h&&h.options.default&&(a.options.default=h.options.default)}const c=new Nn({connection:this.connection,entityMetadata:t,args:a});return e.find(h=>h.tableType==="entity-child"&&h.target===a.target)&&(c.isNullable=!0),c}),n&&n.column){const a=n.column&&n.column.name?n.column.name:"type";let c=t.ownColumns.find(l=>l.propertyName===a);c?c.isDiscriminator=!0:(c=new Nn({connection:this.connection,entityMetadata:t,args:{target:t.target,mode:"virtual",propertyName:a,options:n.column||{name:a,type:"varchar",nullable:!1}}}),c.isVirtual=!0,c.isDiscriminator=!0,t.ownColumns.push(c))}if(t.tableType==="entity-child"){const a=t.parentEntityMetadata.ownColumns.find(c=>c.isDiscriminator);a&&!t.ownColumns.find(c=>c===a)&&t.ownColumns.push(a),t.inheritancePattern=t.parentEntityMetadata.inheritancePattern,!t.treeType&&t.parentEntityMetadata.treeType&&(t.treeType=t.parentEntityMetadata.treeType,t.treeOptions=t.parentEntityMetadata.treeOptions,t.treeParentRelation=t.parentEntityMetadata.treeParentRelation,t.treeLevelColumn=t.parentEntityMetadata.treeLevelColumn)}const{namingStrategy:r}=this.connection;if(t.treeType==="materialized-path")t.ownColumns.push(new Nn({connection:this.connection,entityMetadata:t,materializedPath:!0,args:{target:t.target,mode:"virtual",propertyName:"mpath",options:{name:r.materializedPathColumnName,type:String,nullable:!0,default:""}}}));else if(t.treeType==="nested-set"){const{left:a,right:c}=r.nestedSetColumnNames;t.ownColumns.push(new Nn({connection:this.connection,entityMetadata:t,nestedSetLeft:!0,args:{target:t.target,mode:"virtual",propertyName:a,options:{name:a,type:Number,nullable:!1,default:1}}})),t.ownColumns.push(new Nn({connection:this.connection,entityMetadata:t,nestedSetRight:!0,args:{target:t.target,mode:"virtual",propertyName:c,options:{name:c,type:Number,nullable:!1,default:2}}}))}if(t.ownRelations=this.metadataArgsStorage.filterRelations(t.inheritanceTree).map(a=>{if(t.tableType==="entity-child"){const c=t.parentEntityMetadata.ownRelations.find(h=>h.propertyName===a.propertyName),l=typeof a.type=="function"?a.type():a.type;if(c.type!==l){const h=Object.create(c);return h.type=l,h}return c}return new _f({entityMetadata:t,args:a})}),t.relationIds=this.metadataArgsStorage.filterRelationIds(t.inheritanceTree).map(a=>t.tableType==="entity-child"?t.parentEntityMetadata.relationIds.find(c=>c.propertyName===a.propertyName):new vf({entityMetadata:t,args:a})),t.relationCounts=this.metadataArgsStorage.filterRelationCounts(t.inheritanceTree).map(a=>t.tableType==="entity-child"?t.parentEntityMetadata.relationCounts.find(c=>c.propertyName===a.propertyName):new Mf({entityMetadata:t,args:a})),t.ownListeners=this.metadataArgsStorage.filterListeners(t.inheritanceTree).map(a=>new Pf({entityMetadata:t,args:a})),t.checks=this.metadataArgsStorage.filterChecks(t.inheritanceTree).map(a=>new Ax({entityMetadata:t,args:a})),this.connection.driver.options.type==="postgres"&&(t.exclusions=this.metadataArgsStorage.filterExclusions(t.inheritanceTree).map(a=>new Cx({entityMetadata:t,args:a}))),this.connection.driver.options.type==="cockroachdb"){t.ownIndices=this.metadataArgsStorage.filterIndices(t.inheritanceTree).filter(c=>!c.unique).map(c=>new qn({entityMetadata:t,args:c}));const a=this.metadataArgsStorage.filterIndices(t.inheritanceTree).filter(c=>c.unique).map(c=>new Da({entityMetadata:t,args:{target:c.target,name:c.name,columns:c.columns}}));t.ownUniques.push(...a)}else t.ownIndices=this.metadataArgsStorage.filterIndices(t.inheritanceTree).map(a=>new qn({entityMetadata:t,args:a}));if(te.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"){const a=this.metadataArgsStorage.filterUniques(t.inheritanceTree).map(c=>new qn({entityMetadata:t,args:{target:c.target,name:c.name,columns:c.columns,unique:!0,synchronize:!0}}));t.ownIndices.push(...a)}else{const a=this.metadataArgsStorage.filterUniques(t.inheritanceTree).map(c=>new Da({entityMetadata:t,args:c}));t.ownUniques.push(...a)}}createEmbeddedsRecursively(e,t){return t.map(n=>{const i=new Tx({entityMetadata:e,args:n}),r=typeof i.type=="function"?_a.getInheritanceTree(i.type):[i.type];return i.columns=this.metadataArgsStorage.filterColumns(r).map(a=>new Nn({connection:this.connection,entityMetadata:e,embeddedMetadata:i,args:a})),i.relations=this.metadataArgsStorage.filterRelations(r).map(a=>new _f({entityMetadata:e,embeddedMetadata:i,args:a})),i.listeners=this.metadataArgsStorage.filterListeners(r).map(a=>new Pf({entityMetadata:e,embeddedMetadata:i,args:a})),i.indices=this.metadataArgsStorage.filterIndices(r).map(a=>new qn({entityMetadata:e,embeddedMetadata:i,args:a})),i.uniques=this.metadataArgsStorage.filterUniques(r).map(a=>new Da({entityMetadata:e,embeddedMetadata:i,args:a})),i.relationIds=this.metadataArgsStorage.filterRelationIds(r).map(a=>new vf({entityMetadata:e,args:a})),i.relationCounts=this.metadataArgsStorage.filterRelationCounts(r).map(a=>new Mf({entityMetadata:e,args:a})),i.embeddeds=this.createEmbeddedsRecursively(e,this.metadataArgsStorage.filterEmbeddeds(r)),i.embeddeds.forEach(a=>a.parentEmbeddedMetadata=i),e.allEmbeddeds.push(i),i})}computeEntityMetadataStep2(e){e.embeddeds.forEach(t=>t.build(this.connection)),e.embeddeds.forEach(t=>{t.columnsFromTree.forEach(n=>n.build(this.connection)),t.relationsFromTree.forEach(n=>n.build())}),e.ownColumns.forEach(t=>t.build(this.connection)),e.ownRelations.forEach(t=>t.build()),e.relations=e.embeddeds.reduce((t,n)=>t.concat(n.relationsFromTree),e.ownRelations),e.eagerRelations=e.relations.filter(t=>t.isEager),e.lazyRelations=e.relations.filter(t=>t.isLazy),e.oneToOneRelations=e.relations.filter(t=>t.isOneToOne),e.oneToManyRelations=e.relations.filter(t=>t.isOneToMany),e.manyToOneRelations=e.relations.filter(t=>t.isManyToOne),e.manyToManyRelations=e.relations.filter(t=>t.isManyToMany),e.ownerOneToOneRelations=e.relations.filter(t=>t.isOneToOneOwner),e.ownerManyToManyRelations=e.relations.filter(t=>t.isManyToManyOwner),e.treeParentRelation=e.relations.find(t=>t.isTreeParent),e.treeChildrenRelation=e.relations.find(t=>t.isTreeChildren),e.columns=e.embeddeds.reduce((t,n)=>t.concat(n.columnsFromTree),e.ownColumns),e.listeners=e.embeddeds.reduce((t,n)=>t.concat(n.listenersFromTree),e.ownListeners),e.afterLoadListeners=e.listeners.filter(t=>t.type===wt.AFTER_LOAD),e.afterInsertListeners=e.listeners.filter(t=>t.type===wt.AFTER_INSERT),e.afterUpdateListeners=e.listeners.filter(t=>t.type===wt.AFTER_UPDATE),e.afterRemoveListeners=e.listeners.filter(t=>t.type===wt.AFTER_REMOVE),e.afterSoftRemoveListeners=e.listeners.filter(t=>t.type===wt.AFTER_SOFT_REMOVE),e.afterRecoverListeners=e.listeners.filter(t=>t.type===wt.AFTER_RECOVER),e.beforeInsertListeners=e.listeners.filter(t=>t.type===wt.BEFORE_INSERT),e.beforeUpdateListeners=e.listeners.filter(t=>t.type===wt.BEFORE_UPDATE),e.beforeRemoveListeners=e.listeners.filter(t=>t.type===wt.BEFORE_REMOVE),e.beforeSoftRemoveListeners=e.listeners.filter(t=>t.type===wt.BEFORE_SOFT_REMOVE),e.beforeRecoverListeners=e.listeners.filter(t=>t.type===wt.BEFORE_RECOVER),e.indices=e.embeddeds.reduce((t,n)=>t.concat(n.indicesFromTree),e.ownIndices),e.uniques=e.embeddeds.reduce((t,n)=>t.concat(n.uniquesFromTree),e.ownUniques),e.primaryColumns=e.columns.filter(t=>t.isPrimary),e.nonVirtualColumns=e.columns.filter(t=>!t.isVirtual),e.ancestorColumns=e.columns.filter(t=>t.closureType==="ancestor"),e.descendantColumns=e.columns.filter(t=>t.closureType==="descendant"),e.hasMultiplePrimaryKeys=e.primaryColumns.length>1,e.generatedColumns=e.columns.filter(t=>t.isGenerated||t.isObjectId),e.hasUUIDGeneratedColumns=e.columns.filter(t=>t.isGenerated||t.generationStrategy==="uuid").length>0,e.createDateColumn=e.columns.find(t=>t.isCreateDate),e.updateDateColumn=e.columns.find(t=>t.isUpdateDate),e.deleteDateColumn=e.columns.find(t=>t.isDeleteDate),e.versionColumn=e.columns.find(t=>t.isVersion),e.discriminatorColumn=e.columns.find(t=>t.isDiscriminator),e.treeLevelColumn=e.columns.find(t=>t.isTreeLevel),e.nestedSetLeftColumn=e.columns.find(t=>t.isNestedSetLeft),e.nestedSetRightColumn=e.columns.find(t=>t.isNestedSetRight),e.materializedPathColumn=e.columns.find(t=>t.isMaterializedPath),e.objectIdColumn=e.columns.find(t=>t.isObjectId),e.foreignKeys.forEach(t=>t.build(this.connection.namingStrategy)),e.propertiesMap=e.createPropertiesMap(),e.relationIds.forEach(t=>t.build()),e.relationCounts.forEach(t=>t.build()),e.embeddeds.forEach(t=>{t.relationIdsFromTree.forEach(n=>n.build()),t.relationCountsFromTree.forEach(n=>n.build())})}computeInverseProperties(e,t){e.relations.forEach(n=>{const i=t.find(r=>r.target===n.type||typeof n.type=="string"&&(r.targetName===n.type||r.givenTableName===n.type));if(!i)throw new _("Entity metadata for "+e.name+"#"+n.propertyPath+" was not found. Check if you specified a correct entity object and if it's connected in the connection options.");n.inverseEntityMetadata=i,n.inverseSidePropertyPath=n.buildInverseSidePropertyPath(),n.inverseRelation=i.relations.find(r=>r.propertyPath===n.inverseSidePropertyPath)})}createKeysForTableInheritance(e){e.indices.some(({givenColumnNames:n})=>{var i;return!!n&&Array.isArray(n)&&n.length===1&&n[0]===((i=e.discriminatorColumn)==null?void 0:i.databaseName)})||e.indices.push(new qn({entityMetadata:e,columns:[e.discriminatorColumn],args:{target:e.target,unique:!1}}))}createForeignKeys(e,t){this.metadataArgsStorage.filterForeignKeys(e.inheritanceTree).forEach(n=>{const i=typeof n.type=="function"?n.type():n.type,r=t.find(p=>typeof i=="string"?p.targetName===i||p.givenTableName===i:$.isEntitySchema(i)?p.target===i.options.name||p.target===i.options.target:p.target===i);if(!r)throw new _("Entity metadata for "+e.name+(n.propertyName?"#"+n.propertyName:"")+" was not found. Check if you specified a correct entity object and if it's connected in the connection options.");const a=n.columnNames??[],c=n.referencedColumnNames??[],l=[],h=[];n.propertyName&&(a.push(n.propertyName),n.inverseSide&&(typeof n.inverseSide=="function"?c.push(n.inverseSide(r.propertiesMap)):c.push(n.inverseSide))),c.length||h.push(...r.primaryColumns);const f=(p,m)=>{const T=m.columns.find(P=>P.propertyName===p||P.databaseName===p);if(T)return T;const A=n.name?'"'+n.name+'" ':"",S=m.targetName;throw new _(`Foreign key constraint ${A}contains column that is missing in the entity (${S}): ${p}`)};l.push(...a.map(p=>f(p,e))),h.push(...c.map(p=>f(p,r))),e.foreignKeys.push(new Lr({entityMetadata:e,referencedEntityMetadata:r,namingStrategy:this.connection.namingStrategy,columns:l,referencedColumns:h,...n}))})}}class ja extends _{static createEntitySchemaIsRequiredException(e){return new ja(`EntitySchema is required for ${e} embedded field`)}static createTargetIsRequired(e){return new ja(`Target field is required for ${e} embedded EntitySchema`)}constructor(e){super(e)}}class Sx{transform(e){const t=new hp;return e.forEach(n=>{const i=n.options,r={target:i.target||i.name,name:i.tableName,database:i.database,schema:i.schema,type:i.type||"regular",orderBy:i.orderBy,synchronize:i.synchronize,withoutRowid:!!i.withoutRowid,expression:i.expression};t.tables.push(r);const{inheritance:a}=i;a&&t.inheritances.push({target:i.target,pattern:a.pattern??"STI",column:a.column?typeof a.column=="string"?{name:a.column}:a.column:void 0});const{discriminatorValue:c}=i;c&&t.discriminatorValues.push({target:i.target||i.name,value:c}),this.transformColumnsRecursive(i,t)}),t}transformColumnsRecursive(e,t){Object.keys(e.columns).forEach(n=>{const r=e.columns[n];let a="regular";r.createDate&&(a="createDate"),r.updateDate&&(a="updateDate"),r.deleteDate&&(a="deleteDate"),r.version&&(a="version"),r.treeChildrenCount&&(a="treeChildrenCount"),r.treeLevel&&(a="treeLevel"),r.objectId&&(a="objectId"),r.virtualProperty&&(a="virtual-property");const c={target:e.target||e.name,mode:a,propertyName:n,options:{type:r.type,name:r.objectId?"_id":r.name,primaryKeyConstraintName:r.primaryKeyConstraintName,length:r.length,width:r.width,nullable:r.nullable,readonly:r.readonly,update:r.update,select:r.select,insert:r.insert,primary:r.primary,unique:r.unique,comment:r.comment,default:r.default,onUpdate:r.onUpdate,precision:r.precision,scale:r.scale,zerofill:r.zerofill,unsigned:r.unsigned,charset:r.charset,collation:r.collation,enum:r.enum,enumName:r.enumName,asExpression:r.asExpression,generatedType:r.generatedType,hstoreType:r.hstoreType,array:r.array,transformer:r.transformer,spatialFeatureType:r.spatialFeatureType,srid:r.srid,query:r.query}};if(t.columns.push(c),r.generated){const l={target:e.target||e.name,propertyName:n,strategy:typeof r.generated=="string"?r.generated:"increment"};t.generations.push(l)}if(r.unique&&t.uniques.push({target:e.target||e.name,columns:[n]}),r.foreignKey){const l=r.foreignKey,h={target:e.target||e.name,type:l.target,propertyName:n,inverseSide:l.inverseSide,name:l.name,onDelete:l.onDelete,onUpdate:l.onUpdate,deferrable:l.deferrable};t.foreignKeys.push(h)}}),e.relations&&Object.keys(e.relations).forEach(n=>{const i=e.relations[n],r={target:e.target||e.name,propertyName:n,relationType:i.type,isLazy:i.lazy||!1,type:i.target,inverseSideProperty:i.inverseSide,isTreeParent:i.treeParent,isTreeChildren:i.treeChildren,options:{eager:i.eager||!1,cascade:i.cascade,nullable:i.nullable,onDelete:i.onDelete,onUpdate:i.onUpdate,deferrable:i.deferrable,createForeignKeyConstraints:i.createForeignKeyConstraints,persistence:i.persistence,orphanedRowAction:i.orphanedRowAction}};if(t.relations.push(r),i.joinColumn)if(typeof i.joinColumn=="boolean"){const a={target:e.target||e.name,propertyName:n};t.joinColumns.push(a)}else{const a=Array.isArray(i.joinColumn)?i.joinColumn:[i.joinColumn];for(const c of a){const l={target:e.target||e.name,propertyName:n,name:c.name,referencedColumnName:c.referencedColumnName,foreignKeyConstraintName:c.foreignKeyConstraintName};t.joinColumns.push(l)}}if(i.joinTable)if(typeof i.joinTable=="boolean"){const a={target:e.target||e.name,propertyName:n};t.joinTables.push(a)}else{const a={target:e.target||e.name,propertyName:n,name:i.joinTable.name,database:i.joinTable.database,schema:i.joinTable.schema,joinColumns:i.joinTable.joinColumn?[i.joinTable.joinColumn]:i.joinTable.joinColumns,inverseJoinColumns:i.joinTable.inverseJoinColumn?[i.joinTable.inverseJoinColumn]:i.joinTable.inverseJoinColumns};t.joinTables.push(a)}}),e.relationIds&&Object.keys(e.relationIds).forEach(n=>{const i=e.relationIds[n],r={propertyName:n,relation:i.relationName,target:e.target||e.name,alias:i.alias,queryBuilderFactory:i.queryBuilderFactory};t.relationIds.push(r)}),e.indices&&e.indices.forEach(n=>{const i={target:e.target||e.name,name:n.name,unique:n.unique===!0,spatial:n.spatial===!0,fulltext:n.fulltext===!0,nullFiltered:n.nullFiltered===!0,parser:n.parser,synchronize:n.synchronize!==!1,where:n.where,sparse:n.sparse,columns:n.columns};t.indices.push(i)}),e.foreignKeys&&e.foreignKeys.forEach(n=>{const i={target:e.target||e.name,type:n.target,columnNames:n.columnNames,referencedColumnNames:n.referencedColumnNames,name:n.name,onDelete:n.onDelete,onUpdate:n.onUpdate,deferrable:n.deferrable};t.foreignKeys.push(i)}),e.uniques&&e.uniques.forEach(n=>{const i={target:e.target||e.name,name:n.name,columns:n.columns,deferrable:n.deferrable};t.uniques.push(i)}),e.checks&&e.checks.forEach(n=>{const i={target:e.target||e.name,name:n.name,expression:n.expression};t.checks.push(i)}),e.exclusions&&e.exclusions.forEach(n=>{const i={target:e.target||e.name,name:n.name,expression:n.expression};t.exclusions.push(i)}),e.embeddeds&&Object.keys(e.embeddeds).forEach(n=>{const i=e.embeddeds[n];if(!i.schema)throw ja.createEntitySchemaIsRequiredException(n);const r=i.schema.options;t.embeddeds.push({target:e.target||e.name,propertyName:n,isArray:i.array===!0,prefix:i.prefix!==void 0?i.prefix:void 0,type:()=>(r==null?void 0:r.target)||r.name}),this.transformColumnsRecursive(r,t)})}}class Rx{constructor(e){this.connection=e}async buildMigrations(e){const[t]=ee.splitClassesAndStrings(e);return[...t,...await Jc(this.connection.logger)].map(i=>Au(i))}async buildSubscribers(e){const[t]=ee.splitClassesAndStrings(e||[]),n=[...t,...await Jc(this.connection.logger)];return Va().filterSubscribers(n).map(i=>Au(i.target))}async buildEntityMetadatas(e){const[t]=ee.splitClassesAndStrings(e||[]),n=t.filter(h=>!$.isEntitySchema(h)),i=t.filter(h=>$.isEntitySchema(h)),r=[...n,...await Jc(this.connection.logger)];r.forEach(h=>{$.isEntitySchema(h)&&i.push(h)});const a=new Of(this.connection,Va()).build(r),c=new Sx().transform(i),l=new Of(this.connection,c).build();return[...a,...l]}}class lo{constructor(e){this.options=e}logQuery(e,t,n){this.isLogEnabledFor("query")&&this.writeLog("query",{type:"query",prefix:"query",message:e,format:"sql",parameters:t},n)}logQueryError(e,t,n,i){this.isLogEnabledFor("query-error")&&this.writeLog("warn",[{type:"query-error",prefix:"query failed",message:t,format:"sql",parameters:n},{type:"query-error",prefix:"error",message:e}],i)}logQuerySlow(e,t,n,i){this.isLogEnabledFor("query-slow")&&this.writeLog("warn",[{type:"query-slow",prefix:"query is slow",message:t,format:"sql",parameters:n,additionalInfo:{time:e}},{type:"query-slow",prefix:"execution time",message:e}],i)}logSchemaBuild(e,t){this.isLogEnabledFor("schema-build")&&this.writeLog("schema",{type:"schema-build",message:e},t)}logMigration(e,t){this.isLogEnabledFor("migration")&&this.writeLog("log",{type:"migration",message:e},t)}log(e,t,n){switch(e){case"log":if(!this.isLogEnabledFor("log"))return;this.writeLog("log",{type:"log",message:t},n);break;case"info":if(!this.isLogEnabledFor("info"))return;this.writeLog("info",{type:"info",prefix:"info",message:t},n);break;case"warn":if(!this.isLogEnabledFor("warn"))return;this.writeLog("warn",{type:"warn",message:t},n);break}}isLogEnabledFor(e){switch(e){case"query":return this.options==="all"||this.options===!0||Array.isArray(this.options)&&this.options.indexOf("query")!==-1;case"error":case"query-error":return this.options==="all"||this.options===!0||Array.isArray(this.options)&&this.options.indexOf("error")!==-1;case"query-slow":return!0;case"schema":case"schema-build":return this.options==="all"||Array.isArray(this.options)&&this.options.indexOf("schema")!==-1;case"migration":return!0;case"log":return this.options==="all"||Array.isArray(this.options)&&this.options.indexOf("log")!==-1;case"info":return this.options==="all"||Array.isArray(this.options)&&this.options.indexOf("info")!==-1;case"warn":return this.options==="all"||Array.isArray(this.options)&&this.options.indexOf("warn")!==-1;default:return!1}}prepareLogMessages(e,t,n){var r;t={addColonToPrefix:!0,appendParameterAsComment:!0,highlightSql:!0,formatSql:!1,...t};const i=Array.isArray(e)?e:[e];for(let a of i){if(typeof a!="object"&&(a={message:a}),a.format==="sql"){let c=String(a.message);t.formatSql&&(c=Ye.formatSql(c,(r=n==null?void 0:n.connection)==null?void 0:r.options.type)),t.appendParameterAsComment&&a.parameters&&a.parameters.length&&(c+=` -- PARAMETERS: ${this.stringifyParams(a.parameters)}`),t.highlightSql&&(c=Ye.highlightSql(c)),a.message=c}t.addColonToPrefix&&a.prefix&&(a.prefix+=":")}return i}stringifyParams(e){try{return JSON.stringify(e)}catch{return e}}}class xx extends lo{writeLog(e,t,n){const i=this.prepareLogMessages(t,{highlightSql:!1});for(const r of i)switch(r.type??e){case"log":case"schema-build":case"migration":console.log(r.message);break;case"info":case"query":r.prefix?console.info(r.prefix,r.message):console.info(r.message);break;case"warn":case"query-slow":r.prefix?console.warn(r.prefix,r.message):console.warn(r.message);break;case"error":case"query-error":r.prefix?console.error(r.prefix,r.message):console.error(r.message);break}}}class Df extends lo{writeLog(e,t,n){const i=this.prepareLogMessages(t);for(const r of i)switch(r.type??e){case"log":case"schema-build":case"migration":Ye.log(String(r.message));break;case"info":case"query":r.prefix?Ye.logInfo(r.prefix,r.message):Ye.log(String(r.message));break;case"warn":case"query-slow":r.prefix?Ye.logWarn(r.prefix,r.message):console.warn(Ye.warn(String(r.message)));break;case"error":case"query-error":r.prefix?Ye.logError(r.prefix,String(r.message)):console.error(Ye.error(String(r.message)));break}}}class _x{logQuery(){throw new Error("This logger is not applicable in a browser context")}logQueryError(){throw new Error("This logger is not applicable in a browser context")}logQuerySlow(){throw new Error("This logger is not applicable in a browser context")}logSchemaBuild(){throw new Error("This logger is not applicable in a browser context")}logMigration(){throw new Error("This logger is not applicable in a browser context")}log(){throw new Error("This logger is not applicable in a browser context")}}class vx extends _x{}var Cu={exports:{}},Xc,If;function Mx(){if(If)return Xc;If=1;var s=1e3,e=s*60,t=e*60,n=t*24,i=n*7,r=n*365.25;Xc=function(f,p){p=p||{};var m=typeof f;if(m==="string"&&f.length>0)return a(f);if(m==="number"&&isFinite(f))return p.long?l(f):c(f);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(f))};function a(f){if(f=String(f),!(f.length>100)){var p=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(f);if(p){var m=parseFloat(p[1]),T=(p[2]||"ms").toLowerCase();switch(T){case"years":case"year":case"yrs":case"yr":case"y":return m*r;case"weeks":case"week":case"w":return m*i;case"days":case"day":case"d":return m*n;case"hours":case"hour":case"hrs":case"hr":case"h":return m*t;case"minutes":case"minute":case"mins":case"min":case"m":return m*e;case"seconds":case"second":case"secs":case"sec":case"s":return m*s;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return m;default:return}}}}function c(f){var p=Math.abs(f);return p>=n?Math.round(f/n)+"d":p>=t?Math.round(f/t)+"h":p>=e?Math.round(f/e)+"m":p>=s?Math.round(f/s)+"s":f+"ms"}function l(f){var p=Math.abs(f);return p>=n?h(f,p,n,"day"):p>=t?h(f,p,t,"hour"):p>=e?h(f,p,e,"minute"):p>=s?h(f,p,s,"second"):f+" ms"}function h(f,p,m,T){var A=p>=m*1.5;return Math.round(f/m)+" "+T+(A?"s":"")}return Xc}function Px(s){t.debug=t,t.default=t,t.coerce=l,t.disable=a,t.enable=i,t.enabled=c,t.humanize=Mx(),t.destroy=h,Object.keys(s).forEach(f=>{t[f]=s[f]}),t.names=[],t.skips=[],t.formatters={};function e(f){let p=0;for(let m=0;m<f.length;m++)p=(p<<5)-p+f.charCodeAt(m),p|=0;return t.colors[Math.abs(p)%t.colors.length]}t.selectColor=e;function t(f){let p,m=null,T,A;function S(...P){if(!S.enabled)return;const F=S,B=Number(new Date),q=B-(p||B);F.diff=q,F.prev=p,F.curr=B,p=B,P[0]=t.coerce(P[0]),typeof P[0]!="string"&&P.unshift("%O");let Z=0;P[0]=P[0].replace(/%([a-zA-Z%])/g,(Ee,Se)=>{if(Ee==="%%")return"%";Z++;const me=t.formatters[Se];if(typeof me=="function"){const W=P[Z];Ee=me.call(F,W),P.splice(Z,1),Z--}return Ee}),t.formatArgs.call(F,P),(F.log||t.log).apply(F,P)}return S.namespace=f,S.useColors=t.useColors(),S.color=t.selectColor(f),S.extend=n,S.destroy=t.destroy,Object.defineProperty(S,"enabled",{enumerable:!0,configurable:!1,get:()=>m!==null?m:(T!==t.namespaces&&(T=t.namespaces,A=t.enabled(f)),A),set:P=>{m=P}}),typeof t.init=="function"&&t.init(S),S}function n(f,p){const m=t(this.namespace+(typeof p>"u"?":":p)+f);return m.log=this.log,m}function i(f){t.save(f),t.namespaces=f,t.names=[],t.skips=[];const p=(typeof f=="string"?f:"").trim().replace(/\s+/g,",").split(",").filter(Boolean);for(const m of p)m[0]==="-"?t.skips.push(m.slice(1)):t.names.push(m)}function r(f,p){let m=0,T=0,A=-1,S=0;for(;m<f.length;)if(T<p.length&&(p[T]===f[m]||p[T]==="*"))p[T]==="*"?(A=T,S=m,T++):(m++,T++);else if(A!==-1)T=A+1,S++,m=S;else return!1;for(;T<p.length&&p[T]==="*";)T++;return T===p.length}function a(){const f=[...t.names,...t.skips.map(p=>"-"+p)].join(",");return t.enable(""),f}function c(f){for(const p of t.skips)if(r(f,p))return!1;for(const p of t.names)if(r(f,p))return!0;return!1}function l(f){return f instanceof Error?f.stack||f.message:f}function h(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.enable(t.load()),t}var Ox=Px;(function(s,e){var t={};e.formatArgs=i,e.save=r,e.load=a,e.useColors=n,e.storage=c(),e.destroy=(()=>{let h=!1;return()=>{h||(h=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),e.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function n(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let h;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(h=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(h[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function i(h){if(h[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+h[0]+(this.useColors?"%c ":" ")+"+"+s.exports.humanize(this.diff),!this.useColors)return;const f="color: "+this.color;h.splice(1,0,f,"color: inherit");let p=0,m=0;h[0].replace(/%[a-zA-Z%]/g,T=>{T!=="%%"&&(p++,T==="%c"&&(m=p))}),h.splice(m,0,f)}e.log=console.debug||console.log||(()=>{});function r(h){try{h?e.storage.setItem("debug",h):e.storage.removeItem("debug")}catch{}}function a(){let h;try{h=e.storage.getItem("debug")||e.storage.getItem("DEBUG")}catch{}return!h&&typeof process<"u"&&"env"in process&&(h=t.DEBUG),h}function c(){try{return localStorage}catch{}}s.exports=Ox(e);const{formatters:l}=s.exports;l.j=function(h){try{return JSON.stringify(h)}catch(f){return"[UnexpectedJSONParseError]: "+f.message}}})(Cu,Cu.exports);var gi=Cu.exports;class Dx extends lo{constructor(){super(...arguments),this.logger={log:gi.debug("typeorm:log"),info:gi.debug("typeorm:info"),warn:gi.debug("typeorm:warn"),error:gi.debug("typeorm:error"),query:gi.debug("typeorm:query:log"),"query-error":gi.debug("typeorm:query:error"),"query-slow":gi.debug("typeorm:query:slow"),"schema-build":gi.debug("typeorm:schema"),migration:gi.debug("typeorm:migration")}}isLogEnabledFor(e){switch(e){case"query":return this.logger.query.enabled;case"query-error":return this.logger["query-error"].enabled;case"query-slow":return!0;case"schema":case"schema-build":return this.logger["schema-build"].enabled;case"migration":return this.logger.migration.enabled;case"log":return this.logger.log.enabled;case"info":return this.logger.info.enabled;case"warn":return this.logger.warn.enabled;default:return!1}}writeLog(e,t,n){const i=this.prepareLogMessages(t,{appendParameterAsComment:!1});for(const r of i){const a=r.type??e;a in this.logger&&(r.prefix?this.logger[a](r.prefix,r.message):this.logger[a](r.message),r.parameters&&r.parameters.length&&this.logger[a]("parameters:",r.parameters))}}}class Ix extends lo{writeLog(e,t,n){const i=this.prepareLogMessages(t,{highlightSql:!0,formatSql:!0},n);for(const r of i)switch(r.type??e){case"log":case"schema-build":case"migration":Ye.log(String(r.message));break;case"info":case"query":r.prefix?Ye.logInfo(r.prefix,r.message):Ye.log(String(r.message));break;case"warn":case"query-slow":r.prefix?Ye.logWarn(r.prefix,r.message):console.warn(Ye.warn(String(r.message)));break;case"error":case"query-error":r.prefix?Ye.logError(r.prefix,String(r.message)):console.error(Ye.error(String(r.message)));break}}}class $f{create(e,t){if(Ce.isObject(e))return e;if(e)switch(e){case"simple-console":return new xx(t);case"file":return new vx(t);case"advanced-console":return new Df(t);case"formatted-console":return new Ix(t);case"debug":return new Dx}return new Df(t)}}class $x{constructor(e,t){this.connection=e,this.clientType=t,this.redis=this.loadRedis()}async connect(){const e=this.connection.options.cache;if(this.clientType==="redis"){const t={...e==null?void 0:e.options};let n=this.redis.createClient(t);typeof n.connect=="function"&&(t.legacyMode=!0,n=this.redis.createClient(t)),this.client=n,typeof this.connection.options.cache=="object"&&this.connection.options.cache.ignoreErrors&&this.client.on("error",r=>{this.connection.logger.log("warn",r)}),typeof this.client.connect=="function"&&await this.client.connect(),this.detectRedisVersion()}else if(this.clientType==="ioredis")e&&e.port?e.options?this.client=new this.redis(e.port,e.options):this.client=new this.redis(e.port):e&&e.options?this.client=new this.redis(e.options):this.client=new this.redis;else if(this.clientType==="ioredis/cluster")if(e&&e.options&&Array.isArray(e.options))this.client=new this.redis.Cluster(e.options);else if(e&&e.options&&e.options.startupNodes)this.client=new this.redis.Cluster(e.options.startupNodes,e.options.options);else throw new _(`options.startupNodes required for ${this.clientType}.`)}async disconnect(){if(this.isRedis5OrHigher()){await this.client.quit(),this.client=void 0;return}return new Promise((e,t)=>{this.client.quit((n,i)=>{if(n)return t(n);e(),this.client=void 0})})}async synchronize(e){}getFromCache(e,t){const n=e.identifier||e.query;return n?this.isRedis5OrHigher()?this.client.get(n).then(i=>i?JSON.parse(i):void 0):new Promise((i,r)=>{this.client.get(n,(a,c)=>{if(a)return r(a);i(c?JSON.parse(c):void 0)})}):Promise.resolve(void 0)}isExpired(e){return e.time+e.duration<Date.now()}async storeInCache(e,t,n){const i=e.identifier||e.query;if(!i)return;const r=JSON.stringify(e),a=e.duration;if(this.isRedis5OrHigher()){await this.client.set(i,r,{PX:a});return}return new Promise((c,l)=>{this.client.set(i,r,"PX",a,(h,f)=>{if(h)return l(h);c()})})}async clear(e){if(this.isRedis5OrHigher()){await this.client.flushDb();return}return new Promise((t,n)=>{this.client.flushdb((i,r)=>{if(i)return n(i);t()})})}async remove(e,t){await Promise.all(e.map(n=>this.deleteKey(n)))}async deleteKey(e){if(this.isRedis5OrHigher()){await this.client.del(e);return}return new Promise((t,n)=>{this.client.del(e,(i,r)=>{if(i)return n(i);t()})})}loadRedis(){try{return this.clientType==="ioredis/cluster"?Ye.load("ioredis"):Ye.load(this.clientType)}catch{throw new _(`Cannot use cache because ${this.clientType} is not installed. Please run "npm i ${this.clientType}".`)}}detectRedisVersion(){if(this.clientType==="redis")try{const e=this.client.set;e&&e.length<=3?this.redisMajorVersion=5:this.redisMajorVersion=3}catch{this.redisMajorVersion=3}}isRedis5OrHigher(){return this.clientType!=="redis"?!1:this.redisMajorVersion!==void 0&&this.redisMajorVersion>=5}}class Lx{constructor(e){this.connection=e;const{schema:t}=this.connection.driver.options,n=this.connection.driver.database,r=(typeof this.connection.options.cache=="object"?this.connection.options.cache:{}).tableName||"query-result-cache";this.queryResultCacheDatabase=n,this.queryResultCacheSchema=t,this.queryResultCacheTable=this.connection.driver.buildTableName(r,t,n)}async connect(){}async disconnect(){}async synchronize(e){e=this.getQueryRunner(e);const t=this.connection.driver;await e.hasTable(this.queryResultCacheTable)||await e.createTable(new pt({database:this.queryResultCacheDatabase,schema:this.queryResultCacheSchema,name:this.queryResultCacheTable,columns:[{name:"id",isPrimary:!0,isNullable:!1,type:t.normalizeType({type:t.mappedDataTypes.cacheId}),generationStrategy:t.options.type==="spanner"?"uuid":"increment",isGenerated:!0},{name:"identifier",type:t.normalizeType({type:t.mappedDataTypes.cacheIdentifier}),isNullable:!0},{name:"time",type:t.normalizeType({type:t.mappedDataTypes.cacheTime}),isPrimary:!1,isNullable:!1},{name:"duration",type:t.normalizeType({type:t.mappedDataTypes.cacheDuration}),isPrimary:!1,isNullable:!1},{name:"query",type:t.normalizeType({type:t.mappedDataTypes.cacheQuery}),isPrimary:!1,isNullable:!1},{name:"result",type:t.normalizeType({type:t.mappedDataTypes.cacheResult}),isNullable:!1}]}))}getFromCache(e,t){t=this.getQueryRunner(t);const n=this.connection.createQueryBuilder(t).select().from(this.queryResultCacheTable,"cache");return e.identifier?n.where(`${n.escape("cache")}.${n.escape("identifier")} = :identifier`).setParameters({identifier:this.connection.driver.options.type==="mssql"?new Ln(e.identifier,"nvarchar"):e.identifier}).cache(!1).getRawOne():e.query?this.connection.driver.options.type==="oracle"?n.where(`dbms_lob.compare(${n.escape("cache")}.${n.escape("query")}, :query) = 0`,{query:e.query}).cache(!1).getRawOne():n.where(`${n.escape("cache")}.${n.escape("query")} = :query`).setParameters({query:this.connection.driver.options.type==="mssql"?new Ln(e.query,"nvarchar"):e.query}).cache(!1).getRawOne():Promise.resolve(void 0)}isExpired(e){const t=typeof e.duration=="string"?parseInt(e.duration):e.duration;return(typeof e.time=="string"?parseInt(e.time):e.time)+t<Date.now()}async storeInCache(e,t,n){const i=n===void 0||(n==null?void 0:n.getReplicationMode())==="slave";(n===void 0||i)&&(n=this.connection.createQueryRunner("master"));let r=e;if(this.connection.driver.options.type==="mssql"&&(r={identifier:new Ln(e.identifier,"nvarchar"),time:new Ln(e.time,"bigint"),duration:new Ln(e.duration,"int"),query:new Ln(e.query,"nvarchar"),result:new Ln(e.result,"nvarchar")}),t&&t.identifier){const a=n.manager.createQueryBuilder().update(this.queryResultCacheTable).set(r);a.where(`${a.escape("identifier")} = :condition`,{condition:r.identifier}),await a.execute()}else if(t&&t.query){const a=n.manager.createQueryBuilder().update(this.queryResultCacheTable).set(r);this.connection.driver.options.type==="oracle"?a.where('dbms_lob.compare("query", :condition) = 0',{condition:r.query}):a.where(`${a.escape("query")} = :condition`,{condition:r.query}),await a.execute()}else this.connection.driver.options.type==="spanner"&&!r.id&&(r.id=Ip()),await n.manager.createQueryBuilder().insert().into(this.queryResultCacheTable).values(r).execute();i&&await n.release()}async clear(e){return this.getQueryRunner(e).clearTable(this.queryResultCacheTable)}async remove(e,t){const n=t||this.getQueryRunner();await Promise.all(e.map(i=>{const r=n.manager.createQueryBuilder();return r.delete().from(this.queryResultCacheTable).where(`${r.escape("identifier")} = :identifier`,{identifier:i}).execute()})),t||await n.release()}getQueryRunner(e){return e||this.connection.createQueryRunner()}}class Lf{constructor(e){this.connection=e}create(){if(!this.connection.options.cache)throw new _("To use cache you need to enable it in connection options by setting cache: true or providing some caching options. Example: { host: ..., username: ..., cache: true }");const e=this.connection.options.cache;return e.provider&&typeof e.provider=="function"?e.provider(this.connection):e.type==="redis"||e.type==="ioredis"||e.type==="ioredis/cluster"?new $x(this.connection,e.type):new Lx(this.connection)}}class qx{constructor(e){this.connection=e}load(e,t,n,i){return n&&n.isReleased&&(n=void 0),e.isManyToOne||e.isOneToOneOwner?this.loadManyToOneOrOneToOneOwner(e,t,n,i):e.isOneToMany||e.isOneToOneNotOwner?this.loadOneToManyOrOneToOneNotOwner(e,t,n,i):e.isManyToManyOwner?this.loadManyToManyOwner(e,t,n,i):this.loadManyToManyNotOwner(e,t,n,i)}loadManyToOneOrOneToOneOwner(e,t,n,i){const r=Array.isArray(t)?t:[t],a=e.entityMetadata.name,c=i||this.connection.createQueryBuilder(n).select(e.propertyName).from(e.type,e.propertyName),l=c.expressionMap.mainAlias.name,h=e.entityMetadata.primaryColumns,p=(e.isOwning?e.joinColumns:e.inverseRelation.joinColumns).map(m=>`${e.entityMetadata.name}.${m.propertyName} = ${l}.${m.referencedColumn.propertyName}`).join(" AND ");if(c.innerJoin(e.entityMetadata.target,a,p),h.length===1)c.where(`${a}.${h[0].propertyPath} IN (:...${a+"_"+h[0].propertyName})`),c.setParameter(a+"_"+h[0].propertyName,r.map(m=>h[0].getEntityValue(m,!0)));else{const m=r.map((T,A)=>h.map((S,P)=>{const F=a+"_entity_"+A+"_"+P;return c.setParameter(F,S.getEntityValue(T,!0)),a+"."+S.propertyPath+" = :"+F}).join(" AND ")).map(T=>"("+T+")").join(" OR ");c.where(m)}return kt.joinEagerRelations(c,c.alias,c.expressionMap.mainAlias.metadata),c.getMany()}loadOneToManyOrOneToOneNotOwner(e,t,n,i){const r=Array.isArray(t)?t:[t],a=e.inverseRelation.joinColumns,c=i||this.connection.createQueryBuilder(n).select(e.propertyName).from(e.inverseRelation.entityMetadata.target,e.propertyName),l=c.expressionMap.mainAlias.name;if(a.length===1)c.where(`${l}.${a[0].propertyPath} IN (:...${l+"_"+a[0].propertyName})`),c.setParameter(l+"_"+a[0].propertyName,r.map(h=>a[0].referencedColumn.getEntityValue(h,!0)));else{const h=r.map((f,p)=>a.map((m,T)=>{const A=l+"_entity_"+p+"_"+T;return c.setParameter(A,m.referencedColumn.getEntityValue(f,!0)),l+"."+m.propertyPath+" = :"+A}).join(" AND ")).map(f=>"("+f+")").join(" OR ");c.where(h)}return kt.joinEagerRelations(c,c.alias,c.expressionMap.mainAlias.metadata),c.getMany()}loadManyToManyOwner(e,t,n,i){const r=Array.isArray(t)?t:[t],a=e.joinColumns.reduce((m,T)=>(m[T.propertyName]=r.map(A=>T.referencedColumn.getEntityValue(A,!0)),m),{}),c=i||this.connection.createQueryBuilder(n).select(e.propertyName).from(e.type,e.propertyName),l=c.expressionMap.mainAlias.name,h=e.junctionEntityMetadata.tableName,f=e.joinColumns.map(m=>`${h}.${m.propertyName} IN (:...${m.propertyName})`),p=e.inverseJoinColumns.map(m=>`${h}.${m.propertyName}=${l}.${m.referencedColumn.propertyName}`);return c.innerJoin(h,h,[...f,...p].join(" AND ")).setParameters(a),kt.joinEagerRelations(c,c.alias,c.expressionMap.mainAlias.metadata),c.getMany()}loadManyToManyNotOwner(e,t,n,i){const r=Array.isArray(t)?t:[t],a=i||this.connection.createQueryBuilder(n).select(e.propertyName).from(e.type,e.propertyName),c=a.expressionMap.mainAlias.name,l=e.junctionEntityMetadata.tableName,h=e.inverseRelation.joinColumns.map(m=>`${l}.${m.propertyName} = ${c}.${m.referencedColumn.propertyName}`),f=e.inverseRelation.inverseJoinColumns.map(m=>`${l}.${m.propertyName} IN (:...${m.propertyName})`),p=e.inverseRelation.inverseJoinColumns.reduce((m,T)=>(m[T.propertyName]=r.map(A=>T.referencedColumn.getEntityValue(A,!0)),m),{});return a.innerJoin(l,l,[...h,...f].join(" AND ")).setParameters(p),kt.joinEagerRelations(a,a.alias,a.expressionMap.mainAlias.metadata),a.getMany()}enableLazyLoad(e,t,n){const i=this,r="__"+e.propertyName+"__",a="__promise_"+e.propertyName+"__",c="__has_"+e.propertyName+"__",l=(f,p)=>(f[r]=p,f[c]=!0,delete f[a],p),h=(f,p)=>(delete f[c],delete f[r],f[a]=p,p.then(m=>f[a]===p?l(f,m):m),p);Object.defineProperty(t,e.propertyName,{get:function(){if(this[c]===!0||this[r]!==void 0)return Promise.resolve(this[r]);if(this[a])return this[a];const f=i.load(e,this,n).then(p=>e.isOneToOne||e.isManyToOne?p.length===0?null:p[0]:p);return h(this,f)},set:function(f){f instanceof Promise?h(this,f):l(this,f)},configurable:!0,enumerable:!1})}}qp();class Bx{constructor(e){this["@instanceof"]=Symbol.for("DataSource"),this.migrations=[],this.subscribers=[],this.entityMetadatas=[],this.entityMetadatasMap=new Map,qp(),this.name=e.name||"default",this.options=e,this.logger=new $f().create(this.options.logger,this.options.logging),this.driver=new gx().create(this),this.manager=this.createEntityManager(),this.namingStrategy=e.namingStrategy||new y0,this.metadataTableName=e.metadataTableName||"typeorm_metadata",this.queryResultCache=e.cache?new Lf(this).create():void 0,this.relationLoader=new qx(this),this.relationIdLoader=new $p(this),this.isInitialized=!1}get isConnected(){return this.isInitialized}get mongoManager(){if(!$.isMongoEntityManager(this.manager))throw new _("MongoEntityManager is only available for MongoDB databases.");return this.manager}get sqljsManager(){if(!$.isSqljsEntityManager(this.manager))throw new _("SqljsEntityManager is only available for Sqljs databases.");return this.manager}setOptions(e){return Object.assign(this.options,e),(e.logger||e.logging)&&(this.logger=new $f().create(e.logger||this.options.logger,e.logging||this.options.logging)),e.namingStrategy&&(this.namingStrategy=e.namingStrategy),e.cache&&(this.queryResultCache=new Lf(this).create()),e.database&&(this.driver.database=te.buildDriverOptions(this.options).database),this}async initialize(){if(this.isInitialized)throw new _C(this.name);await this.driver.connect(),this.queryResultCache&&await this.queryResultCache.connect(),Ce.assign(this,{isInitialized:!0});try{await this.buildMetadatas(),await this.driver.afterConnect(),this.options.dropSchema&&await this.dropDatabase(),this.options.migrationsRun&&await this.runMigrations({transaction:this.options.migrationsTransactionMode}),this.options.synchronize&&await this.synchronize()}catch(e){throw await this.destroy(),e}return this}async connect(){return this.initialize()}async destroy(){if(!this.isInitialized)throw new cs(this.name);await this.driver.disconnect(),this.queryResultCache&&await this.queryResultCache.disconnect(),Ce.assign(this,{isInitialized:!1})}async close(){return this.destroy()}async synchronize(e=!1){if(!this.isInitialized)throw new cs(this.name);e&&await this.dropDatabase(),await this.driver.createSchemaBuilder().build()}async dropDatabase(){const e=this.createQueryRunner();try{if(this.driver.options.type==="mssql"||te.isMySQLFamily(this.driver)||this.driver.options.type==="aurora-mysql"||te.isSQLiteFamily(this.driver)){const t=[];if(this.entityMetadatas.forEach(n=>{n.database&&t.indexOf(n.database)===-1&&t.push(n.database)}),t.length===0&&this.driver.database&&t.push(this.driver.database),t.length===0)await e.clearDatabase();else for(const n of t)await e.clearDatabase(n)}else await e.clearDatabase()}finally{await e.release()}}async runMigrations(e){var i;if(!this.isInitialized)throw new cs(this.name);const t=new Gc(this);return t.transaction=(e==null?void 0:e.transaction)||((i=this.options)==null?void 0:i.migrationsTransactionMode)||"all",t.fake=e&&e.fake||!1,await t.executePendingMigrations()}async undoLastMigration(e){if(!this.isInitialized)throw new cs(this.name);const t=new Gc(this);t.transaction=e&&e.transaction||"all",t.fake=e&&e.fake||!1,await t.undoLastMigration()}async showMigrations(){if(!this.isInitialized)throw new cs(this.name);return await new Gc(this).showMigrations()}hasMetadata(e){return!!this.findMetadata(e)}getMetadata(e){const t=this.findMetadata(e);if(!t)throw new DC(e);return t}getRepository(e){return this.manager.getRepository(e)}getTreeRepository(e){return this.manager.getTreeRepository(e)}getMongoRepository(e){if(this.driver.options.type!=="mongodb")throw new _("You can use getMongoRepository only for MongoDB connections.");return this.manager.getRepository(e)}getCustomRepository(e){return this.manager.getCustomRepository(e)}async transaction(e,t){return this.manager.transaction(e,t)}async query(e,t,n){if($.isMongoEntityManager(this.manager))throw new _("Queries aren't supported by MongoDB.");if(n&&n.isReleased)throw new yp;const i=n||this.createQueryRunner();try{return await i.query(e,t)}finally{n||await i.release()}}async sql(e,...t){const{query:n,parameters:i}=oo({driver:this.driver,strings:e,expressions:t});return await this.query(n,i)}createQueryBuilder(e,t,n){if($.isMongoEntityManager(this.manager))throw new _("Query Builder is not supported by MongoDB.");if(t){t=te.buildAlias(this.driver,void 0,t);const i=this.getMetadata(e);return new ps(this,n).select(t).from(i.target,t)}else return new ps(this,e)}createQueryRunner(e="master"){const t=this.driver.createQueryRunner(e),n=this.createEntityManager(t);return Object.assign(t,{manager:n}),t}getManyToManyMetadata(e,t){const n=this.getMetadata(e).findRelationWithPropertyPath(t);if(!n)throw new _(`Relation "${t}" was not found in ${e} entity.`);if(!n.isManyToMany)throw new _(`Relation "${e}#${t}" does not have a many-to-many relationship.You can use this method only on many-to-many relations.`);return n.junctionEntityMetadata}createEntityManager(e){return new H0().create(this,e)}findMetadata(e){const t=this.entityMetadatasMap.get(e);if(t)return t;for(const[n,i]of this.entityMetadatasMap){if($.isEntitySchema(e)&&i.name===e.options.name)return i;if(typeof e=="string"){if(e.indexOf(".")!==-1){if(i.tablePath===e)return i}else if(i.name===e||i.tableName===e)return i}if(Ce.isObjectWithName(e)&&typeof e.name=="string"){if(e.name.indexOf(".")!==-1){if(i.tablePath===e.name)return i}else if(i.name===e.name||i.tableName===e.name)return i}}}async buildMetadatas(){const e=new Rx(this),t=new E0,n=Ce.mixedListToArray(this.options.subscribers||[]),i=await e.buildSubscribers(n);Ce.assign(this,{subscribers:i});const r=Ce.mixedListToArray(this.options.entities||[]),a=await e.buildEntityMetadatas(r);Ce.assign(this,{entityMetadatas:a,entityMetadatasMap:new Map(a.map(h=>[h.target,h]))});const c=Ce.mixedListToArray(this.options.migrations||[]),l=await e.buildMigrations(c);Ce.assign(this,{migrations:l}),t.validateMany(this.entityMetadatas.filter(h=>h.tableType!=="view"),this.driver);for(const h of a)$.isBaseEntityConstructor(h.target)&&h.target.useDataSource(this)}defaultReplicationModeForReads(){if("replication"in this.driver.options&&this.driver.options.replication){const e=this.driver.options.replication.defaultMode;if(e)return e}return"slave"}}class Fx{constructor(){this.connectionMap=new Map}get connections(){return Array.from(this.connectionMap.values())}has(e){return this.connectionMap.has(e)}get(e="default"){const t=this.connectionMap.get(e);if(!t)throw new UC(e);return t}create(e){const t=this.connectionMap.get(e.name||"default");if(t&&t.isInitialized)throw new xC(e.name||"default");const n=new Bx(e);return this.connectionMap.set(n.name,n),n}}function Va(){const s=Ye.getGlobalVariable();return s.typeormMetadataArgsStorage||(s.typeormMetadataArgsStorage=new hp),s.typeormMetadataArgsStorage}async function Ux(s="default"){return new fp().get(s)}function ri(){return Au(Fx)}async function FO(s){const e=typeof s=="string"?s:"default",t=Ce.isObject(s)?s:await Ux(e);return ri().create(t).connect()}async function UO(s){s||(s=await new fp().all());const e=s.map(t=>ri().create(t));for(const t of e)await t.connect();return e}function kx(s="default"){return ri().get(s)}function kO(s="default"){return ri().get(s).manager}function jO(s="default"){return ri().get(s).manager}function VO(s="default"){return ri().get(s).manager}function jx(s,e="default"){return ri().get(e).getRepository(s)}function QO(s,e="default"){return ri().get(e).getTreeRepository(s)}function WO(s,e="default"){return ri().get(e).getCustomRepository(s)}function HO(s,e="default"){return ri().get(e).getMongoRepository(s)}function YO(s,e,t="default"){return s?jx(s,t).createQueryBuilder(e):kx(t).createQueryBuilder()}//! moment.js
//! version : 2.30.1
//! authors : Tim Wood, Iskren Chernev, Moment.js contributors
//! license : MIT
//! momentjs.com
var jp;function ue(){return jp.apply(null,arguments)}function Vx(s){jp=s}function Vn(s){return s instanceof Array||Object.prototype.toString.call(s)==="[object Array]"}function ar(s){return s!=null&&Object.prototype.toString.call(s)==="[object Object]"}function Ke(s,e){return Object.prototype.hasOwnProperty.call(s,e)}function Yu(s){if(Object.getOwnPropertyNames)return Object.getOwnPropertyNames(s).length===0;var e;for(e in s)if(Ke(s,e))return!1;return!0}function tn(s){return s===void 0}function Ri(s){return typeof s=="number"||Object.prototype.toString.call(s)==="[object Number]"}function Cs(s){return s instanceof Date||Object.prototype.toString.call(s)==="[object Date]"}function Vp(s,e){var t=[],n,i=s.length;for(n=0;n<i;++n)t.push(e(s[n],n));return t}function ji(s,e){for(var t in e)Ke(e,t)&&(s[t]=e[t]);return Ke(e,"toString")&&(s.toString=e.toString),Ke(e,"valueOf")&&(s.valueOf=e.valueOf),s}function si(s,e,t,n){return dm(s,e,t,n,!0).utc()}function Qx(){return{empty:!1,unusedTokens:[],unusedInput:[],overflow:-2,charsLeftOver:0,nullInput:!1,invalidEra:null,invalidMonth:null,invalidFormat:!1,userInvalidated:!1,iso:!1,parsedDateParts:[],era:null,meridiem:null,rfc2822:!1,weekdayMismatch:!1}}function $e(s){return s._pf==null&&(s._pf=Qx()),s._pf}var Su;Array.prototype.some?Su=Array.prototype.some:Su=function(s){var e=Object(this),t=e.length>>>0,n;for(n=0;n<t;n++)if(n in e&&s.call(this,e[n],n,e))return!0;return!1};function Gu(s){var e=null,t=!1,n=s._d&&!isNaN(s._d.getTime());if(n&&(e=$e(s),t=Su.call(e.parsedDateParts,function(i){return i!=null}),n=e.overflow<0&&!e.empty&&!e.invalidEra&&!e.invalidMonth&&!e.invalidWeekday&&!e.weekdayMismatch&&!e.nullInput&&!e.invalidFormat&&!e.userInvalidated&&(!e.meridiem||e.meridiem&&t),s._strict&&(n=n&&e.charsLeftOver===0&&e.unusedTokens.length===0&&e.bigHour===void 0)),Object.isFrozen==null||!Object.isFrozen(s))s._isValid=n;else return n;return s._isValid}function ho(s){var e=si(NaN);return s!=null?ji($e(e),s):$e(e).userInvalidated=!0,e}var qf=ue.momentProperties=[],Zc=!1;function zu(s,e){var t,n,i,r=qf.length;if(tn(e._isAMomentObject)||(s._isAMomentObject=e._isAMomentObject),tn(e._i)||(s._i=e._i),tn(e._f)||(s._f=e._f),tn(e._l)||(s._l=e._l),tn(e._strict)||(s._strict=e._strict),tn(e._tzm)||(s._tzm=e._tzm),tn(e._isUTC)||(s._isUTC=e._isUTC),tn(e._offset)||(s._offset=e._offset),tn(e._pf)||(s._pf=$e(e)),tn(e._locale)||(s._locale=e._locale),r>0)for(t=0;t<r;t++)n=qf[t],i=e[n],tn(i)||(s[n]=i);return s}function Ss(s){zu(this,s),this._d=new Date(s._d!=null?s._d.getTime():NaN),this.isValid()||(this._d=new Date(NaN)),Zc===!1&&(Zc=!0,ue.updateOffset(this),Zc=!1)}function Qn(s){return s instanceof Ss||s!=null&&s._isAMomentObject!=null}function Qp(s){ue.suppressDeprecationWarnings===!1&&typeof console<"u"&&console.warn&&console.warn("Deprecation warning: "+s)}function xn(s,e){var t=!0;return ji(function(){if(ue.deprecationHandler!=null&&ue.deprecationHandler(null,s),t){var n=[],i,r,a,c=arguments.length;for(r=0;r<c;r++){if(i="",typeof arguments[r]=="object"){i+=`
[`+r+"] ";for(a in arguments[0])Ke(arguments[0],a)&&(i+=a+": "+arguments[0][a]+", ");i=i.slice(0,-2)}else i=arguments[r];n.push(i)}Qp(s+`
Arguments: `+Array.prototype.slice.call(n).join("")+`
`+new Error().stack),t=!1}return e.apply(this,arguments)},e)}var Bf={};function Wp(s,e){ue.deprecationHandler!=null&&ue.deprecationHandler(s,e),Bf[s]||(Qp(e),Bf[s]=!0)}ue.suppressDeprecationWarnings=!1;ue.deprecationHandler=null;function ai(s){return typeof Function<"u"&&s instanceof Function||Object.prototype.toString.call(s)==="[object Function]"}function Wx(s){var e,t;for(t in s)Ke(s,t)&&(e=s[t],ai(e)?this[t]=e:this["_"+t]=e);this._config=s,this._dayOfMonthOrdinalParseLenient=new RegExp((this._dayOfMonthOrdinalParse.source||this._ordinalParse.source)+"|"+/\d{1,2}/.source)}function Ru(s,e){var t=ji({},s),n;for(n in e)Ke(e,n)&&(ar(s[n])&&ar(e[n])?(t[n]={},ji(t[n],s[n]),ji(t[n],e[n])):e[n]!=null?t[n]=e[n]:delete t[n]);for(n in s)Ke(s,n)&&!Ke(e,n)&&ar(s[n])&&(t[n]=ji({},t[n]));return t}function Ku(s){s!=null&&this.set(s)}var xu;Object.keys?xu=Object.keys:xu=function(s){var e,t=[];for(e in s)Ke(s,e)&&t.push(e);return t};var Hx={sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"};function Yx(s,e,t){var n=this._calendar[s]||this._calendar.sameElse;return ai(n)?n.call(e,t):n}function ni(s,e,t){var n=""+Math.abs(s),i=e-n.length,r=s>=0;return(r?t?"+":"":"-")+Math.pow(10,Math.max(0,i)).toString().substr(1)+n}var Ju=/(\[[^\[]*\])|(\\)?([Hh]mm(ss)?|Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|Qo?|N{1,5}|YYYYYY|YYYYY|YYYY|YY|y{2,4}|yo?|gg(ggg?)?|GG(GGG?)?|e|E|a|A|hh?|HH?|kk?|mm?|ss?|S{1,9}|x|X|zz?|ZZ?|.)/g,Aa=/(\[[^\[]*\])|(\\)?(LTS|LT|LL?L?L?|l{1,4})/g,eu={},Dr={};function ge(s,e,t,n){var i=n;typeof n=="string"&&(i=function(){return this[n]()}),s&&(Dr[s]=i),e&&(Dr[e[0]]=function(){return ni(i.apply(this,arguments),e[1],e[2])}),t&&(Dr[t]=function(){return this.localeData().ordinal(i.apply(this,arguments),s)})}function Gx(s){return s.match(/\[[\s\S]/)?s.replace(/^\[|\]$/g,""):s.replace(/\\/g,"")}function zx(s){var e=s.match(Ju),t,n;for(t=0,n=e.length;t<n;t++)Dr[e[t]]?e[t]=Dr[e[t]]:e[t]=Gx(e[t]);return function(i){var r="",a;for(a=0;a<n;a++)r+=ai(e[a])?e[a].call(i,s):e[a];return r}}function Ia(s,e){return s.isValid()?(e=Hp(e,s.localeData()),eu[e]=eu[e]||zx(e),eu[e](s)):s.localeData().invalidDate()}function Hp(s,e){var t=5;function n(i){return e.longDateFormat(i)||i}for(Aa.lastIndex=0;t>=0&&Aa.test(s);)s=s.replace(Aa,n),Aa.lastIndex=0,t-=1;return s}var Kx={LTS:"h:mm:ss A",LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY h:mm A",LLLL:"dddd, MMMM D, YYYY h:mm A"};function Jx(s){var e=this._longDateFormat[s],t=this._longDateFormat[s.toUpperCase()];return e||!t?e:(this._longDateFormat[s]=t.match(Ju).map(function(n){return n==="MMMM"||n==="MM"||n==="DD"||n==="dddd"?n.slice(1):n}).join(""),this._longDateFormat[s])}var Xx="Invalid date";function Zx(){return this._invalidDate}var e_="%d",t_=/\d{1,2}/;function n_(s){return this._ordinal.replace("%d",s)}var i_={future:"in %s",past:"%s ago",s:"a few seconds",ss:"%d seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",w:"a week",ww:"%d weeks",M:"a month",MM:"%d months",y:"a year",yy:"%d years"};function r_(s,e,t,n){var i=this._relativeTime[t];return ai(i)?i(s,e,t,n):i.replace(/%d/i,s)}function s_(s,e){var t=this._relativeTime[s>0?"future":"past"];return ai(t)?t(e):t.replace(/%s/i,e)}var Ff={D:"date",dates:"date",date:"date",d:"day",days:"day",day:"day",e:"weekday",weekdays:"weekday",weekday:"weekday",E:"isoWeekday",isoweekdays:"isoWeekday",isoweekday:"isoWeekday",DDD:"dayOfYear",dayofyears:"dayOfYear",dayofyear:"dayOfYear",h:"hour",hours:"hour",hour:"hour",ms:"millisecond",milliseconds:"millisecond",millisecond:"millisecond",m:"minute",minutes:"minute",minute:"minute",M:"month",months:"month",month:"month",Q:"quarter",quarters:"quarter",quarter:"quarter",s:"second",seconds:"second",second:"second",gg:"weekYear",weekyears:"weekYear",weekyear:"weekYear",GG:"isoWeekYear",isoweekyears:"isoWeekYear",isoweekyear:"isoWeekYear",w:"week",weeks:"week",week:"week",W:"isoWeek",isoweeks:"isoWeek",isoweek:"isoWeek",y:"year",years:"year",year:"year"};function _n(s){return typeof s=="string"?Ff[s]||Ff[s.toLowerCase()]:void 0}function Xu(s){var e={},t,n;for(n in s)Ke(s,n)&&(t=_n(n),t&&(e[t]=s[n]));return e}var a_={date:9,day:11,weekday:11,isoWeekday:11,dayOfYear:4,hour:13,millisecond:16,minute:14,month:8,quarter:7,second:15,weekYear:1,isoWeekYear:1,week:5,isoWeek:5,year:1};function o_(s){var e=[],t;for(t in s)Ke(s,t)&&e.push({unit:t,priority:a_[t]});return e.sort(function(n,i){return n.priority-i.priority}),e}var Yp=/\d/,hn=/\d\d/,Gp=/\d{3}/,Zu=/\d{4}/,fo=/[+-]?\d{6}/,dt=/\d\d?/,zp=/\d\d\d\d?/,Kp=/\d\d\d\d\d\d?/,po=/\d{1,3}/,el=/\d{1,4}/,mo=/[+-]?\d{1,6}/,jr=/\d+/,yo=/[+-]?\d+/,c_=/Z|[+-]\d\d:?\d\d/gi,go=/Z|[+-]\d\d(?::?\d\d)?/gi,u_=/[+-]?\d+(\.\d{1,3})?/,Rs=/[0-9]{0,256}['a-z\u00A0-\u05FF\u0700-\uD7FF\uF900-\uFDCF\uFDF0-\uFF07\uFF10-\uFFEF]{1,256}|[\u0600-\u06FF\/]{1,256}(\s*?[\u0600-\u06FF]{1,256}){1,2}/i,Vr=/^[1-9]\d?/,tl=/^([1-9]\d|\d)/,Qa;Qa={};function he(s,e,t){Qa[s]=ai(e)?e:function(n,i){return n&&t?t:e}}function l_(s,e){return Ke(Qa,s)?Qa[s](e._strict,e._locale):new RegExp(h_(s))}function h_(s){return Ai(s.replace("\\","").replace(/\\(\[)|\\(\])|\[([^\]\[]*)\]|\\(.)/g,function(e,t,n,i,r){return t||n||i||r}))}function Ai(s){return s.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function An(s){return s<0?Math.ceil(s)||0:Math.floor(s)}function je(s){var e=+s,t=0;return e!==0&&isFinite(e)&&(t=An(e)),t}var _u={};function st(s,e){var t,n=e,i;for(typeof s=="string"&&(s=[s]),Ri(e)&&(n=function(r,a){a[e]=je(r)}),i=s.length,t=0;t<i;t++)_u[s[t]]=n}function xs(s,e){st(s,function(t,n,i,r){i._w=i._w||{},e(t,i._w,i,r)})}function d_(s,e,t){e!=null&&Ke(_u,s)&&_u[s](e,t._a,t,s)}function Eo(s){return s%4===0&&s%100!==0||s%400===0}var Qt=0,wi=1,Xn=2,vt=3,Fn=4,bi=5,sr=6,f_=7,p_=8;ge("Y",0,0,function(){var s=this.year();return s<=9999?ni(s,4):"+"+s});ge(0,["YY",2],0,function(){return this.year()%100});ge(0,["YYYY",4],0,"year");ge(0,["YYYYY",5],0,"year");ge(0,["YYYYYY",6,!0],0,"year");he("Y",yo);he("YY",dt,hn);he("YYYY",el,Zu);he("YYYYY",mo,fo);he("YYYYYY",mo,fo);st(["YYYYY","YYYYYY"],Qt);st("YYYY",function(s,e){e[Qt]=s.length===2?ue.parseTwoDigitYear(s):je(s)});st("YY",function(s,e){e[Qt]=ue.parseTwoDigitYear(s)});st("Y",function(s,e){e[Qt]=parseInt(s,10)});function fs(s){return Eo(s)?366:365}ue.parseTwoDigitYear=function(s){return je(s)+(je(s)>68?1900:2e3)};var Jp=Qr("FullYear",!0);function m_(){return Eo(this.year())}function Qr(s,e){return function(t){return t!=null?(Xp(this,s,t),ue.updateOffset(this,e),this):ms(this,s)}}function ms(s,e){if(!s.isValid())return NaN;var t=s._d,n=s._isUTC;switch(e){case"Milliseconds":return n?t.getUTCMilliseconds():t.getMilliseconds();case"Seconds":return n?t.getUTCSeconds():t.getSeconds();case"Minutes":return n?t.getUTCMinutes():t.getMinutes();case"Hours":return n?t.getUTCHours():t.getHours();case"Date":return n?t.getUTCDate():t.getDate();case"Day":return n?t.getUTCDay():t.getDay();case"Month":return n?t.getUTCMonth():t.getMonth();case"FullYear":return n?t.getUTCFullYear():t.getFullYear();default:return NaN}}function Xp(s,e,t){var n,i,r,a,c;if(!(!s.isValid()||isNaN(t))){switch(n=s._d,i=s._isUTC,e){case"Milliseconds":return void(i?n.setUTCMilliseconds(t):n.setMilliseconds(t));case"Seconds":return void(i?n.setUTCSeconds(t):n.setSeconds(t));case"Minutes":return void(i?n.setUTCMinutes(t):n.setMinutes(t));case"Hours":return void(i?n.setUTCHours(t):n.setHours(t));case"Date":return void(i?n.setUTCDate(t):n.setDate(t));case"FullYear":break;default:return}r=t,a=s.month(),c=s.date(),c=c===29&&a===1&&!Eo(r)?28:c,i?n.setUTCFullYear(r,a,c):n.setFullYear(r,a,c)}}function y_(s){return s=_n(s),ai(this[s])?this[s]():this}function g_(s,e){if(typeof s=="object"){s=Xu(s);var t=o_(s),n,i=t.length;for(n=0;n<i;n++)this[t[n].unit](s[t[n].unit])}else if(s=_n(s),ai(this[s]))return this[s](e);return this}function E_(s,e){return(s%e+e)%e}var St;Array.prototype.indexOf?St=Array.prototype.indexOf:St=function(s){var e;for(e=0;e<this.length;++e)if(this[e]===s)return e;return-1};function nl(s,e){if(isNaN(s)||isNaN(e))return NaN;var t=E_(e,12);return s+=(e-t)/12,t===1?Eo(s)?29:28:31-t%7%2}ge("M",["MM",2],"Mo",function(){return this.month()+1});ge("MMM",0,0,function(s){return this.localeData().monthsShort(this,s)});ge("MMMM",0,0,function(s){return this.localeData().months(this,s)});he("M",dt,Vr);he("MM",dt,hn);he("MMM",function(s,e){return e.monthsShortRegex(s)});he("MMMM",function(s,e){return e.monthsRegex(s)});st(["M","MM"],function(s,e){e[wi]=je(s)-1});st(["MMM","MMMM"],function(s,e,t,n){var i=t._locale.monthsParse(s,n,t._strict);i!=null?e[wi]=i:$e(t).invalidMonth=s});var T_="January_February_March_April_May_June_July_August_September_October_November_December".split("_"),Zp="Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),em=/D[oD]?(\[[^\[\]]*\]|\s)+MMMM?/,w_=Rs,b_=Rs;function N_(s,e){return s?Vn(this._months)?this._months[s.month()]:this._months[(this._months.isFormat||em).test(e)?"format":"standalone"][s.month()]:Vn(this._months)?this._months:this._months.standalone}function A_(s,e){return s?Vn(this._monthsShort)?this._monthsShort[s.month()]:this._monthsShort[em.test(e)?"format":"standalone"][s.month()]:Vn(this._monthsShort)?this._monthsShort:this._monthsShort.standalone}function C_(s,e,t){var n,i,r,a=s.toLocaleLowerCase();if(!this._monthsParse)for(this._monthsParse=[],this._longMonthsParse=[],this._shortMonthsParse=[],n=0;n<12;++n)r=si([2e3,n]),this._shortMonthsParse[n]=this.monthsShort(r,"").toLocaleLowerCase(),this._longMonthsParse[n]=this.months(r,"").toLocaleLowerCase();return t?e==="MMM"?(i=St.call(this._shortMonthsParse,a),i!==-1?i:null):(i=St.call(this._longMonthsParse,a),i!==-1?i:null):e==="MMM"?(i=St.call(this._shortMonthsParse,a),i!==-1?i:(i=St.call(this._longMonthsParse,a),i!==-1?i:null)):(i=St.call(this._longMonthsParse,a),i!==-1?i:(i=St.call(this._shortMonthsParse,a),i!==-1?i:null))}function S_(s,e,t){var n,i,r;if(this._monthsParseExact)return C_.call(this,s,e,t);for(this._monthsParse||(this._monthsParse=[],this._longMonthsParse=[],this._shortMonthsParse=[]),n=0;n<12;n++){if(i=si([2e3,n]),t&&!this._longMonthsParse[n]&&(this._longMonthsParse[n]=new RegExp("^"+this.months(i,"").replace(".","")+"$","i"),this._shortMonthsParse[n]=new RegExp("^"+this.monthsShort(i,"").replace(".","")+"$","i")),!t&&!this._monthsParse[n]&&(r="^"+this.months(i,"")+"|^"+this.monthsShort(i,""),this._monthsParse[n]=new RegExp(r.replace(".",""),"i")),t&&e==="MMMM"&&this._longMonthsParse[n].test(s))return n;if(t&&e==="MMM"&&this._shortMonthsParse[n].test(s))return n;if(!t&&this._monthsParse[n].test(s))return n}}function tm(s,e){if(!s.isValid())return s;if(typeof e=="string"){if(/^\d+$/.test(e))e=je(e);else if(e=s.localeData().monthsParse(e),!Ri(e))return s}var t=e,n=s.date();return n=n<29?n:Math.min(n,nl(s.year(),t)),s._isUTC?s._d.setUTCMonth(t,n):s._d.setMonth(t,n),s}function nm(s){return s!=null?(tm(this,s),ue.updateOffset(this,!0),this):ms(this,"Month")}function R_(){return nl(this.year(),this.month())}function x_(s){return this._monthsParseExact?(Ke(this,"_monthsRegex")||im.call(this),s?this._monthsShortStrictRegex:this._monthsShortRegex):(Ke(this,"_monthsShortRegex")||(this._monthsShortRegex=w_),this._monthsShortStrictRegex&&s?this._monthsShortStrictRegex:this._monthsShortRegex)}function __(s){return this._monthsParseExact?(Ke(this,"_monthsRegex")||im.call(this),s?this._monthsStrictRegex:this._monthsRegex):(Ke(this,"_monthsRegex")||(this._monthsRegex=b_),this._monthsStrictRegex&&s?this._monthsStrictRegex:this._monthsRegex)}function im(){function s(l,h){return h.length-l.length}var e=[],t=[],n=[],i,r,a,c;for(i=0;i<12;i++)r=si([2e3,i]),a=Ai(this.monthsShort(r,"")),c=Ai(this.months(r,"")),e.push(a),t.push(c),n.push(c),n.push(a);e.sort(s),t.sort(s),n.sort(s),this._monthsRegex=new RegExp("^("+n.join("|")+")","i"),this._monthsShortRegex=this._monthsRegex,this._monthsStrictRegex=new RegExp("^("+t.join("|")+")","i"),this._monthsShortStrictRegex=new RegExp("^("+e.join("|")+")","i")}function v_(s,e,t,n,i,r,a){var c;return s<100&&s>=0?(c=new Date(s+400,e,t,n,i,r,a),isFinite(c.getFullYear())&&c.setFullYear(s)):c=new Date(s,e,t,n,i,r,a),c}function ys(s){var e,t;return s<100&&s>=0?(t=Array.prototype.slice.call(arguments),t[0]=s+400,e=new Date(Date.UTC.apply(null,t)),isFinite(e.getUTCFullYear())&&e.setUTCFullYear(s)):e=new Date(Date.UTC.apply(null,arguments)),e}function Wa(s,e,t){var n=7+e-t,i=(7+ys(s,0,n).getUTCDay()-e)%7;return-i+n-1}function rm(s,e,t,n,i){var r=(7+t-n)%7,a=Wa(s,n,i),c=1+7*(e-1)+r+a,l,h;return c<=0?(l=s-1,h=fs(l)+c):c>fs(s)?(l=s+1,h=c-fs(s)):(l=s,h=c),{year:l,dayOfYear:h}}function gs(s,e,t){var n=Wa(s.year(),e,t),i=Math.floor((s.dayOfYear()-n-1)/7)+1,r,a;return i<1?(a=s.year()-1,r=i+Ci(a,e,t)):i>Ci(s.year(),e,t)?(r=i-Ci(s.year(),e,t),a=s.year()+1):(a=s.year(),r=i),{week:r,year:a}}function Ci(s,e,t){var n=Wa(s,e,t),i=Wa(s+1,e,t);return(fs(s)-n+i)/7}ge("w",["ww",2],"wo","week");ge("W",["WW",2],"Wo","isoWeek");he("w",dt,Vr);he("ww",dt,hn);he("W",dt,Vr);he("WW",dt,hn);xs(["w","ww","W","WW"],function(s,e,t,n){e[n.substr(0,1)]=je(s)});function M_(s){return gs(s,this._week.dow,this._week.doy).week}var P_={dow:0,doy:6};function O_(){return this._week.dow}function D_(){return this._week.doy}function I_(s){var e=this.localeData().week(this);return s==null?e:this.add((s-e)*7,"d")}function $_(s){var e=gs(this,1,4).week;return s==null?e:this.add((s-e)*7,"d")}ge("d",0,"do","day");ge("dd",0,0,function(s){return this.localeData().weekdaysMin(this,s)});ge("ddd",0,0,function(s){return this.localeData().weekdaysShort(this,s)});ge("dddd",0,0,function(s){return this.localeData().weekdays(this,s)});ge("e",0,0,"weekday");ge("E",0,0,"isoWeekday");he("d",dt);he("e",dt);he("E",dt);he("dd",function(s,e){return e.weekdaysMinRegex(s)});he("ddd",function(s,e){return e.weekdaysShortRegex(s)});he("dddd",function(s,e){return e.weekdaysRegex(s)});xs(["dd","ddd","dddd"],function(s,e,t,n){var i=t._locale.weekdaysParse(s,n,t._strict);i!=null?e.d=i:$e(t).invalidWeekday=s});xs(["d","e","E"],function(s,e,t,n){e[n]=je(s)});function L_(s,e){return typeof s!="string"?s:isNaN(s)?(s=e.weekdaysParse(s),typeof s=="number"?s:null):parseInt(s,10)}function q_(s,e){return typeof s=="string"?e.weekdaysParse(s)%7||7:isNaN(s)?null:s}function il(s,e){return s.slice(e,7).concat(s.slice(0,e))}var B_="Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),sm="Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),F_="Su_Mo_Tu_We_Th_Fr_Sa".split("_"),U_=Rs,k_=Rs,j_=Rs;function V_(s,e){var t=Vn(this._weekdays)?this._weekdays:this._weekdays[s&&s!==!0&&this._weekdays.isFormat.test(e)?"format":"standalone"];return s===!0?il(t,this._week.dow):s?t[s.day()]:t}function Q_(s){return s===!0?il(this._weekdaysShort,this._week.dow):s?this._weekdaysShort[s.day()]:this._weekdaysShort}function W_(s){return s===!0?il(this._weekdaysMin,this._week.dow):s?this._weekdaysMin[s.day()]:this._weekdaysMin}function H_(s,e,t){var n,i,r,a=s.toLocaleLowerCase();if(!this._weekdaysParse)for(this._weekdaysParse=[],this._shortWeekdaysParse=[],this._minWeekdaysParse=[],n=0;n<7;++n)r=si([2e3,1]).day(n),this._minWeekdaysParse[n]=this.weekdaysMin(r,"").toLocaleLowerCase(),this._shortWeekdaysParse[n]=this.weekdaysShort(r,"").toLocaleLowerCase(),this._weekdaysParse[n]=this.weekdays(r,"").toLocaleLowerCase();return t?e==="dddd"?(i=St.call(this._weekdaysParse,a),i!==-1?i:null):e==="ddd"?(i=St.call(this._shortWeekdaysParse,a),i!==-1?i:null):(i=St.call(this._minWeekdaysParse,a),i!==-1?i:null):e==="dddd"?(i=St.call(this._weekdaysParse,a),i!==-1||(i=St.call(this._shortWeekdaysParse,a),i!==-1)?i:(i=St.call(this._minWeekdaysParse,a),i!==-1?i:null)):e==="ddd"?(i=St.call(this._shortWeekdaysParse,a),i!==-1||(i=St.call(this._weekdaysParse,a),i!==-1)?i:(i=St.call(this._minWeekdaysParse,a),i!==-1?i:null)):(i=St.call(this._minWeekdaysParse,a),i!==-1||(i=St.call(this._weekdaysParse,a),i!==-1)?i:(i=St.call(this._shortWeekdaysParse,a),i!==-1?i:null))}function Y_(s,e,t){var n,i,r;if(this._weekdaysParseExact)return H_.call(this,s,e,t);for(this._weekdaysParse||(this._weekdaysParse=[],this._minWeekdaysParse=[],this._shortWeekdaysParse=[],this._fullWeekdaysParse=[]),n=0;n<7;n++){if(i=si([2e3,1]).day(n),t&&!this._fullWeekdaysParse[n]&&(this._fullWeekdaysParse[n]=new RegExp("^"+this.weekdays(i,"").replace(".","\\.?")+"$","i"),this._shortWeekdaysParse[n]=new RegExp("^"+this.weekdaysShort(i,"").replace(".","\\.?")+"$","i"),this._minWeekdaysParse[n]=new RegExp("^"+this.weekdaysMin(i,"").replace(".","\\.?")+"$","i")),this._weekdaysParse[n]||(r="^"+this.weekdays(i,"")+"|^"+this.weekdaysShort(i,"")+"|^"+this.weekdaysMin(i,""),this._weekdaysParse[n]=new RegExp(r.replace(".",""),"i")),t&&e==="dddd"&&this._fullWeekdaysParse[n].test(s))return n;if(t&&e==="ddd"&&this._shortWeekdaysParse[n].test(s))return n;if(t&&e==="dd"&&this._minWeekdaysParse[n].test(s))return n;if(!t&&this._weekdaysParse[n].test(s))return n}}function G_(s){if(!this.isValid())return s!=null?this:NaN;var e=ms(this,"Day");return s!=null?(s=L_(s,this.localeData()),this.add(s-e,"d")):e}function z_(s){if(!this.isValid())return s!=null?this:NaN;var e=(this.day()+7-this.localeData()._week.dow)%7;return s==null?e:this.add(s-e,"d")}function K_(s){if(!this.isValid())return s!=null?this:NaN;if(s!=null){var e=q_(s,this.localeData());return this.day(this.day()%7?e:e-7)}else return this.day()||7}function J_(s){return this._weekdaysParseExact?(Ke(this,"_weekdaysRegex")||rl.call(this),s?this._weekdaysStrictRegex:this._weekdaysRegex):(Ke(this,"_weekdaysRegex")||(this._weekdaysRegex=U_),this._weekdaysStrictRegex&&s?this._weekdaysStrictRegex:this._weekdaysRegex)}function X_(s){return this._weekdaysParseExact?(Ke(this,"_weekdaysRegex")||rl.call(this),s?this._weekdaysShortStrictRegex:this._weekdaysShortRegex):(Ke(this,"_weekdaysShortRegex")||(this._weekdaysShortRegex=k_),this._weekdaysShortStrictRegex&&s?this._weekdaysShortStrictRegex:this._weekdaysShortRegex)}function Z_(s){return this._weekdaysParseExact?(Ke(this,"_weekdaysRegex")||rl.call(this),s?this._weekdaysMinStrictRegex:this._weekdaysMinRegex):(Ke(this,"_weekdaysMinRegex")||(this._weekdaysMinRegex=j_),this._weekdaysMinStrictRegex&&s?this._weekdaysMinStrictRegex:this._weekdaysMinRegex)}function rl(){function s(f,p){return p.length-f.length}var e=[],t=[],n=[],i=[],r,a,c,l,h;for(r=0;r<7;r++)a=si([2e3,1]).day(r),c=Ai(this.weekdaysMin(a,"")),l=Ai(this.weekdaysShort(a,"")),h=Ai(this.weekdays(a,"")),e.push(c),t.push(l),n.push(h),i.push(c),i.push(l),i.push(h);e.sort(s),t.sort(s),n.sort(s),i.sort(s),this._weekdaysRegex=new RegExp("^("+i.join("|")+")","i"),this._weekdaysShortRegex=this._weekdaysRegex,this._weekdaysMinRegex=this._weekdaysRegex,this._weekdaysStrictRegex=new RegExp("^("+n.join("|")+")","i"),this._weekdaysShortStrictRegex=new RegExp("^("+t.join("|")+")","i"),this._weekdaysMinStrictRegex=new RegExp("^("+e.join("|")+")","i")}function sl(){return this.hours()%12||12}function ev(){return this.hours()||24}ge("H",["HH",2],0,"hour");ge("h",["hh",2],0,sl);ge("k",["kk",2],0,ev);ge("hmm",0,0,function(){return""+sl.apply(this)+ni(this.minutes(),2)});ge("hmmss",0,0,function(){return""+sl.apply(this)+ni(this.minutes(),2)+ni(this.seconds(),2)});ge("Hmm",0,0,function(){return""+this.hours()+ni(this.minutes(),2)});ge("Hmmss",0,0,function(){return""+this.hours()+ni(this.minutes(),2)+ni(this.seconds(),2)});function am(s,e){ge(s,0,0,function(){return this.localeData().meridiem(this.hours(),this.minutes(),e)})}am("a",!0);am("A",!1);function om(s,e){return e._meridiemParse}he("a",om);he("A",om);he("H",dt,tl);he("h",dt,Vr);he("k",dt,Vr);he("HH",dt,hn);he("hh",dt,hn);he("kk",dt,hn);he("hmm",zp);he("hmmss",Kp);he("Hmm",zp);he("Hmmss",Kp);st(["H","HH"],vt);st(["k","kk"],function(s,e,t){var n=je(s);e[vt]=n===24?0:n});st(["a","A"],function(s,e,t){t._isPm=t._locale.isPM(s),t._meridiem=s});st(["h","hh"],function(s,e,t){e[vt]=je(s),$e(t).bigHour=!0});st("hmm",function(s,e,t){var n=s.length-2;e[vt]=je(s.substr(0,n)),e[Fn]=je(s.substr(n)),$e(t).bigHour=!0});st("hmmss",function(s,e,t){var n=s.length-4,i=s.length-2;e[vt]=je(s.substr(0,n)),e[Fn]=je(s.substr(n,2)),e[bi]=je(s.substr(i)),$e(t).bigHour=!0});st("Hmm",function(s,e,t){var n=s.length-2;e[vt]=je(s.substr(0,n)),e[Fn]=je(s.substr(n))});st("Hmmss",function(s,e,t){var n=s.length-4,i=s.length-2;e[vt]=je(s.substr(0,n)),e[Fn]=je(s.substr(n,2)),e[bi]=je(s.substr(i))});function tv(s){return(s+"").toLowerCase().charAt(0)==="p"}var nv=/[ap]\.?m?\.?/i,iv=Qr("Hours",!0);function rv(s,e,t){return s>11?t?"pm":"PM":t?"am":"AM"}var cm={calendar:Hx,longDateFormat:Kx,invalidDate:Xx,ordinal:e_,dayOfMonthOrdinalParse:t_,relativeTime:i_,months:T_,monthsShort:Zp,week:P_,weekdays:B_,weekdaysMin:F_,weekdaysShort:sm,meridiemParse:nv},mt={},us={},Es;function sv(s,e){var t,n=Math.min(s.length,e.length);for(t=0;t<n;t+=1)if(s[t]!==e[t])return t;return n}function Uf(s){return s&&s.toLowerCase().replace("_","-")}function av(s){for(var e=0,t,n,i,r;e<s.length;){for(r=Uf(s[e]).split("-"),t=r.length,n=Uf(s[e+1]),n=n?n.split("-"):null;t>0;){if(i=To(r.slice(0,t).join("-")),i)return i;if(n&&n.length>=t&&sv(r,n)>=t-1)break;t--}e++}return Es}function ov(s){return!!(s&&s.match("^[^/\\\\]*$"))}function To(s){var e=null,t;if(mt[s]===void 0&&typeof module<"u"&&module&&module.exports&&ov(s))try{e=Es._abbr,t=require,t("./locale/"+s),Wi(e)}catch{mt[s]=null}return mt[s]}function Wi(s,e){var t;return s&&(tn(e)?t=xi(s):t=al(s,e),t?Es=t:typeof console<"u"&&console.warn&&console.warn("Locale "+s+" not found. Did you forget to load it?")),Es._abbr}function al(s,e){if(e!==null){var t,n=cm;if(e.abbr=s,mt[s]!=null)Wp("defineLocaleOverride","use moment.updateLocale(localeName, config) to change an existing locale. moment.defineLocale(localeName, config) should only be used for creating a new locale See http://momentjs.com/guides/#/warnings/define-locale/ for more info."),n=mt[s]._config;else if(e.parentLocale!=null)if(mt[e.parentLocale]!=null)n=mt[e.parentLocale]._config;else if(t=To(e.parentLocale),t!=null)n=t._config;else return us[e.parentLocale]||(us[e.parentLocale]=[]),us[e.parentLocale].push({name:s,config:e}),null;return mt[s]=new Ku(Ru(n,e)),us[s]&&us[s].forEach(function(i){al(i.name,i.config)}),Wi(s),mt[s]}else return delete mt[s],null}function cv(s,e){if(e!=null){var t,n,i=cm;mt[s]!=null&&mt[s].parentLocale!=null?mt[s].set(Ru(mt[s]._config,e)):(n=To(s),n!=null&&(i=n._config),e=Ru(i,e),n==null&&(e.abbr=s),t=new Ku(e),t.parentLocale=mt[s],mt[s]=t),Wi(s)}else mt[s]!=null&&(mt[s].parentLocale!=null?(mt[s]=mt[s].parentLocale,s===Wi()&&Wi(s)):mt[s]!=null&&delete mt[s]);return mt[s]}function xi(s){var e;if(s&&s._locale&&s._locale._abbr&&(s=s._locale._abbr),!s)return Es;if(!Vn(s)){if(e=To(s),e)return e;s=[s]}return av(s)}function uv(){return xu(mt)}function ol(s){var e,t=s._a;return t&&$e(s).overflow===-2&&(e=t[wi]<0||t[wi]>11?wi:t[Xn]<1||t[Xn]>nl(t[Qt],t[wi])?Xn:t[vt]<0||t[vt]>24||t[vt]===24&&(t[Fn]!==0||t[bi]!==0||t[sr]!==0)?vt:t[Fn]<0||t[Fn]>59?Fn:t[bi]<0||t[bi]>59?bi:t[sr]<0||t[sr]>999?sr:-1,$e(s)._overflowDayOfYear&&(e<Qt||e>Xn)&&(e=Xn),$e(s)._overflowWeeks&&e===-1&&(e=f_),$e(s)._overflowWeekday&&e===-1&&(e=p_),$e(s).overflow=e),s}var lv=/^\s*((?:[+-]\d{6}|\d{4})-(?:\d\d-\d\d|W\d\d-\d|W\d\d|\d\d\d|\d\d))(?:(T| )(\d\d(?::\d\d(?::\d\d(?:[.,]\d+)?)?)?)([+-]\d\d(?::?\d\d)?|\s*Z)?)?$/,hv=/^\s*((?:[+-]\d{6}|\d{4})(?:\d\d\d\d|W\d\d\d|W\d\d|\d\d\d|\d\d|))(?:(T| )(\d\d(?:\d\d(?:\d\d(?:[.,]\d+)?)?)?)([+-]\d\d(?::?\d\d)?|\s*Z)?)?$/,dv=/Z|[+-]\d\d(?::?\d\d)?/,Ca=[["YYYYYY-MM-DD",/[+-]\d{6}-\d\d-\d\d/],["YYYY-MM-DD",/\d{4}-\d\d-\d\d/],["GGGG-[W]WW-E",/\d{4}-W\d\d-\d/],["GGGG-[W]WW",/\d{4}-W\d\d/,!1],["YYYY-DDD",/\d{4}-\d{3}/],["YYYY-MM",/\d{4}-\d\d/,!1],["YYYYYYMMDD",/[+-]\d{10}/],["YYYYMMDD",/\d{8}/],["GGGG[W]WWE",/\d{4}W\d{3}/],["GGGG[W]WW",/\d{4}W\d{2}/,!1],["YYYYDDD",/\d{7}/],["YYYYMM",/\d{6}/,!1],["YYYY",/\d{4}/,!1]],tu=[["HH:mm:ss.SSSS",/\d\d:\d\d:\d\d\.\d+/],["HH:mm:ss,SSSS",/\d\d:\d\d:\d\d,\d+/],["HH:mm:ss",/\d\d:\d\d:\d\d/],["HH:mm",/\d\d:\d\d/],["HHmmss.SSSS",/\d\d\d\d\d\d\.\d+/],["HHmmss,SSSS",/\d\d\d\d\d\d,\d+/],["HHmmss",/\d\d\d\d\d\d/],["HHmm",/\d\d\d\d/],["HH",/\d\d/]],fv=/^\/?Date\((-?\d+)/i,pv=/^(?:(Mon|Tue|Wed|Thu|Fri|Sat|Sun),?\s)?(\d{1,2})\s(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s(\d{2,4})\s(\d\d):(\d\d)(?::(\d\d))?\s(?:(UT|GMT|[ECMP][SD]T)|([Zz])|([+-]\d{4}))$/,mv={UT:0,GMT:0,EDT:-4*60,EST:-5*60,CDT:-5*60,CST:-6*60,MDT:-6*60,MST:-7*60,PDT:-7*60,PST:-8*60};function um(s){var e,t,n=s._i,i=lv.exec(n)||hv.exec(n),r,a,c,l,h=Ca.length,f=tu.length;if(i){for($e(s).iso=!0,e=0,t=h;e<t;e++)if(Ca[e][1].exec(i[1])){a=Ca[e][0],r=Ca[e][2]!==!1;break}if(a==null){s._isValid=!1;return}if(i[3]){for(e=0,t=f;e<t;e++)if(tu[e][1].exec(i[3])){c=(i[2]||" ")+tu[e][0];break}if(c==null){s._isValid=!1;return}}if(!r&&c!=null){s._isValid=!1;return}if(i[4])if(dv.exec(i[4]))l="Z";else{s._isValid=!1;return}s._f=a+(c||"")+(l||""),ul(s)}else s._isValid=!1}function yv(s,e,t,n,i,r){var a=[gv(s),Zp.indexOf(e),parseInt(t,10),parseInt(n,10),parseInt(i,10)];return r&&a.push(parseInt(r,10)),a}function gv(s){var e=parseInt(s,10);return e<=49?2e3+e:e<=999?1900+e:e}function Ev(s){return s.replace(/\([^()]*\)|[\n\t]/g," ").replace(/(\s\s+)/g," ").replace(/^\s\s*/,"").replace(/\s\s*$/,"")}function Tv(s,e,t){if(s){var n=sm.indexOf(s),i=new Date(e[0],e[1],e[2]).getDay();if(n!==i)return $e(t).weekdayMismatch=!0,t._isValid=!1,!1}return!0}function wv(s,e,t){if(s)return mv[s];if(e)return 0;var n=parseInt(t,10),i=n%100,r=(n-i)/100;return r*60+i}function lm(s){var e=pv.exec(Ev(s._i)),t;if(e){if(t=yv(e[4],e[3],e[2],e[5],e[6],e[7]),!Tv(e[1],t,s))return;s._a=t,s._tzm=wv(e[8],e[9],e[10]),s._d=ys.apply(null,s._a),s._d.setUTCMinutes(s._d.getUTCMinutes()-s._tzm),$e(s).rfc2822=!0}else s._isValid=!1}function bv(s){var e=fv.exec(s._i);if(e!==null){s._d=new Date(+e[1]);return}if(um(s),s._isValid===!1)delete s._isValid;else return;if(lm(s),s._isValid===!1)delete s._isValid;else return;s._strict?s._isValid=!1:ue.createFromInputFallback(s)}ue.createFromInputFallback=xn("value provided is not in a recognized RFC2822 or ISO format. moment construction falls back to js Date(), which is not reliable across all browsers and versions. Non RFC2822/ISO date formats are discouraged. Please refer to http://momentjs.com/guides/#/warnings/js-date/ for more info.",function(s){s._d=new Date(s._i+(s._useUTC?" UTC":""))});function Mr(s,e,t){return s??e??t}function Nv(s){var e=new Date(ue.now());return s._useUTC?[e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate()]:[e.getFullYear(),e.getMonth(),e.getDate()]}function cl(s){var e,t,n=[],i,r,a;if(!s._d){for(i=Nv(s),s._w&&s._a[Xn]==null&&s._a[wi]==null&&Av(s),s._dayOfYear!=null&&(a=Mr(s._a[Qt],i[Qt]),(s._dayOfYear>fs(a)||s._dayOfYear===0)&&($e(s)._overflowDayOfYear=!0),t=ys(a,0,s._dayOfYear),s._a[wi]=t.getUTCMonth(),s._a[Xn]=t.getUTCDate()),e=0;e<3&&s._a[e]==null;++e)s._a[e]=n[e]=i[e];for(;e<7;e++)s._a[e]=n[e]=s._a[e]==null?e===2?1:0:s._a[e];s._a[vt]===24&&s._a[Fn]===0&&s._a[bi]===0&&s._a[sr]===0&&(s._nextDay=!0,s._a[vt]=0),s._d=(s._useUTC?ys:v_).apply(null,n),r=s._useUTC?s._d.getUTCDay():s._d.getDay(),s._tzm!=null&&s._d.setUTCMinutes(s._d.getUTCMinutes()-s._tzm),s._nextDay&&(s._a[vt]=24),s._w&&typeof s._w.d<"u"&&s._w.d!==r&&($e(s).weekdayMismatch=!0)}}function Av(s){var e,t,n,i,r,a,c,l,h;e=s._w,e.GG!=null||e.W!=null||e.E!=null?(r=1,a=4,t=Mr(e.GG,s._a[Qt],gs(ht(),1,4).year),n=Mr(e.W,1),i=Mr(e.E,1),(i<1||i>7)&&(l=!0)):(r=s._locale._week.dow,a=s._locale._week.doy,h=gs(ht(),r,a),t=Mr(e.gg,s._a[Qt],h.year),n=Mr(e.w,h.week),e.d!=null?(i=e.d,(i<0||i>6)&&(l=!0)):e.e!=null?(i=e.e+r,(e.e<0||e.e>6)&&(l=!0)):i=r),n<1||n>Ci(t,r,a)?$e(s)._overflowWeeks=!0:l!=null?$e(s)._overflowWeekday=!0:(c=rm(t,n,i,r,a),s._a[Qt]=c.year,s._dayOfYear=c.dayOfYear)}ue.ISO_8601=function(){};ue.RFC_2822=function(){};function ul(s){if(s._f===ue.ISO_8601){um(s);return}if(s._f===ue.RFC_2822){lm(s);return}s._a=[],$e(s).empty=!0;var e=""+s._i,t,n,i,r,a,c=e.length,l=0,h,f;for(i=Hp(s._f,s._locale).match(Ju)||[],f=i.length,t=0;t<f;t++)r=i[t],n=(e.match(l_(r,s))||[])[0],n&&(a=e.substr(0,e.indexOf(n)),a.length>0&&$e(s).unusedInput.push(a),e=e.slice(e.indexOf(n)+n.length),l+=n.length),Dr[r]?(n?$e(s).empty=!1:$e(s).unusedTokens.push(r),d_(r,n,s)):s._strict&&!n&&$e(s).unusedTokens.push(r);$e(s).charsLeftOver=c-l,e.length>0&&$e(s).unusedInput.push(e),s._a[vt]<=12&&$e(s).bigHour===!0&&s._a[vt]>0&&($e(s).bigHour=void 0),$e(s).parsedDateParts=s._a.slice(0),$e(s).meridiem=s._meridiem,s._a[vt]=Cv(s._locale,s._a[vt],s._meridiem),h=$e(s).era,h!==null&&(s._a[Qt]=s._locale.erasConvertYear(h,s._a[Qt])),cl(s),ol(s)}function Cv(s,e,t){var n;return t==null?e:s.meridiemHour!=null?s.meridiemHour(e,t):(s.isPM!=null&&(n=s.isPM(t),n&&e<12&&(e+=12),!n&&e===12&&(e=0)),e)}function Sv(s){var e,t,n,i,r,a,c=!1,l=s._f.length;if(l===0){$e(s).invalidFormat=!0,s._d=new Date(NaN);return}for(i=0;i<l;i++)r=0,a=!1,e=zu({},s),s._useUTC!=null&&(e._useUTC=s._useUTC),e._f=s._f[i],ul(e),Gu(e)&&(a=!0),r+=$e(e).charsLeftOver,r+=$e(e).unusedTokens.length*10,$e(e).score=r,c?r<n&&(n=r,t=e):(n==null||r<n||a)&&(n=r,t=e,a&&(c=!0));ji(s,t||e)}function Rv(s){if(!s._d){var e=Xu(s._i),t=e.day===void 0?e.date:e.day;s._a=Vp([e.year,e.month,t,e.hour,e.minute,e.second,e.millisecond],function(n){return n&&parseInt(n,10)}),cl(s)}}function xv(s){var e=new Ss(ol(hm(s)));return e._nextDay&&(e.add(1,"d"),e._nextDay=void 0),e}function hm(s){var e=s._i,t=s._f;return s._locale=s._locale||xi(s._l),e===null||t===void 0&&e===""?ho({nullInput:!0}):(typeof e=="string"&&(s._i=e=s._locale.preparse(e)),Qn(e)?new Ss(ol(e)):(Cs(e)?s._d=e:Vn(t)?Sv(s):t?ul(s):_v(s),Gu(s)||(s._d=null),s))}function _v(s){var e=s._i;tn(e)?s._d=new Date(ue.now()):Cs(e)?s._d=new Date(e.valueOf()):typeof e=="string"?bv(s):Vn(e)?(s._a=Vp(e.slice(0),function(t){return parseInt(t,10)}),cl(s)):ar(e)?Rv(s):Ri(e)?s._d=new Date(e):ue.createFromInputFallback(s)}function dm(s,e,t,n,i){var r={};return(e===!0||e===!1)&&(n=e,e=void 0),(t===!0||t===!1)&&(n=t,t=void 0),(ar(s)&&Yu(s)||Vn(s)&&s.length===0)&&(s=void 0),r._isAMomentObject=!0,r._useUTC=r._isUTC=i,r._l=t,r._i=s,r._f=e,r._strict=n,xv(r)}function ht(s,e,t,n){return dm(s,e,t,n,!1)}var vv=xn("moment().min is deprecated, use moment.max instead. http://momentjs.com/guides/#/warnings/min-max/",function(){var s=ht.apply(null,arguments);return this.isValid()&&s.isValid()?s<this?this:s:ho()}),Mv=xn("moment().max is deprecated, use moment.min instead. http://momentjs.com/guides/#/warnings/min-max/",function(){var s=ht.apply(null,arguments);return this.isValid()&&s.isValid()?s>this?this:s:ho()});function fm(s,e){var t,n;if(e.length===1&&Vn(e[0])&&(e=e[0]),!e.length)return ht();for(t=e[0],n=1;n<e.length;++n)(!e[n].isValid()||e[n][s](t))&&(t=e[n]);return t}function Pv(){var s=[].slice.call(arguments,0);return fm("isBefore",s)}function Ov(){var s=[].slice.call(arguments,0);return fm("isAfter",s)}var Dv=function(){return Date.now?Date.now():+new Date},ls=["year","quarter","month","week","day","hour","minute","second","millisecond"];function Iv(s){var e,t=!1,n,i=ls.length;for(e in s)if(Ke(s,e)&&!(St.call(ls,e)!==-1&&(s[e]==null||!isNaN(s[e]))))return!1;for(n=0;n<i;++n)if(s[ls[n]]){if(t)return!1;parseFloat(s[ls[n]])!==je(s[ls[n]])&&(t=!0)}return!0}function $v(){return this._isValid}function Lv(){return Hn(NaN)}function wo(s){var e=Xu(s),t=e.year||0,n=e.quarter||0,i=e.month||0,r=e.week||e.isoWeek||0,a=e.day||0,c=e.hour||0,l=e.minute||0,h=e.second||0,f=e.millisecond||0;this._isValid=Iv(e),this._milliseconds=+f+h*1e3+l*6e4+c*1e3*60*60,this._days=+a+r*7,this._months=+i+n*3+t*12,this._data={},this._locale=xi(),this._bubble()}function $a(s){return s instanceof wo}function vu(s){return s<0?Math.round(-1*s)*-1:Math.round(s)}function qv(s,e,t){var n=Math.min(s.length,e.length),i=Math.abs(s.length-e.length),r=0,a;for(a=0;a<n;a++)je(s[a])!==je(e[a])&&r++;return r+i}function pm(s,e){ge(s,0,0,function(){var t=this.utcOffset(),n="+";return t<0&&(t=-t,n="-"),n+ni(~~(t/60),2)+e+ni(~~t%60,2)})}pm("Z",":");pm("ZZ","");he("Z",go);he("ZZ",go);st(["Z","ZZ"],function(s,e,t){t._useUTC=!0,t._tzm=ll(go,s)});var Bv=/([\+\-]|\d\d)/gi;function ll(s,e){var t=(e||"").match(s),n,i,r;return t===null?null:(n=t[t.length-1]||[],i=(n+"").match(Bv)||["-",0,0],r=+(i[1]*60)+je(i[2]),r===0?0:i[0]==="+"?r:-r)}function hl(s,e){var t,n;return e._isUTC?(t=e.clone(),n=(Qn(s)||Cs(s)?s.valueOf():ht(s).valueOf())-t.valueOf(),t._d.setTime(t._d.valueOf()+n),ue.updateOffset(t,!1),t):ht(s).local()}function Mu(s){return-Math.round(s._d.getTimezoneOffset())}ue.updateOffset=function(){};function Fv(s,e,t){var n=this._offset||0,i;if(!this.isValid())return s!=null?this:NaN;if(s!=null){if(typeof s=="string"){if(s=ll(go,s),s===null)return this}else Math.abs(s)<16&&!t&&(s=s*60);return!this._isUTC&&e&&(i=Mu(this)),this._offset=s,this._isUTC=!0,i!=null&&this.add(i,"m"),n!==s&&(!e||this._changeInProgress?gm(this,Hn(s-n,"m"),1,!1):this._changeInProgress||(this._changeInProgress=!0,ue.updateOffset(this,!0),this._changeInProgress=null)),this}else return this._isUTC?n:Mu(this)}function Uv(s,e){return s!=null?(typeof s!="string"&&(s=-s),this.utcOffset(s,e),this):-this.utcOffset()}function kv(s){return this.utcOffset(0,s)}function jv(s){return this._isUTC&&(this.utcOffset(0,s),this._isUTC=!1,s&&this.subtract(Mu(this),"m")),this}function Vv(){if(this._tzm!=null)this.utcOffset(this._tzm,!1,!0);else if(typeof this._i=="string"){var s=ll(c_,this._i);s!=null?this.utcOffset(s):this.utcOffset(0,!0)}return this}function Qv(s){return this.isValid()?(s=s?ht(s).utcOffset():0,(this.utcOffset()-s)%60===0):!1}function Wv(){return this.utcOffset()>this.clone().month(0).utcOffset()||this.utcOffset()>this.clone().month(5).utcOffset()}function Hv(){if(!tn(this._isDSTShifted))return this._isDSTShifted;var s={},e;return zu(s,this),s=hm(s),s._a?(e=s._isUTC?si(s._a):ht(s._a),this._isDSTShifted=this.isValid()&&qv(s._a,e.toArray())>0):this._isDSTShifted=!1,this._isDSTShifted}function Yv(){return this.isValid()?!this._isUTC:!1}function Gv(){return this.isValid()?this._isUTC:!1}function mm(){return this.isValid()?this._isUTC&&this._offset===0:!1}var zv=/^(-|\+)?(?:(\d*)[. ])?(\d+):(\d+)(?::(\d+)(\.\d*)?)?$/,Kv=/^(-|\+)?P(?:([-+]?[0-9,.]*)Y)?(?:([-+]?[0-9,.]*)M)?(?:([-+]?[0-9,.]*)W)?(?:([-+]?[0-9,.]*)D)?(?:T(?:([-+]?[0-9,.]*)H)?(?:([-+]?[0-9,.]*)M)?(?:([-+]?[0-9,.]*)S)?)?$/;function Hn(s,e){var t=s,n=null,i,r,a;return $a(s)?t={ms:s._milliseconds,d:s._days,M:s._months}:Ri(s)||!isNaN(+s)?(t={},e?t[e]=+s:t.milliseconds=+s):(n=zv.exec(s))?(i=n[1]==="-"?-1:1,t={y:0,d:je(n[Xn])*i,h:je(n[vt])*i,m:je(n[Fn])*i,s:je(n[bi])*i,ms:je(vu(n[sr]*1e3))*i}):(n=Kv.exec(s))?(i=n[1]==="-"?-1:1,t={y:nr(n[2],i),M:nr(n[3],i),w:nr(n[4],i),d:nr(n[5],i),h:nr(n[6],i),m:nr(n[7],i),s:nr(n[8],i)}):t==null?t={}:typeof t=="object"&&("from"in t||"to"in t)&&(a=Jv(ht(t.from),ht(t.to)),t={},t.ms=a.milliseconds,t.M=a.months),r=new wo(t),$a(s)&&Ke(s,"_locale")&&(r._locale=s._locale),$a(s)&&Ke(s,"_isValid")&&(r._isValid=s._isValid),r}Hn.fn=wo.prototype;Hn.invalid=Lv;function nr(s,e){var t=s&&parseFloat(s.replace(",","."));return(isNaN(t)?0:t)*e}function kf(s,e){var t={};return t.months=e.month()-s.month()+(e.year()-s.year())*12,s.clone().add(t.months,"M").isAfter(e)&&--t.months,t.milliseconds=+e-+s.clone().add(t.months,"M"),t}function Jv(s,e){var t;return s.isValid()&&e.isValid()?(e=hl(e,s),s.isBefore(e)?t=kf(s,e):(t=kf(e,s),t.milliseconds=-t.milliseconds,t.months=-t.months),t):{milliseconds:0,months:0}}function ym(s,e){return function(t,n){var i,r;return n!==null&&!isNaN(+n)&&(Wp(e,"moment()."+e+"(period, number) is deprecated. Please use moment()."+e+"(number, period). See http://momentjs.com/guides/#/warnings/add-inverted-param/ for more info."),r=t,t=n,n=r),i=Hn(t,n),gm(this,i,s),this}}function gm(s,e,t,n){var i=e._milliseconds,r=vu(e._days),a=vu(e._months);s.isValid()&&(n=n??!0,a&&tm(s,ms(s,"Month")+a*t),r&&Xp(s,"Date",ms(s,"Date")+r*t),i&&s._d.setTime(s._d.valueOf()+i*t),n&&ue.updateOffset(s,r||a))}var Xv=ym(1,"add"),Zv=ym(-1,"subtract");function Em(s){return typeof s=="string"||s instanceof String}function eM(s){return Qn(s)||Cs(s)||Em(s)||Ri(s)||nM(s)||tM(s)||s===null||s===void 0}function tM(s){var e=ar(s)&&!Yu(s),t=!1,n=["years","year","y","months","month","M","days","day","d","dates","date","D","hours","hour","h","minutes","minute","m","seconds","second","s","milliseconds","millisecond","ms"],i,r,a=n.length;for(i=0;i<a;i+=1)r=n[i],t=t||Ke(s,r);return e&&t}function nM(s){var e=Vn(s),t=!1;return e&&(t=s.filter(function(n){return!Ri(n)&&Em(s)}).length===0),e&&t}function iM(s){var e=ar(s)&&!Yu(s),t=!1,n=["sameDay","nextDay","lastDay","nextWeek","lastWeek","sameElse"],i,r;for(i=0;i<n.length;i+=1)r=n[i],t=t||Ke(s,r);return e&&t}function rM(s,e){var t=s.diff(e,"days",!0);return t<-6?"sameElse":t<-1?"lastWeek":t<0?"lastDay":t<1?"sameDay":t<2?"nextDay":t<7?"nextWeek":"sameElse"}function sM(s,e){arguments.length===1&&(arguments[0]?eM(arguments[0])?(s=arguments[0],e=void 0):iM(arguments[0])&&(e=arguments[0],s=void 0):(s=void 0,e=void 0));var t=s||ht(),n=hl(t,this).startOf("day"),i=ue.calendarFormat(this,n)||"sameElse",r=e&&(ai(e[i])?e[i].call(this,t):e[i]);return this.format(r||this.localeData().calendar(i,this,ht(t)))}function aM(){return new Ss(this)}function oM(s,e){var t=Qn(s)?s:ht(s);return this.isValid()&&t.isValid()?(e=_n(e)||"millisecond",e==="millisecond"?this.valueOf()>t.valueOf():t.valueOf()<this.clone().startOf(e).valueOf()):!1}function cM(s,e){var t=Qn(s)?s:ht(s);return this.isValid()&&t.isValid()?(e=_n(e)||"millisecond",e==="millisecond"?this.valueOf()<t.valueOf():this.clone().endOf(e).valueOf()<t.valueOf()):!1}function uM(s,e,t,n){var i=Qn(s)?s:ht(s),r=Qn(e)?e:ht(e);return this.isValid()&&i.isValid()&&r.isValid()?(n=n||"()",(n[0]==="("?this.isAfter(i,t):!this.isBefore(i,t))&&(n[1]===")"?this.isBefore(r,t):!this.isAfter(r,t))):!1}function lM(s,e){var t=Qn(s)?s:ht(s),n;return this.isValid()&&t.isValid()?(e=_n(e)||"millisecond",e==="millisecond"?this.valueOf()===t.valueOf():(n=t.valueOf(),this.clone().startOf(e).valueOf()<=n&&n<=this.clone().endOf(e).valueOf())):!1}function hM(s,e){return this.isSame(s,e)||this.isAfter(s,e)}function dM(s,e){return this.isSame(s,e)||this.isBefore(s,e)}function fM(s,e,t){var n,i,r;if(!this.isValid())return NaN;if(n=hl(s,this),!n.isValid())return NaN;switch(i=(n.utcOffset()-this.utcOffset())*6e4,e=_n(e),e){case"year":r=La(this,n)/12;break;case"month":r=La(this,n);break;case"quarter":r=La(this,n)/3;break;case"second":r=(this-n)/1e3;break;case"minute":r=(this-n)/6e4;break;case"hour":r=(this-n)/36e5;break;case"day":r=(this-n-i)/864e5;break;case"week":r=(this-n-i)/6048e5;break;default:r=this-n}return t?r:An(r)}function La(s,e){if(s.date()<e.date())return-La(e,s);var t=(e.year()-s.year())*12+(e.month()-s.month()),n=s.clone().add(t,"months"),i,r;return e-n<0?(i=s.clone().add(t-1,"months"),r=(e-n)/(n-i)):(i=s.clone().add(t+1,"months"),r=(e-n)/(i-n)),-(t+r)||0}ue.defaultFormat="YYYY-MM-DDTHH:mm:ssZ";ue.defaultFormatUtc="YYYY-MM-DDTHH:mm:ss[Z]";function pM(){return this.clone().locale("en").format("ddd MMM DD YYYY HH:mm:ss [GMT]ZZ")}function mM(s){if(!this.isValid())return null;var e=s!==!0,t=e?this.clone().utc():this;return t.year()<0||t.year()>9999?Ia(t,e?"YYYYYY-MM-DD[T]HH:mm:ss.SSS[Z]":"YYYYYY-MM-DD[T]HH:mm:ss.SSSZ"):ai(Date.prototype.toISOString)?e?this.toDate().toISOString():new Date(this.valueOf()+this.utcOffset()*60*1e3).toISOString().replace("Z",Ia(t,"Z")):Ia(t,e?"YYYY-MM-DD[T]HH:mm:ss.SSS[Z]":"YYYY-MM-DD[T]HH:mm:ss.SSSZ")}function yM(){if(!this.isValid())return"moment.invalid(/* "+this._i+" */)";var s="moment",e="",t,n,i,r;return this.isLocal()||(s=this.utcOffset()===0?"moment.utc":"moment.parseZone",e="Z"),t="["+s+'("]',n=0<=this.year()&&this.year()<=9999?"YYYY":"YYYYYY",i="-MM-DD[T]HH:mm:ss.SSS",r=e+'[")]',this.format(t+n+i+r)}function gM(s){s||(s=this.isUtc()?ue.defaultFormatUtc:ue.defaultFormat);var e=Ia(this,s);return this.localeData().postformat(e)}function EM(s,e){return this.isValid()&&(Qn(s)&&s.isValid()||ht(s).isValid())?Hn({to:this,from:s}).locale(this.locale()).humanize(!e):this.localeData().invalidDate()}function TM(s){return this.from(ht(),s)}function wM(s,e){return this.isValid()&&(Qn(s)&&s.isValid()||ht(s).isValid())?Hn({from:this,to:s}).locale(this.locale()).humanize(!e):this.localeData().invalidDate()}function bM(s){return this.to(ht(),s)}function Tm(s){var e;return s===void 0?this._locale._abbr:(e=xi(s),e!=null&&(this._locale=e),this)}var wm=xn("moment().lang() is deprecated. Instead, use moment().localeData() to get the language configuration. Use moment().locale() to change languages.",function(s){return s===void 0?this.localeData():this.locale(s)});function bm(){return this._locale}var Ha=1e3,Ir=60*Ha,Ya=60*Ir,Nm=(365*400+97)*24*Ya;function $r(s,e){return(s%e+e)%e}function Am(s,e,t){return s<100&&s>=0?new Date(s+400,e,t)-Nm:new Date(s,e,t).valueOf()}function Cm(s,e,t){return s<100&&s>=0?Date.UTC(s+400,e,t)-Nm:Date.UTC(s,e,t)}function NM(s){var e,t;if(s=_n(s),s===void 0||s==="millisecond"||!this.isValid())return this;switch(t=this._isUTC?Cm:Am,s){case"year":e=t(this.year(),0,1);break;case"quarter":e=t(this.year(),this.month()-this.month()%3,1);break;case"month":e=t(this.year(),this.month(),1);break;case"week":e=t(this.year(),this.month(),this.date()-this.weekday());break;case"isoWeek":e=t(this.year(),this.month(),this.date()-(this.isoWeekday()-1));break;case"day":case"date":e=t(this.year(),this.month(),this.date());break;case"hour":e=this._d.valueOf(),e-=$r(e+(this._isUTC?0:this.utcOffset()*Ir),Ya);break;case"minute":e=this._d.valueOf(),e-=$r(e,Ir);break;case"second":e=this._d.valueOf(),e-=$r(e,Ha);break}return this._d.setTime(e),ue.updateOffset(this,!0),this}function AM(s){var e,t;if(s=_n(s),s===void 0||s==="millisecond"||!this.isValid())return this;switch(t=this._isUTC?Cm:Am,s){case"year":e=t(this.year()+1,0,1)-1;break;case"quarter":e=t(this.year(),this.month()-this.month()%3+3,1)-1;break;case"month":e=t(this.year(),this.month()+1,1)-1;break;case"week":e=t(this.year(),this.month(),this.date()-this.weekday()+7)-1;break;case"isoWeek":e=t(this.year(),this.month(),this.date()-(this.isoWeekday()-1)+7)-1;break;case"day":case"date":e=t(this.year(),this.month(),this.date()+1)-1;break;case"hour":e=this._d.valueOf(),e+=Ya-$r(e+(this._isUTC?0:this.utcOffset()*Ir),Ya)-1;break;case"minute":e=this._d.valueOf(),e+=Ir-$r(e,Ir)-1;break;case"second":e=this._d.valueOf(),e+=Ha-$r(e,Ha)-1;break}return this._d.setTime(e),ue.updateOffset(this,!0),this}function CM(){return this._d.valueOf()-(this._offset||0)*6e4}function SM(){return Math.floor(this.valueOf()/1e3)}function RM(){return new Date(this.valueOf())}function xM(){var s=this;return[s.year(),s.month(),s.date(),s.hour(),s.minute(),s.second(),s.millisecond()]}function _M(){var s=this;return{years:s.year(),months:s.month(),date:s.date(),hours:s.hours(),minutes:s.minutes(),seconds:s.seconds(),milliseconds:s.milliseconds()}}function vM(){return this.isValid()?this.toISOString():null}function MM(){return Gu(this)}function PM(){return ji({},$e(this))}function OM(){return $e(this).overflow}function DM(){return{input:this._i,format:this._f,locale:this._locale,isUTC:this._isUTC,strict:this._strict}}ge("N",0,0,"eraAbbr");ge("NN",0,0,"eraAbbr");ge("NNN",0,0,"eraAbbr");ge("NNNN",0,0,"eraName");ge("NNNNN",0,0,"eraNarrow");ge("y",["y",1],"yo","eraYear");ge("y",["yy",2],0,"eraYear");ge("y",["yyy",3],0,"eraYear");ge("y",["yyyy",4],0,"eraYear");he("N",dl);he("NN",dl);he("NNN",dl);he("NNNN",QM);he("NNNNN",WM);st(["N","NN","NNN","NNNN","NNNNN"],function(s,e,t,n){var i=t._locale.erasParse(s,n,t._strict);i?$e(t).era=i:$e(t).invalidEra=s});he("y",jr);he("yy",jr);he("yyy",jr);he("yyyy",jr);he("yo",HM);st(["y","yy","yyy","yyyy"],Qt);st(["yo"],function(s,e,t,n){var i;t._locale._eraYearOrdinalRegex&&(i=s.match(t._locale._eraYearOrdinalRegex)),t._locale.eraYearOrdinalParse?e[Qt]=t._locale.eraYearOrdinalParse(s,i):e[Qt]=parseInt(s,10)});function IM(s,e){var t,n,i,r=this._eras||xi("en")._eras;for(t=0,n=r.length;t<n;++t){switch(typeof r[t].since){case"string":i=ue(r[t].since).startOf("day"),r[t].since=i.valueOf();break}switch(typeof r[t].until){case"undefined":r[t].until=1/0;break;case"string":i=ue(r[t].until).startOf("day").valueOf(),r[t].until=i.valueOf();break}}return r}function $M(s,e,t){var n,i,r=this.eras(),a,c,l;for(s=s.toUpperCase(),n=0,i=r.length;n<i;++n)if(a=r[n].name.toUpperCase(),c=r[n].abbr.toUpperCase(),l=r[n].narrow.toUpperCase(),t)switch(e){case"N":case"NN":case"NNN":if(c===s)return r[n];break;case"NNNN":if(a===s)return r[n];break;case"NNNNN":if(l===s)return r[n];break}else if([a,c,l].indexOf(s)>=0)return r[n]}function LM(s,e){var t=s.since<=s.until?1:-1;return e===void 0?ue(s.since).year():ue(s.since).year()+(e-s.offset)*t}function qM(){var s,e,t,n=this.localeData().eras();for(s=0,e=n.length;s<e;++s)if(t=this.clone().startOf("day").valueOf(),n[s].since<=t&&t<=n[s].until||n[s].until<=t&&t<=n[s].since)return n[s].name;return""}function BM(){var s,e,t,n=this.localeData().eras();for(s=0,e=n.length;s<e;++s)if(t=this.clone().startOf("day").valueOf(),n[s].since<=t&&t<=n[s].until||n[s].until<=t&&t<=n[s].since)return n[s].narrow;return""}function FM(){var s,e,t,n=this.localeData().eras();for(s=0,e=n.length;s<e;++s)if(t=this.clone().startOf("day").valueOf(),n[s].since<=t&&t<=n[s].until||n[s].until<=t&&t<=n[s].since)return n[s].abbr;return""}function UM(){var s,e,t,n,i=this.localeData().eras();for(s=0,e=i.length;s<e;++s)if(t=i[s].since<=i[s].until?1:-1,n=this.clone().startOf("day").valueOf(),i[s].since<=n&&n<=i[s].until||i[s].until<=n&&n<=i[s].since)return(this.year()-ue(i[s].since).year())*t+i[s].offset;return this.year()}function kM(s){return Ke(this,"_erasNameRegex")||fl.call(this),s?this._erasNameRegex:this._erasRegex}function jM(s){return Ke(this,"_erasAbbrRegex")||fl.call(this),s?this._erasAbbrRegex:this._erasRegex}function VM(s){return Ke(this,"_erasNarrowRegex")||fl.call(this),s?this._erasNarrowRegex:this._erasRegex}function dl(s,e){return e.erasAbbrRegex(s)}function QM(s,e){return e.erasNameRegex(s)}function WM(s,e){return e.erasNarrowRegex(s)}function HM(s,e){return e._eraYearOrdinalRegex||jr}function fl(){var s=[],e=[],t=[],n=[],i,r,a,c,l,h=this.eras();for(i=0,r=h.length;i<r;++i)a=Ai(h[i].name),c=Ai(h[i].abbr),l=Ai(h[i].narrow),e.push(a),s.push(c),t.push(l),n.push(a),n.push(c),n.push(l);this._erasRegex=new RegExp("^("+n.join("|")+")","i"),this._erasNameRegex=new RegExp("^("+e.join("|")+")","i"),this._erasAbbrRegex=new RegExp("^("+s.join("|")+")","i"),this._erasNarrowRegex=new RegExp("^("+t.join("|")+")","i")}ge(0,["gg",2],0,function(){return this.weekYear()%100});ge(0,["GG",2],0,function(){return this.isoWeekYear()%100});function bo(s,e){ge(0,[s,s.length],0,e)}bo("gggg","weekYear");bo("ggggg","weekYear");bo("GGGG","isoWeekYear");bo("GGGGG","isoWeekYear");he("G",yo);he("g",yo);he("GG",dt,hn);he("gg",dt,hn);he("GGGG",el,Zu);he("gggg",el,Zu);he("GGGGG",mo,fo);he("ggggg",mo,fo);xs(["gggg","ggggg","GGGG","GGGGG"],function(s,e,t,n){e[n.substr(0,2)]=je(s)});xs(["gg","GG"],function(s,e,t,n){e[n]=ue.parseTwoDigitYear(s)});function YM(s){return Sm.call(this,s,this.week(),this.weekday()+this.localeData()._week.dow,this.localeData()._week.dow,this.localeData()._week.doy)}function GM(s){return Sm.call(this,s,this.isoWeek(),this.isoWeekday(),1,4)}function zM(){return Ci(this.year(),1,4)}function KM(){return Ci(this.isoWeekYear(),1,4)}function JM(){var s=this.localeData()._week;return Ci(this.year(),s.dow,s.doy)}function XM(){var s=this.localeData()._week;return Ci(this.weekYear(),s.dow,s.doy)}function Sm(s,e,t,n,i){var r;return s==null?gs(this,n,i).year:(r=Ci(s,n,i),e>r&&(e=r),ZM.call(this,s,e,t,n,i))}function ZM(s,e,t,n,i){var r=rm(s,e,t,n,i),a=ys(r.year,0,r.dayOfYear);return this.year(a.getUTCFullYear()),this.month(a.getUTCMonth()),this.date(a.getUTCDate()),this}ge("Q",0,"Qo","quarter");he("Q",Yp);st("Q",function(s,e){e[wi]=(je(s)-1)*3});function eP(s){return s==null?Math.ceil((this.month()+1)/3):this.month((s-1)*3+this.month()%3)}ge("D",["DD",2],"Do","date");he("D",dt,Vr);he("DD",dt,hn);he("Do",function(s,e){return s?e._dayOfMonthOrdinalParse||e._ordinalParse:e._dayOfMonthOrdinalParseLenient});st(["D","DD"],Xn);st("Do",function(s,e){e[Xn]=je(s.match(dt)[0])});var Rm=Qr("Date",!0);ge("DDD",["DDDD",3],"DDDo","dayOfYear");he("DDD",po);he("DDDD",Gp);st(["DDD","DDDD"],function(s,e,t){t._dayOfYear=je(s)});function tP(s){var e=Math.round((this.clone().startOf("day")-this.clone().startOf("year"))/864e5)+1;return s==null?e:this.add(s-e,"d")}ge("m",["mm",2],0,"minute");he("m",dt,tl);he("mm",dt,hn);st(["m","mm"],Fn);var nP=Qr("Minutes",!1);ge("s",["ss",2],0,"second");he("s",dt,tl);he("ss",dt,hn);st(["s","ss"],bi);var iP=Qr("Seconds",!1);ge("S",0,0,function(){return~~(this.millisecond()/100)});ge(0,["SS",2],0,function(){return~~(this.millisecond()/10)});ge(0,["SSS",3],0,"millisecond");ge(0,["SSSS",4],0,function(){return this.millisecond()*10});ge(0,["SSSSS",5],0,function(){return this.millisecond()*100});ge(0,["SSSSSS",6],0,function(){return this.millisecond()*1e3});ge(0,["SSSSSSS",7],0,function(){return this.millisecond()*1e4});ge(0,["SSSSSSSS",8],0,function(){return this.millisecond()*1e5});ge(0,["SSSSSSSSS",9],0,function(){return this.millisecond()*1e6});he("S",po,Yp);he("SS",po,hn);he("SSS",po,Gp);var Vi,xm;for(Vi="SSSS";Vi.length<=9;Vi+="S")he(Vi,jr);function rP(s,e){e[sr]=je(("0."+s)*1e3)}for(Vi="S";Vi.length<=9;Vi+="S")st(Vi,rP);xm=Qr("Milliseconds",!1);ge("z",0,0,"zoneAbbr");ge("zz",0,0,"zoneName");function sP(){return this._isUTC?"UTC":""}function aP(){return this._isUTC?"Coordinated Universal Time":""}var ie=Ss.prototype;ie.add=Xv;ie.calendar=sM;ie.clone=aM;ie.diff=fM;ie.endOf=AM;ie.format=gM;ie.from=EM;ie.fromNow=TM;ie.to=wM;ie.toNow=bM;ie.get=y_;ie.invalidAt=OM;ie.isAfter=oM;ie.isBefore=cM;ie.isBetween=uM;ie.isSame=lM;ie.isSameOrAfter=hM;ie.isSameOrBefore=dM;ie.isValid=MM;ie.lang=wm;ie.locale=Tm;ie.localeData=bm;ie.max=Mv;ie.min=vv;ie.parsingFlags=PM;ie.set=g_;ie.startOf=NM;ie.subtract=Zv;ie.toArray=xM;ie.toObject=_M;ie.toDate=RM;ie.toISOString=mM;ie.inspect=yM;typeof Symbol<"u"&&Symbol.for!=null&&(ie[Symbol.for("nodejs.util.inspect.custom")]=function(){return"Moment<"+this.format()+">"});ie.toJSON=vM;ie.toString=pM;ie.unix=SM;ie.valueOf=CM;ie.creationData=DM;ie.eraName=qM;ie.eraNarrow=BM;ie.eraAbbr=FM;ie.eraYear=UM;ie.year=Jp;ie.isLeapYear=m_;ie.weekYear=YM;ie.isoWeekYear=GM;ie.quarter=ie.quarters=eP;ie.month=nm;ie.daysInMonth=R_;ie.week=ie.weeks=I_;ie.isoWeek=ie.isoWeeks=$_;ie.weeksInYear=JM;ie.weeksInWeekYear=XM;ie.isoWeeksInYear=zM;ie.isoWeeksInISOWeekYear=KM;ie.date=Rm;ie.day=ie.days=G_;ie.weekday=z_;ie.isoWeekday=K_;ie.dayOfYear=tP;ie.hour=ie.hours=iv;ie.minute=ie.minutes=nP;ie.second=ie.seconds=iP;ie.millisecond=ie.milliseconds=xm;ie.utcOffset=Fv;ie.utc=kv;ie.local=jv;ie.parseZone=Vv;ie.hasAlignedHourOffset=Qv;ie.isDST=Wv;ie.isLocal=Yv;ie.isUtcOffset=Gv;ie.isUtc=mm;ie.isUTC=mm;ie.zoneAbbr=sP;ie.zoneName=aP;ie.dates=xn("dates accessor is deprecated. Use date instead.",Rm);ie.months=xn("months accessor is deprecated. Use month instead",nm);ie.years=xn("years accessor is deprecated. Use year instead",Jp);ie.zone=xn("moment().zone is deprecated, use moment().utcOffset instead. http://momentjs.com/guides/#/warnings/zone/",Uv);ie.isDSTShifted=xn("isDSTShifted is deprecated. See http://momentjs.com/guides/#/warnings/dst-shifted/ for more information",Hv);function oP(s){return ht(s*1e3)}function cP(){return ht.apply(null,arguments).parseZone()}function _m(s){return s}var Je=Ku.prototype;Je.calendar=Yx;Je.longDateFormat=Jx;Je.invalidDate=Zx;Je.ordinal=n_;Je.preparse=_m;Je.postformat=_m;Je.relativeTime=r_;Je.pastFuture=s_;Je.set=Wx;Je.eras=IM;Je.erasParse=$M;Je.erasConvertYear=LM;Je.erasAbbrRegex=jM;Je.erasNameRegex=kM;Je.erasNarrowRegex=VM;Je.months=N_;Je.monthsShort=A_;Je.monthsParse=S_;Je.monthsRegex=__;Je.monthsShortRegex=x_;Je.week=M_;Je.firstDayOfYear=D_;Je.firstDayOfWeek=O_;Je.weekdays=V_;Je.weekdaysMin=W_;Je.weekdaysShort=Q_;Je.weekdaysParse=Y_;Je.weekdaysRegex=J_;Je.weekdaysShortRegex=X_;Je.weekdaysMinRegex=Z_;Je.isPM=tv;Je.meridiem=rv;function Ga(s,e,t,n){var i=xi(),r=si().set(n,e);return i[t](r,s)}function vm(s,e,t){if(Ri(s)&&(e=s,s=void 0),s=s||"",e!=null)return Ga(s,e,t,"month");var n,i=[];for(n=0;n<12;n++)i[n]=Ga(s,n,t,"month");return i}function pl(s,e,t,n){typeof s=="boolean"?(Ri(e)&&(t=e,e=void 0),e=e||""):(e=s,t=e,s=!1,Ri(e)&&(t=e,e=void 0),e=e||"");var i=xi(),r=s?i._week.dow:0,a,c=[];if(t!=null)return Ga(e,(t+r)%7,n,"day");for(a=0;a<7;a++)c[a]=Ga(e,(a+r)%7,n,"day");return c}function uP(s,e){return vm(s,e,"months")}function lP(s,e){return vm(s,e,"monthsShort")}function hP(s,e,t){return pl(s,e,t,"weekdays")}function dP(s,e,t){return pl(s,e,t,"weekdaysShort")}function fP(s,e,t){return pl(s,e,t,"weekdaysMin")}Wi("en",{eras:[{since:"0001-01-01",until:1/0,offset:1,name:"Anno Domini",narrow:"AD",abbr:"AD"},{since:"0000-12-31",until:-1/0,offset:1,name:"Before Christ",narrow:"BC",abbr:"BC"}],dayOfMonthOrdinalParse:/\d{1,2}(th|st|nd|rd)/,ordinal:function(s){var e=s%10,t=je(s%100/10)===1?"th":e===1?"st":e===2?"nd":e===3?"rd":"th";return s+t}});ue.lang=xn("moment.lang is deprecated. Use moment.locale instead.",Wi);ue.langData=xn("moment.langData is deprecated. Use moment.localeData instead.",xi);var Ei=Math.abs;function pP(){var s=this._data;return this._milliseconds=Ei(this._milliseconds),this._days=Ei(this._days),this._months=Ei(this._months),s.milliseconds=Ei(s.milliseconds),s.seconds=Ei(s.seconds),s.minutes=Ei(s.minutes),s.hours=Ei(s.hours),s.months=Ei(s.months),s.years=Ei(s.years),this}function Mm(s,e,t,n){var i=Hn(e,t);return s._milliseconds+=n*i._milliseconds,s._days+=n*i._days,s._months+=n*i._months,s._bubble()}function mP(s,e){return Mm(this,s,e,1)}function yP(s,e){return Mm(this,s,e,-1)}function jf(s){return s<0?Math.floor(s):Math.ceil(s)}function gP(){var s=this._milliseconds,e=this._days,t=this._months,n=this._data,i,r,a,c,l;return s>=0&&e>=0&&t>=0||s<=0&&e<=0&&t<=0||(s+=jf(Pu(t)+e)*864e5,e=0,t=0),n.milliseconds=s%1e3,i=An(s/1e3),n.seconds=i%60,r=An(i/60),n.minutes=r%60,a=An(r/60),n.hours=a%24,e+=An(a/24),l=An(Pm(e)),t+=l,e-=jf(Pu(l)),c=An(t/12),t%=12,n.days=e,n.months=t,n.years=c,this}function Pm(s){return s*4800/146097}function Pu(s){return s*146097/4800}function EP(s){if(!this.isValid())return NaN;var e,t,n=this._milliseconds;if(s=_n(s),s==="month"||s==="quarter"||s==="year")switch(e=this._days+n/864e5,t=this._months+Pm(e),s){case"month":return t;case"quarter":return t/3;case"year":return t/12}else switch(e=this._days+Math.round(Pu(this._months)),s){case"week":return e/7+n/6048e5;case"day":return e+n/864e5;case"hour":return e*24+n/36e5;case"minute":return e*1440+n/6e4;case"second":return e*86400+n/1e3;case"millisecond":return Math.floor(e*864e5)+n;default:throw new Error("Unknown unit "+s)}}function _i(s){return function(){return this.as(s)}}var Om=_i("ms"),TP=_i("s"),wP=_i("m"),bP=_i("h"),NP=_i("d"),AP=_i("w"),CP=_i("M"),SP=_i("Q"),RP=_i("y"),xP=Om;function _P(){return Hn(this)}function vP(s){return s=_n(s),this.isValid()?this[s+"s"]():NaN}function lr(s){return function(){return this.isValid()?this._data[s]:NaN}}var MP=lr("milliseconds"),PP=lr("seconds"),OP=lr("minutes"),DP=lr("hours"),IP=lr("days"),$P=lr("months"),LP=lr("years");function qP(){return An(this.days()/7)}var Ti=Math.round,Or={ss:44,s:45,m:45,h:22,d:26,w:null,M:11};function BP(s,e,t,n,i){return i.relativeTime(e||1,!!t,s,n)}function FP(s,e,t,n){var i=Hn(s).abs(),r=Ti(i.as("s")),a=Ti(i.as("m")),c=Ti(i.as("h")),l=Ti(i.as("d")),h=Ti(i.as("M")),f=Ti(i.as("w")),p=Ti(i.as("y")),m=r<=t.ss&&["s",r]||r<t.s&&["ss",r]||a<=1&&["m"]||a<t.m&&["mm",a]||c<=1&&["h"]||c<t.h&&["hh",c]||l<=1&&["d"]||l<t.d&&["dd",l];return t.w!=null&&(m=m||f<=1&&["w"]||f<t.w&&["ww",f]),m=m||h<=1&&["M"]||h<t.M&&["MM",h]||p<=1&&["y"]||["yy",p],m[2]=e,m[3]=+s>0,m[4]=n,BP.apply(null,m)}function UP(s){return s===void 0?Ti:typeof s=="function"?(Ti=s,!0):!1}function kP(s,e){return Or[s]===void 0?!1:e===void 0?Or[s]:(Or[s]=e,s==="s"&&(Or.ss=e-1),!0)}function jP(s,e){if(!this.isValid())return this.localeData().invalidDate();var t=!1,n=Or,i,r;return typeof s=="object"&&(e=s,s=!1),typeof s=="boolean"&&(t=s),typeof e=="object"&&(n=Object.assign({},Or,e),e.s!=null&&e.ss==null&&(n.ss=e.s-1)),i=this.localeData(),r=FP(this,!t,n,i),t&&(r=i.pastFuture(+this,r)),i.postformat(r)}var nu=Math.abs;function vr(s){return(s>0)-(s<0)||+s}function No(){if(!this.isValid())return this.localeData().invalidDate();var s=nu(this._milliseconds)/1e3,e=nu(this._days),t=nu(this._months),n,i,r,a,c=this.asSeconds(),l,h,f,p;return c?(n=An(s/60),i=An(n/60),s%=60,n%=60,r=An(t/12),t%=12,a=s?s.toFixed(3).replace(/\.?0+$/,""):"",l=c<0?"-":"",h=vr(this._months)!==vr(c)?"-":"",f=vr(this._days)!==vr(c)?"-":"",p=vr(this._milliseconds)!==vr(c)?"-":"",l+"P"+(r?h+r+"Y":"")+(t?h+t+"M":"")+(e?f+e+"D":"")+(i||n||s?"T":"")+(i?p+i+"H":"")+(n?p+n+"M":"")+(s?p+a+"S":"")):"P0D"}var He=wo.prototype;He.isValid=$v;He.abs=pP;He.add=mP;He.subtract=yP;He.as=EP;He.asMilliseconds=Om;He.asSeconds=TP;He.asMinutes=wP;He.asHours=bP;He.asDays=NP;He.asWeeks=AP;He.asMonths=CP;He.asQuarters=SP;He.asYears=RP;He.valueOf=xP;He._bubble=gP;He.clone=_P;He.get=vP;He.milliseconds=MP;He.seconds=PP;He.minutes=OP;He.hours=DP;He.days=IP;He.weeks=qP;He.months=$P;He.years=LP;He.humanize=jP;He.toISOString=No;He.toString=No;He.toJSON=No;He.locale=Tm;He.localeData=bm;He.toIsoString=xn("toIsoString() is deprecated. Please use toISOString() instead (notice the capitals)",No);He.lang=wm;ge("X",0,0,"unix");ge("x",0,0,"valueOf");he("x",yo);he("X",u_);st("X",function(s,e,t){t._d=new Date(parseFloat(s)*1e3)});st("x",function(s,e,t){t._d=new Date(je(s))});//! moment.js
ue.version="2.30.1";Vx(ht);ue.fn=ie;ue.min=Pv;ue.max=Ov;ue.now=Dv;ue.utc=si;ue.unix=oP;ue.months=uP;ue.isDate=Cs;ue.locale=Wi;ue.invalid=ho;ue.duration=Hn;ue.isMoment=Qn;ue.weekdays=hP;ue.parseZone=cP;ue.localeData=xi;ue.isDuration=$a;ue.monthsShort=lP;ue.weekdaysMin=fP;ue.defineLocale=al;ue.updateLocale=cv;ue.locales=uv;ue.weekdaysShort=dP;ue.normalizeUnits=_n;ue.relativeTimeRounding=UP;ue.relativeTimeThreshold=kP;ue.calendarFormat=rM;ue.prototype=ie;ue.HTML5_FMT={DATETIME_LOCAL:"YYYY-MM-DDTHH:mm",DATETIME_LOCAL_SECONDS:"YYYY-MM-DDTHH:mm:ss",DATETIME_LOCAL_MS:"YYYY-MM-DDTHH:mm:ss.SSS",DATE:"YYYY-MM-DD",TIME:"HH:mm",TIME_SECONDS:"HH:mm:ss",TIME_MS:"HH:mm:ss.SSS",WEEK:"GGGG-[W]WW",MONTH:"YYYY-MM"};const Vf=qa(),VP=Vf==="browser"||Vf==="pwa",ve=(...s)=>(e,t)=>e;let ze={};VP?ze={Entity:ve,Column:ve,PrimaryGeneratedColumn:ve,PrimaryColumn:ve,ManyToOne:ve,OneToMany:ve,JoinColumn:ve,JoinTable:ve,CreateDateColumn:ve,UpdateDateColumn:ve,VersionColumn:ve,Index:ve,Unique:ve,ViewEntity:ve,ViewColumn:ve}:(ze={Entity:ve,Column:ve,PrimaryGeneratedColumn:ve,PrimaryColumn:ve,ManyToOne:ve,OneToMany:ve,JoinColumn:ve,JoinTable:ve,CreateDateColumn:ve,UpdateDateColumn:ve,VersionColumn:ve,Index:ve,Unique:ve,ViewEntity:ve,ViewColumn:ve},(async()=>{try{const s=await za(()=>import("./index-CSOB4155.js"),__vite__mapDeps([0,1,2,3,4,5,6]));s&&(ze.Entity=s.Entity??ve,ze.Column=s.Column??ve,ze.PrimaryGeneratedColumn=s.PrimaryGeneratedColumn??ve,ze.PrimaryColumn=s.PrimaryColumn??ve,ze.ManyToOne=s.ManyToOne??ve,ze.OneToMany=s.OneToMany??ve,ze.JoinColumn=s.JoinColumn??ve,ze.JoinTable=s.JoinTable??ve,ze.CreateDateColumn=s.CreateDateColumn??ve,ze.UpdateDateColumn=s.UpdateDateColumn??ve,ze.VersionColumn=s.VersionColumn??ve,ze.Index=s.Index??ve,ze.Unique=s.Unique??ve,ze.ViewEntity=s.ViewEntity??ve,ze.ViewColumn=s.ViewColumn??ve,console.log("[ORM SHIM] TypeORM loaded successfully"))}catch(s){console.warn("[ORM SHIM] TypeORM not available - using no-op decorators and shimmed types:",s)}})());const QP=ze.Entity,oi=ze.Column,WP=ze.PrimaryGeneratedColumn;ze.PrimaryColumn;ze.ManyToOne;ze.OneToMany;ze.JoinColumn;ze.JoinTable;ze.CreateDateColumn;ze.UpdateDateColumn;ze.VersionColumn;ze.Index;ze.Unique;ze.ViewEntity;ze.ViewColumn;var HP=Object.defineProperty,YP=Object.getOwnPropertyDescriptor,vn=(s,e,t,n)=>{for(var i=n>1?void 0:n?YP(e,t):e,r=s.length-1,a;r>=0;r--)(a=s[r])&&(i=(n?a(e,t,i):a(i))||i);return n&&i&&HP(e,t,i),i};let ln=class{};vn([WP({name:"doc_id"})],ln.prototype,"docId",2);vn([oi({name:"doc_guid"})],ln.prototype,"docGuid",2);vn([oi({name:"doc_name"})],ln.prototype,"docName",2);vn([oi({name:"doc_description"})],ln.prototype,"docDescription",2);vn([oi({name:"company_id"})],ln.prototype,"companyId",2);vn([oi({name:"doc_from"})],ln.prototype,"docFrom",2);vn([oi({name:"doc_type_id"})],ln.prototype,"docTypeId",2);vn([oi({name:"doc_date"})],ln.prototype,"docDate",2);vn([oi({name:"attach_guid"})],ln.prototype,"attach_guid",2);vn([oi({name:"doc_expire_date"})],ln.prototype,"docExpireDate",2);vn([oi({name:"doc_enabled"})],ln.prototype,"docEnabled",2);ln=vn([QP({name:"doc",synchronize:!1})],ln);var ml={},Dm={},GP=io(),zP=qr,Ou=zP("Object.prototype.toString"),Ao=function(e){return GP&&e&&typeof e=="object"&&Symbol.toStringTag in e?!1:Ou(e)==="[object Arguments]"},Im=function(e){return Ao(e)?!0:e!==null&&typeof e=="object"&&"length"in e&&typeof e.length=="number"&&e.length>=0&&Ou(e)!=="[object Array]"&&"callee"in e&&Ou(e.callee)==="[object Function]"},KP=function(){return Ao(arguments)}();Ao.isLegacyArguments=Im;var JP=KP?Ao:Im,Qf=qr,XP=io(),ZP=NA(),eO=Ja,Du;if(XP){var tO=Qf("RegExp.prototype.exec"),Wf={},iu=function(){throw Wf},Hf={toString:iu,valueOf:iu};typeof Symbol.toPrimitive=="symbol"&&(Hf[Symbol.toPrimitive]=iu),Du=function(e){if(!e||typeof e!="object")return!1;var t=eO(e,"lastIndex"),n=t&&ZP(t,"value");if(!n)return!1;try{tO(e,Hf)}catch(i){return i===Wf}}}else{var nO=Qf("Object.prototype.toString"),iO="[object RegExp]";Du=function(e){return!e||typeof e!="object"&&typeof e!="function"?!1:nO(e)===iO}}var rO=Du,sO=qr,aO=rO,oO=sO("RegExp.prototype.exec"),cO=Ka,uO=function(e){if(!aO(e))throw new cO("`regex` must be a RegExp");return function(n){return oO(e,n)!==null}},ru,Yf;function lO(){if(Yf)return ru;Yf=1;const s=(function*(){}).constructor;return ru=()=>s,ru}var $m=qr,hO=uO,dO=hO(/^\s*(?:function)?\*/),fO=io(),Gf=Jf(),pO=$m("Object.prototype.toString"),mO=$m("Function.prototype.toString"),yO=lO(),gO=function(e){if(typeof e!="function")return!1;if(dO(mO(e)))return!0;if(!fO){var t=pO(e);return t==="[object GeneratorFunction]"}if(!Gf)return!1;var n=yO();return n&&Gf(e)===n.prototype};(function(s){var e=JP,t=gO,n=Ap,i=Cp;function r(K){return K.call.bind(K)}var a=typeof BigInt<"u",c=typeof Symbol<"u",l=r(Object.prototype.toString),h=r(Number.prototype.valueOf),f=r(String.prototype.valueOf),p=r(Boolean.prototype.valueOf);if(a)var m=r(BigInt.prototype.valueOf);if(c)var T=r(Symbol.prototype.valueOf);function A(K,Yn){if(typeof K!="object")return!1;try{return Yn(K),!0}catch{return!1}}s.isArgumentsObject=e,s.isGeneratorFunction=t,s.isTypedArray=i;function S(K){return typeof Promise<"u"&&K instanceof Promise||K!==null&&typeof K=="object"&&typeof K.then=="function"&&typeof K.catch=="function"}s.isPromise=S;function P(K){return typeof ArrayBuffer<"u"&&ArrayBuffer.isView?ArrayBuffer.isView(K):i(K)||k(K)}s.isArrayBufferView=P;function F(K){return n(K)==="Uint8Array"}s.isUint8Array=F;function B(K){return n(K)==="Uint8ClampedArray"}s.isUint8ClampedArray=B;function q(K){return n(K)==="Uint16Array"}s.isUint16Array=q;function Z(K){return n(K)==="Uint32Array"}s.isUint32Array=Z;function re(K){return n(K)==="Int8Array"}s.isInt8Array=re;function Ee(K){return n(K)==="Int16Array"}s.isInt16Array=Ee;function Se(K){return n(K)==="Int32Array"}s.isInt32Array=Se;function me(K){return n(K)==="Float32Array"}s.isFloat32Array=me;function W(K){return n(K)==="Float64Array"}s.isFloat64Array=W;function Re(K){return n(K)==="BigInt64Array"}s.isBigInt64Array=Re;function D(K){return n(K)==="BigUint64Array"}s.isBigUint64Array=D;function se(K){return l(K)==="[object Map]"}se.working=typeof Map<"u"&&se(new Map);function V(K){return typeof Map>"u"?!1:se.working?se(K):K instanceof Map}s.isMap=V;function ne(K){return l(K)==="[object Set]"}ne.working=typeof Set<"u"&&ne(new Set);function ce(K){return typeof Set>"u"?!1:ne.working?ne(K):K instanceof Set}s.isSet=ce;function ye(K){return l(K)==="[object WeakMap]"}ye.working=typeof WeakMap<"u"&&ye(new WeakMap);function oe(K){return typeof WeakMap>"u"?!1:ye.working?ye(K):K instanceof WeakMap}s.isWeakMap=oe;function Te(K){return l(K)==="[object WeakSet]"}Te.working=typeof WeakSet<"u"&&Te(new WeakSet);function Xe(K){return Te(K)}s.isWeakSet=Xe;function Ge(K){return l(K)==="[object ArrayBuffer]"}Ge.working=typeof ArrayBuffer<"u"&&Ge(new ArrayBuffer);function qe(K){return typeof ArrayBuffer>"u"?!1:Ge.working?Ge(K):K instanceof ArrayBuffer}s.isArrayBuffer=qe;function tt(K){return l(K)==="[object DataView]"}tt.working=typeof ArrayBuffer<"u"&&typeof DataView<"u"&&tt(new DataView(new ArrayBuffer(1),0,1));function k(K){return typeof DataView>"u"?!1:tt.working?tt(K):K instanceof DataView}s.isDataView=k;var Y=typeof SharedArrayBuffer<"u"?SharedArrayBuffer:void 0;function X(K){return l(K)==="[object SharedArrayBuffer]"}function de(K){return typeof Y>"u"?!1:(typeof X.working>"u"&&(X.working=X(new Y)),X.working?X(K):K instanceof Y)}s.isSharedArrayBuffer=de;function Me(K){return l(K)==="[object AsyncFunction]"}s.isAsyncFunction=Me;function _e(K){return l(K)==="[object Map Iterator]"}s.isMapIterator=_e;function xe(K){return l(K)==="[object Set Iterator]"}s.isSetIterator=xe;function Fe(K){return l(K)==="[object Generator]"}s.isGeneratorObject=Fe;function We(K){return l(K)==="[object WebAssembly.Module]"}s.isWebAssemblyCompiledModule=We;function yt(K){return A(K,h)}s.isNumberObject=yt;function Dt(K){return A(K,f)}s.isStringObject=Dt;function Et(K){return A(K,p)}s.isBooleanObject=Et;function zt(K){return a&&A(K,m)}s.isBigIntObject=zt;function vi(K){return c&&A(K,T)}s.isSymbolObject=vi;function Wt(K){return yt(K)||Dt(K)||Et(K)||zt(K)||vi(K)}s.isBoxedPrimitive=Wt;function hr(K){return typeof Uint8Array<"u"&&(qe(K)||de(K))}s.isAnyArrayBuffer=hr,["isProxy","isExternal","isModuleNamespaceObject"].forEach(function(K){Object.defineProperty(s,K,{enumerable:!1,value:function(){throw new Error(K+" is not supported in userland")}})})})(Dm);var EO=function(e){return e&&typeof e=="object"&&typeof e.copy=="function"&&typeof e.fill=="function"&&typeof e.readUInt8=="function"};(function(s){var e={},t=Object.getOwnPropertyDescriptors||function(Y){for(var X=Object.keys(Y),de={},Me=0;Me<X.length;Me++)de[X[Me]]=Object.getOwnPropertyDescriptor(Y,X[Me]);return de},n=/%[sdj%]/g;s.format=function(k){if(!Ee(k)){for(var Y=[],X=0;X<arguments.length;X++)Y.push(c(arguments[X]));return Y.join(" ")}for(var X=1,de=arguments,Me=de.length,_e=String(k).replace(n,function(Fe){if(Fe==="%%")return"%";if(X>=Me)return Fe;switch(Fe){case"%s":return String(de[X++]);case"%d":return Number(de[X++]);case"%j":try{return JSON.stringify(de[X++])}catch{return"[Circular]"}default:return Fe}}),xe=de[X];X<Me;xe=de[++X])q(xe)||!Re(xe)?_e+=" "+xe:_e+=" "+c(xe);return _e},s.deprecate=function(k,Y){if(typeof process<"u"&&process.noDeprecation===!0)return k;if(typeof process>"u")return function(){return s.deprecate(k,Y).apply(this,arguments)};var X=!1;function de(){if(!X){if(process.throwDeprecation)throw new Error(Y);process.traceDeprecation?console.trace(Y):console.error(Y),X=!0}return k.apply(this,arguments)}return de};var i={},r=/^$/;if(e.NODE_DEBUG){var a=e.NODE_DEBUG;a=a.replace(/[|\\{}()[\]^$+?.]/g,"\\$&").replace(/\*/g,".*").replace(/,/g,"$|^").toUpperCase(),r=new RegExp("^"+a+"$","i")}s.debuglog=function(k){if(k=k.toUpperCase(),!i[k])if(r.test(k)){var Y=process.pid;i[k]=function(){var X=s.format.apply(s,arguments);console.error("%s %d: %s",k,Y,X)}}else i[k]=function(){};return i[k]};function c(k,Y){var X={seen:[],stylize:h};return arguments.length>=3&&(X.depth=arguments[2]),arguments.length>=4&&(X.colors=arguments[3]),B(Y)?X.showHidden=Y:Y&&s._extend(X,Y),me(X.showHidden)&&(X.showHidden=!1),me(X.depth)&&(X.depth=2),me(X.colors)&&(X.colors=!1),me(X.customInspect)&&(X.customInspect=!0),X.colors&&(X.stylize=l),p(X,k,X.depth)}s.inspect=c,c.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},c.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"};function l(k,Y){var X=c.styles[Y];return X?"\x1B["+c.colors[X][0]+"m"+k+"\x1B["+c.colors[X][1]+"m":k}function h(k,Y){return k}function f(k){var Y={};return k.forEach(function(X,de){Y[X]=!0}),Y}function p(k,Y,X){if(k.customInspect&&Y&&V(Y.inspect)&&Y.inspect!==s.inspect&&!(Y.constructor&&Y.constructor.prototype===Y)){var de=Y.inspect(X,k);return Ee(de)||(de=p(k,de,X)),de}var Me=m(k,Y);if(Me)return Me;var _e=Object.keys(Y),xe=f(_e);if(k.showHidden&&(_e=Object.getOwnPropertyNames(Y)),se(Y)&&(_e.indexOf("message")>=0||_e.indexOf("description")>=0))return T(Y);if(_e.length===0){if(V(Y)){var Fe=Y.name?": "+Y.name:"";return k.stylize("[Function"+Fe+"]","special")}if(W(Y))return k.stylize(RegExp.prototype.toString.call(Y),"regexp");if(D(Y))return k.stylize(Date.prototype.toString.call(Y),"date");if(se(Y))return T(Y)}var We="",yt=!1,Dt=["{","}"];if(F(Y)&&(yt=!0,Dt=["[","]"]),V(Y)){var Et=Y.name?": "+Y.name:"";We=" [Function"+Et+"]"}if(W(Y)&&(We=" "+RegExp.prototype.toString.call(Y)),D(Y)&&(We=" "+Date.prototype.toUTCString.call(Y)),se(Y)&&(We=" "+T(Y)),_e.length===0&&(!yt||Y.length==0))return Dt[0]+We+Dt[1];if(X<0)return W(Y)?k.stylize(RegExp.prototype.toString.call(Y),"regexp"):k.stylize("[Object]","special");k.seen.push(Y);var zt;return yt?zt=A(k,Y,X,xe,_e):zt=_e.map(function(vi){return S(k,Y,X,xe,vi,yt)}),k.seen.pop(),P(zt,We,Dt)}function m(k,Y){if(me(Y))return k.stylize("undefined","undefined");if(Ee(Y)){var X="'"+JSON.stringify(Y).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return k.stylize(X,"string")}if(re(Y))return k.stylize(""+Y,"number");if(B(Y))return k.stylize(""+Y,"boolean");if(q(Y))return k.stylize("null","null")}function T(k){return"["+Error.prototype.toString.call(k)+"]"}function A(k,Y,X,de,Me){for(var _e=[],xe=0,Fe=Y.length;xe<Fe;++xe)Xe(Y,String(xe))?_e.push(S(k,Y,X,de,String(xe),!0)):_e.push("");return Me.forEach(function(We){We.match(/^\d+$/)||_e.push(S(k,Y,X,de,We,!0))}),_e}function S(k,Y,X,de,Me,_e){var xe,Fe,We;if(We=Object.getOwnPropertyDescriptor(Y,Me)||{value:Y[Me]},We.get?We.set?Fe=k.stylize("[Getter/Setter]","special"):Fe=k.stylize("[Getter]","special"):We.set&&(Fe=k.stylize("[Setter]","special")),Xe(de,Me)||(xe="["+Me+"]"),Fe||(k.seen.indexOf(We.value)<0?(q(X)?Fe=p(k,We.value,null):Fe=p(k,We.value,X-1),Fe.indexOf(`
`)>-1&&(_e?Fe=Fe.split(`
`).map(function(yt){return"  "+yt}).join(`
`).slice(2):Fe=`
`+Fe.split(`
`).map(function(yt){return"   "+yt}).join(`
`))):Fe=k.stylize("[Circular]","special")),me(xe)){if(_e&&Me.match(/^\d+$/))return Fe;xe=JSON.stringify(""+Me),xe.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(xe=xe.slice(1,-1),xe=k.stylize(xe,"name")):(xe=xe.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),xe=k.stylize(xe,"string"))}return xe+": "+Fe}function P(k,Y,X){var de=k.reduce(function(Me,_e){return _e.indexOf(`
`)>=0,Me+_e.replace(/\u001b\[\d\d?m/g,"").length+1},0);return de>60?X[0]+(Y===""?"":Y+`
 `)+" "+k.join(`,
  `)+" "+X[1]:X[0]+Y+" "+k.join(", ")+" "+X[1]}s.types=Dm;function F(k){return Array.isArray(k)}s.isArray=F;function B(k){return typeof k=="boolean"}s.isBoolean=B;function q(k){return k===null}s.isNull=q;function Z(k){return k==null}s.isNullOrUndefined=Z;function re(k){return typeof k=="number"}s.isNumber=re;function Ee(k){return typeof k=="string"}s.isString=Ee;function Se(k){return typeof k=="symbol"}s.isSymbol=Se;function me(k){return k===void 0}s.isUndefined=me;function W(k){return Re(k)&&ce(k)==="[object RegExp]"}s.isRegExp=W,s.types.isRegExp=W;function Re(k){return typeof k=="object"&&k!==null}s.isObject=Re;function D(k){return Re(k)&&ce(k)==="[object Date]"}s.isDate=D,s.types.isDate=D;function se(k){return Re(k)&&(ce(k)==="[object Error]"||k instanceof Error)}s.isError=se,s.types.isNativeError=se;function V(k){return typeof k=="function"}s.isFunction=V;function ne(k){return k===null||typeof k=="boolean"||typeof k=="number"||typeof k=="string"||typeof k=="symbol"||typeof k>"u"}s.isPrimitive=ne,s.isBuffer=EO;function ce(k){return Object.prototype.toString.call(k)}function ye(k){return k<10?"0"+k.toString(10):k.toString(10)}var oe=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function Te(){var k=new Date,Y=[ye(k.getHours()),ye(k.getMinutes()),ye(k.getSeconds())].join(":");return[k.getDate(),oe[k.getMonth()],Y].join(" ")}s.log=function(){console.log("%s - %s",Te(),s.format.apply(s,arguments))},s.inherits=cr,s._extend=function(k,Y){if(!Y||!Re(Y))return k;for(var X=Object.keys(Y),de=X.length;de--;)k[X[de]]=Y[X[de]];return k};function Xe(k,Y){return Object.prototype.hasOwnProperty.call(k,Y)}var Ge=typeof Symbol<"u"?Symbol("util.promisify.custom"):void 0;s.promisify=function(Y){if(typeof Y!="function")throw new TypeError('The "original" argument must be of type Function');if(Ge&&Y[Ge]){var X=Y[Ge];if(typeof X!="function")throw new TypeError('The "util.promisify.custom" argument must be of type Function');return Object.defineProperty(X,Ge,{value:X,enumerable:!1,writable:!1,configurable:!0}),X}function X(){for(var de,Me,_e=new Promise(function(We,yt){de=We,Me=yt}),xe=[],Fe=0;Fe<arguments.length;Fe++)xe.push(arguments[Fe]);xe.push(function(We,yt){We?Me(We):de(yt)});try{Y.apply(this,xe)}catch(We){Me(We)}return _e}return Object.setPrototypeOf(X,Object.getPrototypeOf(Y)),Ge&&Object.defineProperty(X,Ge,{value:X,enumerable:!1,writable:!1,configurable:!0}),Object.defineProperties(X,t(Y))},s.promisify.custom=Ge;function qe(k,Y){if(!k){var X=new Error("Promise was rejected with a falsy value");X.reason=k,k=X}return Y(k)}function tt(k){if(typeof k!="function")throw new TypeError('The "original" argument must be of type Function');function Y(){for(var X=[],de=0;de<arguments.length;de++)X.push(arguments[de]);var Me=X.pop();if(typeof Me!="function")throw new TypeError("The last argument must be of type Function");var _e=this,xe=function(){return Me.apply(_e,arguments)};k.apply(this,X).then(function(Fe){process.nextTick(xe.bind(null,null,Fe))},function(Fe){process.nextTick(qe.bind(null,Fe,xe))})}return Object.setPrototypeOf(Y,Object.getPrototypeOf(k)),Object.defineProperties(Y,t(k)),Y}s.callbackify=tt})(ml);const TO=Kf(ml),wO=CA({__proto__:null,default:TO},[ml]),yl=qa()==="node"||qa()==="cli";yl&&za(()=>import("./index-heC92mhW.js").then(s=>s.i),__vite__mapDeps([7,1,2,8,5])).then(s=>{s.createClient}).catch(()=>{console.warn("Redis module not available")});yl&&za(()=>Promise.resolve().then(()=>wO),void 0).then(s=>{s.inspect}).catch(()=>{});yl&&za(()=>import("./index-JiKw9JSs.js"),[]).then(s=>{s.default}).catch(()=>{console.warn("Chalk not available, using no-color fallback")});class bO{constructor(e){this.valid=!0,this.controls=e}get value(){const e={};for(const[t,n]of Object.entries(this.controls))e[t]=n.value;return e}validateAll(){const e={};this.valid=!0;for(const[t,n]of Object.entries(this.controls)){const i=n.validate();e[t]=i,i&&(this.valid=!1)}return e}markAllAsTouched(){for(const e of Object.values(this.controls))e.markAsTouched()}reset(){for(const e of Object.values(this.controls))e.reset()}}class zf{constructor(e=null,t=[]){this._errors=[],this.touched=!1,this.dirty=!1,this._value=e,this._validators=t}get value(){return this._value}get valid(){return this._errors.length===0}get errors(){return this._errors}get error(){return this._errors.length>0?this._errors[0]:null}setValue(e){this._value!==e&&(this._value=e,this.dirty=!0),this.validate()}markAsTouched(){this.touched=!0}validate(){this._errors=[];for(const e of this._validators){const t=e(this._value);t&&this._errors.push(t)}return this.error}reset(e=null){this._value=e,this._errors=[],this.touched=!1,this.dirty=!1}}class su{static required(e){return t=>t==null||t===""?e||"This field is required":null}static minLength(e,t){return n=>n&&n.length<e?t||`Minimum length is ${e}`:null}static email(e){return t=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)?null:e||"Invalid email address"}}class NO{constructor(e,t){if(this.form=e,this.formElement=document.querySelector(t),!this.formElement){console.warn(`Form element not found: ${t}`);return}this.initializeBindings()}initializeBindings(){Object.entries(this.form.controls).forEach(([e,t])=>{const n=this.formElement.querySelector(`[name="${e}"]`);n&&(n.value=t.value??"",n.addEventListener("input",i=>{const r=i.target;t.setValue(r.value),this.applyValidationStyles({[e]:t.error})}),n.addEventListener("blur",()=>{t.markAsTouched(),this.applyValidationStyles({[e]:t.error})}))})}validateAll(){const e=this.form.validateAll();this.applyValidationStyles(e)}applyValidationStyles(e){for(const[t,n]of Object.entries(e)){const i=this.formElement.querySelector(`[name="${t}"]`),r=this.formElement.querySelector(`[data-error-for="${t}"]`);i&&(i.classList.remove("cd-valid","cd-invalid"),n?(i.classList.add("cd-invalid"),r&&(r.textContent=n)):(i.classList.add("cd-valid"),r&&(r.textContent="")))}}}const au={form:null,binder:null,__init(){this.form=new bO({userName:new zf("",[su.required("Username is required")]),password:new zf("",[su.required("Password is required"),su.minLength(4,"Password must be at least 4 characters")])}),this.binder=new NO(this.form,"#signInForm")},__template(){return`
      <form id="signInForm" class="cd-form">
        <div class="cd-form-field">
          <label for="userName">Username</label>
          <input
            id="userName"
            name="userName"
            cdFormControl
            placeholder="Enter username"
          />
          <div class="error-message" data-error-for="userName"></div>
        </div>

        <div class="cd-form-field">
          <label for="password">Password</label>
          <input
            id="password"
            name="password"
            type="password"
            cdFormControl
            placeholder="Enter password"
          />
          <div class="error-message" data-error-for="password"></div>
        </div>

        <button type="submit">Sign In</button>
      </form>
    `},__setup(){this.form||this.__init();const s=document.querySelector("#signInForm");s&&s.addEventListener("submit",e=>{e.preventDefault(),this.auth()})},async auth(){const s=this.form.validateAll();if(this.binder.applyValidationStyles(s),!this.form.valid){alert("Please correct the highlighted errors.");return}const e=this.form.value;console.log("Authenticating:",e),alert(`Welcome, ${e.userName}!`)}},AO={username:"",password:"",__template(){return`
      <form class="cd-sign-up">
        <h1 class="cd-heading">Signup</h1>

        <label>Username</label>
        <input cd-model="username" placeholder="Username" />

        <label>Password</label>
        <input cd-model="password" type="password" placeholder="Password" />

        <button type="button" cd-click="auth">Signup</button>
      </form>
    `},__setup(){console.log("[cd-user] Controller setup complete")},auth(){console.log("Signup triggered with:",this.username,this.password),alert(`Hello, ${this.username}!`)}},Lm={ctx:"sys",moduleId:"cd-user",moduleName:"Auto-Generated Module",moduleGuid:"auto-guid",controller:au,template:au.__template(),menu:[{label:"User",route:"sys/cd-user",children:[{label:"Sign In",route:"sys/cd-user/sign-in",template:au.__template()},{label:"Sign Up",route:"sys/cd-user/sign-up",template:AO.__template()}]}]},CO=Lm,GO=Object.freeze(Object.defineProperty({__proto__:null,cduserModule:Lm,module:CO},Symbol.toStringTag,{value:"Module"}));export{Sn as $,WO as A,ka as B,fp as C,Bx as D,wt as E,As as F,HO as G,YO as H,$ as I,BO as J,Au as K,xC as L,w0 as M,Ea as N,Ce as O,_C as P,bt as Q,Ui as R,ps as S,_ as T,m0 as U,xr as V,vC as W,MC as X,fu as Y,PC as Z,pp as _,y0 as a,Cn as a$,OC as a0,pu as a1,DC as a2,IC as a3,Xd as a4,mp as a5,$C as a6,yp as a7,Zd as a8,Vc as a9,lo as aA,Df as aB,Ix as aC,xx as aD,_x as aE,vx as aF,jn as aG,kp as aH,B0 as aI,Up as aJ,D0 as aK,T0 as aL,DO as aM,b0 as aN,Bp as aO,IO as aP,N0 as aQ,LO as aR,A0 as aS,C0 as aT,wf as aU,S0 as aV,R0 as aW,x0 as aX,kn as aY,nn as aZ,or as a_,LC as aa,qC as ab,no as ac,BC as ad,Bn as ae,FC as af,Fr as ag,UC as ah,kC as ai,jC as aj,os as ak,VC as al,QC as am,WC as an,HC as ao,YC as ap,Un as aq,GC as ar,zC as as,Vt as at,KC as au,cs as av,JC as aw,XC as ax,JR as ay,kt as az,eo as b,Nt as b0,jt as b1,pt as b2,Si as b3,Ln as b4,GO as b5,Fx as c,t0 as d,a0 as e,c0 as f,Va as g,gf as h,Lp as i,e0 as j,Wn as k,Tf as l,Gc as m,rr as n,Ux as o,ri as p,FO as q,UO as r,Hi as s,kx as t,ml as u,kO as v,jO as w,VO as x,jx as y,QO as z};
